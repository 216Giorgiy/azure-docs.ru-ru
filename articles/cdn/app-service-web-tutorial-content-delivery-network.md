---
title: Руководство по добавлению сети доставки содержимого Azure в веб-приложение службы приложений Azure | Документация Майкрософт
description: В этом руководстве показано, как добавить сеть доставки содержимого (CDN) в веб-приложение службы приложений Azure для кэширования и доставки статических файлов с ближайших к вашим клиентам серверов по всему миру.
services: cdn
documentationcenter: ''
author: dksimpson
manager: cfowler
editor: ''
ms.assetid: ''
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 05/14/2018
ms.author: v-deasim
ms.custom: mvc
ms.openlocfilehash: d782f5bf30160d85d7d9ef7a00190551f9a9843a
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
---
# <a name="tutorial-add-azure-cdn-to-an-azure-app-service-web-app"></a>Руководство по добавлению сети доставки содержимого Azure в веб-приложение службы приложений Azure

В этом руководстве показано, как добавить Azure CDN в [веб-приложение службы приложений Azure](../app-service/app-service-web-overview.md). [Сеть доставки содержимого (CDN) Azure](cdn-overview.md) кэширует статическое веб-содержимое в стратегически расположенных точках. Это позволяет обеспечить максимальную пропускную способность для доставки содержимого пользователям. Azure CDN также уменьшает нагрузку сервера веб-приложения. 

Это домашняя страница примера статического HTML-сайта, с которым вы будете работать:

![Домашняя страница примера приложения](media/app-service-web-tutorial-content-delivery-network/sample-app-home-page.png)

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * создание конечной точки CDN;
> * обновление кэшированных ресурсов;
> * использование строк запросов для управления кэшированными версиями;
> * использование личного домена для конечной точки CDN.

## <a name="prerequisites"></a>предварительным требованиям

Для работы с этим руководством:

- [установите Git](https://git-scm.com/);
- [Установите Azure CLI 2.0](https://docs.microsoft.com/cli/azure/install-azure-cli).

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="create-the-web-app"></a>Создание веб-приложения

Чтобы создать веб-приложение, с которым вы будете работать, следуйте инструкциям в разделе **Переход в приложение** статьи [Создание статического веб-приложения HTML в Azure](../app-service/app-service-web-get-started-html.md).

### <a name="have-a-custom-domain-ready"></a>Подготовка личного домена

Чтобы подготовить личный домен, вам необходимо быть его владельцем, а также нужен доступ к реестру DNS поставщика домена. Например, чтобы добавить записи DNS для contoso.com и www.contoso.com, необходим доступ для настройки параметров DNS для корневого домена contoso.com.

Если у вас еще нет доменного имени, ознакомьтесь с [руководством по домену службы приложений](../app-service/custom-dns-web-site-buydomains-web-app.md), чтобы узнать, как приобрести домен с помощью портала Azure. 

## <a name="log-in-to-the-azure-portal"></a>Войдите на портал Azure.

Откройте браузер и перейдите на [портал Azure](https://portal.azure.com).

## <a name="create-a-cdn-profile-and-endpoint"></a>Создание профиля CDN и конечной точки

В области навигации слева выберите раздел **Службы приложений**, а затем и выберите приложение, созданное в соответствии с инструкциями по [созданию статического веб-приложения HTML](../app-service/app-service-web-get-started-html.md).

![Выбор службы приложений на портале](media/app-service-web-tutorial-content-delivery-network/portal-select-app-services.png)

На странице **Служба приложений** в разделе **Параметры** выберите **Сеть > Настроить сеть доставки содержимого Azure для приложения**.

![Выбор CDN на портале](media/app-service-web-tutorial-content-delivery-network/portal-select-cdn.png)

На странице **Сеть доставки содержимого Azure** выберите параметры **новой конечной точки** параметры, как указано в таблице.

![Создание профиля и конечной точки на портале](media/app-service-web-tutorial-content-delivery-network/portal-new-endpoint.png)

| Параметр | Рекомендуемое значение | ОПИСАНИЕ |
| ------- | --------------- | ----------- |
| **Профиль CDN** | myCDNProfile | Выберите **Создать**, чтобы создать профиль CDN. Профиль CDN представляет собой коллекцию конечных точек сети CDN из одной ценовой категории. |
| **Ценовая категория** | Akamai уровня "Стандартный" | От [ценовой категории](cdn-features.md) зависят поставщик и доступные возможности. В этом руководстве используется *Akamai уровня "Стандартный"*. |
| **Имя конечной точки CDN** | Любое имя, которое является уникальным в домене azureedge.net | Вы можете обращаться к кэшированным ресурсам в домене *\<имя_конечной_точки>. azureedge.net*.

Нажмите кнопку **Создать**.

Azure создаст профиль и конечную точку. Новая конечная точка появится в списке **Конечные точки**. Когда она будет готова, ее состояние изменится на **Выполняется**.

![Новая конечная точка в списке](media/app-service-web-tutorial-content-delivery-network/portal-new-endpoint-in-list.png)

### <a name="test-the-cdn-endpoint"></a>Тестирование конечной точки сети CDN

Если выбрать ценовую категорию Verizon, распространение конечной точки может занять около 90 минут. В ценовой категории Akamai распространение длится несколько минут.

Пример приложения содержит файл *index.html* и папки *css*, *img* и *js*, в которых находятся другие статические ресурсы. Пути содержимого для всех этих файлов совпадают с путями конечной точки CDN. Например, оба URL-адреса в примерах ниже обращаются к файлу *bootstrap.css* в папке *css*:

```
http://<appname>.azurewebsites.net/css/bootstrap.css
```

```
http://<endpointname>.azureedge.net/css/bootstrap.css
```

Откройте браузер и перейдите по следующему URL-адресу:

```
http://<endpointname>.azureedge.net/index.html
```

![Домашняя страница примера приложения, которая передается из CDN](media/app-service-web-tutorial-content-delivery-network/sample-app-home-page-cdn.png)

 Вы увидите ту же страницу, которая отображалась раньше в веб-приложении. Сеть доставки содержимого Azure извлекла ресурсы исходного веб-приложения и передает их из конечной точки CDN.

Чтобы убедиться, что эта страница кэшируется в CDN, обновите страницу. Иногда для кэширования запрошенного содержимого в CDN необходимо два запроса к одному и тому же ресурсу.

Дополнительные сведения о создании профилей и конечных точек Azure CDN см. в статье [Начало работы с Azure CDN](cdn-create-new-endpoint.md).

## <a name="purge-the-cdn"></a>Очистка CDN

CDN периодически обновляет свои ресурсы из исходного веб-приложения на основе конфигурации срока жизни (TTL). По умолчанию срок жизни составляет 7 дней.

Иногда может потребоваться обновить CDN до истечения срока жизни, например при развертывании обновленного содержимого веб-приложения. Чтобы активировать обновление, можно вручную очистить ресурсы CDN. 

В этом разделе руководства вы можете развернуть изменение в веб-приложении и очистить CDN, чтобы активировать обновление кэша CDN.

### <a name="deploy-a-change-to-the-web-app"></a>Развертывание изменений в веб-приложении

Откройте файл *index.html* и добавьте *-V2* в заголовок H1, как показано в следующем примере: 

```
<h1>Azure App Service - Sample Static HTML Site - V2</h1>
```

Зафиксируйте изменение и разверните его в веб-приложении.

```bash
git commit -am "version 2"
git push azure master
```

После завершения развертывания откройте URL-адрес веб-приложения, и вы увидите изменения.

```
http://<appname>.azurewebsites.net/index.html
```

![Элемент "V2" в заголовке веб-приложения](media/app-service-web-tutorial-content-delivery-network/v2-in-web-app-title.png)

Если перейти по URL-адресу конечной точки CDN, чтобы открыть домашнюю страницу, вы не увидите изменения, так как срок действия кэшированной версии CDN еще не истек. 

```
http://<endpointname>.azureedge.net/index.html
```

![В заголовке в CDN нет элемента "V2"](media/app-service-web-tutorial-content-delivery-network/no-v2-in-cdn-title.png)

### <a name="purge-the-cdn-in-the-portal"></a>Очистка CDN на портале

Чтобы активировать обновление кэшированной версии в CDN, нужно очистить CDN.

На портале в области навигации слева выберите раздел **Группы ресурсов**, а затем выберите группу ресурсов, созданную для веб-приложения (myResourceGroup).

![Выбор группы ресурсов](media/app-service-web-tutorial-content-delivery-network/portal-select-group.png)

В списке ресурсов выберите конечную точку CDN.

![Выбор конечной точки](media/app-service-web-tutorial-content-delivery-network/portal-select-endpoint.png)

В верхней части страницы **Конечная точка** выберите **Очистить**.

![Нажатие кнопки "Очистить"](media/app-service-web-tutorial-content-delivery-network/portal-select-purge.png)

Введите пути к содержимому, которые необходимо очистить. Вы можете передать полный путь к файлу, чтобы очистить отдельный файл, или сегмент пути, чтобы очистить и обновить все содержимое папки. Так как файл *index.html* был изменен, убедитесь, что он расположен по одному из путей.

В нижней части страницы нажмите кнопку **Очистить**.

![Страница очистки](media/app-service-web-tutorial-content-delivery-network/app-service-web-purge-cdn.png)

### <a name="verify-that-the-cdn-is-updated"></a>Проверка обновления CDN

Подождите, пока запрос очистки завершит обработку. Обычно это длится несколько минут. Чтобы просмотреть текущее состояние, выберите значок колокольчика в верхней части страницы. 

![Уведомление об очистке](media/app-service-web-tutorial-content-delivery-network/portal-purge-notification.png)

Когда вы перейдете по URL-адресу конечной точки сети доставки содержимого для *index.html*, вы увидите надпись *V2*, добавленную в заголовок на домашней странице, который указывает на обновление кэша CDN.

```
http://<endpointname>.azureedge.net/index.html
```

!["V2" в заголовке в CDN](media/app-service-web-tutorial-content-delivery-network/v2-in-cdn-title.png)

Дополнительные сведения см. в статье [Очистка конечной точки сети CDN Azure](../cdn/cdn-purge-endpoint.md). 

## <a name="use-query-strings-to-version-content"></a>Использование строк запросов для управления версиями содержимого

В Azure CDN доступны следующие варианты режима кэширования:

* игнорировать строки запросов;
* обходить кэширование для строк запросов;
* кэшировать все уникальные URL-адреса. 

Первый вариант используется по умолчанию. Это означает, что существует только одна кэшированная версия ресурса, независимо от строки запроса в URL-адресе. 

В этом разделе руководства можно изменить режим кэширования, чтобы кэшировать каждый уникальный URL-адрес.

### <a name="change-the-cache-behavior"></a>Изменение поведения кэширования

На портале Azure на странице **Конечная точка CDN** выберите раздел **Кэш**.

Для параметра **Режим кэширования строк запросов** выберите в раскрывающемся списке **Кэшировать каждый уникальный URL-адрес**.

Щелкните **Сохранить**.

![Выбор режима кэширования строки запроса](media/app-service-web-tutorial-content-delivery-network/portal-select-caching-behavior.png)

### <a name="verify-that-unique-urls-are-cached-separately"></a>Проверка кэширования уникальных URL-адресов по отдельности

В браузере перейдите на домашнюю страницу по адресу конечной точки CDN и включите строку запроса: 

```
http://<endpointname>.azureedge.net/index.html?q=1
```

Azure CDN возвращает текущее содержимое веб-приложения, которое включает *V2* в заголовке. 

Чтобы убедиться, что эта страница кэшируется в CDN, обновите страницу. 

Откройте файл *index.html*, измените *V2* на *V3*, а затем разверните изменения. 

```bash
git commit -am "version 3"
git push azure master
```

В браузере откройте URL-адрес конечной точки CDN с новой строкой запроса, например `q=2`. Azure CDN получает текущий файл *index.html* и отображает значение *V3*. Однако при переходе к конечной точке CDN со строкой запроса `q=1` отображается значение *V2*.

```
http://<endpointname>.azureedge.net/index.html?q=2
```

!["V3" в заголовке CDN, строка запроса 2](media/app-service-web-tutorial-content-delivery-network/v3-in-cdn-title-qs2.png)

```
http://<endpointname>.azureedge.net/index.html?q=1
```

!["V2" в заголовке CDN, строка запроса 1](media/app-service-web-tutorial-content-delivery-network/v2-in-cdn-title-qs1.png)

Этот результат показывает, что каждая строка запроса обрабатывается по-разному:

* строка "q=1" использовалась ранее, поэтому возвращается кэшированное содержимое (V2);
* строка "q=2" используется впервые, поэтому извлекается и возвращается последнее содержимое веб-приложения (V3).

Дополнительные сведения см. в статье [Управление режимом кэширования Azure CDN с помощью строк запросов](../cdn/cdn-query-string.md).

## <a name="map-a-custom-domain-to-a-cdn-endpoint"></a>Сопоставление личного домена с конечной точкой CDN

Чтобы сопоставить личный домен с конечной точкой CDN, нужно создать запись CNAME. Запись CNAME — это компонент DNS, позволяющий сопоставить исходный и конечный домены. Например, можно сопоставить cdn.contoso.com или static.contoso.com с contoso.azureedge.net.

Если у вас нет личного домена, ознакомьтесь с [руководством по доменам службы приложений](../app-service/custom-dns-web-site-buydomains-web-app.md), чтобы узнать, как приобрести домен с помощью портала Azure. 

### <a name="find-the-hostname-to-use-with-the-cname"></a>Поиск имени узла для использования с CNAME

На портале Azure на странице **Конечная точка** убедитесь, что в области навигации слева выбран раздел **Обзор**. Затем нажмите кнопку **+ Custom Domain** (Добавить личный домен) в верхней части страницы.

![Нажатие кнопки добавления личного домена](media/app-service-web-tutorial-content-delivery-network/portal-select-add-domain.png)

На странице **Добавление пользовательского домена** вы увидите имя узла конечной точки, которое нужно использовать при создании записи CNAME. Имя узла является производным от URL-адреса конечной точки CDN: **&lt;имя_конечной_точки>.azureedge.net**. 

![Страница добавления домена](media/app-service-web-tutorial-content-delivery-network/portal-add-domain.png)

### <a name="configure-the-cname-with-your-domain-registrar"></a>Настройка записи CNAME в регистраторе домена

Перейдите на веб-сайт вашего регистратора доменных имен и найдите раздел, посвященный созданию записей DNS. Например, этот раздел может называться **Имя домена**, **DNS** или **Управление сервером доменных имен**.

Найдите раздел управления записями CNAME. Может понадобиться перейти на страницу дополнительных параметров и найти слова CNAME, Псевдоним или Поддомены.

Создайте запись CNAME, которая сопоставляет выбранный вами поддомен (например, **static** или **cdn**) с **именем узла конечной точки**, найденным ранее на портале. 

### <a name="enter-the-custom-domain-in-azure"></a>Ввод имени личного домена в Azure

Вернитесь на страницу **Добавление пользовательского домена** и укажите в диалоговом окне личный домен, включая поддомен. Например, введите *cdn.contoso.com*.   
   
Azure проверит наличие записи CNAME для введенного имени домена. Если запись CNAME правильна, пользовательский домен проходит проверку.

Иногда может потребоваться некоторое время для распространения записи CNAME по серверам имен в Интернете. Если домен не проверяется сразу, подождите несколько минут и повторите попытку.

### <a name="test-the-custom-domain"></a>Тестирование личного домена

В браузере откройте файл *index.html*, используя личный домен (например, cdn.contoso.com/index.html), чтобы убедиться, что вы переходите на ту же страницу, которая открывается при переходе непосредственно по адресу &lt;имя_конечной_точки&gt;azureedge.net/index.html.

![Домашняя страница примера приложения по URL-адресу с личным доменом](media/app-service-web-tutorial-content-delivery-network/home-page-custom-domain.png)

Дополнительные сведения см. в статье [Сопоставление содержимого Azure CDN с пользовательским доменом](../cdn/cdn-map-content-to-custom-domain.md).

[!INCLUDE [cli-samples-clean-up](../../includes/cli-samples-clean-up.md)]

## <a name="next-steps"></a>Дополнительная информация

Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * создание конечной точки CDN;
> * обновление кэшированных ресурсов;
> * использование строк запросов для управления кэшированными версиями;
> * использование личного домена для конечной точки CDN.

Чтобы узнать, как оптимизировать производительность CDN, см. следующие статьи:

> [!div class="nextstepaction"]
> [Руководство. Добавление личного домена к конечной точке CDN Azure](cdn-map-content-to-custom-domain.md)


