<properties
	pageTitle="Использование Azure CDN с CORS"
	description="Сведения об использовании сети доставки содержимого (CDN) Azure с общим доступом к ресурсам независимо от источника (CORS)."
	services="cdn"
	documentationCenter=".net"
	authors="camsoper"
	manager="erikre"
	editor=""/>

<tags
	ms.service="cdn"
	ms.workload="tbd"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/19/2016"
	ms.author="casoper"/>
    
# Использование Azure CDN с CORS     

## Что такое CORS?

CORS (общий доступ к ресурсам независимо от источника) — функция HTTP, которая позволяет веб-приложению, работающему в одном домене, обращаться к ресурсам другого домена. Чтобы снизить вероятность атак с использованием межузловых сценариев, все современные веб-браузеры реализуют ограничение безопасности, известное как [политика одного источника](http://www.w3.org/Security/wiki/Same_Origin_Policy). Это ограничение не позволяет веб-страницы вызывать интерфейсы API в другом домене. CORS позволяет одному домену (домену-источнику) безопасно вызывать API-интерфейсы в другом домене.
 
## Принцип работы
1.	Браузер отправляет запрос OPTIONS с HTTP-заголовком **Origin**. Значение этого заголовка — домен, который обслуживал родительскую страницу. Когда страница из https://www.contoso.com попытается получить доступ к данным пользователя в домене fabrikam.com, на этот домен отправляется запрос со следующим заголовком: 
    
    `Origin: https://www.contoso.com`
 
2.	Сервер может отправить в ответ следующее:
    - Ответ с заголовком **Access-Control-Allow-Origin**, который указывает, какие сайты-источники разрешены. Например:
        
        `Access-Control-Allow-Origin: https://www.contoso.com`
        
    - Страницу с ошибкой, если сервер не разрешает отправку запросов, не зависящих от источника.
    - Заголовок **Access-Control-Allow-Origin** с подстановочным знаком, который разрешает все домены:
        
        `Access-Control-Allow-Origin: *`
 
Для сложных запросов HTTP сначала выполняется "предварительный" запрос. Его задача — определить, есть ли необходимые права, перед отправкой полного запроса.
 
## Подстановочный знак или сценарии с одним источником

CORS в Azure CDN будет работать автоматически без дополнительной настройки, если в заголовке **Access-Control-Allow-Origin** указан подстановочный знак (*) или один источник. В этом случае CDN кэширует первый ответ, и в последующих запросах будет использоваться тот же заголовок.
 
Если запросы в CDN были отправлены до настройки CORS на вашем источнике, потребуется очистить содержимое конечной точки, чтобы обновить содержимое с заголовком **Access-Control-Allow-Origin**.
 
## Сценарии с несколькими источниками

Если необходимо разрешить для CORS определенный набор источников, задача несколько усложняется. Проблема возникает, когда CDN кэширует заголовок **Access-Control-Allow-Origin** для первого источника CORS. При последующем запросе от другого источника CORS CDN отправит кэшированный заголовок **Access-Control-Allow-Origin**, который не будет соответствовать заголовку другого источника. Исправить это можно несколькими способами.
 
### Azure CDN уровня "Премиум" от Verizon

Удобнее всего воспользоваться **Azure CDN уровня "Премиум" от Verizon** с некоторыми дополнительными функциями.
 
Вам потребуется [создать правило](cdn-rules-engine.md) для проверки заголовка запроса **Origin**. Если это допустимый источник, то ваше правило установит заголовок **Access-Control-Allow-Origin** в соответствии с источником, указанным в запросе. Если источник, указанный в заголовке **Origin**, не является допустимым, ваше правило должно опустить заголовок **Access-Control-Allow-Origin**, что заставит браузер отклонить запрос.
 
С помощью обработчика правил это можно сделать двумя способами. В обоих случаях заголовок **Access-Control-Allow-Origin** из файла сервера-источника полностью игнорируется, и разрешенными источниками CORS управляет только обработчик правил CDN.

#### Одно регулярное выражение со всеми допустимыми источниками
 
В этом случае создается регулярное выражение, которое включает все источники, которые вы хотите разрешить:

	https?:\/\/(www\.contoso\.com|contoso\.com|www\.microsoft\.com|microsoft.com\.com)$
 
> [AZURE.TIP] В **Azure CDN от Verizon** в качестве основного механизма регулярных выражений используются [Perl-совместимые регулярные выражения](http://pcre.org/). Для проверки регулярного выражения можно использовать такие ресурсы, как [Regular Expressions 101](https://regex101.com/). Обратите внимание, что символ "/" в регулярных выражениях является допустимым и экранировать его необязательно. Однако его все же рекомендуется экранировать, и некоторые средства проверки регулярных выражений ожидают, что он будет экранирован.

Если регулярное выражение соответствует запросу, то фрагмент CDN правила заменит заголовок **Access-Control-Allow-Origin** источника (если он есть) на источник, который отправил запрос. Также можно добавить дополнительные заголовки CORS, например **Access-Control-Allow-Methods**.

![Пример правил с регулярным выражением](./media/cdn-cors/cdn-cors-regex.png)
 
#### Правило заголовка запроса для каждого источника.

Вместо регулярных выражений можно создать отдельное правило для каждого источника, который вы хотите разрешить, с помощью [условия соответствия](cdn-rules-engine-details.md#match-conditions) для **подстановочного знака заголовка запроса**. Как и регулярное выражение, заголовки CORS задаются только обработчиком правил.
  
![Пример правил без регулярного выражения](./media/cdn-cors/cdn-cors-no-regex.png)

> [AZURE.TIP] В примере выше подстановочный знак * означает, что обработчик правил будет проверять на соответствие как HTTP-, так и HTTPS-запросы.
 
### Azure CDN уровня "Стандартный"

Единственный механизм, который разрешает наличие нескольких источников без использования источника с подстановочным знаком в профилях Azure CDN уровня "Стандартный" — это [кэширование строки запроса](cdn-query-string.md). Вам необходимо включить параметр строки запроса для конечной точки CDN, а затем использовать уникальную строку запроса для запросов от каждого разрешенного домена. Это приведет к тому, что CDN будет кэшировать отдельный объект для каждой уникальной строки запроса. Однако этот подход не является идеальным, так как он приведет к появлению нескольких копий одного файла в кэше CDN.

<!---HONumber=AcomDC_0525_2016-->