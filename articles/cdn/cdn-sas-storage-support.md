---
title: "Использование Azure CDN с SAS | Документация Майкрософт"
description: 
services: cdn
documentationcenter: 
author: dksimpson
manager: 
editor: 
ms.assetid: 
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/14/2017
ms.author: rli v-deasim
ms.openlocfilehash: de30f4319be75362131f8c8ad71aad57b0528f05
ms.sourcegitcommit: 3f33787645e890ff3b73c4b3a28d90d5f814e46c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2018
---
# <a name="using-azure-cdn-with-sas"></a>Использование Azure CDN с SAS

Когда вы обслуживаете содержимое из контейнера хранения вашей учетной записи хранения, вы можете защитить доступ пользователей к вашим файлам, предоставив частный доступ к контейнеру. В противном случае доступ к общедоступному контейнеру хранения может получить любой, кто знает его URL-адрес. Чтобы защитить учетную запись хранения, доступ к которой вы разрешили для сети доставки содержимого (CDN), вы можете использовать функцию подписанного URL-адреса (SAS) из хранилища Azure для предоставления ограниченного доступа к частным контейнерам хранения.

SAS — это URI, который предоставляет ограниченные права доступа к ресурсам хранилища Azure, не отображая ключ вашей учетной записи. Вы можете предоставить SAS клиентам, которым вы не доверяете ключ учетной записи хранения, но которым вы хотите делегировать доступ к определенным ресурсам учетной записи. Распределяя URI подписи общего доступа к этим клиентам, вы предоставляете им доступ к ресурсу в течение определенного периода времени.
 
SAS позволяет вам определить различные параметры доступа к BLOB-объекту, такие как время запуска и истечения срока действия, разрешения (на чтение и запись) и диапазоны IP-адресов. В этой статье описывается использование SAS вместе с Azure CDN. Дополнительные сведения о SAS, включая данные о его создании и настройке параметров, см. в статье [Использование подписанных URL-адресов (SAS)](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1).

## <a name="setting-up-azure-cdn-to-work-with-storage-sas"></a>Настройка Azure CDN для работы с SAS хранилища
Для использования SAS с Azure CDN рекомендуются следующие три варианта. Предполагается, что вы уже создали рабочий SAS (см. предварительные требования). 
 
### <a name="prerequisites"></a>предварительным требованиям
Для начала создайте учетную запись хранения, а затем создайте SAS для ресурса. Вы можете создать два типа подписанных URL-адресов: SAS службы или учетной записи. Дополнительные сведения см. в разделе [Типы подписанных URL-адресов](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1#types-of-shared-access-signatures).

После того, как вы создали SAS, вы можете получить доступ к файлу хранилища BLOB-объектов с использованием URL-адреса, который имеет следующий формат: `https://<account>.blob.core.windows.net/<folder>/<file>?sv=<SAS_TOKEN>`
 
Например: 
 ```
https://democdnstorage1.blob.core.windows.net/container1/sasblob.txt?sv=2017-04-17&ss=b&srt=co&sp=r&se=2038-01-02T21:30:49Z&st=2018-01-02T13:30:49Z&spr=https&sig=QehoetQFWUEd1lhU5iOMGrHBmE727xYAbKJl5ohSiWI%3D
```

Дополнительные сведения о параметрах см. в разделах [Сведения о параметрах SAS](#sas-parameter-considerations) и [Параметры подписанного URL-адреса](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1#shared-access-signature-parameters).

![Параметры SAS CDN](./media/cdn-sas-storage-support/cdn-sas-settings.png)

### <a name="option-1-using-sas-with-pass-through-to-blob-storage-from-the-cdn"></a>Вариант 1. Использование SAS с передачей к хранилищу BLOB-объектов из CDN

Этот вариант является самым простым и использует только один маркер SAS, который передается из CDN на исходный сервер. Его поддерживает **Azure CDN от Verizon** для профилей уровня "Стандартный" и "Премиум" и **Azure CDN от Akamai**. 
 
1. Выберите конечную точку, щелкните **Правила кеширования**, затем выберите **Кэшировать каждый уникальный URL-адрес** из списка **Query string caching** (Кэширование строк запросов).

    ![Правила кэширования CDN](./media/cdn-sas-storage-support/cdn-caching-rules.png)

2. После настройки SAS в вашей учетной записи хранения используйте маркер SAS с URL-адресом CDN для доступа к файлу. 
   
   Полученный SAS имеет следующий формат: `https://<endpoint>.azureedge.net/<folder>/<file>?sv=<SAS_TOKEN>`

   Например:    
   ```
   https://demoendpoint.azureedge.net/test/demo.jpg/?sv=2017-04-17&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
   
3. Точная настройка длительности кэширования выполняется либо с помощью правил кеширования, либо путем добавления заголовков `Cache-Control` в источник. Так как CDN рассматривает маркер SAS как обычную строку запроса, необходимо настроить длительность кэширования, которая истекает во время или до истечения срока действия SAS. В противном случае, если файл кэшируется дольше, чем активен SAS, файл может остаться доступным с сервера-источника CDN по истечении срока действия SAS. В этом случае, если вы хотите сделать кэшированный файл недоступным, выполните операцию очистки кэша в файле. Сведения о настройке длительности кэширования на CDN см. в статье [Управление поведением кэширования сети доставки содержимого Azure с помощью правил кэширования](cdn-caching-rules.md).

### <a name="option-2-hidden-cdn-security-token-using-rewrite-rule"></a>Вариант 2. Скрытый маркер безопасности CDN с использованием правила переопределения
 
С помощью этого варианта вы можете защитить исходное хранилище BLOB-объектов без использования маркера SAS для пользователя CDN. Его можно использовать, если вам не нужны определенные ограничения доступа к файлу, но вы хотите, чтобы пользователи не могли напрямую обращаться к источнику хранения, чтобы улучшить время разгрузки CDN. Этот параметр доступен только для профилей **Azure CDN уровня "Премиум" от Verizon**. 
 
1. Используйте [обработчик правил](cdn-rules-engine.md) для создания правила переопределения URL-адресов. Новые правила распространяются в течение 90 минут.

   ![Кнопка управления CDN](./media/cdn-sas-storage-support/cdn-manage-btn.png)

   ![Кнопка обработчика правил Azure CDN](./media/cdn-sas-storage-support/cdn-rules-engine-btn.png)

   Этот пример правила переопределения URL-адресов имеет следующие шаблоны:
   
   Источник:   
   `/test/demo.jpg`
   
   Назначение:   
   `/test/demo.jpg?sv=2017-04-17&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D`

   ![Правило переопределения URL-адресов CDN](./media/cdn-sas-storage-support/cdn-url-rewrite-rule.png)
 
2. Доступ к файлу в CDN можно получить без маркера SAS в следующем формате: `https://<endpoint>.azureedge.net/<folder>/<file>`
 
   Например:    
   `https://demoendpoint.azureedge.net/test/demo.jpg`
       
   Обратите внимание, что доступ к конечной точке CDN может получить любой пользователь независимо от использования маркера SAS. 

3. Точная настройка длительности кэширования выполняется либо с помощью правил кеширования, либо путем добавления заголовков `Cache-Control` в источник. Так как CDN рассматривает маркер SAS как обычную строку запроса, необходимо настроить длительность кэширования, которая истекает во время или до истечения срока действия SAS. В противном случае, если файл кэшируется дольше, чем активен SAS, файл может остаться доступным с сервера-источника CDN по истечении срока действия SAS. В этом случае, если вы хотите сделать кэшированный файл недоступным, выполните операцию очистки кэша в файле. Сведения о настройке длительности кэширования на CDN см. в статье [Управление поведением кэширования сети доставки содержимого Azure с помощью правил кэширования](cdn-caching-rules.md).

### <a name="option-3-using-cdn-security-token-authentication-with-a-rewrite-rule"></a>Вариант 3. Использование аутентификации маркера безопасности CDN с правилом подстановки

Этот вариант является наиболее безопасным и настраиваемым. Чтобы использовать аутентификацию маркера безопасности CDN, у вас должен быть профиль**Azure CDN уровня "Премиум" от Verizon**. Клиентский доступ основан на параметрах безопасности, установленных на маркере CDN. Однако, если SAS становится недействительным, CDN не сможет обновить содержимое с исходного сервера.

1. [Создайте маркер безопасности CDN](https://docs.microsoft.com/azure/cdn/cdn-token-auth#setting-up-token-authentication) и активируйте его, используя обработчик правил для конечной точки CDN и путь, с помощью которого пользователи смогут получить доступ к файлу.

   Ниже приведен формат URL-адреса SAS:   
   `https://<endpoint>.azureedge.net/<folder>/<file>?sv=<SAS_TOKEN>`
 
   Например:    
   ```
   https://demoendpoint.azureedge.net/test/demo.jpg?sv=2017-04-17&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
       
   Параметры аутентификации маркера безопасности CDN отличаются от параметров маркера SAS. Если вы решите использовать время окончания срока действия при создании маркера безопасности CDN, установите для него то же значение, что и для маркера SAS. Это обеспечит прогнозируемость срока окончания действия. 
 
2. Используйте [обработчик правил](cdn-rules-engine.md), чтобы создать правило переопределения URL-адреса и разрешить доступ по маркеру ко всем блокам в контейнере. Новые правила распространяются в течение 90 минут.

   Этот пример правила переопределения URL-адресов имеет следующие шаблоны:
   
   Источник:   
   `/test/demo.jpg`
   
   Назначение:   
   `/test/demo.jpg?sv=2017-04-17&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D`

   ![Правило переопределения URL-адресов CDN](./media/cdn-sas-storage-support/cdn-url-rewrite-rule.png)

3. При обновлении SAS обновите правило переопределения URL-адресов, чтобы использовать новый маркер SAS. 

## <a name="sas-parameter-considerations"></a>Рекомендации по настройке параметров SAS

Так как параметры SAS не отображаются в CDN, CDN не может изменить свое поведение доставки на их основе. Определенные ограничения параметров применяются только к запросам, которые CDN делает к исходному серверу, а не к запросам клиента к CDN. Это различие следует учитывать при установке параметров SAS. Если необходимы эти дополнительные возможности, и вы используете [вариант 3](#option-3-using-cdn-security-token-authentication-with-a-rewrite-rule), установите соответствующие ограничения в маркере безопасности CDN.

| Имя параметра SAS | ОПИСАНИЕ |
| --- | --- |
| Начало | Время, когда CDN может начать получать доступ к файлу BLOB-объектов. Из-за разницы в показаниях часов (когда сигнал времени поступает в разное время для различных компонентов) установите время на 15 минут раньше, если вы хотите, чтобы ресурс был доступен немедленно. |
| End | Время, после которого CDN больше не может получить доступ к файлу BLOB-объектов. Ранее кэшированные файлы в CDN по-прежнему будут доступны. Чтобы управлять временем окончания срока действия файла, установите соответствующее время для маркера безопасности CDN, либо очистите ресурс. |
| Разрешенные IP-адреса | Необязательный элемент. Если вы используете **Azure CDN от Verizon**, примените параметр диапазонов, указанных на странице [Azure CDN from Verizon Edge Server IP Ranges](https://msdn.microsoft.com/library/mt757330.aspx) (Диапазоны IP-адресов пограничного сервера Azure CDN от Verizon). Если вы используете **Azure CDN от Akamai**, нельзя задать параметр диапазонов IP-адресов, так как они не являются статичными.|
| Разрешенные протоколы | Протоколы, разрешенные для запроса, сделанного с помощью SAS учетной записи. Рекомендуется использовать параметр HTTPS.|

## <a name="see-also"></a>См. также
- [Использование подписанных URL-адресов (SAS)](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1)
- [Подписанные URL-адреса. Часть 2: создание и использование подписанного URL-адреса в службе BLOB-объектов](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2)
- [Защита ресурсов сети доставки содержимого Azure с помощью аутентификации на основе маркеров](https://docs.microsoft.com/azure/cdn/cdn-token-auth)
