<properties pageTitle="Что такое многофакторная проверка подлинности Azure?" description="Подробные сведения о многофакторной проверке подлинности в Azure, методе проверки подлинности, который требует применения более одного метода проверки и добавляет критически важный второй уровень безопасности для операций входа и транзакций пользователя." services="active-directory, multi-factor-authentication" documentationCenter="" authors="blackmist" manager="wpickett" editor=""/>

<tags ms.service="virtual-machines" ms.workload="infrastructure-services" ms.tgt_pltfrm="na" ms.devlang="ruby" ms.topic="article" ms.date="09/17/2014" ms.author="larryfr"/>



#Как управлять виртуальными машинами Azure с использованием Ruby

В этом руководстве показано, как программными средствами выполнить общие задачи управления для виртуальных машин Azure, такие как создание и настройка виртуальных машин и добавление дисков данных. Пакет Azure SDK для Ruby предоставляет доступ к функциям управления для различных служб Azure, включая службу виртуальных машин Azure.

##Оглавление

* [Что такое управление службами?](#what-is)
* [Основные понятия](#concepts)
* [Создание сертификата управления](#setup-certificate)
* [Создание приложения Ruby](#create-app)
* [Настройка приложения для использования пакета SDK](#configure-access)
* [Настройка подключения управления Azure](#setup-connection)
* [Практическое руководство. Работа с виртуальными машинами](#virtual-machine)
* [Практическое руководство. Работа с образами и дисками](#vm-images)
* [Практическое руководство. Работа с облачными службами](#cloud-services)
* [Практическое руководство. Работа со службами хранилища](#storage-services)
* [Дальнейшие действия](#next-steps)

## <a name="what-is"> </a>Что такое управление службами?

Azure предоставляет [интерфейсы REST API для операций управления службами](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee460799.aspx), включая управление виртуальными машинами Azure. Пакет Azure SDK для Ruby предоставляет операции управления для виртуальных машин через класс **Azure::VirtualMachineSerivce**. С помощью этого класса доступно большинство функций управления виртуальными машинами, доступных через [портал управления Azure](https://manage.windowsazure.com).

Хотя API-интерфейс управления службами можно использовать для управления различными службами, размещенными в Azure, в этом документе приводятся только сведения об управлении виртуальными машинами Azure.

## <a name="concepts"> </a>Основные понятия

Виртуальные машины Azure реализованы как 'роли' в облачной службе. Каждая облачная служба может содержать одну или несколько ролей, которые логически сгруппированы в развертывания. Роль определяет общие физические характеристики виртуальной машины, например доступный объем памяти, количество ядер ЦП и т. д.

Каждая виртуальная машина имеет также диск ОС, содержащий загружаемую операционную систему. Виртуальная машина может иметь один или несколько дисков данных, представляющих собой дополнительные диски, которые должны использоваться для хранения данных приложений. Диски реализуются как виртуальные жесткие диски (VHD), хранящиеся в хранилище BLOB-объектов Azure. Виртуальные жесткие диски также могут предоставляться в виде 'образов', представляющих собой шаблоны, которые применяются для создания дисков, используемых виртуальной машиной во время создания виртуальной машины. Например, результатом создания новой виртуальной машины, для которой используется образ Ubuntu, станет новый диск ОС, создаваемый из образа Ubuntu.

Большинство образов предоставляется корпорацией Майкрософт или ее партнерами, но вы можете создавать собственные образы или создать образ из виртуальной машины, размещенной в Azure.

## <a name="setup-certificate"> </a>Создание сертификата управления Azure

При выполнении операций управления службами, например предоставляемых через класс **Azure::VirtualMachineService**, необходимо указать идентификатор подписки Azure и файл, содержащий сертификат управления для подписки. Они используются пакетом SDK при проверке подлинности в API-интерфейсе Azure REST.

Идентификатор подписки и сертификат управления можно получить с помощью межплатформенного интерфейса командной строки Azure (xplat-cli). Сведения об установке и настройке xplat-cli см. в разделе [Установка и настройка межплатформенного интерфейса командной строки Azure](http://www.windowsazure.com/ru-ru/manage/install-and-configure-cli/).

После настройки xplat-cli можно выполнить описанные ниже действия, чтобы получить идентификатор подписки Azure и экспортировать сертификат управления.

1. Чтобы получить идентификатор подписки, используйте следующую команду:

		azure account list

2. Чтобы экспортировать сертификат управления, используйте следующую команду:

		azure account cert export

	После выполнения команды сертификат экспортируется в файл с именем &lt;имя-подписки-azure&gt;.pem. Например, если ваша подписка называется **mygreatsubscription**, то созданному файлу будет присвоено имя **mygreatsubscription.pem**.

Зафиксируйте идентификатор подписки и расположение PEM-файла, содержащего экспортированный сертификат, поскольку они будут использоваться далее в этом документе.

## <a name="create-app"></a>Создание приложения Ruby

Создайте новое приложение с использованием Ruby. Примеры, используемые в данном документе, могут быть реализованы в одном файле **.rb**.

## <a name="configure-access"></a>Настройка приложения

Для управления службами Azure необходимо загрузить и использовать пакет Azure, содержащий пакет Azure SDK для Ruby.

### Использование команды gem для установки пакета

1.  Используя интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (UNIX), перейдите к папке, в которой вы создали пример приложения.

2. Используйте следующую команду для установки пакета Azure:

		gem install azure

	Вы должны увидеть результат, аналогичный приведенному ниже:

		Fetching: mini_portile-0.5.1.gem (100%)
		Fetching: nokogiri-1.6.0-x86-mingw32.gem (100%)
		Fetching: mime-types-1.25.gem (100%)
		Fetching: systemu-2.5.2.gem (100%)
		Fetching: macaddr-1.6.1.gem (100%)
		Fetching: uuid-2.3.7.gem (100%)
		Fetching: azure-0.5.0.gem (100%)
		Successfully installed mini_portile-0.5.1
		Successfully installed nokogiri-1.6.0-x86-mingw32
		Successfully installed mime-types-1.25
		Successfully installed systemu-2.5.2
		Successfully installed macaddr-1.6.1
		Successfully installed uuid-2.3.7
		Successfully installed azure-0.5.0
		7 gems installed

	> [AZURE.NOTE] Если появляется ошибка, связанная с разрешениями, тогда используйте команду <code>sudo gem install azure</code>.

### Требование пакета

С помощью текстового редактора добавьте в начало файла приложения Ruby приведенную ниже строку. Она загрузит пакет Azure и сделает пакет Azure SDK для Ruby доступным для приложения.

	require 'azure'

## <a name="setup-connection"> </a>Практическое руководство. Подключение к управлению службами

Для успешного выполнения операций управления службами в Azure необходимо указать идентификатор подписки и сертификат, полученный в разделе [Создание сертификата управления Azure](#setup-certificate) . Для этого проще всего указать идентификатор и путь к файлу сертификата, используя следующие переменные среды:

* AZURE\_MANAGEMENT\_CERTIFICATE - Путь к PEM-файлу, содержащему сертификат управления.

* AZURE\_SUBSCRIPTION\_ID - Идентификатор вашей подписки Azure.

Можно также задать эти значения программным способом в приложении, используя следующий код:

	Azure.configure do |config|
	  config.management_certificate = 'path/to/certificate'
	  config.subscription_id = 'subscription ID'
	end

##<a name="virtual-machine"> </a>Практическое руководство. Работа с виртуальными машинами

Операции управления для виртуальных машин Azure выполняются с использованием класса **Azure::VirtualMachineService**.

###Практическое руководство. Создание новой виртуальной машины

Для создания новой виртуальной машины используется метод **create\_virtual\_machine**. Этот метод принимает хэш, содержащий перечисленные ниже параметры, и возвращает экземпляр **Azure::VirtualMachineManagement::VirtualMachine**, описывающий созданную виртуальную машину:

**Параметры**

* **:vm\_name** - Имя виртуальной машины.

* **:vm\_user** - Имя привилегированного пользователя или администратора.

* **:password** - Пароль привилегированного пользователя или администратора.

* **:image** - Образ ОС, который будет использоваться для создания диска ОС этой виртуальной машины. Диск ОС будет храниться в файле VHD, созданном в хранилище BLOB-объектов.

* **:location** - Регион, в котором будет создана виртуальная машина. Этот регион должен совпадать с регионом учетной записи хранения, содержащий диски, используемые этой виртуальной машиной.

Ниже приведен пример создания новой виртуальной машины с использованием этих параметров.

	vm_params = {
	  :vm_name => 'mygreatvm',
	  :vm_user => 'myuser',
	  :password => 'mypassword',
	  :image => 'b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-13_04-amd64-server-20130824-ru-ru-30GB',
	  :location = 'East US'
	}

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.create_virtual_machine(vm_params)

	puts "A VM named #{vm.vm_name} was created in a cloud service named #{vm.cloud_service_name}."
	puts "It uses a disk named #{vm.disk_name}, which was created from a #{vm.os_type}-based image."
	puts "The virtual IP address of the machine is #{vm.ipaddress}."
    puts "The fully qualified domain name is #{vm.cloud_service_name}.cloudapp.net."

**Параметры**

Можно указать хэш необязательных параметров, которые позволяют переопределить поведение по умолчанию при создании виртуальной машины, например указание существующей учетной записи хранения вместо создания новой.

При использовании метода **create\_virtual\_machine** доступны следующие параметры:

* **:storage\_account\_name** - Имя учетной записи хранения, которая будет использоваться для хранения образов дисков. Если учетной записи хранения еще не существует, создается новая учетная запись. Если параметр не указан, создается новая учетная запись хранения, имя которой определяется параметром :vm\_name param.

* **:cloud\_service\_name** - Имя облачной службы, которая будет использоваться для размещения виртуальной машины. Если облачной службы еще не существует, создается новая облачная служба. Если параметр не указан, создается новая облачная служба, имя которой определяется параметром :vm\_name.

* **:deployment\_name** - Имя развертывания, которое будет использоваться при развертывании конфигурации виртуальной машины.

* **:tcp\_endpoints** - Порты TCP для предоставления общего доступа к виртуальной машине. Конечную точку SSH (для виртуальных машин на основе Linux) и конечную точку WinRM (для виртуальных машин на основе Windows) не требуется указывать, они будут созданы автоматически. Можно указать несколько портов, разделяя их запятой. Чтобы связать внутренний порт с общим портом с помощью другого номера порта, используйте формат **общий порт:внутренний порт**. Например, 80:8080 предоставляет внутренний порт 8080 как общий порт 80.

* **:service\_location** - Целевое расположение хранилища сертификатов на виртуальной машине. Применяется только к виртуальным машинам под управлением Windows.

* **:ssh\_private\_key\_file** - Файл, содержащий закрытый ключ, который будет использоваться для защиты SSH-доступа к виртуальной машине на основе Linux. Используется также для указания сертификата, применяемого для защиты WinRM, если выбран транспортный протокол HTTPS. Если **: ssh\_private\_key\_file** и **: ssh\_certificate\_file** опущены, то протокол SSH будет использовать только аутентификацию по паролю

* **:ssh\_certificate\_file** - Файл, содержащий файл сертификата, который будет использоваться для защиты SSH-доступа к виртуальной машине на основе Linux. Используется также для указания сертификата, применяемого для защиты WinRM, если выбран транспортный протокол HTTPS. Если **: ssh\_private\_key\_file** и **: ssh\_certificate\_file** опущены, то протокол SSH будет использовать только аутентификацию по паролю

* **:ssh\_port** - Общий порт, который будет использоваться для обмена данными по протоколу SSH. Если параметр не указан, по умолчанию используется порт SSH 22.

* **:vm\_size** - Размер виртуальной машины. Этот параметр определяет размер памяти, количество ядер, полосу пропускания и другие физические характеристики виртуальной машины. Сведения о доступных размерах и физических характеристиках см. в разделе [Размеры виртуальных машин и облачных служб в Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/dn197896.aspx).

* **:winrm_transport** - Массив транспортных протоколов, которые можно использовать с WinRM. Допускается использование транспортов  'http' и  'https'. Если в качестве транспортного протокола указан  'https', необходимо также использовать параметры **:ssh\_private\_key\_file** и **:ssh\_certificate\_file**, чтобы указать сертификат, применяемый для защиты обмена данных по протоколу HTTPS.

Ниже приведен пример создания новой виртуальной машины, которая использует малую интенсивность вычислительных операций, открытым способом предоставляет порты для трафика через HTTP (локальный порт 8080, общий порт 80) и HTTPS (443) и применяет проверку подлинности сертификата для сеансов SSH, используя указанные файлы сертификатов.

	vm_params = {
	  :vm_name => 'myvm',
	  :vm_user => 'myuser',
	  :password => 'mypassword',
	  :image => 'b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-13_04-amd64-server-20130824-ru-ru-30GB',
	  :location = 'East US'
	}

	vm_opts = {
      :tcp_endpoints => '80:8080,443',
      :vm_size => 'Small',
      :ssh_private_key_file => '../sshkey/mykey.key',
      :ssh_certificate_file => '../sshkey/mykey.pem'
	}

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.create_virtual_machine(vm_params, vm_opts)

###Практическое руководство. получение списка виртуальных машин

Чтобы получить список существующих виртуальных машин для подписки Azure, используйте метод **list\_virtual\_machines**. Этот метод возвращает массив объектов **Azure::VirtualMachineManagement::VirtualMachine**:

	vm_mgr = Azure::VirtualMachineService.new
	virtual_machines = vm_mgr.list_virtual_machines

###Практическое руководство. получение информации о виртуальной машине

Чтобы получить экземпляр **Azure::VirtualMachineManagement::VirtualMachine** для конкретной виртуальной машины, используйте метод **get\_virtual\_machine** и укажите имена виртуальной машины и облачной службы:

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.get_virtual_machine('myvm', 'mycloudservice')

###Практическое руководство. удаление виртуальной машины

Чтобы удалить виртуальную машину, используйте метод **delete\_virtual\_machine** и укажите имена виртуальной машины и облачной службы:

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.delete_virtual_machine('myvm', 'mycloudservice')

> [AZURE.WARNING] Метод **delete_virtual_machine** удаляет облачную службу и все диски, связанные с виртуальной машиной:

###Практическое руководство. завершение работы виртуальной машины

Чтобы завершить работу виртуальной машины, используйте метод **shutdown\_virtual\_machine** и укажите имена виртуальной машины и облачной службы:

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.shutdown_virtual_machine('myvm', 'mycloudservice')

###Практическое руководство. запуск виртуальной машины

Чтобы запустить виртуальную машину, используйте метод **start\_virtual\_machine** и укажите имена виртуальной машины и облачной службы:

	vm_mgr = Azure::VirtualMachineService.new
	vm = vm_mgr.start_virtual_machine('myvm', 'mycloudservice')

##<a name="vm-images"> </a>Практическое руководство. Работа с образами и дисками виртуальных машин

Для операций с образами виртуальных машин используется класс **Azure::VirtualMachineImageService**. Для выполнения операций с дисками используется класс **Azure::VirtualMachineImageManagement::VirtualMachineDiskManagementService**.

###Практическое руководство. получение списка образов виртуальных машин

Чтобы получить список образов виртуальных машин, используйте метод **list\_virtual\_machine\_images**. Этот метод возвращает массив объектов **Azure::VirtualMachineImageService**.

	image_mgr = Azure::VirtualMachineImageService.new
	images = image_mgr.list_virtual_machine_images

###Практическое руководство. получение списка дисков

Чтобы получить список дисков для подписки Azure, используйте метод **list\_virtual\_machine\_disks**. Этот метод возвращает массив объектов **Azure::VirtualMachineImageManagement::VirtualMachineDisk**.

	disk_mgr = Azure::VirtualMachineImageManagement::VirtualMachineDiskManagementService.new
	disks = disk_mgr.list_virtual_machine_disks

###Практическое руководство. удаление диска

Чтобы удалить диск, используйте метод **delete\_virtual\_machine\_disk** и укажите имя удаляемого диска:

	disk_mgr = Azure::VirtualMachineImageManagement::VirtualMachineDiskManagementService.new
	disk_mgr.delete_virtual_machine_disk

##<a name="cloud-services"> </a>Практическое руководство. Работа с облачными службами

Операции управления для облачных служб Azure выполняются с использованием класса **Azure::CloudService**.

###Практическое руководство. Создание облачной службы

Чтобы создать новую облачную службу, используйте метод **create\_cloud\_service** и укажите имя и хэш параметров. Допустимые параметры:

* **:location** - *Обязательный параметр*. Регион, в котором будет создана облачная служба.

* **:description** - Описание облачной службы.

Следующий код создает новую облачную службу в регионе "East US" (Восток США):

	cs_mgr = Azure::CloudService.new
	cs_mgr.create_cloud_service('mycloudservice', { :location => 'East US' })

###Практическое руководство. получение списка облачных служб

Чтобы получить список облачных служб для подписки Azure, используйте метод **list\_cloud\_services**. Этот метод возвращает массив объектов **Azure::CloudServiceManagement::CloudService**.

	cs_mgr = Azure::CloudService.new
	cloud_services = cs_mgr.list_cloud_services

###Практическое руководство. проверка наличия облачной службы

Чтобы проверить, существует ли уже облачная служба, используйте метод **get\_cloud\_service** и укажите имя облачной службы. Если облачная служба с указанным именем существует, возвращается значение **true**; в противном случае -значение **false**.

	cs_mgr = Azure::CloudService.new
	cs_exists = cs_mgr.get_cloud_service('mycloudservice')

###Практическое руководство. Удаление облачной службы

Чтобы удалить облачную службу, используйте метод **delete\_cloud\_service** и укажите имя облачной службы:

	cs_mgr = Azure::CloudService.new
	cs_mgr.delete_cloud_service('mycloudservice')

###Практическое руководство. Удаление развертывания

Чтобы удалить развертывание для облачной службы, используйте метод **delete\_cloud\_service\_deployment** и укажите имя облачной службы:

	cs_mgr = Azure::CloudService.new
	cs_mgr.delete_cloud_service_deployment('mycloudservice')

##<a name="storage-services"> </a>Практическое руководство. Работа со службами хранилища

Операции управления для облачных служб Azure выполняются с использованием класса **Azure::StorageService**.

###Практическое руководство. Создание учетной записи хранения

Чтобы создать новую учетную запись хранения, используйте метод **create\_storage\_account** и укажите имя и хэш параметров. Допустимые параметры:

* **:location** - *Обязательный параметр*. Регион, в котором будет создана учетная запись хранения.

* **:description** - Описание учетной записи хранения.

Следующий код создает новую учетную запись хранения в регионе "East US" (Восток США):

	storage_mgr = Azure::StorageService.new
	storage_mgr.create_storage_account('mystorage', { :location => 'East US' })

###Практическое руководство. получение списка учетных записей хранения

Чтобы получить список учетных записей хранения для подписки Azure, используйте метод **list\_storage\_accounts**. Этот метод возвращает массив объектов **Azure::StorageManagement::StorageAccount**.

	storage_mgr = Azure::StorageService.new
	accounts = storage_mgr.list_storage_accounts

###Практическое руководство. проверка наличия учетной записи хранения

Чтобы проверить, существует ли конкретная учетная запись хранения, используйте метод **get\_storage\_account** и укажите имя этой учетной записи хранения. Если учетная запись хранения существует, возвращается значение **true**; в противном случае - значение **false**.

	storage_mgr = Azure::StorageService.new
	store_exists = storage_mgr.get_storage_account('mystorage')

###Практическое руководство. Удаление учетной записи хранения

Чтобы удалить учетную запись хранения, используйте метод **delete\_storage\_account** и укажите имя учетной записи хранения.

	storage_mgr = Azure::StorageService.new
	storage_mgr.delete_storage_account('mystorage')

##<a name="next-steps"> </a>Дальнейшие действия

Вы изучили основы создания виртуальных машин Azure программными средствами. Дополнительные сведения о других действиях при работе с виртуальными машинами можно найти по приведенным ниже ссылкам.

* Посетите страницу компонента [Виртуальные машины](http://www.windowsazure.com/ru-ru/documentation/services/virtual-machines/).
*  См. справочник MSDN: [Виртуальные машины](http://msdn.microsoft.com/ru-ru/library/windowsazure/jj156003.aspx)
* Узнайте, как разместить [приложение Ruby on Rails на виртуальной машине](http://www.windowsazure.com/ru-ru/develop/ruby/tutorials/web-app-with-linux-vm/)

<!--HONumber=42-->
