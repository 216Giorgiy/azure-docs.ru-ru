<properties
   pageTitle="Устранение неполадок с оперативной аналитикой"
   description="Дополнительные сведения об устранении неполадок с оперативной аналитикой"
   services="operational-insights"
   documentationCenter=""
   authors="bandersmsft"
   manager="jwhit"
   editor="tysonn" />
<tags
   ms.service="operational-insights"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/02/2015"
   ms.author="banders" />

#Устранение неполадок с оперативной аналитикой

[AZURE.INCLUDE [operational-insights-note-moms](../../includes/operational-insights-note-moms.md)]

Для устранения неполадок используйте сведения в следующих разделах. Если ваша проблема не описана в этой статье, попробуйте найти ее в [блоге группы Operational Insights](http://blogs.technet.com/b/momteam/archive/2014/05/29/advisor-error-3000-unable-to-register-to-the-advisor-service-amp-onboarding-troubleshooting-steps.aspx).

## Диагностика проблем с подключением для оперативной аналитики

Так как оперативная аналитика Microsoft Azure использует данные, которые перемещает в облако и получает из него, проблемы с подключением могут оказаться критическими. Воспользуйтесь следующей информацией, чтобы определить и решить проблемы с подключением.


**Сообщение об ошибке.** Подключение к Интернету проверено, но не удалось установить подключение к службе Operational Insights. Повторите попытку позже.

**Возможные причины.** — Служба Operational Insights находится на обслуживании. Дождитесь окончания ее обслуживания. — Ваша сеть заблокировала службу Operational Insights. Обратитесь к администратору сети и запросите доступ к службе оперативной аналитики или используйте другой сервер в качестве шлюза.

**Сообщение об ошибке.** Не удалось установить подключение к Интернету. Проверьте параметры прокси-сервера.

**Возможные причины.** — Этот сервер не подключен к Интернету. Проверьте состояние подключения к Интернету и подключите сервер к Интернету. — Задан неправильный параметр прокси-сервера. Дополнительные сведения о том, как задать или изменить параметры прокси-сервера, см. в разделе [Настройка параметров прокси-сервера или брандмауэра](operational-insights-proxy-firewall.md). — Для прокси-сервера требуется проверка подлинности. Дополнительные сведения о том, как настроить в Operations Manager использование прокси-сервера, см. в разделе [Настройка параметров прокси-сервера и брандмауэра](operational-insights-proxy-firewall.md).


## Устранение неполадок обнаружения SQL Server

Если вы используете Microsoft SQL Server 2008 R2 и, несмотря на развертывание агента Operations Manager, не видите оповещений для этого сервера, возможно, возникла проблема с обнаружением.

Чтобы проверить, действительно ли это так, просмотрите следующие две проблемы.

- В журнале событий Operations Manager отображается событие с идентификатором 4001. Это событие означает наличие недопустимого класса.

- В SQL Server Configuration Manager при просмотре служб SQL Server вы видите сообщение об ошибке: «Сбой вызова удаленной процедуры. [0x0800706be]»

Если напротив обеих проблем стоит true, необходимо установить SQL Server 2008 R2 с пакетом обновления 2 (SP2). Чтобы загрузить этот пакет обновления, перейдите по ссылке [SQL Server 2008 R2 с пакетом обновления 2 (SP2)](http://go.microsoft.com/fwlink/?LinkId=271310) в Центре загрузки Майкрософт.

После установки пакета обновления данные оперативной аналитики для сервера отобразятся в течение 24 часов.

## Устранение неполадок с агентами или потоком данных Operations Manager в службе оперативной аналитики

Следующий набор процедур следует использовать как руководство, которое поможет устранить неполадки с напрямую подключенными агентами или развертываниями Operations Manager, настроенными для передачи данных в службу оперативной аналитики Azure.

### Процедура 1. Проверка правильности загруженных пакетов управления в среду Operations Manager
>[AZURE.NOTE]Если вы используете только Direct Agent, вы можете перейти к следующей процедуре.

Количество отображаемых решений (ранее называемых «пакетами аналитики») зависит от того, какие решения включены на портале OpInsights. Найдите ключевое слово Advisor или Intelligence в их имени. Вы можете искать эти пакеты управления с помощью OpsMgr PowerShell:

```Powershell
Get-SCOMManagementPack | where {$_.DisplayName -match 'Advisor'} | Select Name,Sealed,Version
Get-SCOMManagementPack | where {$_.Name -match 'IntelligencePacks'} | Select Name,Sealed,Version
```

>[AZURE.NOTE]При устранении неполадок для решения управления емкостью проверьте, *сколько* у вас пакетов управления с именем, включающим слово «емкость»: в наборе пакетов управления существует два пакета управления с одним отображаемым именем (но разными внутренними идентификаторами); если один из них не импортировать (это часто случается из-за отсутствующей зависимости VMM), другой пакет управления не импортируется, и операция не выполняется повторно.

Должно отображаться три пакета управления, связанных с емкостью: пакет аналитики емкости Microsoft System Center Advisor, пакет аналитики емкости Microsoft System Center Advisor и данные хранилища емкости Microsoft System Center Advisor.

Если вы видите только один или два, а не все три пакета, подождите 5–10 минут, пока Operations Manager повторно скачает и импортирует их, а тем временем проверьте журналы событий на предмет ошибок в этот период.

### Процедура 2. Проверка правильности загруженных решений в Direct Agent
>[AZURE.NOTE]Если вы используете только Operations Manager, можно пропустить эту процедуру.

В Direct Agent политика коллекции решений должна кэшироваться в папке **C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\Health Service State\\Management Packs**.


### Процедура 3. Проверка отправки данных в службу Advisor (или попытки отправки)
В зависимости от того, используете ли вы напрямую подключенные агенты или Operations Manager, можно выполнить следующую процедуру на компьютере Direct Agent или на сервере управления Operations Manager.

1. - Откройте «Системный монитор».
2. - Выберите «Группы управления службы работоспособности».
3. - Добавьте все счетчики, которые начинаются с HTTP.

Если все настроено правильно, по мере отправки событий и других элементов данных (на основе решений, выставленных на портале, и настроенной политики сбора журналов) для этих счетчиков должны появиться действия. Эти счетчики не должны быть постоянно заняты — если действия не происходят, возможно, вы выставили немного решений или у вас очень простая политика сбора.

### Процедура 4. Проверка ошибок в журналах событий сервера управления или Direct Agent
Наконец, если вы выполнили все вышеперечисленное, но служба все еще не получает данные, проверьте ошибки в **средстве просмотра событий**.

Откройте **Средство просмотра событий** –> **Приложение и службы** –> **Operations Manager** и примените фильтр по источникам событий: **Advisor**, **Модули службы работоспособности**, **Служба работоспособности** и **Соединитель служб** (последнее применяется только к Direct Agent).

Большинство этих событий, а также шаги по устранению неполадок будут аналогичны в Operations Manager и Direct Agent. Единственное отличие между Operations Manager и Direct Agent — это процесс регистрации (GUI в Operations Manager; комбинация идентификатора и ключа рабочей области в Direct Agent), но после первоначальной регистрации происходит обмен сертификатами и все остальное взаимодействие со службой происходит аналогично.

Следовательно, многие из этих событий применяются к обоим типам инфраструктуры отчетности. Далее представлен список наиболее частых из них.

### События из источника «Модули службы работоспособности»
##### EventID 2138
Это означает, что для прокси-сервера требуется проверка подлинности. Выполните действия по [настройке прокси-серверов](https://msdn.microsoft.com/library/azure/dn884643.aspx).

##### EventID 2137
Operations Manager не может прочитать сертификат проверки подлинности. Повторный запуск мастера регистрации Advisor исправит сертификаты и учетные записи запуска от имени

##### EventID 2132
Это означает **Не авторизовано**. Возможно, возникла проблема с сертификатом или регистрацией в службе; попробуйте перезапустить мастер регистрации, который исправит сертификаты и учетные записи запуска от имени. Кроме того, убедитесь, что на прокси-сервере разрешены исключения. Дополнительные сведения см. в разделе [Настройка прокси-серверов](https://msdn.microsoft.com/library/azure/dn884643.aspx).

##### EventID 2129
Это подключение, завершившееся сбоем из-за сбоя согласования SSL. Настройте системы для использования TLS, а не SSL. На этом сервере могут быть заданы необычные параметры SSL для шифров в меню **Дополнительно** Internet Explorer или в разделе реестра Windows.

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL

##### EventID 2127
При отправке данных о сбое был получен код ошибки. Если это происходит редко, возможно, это простой сбой. Обратите внимание на их частоту. Если сбои происходят очень часто (каждые 10 минут в течение продолжительного периода времени), это действительно может быть ошибкой. Проверьте параметры сети и прокси-сервера, описанные выше, и перезапустите мастер регистрации. Но если это происходит только время от времени (т. е. пару раз в день), все должно быть нормально после того, как данные будут поставлены в очередь и повторно переданы. Возможно, время ожидания сети истекло (если это происходит с такой периодичностью).

Некоторые коды ошибок HTTP имеют следующие специальные значения:

- при ПЕРВОЙ отправке данных MMA Direct Agent или сервером управления в службу появится ошибка 500 с внутренним кодом ошибки 404 (404 означает «не найдено»). Это указывает на то, что область хранилища, которая будет использоваться для этой новой рабочей области, еще не готова — идет ее подготовка. Однако при следующей попытке она будет готова и поток начнет работать (в обычных условиях).
- 403 может указывать на проблему с разрешениями или учетными данными и т. д.

##### EventID 2128
Сбой разрешения DNS-имени. Ваш сервер не может разрешить адрес в Интернете, по которому ему следует отправлять данные. Возможно, неправильно настроены параметры сопоставителя DNS на компьютере, параметры прокси-сервера или возникла (временная) проблема с DNS у поставщика. Как и в предыдущем событии, в зависимости от того, постоянно это происходит или время от времени, это может указывать или не указывать на ошибку.

##### EventID 2130
Время ожидания истекло. Как и в предыдущем событии, в зависимости от того, постоянно это происходит или время от времени, это может указывать или не указывать на ошибку.

### События из источника «Служба работоспособности»
##### EventID 4511
Не удается загрузить модуль System.PublishDataToEndPoint — файл не найден. Сбой инициализации модуля типа System.PublishDataToEndPoint (CLSID {D407D659-65E4-4476-BF40-924E56841465}) с кодом ошибки «Система не может найти указанный файл». Эта ошибка означает, что библиотеки DLL на компьютере устарели и не содержат нужные модули. Чтобы это исправить, обновите серверы управления до последнего накопительного пакета обновления.

##### EventID 4502
Сбой модуля. Если это происходит для рабочих процессов с такими именами, как **CollectInstanceSpace** или **CollectTypeSpace**, возможно, на сервере возникли проблемы с отправкой данных конфигурации. В зависимости от частоты происходящего (постоянно или время от времени) это может указывать или не указывать на ошибку. Если сбой происходит чаще, чем раз в час, это определенно представляет проблему. Если сбой операции происходит один или два раза в день, она будет восстановлена. В зависимости от того, как происходит сбой модуля (в описании содержатся дополнительные сведения), это может быть локальной ошибкой, т. е. при сборе данных в базу данных, или ошибкой отправки в облако. Проверьте параметры сети и прокси-сервера и в крайнем случае попробуйте перезапустить HealthService.

##### EventID 4501
Сбой модуля System.PublishDataToEndPoint. Модуль типа System.PublishDataToEndPoint сообщил об ошибке 87L в рамках правила Microsoft.SystemCenter.CollectAlertChangeDataToCloud, выполняющегося для экземпляра «Группа управления Operations Manager» с идентификатором {6B1D1BE8-EBB4-B425-08DC-2385C5930B04} в группе управления SCOMTEST. Эта ошибка больше *не* должна появляться в этом рабочем процессе и модуле, так как [ошибка* теперь исправлена*](http://feedback.azure.com/forums/267889-azure-operational-insights/suggestions/6714689-alert-management-intelligence-pack-not-sending-ale). При возникновении сообщите о ней по любому предпочтительному каналу поддержки Майкрософт.


### События из источника «Соединитель служб»
##### EventID 4002
Служба вернула код состояния HTTP 403 в ответ на запрос. Обратитесь к администратору службы, чтобы проверить ее работоспособность. Повторная попытка запроса будет выполнена позже. Вы можете получить ошибку 403 во время первоначальной регистрации агента. Появится следующий URL-адрес: https://<YourWorkspaceID>.oms.opinsights.azure.com/AgentService.svc/AgentTopologyRequest. Код ошибки 403 означает «запрещено» — обычно он вызывается из-за неправильно скопированного значения идентификатора рабочей области или ключа либо из-за того, что часы на компьютере не синхронизированы. Попробуйте выполнить синхронизацию с надежным источником времени и используйте проверку подключения в приложении панели управления для Microsoft Monitoring Agent, чтобы убедиться, что у вас есть нужный идентификатор рабочей области и ключ.


### Процедура 5. Проверка отправки агентами данных и их индексирования на портале
Откройте портал OpInsights. Со страницы «Обзор» перейдите на маленькую плитку **Серверы и использование**, чтобы посмотреть, отправляют ли группы управления (и их агенты) и агенты Direct Agent данные в систему поиска журналов. Количество агентов на плитке является производным от данных: если компьютеры не сообщают данные в течение 2 недель, радар будет отключен.

Детализация позволит перейти в систему поиска журналов и просмотреть метку времени последних индексированных данных для каждого компьютера. Здесь вы можете просмотреть, что это за данные. Расписание и скорость передачи данных могут различаться в зависимости от заданного объема собираемых данных и решений.

На этой странице также предоставлены сведения об измерении объемов данных с разбивкой по решению (при этом используется не индекс поиска журналов, а система выставления счетов, которая обновляется каждые несколько часов).

<!---HONumber=August15_HO6-->