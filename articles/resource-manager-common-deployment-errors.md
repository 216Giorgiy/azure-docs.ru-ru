---
title: Устранение распространенных ошибок развертывания в Azure | Microsoft Docs
description: Описывается устранение распространенных ошибок при развертывании ресурсов в Azure с помощью Azure Resource Manager.
services: azure-resource-manager
documentationcenter: ''
tags: top-support-issue
author: tfitzmac
manager: timlt
editor: tysonn
keywords: ошибка развертывания, развертывание Azure, развернуть в Azure

ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/14/2016
ms.author: tomfitz

---
# Устранение распространенных ошибок развертывания в Azure с помощью Azure Resource Manager | Microsoft Azure
В этой статье объясняется, как устранить некоторые распространенные ошибки при развертывании в Azure. Если вам необходима дополнительная информация о причинах сбоя развертывания, сначала ознакомьтесь со статьей [Просмотр операций развертывания с помощью портала Azure](resource-manager-troubleshoot-deployments-portal.md), а затем вернитесь к этой статье, чтобы узнать, как устранить ошибку.

## Недопустимый шаблон или ресурс
При развертывании шаблона может возникнуть такая ошибка:

    Code=InvalidTemplate 
    Message=Deployment template validation failed

Если появится сообщение о том, что шаблон или свойство ресурса является недопустимым, возможно, в шаблоне есть синтаксическая ошибка. Такую ошибку легко допустить, так как выражения шаблонов могут быть сложными. Например, представленное ниже присвоение имени для учетной записи хранения содержит один набор квадратных скобок, три функции, три набора круглых скобок, один набор одинарных кавычек и одно свойство:

    "name": "[concat('storage', uniqueString(resourceGroup().id))]",

Если вы не укажете весь соответствующий синтаксис, шаблон создаст значение, которое будет в значительной степени расходиться с вашими ожиданиями.

При получении сообщения об ошибке такого типа тщательно проверьте синтаксис выражения. Рекомендуется использовать редактор JSON, например [Visual Studio](vs-azure-tools-resource-groups-deployment-projects-create-deploy.md) или [Visual Studio Code](resource-manager-vs-code.md), в котором отображаются предупреждения о синтаксических ошибках.

## Неправильная длина сегментов
Шаблон также считается недопустимым, если имя ресурса указано в неправильном формате.

    Code=InvalidTemplate
    Message=Deployment template validation failed: 'The template resource {resource-name}' 
    for type {resource-type} has incorrect segment lengths.

Имя ресурса на корневом уровне должно содержать на один сегмент меньше, чем тип ресурса. Каждый сегмент разделяется косой чертой. В следующем примере тип содержит 2 сегмента, а имя — 1 сегмент. Так что это **допустимое имя**.

    {
      "type": "Microsoft.Web/serverfarms",
      "name": "myHostingPlanName",

В приведенном ниже примере указано **недопустимое имя**, так как оно содержит такое же количество сегментов, что и тип.

    {
      "type": "Microsoft.Web/serverfarms",
      "name": "appPlan/myHostingPlanName",

В случае дочерних ресурсов тип и имя должны содержать одинаковое количество сегментов. Это связано с тем, что полное имя и тип дочернего ресурса включают в себя имя и тип родительского ресурса, поэтому полное имя по-прежнему содержит на один сегмент меньше, чем полный тип.

    "resources": [
        {
            "type": "Microsoft.KeyVault/vaults",
            "name": "contosokeyvault",
            ...
            "resources": [
                {
                    "type": "secrets",
                    "name": "appPassword",

Разобраться с правильной длиной сегментов особенно сложно при использовании типов Resource Manager, которые применяются для поставщиков ресурсов. Например, для применения блокировки ресурсов на веб-сайте требуется тип с 4 сегментами. Поэтому имя содержит 3 сегмента:

    {
        "type": "Microsoft.Web/sites/providers/locks",
        "name": "[concat(variables('siteName'),'/Microsoft.Authorization/MySiteLock')]",

## Имя ресурса уже существует или используется другим ресурсом
Для некоторых ресурсов, особенно для учетных записей хранения, серверов баз данных и веб-сайтов, необходимо указывать имя ресурса, которое будет уникальным в Azure. Если не указать уникальное имя, может возникнуть такая ошибка:

    Code=StorageAccountAlreadyTaken 
    Message=The storage account named mystorage is already taken.

Уникальное имя можно создать, используя соглашение об именовании и результат функции [uniqueString](resource-group-template-functions.md#uniquestring).

    "name": "[concat('contosostorage', uniqueString(resourceGroup().id))]",
    "type": "Microsoft.Storage/storageAccounts",

## Не удается найти ресурс во время развертывания
Resource Manager оптимизирует развертывание, создавая ресурсы параллельно, когда это возможно. Если один ресурс необходимо развернуть после другого, создайте зависимость от другого ресурса, используя в шаблоне элемент **dependsOn**. Например, при развертывании веб-приложения вам нужно создать план службы приложений. Если вы не указали, что веб-приложение зависит от плана службы приложений, Resource Manager создаст оба ресурса одновременно. При попытке указать свойство веб-приложения вы получите сообщение о том, что невозможно найти ресурс плана службы приложений, так как он еще не существует. Чтобы предотвратить эту ошибку, в веб-приложении следует настроить зависимость.

    {
      "apiVersion": "2015-08-01",
      "type": "Microsoft.Web/sites",
      ...
      "dependsOn": [
        "[variables('hostingPlanName')]"
      ],
      ...
    }

## Не удалось найти элемент copy в объекте
Эта ошибка возникает в случае применения элемента **copy** к части шаблона, которая не поддерживает этот элемент. Элемент copy можно применять только к типу ресурса. Нельзя применять элемент copy к свойству в типе ресурса. Например, его можно применить к виртуальной машине, но не к дискам операционной системы виртуальной машины. В некоторых случаях можно преобразовывать дочерние ресурсы в родительские для создания цикла копирования. Дополнительные сведения об использовании элемента copy см. в статье [Создание нескольких экземпляров ресурсов в Azure Resource Manager](resource-group-create-multiple.md).

## Номер SKU недоступен
При развертывании ресурса (как правило, виртуальной машины) могут появиться код ошибки и сообщение об ошибке:

    Code: SkuNotAvailable
    Message: The requested tier for resource '<resource>' is currently not available in location '<location>' for subscription '<subscriptionID>'. Please try another tier or deploy to a different location.

Эта ошибка возникает, когда выбранный номер SKU ресурса (например, размер виртуальной машины) недоступен для указанного расположения. Существует два способа решения этой проблемы.

1. Войдите на портал и добавьте новый ресурс с помощью пользовательского интерфейса. Когда значения будут заданы, вы увидите доступные номера SKU для этого ресурса.
   
   ![доступные номера sku](./media/resource-manager-common-deployment-errors/view-sku.png)
2. Если вам не удастся найти подходящий номер SKU в этом или альтернативном регионе, который соответствует потребностям вашей компании, обратитесь в [службу поддержки Azure](https://portal.azure.com/#create/Microsoft.Support).

## Зарегистрированные поставщики не найдены
При развертывании ресурсов вы можете получить следующий код ошибки и сообщение об ошибке:

    Code: NoRegisteredProviderFound
    Message: No registered resource provider found for location '<location>' and API version '<api-version>' for type '<resource-type>'.

Эта ошибка возникает по одной из следующих причин.

1. Расположение не поддерживается для выбранного типа ресурса.
2. Версия API не поддерживается для выбранного типа ресурса.
3. Для подписки не зарегистрирован поставщик ресурсов.

В сообщении об ошибке должны быть указаны поддерживаемые расположения и версии API. Вы можете изменить шаблон, используя одно из предложенных значений. Большинство поставщиков, но не все, регистрируются автоматически порталом Azure или интерфейсом командной строки, который вы используете. Если ранее вы не использовали конкретный поставщик ресурсов, возможно, потребуется зарегистрировать такой поставщик. C помощью приведенных ниже команд вы можете получить дополнительную информацию о поставщиках ресурсов.

### PowerShell
Чтобы просмотреть состояние регистрации, используйте командлет **Get-AzureRmResourceProvider**.

    Get-AzureRmResourceProvider -ListAvailable

Чтобы зарегистрировать поставщик, используйте командлет **Register-AzureRmResourceProvider** и укажите имя поставщика ресурсов, который необходимо зарегистрировать.

    Register-AzureRmResourceProvider -ProviderNamespace Microsoft.Cdn

Чтобы получить поддерживаемые расположения для определенного типа ресурсов, используйте следующую команду:

    ((Get-AzureRmResourceProvider -ProviderNamespace Microsoft.Web).ResourceTypes | Where-Object ResourceTypeName -eq sites).Locations

Чтобы получить поддерживаемые версии API для определенного типа ресурсов, используйте следующую команду:

    ((Get-AzureRmResourceProvider -ProviderNamespace Microsoft.Web).ResourceTypes | Where-Object ResourceTypeName -eq sites).ApiVersions

### Инфраструктура CLI Azure
Чтобы узнать, зарегистрирован ли поставщик, используйте команду `azure provider list`.

    azure provider list

Чтобы зарегистрировать поставщик ресурсов, используйте команду `azure provider register` и укажите *пространство имен*, которое следует зарегистрировать.

    azure provider register Microsoft.Cdn

Чтобы просмотреть поддерживаемые расположения и версии API для поставщика ресурсов, используйте следующую команду:

    azure provider show -n Microsoft.Compute --json > compute.json

## Превышена квота
Кроме того, при развертывании могут возникнуть проблемы при достижении квоты, которая может задаваться для группы ресурсов, подписок, учетных записей и других областей. Например, в подписке может быть настроено ограничение количества ядер для определенного региона. При попытке развертывания виртуальной машины с большим количеством ядер, чем разрешено, вы получите сообщение о том, что квота превышена. Полные сведения о квотах см. в статье [Подписка Azure, границы, квоты и ограничения службы](azure-subscription-service-limits.md).

Проверить квоты ядер в своей подписке можно с помощью команды `azure vm list-usage` в интерфейсе командной строки Azure. В примере ниже показано, что квота ядер для бесплатной пробной учетной записи равна 4:

    azure vm list-usage

Возвращаемые данные:

    info:    Executing command vm list-usage
    Location: westus
    data:    Name   Unit   CurrentValue  Limit
    data:    -----  -----  ------------  -----
    data:    Cores  Count  0             4
    info:    vm list-usage command OK

Если попытаться развернуть шаблон, который создает более 4 ядер в регионе "Западная часть США" для указанной выше подписки, произойдет ошибка развертывания, которая может выглядеть следующим образом (на портале или при проверке журналов развертывания):

    statusCode:Conflict
    serviceRequestId:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    statusMessage:{"error":{"code":"OperationNotAllowed","message":"Operation results in exceeding quota limits of Core. Maximum allowed: 4, Current in use: 4, Additional requested: 2."}}

Можно также использовать командлет PowerShell **Get-AzureRmVMUsage**.

    Get-AzureRmVMUsage

Возвращаемые данные:

    ...
    CurrentValue : 0
    Limit        : 4
    Name         : {
                     "value": "cores",
                     "localizedValue": "Total Regional Cores"
                   }
    Unit         : null
    ...

В таких случаях следует перейти на портал и зарегистрировать проблему в службе поддержки, чтобы поднять свою квоту для региона, в котором требуется осуществить развертывание.

> [!NOTE]
> Следует помнить, что для групп ресурсов квоты устанавливаются для каждого отдельного региона, а не для всей подписки. Если необходимо развернуть 30 ядер в западной части США, необходимо запросить 30 ядер управления ресурсами в этом регионе. Если необходимо развернуть 30 ядер в любом из регионов, к которым у вас есть доступ, следует запросить 30 ядер управления ресурсами во всех регионах.
> 
> 

## Ошибка авторизации
Эта ошибка может возникнуть во время развертывания, если учетная запись или субъект-служба, пытающиеся развернуть ресурсы, не имеют доступа на выполнение этих действий. Azure Active Directory позволяет вам или вашему администратору управлять удостоверениями, которые могут получать доступ к тем или иным ресурсам. Например, если учетной записи назначена роль "Читатель", такая учетная запись не сможет создавать ресурсы. В таком случае появится сообщение об ошибке авторизации.

Дополнительные сведения об управлении доступом на основе ролей см. в [этой статье](active-directory/role-based-access-control-configure.md).

Помимо управления доступом на основе ролей, действия по развертыванию можно ограничить, применив к подписке политики. С помощью политик администратор может обеспечить выполнение соглашений на всех ресурсах, развернутых в подписке. Например, администратор может указать, что для того или иного типа ресурса следует указывать определенное значение тега. Если требования политики не будут выполнены, во время развертывания возникнет ошибка. Дополнительные сведения о политиках см. в статье [Применение политик для управления ресурсами и контроля доступа](resource-manager-policy.md).

## Устранение неполадок на виртуальных машинах
| Ошибка | Статьи |
| --- | --- |
| Ошибки расширений пользовательских скриптов |[Устранение неполадок расширений для виртуальных машин Windows](virtual-machines/virtual-machines-windows-extensions-troubleshoot.md)<br /> или <br />[Устранение неполадок расширения виртуальной машины Linux](virtual-machines/virtual-machines-linux-extensions-troubleshoot.md) |
| Ошибки при подготовке образа операционной системы |[Устранение неполадок в развертывании Resource Manager при создании виртуальной машины Windows в Azure](virtual-machines/virtual-machines-windows-troubleshoot-deployment-new-vm.md)<br /> или <br />[Устранение неполадок в развертывании Resource Manager при создании виртуальной машины Linux в Azure](virtual-machines/virtual-machines-linux-troubleshoot-deployment-new-vm.md) |
| Ошибки выделения ресурсов |[Устранение ошибок выделения ресурсов при создании, перезагрузке или изменении размера виртуальных машин Windows в Azure](virtual-machines/virtual-machines-windows-allocation-failure.md)<br /> или <br />[Устранение ошибок выделения ресурсов при создании, перезагрузке или изменении размера виртуальных машин Linux в Azure](virtual-machines/virtual-machines-linux-allocation-failure.md) |
| Ошибки Secure Shell (SSH) при попытке подключения |[Устранение неполадок с подключением Secure Shell к виртуальной машине Azure под управлением Linux](virtual-machines/virtual-machines-linux-troubleshoot-ssh-connection.md) |
| Ошибки при подключении к приложению, выполняющемуся на виртуальной машине |[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines/virtual-machines-windows-troubleshoot-app-connection.md)<br /> (Windows) или <br />[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines/virtual-machines-linux-troubleshoot-app-connection.md) (Linux) |
| Ошибки при подключении к удаленному рабочему столу |[Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](virtual-machines/virtual-machines-windows-troubleshoot-rdp-connection.md) |
| Ошибки подключения, устраняемые путем повторного развертывания |[Повторное развертывание виртуальной машины на новом узле Azure](virtual-machines/virtual-machines-windows-redeploy-to-new-node.md) |
| Ошибки облачной службы |[Устранение неполадок, которые могут возникнуть при развертывании облачной службы](cloud-services/cloud-services-troubleshoot-deployment-problems.md) |

## Устранение неполадок в других службах
Следующая таблица не является полным списком статей по устранению неполадок в Azure. Она посвящена проблемам, связанным с развертыванием или настройкой ресурсов. Если вам нужна помощь в устранении неполадок во время выполнения, см. документацию для соответствующей службы Azure.

| служба | Статья |
| --- | --- |
| Автоматизация |[Советы по устранению неполадок при возникновении типичных ошибок в службе автоматизации Azure](automation/automation-troubleshooting-automation-errors.md) |
| Azure Stack |[Microsoft Azure Stack troubleshooting (Устранение неполадок, связанных с Microsoft Azure Stack)](azure-stack/azure-stack-troubleshooting.md) |
| Azure Stack |[Web Apps Resource Provider - Known Issues and Troubleshooting (Поставщик ресурсов веб-приложений. Известные проблемы и их решение)](azure-stack/azure-stack-webapps-troubleshoot-known-issues.md) |
| Фабрика данных |[Устранение неполадок фабрики данных](data-factory/data-factory-troubleshoot.md) |
| Service Fabric |[Устранение распространенных проблем при развертывании служб в Azure Service Fabric](service-fabric/service-fabric-diagnostics-troubleshoot-common-scenarios.md) |
| Site Recovery |[Мониторинг и устранение неполадок защиты виртуальных машин и физических серверов](site-recovery/site-recovery-monitoring-and-troubleshooting.md) |
| Хранилище |[Наблюдение, диагностика и устранение неисправностей хранилища Microsoft Azure](storage/storage-monitoring-diagnosing-troubleshooting.md) |
| StorSimple |[Устранение неполадок в развертывании устройства StorSimple](storsimple/storsimple-troubleshoot-deployment.md) |
| База данных SQL |[Устранение неполадок подключения к базе данных SQL Azure](sql-database/sql-database-troubleshoot-common-connection-issues.md) |
| Хранилище данных SQL |[Устранение неполадок хранилища данных SQL Azure](sql-data-warehouse/sql-data-warehouse-troubleshoot.md) |

## Как понять, что развертывание готово
Azure Resource Manager сообщает об успешном выполнении развертывания при успешном возврате всех поставщиков из развертывания. Однако это не обязательно означает, что ваша группа ресурсов "активна и готова для пользователей". Например, для развертывания может потребоваться скачать обновления, дождаться возможности использования других ресурсов, не являющихся шаблонами, или установить сложные скрипты либо другое исполняемое действие, о котором среде Azure не известно, так как оно не отслеживается поставщиком. В таких случаях ресурсы могут быть готовы к практическому использованию только спустя некоторое время. В результате этого следует ожидать, что состояние развертывания меняется на "успешно" за некоторое время до того, прежде чем развертывание можно будет использовать.

Тем не менее вы можете сделать так, чтобы Azure не сообщал об успешном развертывании, создав настраиваемый сценарий для пользовательского шаблона (например, с помощью [CustomScriptExtension](https://azure.microsoft.com/blog/2014/08/20/automate-linux-vm-customization-tasks-using-customscript-extension/)), который умеет отслеживать все развертывание на предмет готовности в рамках всей системы и возвращает успешный результат только в том случае, если пользователи могут работать со всем развертыванием. Если вы хотите сделать так, чтобы ваше расширение выполнялось последним, используйте свойство **dependsOn** в шаблоне.

## Дальнейшие действия
* Сведения о действиях аудита см. в статье [Операции аудита с помощью Resource Manager](resource-group-audit.md).
* Дополнительные сведения об определении ошибок во время развертывания см. в статье [Просмотр операций развертывания с помощью портала Azure](resource-manager-troubleshoot-deployments-portal.md).

<!---HONumber=AcomDC_0720_2016-->