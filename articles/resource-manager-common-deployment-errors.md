<properties
   pageTitle="Распространенные ошибки развертывания в Azure | Microsoft Azure"
   description="В этой статье описываются способы устранения распространенных ошибок во время развертывания с помощью Azure Resource Manager."
   services="azure-resource-manager"
   documentationCenter=""
   tags=""
   authors="tfitzmac"
   manager="timlt"
   editor="tysonn"/>

<tags
   ms.service="azure-resource-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/19/2016"
   ms.author="tomfitz"/>

# Устранение распространенных ошибок при развертывании ресурсов в Azure с помощью Azure Resource Manager

В этой статье объясняется, как устранить некоторые распространенные ошибки, которые могут возникнуть при развертывании ресурсов в Azure. Дополнительные сведения об устранении неполадок развертывания см. в статье [Устранение неполадок развертываний групп ресурсов с помощью портала Azure](resource-manager-troubleshoot-deployments-portal.md).

Некоторых ошибок можно избежать, проверив шаблон и параметры перед развертыванием. Примеры проверки шаблона см. в статье [Развертывание группы ресурсов с использованием шаблона Azure Resource Manager](resource-group-template-deploy.md).

## Недопустимый шаблон или ресурс

Если появится сообщение о том, что шаблон или свойство ресурса является недопустимым, возможно, в шаблоне пропущен символ. Эта ошибка часто возникает при использовании выражений шаблона, так как выражение заключено в кавычки. В таком случае JSON продолжает проверку, и редактор может не обнаружить ошибку. Например, представленное ниже присвоение имени для учетной записи хранения содержит один набор квадратных скобок, три функции, три набора круглых скобок, один набор одинарных кавычек и одно свойство:

    "name": "[concat('storage', uniqueString(resourceGroup().id))]",

Если вы не укажете весь соответствующий синтаксис, шаблон создаст значение, которое будет в значительной степени расходиться с вашими ожиданиями.

В зависимости от места, в котором отсутствует символ в шаблоне, появится сообщение о недопустимом шаблоне или ресурсе. Кроме того, сообщение об ошибке может указывать на то, что в процессе развертывания не удалось обработать выражение языка шаблона. При получении сообщения об ошибке такого типа тщательно проверьте синтаксис выражения.

## Имя ресурса уже существует

Для некоторых ресурсов, особенно учетных записей хранения, серверов баз данных и веб-сайтов, необходимо указать имя ресурса, которое будет уникальным в Azure. Уникальное имя можно создать, используя соглашение об именовании и результат функции [uniqueString](./resource-group-template-functions/#uniquestring).
 
    "name": "[concat('contosostorage', uniqueString(resourceGroup().id))]", 
    "type": "Microsoft.Storage/storageAccounts", 

## Не удается найти ресурс во время развертывания

Resource Manager оптимизирует развертывание, создавая ресурсы параллельно, когда это возможно. Если один ресурс необходимо развернуть после другого, создайте зависимость от другого ресурса, используя в шаблоне элемент **dependsOn**. Например, при развертывании веб-приложения вам нужно создать план службы приложений. Если вы не указали, что веб-приложение зависит от плана службы приложений, Resource Manager создаст оба ресурса одновременно. При попытке указать свойство веб-приложения вы получите сообщение о том, что невозможно найти ресурс плана службы приложений, так как он еще не существует. Чтобы предотвратить эту ошибку, в веб-приложении следует настроить зависимость.

    {
      "apiVersion": "2015-08-01",
      "type": "Microsoft.Web/sites",
      ...
      "dependsOn": [
        "[variables('hostingPlanName')]"
      ],
      ...
    }

## Расположение недоступно для ресурса

При указании расположения для ресурса необходимо использовать одно из расположений, которые поддерживают ресурс. Перед указанием расположения ресурса используйте одну из следующих команд, чтобы убедиться, что это расположение поддерживает тип ресурса.

### PowerShell

Чтобы получить список поддерживаемых типов и расположений для конкретного поставщика ресурсов, используйте командлет **Get-AzureRmResourceProvider**.

    Get-AzureRmResourceProvider -ProviderNamespace Microsoft.Web

Вы получите список типов ресурсов для этого поставщика ресурсов.

    ProviderNamespace RegistrationState ResourceTypes               Locations
    ----------------- ----------------- -------------               ---------
    Microsoft.Web     Registered        {sites/extensions}          {Brazil South, ...
    Microsoft.Web     Registered        {sites/slots/extensions}    {Brazil South, ...
    Microsoft.Web     Registered        {sites/instances}           {Brazil South, ...
    ...

Выбрать расположения для определенного типа ресурсов можно с помощью следующего кода:

    ((Get-AzureRmResourceProvider -ProviderNamespace Microsoft.Web).ResourceTypes | Where-Object ResourceTypeName -eq sites).Locations

Он вернет поддерживаемые расположения:

    Brazil South
    East Asia
    East US
    Japan East
    Japan West
    North Central US
    North Europe
    South Central US
    West Europe
    West US
    Southeast Asia

### Инфраструктура CLI Azure

В интерфейсе командной строки Azure можно использовать команду **azure location list**. Так как список расположений может быть длинным и включать множество поставщиков, с помощью предлагаемых средств можно изучить поставщики и расположения, прежде чем использовать расположение, которое еще не доступно. Следующий сценарий использует средство **jq** для поиска расположений, в которых доступен поставщик ресурсов для виртуальных машин Azure.

    azure location list --json | jq '.[] | select(.name == "Microsoft.Compute/virtualMachines")'
    
Он вернет поддерживаемые расположения:
    
    {
      "name": "Microsoft.Compute/virtualMachines",
      "location": "East US,East US 2,West US,Central US,South Central US,North Europe,West Europe,East Asia,Southeast Asia,Japan East,Japan West"
    }

### Интерфейс REST API

Для API-интерфейса REST см. [Получение сведений о поставщике ресурсов](https://msdn.microsoft.com/library/azure/dn790534.aspx).

## Превышена квота

Кроме того, при развертывании могут возникнуть проблемы при достижении квоты, которая может задаваться для группы ресурсов, подписок, учетных записей и других областей. Например, в подписке может быть настроено ограничение количества ядер для определенного региона. При попытке развертывания виртуальной машины с большим количеством ядер, чем разрешено, вы получите сообщение о том, что квота превышена. Полные сведения о квотах см. в статье [Подписка Azure, границы, квоты и ограничения службы](azure-subscription-service-limits.md).

Проверить квоты ядер в своей подписке можно с помощью команды `azure vm list-usage` в Azure CLI. В примере ниже показано, что квота ядер для бесплатной пробной учетной записи равна 4:

    azure vm list-usage
    
Возвращаемые данные:
    
    info:    Executing command vm list-usage
    Location: westus
    data:    Name   Unit   CurrentValue  Limit
    data:    -----  -----  ------------  -----
    data:    Cores  Count  0             4
    info:    vm list-usage command OK

Если попытаться развернуть шаблон, который создает более 4 ядер в регионе "Западная часть США" для указанной выше подписки, произойдет ошибка развертывания, которая может выглядеть следующим образом (на портале или при проверке журналов развертывания):

    statusCode:Conflict
    serviceRequestId:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    statusMessage:{"error":{"code":"OperationNotAllowed","message":"Operation results in exceeding quota limits of Core. Maximum allowed: 4, Current in use: 4, Additional requested: 2."}}

В PowerShell можно использовать командлет **Get-AzureRmVMUsage**.

    Get-AzureRmVMUsage
    
Возвращаемые данные:

    ...
    CurrentValue : 0
    Limit        : 4
    Name         : {
                     "value": "cores",
                     "localizedValue": "Total Regional Cores"
                   }
    Unit         : null
    ...

В таких случаях следует перейти на портал и зарегистрировать проблему в службе поддержки, чтобы поднять свою квоту для региона, в котором требуется осуществить развертывание.

> [AZURE.NOTE] Следует помнить, что для групп ресурсов квоты устанавливаются для каждого отдельного региона, а не для всей подписки. Если необходимо развернуть 30 ядер в западной части США, необходимо запросить 30 ядер управления ресурсами в этом регионе. Если необходимо развернуть 30 ядер в любом из регионов, к которым у вас есть доступ, следует запросить 30 ядер управления ресурсами во всех регионах.


## Ошибка авторизации

Эта ошибка может возникнуть во время развертывания, если учетная запись или субъект-служба, пытающиеся развернуть ресурсы, не имеют доступа на выполнение этих действий. Azure Active Directory позволяет вам или вашему администратору управлять удостоверениями, которые могут получать доступ к тем или иным ресурсам. Например, если учетной записи назначена роль "Читатель", такая учетная запись не сможет создавать ресурсы. В таком случае появится сообщение об ошибке авторизации.

Дополнительные сведения об управлении доступом на основе ролей см. в статье [Использование назначений ролей для управления доступом к ресурсам Azure Active Directory](./active-directory/role-based-access-control-configure.md).

Помимо управления доступом на основе ролей, действия по развертыванию можно ограничить, применив к подписке политики. С помощью политик администратор может обеспечить выполнение соглашений на всех ресурсах, развернутых в подписке. Например, администратор может указать, что для того или иного типа ресурса следует указывать определенное значение тега. Если требования политики не будут выполнены, во время развертывания возникнет ошибка. Дополнительные сведения о политиках см. в статье [Применение политик для управления ресурсами и контроля доступа](resource-manager-policy.md).

## Проверка регистрации поставщика ресурсов

Ресурсами управляют поставщики ресурсов, и для использования конкретного поставщика его необходимо зарегистрировать в учетной записи или подписке. Большинство поставщиков, но не все, регистрируются автоматически порталом Azure или интерфейсом командной строки, который вы используете.

### PowerShell

Чтобы просмотреть состояние регистрации, используйте командлет **Get-AzureRmResourceProvider**.

    Get-AzureRmResourceProvider -ListAvailable

Он возвращает имена всех доступных поставщиков ресурсов и состояние регистрации:

    ProviderNamespace               RegistrationState ResourceTypes
    -----------------               ----------------- -------------
    Microsoft.ApiManagement         Unregistered      {service, validateServiceName, checkServiceNameAvailability}
    Microsoft.AppService            Registered        {apiapps, appIdentities, gateways, deploymenttemplates...}
    Microsoft.Batch                 Registered        {batchAccounts}

Чтобы зарегистрировать поставщик, используйте командлет **Register-AzureRmResourceProvider** и укажите имя поставщика ресурсов, который необходимо зарегистрировать.

    Register-AzureRmResourceProvider -ProviderNamespace Microsoft.Cdn

Появится запрос на подтверждение регистрации, а затем отобразится состояние.

    Confirm
    Are you sure you want to register the provider 'Microsoft.Cdn'
    [Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y

    ProviderNamespace RegistrationState ResourceTypes
    ----------------- ----------------- -------------
    Microsoft.Cdn     Registering       {profiles, profiles/endpoints,...

### Инфраструктура CLI Azure

Чтобы узнать, зарегистрирован ли поставщик для использования, выполните в CLI Azure команду `azure provider list` (приведен сокращенный пример вывода).

    azure provider list
        
Она возвращает имена всех доступных поставщиков ресурсов и состояние регистрации:
        
    info:    Executing command provider list
    + Getting ARM registered providers
    data:    Namespace                        Registered
    data:    -------------------------------  -------------
    data:    Microsoft.Compute                Registered
    data:    Microsoft.Network                Registered  
    data:    Microsoft.Storage                Registered
    data:    microsoft.visualstudio           Registered
    ...
    info:    provider list command OK

Чтобы зарегистрировать поставщик ресурсов, используйте команду `azure provider register` и укажите *пространство имен*, которое следует зарегистрировать.

    azure provider register Microsoft.Cdn

### Интерфейс REST API

Для получения состояния регистрации см. [Получение сведений о поставщике ресурсов](https://msdn.microsoft.com/library/azure/dn790534.aspx).

Для регистрации поставщика см. [Регистрация подписки с поставщиком ресурсов](https://msdn.microsoft.com/library/azure/dn790548.aspx).

## Ошибки расширений пользовательских скриптов

Если при развертывании виртуальной машины возникнет ошибка с расширением пользовательского скрипта, см. статью [Troubleshooting Azure Windows VM extension failures](./virtual-machines/virtual-machines-windows-extensions-troubleshoot.md) (Устранение неполадок расширений виртуальных машин Windows в Azure) или [Устранение неполадок расширения виртуальной машины Linux](./virtual-machines/virtual-machines-linux-extensions-troubleshoot.md).

## Как понять, что развертывание готово 

Azure Resource Manager сообщает об успешном выполнении развертывания при успешном возврате всех поставщиков из развертывания. Однако это не обязательно означает, что ваша группа ресурсов "активна и готова для пользователей". Например, для развертывания может потребоваться скачать обновления, дождаться возможности использования других ресурсов, не являющихся шаблонами, или установить сложные скрипты либо другое исполняемое действие, о котором среде Azure не известно, так как оно не отслеживается поставщиком. В таких случаях ресурсы могут быть готовы к практическому использованию только спустя некоторое время. В результате этого следует ожидать, что состояние развертывания меняется на "успешно" за некоторое время до того, прежде чем развертывание можно будет использовать.

Тем не менее вы можете сделать так, чтобы Azure не сообщал об успешном развертывании, создав настраиваемый сценарий для пользовательского шаблона (например, с помощью [CustomScriptExtension](https://azure.microsoft.com/blog/2014/08/20/automate-linux-vm-customization-tasks-using-customscript-extension/)), который умеет отслеживать все развертывание на предмет готовности в рамках всей системы и возвращает успешный результат только в том случае, если пользователи могут работать со всем развертыванием. Если вы хотите сделать так, чтобы ваше расширение выполнялось последним, используйте свойство **dependsOn** в шаблоне.

## Дальнейшие действия

- Сведения об аудите действий см. в статье [Операции аудита с помощью Resource Manager](resource-group-audit.md).
- Дополнительные сведения об определении ошибок во время развертывания см. в статье [Устранение неполадок развертываний групп ресурсов с помощью портала Azure](resource-manager-troubleshoot-deployments-portal.md).

<!---HONumber=AcomDC_0511_2016-->