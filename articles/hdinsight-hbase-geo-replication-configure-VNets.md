<properties 
   pageTitle="Настройка VPN-подключения между двумя виртуальными сетями Azure | Azure" 
   description="Подробные сведения о настройке VPN-подключений между двумя виртуальными сетями Azure, о настройке разрешения доменных имен между двумя виртуальными сетями, а также о настройке географической репликации HBase" 
   services="hdinsight" 
   documentationCenter="" 
   authors="mumian" 
   manager="paulettm" 
   editor="cgronlun"/>

<tags
   ms.service="hdinsight"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data" 
   ms.date="04/02/2015"
   ms.author="jgao"/>

# Настройка VPN-подключения между двумя виртуальными сетями Azure  

> [AZURE.SELECTOR]
- [Configure VPN connectivity](hdinsight-hbase-geo-replication-configure-VNETs.md)
- [Configure DNS](hdinsight-hbase-geo-replication-configure-DNS.md)
- [Configure HBase replication](hdinsight-hbase-geo-replication.md) 

При подключении между сайтами в виртуальной сети Azure используется VPN-шлюз для предоставления защищенного туннеля с использованием IPsec/IKE. Подключаемые виртуальные сети могут иметь разные подписки в разных регионах. Можно даже комбинировать подключение виртуальных сетей с многосайтовыми конфигурациями. Существует несколько причин для подключения одной виртуальной сети к другой.

- Межрегиональная географическая избыточность и географическое присутствие 
- Региональные многоуровневые приложения с четкой границей изоляции 
- Обмен данными между подписками и организациями в Azure

Дополнительные сведения см. в разделе [Настройка подключения между двумя виртуальными сетями](https://msdn.microsoft.com/library/azure/dn690122.aspx).

Этот учебник является частью [серии][hdinsight-hbase-replication] по созданию географической репликации HBase.

- Настройка VPN-подключения между двумя виртуальными сетями (данный учебник)
- [Настройка DNS для виртуальных сетей][hdinsight-hbase-geo-replication-DNS]
- [Настройка георепликации HBase][hdinsight-hbase-geo-replication]

На следующей схеме показаны две виртуальные сети, которые вы создадите в этом учебнике:

![Схема виртуальной сети репликации HBase в HDInsight][img-vnet-diagram]
 

##Предварительные требования
Перед началом работы с этим учебником необходимо иметь следующее:

- **Подписка Azure.**. Azure — это платформа на основе подписок. Дополнительные сведения о получении подписки см. в разделах [Варианты приобретения][azure-purchase-options], [Предложения для участников][azure-member-offers] или [Бесплатное пробное использование][azure-free-trial].

- ** Рабочая станция, на которой установлена и настроена среда Azure PowerShell**. Инструкции см. в разделе [Установка и настройка Azure PowerShell][powershell-install].

	Перед выполнением скриптов PowerShell убедитесь, что вы подключены к подписке Azure, с помощью следующего командлета:

		Add-AzureAccount

	При наличии нескольких подписок Azure используется следующий командлет для установки текущей подписки:

		Select-AzureSubscription <AzureSubscriptionName>


>[AZURE.NOTE]Имена служб Azure и имена виртуальных машин должны быть уникальными. В этом учебнике используется имя Contoso-[имя службы или виртуальной машины Azure]-[EU/US]. Например, Contoso-VNet-EU — это виртуальная сеть Azure в центре обработки данных, расположенном в Северной Европе; Contoso-DNS-US — виртуальная машина DNS-сервера в центре обработки данных, расположенном на востоке США. Вам необходимо создать собственные имена.
 

##Создание двух виртуальных сетей Azure



**Создание виртуальной сети с именем Contoso-VNet-EU в Северной Европе**

1.	Выполните вход на [портал Azure][azure-portal].
2.	Щелкните **СОЗДАТЬ**, **СЕТЕВЫЕ СЛУЖБЫ**, **ВИРТУАЛЬНАЯ СЕТЬ**, **НАСТРАИВАЕМОЕ СОЗДАНИЕ**.
3.	Введите:

	- **ИМЯ**: Contoso-VNet-EU
	- **РАСПОЛОЖЕНИЕ**: North Europe

		В этом учебнике используются центры обработки данных в Северной Европе и на востоке США. Можно выбрать собственные центры обработки данных.
4.	Введите:

	- **DNS-СЕРВЕР**: (оставьте пустым) 
	
		Вам понадобится собственный DNS-сервер для разрешения имен в виртуальных сетях. Дополнительную информацию о том, когда использовать предоставленный Azure модуль разрешения имен и собственный DNS-сервер, см. в разделе [Разрешение имен (DNS)] (https://msdn.microsoft.com/library/azure/jj156088.aspx). Инструкции по настройке разрешения имен между виртуальными сетями см. в разделе [Настройка DNS между двумя виртуальными сетями Azure][hdinsight-hbase-dns].
  
	- **Настроить VPN между точкой и сайтом**: (флажок не установлен)

		Point-to-site doesn't apply to this scenario.

 **Настроить VPN между сайтами**: (флажок не установлен)
 	
		You will configure the site-to-site VPN connection to the Azure virtual network in the East U.S. datacenter.
5.	Введите:

	- 	**НАЧАЛЬНЫЙ IP АДРЕСНОГО ПРОСТРАНСТВА**: 10.1.0.0
	- 	**CIDR АДРЕСНОГО ПРОСТРАНСТВА**: /16
	- 	**НАЧАЛЬНЫЙ IP Subnet-1**: 10.1.0.0
	- 	**CIDR Subnet-1 **: /24

	Адресное пространство не может перекрывать виртуальную сеть США.

**Создание виртуальной сети с именем Contoso-VNet-EU в Западной Европе**

- Повторите последнюю процедуру со следующими значениями:

	- **ИМЯ**: Contoso-VNet-US
	- **РАСПОЛОЖЕНИЕ**: Восток США
	 
	- **DNS-СЕРВЕР**: (оставьте пустым)
	- **Настроить VPN между точкой и сайтом**: (флажок не установлен)
	- **Настроить VPN между сайтами**: (флажок не установлен)
	 
	- **НАЧАЛЬНЫЙ IP АДРЕСНОГО ПРОСТРАНСТВА**: 10.2.0.0
	- **CIDR АДРЕСНОГО ПРОСТРАНСТВА**: /16
	- **НАЧАЛЬНЫЙ IP Subnet-1**: 10.2.0.0
	- **CIDR Subnet-1 **: /24

















##Настройка VPN-подключения между двумя виртуальными сетями

###Создание локальных сетей

При создании конфигурации между двумя виртуальными сетями необходимо настроить каждую из сетей так, чтобы они идентифицировали друг друга в качестве сайта локальной сети. В этом разделе вы настроите каждую виртуальную сеть в качестве локальной. Локальные сети используют общие пространства IP-адресов с соответствующей виртуальной сетью.

![Настройка конфигурации VPN Azure «сайт-сайт» — локальные сети Azure][img-vnet-lnet-diagram]


**Создание локальной сети с именем Contoso-LNet-EU, соответствующей адресному пространству сети Contoso-VNet-EU**

1. На портале Azure щелкните **СОЗДАТЬ**, **СЕТЕВЫЕ СЛУЖБЫ**, **ВИРТУАЛЬНАЯ СЕТЬ**, **ДОБАВИТЬ ЛОКАЛЬНУЮ СЕТЬ**.
3. Введите:

	- **ИМЯ**: Contoso-LNet-EU
	- **IP-АДРЕС УСТРОЙСТВА VPN**: 192.168.0.1 (этот адрес будет обновлен позднее)

		Typically, you’d use the actual external IP address for a VPN device. For VNet to VNet configurations, you will use the VPN gateway IP address. Given that you have not created the VPN gateways for the two VNets yet, you enter an arbitary IP address and come back to fix it.
4.	Введите:

	- **НАЧАЛЬНЫЙ IP АДРЕСНОГО ПРОСТРАНСТВА**: 10.1.0.0
	- **CIDR АДРЕСНОГО ПРОСТРАНСТВА**: /16
	
	Он должен точно соответствовать диапазону, который был ранее указан для Contoso-VNet-EU.

**Создание локальной сети с именем Contoso-LNet-US, соответствующей адресному пространству сети Contoso-VNet-US**

- Повторите последнюю процедуру со следующими параметрами:

	- **ИМЯ**: Contoso-LNet-US
	- **IP-АДРЕС УСТРОЙСТВА VPN**: 192.168.0.1 (этот адрес будет обновлен позднее)
	 
	- **НАЧАЛЬНЫЙ IP АДРЕСНОГО ПРОСТРАНСТВА**: 10.2.0.0
	- **CIDR АДРЕСНОГО ПРОСТРАНСТВА**: /16


###Создание VPN-шлюзов

В этой конфигурации имеются две части. Сначала настраивается подключение виртуальной сети «сайт-сайт» к локальной сети, а затем создается VPN с динамической маршрутизацией. Для подключения виртуальной сети к виртуальной сети требуются VPN-шлюзы Azure с сетями VPN динамической маршрутизации. Сети VPN Azure со статической маршрутизацией не поддерживаются.

**Настройка подключения «сайт-сайт» Contoso-VNet-EU к Contoso-LNet-US**

1.	На портале Azure щелкните **СЕТИ** в области слева.
2.	Щелкните **Contoso-VNet-EU**.
3.	Выберите вкладку **НАСТРОЙКА**.
4.	Установите флажок **Подключиться к локальной сети**.
5.	В разделе **ЛОКАЛЬНАЯ СЕТЬ** выберите **Contoso-LNet-US**.
6.	Щелкните **Добавить подсеть шлюза** в разделе пространств адресов виртуальной сети.
7.	Щелкните **СОХРАНИТЬ**.
8.	Нажмите кнопку **ОК** для подтверждения.


**Создание VPN-шлюза для Contoso-VNet-EU**

1.	На портале Azure выберите вкладку **ПАНЕЛЬ МОНИТОРИНГА**.
4.	Щелкните **СОЗДАТЬ ШЛЮЗ** внизу страницы, а затем щелкните **Динамическая маршрутизация**.
5.	Нажмите кнопку **Да** для подтверждения. Обратите внимание, что графическое представление шлюза на странице меняет цвет на желтый с надписью «Создание шлюза». Обычно создание шлюза занимает около 15 минут.

	Когда состояние шлюза изменится на «Подключение», IP-адрес для каждого шлюза будет отображаться на панели мониторинга. Запишите IP-адрес, соответствующий каждой виртуальной сети, стараясь не перепутать их. Это IP-адреса, которые будут использоваться при редактировании заполнителей IP-адресов для VPN-устройства в разделе «Локальные сети».

6.	Скопируйте **IP-АДРЕС ШЛЮЗА**. Он будет использоваться для настройки IP-адреса VPN-шлюза для Contoso-VNet-EU в следующем разделе.

**Создание VPN-шлюза для Contoso-VNet-EU**

- Повторите последние две процедуры для настройки подключения типа «сайт — сайт» между Contoso-VNet-US и Contoso-LNet-EU и последующего создания VPN-шлюза для Contoso-Vnet-US. После завершения вы получите IP-адрес VPN-шлюза для Contoso-VNet-US.


### Установка IP-адресов VPN-устройств для локальных сетей
В последнем разделе создается VPN-шлюз для каждой из виртуальных сетей. Вы получили IP-адреса VPN-шлюзов. Теперь можно вернуться к настройке IP-адресов VPN-устройств локальной сети.

**Настройка IP-адреса VPN-устройства для Contoso-LNet-EU**

1.	На портале Azure щелкните **СЕТИ** в области слева.
2.	Щелкните **ЛОКАЛЬНЫЕ СЕТИ** вверху.
3.	Щелкните **Contoso-LNet-EU**, а затем щелкните **ИЗМЕНИТЬ** внизу.
4.	Обновите **IP-АДРЕС УСТРОЙСТВА VPN**. Это адрес, получаемый с вкладки «ПАНЕЛЬ МОНИТОРИНГА» Contoso-VNET-EU.
5.	Щелкните стрелку вправо.
6.	Нажмите кнопку «Проверить».

**Настройка IP-адреса VPN-устройства для Contoso-LNet-US**

- Повторите последнюю процедуру, чтобы настроить IP-адрес VPN-устройства для Contoso-LNet-US.

###Установка ключей шлюза виртуальной сети

Шлюзы виртуальной сети используют общий ключ для проверки подлинности соединений между виртуальными сетями. Ключ нельзя настроить на портале Azure. Необходимо использовать PowerShell или пакет SDK для .NET.

**Установка ключей**

1. На рабочей станции откройте **Windows PowerShell ISE** или консоль Windows PowerShell.
2. Обновите параметры в следующем сценарии и запустите его:

		Add-AuzreAccount
		Select-AzureSubscription -[AzureSubscriptionName]
		Set-AzureVNetGatewayKey -VNetName ContosoVNet-EU -LocalNetworkSiteName Contoso-LNet-US -SharedKey A1b2C3D4
		Set-AzureVNetGatewayKey -VNetName ContosoVNet-US -LocalNetworkSiteName Contoso-LNet-EU -SharedKey A1b2C3D4 


##Проверка подключения VPN 

Без виртуальных машин, развернутых в виртуальных сетях, можно использовать визуальную схему виртуальной сети на странице панели мониторинга виртуальной сети на портале Azure для проверки состояния соединения:

![Состояние VPN-подключения виртуальной сети репликации HBase в HDInsight][img-vpn-status]
  



##Дальнейшие действия

В этом учебнике вы узнали, как настроить VPN-подключение между двумя виртуальными сетями Azure. Две оставшиеся статьи в серии описывают следующие темы:

- [Настройка DNS между двумя виртуальными сетями Azure][hdinsight-hbase-geo-replication-dns]
- [Настройка георепликации HBase][hdinsight-hbase-geo-replication]



[hdinsight-hbase-geo-replication-dns]: hdinsight-hbase-geo-replication-configure-DNS.md
[hdinsight-hbase-geo-replication]: hdinsight-hbase-geo-replication.md


[azure-purchase-options]: http://azure.microsoft.com/pricing/purchase-options/
[azure-member-offers]: http://azure.microsoft.com/pricing/member-offers/
[azure-free-trial]: http://azure.microsoft.com/pricing/free-trial/
[azure-portal]: http://manage.windowsazure.com


[powershell-install]: ../install-configure-powershell



[hdinsight-hbase-replication]: ../hdinsight-hbase-geo-replication/
[hdinsight-hbase-dns]: ../hdinsight-hbase-geo-replication-configure-DNS/


[img-vnet-diagram]: ./media/hdinsight-hbase-geo-replication-configure-VNets/HDInsight.HBase.VPN.diagram.png
[img-vnet-lnet-diagram]: ./media/hdinsight-hbase-geo-replication-configure-VNets/HDInsight.HBase.VPN.LNet.diagram.png
[img-vpn-status]: ./media/hdinsight-hbase-geo-replication-configure-VNets/HDInsight.HBase.VPN.status.png
<!--HONumber=52-->
