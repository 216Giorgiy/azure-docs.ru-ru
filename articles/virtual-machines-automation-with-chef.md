<properties 
   pageTitle="Автоматизация развертывания виртуальной машины Azure с помощью Chef" 
   description="Научитесь автоматизировать работу виртуальной машины Azure с помощью Chef" 
   services="virtual-machines" 
   documentationCenter="" 
   authors="diegoviso" 
   manager="timlt" 
   editor=""/>

<tags ms.service="virtual-machines" ms.workload="infrastructure-services" 
ms.tgt_pltfrm="vm-multiple" 
ms.devlang="na" 
ms.topic="article" 
ms.date="01/29/2015" 
ms.author="diviso"/>

# Автоматизация развертывания виртуальной машины Azure с помощью Chef

Chef - это отличное средство для автоматизации и для настройки требуемого состояния. 

После нашего последнего выпуска облачного API средство Chef обеспечивает прозрачную интеграцию с Azure, позволяя подготовить и развернуть состояния конфигурации одной командой.

В этой статье показано, как настроить среду Chef для подготовки виртуальных машин Azure, а также рассматривается пошаговая процедура создания политики или "подробной инструкции", после чего данная инструкция применяется на практике к виртуальной машине Azure.

Итак, начнем!

## Основы использования Chef

Перед началом работы вам рекомендуется ознакомиться с основными понятиями и принципами использования Chef. Вот <a href="http://www.chef.io/chef" target="_blank">здесь</a> опубликован отличный материал, с которым рекомендуется ознакомиться, прежде чем пытаться выполнить описанную здесь пошаговую процедуру. Однако перед началом работы мы все равно повторим основы.

На приведенной ниже схеме показана высокоуровневая архитектура Chef.

![][2]

Chef имеет три основных архитектурных компонента: **сервер Chef, клиент Chef (узел)** и **рабочая станция Chef.**

**Сервер Chef** является управляющим компонентом и доступен в двух вариантах: размещенное решение или локальное решение. Мы будем использовать размещенное решение.

**Клиент Chef (узел)** - это агент, который находится на управляемых серверах.

**Рабочая станция Chef** является нашей рабочей станцией администрирования, где мы создаем политики и выполняем команды управления. Мы выполняем команду **knife** с рабочей станции Chef для управления инфраструктурой.

Кроме того, существует понятие "детальных инструкций" и "рецептов". Фактически, это те политики, которые мы определяем и применяем к своим серверам.

## Подготовка рабочей станции

Сначала давайте подготовим рабочую станцию. В данном случае используется стандартная рабочая станция Windows. Необходимо создать каталог для хранения файлов конфигурации и детальных инструкций.

Сначала создайте каталог с именем **C:\chef**. 

Затем создайте второй каталог **c:\chef\cookbooks**.

Теперь нам нужно скачать наш файл параметров Azure, чтобы средство Chef могло взаимодействовать с нашей подпиской Azure.

Скачайте свои параметры публикации по этому адресу: <a href="https://manage.windowsazure.com/publishsettings/" target="_blank">https://manage.windowsazure.com/publishsettings/</a>

Сохраните файл параметров публикации в каталоге **C:\chef**.

##Создание управляемой учетной записи Chef

Зарегистрируйте размещенную учетную запись Chef: <a href="https://manage.chef.io/signup" target="_blank">https://manage.chef.io/signup</a>

В процессе регистрации вам будет предложено создать новую организацию.

![][3]

После создания организации скачайте начальный набор.

![][4]

**Примечание.** В случае отображения предупреждения о том, что ваши ключи будут сброшены, вы можете спокойно продолжить процедуру, так как у вас пока нет никакой настроенной инфраструктуры.

Этот ZIP-файл начального набора содержит ключи и файлы конфигурации вашей организации.

##Настройка рабочей станции Chef

Извлеките содержимое файла chef-starter.zip в каталог **C:\chef**.

Скопируйте все файлы из **chef-starter\chef-repo.chef** в каталог **c:\chef**.

Теперь ваш каталог должен выглядеть примерно следующим образом:

![][5]

У вас должно быть 4 файла, включая файл публикации Azure в корне каталога c:\chef.

PEM-файлы содержат закрытые ключи администратора и организации для обеспечения связи, а файл **knife.rb** содержит конфигурацию knife. Нам потребуется изменить файл **knife.rb**.

Откройте файл в предпочитаемом вами редакторе и измените cookbook_path, удалив "/.../" из пути, чтобы он имел следующий вид:

	cookbook_path  ["#{current_dir}/cookbooks"]

Кроме того, добавьте следующие строки с учетом имени своего файла параметров публикации Azure.   

	knife[:azure_publish_settings_file] = "yourfilename.publishsettings" 

Теперь файл knife.rb должен выглядеть примерно следующим образом:

![][6]

Эти строки обеспечивают, что Knife ссылается на каталог подробных инструкций c:\chef\cookbooks, а также использует наш файл параметров публикации Azure во время выполнения операций Azure.

## Установка пакета средств разработки Chef

Затем скачайте и установите ChefDK (пакет средств разработки Chef) для настройки рабочей станции Chef.

<a href="http://downloads.getchef.com/chef-dk/windows" target="_blank">http://downloads.getchef.com/chef-dk/windows</a>

![][7]

Эта процедура не представляет никаких трудностей. Позвольте пакету выполнить установку в расположение по умолчанию - c:\opscode. Эта установка займет около 10 минут.

Убедитесь, что переменная PATH содержит записи для C:\opscode\chefdk\bin;C:\opscode\chefdk\embedded\bin;c:\users\yourusername.chefdk\gem\ruby\2.0.0\bin.

Если они отсутствуют, обязательно добавьте эти пути!

**ПОМНИТЕ, ЧТО ПОРЯДОК ПУТЕЙ ИМЕЕТ ЗНАЧЕНИЕ!** Если пути opscode указаны в неправильном порядке, возникнут проблемы.

Прежде чем продолжить, перезагрузите рабочую станцию.

Далее мы установим расширение для Knife Azure. Это предоставляет Knife "подключаемый модуль Azure".

Выполните следующую команду:

	chef gem install knife-azure --pre

**Примечание.** Аргумент -pre обеспечивает получение самой новой версии-кандидата подключаемого модуля azure для knife, предоставляющего доступ к актуальному набору API.

Вполне вероятно, что в это же время будет установлен набор зависимостей.

![][8]


Чтобы проверить правильность настройки, выполните следующую команду:

	knife azure image list

Если все настроено правильно, появится прокручиваемый список доступных образов Azure.

Поздравляем! Рабочая станция настроена!

##Создание подробной инструкции

Подробная инструкция Chef используется для определения набора команд, которые необходимо выполнить на управляемом клиенте. Создание подробной инструкции не вызывает проблем, и мы используем команду chef generate cookbook для создания нашего шаблона подробной инструкции. Мы назовем свою подробную инструкцию именем webserver, так как нам нужна политика, которая автоматически развертывает службы IIS.

В каталоге C:\Chef выполните следующую команду:

	chef generate cookbook webserver

Будет создан набор файлов в каталоге **C:\Chef\cookbooks\webserver.** Необходимо определить набор команд, который наш клиент Chef должен выполнять на управляемой виртуальной машине.

Команды хранятся в файле **default.rb.** В этом файле мы определим набор команд, который устанавливает службы IIS, запускает их и копирует файл шаблона в папку wwwroot.

Измените **C:\chef\cookbooks\webserver\recipes\default.rb** и добавьте следующие строки:

	powershell_script 'Install IIS' do
 		action :run
 		code 'add-windowsfeature Web-Server'
	end

	service 'w3svc' do
 		action [ :enable, :start ]
	end

	template 'c:\inetpub\wwwroot\Default.htm' do
 		source 'Default.htm.erb'
 		rights :read, 'Everyone'
	end

После завершения работы сохраните файл.

## Создание шаблона

Как упоминалось ранее, необходимо создать файл шаблона, который будет использоваться в качестве нашей страницы default.html.

Выполните следующую команду, чтобы создать шаблон:

	chef generate template webserver Default.htm

Теперь перейдите к файлу **C:\chef\cookbooks\webserver\templates\default\Default.htm.erb** и измените его.

Добавьте простой HTML-код Hello World и сохраните файл.

## Передача подробной инструкции на сервер Chef

В этом шаге мы отправляем копию подробной инструкции, созданной на локальном компьютере, на размещенный сервер Chef. После передачи подробная инструкция появляется на вкладке политики.

	knife cookbook upload webserver

![][9]

## Развертывание виртуальной машины с помощью Knife Azure

Теперь мы развернем виртуальную машину Azure и применим подробную инструкцию Webserver, которая установит нашу веб-службу IIS и веб-страницу по умолчанию.

Чтобы сделать это, используйте команду **knife azure server create**.

Вот пример такой команды:

	knife azure server create --azure-dns-name 'diegotest01' --azure-vm-name 'testserver01' --azure-vm-size 'Small' --azure-storage-account 'portalvhdsxxxx' --bootstrap-protocol 'cloud-api' --azure-source-image 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201411.01-en.us-127GB.vhd' --azure-service-location 'Southeast Asia' --winrm-user azureuser --winrm-password 'myPassword123' --tcp-endpoints 80,3389 --r 'recipe[webserver]'

Названия параметров говорят сами за себя. Подставьте свои переменные и запустите команду.

**Примечание.** С помощью командной строки мы также автоматизируем работу правил сетевых фильтров конечной точки, используя параметр -tcp-endpoints. Здесь открыты порты 80 и 3389, чтобы обеспечить доступ к веб-странице и сеансу протокола удаленного рабочего стола.

После выполнения команды перейдите на портал Azure, где можно наблюдать за началом подготовки виртуальной машины.

![][13]

Вернемся в командную строку:

![][10]

После завершения развертывания мы должны получить возможность подключения к веб-службе через порт 80, так как мы открыли этот порт, когда подготавливали виртуальную машину с помощью команды knife azure. Поскольку это единственная виртуальная машина в нашей облачной службе, подключим ее с использованием URL-адреса облачной службы.

![][11]

Здесь вы могли наблюдать пример творческого подхода к написанию кода :)

Не забывайте, что можно также подключиться через сеанс протокола удаленного рабочего стола с портала Azure через порт 3389.

Надеюсь, что эта информация была для вас полезной! Начинайте использовать подход "инфраструктура как код" прямо сейчас с помощью Azure!

Диего Висо (Diego Viso) [MSFT]

<!--Image references-->
[2]: ./media/virtual-machines-automation-with-chef/2.png
[3]: ./media/virtual-machines-automation-with-chef/3.png
[4]: ./media/virtual-machines-automation-with-chef/4.png
[5]: ./media/virtual-machines-automation-with-chef/5.png
[6]: ./media/virtual-machines-automation-with-chef/6.png
[7]: ./media/virtual-machines-automation-with-chef/7.png
[8]: ./media/virtual-machines-automation-with-chef/8.png
[9]: ./media/virtual-machines-automation-with-chef/9.png
[10]: ./media/virtual-machines-automation-with-chef/10.png
[11]: ./media/virtual-machines-automation-with-chef/11.png
[13]: ./media/virtual-machines-automation-with-chef/13.png


<!--Link references-->

<!--HONumber=47-->
