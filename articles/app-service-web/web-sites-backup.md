<properties 
	pageTitle="Резервное копирование веб-приложений в службе приложений Azure" 
	description="Узнайте, как создавать резервные копии веб-приложений в службе приложений Azure." 
	services="app-service\web" 
	documentationCenter="" 
	authors="cephalin" 
	manager="wpickett" 
	editor="mollybos"/>

<tags 
	ms.service="app-service-web" 
	ms.workload="web" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/24/2015" 
	ms.author="cephalin"/>

# Резервное копирование веб-приложений в службе приложений Azure


Компонент резервного копирования и восстановления в [веб-приложениях службы приложений Azure](http://go.microsoft.com/fwlink/?LinkId=529714) позволяет легко создавать резервные копии веб-приложений вручную или автоматически. Вы можете восстановить предыдущее состояние веб-приложения или создать новое на основе одной из резервных копий исходного приложения.

Сведения о восстановлении веб-приложения Azure из резервной копии см. в статье [Восстановление веб-приложения](web-sites-restore.md).

<a name="whatsbackedup"></a>
## Что включается в резервную копию 
Вот какая информация входит в резервную копию веб-приложения:

* конфигурация веб-приложения;
* содержимое файлов веб-приложения;
* подключенные к сайту базы данных MySQL или SQL Server (вы можете выбрать конкретные базы для включения в резервную копию).

Эта информация копируется в указанные контейнер и учетную запись хранения Azure.

> [AZURE.NOTE]Каждая резервная копия является полной автономной копией приложения, а не добавочным обновлением.

<a name="requirements"></a>
## Требования и ограничения

* Для компонента резервного копирования и восстановления сайт должен пребывать в режиме Standard. Дополнительные сведения о масштабировании веб-приложения для использования режима Standard см. в статье [Масштабирование веб-приложения в службе приложения Azure](web-sites-scale.md). Обратите внимание, что режим Premium позволяет ежедневно создавать большее количество резервных копий, чем режим Standard.

* Компоненту резервного копирования и восстановления требуется учетная запись хранения Azure и контейнер, принадлежащие к той же подписке, что и веб-приложение, резервную копию которого вы собираетесь создать. Если у вас еще нет учетной записи хранения, вы можете создать ее, щелкнув элемент **Учетная запись хранения** в колонке **Резервные копии** на [портале Azure](http://go.microsoft.com/fwlink/?LinkId=529715) и выбрав **учетную запись хранения** и **контейнер** из колонки **Место назначения**. Дополнительные сведения об учетных записях хранения Azure см. в [ссылках](#moreaboutstorage) в конце этой статьи.

* Компонент резервного копирования и восстановления поддерживает содержимое веб-сайта и базы данных объемом до 10 ГБ. Если компонент резервного копирования не может работать, поскольку объем полезных данных превышает этот предел, ошибка будет занесена в журналы операций.

<a name="manualbackup"></a>
## Создание резервной копии вручную

1. Выберите веб-приложение в колонке "Веб-приложения" на портале Azure. В результате в новой колонке появятся подробные сведения о веб-приложении.
2. Выберите элемент **Параметры**. Откроется колонка **Параметры**, в которой можно изменять свое веб-приложение.
	
	![Страница резервных копий][ChooseBackupsPage]

3. Выберите параметр **Резервные копии** в колонке **Параметры**. Откроется колонка **Резервные копии**.
	
4. Из колонки **Резервные копии** выберите расположение резервной копии, указав параметры **Учетная запись хранения** и **Контейнер**. Эта учетная запись хранения должна принадлежать к той же подписке, что и веб-приложение, резервную копию которого вы собираетесь создать.
	
	![Выбор учетной записи хранения][ChooseStorageAccount]
	
5. В разделе **Включенные базы данных** колонки **Резервные копии** выберите базы данных, подключенные к веб-приложениям (SQL Server или MySQL), резервные копии которых вы хотите создать.

	> [AZURE.NOTE]Чтобы база данных появилась в этом списке, ее строка подключения должна присутствовать в разделе **Строки подключения** колонки **Параметры веб-приложения** на портале.
	
6. В колонке **Резервные копии** щелкните элемент **Расположение резервной копии**. Выберите существующую учетную запись хранилища и контейнер.
7. На панели команд щелкните **Создать резервную копию**.
	
	![Кнопка создания резервной копии][BackUpNow]
	
	Во время процесса резервного копирования отображается сообщение о ходе выполнения.
	

В любое время можно выполнить резервное копирование вручную.

<a name="automatedbackups"></a>
## Настройка автоматического резервного копирования

1. В колонке **Резервные копии** включите параметр **Запланированное резервное копирование**.
	
	![Включение автоматически создаваемых резервных копий][SetAutomatedBackupOn]
	
2. Выберите учетную запись хранения, в которой нужно разместить резервную копию веб-приложения. Эта учетная запись хранения должна принадлежать к той же подписке, что и веб-приложение, резервную копию которого вы собираетесь создать.
	
	![Выбор учетной записи хранения][ChooseStorageAccount]
	
3. В поле **Частота** укажите, как часто требуется осуществлять автоматическое резервное копирование. Число дней должно быть в диапазоне от 1 до 90 включительно (от одного раза в день до одного раза каждые 90 дней).
	
4. Используйте параметр **Начало**, чтобы указать дату и время начала автоматического резервного копирования.
	
	> [AZURE.NOTE]Azure хранит значения времени резервного копирования в формате UTC, но отображает их в соответствии с системным временем на компьютере, где отображается портал.
	
5. В разделе **Включенные базы данных** выберите базы данных, подключенные к веб-приложению (SQL Server или MySQL), резервную копию которого вы хотите создать. Чтобы база данных появилась в списке, ее строка подключения должна присутствовать в разделе **Строки подключения** колонки **Параметры веб-приложения** на портале.
	
	> [AZURE.NOTE]Если требуется включить в резервную копию одну или несколько баз данных и указана частота менее 7 дней, выводится предупреждение о том, что такое частое резервное копирование может увеличить расходы на базу данных.
	
6. Кроме того, задайте для значения **Хранение (дни)** количество дней, на протяжении которых вы хотите сохранять резервную копию.
7. На панели команд нажмите кнопку **Сохранить**, чтобы сохранить изменения конфигурации (или выберите **Отменить**, чтобы отказаться от сохранения).
	
	![Кнопка сохранения][SaveIcon]

<a name="notes"></a>
## Примечания

* Чтобы компонент резервного копирования и восстановления мог включить ваши базы данных, убедитесь, что вы правильно настроили строки подключения для каждой базы данных в колонке **Параметры веб-приложения** раздела **Параметры**.
* Хотя вы можете выполнить резервное копирование нескольких веб-приложений в одну учетную запись хранения, для упрощения обслуживания рекомендуется создать отдельную учетную запись хранения для каждого веб-приложения.

>[AZURE.NOTE]Если вы хотите приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), где вы можете быстро создать кратковременное веб-приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.

<a name="partialbackups"></a>
## Создание резервной копии части сайта

Иногда резервное копирование всего содержимого сайта не требуется, особенно если вы регулярно создаете резервные копии или размер содержимого сайта превышает 10 ГБ (максимальный объем данных, для которых можно создать резервную копию за один раз).

Например, вам, возможно, не нужно создавать резервные копии файлов журналов. Или же вы [настроили еженедельное резервное копирование](https://azure.microsoft.com/ru-ru/documentation/articles/web-sites-backup/#configure-automated-backups) и вам ни к чему хранить в своей учетной записи хранения копии неизменяемого статического содержимого, как то старых записей блогов или изображений.

Функция частичного резервного копирования позволяет выбрать только те файлы, для которых нужно создавать резервные копии.

###Выбор файлов, для которых не нужно создавать резервные копии
Вы можете создать список файлов и папок, для которых резервные копии создаваться не будут.

Сохраните этот список как текстовый файл с именем _backup.filter в папке wwwroot своего сайта. Сделать это можно с помощью [консоли Kudu](https://github.com/projectkudu/kudu/wiki/Kudu-console) по адресу `http://{yoursite}.scm.azurewebsites.net/DebugConsole`. 

Приведенные ниже инструкции описывают процесс создания файла _backup.filter с помощью консоли Kudu, но файл можно сохранить в нужном вам расположении также с помощью привычного вам метода развертывания.

###Что нужно сделать
У меня есть сайт, содержащий файлы журналов и статические изображения, собранные за последние несколько лет. Это содержимое никогда не будет изменяться.

У меня уже есть полная резервная копия сайта, включающая старые изображения. Теперь я хочу ежедневно создавать резервные копии сайта, но не хочу платить за хранение неизменяемых файлов журналов или статических изображений.

![Папка журналов][LogsFolder] ![Папка с изображениями][ImagesFolder]
	
Ниже описано, как исключить эти файлы из процесса резервного копирования.

####Выбор файлов и папок, для которых не нужно создавать резервные копии
Тут все просто. Я уже знаю, что не хочу включать в резервную копию все файлы журналов, поэтому мне нужно исключить папку `D:\home\site\wwwroot\Logs`.

У всех веб-приложений Azure есть еще одна папка с файлами журналов: `D:\home\LogFiles`. Ее также можно исключить.

Я также не хочу создавать многочисленные резервные копии изображений за предыдущие годы. Следовательно, в список также следует включить папки `D:\home\site\wwwroot\Images\2013` и `D:\home\site\wwwroot\Images\2014`.

Наконец, давайте исключим файл brand.png (находится в папке с изображениями) — просто в качестве примера, что можно исключать также отдельные файлы. Файл расположен в каталоге `D:\home\site\wwwroot\Images\brand.png`.

Итак, мы выбрали следующие папки, которые будут исключены из процесса резервного копирования:

* D:\\home\\site\\wwwroot\\Logs
* D:\\home\\LogFiles
* D:\\home\\site\\wwwroot\\Images\\2013
* D:\\home\\site\\wwwroot\\Images\\2014
* D:\\home\\site\\wwwroot\\Images\\brand.png

#### Создание списка исключений
Теперь нужно сохранить список файлов и папок, для которых не нужно создавать резервные копии, в специальный файл с именем _backup.filter. Создайте файл и поместите его в расположение `D:\home\site\wwwroot_backup.filter`.

Добавьте все файлы и папки, для которых не нужно создавать резервные копии, в файл _backup.filter. Пути к исключаемым из процесса резервного копирования папкам и файлам (относительно каталога D:\\home) указываются по одному на строку.

Таким образом, для моего сайта путь `D:\home\site\wwwroot\Logs` становится `\site\wwwroot\Logs`, путь `D:\home\LogFiles` становится `\LogFiles` и т. д., а содержимое файла _backup.filter приобретает следующий вид:

    \site\wwwroot\Logs
    \LogFiles
    \site\wwwroot\Images\2013
    \site\wwwroot\Images\2014
    \site\wwwroot\Images\brand.png

Обратите внимание на символ `` в начале каждой строки. Это важно.

###Запуск резервного копирования
Теперь можно начинать стандартную процедуру резервного копирования. [Вручную](https://azure.microsoft.com/ru-ru/documentation/articles/web-sites-backup/#create-a-manual-backup) или [автоматически](https://azure.microsoft.com/ru-ru/documentation/articles/web-sites-backup/#configure-automated-backups) — как вам удобнее.

Все попавшие под фильтр файлы и папки (включенные в файл _backup.filter) будут исключены из процесса резервного копирования. Это означает, что для файлов журналов и изображений за 2013 и 2014 годы резервные копии больше не будут создаваться.

###Восстановление резервной копии сайта
Восстановление частичных резервных копий сайта происходит точно так же, как и [восстановление обычных резервных копий](https://azure.microsoft.com/ru-ru/documentation/articles/web-sites-restore/). Алгоритм один и тот же.

####Технические сведения
При восстановлении полной (не частичной) резервной копии все содержимое сайта, как правило, заменяется содержимым из резервной копии. Если файл, который находится на сайте, не включен в резервную копию, он удаляется.

При восстановлении частичной резервной копии любое содержимое, находящееся в одной из исключенных папок (например, папки `D:\home\site\wwwroot\images\2014` моего сайта), остается неизменным. То же касается и отдельных исключенных файлов: они также не будут изменены во время восстановления.

<a name="aboutbackups"></a>
## Как хранятся резервные копии

После создания одной или нескольких резервных копий они отображаются в колонке **Контейнеры** вашей **учетной записи хранения**, а также в веб-приложении. В **учетной записи хранения** каждая резервная копия состоит из ZIP-файла, содержащего резервную копию данных, и XML-файла, содержащего манифест для содержимого ZIP-файла.

Имена архивных ZIP- и XML-файлов состоят из имени веб-приложения, за которым через символ подчеркивания следует метка времени, обозначающая время создания резервной копии. Метка времени содержит дату в формате ГГГГММДД (в виде цифр без пробелов), а также время в 24-часовом формате UTC (например, fabrikam_201402152300.zip). Содержимое этих файлов можно распаковать и просмотреть, если требуется получить доступ к резервным копиям без фактического восстановления веб-приложения.

В файле XML, сохраняемом с файлом zip, имя файла базы данных обозначено в *backupdescription* > *databases* > *databasebackupdescription* > *filename*.

Файл резервной копии базы данных сохраняется в корне файла .zip. Для базы данных SQL это файл BACPAC (без расширения), и его можно импортировать. Чтобы создать новую базу данных SQL на основе экспорта BACPAC, выполните шаги, описанные в разделе [Импорт файла BACPAC для создания новой базы данных пользователя](http://technet.microsoft.com/library/hh710052.aspx).

Сведения о восстановлении веб-приложения (в том числе баз данных) с помощью портала Azure см. в статье [Восстановление веб-приложения в службе приложений Azure](web-sites-restore.md).

> [AZURE.NOTE]Изменение любого из этих файлов в контейнере **websitebackups** может привести к повреждению резервной копии и сделать восстановление из нее невозможным.

<a name="bestpractices"></a>
##Рекомендации
Что делать, когда случается сбой и вам нужно восстановить свой сайт? Лучше подготовиться к такой ситуации загодя.

Да, можно создавать частичные резервные копии, но сначала лучше создать как минимум одну полную резервную копию (это подготовка к наихудшему развитию ситуации). В таком случае, восстанавливая свой сайт, вы сможете сперва восстановить полную резервную копию, а затем восстановить поверх нее последнюю частичную копию.

Причина? Так вы можете использовать [слоты развертывания](https://azure.microsoft.com/ru-ru/documentation/articles/web-sites-staged-publishing/) для тестирования восстановленного сайта. Более того, вы можете проверить процесс восстановления, не изменяя свой рабочий сайт. Ведь проверка процесса восстановления является [очень полезной практикой](http://axcient.com/blog/one-thing-can-derail-disaster-recovery-plan/). Вы никогда не знаете, когда у вас может произойти какой-то малозаметный сбой, как это было у меня при попытке восстановления блога. В итоге я потерял половину содержимого.

###Ужасная история

Я создал свой блог на платформе [Ghost](https://ghost.org/). Как ответственный разработчик я создал резервную копию сайта; все шло по плану. Затем в один прекрасный день мне пришло сообщение о том, что доступна новая версия платформы Ghost и я могу обновить свой блог. Отлично!

Я создал еще одну резервную копию сайта с последними записями блога и приступил к обновлению платформы Ghost.

На своем рабочем сайте.

За что и поплатился.

В общем, что-то пошло не так с этим обновлением, и вместо начального экрана я смотрел на пустой экран. «Ладно», — подумал я и принялся восстанавливать сайт из только что созданной резервной копии.

Когда восстановление завершилось, я было обрадовался, увидев свой блог... Но в нем не было ни одной записи.

ЧТО?!

Оказывается, в [примечаниях к обновлению платформы Ghost](http://support.ghost.org/how-to-upgrade/) есть такое предупреждение:

![Копировать базу данных из папки content/data при работающей платформе Ghost нельзя. Остановите ее сначала.][GhostUpgradeWarning]

При попытке выполнить резервное копирование данных при работающей платформе Ghost... резервное копирование данных не выполняется.

Занавес.

Если бы я сперва попытался выполнить восстановление в тестовом слоте, я бы увидел эту проблему и не потерял все свои записи.

Такова жизнь. Это может случиться с [лучшими из нас](http://blog.codinghorror.com/international-backup-awareness-day/).

Тестируйте свои резервные копии.

<a name="nextsteps"></a>
## Дальнейшие действия
Сведения о восстановлении веб-приложения Azure из резервной копии см. в статье [Восстановление веб-приложения в службе приложений Azure](web-sites-restore.md).

Чтобы начать работу с Azure, см. раздел [Бесплатная пробная версия Microsoft Azure](/pricing/free-trial/).


<a name="moreaboutstorage"></a>
### Подробнее об учетных записях хранения

[Что такое учетная запись хранения?](../storage-whatis-account.md)

[Создание учетной записи хранения](../storage-create-storage-account/)

[Мониторинг учетной записи хранения](../storage-monitor-storage-account.md)

[Общая информация об оплате службы хранилища Azure](http://blogs.msdn.com/b/windowsazurestorage/archive/2010/07/09/understanding-windows-azure-storage-billing-bandwidth-transactions-and-capacity.aspx)

## Изменения
* Указания по изменениям при переходе от веб-сайтов к службе приложений см. в разделе [Служба приложений Azure и ее влияние на существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).
* Руководство по смене старого портала на новый портал см. в разделе [Справочник по навигации на предварительной версии портала](http://go.microsoft.com/fwlink/?LinkId=529715).

<!-- IMAGES -->
[ChooseBackupsPage]: ./media/web-sites-backup/01ChooseBackupsPage.png
[ChooseStorageAccount]: ./media/web-sites-backup/02ChooseStorageAccount.png
[IncludedDatabases]: ./media/web-sites-backup/03IncludedDatabases.png
[BackUpNow]: ./media/web-sites-backup/04BackUpNow.png
[BackupProgress]: ./media/web-sites-backup/05BackupProgress.png
[SetAutomatedBackupOn]: ./media/web-sites-backup/06SetAutomatedBackupOn.png
[Frequency]: ./media/web-sites-backup/07Frequency.png
[StartDate]: ./media/web-sites-backup/08StartDate.png
[StartTime]: ./media/web-sites-backup/09StartTime.png
[SaveIcon]: ./media/web-sites-backup/10SaveIcon.png
[ImagesFolder]: ./media/web-sites-backup/11Images.png
[LogsFolder]: ./media/web-sites-backup/12Logs.png
[GhostUpgradeWarning]: ./media/web-sites-backup/13GhostUpgradeWarning.png
 

<!---HONumber=62-->