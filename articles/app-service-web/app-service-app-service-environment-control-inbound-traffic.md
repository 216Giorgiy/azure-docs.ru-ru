<properties 
	pageTitle="Как управлять входящим трафиком в среде службы приложений" 
	description="Дополнительные сведения о настройке правил сетевой безопасности для управления входящим трафиком в среде службы приложений." 
	services="app-service" 
	documentationCenter="" 
	authors="ccompy" 
	manager="wpickett" 
	editor=""/>

<tags 
	ms.service="app-service" 
	ms.workload="na" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/06/2016" 
	ms.author="stefsch"/>

# Как управлять входящим трафиком в среде службы приложений

## Обзор ##
Среда службы приложения всегда создается в подсети классической региональной [виртуальной сети][virtualnetwork] версии 1. Новую классическую региональную виртуальную сеть версии 1 и новую подсеть можно определить во время создания среды службы приложений. Кроме того, среду службы приложений можно создать в существующей классической региональной виртуальной сети версии 1 и существующей подсети. Сейчас поддерживаются только виртуальные сети с адресным пространством RFC1918 (т. е. частными адресами). Дополнительные сведения о создании среды службы приложений см. в статье [Создание среды службы приложений][HowToCreateAnAppServiceEnvironment].

**Примечание.** Среду службы приложений невозможно создать в виртуальной сети v2 под управлением ARM.

Среда службы приложений всегда должна создаваться в подсети, поскольку подсеть обеспечивает границы сети, которые можно использовать для блокировки входящего трафика за вышестоящими устройствами и службами, например трафик HTTP и HTTPS допускается только от определенных вышестоящих IP-адресов.

Входящий и исходящий сетевой трафик в подсети контролируется с помощью [группы сетевой безопасности][NetworkSecurityGroups]. Для управления входящим трафиком необходимо создать правила сетевой безопасности в группе сетевой безопасности, а затем назначить группу сетевой безопасности для подсети, содержащей среду службы приложений.

После назначения группы сетевой безопасности для подсети входящий трафик на приложения в среде службы приложений разрешается или блокируется в зависимости от правил разрешения или блокировки, определенных в группе сетевой безопасности.

[AZURE.INCLUDE [app-service-web-to-api-and-mobile](../../includes/app-service-web-to-api-and-mobile.md)]

## Сетевые порты, используемые в среде службы приложений ##
Перед блокировкой входящего сетевого трафика с помощью группы сетевой безопасности важно знать набор обязательных и необязательных сетевых портов, используемых средой службы приложений. Случайное закрытие трафика на некоторых портах может привести к потере функциональности в среде службы приложений.

Ниже приведен список портов, используемых средой службы приложений.

- 454: **обязательный порт**, используемый инфраструктурой Azure для управления и обслуживания сред службы приложений. Не блокируйте трафик на этом порту.
- 455: **обязательный порт**, используемый инфраструктурой Azure для управления и обслуживания сред службы приложений. Не блокируйте трафик на этом порту.
- 80: порт по умолчанию для входящего трафика HTTP на приложения, выполняемые в планах службы приложений в среде службы приложений.
- 443: порт по умолчанию для входящего трафика SSL на приложения, выполняемые в планах службы приложений в среде службы приложений.
- 21: канал управления для FTP. Этот порт можно безопасно заблокировано, если FTP не используется.
- 10001 10020: каналы данных для FTP. Как и с каналом управления, эти порты можно безопасно заблокировать, если FTP не используется. (**Примечание.** Каналы данных FTP могут измениться во время предварительного просмотра.)
- 4016: используется для удаленной отладки с помощью Visual Studio 2012. Этот порт можно безопасно заблокировано, если функция не используется.
- 4018: используется для удаленной отладки с помощью Visual Studio 2013. Этот порт можно безопасно заблокировано, если функция не используется.
- 4020: используется для удаленной отладки с помощью Visual Studio 2015. Этот порт можно безопасно заблокировано, если функция не используется.

## Требования к DNS и исходящим подключениям ##
Для правильной работы среды службы приложений требуется исходящий повсеместный доступ к хранилищу Azure и базе данных SQL в том же регионе Azure. Если исходящий доступ к Интернету заблокирован в виртуальной сети, среды службы приложений не смогут получить доступ к этим конечным точкам Azure.

Для сред службы приложений также требуется допустимая инфраструктура DNS, настроенная для виртуальной сети. Если после создания среды службы приложений по какой-либо причине меняется конфигурация DNS, разработчик может принудительно задать выбор новой конфигурации DNS в среде службы приложений. Перезагрузка разворачиваемой среды с помощью значка "Перезапуск", расположенного в верхней части колонки управления средой службы приложений на [классическом портале Azure][NewPortal], приведет к выбору новой конфигурации DNS в среде.

В следующем списке приведены требования к подключениям и DNS для среды службы приложений.

-  Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Сюда входят конечные точки, находящиеся в одном регионе со средой службы приложений, а также конечные точки хранилища, расположенные в **других** регионах Azure. Конечные точки хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*.  
-  Исходящие сетевые подключения к конечным точкам баз данных SQL, которые находятся в одном регионе со средой службы приложений. Конечные точки баз данных SQL разрешаются в следующем домене: *database.windows.net*.
-  Исходящие сетевые подключения к конечным точкам плоскости управления Azure (конечные точки ASM и ARM). В том числе исходящие подключения к *management.core.windows.net* и *management.azure.com*. 
-  Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*. Это необходимо для поддержки функций протокола SSL.
-  Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Если эти конечные точки разрешить нельзя, попытка создания среды службы приложений завершится ошибкой, а существующие среды службы приложений будут помечены как неработоспособные.
-  Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой находится среда службы приложений. 
-  Путь для исходящих сетевых подключений не может проходить через внутренние корпоративные прокси и не может принудительно туннелироваться в локальную среду, потому что в этом случае меняется действующий адрес NAT для исходящего сетевого трафика из среды службы приложений. Изменение адреса NAT для исходящего сетевого трафика среды службы приложений приведет к появлению проблем подключения ко многим указанным выше конечным точкам. Это приведет к неудачным попыткам создания среды службы приложений, а также присвоению ранее работоспособной среде службы приложений статуса неработоспособной.  
-  Необходимо предоставить разрешения для входящих сетевых подключений на нужных портах для сред службы приложений согласно процедуре, описанной в этой [статье](app-service-app-service-environment-control-inbound-traffic.md).

Также рекомендуется настроить пользовательские DNS-серверы в виртуальной сети заранее, т. е. до создания среды службы приложений. Если конфигурация виртуальной сети DNS изменяется во время создания среды службы приложений, это приведет к сбою процесса создания среды службы приложений. Аналогично, если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, который недоступен, процесс создания среды службы приложений будет прерван.

## Создание группы сетевой безопасности ##
Подробные сведения о принципах работы групп сетевой безопасности см. сведения [здесь][NetworkSecurityGroups]. Ниже приведены основные сведения о группах сетевой безопасности. Особое внимание уделено настройке и применению группы сетевой безопасности к подсети, которая содержит среду службы приложений.

**Примечание.** Группы безопасности сети можно настроить только с помощью командлетов Powershell, описанных ниже. Группы безопасности сети нельзя настроить с помощью графического интерфейса пользователя на [портале Azure](https://portal.azure.com), потому что этот портал позволяет настроить только группы безопасности сети, связанные с виртуальными сетями версии 2. Тем не менее, сейчас среды службы приложений работают только с классическими виртуальными сетями версии 1. Поэтому для настройки групп безопасности сети, связанных с виртуальными сетями версии 1, можно использовать только командлеты Powershell.

Сначала группы сетевой безопасности создаются как отдельные сущности, связанные с подпиской. Так как группы сетевой безопасности создаются в области Azure, убедитесь, что группа сетевой безопасности создана в той же области, что и среда службы приложений.

Ниже показано создание группы сетевой безопасности.

    New-AzureNetworkSecurityGroup -Name "testNSGexample" -Location "South Central US" -Label "Example network security group for an app service environment"

После создания группы сетевой безопасности к ней добавляются одно или несколько правил сетевой безопасности. Поскольку набор правил может со временем меняться, рекомендуется организовать схему нумерации, используемую для приоритетов правил, таким образом, чтобы дополнительные правила можно было просто вставить в дальнейшем.

В приведенном ниже примере показано правило, которое разрешает доступ к портам управления, необходимым для управления и обслуживания среды службы приложений инфраструктурой Azure. Обратите внимание, что весь трафик управления проходит по SSL и защищен клиентскими сертификатами, поэтому, несмотря на то, что порты открыты, они недоступны для любой сущности, кроме инфраструктуры управления Azure.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "ALLOW AzureMngmt" -Type Inbound -Priority 100 -Action Allow -SourceAddressPrefix 'INTERNET'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '454-455' -Protocol TCP
    

При блокировании доступа к портам 80 и 443, чтобы «скрыть» среду службы приложений за вышестоящими устройствами или службами, необходимо знать вышестоящий IP-адрес. Например, если вы используете брандмауэр веб-приложения (WAF), WAF будет иметь свой собственный IP-адрес (или адреса), которые он использует при перенаправлении трафика на нисходящую среду службы приложений. Необходимо будет использовать этот IP-адрес в параметре *SourceAddressPrefix* правила сетевой безопасности.

В следующем примере входящий трафик от конкретного вышестоящего IP-адреса полностью разрешен. Адрес *1.2.3.4* используется как заполнитель для IP-адреса вышестоящего WAF. Измените значение адреса на адрес, используемый вышестоящим устройством или службой.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTP" -Type Inbound -Priority 200 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '80' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTPS" -Type Inbound -Priority 300 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '443' -Protocol TCP
    
Если требуется поддержка FTP, следующие правила можно использовать как шаблон для предоставления доступа к порту управления FTP и портал каналов данных. Поскольку протокол FTP является протоколом с отслеживанием состояния, нельзя будет направить FTP-трафик через обычный брандмауэр HTTP/HTTPS или прокси-устройство. В этом случае необходимо задать для параметра *SourceAddressPrefix* другое значение, например диапазон IP-адресов машин разработчика или развертывания, на которых запущены FTP-клиенты.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPCtrl" -Type Inbound -Priority 400 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '21' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPDataRange" -Type Inbound -Priority 500 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '10001-10020' -Protocol TCP

(**Примечание.** Диапазон портов канала данных может измениться в период использования предварительной версии.)

Следующие правила показывают, как предоставить доступ при использовании удаленной отладки с помощью Visual Studio. Существует отдельное правило для каждой поддерживаемой версии Visual Studio, поскольку каждая версия использует другой порт для удаленной отладки. Как и для FTP-доступа, трафик удаленной отладки не может правильно проходить через традиционный брандмауэр WAF или прокси-устройство. Для параметра *SourceAddressPrefix* вместо этого можно задать значение диапазона IP-адресов машины разработчиков, на которых запущена программа Visual Studio.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2012" -Type Inbound -Priority 600 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4016' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2013" -Type Inbound -Priority 700 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4018' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2015" -Type Inbound -Priority 800 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4020' -Protocol TCP

## Назначение группы сетевой безопасности для подсети ##
Группа сетевой безопасности имеет правило безопасности по умолчанию, которое запрещает доступ для любого внешнего трафика. Результатом объединения описанных выше правил сетевой безопасности и правила безопасности по умолчанию, которое блокирует входящий трафик, является то, что только трафик из исходных диапазонов адресов, связанных с действием *Разрешить*, будет отправляться к приложениям, работающим в среде службы приложений.

После заполнения группы сетевой безопасности правилами безопасности ее необходимо назначить для подсети, содержащей среду службы приложений. Команда назначения ссылается как на имя виртуальной сети, в которой находится среда службы приложений, так и на имя подсети, в которой была создана среда службы приложений.

В приведенном ниже примере показана группа сетевой безопасности, назначаемая для подсети и виртуальной сети.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityGroupToSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

После успешного назначения группы сетевой безопасности (назначение является длительным процессом и может занять несколько минут) только входящий трафик, соответствующий правилам *Разрешить*, успешно дойдет до приложений в среде службы приложений.

Для полноты картины в приведенном ниже примере показано, как удалить группу сетевой безопасности для подсети и тем самым отменить связь между ними.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Remove-AzureNetworkSecurityGroupFromSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

## Специальные рекомендации для SSL на основе явного IP ##
Если приложение настроено с использованием явного IP-адреса, то вместо IP-адреса по умолчанию среды службы приложений трафик HTTP и HTTPS пропускается в подсеть по другому набору портов, отличному от портов 80 и 443.

Отдельные пары портов, используемых для каждого адреса IP-SSL, можно найти, щелкнув «Все параметры» > «IP-адреса» в колонке пользовательского интерфейса среды службы приложения. В колонке «IP-адреса» показана таблица всех явно заданных адресов IP-SSL для среды службы приложения, а также специальные пары портов, используемых для маршрутизации трафика HTTP и HTTPS, связанного с каждым адресом IP-SSL. Эти пары портов необходимо использовать для параметров DestinationPortRange при настройке правил в группе безопасности сети.

## Приступая к работе

Чтобы начать работу со средами службы приложений, см. статью [Введение в среду службы приложений][IntroToAppServiceEnvironment]

Подробные сведения о безопасном подключении приложений к серверным ресурсам из среды службы приложений см. в разделе [Безопасное подключение к серверным ресурсам из среды службы приложений][SecurelyConnecttoBackend]

Дополнительные сведения о платформе службы приложений Azure см. в статье [Служба приложений Azure][AzureAppService].

[AZURE.INCLUDE [app-service-web-whats-changed](../../includes/app-service-web-whats-changed.md)]

[AZURE.INCLUDE [app-service-web-try-app-service](../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[virtualnetwork]: https://azure.microsoft.com/documentation/articles/virtual-networks-faq/
[HowToCreateAnAppServiceEnvironment]: http://azure.microsoft.com/documentation/articles/app-service-web-how-to-create-an-app-service-environment/
[NetworkSecurityGroups]: https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[AzureAppService]: http://azure.microsoft.com/documentation/articles/app-service-value-prop-what-is/
[IntroToAppServiceEnvironment]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-intro/
[SecurelyConnecttoBackend]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-securely-connecting-to-backend-resources/
[NewPortal]: https://portal.azure.com

<!-- IMAGES -->
 

<!---HONumber=AcomDC_0504_2016-->