<properties 
	pageTitle="Как управлять входящим трафиком в среде службы приложений"
	description="Дополнительные сведения о настройке правил сетевой безопасности для управления входящим трафиком в среде службы приложений."
	services="app-service\web"
	documentationCenter=""
	authors="ccompy"
	manager="wpickett"
	editor=""/>

<tags 
	ms.service="app-service-web"
	ms.workload="web"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/30/2015"
	ms.author="stefsh"/>

# Как управлять входящим трафиком в среде службы приложений

## Обзор ##
Среда службы приложения всегда создается в подсети региональной [виртуальной сети][virtualnetwork]. Новую региональную виртуальную сеть и новую подсеть можно определить во время создания среды службы приложений. Кроме того, среду службы приложений можно создать в существующей региональной виртуальной сети и существующей подсети. Дополнительные сведения о создании среды службы приложений см. в статье [Создание среды службы приложений][HowToCreateAnAppServiceEnvironment].

Среда службы приложений всегда должна создаваться в подсети, поскольку подсеть обеспечивает границы сети, которые можно использовать для блокировки входящего трафика за вышестоящими устройствами и службами, например трафик HTTP и HTTPS допускается только от определенных вышестоящих IP-адресов.

Входящий и исходящий сетевой трафик в подсети контролируется с помощью [группы сетевой безопасности][NetworkSecurityGroups]. Для управления входящим трафиком необходимо создать правила сетевой безопасности в группе сетевой безопасности, а затем назначить группу сетевой безопасности для подсети, содержащей среду службы приложений.

После назначения группы сетевой безопасности для подсети входящий трафик на приложения в среде службы приложений разрешается или блокируется в зависимости от правил разрешения или блокировки, определенных в группе сетевой безопасности.

## Сетевые порты, используемые в среде службы приложений ##
Перед блокировкой входящего сетевого трафика с помощью группы сетевой безопасности важно знать набор обязательных и необязательных сетевых портов, используемых средой службы приложений. Случайное закрытие трафика на некоторых портах может привести к потере функциональности в среде службы приложений.

Ниже приведен список портов, используемых средой службы приложений.

- 454: **обязательный порт**, используемый инфраструктурой Azure для управления и обслуживания сред службы приложений. Не блокируйте трафик на этом порту.
- 455: **обязательный порт**, используемый инфраструктурой Azure для управления и обслуживания сред службы приложений. Не блокируйте трафик на этом порту.
- 80: порт по умолчанию для входящего трафика HTTP на приложения, выполняемые в планах службы приложений в среде службы приложений.
- 443: порт по умолчанию для входящего трафика SSL на приложения, выполняемые в планах службы приложений в среде службы приложений.
- 21: канал управления для FTP. Этот порт можно безопасно заблокировано, если FTP не используется.
- 10001 10020: каналы данных для FTP. Как и с каналом управления, эти порты можно безопасно заблокировать, если FTP не используется (**Примечание.** Каналы данных FTP могут измениться во время предварительного просмотра.)
- 4016: используется для удаленной отладки с помощью Visual Studio 2012. Этот порт можно безопасно заблокировано, если функция не используется.
- 4018: используется для удаленной отладки с помощью Visual Studio 2013. Этот порт можно безопасно заблокировано, если функция не используется.
- 4020: используется для удаленной отладки с помощью Visual Studio 2015. Этот порт можно безопасно заблокировано, если функция не используется.

## Требования к DNS и исходящим подключениям ##
Обратите внимание, что для правильной работы среды службы приложений также требуется исходящий доступ к хранилищу Azure и базе данных SQL в том же регионе Azure. Если исходящий доступ к Интернету заблокирован в виртуальной сети, среды службы приложений не смогут получить доступ к этим конечным точкам Azure.

Клиент может также иметь пользовательские DNS-серверы в виртуальной сети. Среды служб приложений должны быть в состоянии разрешать адреса конечных точек Azure для имен *.database.windows.net, *.file.core.windows.net и *.blob.core.windows.net.

Также рекомендуется настроить пользовательские DNS-серверы в виртуальной сети заранее, т. е. до создания среды службы приложений. Если конфигурация виртуальной сети DNS изменяется во время создания среды службы приложений, это приведет к сбою процесса создания среды службы приложений.

## Создание группы сетевой безопасности ##
Подробные сведения о принципах работы групп сетевой безопасности см. сведения [здесь][NetworkSecurityGroups]. Ниже приведены основные сведения о группах сетевой безопасности. Особое внимание уделено настройке и применению группы сетевой безопасности к подсети, которая содержит среду службы приложений.

Сначала группы сетевой безопасности создаются как отдельные сущности, связанные с подпиской. Так как группы сетевой безопасности создаются в области Azure, убедитесь, что группа сетевой безопасности создана в той же области, что и среда службы приложений.

Ниже показано создание группы сетевой безопасности.

    New-AzureNetworkSecurityGroup -Name "testNSGexample" -Location "South Central US" -Label "Example network security group for an app service environment"

После создания группы сетевой безопасности к ней добавляются одно или несколько правил сетевой безопасности. Поскольку набор правил может со временем меняться, рекомендуется организовать схему нумерации, используемую для приоритетов правил, таким образом, чтобы дополнительные правила можно было просто вставить в дальнейшем.

В приведенном ниже примере показано правило, которое разрешает доступ к портам управления, необходимым для управления и обслуживания среды службы приложений инфраструктурой Azure. Обратите внимание, что весь трафик управления проходит по SSL и защищен клиентскими сертификатами, поэтому, несмотря на то, что порты открыты, они недоступны для любой сущности, кроме инфраструктуры управления Azure.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "ALLOW AzureMngmt" -Type Inbound -Priority 100 -Action Allow -SourceAddressPrefix 'INTERNET'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '454-455' -Protocol TCP
    

При блокировании доступа к портам 80 и 443, чтобы «скрыть» среду службы приложений за вышестоящими устройствами или службами, необходимо знать вышестоящий IP-адрес. Например, если вы используете брандмауэр веб-приложения (WAF), WAF будет иметь свой собственный IP-адрес (или адреса), которые он использует при перенаправлении трафика на нисходящую среду службы приложений. Необходимо будет использовать этот IP-адрес в параметре *SourceAddressPrefix* правила сетевой безопасности.

В следующем примере входящий трафик от конкретного вышестоящего IP-адреса полностью разрешен. Адрес *1.2.3.4* используется как заполнитель для IP-адреса вышестоящего WAF. Измените значение адреса на адрес, используемый вышестоящим устройством или службой.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTP" -Type Inbound -Priority 200 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '80' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTPS" -Type Inbound -Priority 300 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '443' -Protocol TCP
    
Если требуется поддержка FTP, следующие правила можно использовать как шаблон для предоставления доступа к порту управления FTP и портал каналов данных. Поскольку протокол FTP является протоколом с отслеживанием состояния, нельзя будет направить FTP-трафик через обычный брандмауэр HTTP/HTTPS или прокси-устройство. В этом случае необходимо задать для параметра *SourceAddressPrefix* другое значение, например диапазон IP-адресов машин разработчика или развертывания, на которых запущены FTP-клиенты.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPCtrl" -Type Inbound -Priority 400 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '21' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPDataRange" -Type Inbound -Priority 500 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '10001-10020' -Protocol TCP

(**Примечание.** Диапазон портов канала данных может измениться в период предварительного просмотра.)

Следующие правила показывают, как предоставить доступ при использовании удаленной отладки с помощью Visual Studio. Существует отдельное правило для каждой поддерживаемой версии Visual Studio, поскольку каждая версия использует другой порт для удаленной отладки. Как и для FTP-доступа, трафик удаленной отладки не может правильно проходить через традиционный брандмауэр WAF или прокси-устройство. Для параметра *SourceAddressPrefix* вместо этого можно задать значение диапазона IP-адресов машины разработчиков, на которых запущена программа Visual Studio.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2012" -Type Inbound -Priority 600 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4016' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2013" -Type Inbound -Priority 700 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4018' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2015" -Type Inbound -Priority 800 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4020' -Protocol TCP

## Назначение группы сетевой безопасности для подсети ##
Группа сетевой безопасности имеет правило безопасности по умолчанию, которое запрещает доступ для любого внешнего трафика. Результатом объединения описанных выше правил сетевой безопасности и правила безопасности по умолчанию, которое блокирует входящий трафик, является то, что только трафик из исходных диапазонов адресов, связанных с действием *Разрешить*, будет отправляться к приложениям, работающим в среде службы приложений.

После заполнения группы сетевой безопасности правилами безопасности ее необходимо назначить для подсети, содержащей среду службы приложений. Команда назначения ссылается как на имя виртуальной сети, в которой находится среда службы приложений, так и на имя подсети, в которой была создана среда службы приложений.

В приведенном ниже примере показана группа сетевой безопасности, назначаемая для подсети и виртуальной сети.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityGroupToSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

После успешного назначения группы сетевой безопасности (назначение является длительным процессом и может занять несколько минут) только входящий трафик, соответствующий правилам *Разрешить*, успешно дойдет до приложений в среде службы приложений.

Для полноты картины в приведенном ниже примере показано, как удалить группу сетевой безопасности для подсети и тем самым отменить связь между ними.


    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Remove-AzureNetworkSecurityGroupFromSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

## Специальные рекомендации для SSL на основе явного IP ##
Если приложение настроено с использованием явного IP-адреса, то вместо IP-адреса по умолчанию среды службы приложений трафик HTTP и HTTPS пропускается в подсеть по другому набору портов, отличному от портов 80 и 443.

Во время начального предварительного просмотра сред службы приложений невозможно определить точные порты, используемые SSL на основе IP. Однако после предоставления этой информации через портал, средства командной строки и REST API разработчики смогут настроить группы сетевой безопасности так, чтобы осуществлять контроль трафика через эти порты.

## Приступая к работе

Чтобы начать работу со средами службы приложений, см. статью [Введение в среду службы приложений][IntroToAppServiceEnvironment]

Подробные сведения о безопасном подключении приложений к серверным ресурсам из среды службы приложений см. в разделе [Безопасное подключение к серверным ресурсам из среды службы приложений][SecurelyConnecttoBackend]

Дополнительные сведения о платформе службы приложений Azure см. в статье [Служба приложений Azure][AzureAppService].

[AZURE.INCLUDE [app-service-web-whats-changed](../../includes/app-service-web-whats-changed.md)]

[AZURE.INCLUDE [app-service-web-try-app-service](../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[virtualnetwork]: https://azure.microsoft.com/documentation/articles/virtual-networks-faq/
[HowToCreateAnAppServiceEnvironment]: http://azure.microsoft.com/documentation/articles/app-service-web-how-to-create-an-app-service-environment/
[NetworkSecurityGroups]: https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[AzureAppService]: http://azure.microsoft.com/documentation/articles/app-service-value-prop-what-is/
[IntroToAppServiceEnvironment]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-intro/
[SecurelyConnecttoBackend]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-securely-connecting-to-backend-resources/

<!-- IMAGES -->

<!---HONumber=August15_HO9-->