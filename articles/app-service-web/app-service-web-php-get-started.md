<properties
	pageTitle="Создание, настройка и развертывание веб-приложения PHP в Azure"
	description="В этом руководстве описывается, как запустить веб-приложение PHP (Laravel) в службе приложений Azure. Узнайте, как настроить службу приложений Azure в соответствии с требованиями выбранной платформы PHP."
	services="app-service\web"
	documentationCenter="php"
	authors="cephalin"
	manager="wpickett"
	editor=""
	tags="mysql"/>

<tags
	ms.service="app-service-web"
	ms.workload="web"
	ms.tgt_pltfrm="na"
	ms.devlang="PHP"
	ms.topic="article"
	ms.date="06/03/2016" 
	ms.author="cephalin"/>

# Создание, настройка и развертывание веб-приложения PHP в Azure

[AZURE.INCLUDE [вкладки](../../includes/app-service-web-get-started-nav-tabs.md)]

В этом руководстве описывается, как создать, настроить и развернуть веб-приложение PHP в Azure, а также как настроить службу приложений Azure в соответствии с требованиями веб-приложения PHP. По окончании изучения этого руководства у вас будет работающее веб-приложение [Laravel](https://www.laravel.com/), запущенное в [службе приложений Azure](../app-service/app-service-value-prop-what-is.md) в режиме реального времени.

Как разработчик PHP вы можете перенести предпочитаемую среду PHP в Azure. В этом руководстве в качестве примера используется приложение Laravel. Вы узнаете:

- как выполнить развертывание с помощью Git;
- как установить версию PHP;
- как использовать файл запуска, который не находится в корневом каталоге приложения;
- как получить доступ к переменным конкретной среды;
- как обновить приложение в Azure.

Вы сможете применить полученные здесь знания для других веб-приложений PHP, развертываемых в Azure.

## Предварительные требования

- Установка [PHP 5.6.x](http://php.net/downloads.php) (с поддержкой бета-версии PHP 7).
- Установка инструмента [Composer](https://getcomposer.org/download/).
- Установка [интерфейса командной строки Azure](../xplat-cli-install.md).
- Установка [Git](http://www.git-scm.com/downloads).
- Учетная запись Microsoft Azure. Если у вас нет учетной записи, [подпишитесь на бесплатную пробную версию](/pricing/free-trial/?WT.mc_id=A261C142F) или [активируйте преимущества для подписчиков Visual Studio](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F).

>[AZURE.NOTE] Веб-приложение можно увидеть в действии. [Попробуйте службу приложений](http://go.microsoft.com/fwlink/?LinkId=523751) — в ней можно быстро создать кратковременное приложение начального уровня. Для этого не потребуется ни кредитная карта, ни какие-либо обязательства.

## Создание приложения PHP (Laravel) на компьютере разработки

1. Откройте новое окно командной строки Windows, окно PowerShell, оболочку Linux или терминал OS X. Чтобы проверить, правильно ли установлены требуемые инструменты на компьютере, выполните следующие команды.

        php --version
        composer --version
        azure --version
        git --version

    ![Протестируйте установку инструментов перед созданием приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/test-tools.png)

    Если вы еще не установили необходимые инструменты, см. ссылки для их загрузки в разделе [Предварительные требования](#Prerequisites).
    
2. Установите приложение Laravel следующим образом:

        composer global require "laravel/installer

3. Перейдите в рабочий каталог, используя команду `CD`, и создайте приложение Laravel следующим образом:

        cd <working_directory>
        laravel new <app_name>

4. Перейдите в только что созданный каталог `<app_name>`, используя команду `CD`, и протестируйте приложение следующим образом:

        cd <app_name>
        php artisan serve
        
    Теперь после перехода по ссылке http://localhost:8000 в браузере отобразится экран-заставка приложения Laravel.
    
    ![Протестируйте приложение PHP (Laravel) локально перед его развертыванием в Azure](./media/app-service-web-php-get-started/laravel-splash-screen.png)
    
Это обычный рабочий процесс Laravel, но мы здесь не для <a href="https://laravel.com/docs/5.2" rel="nofollow">изучения работы с Laravel</a>, поэтому давайте пойдем дальше.

## Создание веб-приложения Azure и настройка развертывания Git

>[AZURE.NOTE] Если вы хотите выполнить развертывание с помощью FTP, см. сведения в [руководстве для FTP](web-sites-php-mysql-deploy-use-ftp.md).

С помощью интерфейса командной строки Azure можно создать веб-приложение в службе приложений Azure и настроить для него развертывание Git, используя всего одну командную строку. Давайте приступим.

1. Переключитесь на режим ASM и войдите в Azure.

        azure config mode asm
        azure login
    
    Следуйте инструкциям из справочного сообщения, чтобы продолжить процесс входа в систему.
    
    ![Войдите в Azure для развертывания приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/log-in-to-azure-cli.png)

4. Выполните приведенную ниже команду, чтобы создать веб-приложение Azure, используя развертывание Git. При появлении запроса укажите номер нужного региона.

        azure site create --git <app_name>
    
    ![Создайте ресурс Azure для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/create-site-cli.png)
    
    >[AZURE.NOTE] Если вы еще не настроили учетные данные развертывания для своей подписки Azure, вам будет предложено создать их. Именно эти учетные данные (а не соответствующие данные учетной записи Azure) используются службой приложений только для развертывания Git и входа по протоколу FTP.
    
    Эта команда создает новый репозиторий Git в текущем каталоге (с использованием `git init`) и подключает его к репозиторию в Azure в качестве удаленного репозитория Git (с использованием `git remote add`).

<a name="configure"/>
## Настройка веб-приложения Azure

Чтобы приложение Laravel работало в Azure, необходимо обратить внимание на несколько моментов. Эти же действия можно выполнить для выбранной платформы PHP.

- Настройте PHP версии 5.5.9 или более поздней. Полный список требований к серверу см. в разделе [Latest Laravel 5.2 Server Requirements](https://laravel.com/docs/5.2#server-requirements) (Требования к серверу для приложения Laravel версии 5.2). В остальной части списка содержатся расширения, которые включены при установке PHP в Azure.
- Укажите переменные среды, необходимые для приложения. Чтобы легко задать переменные среды, в приложении Laravel используется файл `.env`. Но так как он не должен фиксироваться в системе управления версиями (см. раздел о [настройке среды для приложения Laravel](https://laravel.com/docs/5.2/configuration#environment-configuration)), вместо этого вы можете настроить параметры для веб-приложения Azure.
- Сначала загрузите точку входа приложения Laravel `public/index.php`. См. раздел с [обзором жизненного цикла Laravel](https://laravel.com/docs/5.2/lifecycle#lifecycle-overview). Другими словами, необходимо задать корневой URL-адрес веб-приложения, указывающий на каталог `public`.
- Включите расширение Composer в Azure при наличии файла composer.json. Таким образом, во время развертывания с помощью `git push` Composer будет контролировать получение требуемых пакетов. Так удобнее. Если автоматизация Composer не включена, необходимо просто удалить `/vendor` из файла `.gitignore`, чтобы Git включал ("не игнорировал") все содержимое каталога `vendor` во время выполнения и развертывания кода.

Давайте последовательно выполним эти задачи.

4. Установите версию PHP, которая требуется для приложения Laravel.

        azure site set --php-version 5.6

    Теперь версия PHP установлена.
    
4. Создайте новый ключ `APP_KEY` для веб-приложения Azure и установите его в качестве параметра приложения.

        php artisan key:generate --show
        azure site appsetting add APP_KEY="<output_of_php_artisan_key:generate_--show>"

4. Включите отладку Laravel, чтобы устранять все зашифрованные страницы `Whoops, looks like something went wrong.`.

        azure site appsetting add APP_DEBUG=true

    Теперь переменные среды указаны.
    
    >[AZURE.NOTE] Давайте не будем торопиться и разберемся, что конкретно выполняется в Laravel и Azure. Приложение Laravel использует файл `.env` в корневом каталоге, чтобы предоставить приложению переменные среды. В этом файле содержится строка `APP_DEBUG=true` (а также `APP_KEY=...`). Доступ к этой переменной в `config/app.php` осуществляется с помощью кода `'debug' => env('APP_DEBUG', false),`. [env()](https://laravel.com/docs/5.2/helpers#method-env) — это вспомогательный метод Laravel, в котором используется [getenv()](http://php.net/manual/en/function.getenv.php) PHP.
    >
    >Но `.env` игнорируется Git, так как он вызывается с помощью файла `.gitignore` в корневом каталоге. Проще говоря, `.env` в локальном репозитории Git не отправляется в Azure вместе с остальными файлами. Конечно, можно просто удалить эту строку из `.gitignore`, но мы уже выяснили, что этот файл не должен фиксироваться в системе управления версиями. Тем не менее по-прежнему нужен метод, чтобы задать эти переменные среды в Azure.
    >
    >Хорошо, что параметры приложения в службе приложений Azure поддерживают [getenv()](http://php.net/manual/en/function.getenv.php) в PHP. Чтобы вручную отправить файл `.env` в Azure, можно использовать протокол FTP или другие средства. Вы все также можете просто указать необходимые переменные для параметров приложения Azure, не используя файл `.env` в Azure. Кроме того, если переменная указана и в файле `.env`, и в параметрах приложения Azure, параметры приложения Azure являются приоритетными.

4. Для последних двух заданий (настройка виртуального каталога и включение Composer) нужно войти на [портал Azure](https://portal.azure.com) с помощью учетной записи [портала](https://portal.azure.com) Azure.

4. В меню слева выберите пункты **Службы приложений** > **&lt;имя\_приложения>** > **Инструменты**.

    ![Включите Composer для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-composer-tools.png)
    
    >[AZURE.TIP] Щелкнув **Параметры** вместо **Инструменты**, можно получить доступ к колонке **Параметры приложения**, где можно настроить версии PHP, параметры приложения и виртуальные каталоги.
    
4. Выберите пункты **Расширения** > **Добавить**, чтобы добавить расширение.

4. Выберите пункт **Composer** в [колонке](../azure-portal-overview.md) **Выберите расширение** (*колонка* — это страница на портале, которая открывается горизонтально).

4. Нажмите кнопку **ОК** в колонке **Принять юридические условия**.

5. Нажмите кнопку **ОК** в колонке **Добавить расширение**.

    После добавления расширений в Azure в углу отобразится всплывающее сообщение и вы увидите, что в колонке **расширений** добавлено расширение **Composer**.

    ![Колонка расширений после включения расширения Composer для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-composer-end.png)

    Теперь расширение Composer включено.
    
4. Вернитесь в колонку веб-приложения и щелкните **Параметры** > **Параметры приложения**.

    ![Откройте колонку параметров для настройки виртуального каталога для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-virtual-dir-settings.png)

    В колонке **Параметры приложения** обратите внимание на ранее заданную версию PHP:

    ![Версия PHP в колонке параметров для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-virtual-dir-settings-a.png)

    Просмотрите также добавленные параметры приложения:
    
    ![Параметры приложения в колонке параметров для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-virtual-dir-settings-b.png)

4. Перейдите к нижней части колонки и измените корневой виртуальный каталог, указав **site\\wwwroot\\public** вместо **site\\wwwroot**.

    ![Настройте виртуальный каталог для приложения PHP (Laravel) в Azure](./media/app-service-web-php-get-started/configure-virtual-dir-public.png)

4. Щелкните **Сохранить** в верхней части колонки.

    Теперь виртуальный каталог настроен.

## Развертывание веб-приложения с помощью Git (и указание переменных среды)

Теперь все готово к развертыванию кода. Для этого необходимо снова открыть командную строку или терминал.

4. Сохраните все изменения и разверните код в веб-приложении Azure, так же как в любом репозитории Git:

        git add .
        git commit -m "Hurray! My first commit for my Azure app!"
        git push azure master 

    При выполнении `git push` появится запрос на ввод пароля развертывания Git. Введите пароль, указанный при создании учетных данных развертывания во время выполнения команды `azure site create`.
    
5. Давайте запустим веб-приложение в браузере с помощью следующей команды:

        azure site browse

    В браузере должен отобразиться экран-заставка приложения Laravel.
    
    ![Экран-заставка приложения Laravel после развертывания веб-приложения в Azure](./media/app-service-web-php-get-started/laravel-azure-splash-screen.png)
    
    Теперь веб-приложение Laravel выполняется в Azure.
             
## Устранение распространенных ошибок

Ниже приведены некоторые ошибки, с которыми можно столкнуться при работе с этим руководством.

- [В интерфейсе командной строки Azure отображается сообщение 'site' is not an azure command](#clierror) (site не является командой Azure).
- [В веб-приложении отображается ошибка HTTP 403](#http403).
- [В веб-приложении отображается сообщение Whoops, looks like something went wrong](#whoops) (Вероятно, произошла ошибка).
- [В веб-приложении отображается сообщение No supported encryptor found](#encryptor) (Не удалось найти поддерживаемый шифратор).

<a name="clierror"></a>
### В интерфейсе командной строки Azure отображается сообщение 'site' is not an azure command (site не является командой Azure)

При выполнении `azure site *` в терминале командной строки отобразится ошибка `error:   'site' is not an azure command. See 'azure help'.`

Обычно это является результатом переключения в режим Azure Resource Manager (ARM). Чтобы устранить эту проблему, переключитесь обратно в режим управления службами Azure (ASM), выполнив команду `azure config mode asm`.

<a name="http403"></a>
### В веб-приложении отображается ошибка HTTP 403

Вы успешно развернули веб-приложение в Azure, но при его просмотре появляется сообщение `HTTP 403` или `You do not have permission to view this directory or page.`

Скорее всего, это связано с тем, что веб-приложению не удается найти точку входа в приложение Laravel. Для корневого виртуального каталога необходимо задать `site\wwwroot\public`, где находится `index.php` Laravel (см. раздел [Настройка веб-приложения Azure](#configure)).

<a name="whoops"></a>
### В веб-приложении отображается сообщение Whoops, looks like something went wrong (Вероятно, произошла ошибка)

Вы успешно развернули веб-приложение в Azure, но при его просмотре появляется зашифрованное сообщение `Whoops, looks like something went wrong.`

Чтобы получить сообщение об ошибке с подробным описанием, включите отладку Laravel, установив для переменной среды `APP_DEBUG` значение `true` (см. раздел [Настройка веб-приложения Azure](#configure)).

<a name="encryptor"></a>
### В веб-приложении отображается сообщение No supported encryptor found (Не удалось найти поддерживаемый шифратор)

Вы успешно развернули веб-приложение в Azure, но при его просмотре появляется следующее сообщение об ошибке:

![Параметр APP\_KEY отсутствует в приложении PHP (Laravel) в Azure](./media/app-service-web-php-get-started/laravel-error-APP_KEY.png)
    
Это опасная ошибка, но по крайней мере она не зашифрована, так как включена отладка Laravel. Выполнив поверхностный поиск строки ошибки на форумах Laravel, вы узнаете, что эта ошибка возникла, потому что в `.env` не задан параметр APP\_KEY или, как в вашем случае, потому что `.env` вообще не используется в Azure. Чтобы исправить эту ошибку, добавьте `APP_KEY` в качестве параметра приложения Azure (см. раздел [Настройка веб-приложения](#configure)).
    
## Дальнейшие действия

Узнайте, как добавить данные в приложение в разделе [Создание базы данных MySQL в Azure](../store-php-create-mysql-database.md). Кроме того, ознакомьтесь с полезными ресурсами для PHP в Azure, ссылки на которые приведены ниже.

- [Центр разработчиков PHP](/develop/php/)
- [Создание веб-приложения из Azure Marketplace](app-service-web-create-web-app-from-marketplace.md)
- [Настройка PHP в веб-приложениях службы приложений Azure](web-sites-php-configure.md)
- [Преобразование сайта WordPress в мультисайт с помощью службы приложений Azure](web-sites-php-convert-wordpress-multisite.md)
- [Сайт WordPress корпоративного класса в службе приложений Azure](web-sites-php-enterprise-wordpress.md)

<!---HONumber=AcomDC_0914_2016-->