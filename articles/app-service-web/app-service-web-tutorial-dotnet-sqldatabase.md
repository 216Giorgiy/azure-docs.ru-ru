---
title: "Создание приложения ASP.NET в Azure с подключением к базе данных SQL | Документация Майкрософт"
description: "Узнайте, как создать в Azure приложение ASP.NET с подключением к базе данных SQL."
services: app-service\web
documentationcenter: nodejs
author: cephalin
manager: erikre
editor: 
ms.assetid: 03c584f1-a93c-4e3d-ac1b-c82b50c75d3e
ms.service: app-service-web
ms.workload: web
ms.tgt_pltfrm: na
ms.devlang: nodejs
ms.topic: article
ms.date: 05/04/2017
ms.author: cephalin
ms.translationtype: Human Translation
ms.sourcegitcommit: 2db2ba16c06f49fd851581a1088df21f5a87a911
ms.openlocfilehash: 6563d1520149ae5ced7e2de80686ef1624ebb651
ms.contentlocale: ru-ru
ms.lasthandoff: 05/09/2017


---
# <a name="build-an-aspnet-app-in-azure-with-sql-database"></a>Создание приложения ASP.NET в Azure с подключением к базе данных SQL

В этом учебнике показано, как разработать управляемое данными веб-приложение ASP.NET в Azure, подключить его к базе данных SQL Azure и включить функцию управления данными. Выполнив действия, описанные в этом учебнике, вы получите приложение ASP.NET, запущенное в [службе приложений Azure](../app-service/app-service-value-prop-what-is.md) и подключенное к базе данных SQL.

![Опубликованное приложение ASP.NET в веб-приложении Azure](./media/app-service-web-tutorial-dotnet-sqldatabase/azure-app-in-browser.png)

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание базы данных SQL в Azure.
> * Подключение приложения ASP.NET к базе данных SQL.
> * Развертывание приложения в Azure
> * Обновление модели данных и повторное развертывание приложения.
> * Потоковая передача журналов из Azure в окно терминала.
> * Управление приложением на портале Azure.

## <a name="prerequisites"></a>Предварительные требования

Перед запуском этого примера [скачайте и установите бесплатную среду Visual Studio 2017 Community Edition](https://www.visualstudio.com/downloads/). При установке Visual Studio необходимо включить возможность **разработки для Azure**.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="download-the-sample"></a>Скачивание примера приложения
На этом шаге вы скачаете пример приложения ASP.NET.

### <a name="get-the-sample-project"></a>Скачивание примера проекта

Скачайте пример проекта, щелкнув [здесь](https://github.com/Azure-Samples/dotnet-sqldb-tutorial/archive/master.zip).

Извлеките скачанный файл _dotnet-sqldb-tutorial-master.zip_ в рабочий каталог.

> [!TIP]
> Для получения примера также можно клонировать репозиторий GitHub:
>
> ```bash
> git clone https://github.com/Azure-Samples/dotnet-sqldb-tutorial.git
> ```
>
>

Этот пример проекта содержит простое MVC-приложение CRUD [ASP.NET](https://www.asp.net/mvc), созданное на основе [Entity Framework Code First](/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application).

### <a name="run-the-application"></a>Выполнение приложения

В каталоге извлечения откройте файл _dotnet-sqldb-tutorial-master\DotNetAppSqlDb.sln_ в Visual Studio 2017.

После того как пример решения откроется, введите `F5`, чтобы запустить его в браузере.

На главной странице вы должны увидеть простой список задач. Попробуйте добавить несколько задач в пустой список.

![Диалоговое окно "Новый проект ASP.NET"](./media/app-service-web-tutorial-dotnet-sqldatabase/local-app-in-browser.png)

Контекст базы данных использует строку подключения `MyDbConnection`. Эта строка подключения определена в файле _Web.config_ и указана в файле _Models\MyDatabaseContext.cs_. В дальнейшем для подключения веб-приложения Azure к базе данных SQL Azure потребуется только имя строки подключения. 

## <a name="publish-to-azure-with-sql-database"></a>Публикация в Azure с базой данных SQL

В **обозревателе решений** щелкните правой кнопкой мыши проект **DotNetAppSqlDb** и выберите **Опубликовать**.

![Публикация в обозревателе решений](./media/app-service-web-tutorial-dotnet-sqldatabase/solution-explorer-publish.png)

Выберите **Служба приложений Microsoft Azure** и нажмите кнопку **Опубликовать**.

![Публикация с помощью страницы обзора проекта](./media/app-service-web-tutorial-dotnet-sqldatabase/publish-to-app-service.png)

Откроется диалоговое окно **Создать службу приложений**, с помощью которого вы можете создать все ресурсы Azure, необходимые для запуска веб-приложения ASP.NET в Azure.

### <a name="sign-in-to-azure"></a>Вход в Azure

В диалоговом окне **Создать службу приложений** щелкните **Добавить новую учетную запись**, а затем выполните вход в подписку Azure. Если вы уже вошли в учетную запись Майкрософт, проверьте, содержит ли она подписку Azure. Если подписки нет, щелкните ее, чтобы добавить правильную учетную запись.
   
![Вход в Azure](./media/app-service-web-tutorial-dotnet-sqldatabase/sign-in-azure.png)

После того как вы войдете в систему, вы будете готовы создать все ресурсы, необходимые для веб-приложения Azure в этом диалоговом окне.

### <a name="create-a-resource-group"></a>Создание группы ресурсов

В первую очередь вам необходима _группа ресурсов_. 

> [!NOTE] 
> Группа ресурсов — это логический контейнер, в котором происходит развертывание ресурсов Azure (веб-приложений, баз данных и учетных записей хранения) и управление ими.
>
>

Рядом с **группой ресурсов** щелкните **Создать**.

Присвойте группе ресурсов имя **myResourceGroup** и нажмите кнопку **ОК**.

### <a name="create-an-app-service-plan"></a>Создание плана службы приложений

Вашему веб-приложению Azure также необходим _план службы приложений_. 

> [!NOTE]
> План службы приложений представляет собой коллекцию физических ресурсов, используемых для размещения приложений. Все приложения, назначенные плану службы приложений, совместно используют ресурсы, определенные в нем. Поэтому, разместив несколько приложений, вы сможете сэкономить. 
>
> Планы службы приложений определяют такие компоненты:
>
> - регион (Северная Европа, восточная часть США, Юго-Восточная Азия);
> - размер экземпляра (небольшой, средний, крупный);
> - число масштабируемых элементов (один, два, три экземпляра и т. д.); 
> - SKU ("Бесплатный", "Общий", "Базовый", "Стандартный", "Премиум").
>
>

Рядом с **планом службы приложений** щелкните **Создать**. 

В диалоговом окне **Настроить план службы приложений** настройте новый план службы приложений, задав приведенные ниже параметры.

- **План службы приложений**. Введите **myAppServicePlan**. 
- **Расположение**. Выберите **Западная Европа** или любой другой регион на свое усмотрение.
- **Размер**. Выберите **Бесплатно** или любую другую [ценовую категорию](https://azure.microsoft.com/pricing/details/app-service/) на свое усмотрение.

Нажмите кнопку **ОК**.

![Создание плана службы приложений](./media/app-service-web-tutorial-dotnet-sqldatabase/configure-app-service-plan.png)

### <a name="configure-the-web-app-name"></a>Настройка имени веб-приложения

В поле **Имя веб-приложения** введите уникальное имя. Это имя используется как часть DNS-имени по умолчанию для приложения (`<app_name>.azurewebsites.net`), поэтому оно должно быть глобально уникальным среди всех приложений Azure. Позже вы можете сопоставить имя пользовательского домена с приложением, перед тем как предоставить его пользователям.

Вы также можете принять имя, созданное автоматически, которое тоже является уникальным.

Чтобы подготовиться к следующему шагу, щелкните **Обзор дополнительных служб Azure**.

> [!NOTE]
> Пока что не нажимайте кнопку **Создать** в этом диалоговом окне. Сначала необходимо настроить базу данных SQL на следующем шаге.

![Настройка имени веб-приложения](./media/app-service-web-tutorial-dotnet-sqldatabase/web-app-name.png)

### <a name="create-a-sql-server-instance"></a>Создание экземпляра SQL Server

На вкладке **Службы** щелкните значок **+** рядом с **базой данных SQL**. 

В окне **Настройка базы данных SQL** нажмите кнопку **Создать** рядом с **SQL Server**. 

В поле **Имя сервера** введите уникальное имя. Это имя используется как часть DNS-имени по умолчанию для сервера базы данных (`<server_name>.database.windows.net`), поэтому оно должно быть уникальным для всех экземпляров SQL Server в Azure. 

Заполните остальные поля подходящими значениями и нажмите кнопку **OK**.

![Создание экземпляра SQL Server](./media/app-service-web-tutorial-dotnet-sqldatabase/configure-sql-database-server.png)

### <a name="configure-the-sql-database"></a>Настройка базы данных SQL

В поле **Имя базы данных** введите _myToDoAppDb_ или любое другое имя.

В поле **Имя строки подключения** введите _MyDbConnection_. Это имя должно совпадать с именем строки подключения, указанном в _Models\MyDatabaseContext.cs_.

![Настройка базы данных SQL](./media/app-service-web-tutorial-dotnet-sqldatabase/configure-sql-database.png)

### <a name="create-and-publish-the-web-app"></a>Создание и публикация веб-приложения

Щелкните **Создать**. 

Когда мастер создаст ресурсы Azure, веб-приложение ASP.NET будет автоматически опубликовано в Azure, а затем открыто в браузере по умолчанию.

Попробуйте добавить несколько задач в пустой список.

![Опубликованное приложение ASP.NET в веб-приложении Azure](./media/app-service-web-tutorial-dotnet-sqldatabase/azure-app-in-browser.png)

Поздравляем! Вы запустили управляемое данными приложение ASP.NET в службе приложений Azure.

## <a name="access-the-sql-database-locally"></a>Локальный доступ к базе данных SQL

В **обозревателе объектов SQL Server** Visual Studio вы сможете легко просматривать свою базу данных SQL и управлять ею.

### <a name="create-a-database-connection"></a>Создание подключения к базе данных

Откройте **обозреватель объектов SQL Server**, выполнив команды `Ctrl`+`` ` ``, `Ctrl`+`S`.

В верхней части **обозревателя объектов SQL Server** нажмите кнопку **Добавить SQL Server**.

### <a name="configure-the-database-connection"></a>Настройка подключения к базе данных

В диалоговом окне **Подключение** разверните узел **Azure**. Вы увидите список со всеми базами данных SQL в Azure.

Выберите ранее созданную базу данных SQL. В нижней части автоматически появятся сведения о подключении, которое использовалось в прошлый раз.

Введите пароль администратора базы данных, который использовался ранее, и нажмите кнопку **Подключиться**.

![Настройка подключения к базе данных из Visual Studio](./media/app-service-web-tutorial-dotnet-sqldatabase/connect-to-sql-database.png)

### <a name="allow-client-connection-from-your-computer"></a>Разрешение клиентских подключений с вашего компьютера

Откроется диалоговое окно **Создать новое правило брандмауэра**. По умолчанию к экземпляру SQL Server могут подключаться только службы Azure, такие как ваше веб-приложение Azure. Чтобы подключиться к базе данных непосредственно из Visual Studio, необходимо создать правило брандмауэра в экземпляре SQL Server, которое разрешало бы подключения с общедоступного IP-адреса вашего локального компьютера.

В Visual Studio сделать это нетрудно. В диалоговом окне уже указан общедоступный IP-адрес компьютера.

Убедитесь, что флажок **Добавить IP-адрес моего клиента** установлен, и щелкните **ОК**. 

![Настройка брандмауэра для экземпляра SQL Server](./media/app-service-web-tutorial-dotnet-sqldatabase/sql-set-firewall.png)

После окончания настройки брандмауэра для экземпляра SQL Server ваше подключение появится в **обозревателе объектов SQL Server**.

В нем вы можете выполнять большинство распространенных операций с базой данных: выполнять запросы, создавать представления и хранимые процедуры и многое другое. В следующем примере показано, как просмотреть данные в базе данных. 

![Просмотр объектов базы данных SQL](./media/app-service-web-tutorial-dotnet-sqldatabase/explore-sql-database.png)

## <a name="update-app-with-code-first-migrations"></a>Изменение приложения с помощью Code First Migrations

На этом шаге вы измените схему базы данных с помощью Code First Migrations в Entity Framework и опубликуете ее в Azure.

### <a name="update-your-data-model"></a>Обновление модели данных

Откройте файл _Models\Todo.cs_ в редакторе кода. Добавьте в класс `ToDo` следующее свойство:

```csharp
public bool Done { get; set; }
```

### <a name="run-code-first-migrations-locally"></a>Локальный запуск Code First Migrations

Теперь выполните несколько команд, чтобы обновить базу данных localdb. 

В меню **Инструменты** выберите **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**. Консоль обычно открывается в нижнем окне.

Включите Code First Migrations следующим образом:

```PowerShell
Enable-Migrations
```

Добавьте миграцию следующим образом:

```PowerShell
Add-Migration AddProperty
```

Обновите базу данных localdb следующим образом:

```PowerShell
Update-Database
```

Проверить изменения, запустив приложение с помощью команды `F5`.

Если приложение загружается без ошибок, Code First Migrations успешно включен. Однако ваша страница не изменилась, так как новое свойство все еще не используется в логике приложения. 

### <a name="use-the-new-property"></a>Использование нового свойства

Внесем некоторые изменения в код, чтобы использовалось свойство `Done`. Для простоты мы изменим только представления `Index` и `Create`, чтобы просмотреть свойство в действии.

Откройте файл _Controllers\TodosController.cs_.

Найдите метод `Create()` и добавьте `Done` в список свойств атрибута `Bind`. Когда все будет готово, сигнатура метода `Create()` должна выглядеть следующим образом:

```csharp
public ActionResult Create([Bind(Include = "id,Description,CreatedDate,Done")] Todo todo)
```

Откройте файл _Views\Todos\Create.cshtml_.

В коде Razor вы должны увидеть тег `<div class="form-group">`, который использует `model.Description`, и еще один тег `<div class="form-group">`, который использует `model.CreatedDate`. Сразу после этих тегов добавьте еще один тег `<div class="form-group">`, который использует `model.Done`:

```csharp
<div class="form-group">
    @Html.LabelFor(model => model.Done, htmlAttributes: new { @class = "control-label col-md-2" })
    <div class="col-md-10">
        <div class="checkbox">
            @Html.EditorFor(model => model.Done)
            @Html.ValidationMessageFor(model => model.Done, "", new { @class = "text-danger" })
        </div>
    </div>
</div>
```

Откройте файл _Views\Todos\Index.cshtml_.

Найдите пустой тег `<th></th>`. Добавьте следующий код Razor над этим тегом:

```csharp
<th>
    @Html.DisplayNameFor(model => model.Done)
</th>
```

Найдите тег `<td>`, который содержит вспомогательные методы `Html.ActionLink()`. Добавьте следующий код Razor над этим тегом:

```csharp
<td>
    @Html.DisplayFor(modelItem => item.Done)
</td>
```

Это все, что нужно сделать, чтобы увидеть изменения в представлениях `Index` и `Create`. 

Снова наберите `F5`, чтобы запустить приложение.

Теперь вы сможете добавить задание и установить флажок **Готово**. После этого задание должно появиться на главной странице как выполненное. Это все, что можно сделать на этом этапе, так как мы не изменили представление `Edit`.

### <a name="enable-code-first-migrations-in-azure"></a>Включение Code First Migrations в Azure

Теперь, когда изменения в коде, включая миграцию базы данных, выполнены успешно, можно опубликовать изменения в веб-приложение Azure, а также обновить базу данных SQL для использования Code First Migrations.

Как и прежде, щелкните правой кнопкой мыши свой проект и выберите **Опубликовать**.

Щелкните **Параметры**, чтобы открыть мастер публикации.

![Открытие параметров публикации](./media/app-service-web-tutorial-dotnet-sqldatabase/publish-settings.png)

В мастере нажмите кнопку **Далее**.

Убедитесь, что строка подключения для базы данных SQL в контексте **MyDatabaseContext (MyDbConnection)** заполнена. Возможно, вам потребуется выбрать базу данных **myToDoAppDb** из раскрывающегося списка. 

Установите флажок **Выполнять Code First Migrations (при запуске приложения)** и нажмите кнопку **Сохранить**.

![Включение Code First Migrations в веб-приложении Azure](./media/app-service-web-tutorial-dotnet-sqldatabase/enable-migrations.png)

### <a name="publish-your-changes"></a>Публикация изменений

Включив Code First Migrations в веб-приложении Azure, просто опубликуйте изменения кода.

На странице публикации щелкните **Опубликовать**.

Попробуйте добавить новые задачи, устанавливая флажок **Готово**. Эти задачи должны появляться на главной странице как выполненные.

![Веб-приложение Azure после включения Code First Migrations](./media/app-service-web-tutorial-dotnet-sqldatabase/this-one-is-done.png)

> [!NOTE]
> Обратите внимание, что все существующие задачи по-прежнему отображаются. При повторной публикации приложения ASP.NET существующие данные в базе данных SQL не теряются. Кроме того, Code First Migrations изменяет только схему данных, оставляя существующие данные нетронутыми.
>
>

## <a name="stream-application-logs"></a>Потоковая передача журналов приложений

Сообщения трассировки можно передавать прямо из веб-приложения Azure в Visual Studio.

Откройте файл _Controllers\TodosController.cs_.

Обратите внимание, что каждое действие начинается с метода `Trace.WriteLine()`. Этот код добавлен, чтобы показать, как легко добавить сообщения трассировки в веб-приложение Azure.

### <a name="open-server-explorer"></a>Откройте обозреватель сервера

Ведение журнала для веб-приложения Azure можно включить в **обозревателе сервера**. 

Чтобы его открыть, наберите `Ctrl`+`Alt`+`S`.

### <a name="enable-log-streaming"></a>Включение потоковой передачи журналов

В **обозревателе сервера** выберите **Azure** > **Служба приложений**.

Разверните группу ресурсов **myResourceGroup**, которая была создана при создании веб-приложения.

Щелкните веб-приложение правой кнопкой мыши и выберите **Просмотреть журналы потоковой передачи**.

![Включение потоковой передачи журналов](./media/app-service-web-tutorial-dotnet-sqldatabase/stream-logs.png)

Теперь журналы передаются в окно **Выходные данные**. 

![Потоковая передача журналов в окне "Выходные данные"](./media/app-service-web-tutorial-dotnet-sqldatabase/log-streaming-pane.png)

Однако сообщения трассировки пока не отображаются. Это объясняется тем, что когда вы в первый раз выбираете пункт меню **Просмотр журналов потоковой передачи**, веб-приложение устанавливает уровень трассировки в `Error`, при котором в журнал записываются только события ошибок (с помощью метода `Trace.TraceError()`).

### <a name="change-trace-levels"></a>Изменение уровней трассировки

Чтобы изменить уровень трассировки для вывода других сообщений трассировки, вернитесь в **обозреватель сервера**.

Снова щелкните веб-приложение правой кнопкой мыши и выберите **Параметры**.

В раскрывающемся списке **Ведение журнала приложения (файловая система)** выберите **Подробно**. Щелкните **Сохранить**.

![Измените уровень трассировки на "Подробно"](./media/app-service-web-tutorial-dotnet-sqldatabase/trace-level-verbose.png)

> [!TIP]
> Вы можете поэкспериментировать с различными уровнями трассировки, чтобы посмотреть, какие типы сообщений отображаются для каждого уровня. Например, уровень **Информация** включает все журналы, созданные `Trace.TraceInformation()`, `Trace.TraceWarning()`, и `Trace.TraceError()`, но не включает журналы, созданные `Trace.WriteLine()`.
>
>

В браузере попробуйте щелкнуть мышью рядом со списком задач в Azure. Теперь сообщения трассировки передаются в окно **Выходные данные** в Visual Studio.

```
Application: 2017-04-06T23:30:41  PID[8132] Verbose     GET /Todos/Index
Application: 2017-04-06T23:30:43  PID[8132] Verbose     GET /Todos/Create
Application: 2017-04-06T23:30:53  PID[8132] Verbose     POST /Todos/Create
Application: 2017-04-06T23:30:54  PID[8132] Verbose     GET /Todos/Index
```

### <a name="stop-log-streaming"></a>Выключение потоковой передачи журналов

Чтобы остановить службу потоковой передачи журналов, нажмите кнопку **Остановить наблюдение** в окне **Выходные данные**.

![Выключение потоковой передачи журналов](./media/app-service-web-tutorial-dotnet-sqldatabase/stop-streaming.png)

## <a name="manage-your-azure-web-app"></a>Управление веб-приложением Azure

Перейти на портал Azure, чтобы увидеть созданное веб-приложение. 

Для этого войдите на портал [https://portal.azure.com](https://portal.azure.com).

В меню слева выберите **Служба приложений**, а затем щелкните имя своего веб-приложения Azure.

![Переход к веб-приложению Azure на портале](./media/app-service-web-tutorial-dotnet-sqldatabase/access-portal.png)

Вы попадете в _колонку_ веб-приложения (страница портала, открывшаяся горизонтально). 

По умолчанию колонка веб-приложения отображает страницу **обзора**. Здесь вы можете наблюдать за работой приложения. Вы также можете выполнять базовые задачи управления: обзор, завершение, запуск, перезагрузку и удаление. На вкладках в левой части колонки отображаются различные страницы конфигурации, которые можно открыть. 

![Колонка службы приложений на портале Azure](./media/app-service-web-tutorial-dotnet-sqldatabase/web-app-blade.png)

На вкладках в колонке содержится множество полезных функций, которые вы можете добавить в веб-приложение. Ниже представлены лишь некоторые из возможностей:

- сопоставление настраиваемого DNS-имени;
- привязка настраиваемого SSL-сертификата;
- настройка непрерывного развертывания;
- вертикальное и горизонтальное масштабирование;
- добавление аутентификации пользователей.

## <a name="clean-up-resources"></a>Очистка ресурсов
 
Если эти ресурсы не требуются для изучения другого руководства (см. раздел [Дальнейшие действия](#next)), их можно удалить, выполнив следующие команды: 
  
```azurecli 
az group delete --name myResourceGroup 
``` 

<a name="next"></a>

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание базы данных SQL в Azure.
> * Подключение приложения ASP.NET к базе данных SQL.
> * Развертывание приложения в Azure
> * Обновление модели данных и повторное развертывание приложения.
> * Потоковая передача журналов из Azure в окно терминала.
> * Управление приложением на портале Azure.

Перейдите к следующему руководству, чтобы научиться сопоставлять пользовательские DNS-имена.

> [!div class="nextstepaction"]
> [Сопоставление существующего настраиваемого DNS-имени с веб-приложениями Azure](app-service-web-tutorial-custom-domain.md)

