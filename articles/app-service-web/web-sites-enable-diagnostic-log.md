<properties
	pageTitle="Включение ведения журнала диагностики для веб-приложений в службе приложений Azure"
	description="Узнайте, как включить ведение журналов диагностики и добавить инструментирование в приложение, а также, как получить доступ к данным журналов Azure."
	services="app-service"
	documentationCenter=".net"
	authors="cephalin"
	manager="wpickett"
	editor="jimbe"/>

<tags
	ms.service="app-service"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/06/2016"
	ms.author="cephalin"/>

# Включение ведения журнала диагностики для веб-приложений в службе приложений Azure

## Обзор

В Azure доступны встроенные средства диагностики для отладки [веб-приложений службы приложений](http://go.microsoft.com/fwlink/?LinkId=529714). В этой статье вы узнаете, как включить ведение журналов диагностики и добавить инструментирование в свое приложение, а также как получить доступ к данным журналов Azure.

В этой статье рассматривается использование [портала Azure](https://portal.azure.com), Azure PowerShell и интерфейса командной строки Azure (Azure CLI) для работы с журналами диагностики. Дополнительные сведения о работе с журналами диагностики с использованием Visual Studio см. в статье [Устранение неполадок Azure в Visual Studio](web-sites-dotnet-troubleshoot-visual-studio.md).

[AZURE.INCLUDE [app-service-web-to-api-and-mobile](../../includes/app-service-web-to-api-and-mobile.md)]

## <a name="whatisdiag"></a>Диагностика веб-сервера и приложений

Веб-приложения службы приложений включают функции диагностики для записи в журнал информации как с веб-сервера, так и из веб-приложения. Используется следующее логическое разделение: **диагностика веб-сервера** и **диагностика приложений**.

### Диагностика веб-сервера

Вы можете включить или отключить такие виды журналов:

- **Подробное ведение журнала ошибок** — регистрация подробной информации об ошибке для кодов состояния HTTP, которые указывают на сбой (код состояния 400 и выше). Здесь могут содержаться сведения, которые помогут определить причину, по которой сервер вернул код ошибки.
- **Трассировка неудачно завершенных запросов** — регистрация подробной информации о неудачных запросах, включая трассировку компонентов IIS для обработки запроса и время каждого компонента. Это может быть полезно, если вы пытаетесь повысить производительность веб-сайта или определить причину ошибки HTTP.
- **Журналы веб-сервера** — регистрация сведений о HTTP-транзакциях в [расширенном формате файла журнала W3C](http://msdn.microsoft.com/library/windows/desktop/aa814385.aspx). Это удобно при определении общих показателей сайта, например количества обработанных запросов или количества запросов, поступивших с определенного IP-адреса.

### Диагностика приложения

Диагностика приложений позволяет записывать сведения, созданные веб-приложениями. Приложения ASP.NET могут использовать класс [System.Diagnostics.Trace](http://msdn.microsoft.com/library/36hhw2t6.aspx) для записи информации в журнал диагностики приложений. Например:

	System.Diagnostics.Trace.TraceError("If you're seeing this, something bad happened");

Во время выполнения эти журналы доступны для устранения неполадок. Дополнительную информацию см. в разделе [Устранение неполадок веб-приложений Azure в Visual Studio](web-sites-dotnet-troubleshoot-visual-studio.md).

Веб-приложения службы приложений также записывают в журнал сведения о развертывании при публикации содержимого в веб-приложение. Это происходит автоматически, а параметры конфигурации для ведения журнала развертывания отсутствуют. Ведение журнала развертывания позволяет определить причину сбоя развертывания. Например, если применяется пользовательский скрипт развертывания, можно использовать ведение журнала развертывания, чтобы определить, почему не удается выполнить скрипт.

## <a name="enablediag"></a>Практическое руководство. Включение диагностики

Чтобы включить диагностику на [портале Azure](https://portal.azure.com), в колонке своего веб-приложения выберите **Параметры > Журналы диагностики**.

<!-- todo:cleanup dogfood addresses in screenshot -->
![Часть журналов](./media/web-sites-enable-diagnostic-log/logspart.png)

Включив **диагностику приложений**, также можно выбрать **уровень**. Этот параметр позволяет отфильтровывать из собранных данных **информационные сообщения**, **предупреждения** и **сведения об ошибках**. Можно выбрать вариант **подробно**, чтобы записать в журнал все сведения, созданные приложением.

> [AZURE.NOTE] В отличие от изменения файла web.config, включение диагностики приложений или изменение уровней журнала диагностики не приводит к перезапуску домена, в котором запущено данное приложение.

На [классическом портале](https://manage.windowsazure.com) на вкладке **Настройка** веб-приложения можно выбрать **хранилище** или **файловую систему** для **ведения журнала веб-сервера**. Выбор **хранилища** позволяет выбрать учетную запись хранилища, а затем blob-контейнер, в который будут записываться журналы. Все другие журналы **диагностики сайтов** записываются только в файловую систему.

На [классическом портале](https://manage.windowsazure.com) на вкладке **Настройка** веб-приложения также доступны дополнительные параметры диагностики приложений.

* **Файловая система** хранит сведения диагностики приложения в файловой системе веб-приложения. Доступ к этим файлам можно получить с помощью FTP, а также скачать их в виде архива с использованием Azure PowerShell или интерфейса командной строки Azure (Azure CLI).
* **Хранилище таблиц** — хранит сведения диагностики приложений для указанной учетной записи хранилища Azure, а также имя таблицы.
* **Хранилище Blob-объектов** — хранит сведения диагностики приложений для указанной учетной записи хранилища Azure, а также контейнер BLOB-объектов.
* **Срок хранения** — по умолчанию журналы из **хранилища blob-объектов** не удаляются автоматически. Выберите **задать хранение** и введите число дней хранения журналов, если вы хотите автоматически удалить журналы.

>[AZURE.NOTE] Если вы [создаете повторно ключи доступа учетной записи хранения](storage-create-storage-account.md#view-copy-and-regenerate-storage-access-keys), то необходимо сбросить соответствующую конфигурацию ведения журнала, чтобы использовать обновленные ключи. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выкл.** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта или таблицы учетной записи хранения. Сохраните вашу настройку.

Можно одновременно активировать варианты "Файловая система", "Табличное хранилище" или "Хранилище BLOB-объектов" в любом сочетании, а также настроить индивидуальные конфигурации уровня ведения журнала. Например, запись в хранилище ошибок и предупреждений в хранилище blob-объектов может потребоваться в качестве решения для длительного подробного ведения журнала.

Хотя во всех трех местах хранения содержится одна и та же базовая информация о событиях, вносимых в журнал, в журнале **табличного хранилища** и **хранилища BLOB-объектов** также содержатся дополнительные сведения, например идентификатор экземпляра, идентификатор потока и более подробная отметка времени (формат отсчетов) в сравнении с журналом **файловой системы**.

> [AZURE.NOTE] Доступ к сведениям, хранящимся в **табличных хранилищах** или в **хранилищах blob-объектов**, можно получить только с помощью клиента хранения или приложения, которое может напрямую работать с этими системами хранения данных. Например, в Visual Studio 2013 содержится проводник хранилищ, который может использоваться для просмотра таблицы или blob-хранилища, а HDInsight может получать доступ к данным, хранящимся в хранилище blob-объектов. Можно также написать приложение, которое обращается к хранилищу Azure, используя один из [пакетов SDK для Azure](/downloads/#).

> [AZURE.NOTE] Вы также можете включить диагностику из PowerShell Azure с помощью командлета **Set-AzureWebsite**. Если оболочка Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Как использовать Azure PowerShell](/develop/nodejs/how-to-guides/powershell-cmdlets/).

##<a name="download"></a> Практическое руководство. Загрузка журналов

Доступ к диагностическим сведениям, хранящимся в файловой системе веб-приложения, можно получить непосредственно через FTP. Их также можно скачать в виде ZIP-архива с помощью Azure PowerShell или интерфейса командной строки Azure.

Структура каталогов, в которых хранятся журналы, выглядит следующим образом:

* **Журналы приложений** — /LogFiles/Application/. Эта папка содержит один или несколько текстовых файлов со сведениями, созданными при ведении журнала приложения.

* **Трассировка невыполненных запросов** — /LogFiles/W3SVC#########/. Эта папка содержит XSL-файл и один или несколько XML-файлов. Убедитесь, что XSL-файл загружен в тот же каталог, что и XML-файлы, так как XSL-файл обеспечивает функциональные возможности форматирования и фильтрации содержимого XML-файлов при просмотре в браузере Internet Explorer.

* **Подробные журналы ошибок** — /LogFiles/DetailedErrors/. Эта папка содержит один или несколько HTM-файлов с подробными сведениями обо всех произошедших ошибках HTTP.

* **Журналы веб-сервера** — /LogFiles/http/RawLogs. Эта папка содержит один или несколько текстовых файлов, отформатированных с применением [расширенного формата журнала W3C](http://msdn.microsoft.com/library/windows/desktop/aa814385.aspx).

* **Журналы развертывания** — /LogFiles/Git. В этой папке содержатся журналы, созданные внутренними процессами развертывания, используемыми в веб-приложениях Azure, а также журналы развертываний с применением Git.

### FTP

Чтобы получить доступ к диагностическим сведениям через FTP, откройте **панель мониторинга** своего веб-приложения на [классическом портале](https://manage.windowsazure.com). В разделе **Сводка** используйте ссылку **Журналы диагностики FTP** для доступа к файлам журнала через FTP. Пункт **Развертывание/FTP-пользователь** содержит имя пользователя, указываемое для доступа к сайту FTP.

> [AZURE.NOTE] Если пункт **Развертывание/FTP-пользователь** не задан или вы забыли пароль для этого пользователя, можно создать нового пользователя и новый пароль с помощью ссылки **Сбросить учетные данные развертывания** в разделе **Сводка** **панели мониторинга**.

### Загрузка с использованием Azure PowerShell

Для загрузки файлов журналов запустите новый экземпляр Azure PowerShell и используйте следующую команду:

	Save-AzureWebSiteLog -Name webappname

Команда сохранит файлы журналов для веб-приложения, заданного параметром **-Name**, в файл **logs.zip** в текущем каталоге.

> [AZURE.NOTE] Если оболочка Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Как использовать Azure PowerShell](/develop/nodejs/how-to-guides/powershell-cmdlets/).

### Скачивание с использованием интерфейса командной строки Azure

Чтобы скачать файлы журналов с использованием интерфейса командной строки Azure, откройте командную строку, PowerShell, Bash или сеанс терминала и введите следующую команду:

	azure site log download webappname

Команда сохранит журналы веб-приложения с именем "имя\_веб-приложения" в файл **diagnostics.zip** в текущем каталоге.

> [AZURE.NOTE] Если интерфейс командной строки Azure (Azure CLI) не установлен или не настроен для использования подписки Azure, см. раздел [Использование интерфейса командной строки Azure](../xplat-cli-install.md).

## Практическое руководство. Просмотр журналов в Application Insights

Visual Studio Application Insights предоставляет средства для фильтрации и поиска журналов, а также для связывания журналов с запросами и другими событиями.

1. Добавление SDK Application Insights в проект в Visual Studio.
 * В обозревателе решений щелкните проект правой кнопкой мыши и выберите пункт "Добавить Application Insights". Откроется мастер, состоящий из нескольких шагов, в том числе шаг создания ресурса Application Insights. [Подробнее](../application-insights/app-insights-start-monitoring-app-health-usage.md)
2. Добавление прослушивателя трассировки пакета в проект.
 * Щелкните правой кнопкой мыши проект и выберите "Управление пакетами NuGet". Выберите `Microsoft.ApplicationInsights.TraceListener` [Подробнее](../application-insights/app-insights-asp-net-trace-logs.md).
3. Загрузите проект и запустите его для создания данных журнала.
4. На [портале Azure](https://portal.azure.com/) перейдите к новому ресурсу Application Insights и откройте **Поиск**. Вы увидите данные журнала, а также запросы, сведения об использовании и другую телеметрию. Получение некоторых данных телеметрии может занять несколько минут: щелкните "Обновить". [Подробнее](../application-insights/app-insights-diagnostic-search.md)

[Дополнительные сведения об отслеживании производительности с помощью Application Insights](../azure-portal/insights-perf-analytics.md)

##<a name="streamlogs"></a> Практическое руководство. Потоковая передача журналов

При разработке приложения удобно видеть сведения о ведении журнала практически в режиме реального времени. Этого можно добиться, используя потоковую передачу информации о ведении журнала в среду разработки с помощью Azure PowerShell или интерфейса командной строки Azure.

> [AZURE.NOTE] Некоторые типы буфера журнала записывают данные в файл журнала, что может привести к нарушению порядка событий в потоке. Например, запись в журнале приложений, возникающая при посещении пользователем страницы, может отображаться в потоке перед соответствующей записью журнала HTTP о запросе страницы.

> [AZURE.NOTE] При потоковой передаче журнала будут также передаваться данные, записанные в любой текстовый файл, хранящийся в каталоге **D:\\home\\LogFiles\**.

### Потоковая передача с использованием Azure PowerShell

Для потоковой передачи информации журналов запустите новый экземпляр Azure PowerShell и используйте следующую команду:

	Get-AzureWebSiteLog -Name webappname -Tail

Будет выполнено подключение к веб-приложению, заданному параметром **-Name**, и по мере возникновения в веб-приложении регистрируемых событий будет начата потоковая передача информации в окно PowerShell. Вся информация, записываемая в файлы с расширением .txt, .log или .htm, которые сохраняются в каталоге /LogFiles (d:/home/logfiles), передается посредством потоковой передачи на локальную консоль.

Чтобы отфильтровать определенные события, например ошибки, используйте параметр **-Message**. Например:

	Get-AzureWebSiteLog -Name webappname -Tail -Message Error

Чтобы отфильтровать определенные типы журналов, например HTTP, используйте параметр **-Path**. Например:

	Get-AzureWebSiteLog -Name webappname -Tail -Path http

Чтобы просмотреть список доступных путей, используйте параметр -ListPath.

> [AZURE.NOTE] Если оболочка Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Как использовать Azure PowerShell](/develop/nodejs/how-to-guides/powershell-cmdlets/).

### Потоковая передача с использованием интерфейса командной строки Azure

Чтобы передать информацию журналов, откройте новое окно командной строки, PowerShell, Bash или сеанс терминала и введите следующую команду:

	azure site log tail webappname

Установится подключение к веб-приложению с именем "имя\_веб-приложения", и по мере возникновения в веб-приложении регистрируемых событий будет начата потоковая передача информации в окно PowerShell. Вся информация, записываемая в файлы с расширением .txt, .log или .htm, которые сохраняются в каталоге /LogFiles (d:/home/logfiles), передается посредством потоковой передачи на локальную консоль.

Чтобы отфильтровать определенные события, например ошибки, используйте параметр **--Filter**. Например:

	azure site log tail webappname --filter Error

Чтобы отфильтровать определенные типы журналов, например HTTP, используйте параметр **--Path**. Например:

	azure site log tail webappname --path http

> [AZURE.NOTE] Если интерфейс командной строки Azure не установлен или не настроен для использования подписки Azure, см. раздел [Использование интерфейса командной строки Azure](../xplat-cli-install.md).

##<a name="understandlogs"></a> Практическое руководство. Интерпретация журналов диагностики

### Журналы диагностики приложений

Диагностика приложений хранит данные в определенном формате для приложений .NET в зависимости от того, сохраняются ли журналы в файловую систему, табличные хранилища или хранилища BLOB-данных. Базовый набор данных является одинаковым для всех трех типов хранения — дата и время, когда произошло событие, идентификатор процесса, который создал событие, тип события (информация, предупреждение, ошибка) и сообщение о событии.

__Файловая система__

Каждая строка, протоколируемая в файловой системе или полученная с помощью потоковой передачи, будет иметь следующий формат:

	{Date}  PID[{process id}] {event type/level} {message}

Например, сообщение об ошибке будет выглядеть следующим образом:

	2014-01-30T16:36:59  PID[3096] Error       Fatal error on the page!

Ведение журнала в файловой системе позволяет получить базовые сведения из трех доступных методов; предоставляется только время, идентификатор процесса, уровень события и сообщение.

__Хранилище таблиц__

Ведение журнала в хранилище таблиц позволяет использовать дополнительные свойства для облегчения поиска данных, хранящихся в таблице, а также более подробные сведения о событии. Для каждого элемента (строки) в таблице используются следующие свойства (столбцы).

Имя свойства|Значение/формат
---|---
PartitionKey|Дата и время события в формате yyyyMMddHH
RowKey|Значение GUID, которое уникальным образом идентифицирует этот объект
Timestamp|Дата и время возникновения события
EventTickCount|Дата и время, когда произошло событие, в формате отсчетов (более высокая точность)
ApplicationName|Имя веб-приложения
Уровень|Уровень события (например, ошибка, предупреждение, информация)
EventId|Идентификатор события<p><p>По умолчанию равен 0 (если не указан)
InstanceId|Экземпляр веб-приложения, в котором произошло событие
Pid|ИД процесса
Tid|Идентификатор потока, который вызвал это событие
Сообщение|Сообщение с подробными сведениями о событии

__Хранилище BLOB-объектов__

Если журнал ведется в хранилище blob-объектов, данные хранятся в формате с разделителями-запятыми (CSV). По аналогии с хранилищем таблиц, здесь фиксируются дополнительные с более подробными сведениями о событии. Для каждой строки CSV-файла используются следующие свойства:

Имя свойства|Значение/формат
---|---
Дата|Дата и время возникновения события
Уровень|Уровень события (например, ошибка, предупреждение, информация)
ApplicationName|Имя веб-приложения
InstanceId|Экземпляр веб-приложения, в котором произошло событие
EventTickCount|Дата и время, когда произошло событие, в формате отсчетов (более высокая точность)
EventId|Идентификатор события<p><p>По умолчанию равен 0 (если не указан)
Pid|ИД процесса
Tid|Идентификатор потока, который вызвал это событие
Сообщение|Сообщение с подробными сведениями о событии

Данные, хранящиеся в хранилище больших двоичных объектов, будут похожи на эти:

	date,level,applicationName,instanceId,eventTickCount,eventId,pid,tid,message
	2014-01-30T16:36:52,Error,mywebapp,6ee38a,635266966128818593,0,3096,9,An error occurred

> [AZURE.NOTE] В первой строке журнала содержатся заголовки столбцов, представленных в данном примере.

### Трассировка невыполненных запросов

Трассировка невыполненных запросов хранится в XML-файлах с именами __fr######.xml__. Чтобы облегчить просмотр данных журнала, используется таблица стилей XSL с именем __freb.xsl__, расположенная в том же каталоге, что и XML-файлы. При открытии одного из XML-файлов в Internet Explorer будет использоваться таблица стилей XSL для форматированного отображения информации о трассировке. Экран будет выглядеть следующим образом:

![вид трассировки неудачно завершенных запросов в браузере](./media/web-sites-enable-diagnostic-log/tws-failedrequestinbrowser.png)

### Подробные журналы ошибок

Подробные журналы ошибок представляют собой документы HTML, в которых содержатся более подробные сведения о возникших ошибках HTTP. Поскольку они являются простыми HTML-документами, их можно просматривать с помощью веб-браузера.

### Журналы веб-сервера

Журналы веб-сервера форматируются с помощью [расширенного формата журнала W3C](http://msdn.microsoft.com/library/windows/desktop/aa814385.aspx). Эти данные могут быть прочитаны с помощью текстового редактора, либо можно провести их синтаксический анализ с помощью служебных программ, таких как [Log Parser](http://go.microsoft.com/fwlink/?LinkId=246619)

> [AZURE.NOTE] Журналы, созданные веб-приложениями Azure, не поддерживают поля __s-computername__, __s-ip__ и __cs-version__.

##<a name="nextsteps"></a>Дальнейшие действия

- [Мониторинг веб-приложений](/manage/services/web-sites/how-to-monitor-websites/)
- [Устранение неполадок веб-приложений Azure в Visual Studio](web-sites-dotnet-troubleshoot-visual-studio.md)
- [Анализ журналов веб-приложения в HDInsight](http://gallery.technet.microsoft.com/scriptcenter/Analyses-Windows-Azure-web-0b27d413)

> [AZURE.NOTE] Чтобы приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), где вы можете быстро создать кратковременное веб-приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.

## Изменения
* Указания по изменениям при переходе от веб-сайтов к службе приложений см. в разделе [Служба приложений Azure и ее влияние на существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).
* Информацию о смене старого портала на новый см. в [справочнике по навигации на портале Azure](http://go.microsoft.com/fwlink/?LinkId=529715).
 

<!---HONumber=AcomDC_0211_2016-->