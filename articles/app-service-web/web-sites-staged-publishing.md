---
title: "Настройка промежуточных сред для веб-приложений в службе приложений Azure"
description: "Узнайте, как использовать промежуточную публикацию для веб-приложений в службе приложений Azure."
services: app-service
documentationcenter: 
author: cephalin
writer: cephalin
manager: wpickett
editor: mollybos
ms.assetid: e224fc4f-800d-469a-8d6a-72bcde612450
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/09/2016
ms.author: cephalin
translationtype: Human Translation
ms.sourcegitcommit: 219dcbfdca145bedb570eb9ef747ee00cc0342eb
ms.openlocfilehash: f65791e42ce7c8602b01837f2ea262477f5ab3b1


---
# <a name="set-up-staging-environments-for-web-apps-in-azure-app-service"></a>Настройка промежуточных сред для веб-приложений в службе приложений Azure
<a name="Overview"></a>

Режимы планов службы приложений **Стандартный** и **Премиум** позволяют развертывать веб-приложения в [службе приложений](http://go.microsoft.com/fwlink/?LinkId=529714) в отдельный слот развертывания вместо рабочего слота по умолчанию. Слоты развертывания фактически являются динамическими веб-приложениями со своими собственными именами узлов. Содержимое веб-приложений и элементы конфигурации можно перемещать между двумя слотами (включая производственный). Развертывание приложения в области развертывания дает следующие преимущества:

* В промежуточном слоте развертывания можно проверить изменения в веб-приложении до того, как они будут отправлены в рабочий слот.
* Развертывание веб-приложения в промежуточном слоте и последующее перемещение в производственный позволяет подготовить все экземпляры слота до того, как они будут перемещены в производственную среду. Это сокращает время простоя при развертывании веб-приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются в результате операций подкачки. Весь этот рабочий процесс можно автоматизировать, настроив функцию [автоматического переноса](#configure-auto-swap-for-your-web-app) , когда проверка перед переносом не требуется.
* После переноса в слоте промежуточного развертывания окажется предыдущее производственное веб-приложение. Если изменения в производственной области не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к своему "последнему удачному сайту".

Каждый режим плана службы приложений поддерживает разное количество слотов развертывания. Чтобы узнать, сколько слотов поддерживает ваш режим веб-приложения, прочитайте статью [Цены на службу приложений](/pricing/details/app-service/).

* Если веб-приложение имеет несколько слотов, режим изменить нельзя.
* Масштабирование для веб-сайтов, не находящихся в производственной области, недоступно.
* Для непроизводственных областей управление связанными ресурсами недоступно. Только на [портале Azure](http://go.microsoft.com/fwlink/?LinkId=529715) можно избежать этого потенциального воздействия на рабочий слот, временно переместив слот, не являющийся рабочим, в другой режим плана службы приложений. Обратите внимание, что для непроизводственного слота необходимо повторно выбрать режим производственного слота. Только после этого содержимое этих двух слотов можно будет менять местами.

[!INCLUDE [app-service-web-to-api-and-mobile](../../includes/app-service-web-to-api-and-mobile.md)]

<a name="Add"></a>

## <a name="add-a-deployment-slot-to-a-web-app"></a>Добавление слота развертывания в веб-приложение
Чтобы включить несколько слотов развертывания, веб-приложение должно работать в режиме **Стандартный** или **Премиум**.

1. Откройте колонку вашего веб-приложения на [портале Azure](https://portal.azure.com/).
2. Щелкните **Параметры**, а затем щелкните **Слоты развертывания**. В колонке **Слоты развертывания** щелкните **Добавить слот**.
   
    ![Добавить новый слот развернутого приложения][QGAddNewDeploymentSlot]
   
   > [!NOTE]
   > Если веб-приложение не работает в режиме **Стандартный** или **Премиум**, появится сообщение со списком поддерживаемых режимов, позволяющих включить промежуточную публикацию. На этом этапе у вас появится возможность выбрать команду **Обновить** и перейти на вкладку **Масштаб** веб-приложения, прежде чем продолжить.
   > 
   > 
3. В колонке **Добавить слот** присвойте слоту имя и укажите, следует ли клонировать конфигурацию веб-приложения из другого существующего слота развертывания. Установите флажок для продолжения.
   
    ![Источник конфигурации][ConfigurationSource1]
   
    При первом добавлении слота у вас будет только два варианта: клонировать конфигурацию производственного слота по умолчанию или не делать этого.
   
    После создания нескольких областей у вас уже будет выбор для копирования конфигураций помимо производственной области:
   
    ![Источники конфигураций][MultipleConfigurationSources]
4. В колонке **Слоты развертывания** щелкните слот развертывания, чтобы открыть колонку для этого слота с набором метрик и настройкой, как у любого другого веб-приложения. **имя_вашего_веб приложения-имя_слота_развертывания** будет отображаться в верхней части колонки, напоминая о том, что отображается слот развертывания.
   
    ![Название области развертывания][StagingTitle]
5. Щелкните URL-адрес приложения в колонке слота. Обратите внимание, что слот развертывания имеет собственное имя узла и также является динамическим приложением. Сведения о том, как запретить общий доступ к слоту развертывания, см. в статье [Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/).

В созданном слоте развертывания изначально нет содержимого. Вы можете выполнить развертывание в область из другой ветви репозитория или вообще из другого репозитория. Вы также можете изменить конфигурацию области. Для обновлений содержимого используйте профиль публикации или учетные данные развертывания, связанные с областью развертывания.  Например, вы можете выполнить [публикацию в эту область с помощью Git](app-service-deploy-local-git.md).

<a name="AboutConfiguration"></a>

## <a name="configuration-for-deployment-slots"></a>Конфигурация слотов развертывания
При клонировании конфигурации из другой области развертывания вы можете изменять клонированную конфигурацию. Кроме того, некоторые элементы конфигурации будут перенесены вместе с содержимым в другой слот (элементы, которые не определяются слотом), тогда как другие элементы останутся на месте (определяемые слотом элементы). Ниже приведена конфигурация, которая изменится при переключении сайтов.

**Переносимые параметры**:

* Общие параметры, например версия платформы, 32/64-разрядная версия, веб-сокеты
* Параметры приложения (их также можно привязать к слоту)
* Строки подключения (их также можно привязать к слоту)
* Сопоставления обработчиков
* Настройки диагностики и мониторинга
* Содержимое веб-заданий

**Непереносимые параметры**:

* Конечные точки публикации
* Имена пользовательских доменов
* SSL-сертификаты и SSL-привязки
* Параметры масштабирования
* Планировщики веб-заданий

Чтобы привязать параметры приложения или строку подключения к слоту (запретить их перенос в другой слот), откройте для нужного слота колонку **Параметры приложения** и установите флажок **Параметр слота** для всех элементов конфигурации, которые не нужно переносить в другой слот. Обратите внимание, что установка этого флажка для определенного элемента конфигурации приводит к тому, что перенос такого элемента становится невозможным во всех слотах развертывания, связанных с веб-приложением.

![Параметры слота][SlotSettings]

<a name="Swap"></a>

## <a name="to-swap-deployment-slots"></a>Переключение областей развертывания
> [!IMPORTANT]
> Перед переносом веб-приложения из слота развертывания в производственный слот убедитесь, что все параметры, которые не определяются слотом, настроены так, как нужно для производственного слота.
> 
> 

1. Чтобы перенести содержимое из одного слота развертывания в другой, нажмите кнопку **Перенести** на панели команд веб-приложения или на панели команд слота развертывания. Убедитесь, что исходный и целевой слоты указаны правильно. Как правило, целевым слотом выступает производственный слот.  
   
    ![Кнопка "Переключить"][SwapButtonBar]
2. Нажмите кнопку **ОК** , чтобы завершить операцию. После завершения операции содержимое слотов развертывания поменяется местами.

## <a name="configure-auto-swap-for-your-web-app"></a>Настройка автоматического переноса для веб-приложения
Функция автоматического переноса упрощает сценарии DevOps, в рамках которых требуется непрерывно разворачивать веб-приложение с нулевым временем холодного запуска и нулевым временем простоя для конечных пользователей веб-приложения. Если для слота развертывания настроен автоматический перенос в производственную среду, при каждом обновлении кода в этом слоте служба приложений автоматически будет переносить веб-приложение в производственную среду после его подготовки в слоте.

> [!IMPORTANT]
> Прежде чем включить автоматический перенос, убедитесь, что конфигурация слота точно соответствует конфигурации целевого слота (обычно производственного).
> 
> 

Настроить автоматический перенос для слота очень просто. Для этого сделайте вот что.

1. В колонке **Слоты развертывания** выберите слот, не являющийся рабочим, и в его колонке щелкните **Все параметры**.  
   
    ![][Autoswap1]
2. Щелкните **Параметры приложения**. Установите переключатель **Автоматическое переключение** в положение **Включено**, выберите из списка **Слот автоматического переключения** целевой слот и на панели команд щелкните **Сохранить**. Убедитесь, что конфигурация слота точно соответствует конфигурации, которую должен иметь целевой слот.
   
    После завершения операции на вкладке **Уведомления** появится зеленая надпись **Выполнено**.
   
    ![][Autoswap2]
   
   > [!NOTE]
   > Чтобы протестировать функцию автоматического переключения веб-приложения, из списка **Слот автоматического переключения** сначала можно выбрать целевой слот, не являющийся рабочим. Таким образом вы сможете на практике увидеть, как работает эта функция.  
   > 
   > 
3. Передайте код в этот слот развертывания. Вскоре произойдет автоматический перенос, и изменения будут отражены в URL-адресе целевого слота.

<a name="Multi-Phase"></a>

## <a name="use-multi-phase-swap-for-your-web-app"></a>Использование многофазного переключения для веб-приложения
Многофазное переключение доступно для упрощения проверки в контексте элементов конфигурации, предназначенных для определенного слота, например строк подключения. В этих случаях может быть полезно применять такие элементы конфигурации из цели переключения в источник и выполнять проверку до того, как произойдет переключение. После применения целевых элементов конфигурации к источнику вы можете либо завершить переключение, либо восстановить исходную конфигурацию источника, что также отменяет переключение. Примеры командлетов Azure PowerShell, доступных для многофазного переключения, включены в раздел командлетов Azure PowerShell для слотов развертывания.

<a name="Rollback"></a>

## <a name="to-rollback-a-production-app-after-swap"></a>Откат производственного приложения после переноса
В случае обнаружения ошибок в производственной области вы можете выполнить откат сайтов до состояния, предшествующего их переключению, выполнив мгновенное обратное переключение тех же двух областей.

<a name="Warm-up"></a>

## <a name="custom-warm-up-before-swap"></a>Пользовательский прогрев перед заменой
Некоторые приложения могут потребовать пользовательских действий прогрева перед заменой. В элементе конфигурации applicationInitialization в файле web.config можно указать пользовательские действия инициализации, которые должны быть выполнены до получения запроса. Операция замены будет ждать, пока этот пользовательский прогрев не завершится. Ниже приведен пример фрагмента файла web.config.

    <applicationInitialization>
        <add initializationPage="/" hostName="[web app hostname]" />
        <add initializationPage="/Home/About" hostname="[web app hostname]" />
    </applicationInitialization>

<a name="Delete"></a>

## <a name="to-delete-a-deployment-slot"></a>Удаление слота развертывания
В колонке слота развертывания на панели команд щелкните **Удалить** .  

![Удаление слота развертывания][DeleteStagingSiteButton]

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>

## <a name="azure-powershell-cmdlets-for-deployment-slots"></a>Командлеты Azure PowerShell для слотов развертывания
Azure PowerShell — это модуль, предоставляющий командлеты для управления Azure с помощью Windows PowerShell, включая поддержку управления слотами развертывания веб-приложения в службе приложений Azure.

* Сведения об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с использованием подписки Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](../powershell-install-configure.md).  

- - -
### <a name="create-web-app"></a>Создание веб-приложения
```
New-AzureRmWebApp -ResourceGroupName [resource group name] -Name [web app name] -Location [location] -AppServicePlan [app service plan name]
```

- - -
### <a name="create-a-deployment-slot-for-a-web-app"></a>Создание слота развертывания для веб-приложения
```
New-AzureRmWebAppSlot -ResourceGroupName [resource group name] -Name [web app name] -Slot [deployment slot name] -AppServicePlan [app service plan name]
```

- - -
### <a name="initiate-multi-phase-swap-and-apply-target-slot-configuration-to-source-slot"></a>Запуск многофазного переключения и применение конфигурации целевого слота к исходному слоту
```
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01
```

- - -
### <a name="revert-the-first-phase-of-multi-phase-swap-and-restore-source-slot-configuration"></a>Сброс первого этапа многофазного переключения и восстановление конфигурации исходного слота
```
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01
```

- - -
### <a name="swap-deployment-slots"></a>Переключение слотов развертывания
```
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01
```

- - -
### <a name="delete-deployment-slot"></a>Удаление слота развертывания
```
Remove-AzureRmResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [web app name]/[slot name] -ApiVersion 2015-07-01
```

- - -
<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>

## <a name="azure-command-line-interface-azure-cli-commands-for-deployment-slots"></a>Команды интерфейса командной строки Azure (Azure CLI) для слотов развертывания
Интерфейс командной строки Azure предоставляет набор кроссплатформенных команд для работы с Azure, включая поддержку управления слотами развертывания веб-приложений.

* Инструкции по установке и настройке интерфейса командной строки Azure, включая сведения о том, как его подключить к подписке Azure, см. в разделе [Установка и настройка интерфейса командной строки Azure](../xplat-cli-install.md).
* Чтобы получить список команд, доступных для службы приложений Azure в интерфейсе командной строки Azure, вызовите `azure site -h`.

- - -
### <a name="azure-site-list"></a>azure site list
Чтобы получить информацию о веб-приложениях в текущей подписке, вызовите **azure site list**, как показано в следующем примере.

`azure site list webappslotstest`

- - -
### <a name="azure-site-create"></a>azure site create
Чтобы создать слот развертывания, вызовите команду **azure site create** и укажите имя существующего веб-приложения и имя создаваемого слота, как показано в следующем примере.

`azure site create webappslotstest --slot staging`

Чтобы включить управление версиями для новой области, используйте параметр **--git** , как показано в следующем примере.

`azure site create --git webappslotstest --slot staging`

- - -
### <a name="azure-site-swap"></a>azure site swap
Чтобы сделать обновленный слот развертывания производственным приложением, воспользуйтесь командой **azure site swap** (запускает операцию переноса), как показано в следующем примере. Производственное приложение при этом будет постоянно доступно, и для него не потребуется холодного запуска.

`azure site swap webappslotstest`

- - -
### <a name="azure-site-delete"></a>azure site delete
Чтобы удалить область развертывания, которая больше не нужна, используйте команду **azure site delete** , как в следующем примере.

`azure site delete webappslotstest --slot staging`

- - -
> [!NOTE]
> Чтобы приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), где вы можете быстро создать кратковременное веб-приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
[Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/)

[Бесплатная пробная версия Microsoft Azure](/pricing/free-trial/)

## <a name="whats-changed"></a>Изменения
* Руководство по переходу от веб-сайтов к службе приложений см. в статье [Служба приложений Azure и существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).

<!-- IMAGES -->
[QGAddNewDeploymentSlot]:  ./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png
[AddNewDeploymentSlotDialog]: ./media/web-sites-staged-publishing/AddNewDeploymentSlotDialog.png
[ConfigurationSource1]: ./media/web-sites-staged-publishing/ConfigurationSource1.png
[MultipleConfigurationSources]: ./media/web-sites-staged-publishing/MultipleConfigurationSources.png
[SiteListWithStagedSite]: ./media/web-sites-staged-publishing/SiteListWithStagedSite.png
[StagingTitle]: ./media/web-sites-staged-publishing/StagingTitle.png
[SwapButtonBar]: ./media/web-sites-staged-publishing/SwapButtonBar.png
[SwapConfirmationDialog]:  ./media/web-sites-staged-publishing/SwapConfirmationDialog.png
[DeleteStagingSiteButton]: ./media/web-sites-staged-publishing/DeleteStagingSiteButton.png
[SwapDeploymentsDialog]: ./media/web-sites-staged-publishing/SwapDeploymentsDialog.png
[Autoswap1]: ./media/web-sites-staged-publishing/AutoSwap01.png
[Autoswap2]: ./media/web-sites-staged-publishing/AutoSwap02.png
[SlotSettings]: ./media/web-sites-staged-publishing/SlotSetting.png




<!--HONumber=Nov16_HO3-->


