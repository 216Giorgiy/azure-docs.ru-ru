<properties
	pageTitle="Настройка промежуточных сред для веб-приложений в службе приложений Azure"
	description="Узнайте, как использовать промежуточную публикацию для веб-приложений в службе приложений Azure."
	services="app-service"
	documentationCenter=""
	authors="cephalin"
	writer="cephalin"
	manager="wpickett"
	editor="mollybos"/>

<tags
	ms.service="app-service"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/21/2015"
	ms.author="cephalin"/>

# Настройка промежуточных сред для веб-приложений в службе приложений Azure
<a name="Overview"></a>

Режимы планов службы приложений **Standard** и **Premium** позволяют развертывать веб-приложения в [службе приложений](http://go.microsoft.com/fwlink/?LinkId=529714) в отдельный слот развертывания вместо производственного слота по умолчанию. Слоты развертывания фактически являются динамическими веб-приложениями со своими собственными именами узлов. Содержимое веб-приложений и элементы конфигурации можно перемещать между двумя слотами (включая производственный). Развертывание приложения в области развертывания дает следующие преимущества:

- В промежуточном слоте развертывания можно проверить изменения в веб-приложении до того, как они будут отправлены в производственный слот.

- Развертывание веб-приложения в промежуточном слоте и последующее перемещение в производственный позволяет подготовить все экземпляры слота до того, как они будут перемещены в производственную среду. Это сокращает время простоя при развертывании веб-приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются в результате операций подкачки. Весь этот рабочий процесс можно автоматизировать, настроив функцию [автоматического переноса](#configure-auto-swap-for-your-web-app), когда проверка перед переносом не требуется.

- После переноса в слоте промежуточного развертывания окажется предыдущее производственное веб-приложение. Если изменения в производственной области не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к своему "последнему удачному сайту".

Каждый режим плана службы приложений поддерживает разное количество слотов развертывания. Чтобы узнать, сколько слотов поддерживает ваш режим веб-приложения, см. статью [Сведения о ценах на службу приложений](/pricing/details/app-service/).

- Если веб-приложение имеет несколько слотов, режим изменить нельзя.

- Масштабирование для веб-сайтов, не находящихся в производственной области, недоступно.

- Для непроизводственных областей управление связанными ресурсами недоступно. Только на [портале предварительной версии Azure](http://go.microsoft.com/fwlink/?LinkId=529715) можно избежать этого потенциального воздействия на производственный слот, временно переместив непроизводственный слот в другой режим плана службы приложений. Обратите внимание, что для непроизводственного слота необходимо повторно выбрать режим производственного слота. Только после этого содержимое этих двух слотов можно будет менять местами.


[AZURE.INCLUDE [app-service-web-to-api-and-mobile](../../includes/app-service-web-to-api-and-mobile.md)]

<a name="Add"></a>
## Добавление слота развертывания в веб-приложение ##

Чтобы включить несколько слотов развертывания, веб-приложение должно работать в режиме **Standard** или **Premium**.

1. На [портале предварительной версии Azure](https://portal.azure.com/) откройте колонку своего веб-приложения.
2. Щелкните **Слоты развертывания**. Затем в колонке **Слоты развертывания** щелкните **Добавить слот**.

	![Добавить новый слот развернутого приложения][QGAddNewDeploymentSlot]

	> [AZURE.NOTE]Если веб-приложение не работает в режиме **Standard** или **Premium**, появится сообщение со списком поддерживаемых режимов, позволяющих включить промежуточную публикацию. На этом этапе у вас появится возможность выбрать команду **Обновить** и перейти в веб-приложении на вкладку **Масштаб**.

2. В колонке **Добавить слот** присвойте слоту имя и укажите, следует ли клонировать конфигурацию веб-приложения из другого существующего слота развертывания. Установите флажок для продолжения.

	![Источник конфигурации][ConfigurationSource1]

	При первом добавлении слота у вас будет только два варианта: клонировать конфигурацию производственного слота по умолчанию или не делать этого.

	После создания нескольких областей у вас уже будет выбор для копирования конфигураций помимо производственной области:

	![Источники конфигураций][MultipleConfigurationSources]

5. В колонке **Слоты развертывания** щелкните слот развертывания, чтобы открыть колонку для этого слота с набором метрик и настройкой, как у любого другого веб-приложения. **имя\_вашего\_веб приложения-имя\_слота\_развертывания** будет отображаться в верхней части колонки, напоминая о том, что отображается слот развертывания.

	![Название области развертывания][StagingTitle]

5. Щелкните URL-адрес приложения в колонке слота. Обратите внимание, что слот развертывания имеет собственное имя узла и также является динамическим приложением. Сведения о том, как запретить общий доступ к слоту развертывания, см. в статье [Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/).

В созданном слоте развертывания изначально нет содержимого. Вы можете выполнить развертывание в область из другой ветви репозитория или вообще из другого репозитория. Вы также можете изменить конфигурацию области. Для обновлений содержимого используйте профиль публикации или учетные данные развертывания, связанные с областью развертывания. Например, вы можете выполнить [публикацию в эту область с помощью Git](web-sites-publish-source-control.md).

<a name="AboutConfiguration"></a>
## Конфигурация слотов развертывания ##
При клонировании конфигурации из другой области развертывания вы можете изменять клонированную конфигурацию. Кроме того, некоторые элементы конфигурации будут перенесены вместе с содержимым в другой слот (элементы, которые не определяются слотом), тогда как другие элементы останутся на месте (определяемые слотом элементы). Ниже приведена конфигурация, которая изменится при переключении сайтов.

**Переносимые параметры**:

- Общие параметры, например версия платформы, 32/64-разрядная версия, веб-сокеты
- Параметры приложения (их также можно привязать к слоту)
- Строки подключения (их также можно привязать к слоту)
- Сопоставления обработчиков
- Настройки диагностики и мониторинга
- Содержимое веб-заданий

**Непереносимые параметры**:

- Конечные точки публикации
- Имена пользовательских доменов
- SSL-сертификаты и SSL-привязки
- Параметры масштабирования
- Планировщики веб-заданий

Чтобы привязать параметры приложения или строку подключения к слоту (запретить их перенос в другой слот), откройте для нужного слота колонку **Параметры приложения** и установите флажок **Параметр слота** для всех элементов конфигурации, которые не нужно переносить в другой слот. Обратите внимание, что установка этого флажка для определенного элемента конфигурации приводит к тому, что перенос такого элемента становится невозможным во всех слотах развертывания, связанных с веб-приложением.

![Параметры слота][SlotSettings]

<a name="Swap"></a>
## Переключение областей развертывания ##

>[AZURE.IMPORTANT]Перед переносом веб-приложения из слота развертывания в производственный слот убедитесь, что все параметры, которые не определяются слотом, настроены так, как нужно для производственного слота.

1. Чтобы перенести содержимое из одного слота развертывания в другой, нажмите кнопку **Перенести** на панели команд веб-приложения или на панели команд слота развертывания. Убедитесь, что исходный и целевой слоты указаны правильно. Как правило, целевым слотом выступает производственный слот.  

	![Кнопка "Переключить"][SwapButtonBar]

3. Нажмите кнопку **ОК**, чтобы завершить операцию. После завершения операции содержимое слотов развертывания поменяется местами.

## Настройка автоматического переноса для веб-приложения ##

Функция автоматического переноса упрощает сценарии DevOps, в рамках которых требуется непрерывно разворачивать веб-приложение с нулевым временем холодного запуска и нулевым временем простоя для конечных пользователей веб-приложения. Если для слота развертывания настроен автоматический перенос в производственную среду, при каждом обновлении кода в этом слоте служба приложений автоматически будет переносить веб-приложение в производственную среду после его подготовки в слоте.

>[AZURE.IMPORTANT]Прежде чем включить автоматический перенос, убедитесь, что конфигурация слота точно соответствует конфигурации целевого слота (обычно производственного).

Настроить автоматический перенос для слота очень просто. Для этого сделайте вот что.

1. В колонке **Слоты развертывания** выберите непроизводственный слот и в его колонке щелкните **Все параметры**.  

	![][Autoswap1]

2. Щелкните **Параметры приложения**. Установите переключатель **Автоматический перенос** в положение **Включено**, выберите в списке **Автоматический перенос в слот** целевой слот и на панели команд нажмите кнопку **Сохранить**. Убедитесь, что конфигурация слота точно соответствует конфигурации, которую должен иметь целевой слот.

	После завершения операции на вкладке **Уведомления** появится зеленая надпись **ВЫПОЛНЕНО**.

	![][Autoswap2]

	>[AZURE.NOTE]Чтобы протестировать функцию автоматического переноса веб-приложения, в списке **Автоматический перенос в слот** сначала можно выбрать непроизводственный целевой слот. Таким образом вы сможете на практике увидеть, как работает эта функция.

3. Передайте код в этот слот развертывания. Вскоре произойдет автоматический перенос, и изменения будут отражены в URL-адресе целевого слота.

<a name="Multi-Phase"></a>
## Использование многофазного переключения для веб-приложения ##

Многофазное переключение доступно для упрощения проверки в контексте элементов конфигурации, предназначенных для определенного слота, например строк подключения. В этих случаях может быть полезно применять такие элементы конфигурации из цели переключения в источник и выполнять проверку до того, как произойдет переключение. После применения целевых элементов конфигурации к источнику вы можете либо завершить переключение, либо восстановить исходную конфигурацию источника, что также отменяет переключение. Примеры командлетов Azure PowerShell, доступных для многофазного переключения, включены в раздел командлетов Azure PowerShell для слотов развертывания.

<a name="Rollback"></a>
## Откат производственного приложения после переноса ##
В случае обнаружения ошибок в производственной области вы можете выполнить откат сайтов до состояния, предшествующего их переключению, выполнив мгновенное обратное переключение тех же двух областей.

<a name="Delete"></a>
## Удаление слота развертывания##

В колонке слота развертывания на панели команд щелкните **Удалить**.

![Удаление слота развертывания][DeleteStagingSiteButton]

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>
## Командлеты Azure PowerShell для слотов развертывания

Azure PowerShell — это модуль, предоставляющий командлеты для управления Azure с помощью Windows PowerShell, включая поддержку управления слотами развертывания веб-приложения в службе приложений Azure.

- Информацию об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с подпиской Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](../install-configure-powershell.md).  

- Чтобы использовать новый режим Диспетчера ресурсов Azure для командлетов PowerShell, для начала сделайте следующее: `Switch-AzureMode -Name AzureResourceManager`.

----------

### Создание веб-приложения

`New-AzureWebApp -ResourceGroupName [resource group name] -Name [web app name] -Location [location] -AppServicePlan [app service plan name]`

----------

### Создание слота развертывания для веб-приложения

`New-AzureWebApp -ResourceGroupName [resource group name] -Name [web app name] -SlotName [deployment slot name] -Location [location] -AppServicePlan [app service plan name]`

----------

### Запуск многофазного переключения и применение конфигурации целевого слота к исходному слоту

`$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}` `Invoke-AzureResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01`

----------

### Сброс первого этапа многофазного переключения и восстановление конфигурации исходного слота

`Invoke-AzureResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01`

----------

### Переключение слотов развертывания

`$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}` `Invoke-AzureResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [web app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01`

----------

### Удаление слота развертывания

`Remove-AzureResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [web app name]/[slot name] -ApiVersion 2015-07-01`

----------

<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>
## Команды интерфейса командной строки Azure (Azure CLI) для слотов развертывания

Интерфейс командной строки Azure предоставляет набор кроссплатформенных команд для работы с Azure, включая поддержку управления слотами развертывания веб-приложений.

- Указания по установке, настройке и использованию интерфейса командной строки Azure, включая информацию о подключении интерфейса командной строки Azure к подписке Azure, см. в разделе [Установка и настройка интерфейса командной строки Azure](../xplat-cli-install.md).

-  Чтобы получить список команд, доступных для службы приложений Azure в интерфейсе командной строки Azure, вызовите `azure site -h`.

----------
### azure site list
Чтобы получить информацию о веб-приложениях в текущей подписке, вызовите **azure site list**, как показано в следующем примере.

`azure site list webappslotstest`

----------
### azure site create
Чтобы создать слот развертывания, вызовите команду **azure site create** и укажите имя существующего веб-приложения и имя создаваемого слота, как показано в следующем примере.

`azure site create webappslotstest --slot staging`

Чтобы включить управление версиями для новой области, используйте параметр **--git**, как показано в следующем примере.

`azure site create --git webappslotstest --slot staging`

----------
### azure site swap
Чтобы сделать обновленный слот развертывания производственным приложением, воспользуйтесь командой **azure site swap** (запускает операцию переноса), как показано в следующем примере. Производственное приложение при этом будет постоянно доступно, и для него не потребуется холодного запуска.

`azure site swap webappslotstest`

----------
### azure site delete
Чтобы удалить область развертывания, которая больше не нужна, используйте команду **azure site delete**, как в следующем примере.

`azure site delete webappslotstest --slot staging`

----------

>[AZURE.NOTE]Чтобы приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), где вы можете быстро создать кратковременное веб-приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.

## Дальнейшие действия ##
[Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/)

[Бесплатная пробная версия Microsoft Azure](/pricing/free-trial/)

## Изменения
* Указания по изменениям при переходе от веб-сайтов к службе приложений см. в разделе [Служба приложений Azure и ее влияние на существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).
* Руководство по смене старого портала на новый портал см. в разделе [Справочник по навигации на предварительной версии портала](http://go.microsoft.com/fwlink/?LinkId=529715).

<!-- IMAGES -->
[QGAddNewDeploymentSlot]: ./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png
[AddNewDeploymentSlotDialog]: ./media/web-sites-staged-publishing/AddNewDeploymentSlotDialog.png
[ConfigurationSource1]: ./media/web-sites-staged-publishing/ConfigurationSource1.png
[MultipleConfigurationSources]: ./media/web-sites-staged-publishing/MultipleConfigurationSources.png
[SiteListWithStagedSite]: ./media/web-sites-staged-publishing/SiteListWithStagedSite.png
[StagingTitle]: ./media/web-sites-staged-publishing/StagingTitle.png
[SwapButtonBar]: ./media/web-sites-staged-publishing/SwapButtonBar.png
[SwapConfirmationDialog]: ./media/web-sites-staged-publishing/SwapConfirmationDialog.png
[DeleteStagingSiteButton]: ./media/web-sites-staged-publishing/DeleteStagingSiteButton.png
[SwapDeploymentsDialog]: ./media/web-sites-staged-publishing/SwapDeploymentsDialog.png
[Autoswap1]: ./media/web-sites-staged-publishing/AutoSwap01.png
[Autoswap2]: ./media/web-sites-staged-publishing/AutoSwap02.png
[SlotSettings]: ./media/web-sites-staged-publishing/SlotSetting.png
 

<!---HONumber=Oct15_HO3-->