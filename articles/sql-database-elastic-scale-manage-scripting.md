<properties 
	pageTitle="Создание скриптов для эластичного масштабирования" 
	description="Создание сценариев задач эластичного масштабирования с помощью Runbook службы автоматизации Azure PowerShell." 
	services="sql-database" 
	documentationCenter="" 
	manager="stuartozer" 
	authors="Joseidz" 
	editor=""/>

<tags 
	ms.service="sql-database" 
	ms.workload="sql-database" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/03/2015" 
	ms.author="Joseidz@microsoft.com"/>

# Управление эластичным масштабированием с помощью скриптов


## Служба автоматизации Azure 

[Служба автоматизации Azure](http://azure.microsoft.com/documentation/services/automation/) дает возможность использовать на платформе Azure всю мощь рабочего процесса PowerShell, что значительно облегчает работу. Теперь вы можете автоматизировать задачи обслуживания, которые трудно реализовать обычными средствами портала Azure.  Для этого нужно лишь создать рабочий процесс PowerShell (называемый в службе автоматизации Azure **модулем runbook**), передать его в облако и запланировать, когда вы хотите, чтобы он выполнился. В этом документе подробно описывается настройка службы автоматизации Azure для нескольких примеров, демонстрирующих эластичность сегментов. Более подробную информацию см. в [предварительном описании](http://blogs.technet.com/b/in_the_cloud/archive/2014/04/15/announcing-the-microsoft-azure-automation-preview.aspx). Можно также зарегистрироваться, чтобы оформить [подписку](https://account.windowsazure.com/PreviewFeatures?fid=automation) на Azure.

В этом примере служба автоматизации Azure используется как платформа для создания расписания для рабочей нагрузки и ее выполнения. Фактически, службу автоматизации Azure можно представить как [агент SQL Server в облаке](http://azure.microsoft.com/blog/2014/06/26/azure-automation-your-sql-agent-in-the-cloud/). 

Помимо этого документа существуют и другие ресурсы:

* [Приступая к работе со службой автоматизации Azure](http://azure.microsoft.com/documentation/articles/automation-create-runbook-from-samples/)
* [Пошаговое руководство. Приступая к работе с НОВОЙ предварительной версией службы автоматизации Microsoft Azure](http://blogs.technet.com/b/keithmayer/archive/2014/04/04/step-by-step-getting-started-with-windows-azure-automation.aspx) 
* [Служба автоматизации Microsoft Azure](http://blogs.technet.com/b/cbernier/archive/2014/04/08/microsoft-azure-automation.aspx) 
* Задавайте вопросы по службе автоматизации Azure на [форуме по автоматизации](http://social.msdn.microsoft.com/Forums/windowsazure/home?forum=azureautomation&filter=alltypes&sort=lastpostdesc).  


## Предварительные требования

[Зарегистрируйтесь](http://azure.microsoft.com/services/preview/) и [ознакомьтесь](http://azure.microsoft.com/documentation/articles/automation-create-runbook-from-samples/) с предварительной версией службы автоматизации Microsoft Azure.


## Файлы PowerShell для эластичности сегментов

Следующий набор файлов PowerShell содержит основные команды для выполнения сценариев горизонтального и вертикального масштабирования с помощью службы автоматизации Azure. 

Эти примеры показывают, как использовать образцы модулей PowerShell для выполнения основных задач по эластичности сегментов. В сочетании со службой автоматизации Microsoft Azure и ее соответствующими модулями Runbook вы можете создать автоматизированные и запланированные к выполнению задания, провизионирующие новый сегмент и/или меняющие уровень производительности отдельных сегментов в соответствии с набором правил. 

**SetupShardedEnvironment.ps1**. Этот модуль runbook для PowerShell выполняет одноразовую настройку сегментированной среды с диспетчером сопоставления сегментов и картой диапазонов сегмента. 

**ProvisionByDate.ps1**. Заранее провизионирует новую базу данных для рабочей нагрузки будущего дня. База данных создается и именуется в соответствии с датой (формат ГГГГММДД) и регистрируется в диспетчере сопоставления сегментов в виде диапазона [ГГГГММДД, ГГГГММДД + 1Д). 

**ProvisionBySize.ps1**. Провизионирует новую базу данных при недостатке емкости текущей базы данных. 

**ReduceServiceTier.ps1**. Проходит в цикле через сегменты в предоставленном сопоставлении сегментов и определяет, является ли каждый индивидуальный сегмент кандидатом на снижение уровня производительности. Определение производится по двум условиям: (1) текущему уровню обслуживания сегмента и (2) времени существования базы данных.  

**ShardManagement.psm1**. Предоставляет набор методов для взаимодействия с диспетчером сопоставления сегментов. 

**SqlDatabaseHelpers.psm1**. Предоставляет набор методов для взаимодействия с базами данных SQL Azure. 

**ShardElasticity.psm1**. Предоставляет набор методов для выполнения операций по горизонтальному и вертикальному масштабированию. 

**ShardElasticityModule.psd1**. Предоставляет набор методов для взаимодействия с эластичным масштабированием и базой данных SQL Azure. 

## Расходы

Внимание: выполнение примеров скриптов PowerShell приведет к созданию баз данных, что повлечет за собой денежные затраты для владельца подписки. За использование базовых баз данных SQL Azure будет [взиматься плата](http://azure.microsoft.com/pricing/details/sql-database/) в том же размере, что и за другие базы данных SQL Azure.  Начиная с 1 ноября взимается следующая оплата: 

* Модуль runbook SetupShardedEnvironment создает диспетчер сопоставления сегментов в базе данных Basic (0,0069 долларов США в час), а также провизионирует первый сегмент базы данных Basic (0,0069 долларов США в час). 

* Модули runbook ProvisionBySize и ProvisionByDate провизионируют базу данных Standard S0 (0,0208 долларов США в час).  Снизить эти затраты можно, запустив модули совместно с модулем runbook ReduceServiceTier - тогда спустя сутки уровень обслуживания новых провизионированных баз данных будет уменьшен с Standard S0 ($0,0208 в час) до Basic ($0,0069 в час). 

И, наконец, использование [службы автоматизации Azure](http://azure.microsoft.com/pricing/details/automation/) в рамках приведенных примеров в настоящее время не повлечет за собой взимание платы с владельца подписки.  Дополнительную информацию см. на [странице цен за использование службы автоматизации Azure](http://azure.microsoft.com/pricing/details/automation/). 

## Загрузка модулей Runbook 

1. Скачайте файл **ShardElasticity.zip** и извлеките его содержание.
2. [Добавьте ссылки на двоичные файлы эластичного масштабирования с помощью NuGet](sql-database-elastic-scale-add-references-visual-studio.md)
3. Найдите двоичный файл клиента эластичного масштабирования (**Microsoft.Azure.SqlDatabase.ElasticScale.Client.dll**).
4. Поместите DLL в папку ShardElasticityModule и сожмите эту папку в ZIP-архив. 
3. Войдите в свою учетную запись службы автоматизации Azure и отправьте файл ShardElasticityModule.zip в качестве **ресурса**. 
4. Создайте в службе автоматизации Azure **учетные данные ресурса** с именем *ElasticScaleCredential*, содержащие имя пользователя и пароль для вашего сервера баз данных SQL Azure. 
5. Создайте **переменную ресурса** с именем *SqlServerName* для полного имени сервера баз данных SQL Azure. 
5. Передайте файлы **SetupShardedEnvironment.ps1**, **ProvisionBySize.ps1**, **ProvisionByDate.ps1** и **ProvisionByDate.ps1** в качестве модулей runbook. 
6. Чтобы настроить сегментированную среду, однократно испытайте модуль runbook **SetupShardedEnvironment.ps1**. 
7. Опубликуйте один или несколько из оставшихся модулей runbook и свяжите эти модули с расписанием. 
8. Просмотрите выходные данные модуля runbook на вкладке **ЗАДАНИЯ**. 

Если краткие инструкции не помогли вам в работе над примером, ознакомьтесь с подробными инструкциями, приведенными ниже.  

## Использование модулей Runbook

1. Создайте и упакуйте модуль PowerShell. 
2. Создайте учетную запись службы автоматизации Microsoft Azure. 
3. Передайте модуль PowerShell в службу автоматизации Azure в качестве ресурса. 
4. Создайте учетные данные службы автоматизации Azure и переменные ресурсы. 
5. Передайте модули Runbook PowerShell в службу автоматизации Azure. 
6. Настройте сегментированную среду. 
7. Протестируйте модули Runbook службы автоматизации. 
8. Опубликуйте модули Runbook. 
9. Запланируйте выполнение модулей Runbook. 


## Создайте и упакуйте модуль PowerShell. 

Первый шаг - создание модуля PowerShell, ссылающегося на сборки эластичного масштабирования, и упаковка этого модуля для передачи в службу автоматизации Azure в качестве ресурса. 

1. Загрузите файл ShardElasticity.zip.
2. Извлеките все содержание файла.

    ![Extract all][1]
3. Получите клиентский DLL-файл эластичного масштабирования (т. е. файл Microsoft.Azure.SqlDatabase.ElasticScale.Client.dll) и скопируйте следующие файлы в свою локальную папку ShardElasticityModule, которую вы скачали на шаге 1.  Это можно сделать двумя способами: 1) скачать DLL по [ссылке] на пакет NuGet для эластичного масштабирования или 2) скачать по [ссылке] для проекта из начального набора эластичного масштабирования (проект должен быть построен) и перейти в каталог \bin\Debug\, чтобы взять оттуда DLL-файл.

    ![Obtain Dll][2]

4. Сожмите папку ShardElasticityModule в ZIP-архив. 

    Примечание. Служба автоматизации Azure требует выполнения некоторых соглашений о присвоении имен: имя ZIP-файла должно полностью соответствовать имени модуля. Например, если модуль называется ShardElasticityModule.psm1, ZIP-файл должен называться ShardElasticityModule.zip. В zip-файле содержится папка ShardElasticityModule (имя соответствует имени модуля), в которой в свою очередь содержится psm1-файл. Если эта структура не соблюдены, автоматизации Azure не будет распаковать модуль.

5.    Когда вы убедитесь, что содержание и структура папки, сжатой в ZIP-архив, соответствуют требованиям, переходите к следующему шагу. Он должен выглядеть примерно следующим образом:

    ![dll][3]


## Регистрация для предварительной версии службы автоматизации Azure

1. Перейдите на страницу [Предварительная версия Azure](http://azure.microsoft.com/services/preview/).
    
2. Щелкните ссылку **Попробовать**.

    ![Click Try It][8]

2. Перейдите на[ портал Microsoft Azure](https://manage.windowsazure.com/microsoft.onmicrosoft.com).
3. Щелкните ссылку **Автоматизация**.

    ![Automation][4]
4. В нижней части экрана щелкните ссылку **Создать**. 
5. В командной строке, показанной ниже, введите действующее имя учетной записи и установите флажок в правом нижнем углу окна.

    ![Prompt][5] 
5. Перейдите к следующему шагу. Успешное выполнение будет схоже с приведенной ниже иллюстрацией.

    ![success][6]

## Передайте модуль PowerShell в службу автоматизации Azure в качестве ресурса. 

Передайте указанный выше модуль PowerShell в свою учетную записи службы автоматизации Azure. Например, в модуле содержатся набор функций для эластичности сегментов и библиотеки DLL для эластичного масштабирования, на которые можно ссылаться из модулей Runbook. 

1. На ленте в верхней части экрана нажмите кнопку **РЕСУРСЫ**.
2. В нижней части страницы нажмите кнопку **ИМПОРТИРОВАТЬ МОДУЛЬ**. 
3. Нажмите кнопку **ОБЗОР ФАЙЛА...** и найдите упомянутый выше файл **ShardElasticityModule.zip**. 
4. Выбрав правильный файл, установите флажок в правом нижнем углу поля, чтобы импортировать его. Служба автоматизации Azure импортирует модуль. 
5. Перейдите к следующему шагу. У вас должен получиться результат, показанный на этом рисунке. Если модуль не был успешно импортирован, убедитесь, что в ZIP-файл соответствует описанным выше.

    ![Assets][10] 
      
## Создайте учетные данные службы автоматизации Azure и переменные ресурсы. 

Вместо жесткого задания учетных данных и часто используемых переменных в модуле Runbook служба автоматизации Azure позволяет создавать соответственно учетные данные и переменные ресурсы так, что на них можно будет ссылаться из разных модулей. Например, менять пароль потом нужно будет только в одном месте. 

1. Выберите только что созданную вами новую учетную запись службы автоматизации Azure.
2. Войдя в учетную запись **ShardElasticityExamples**, нажмите на ленте кнопку **РЕСУРСЫ**.
3. Нажмите кнопку **ДОБАВИТЬ ПАРАМЕТР** в нижней части экрана.  
4. Щелкните **ДОБАВИТЬ УЧЕТНЫЕ ДАННЫЕ**. 

    ![Add credential][9]
4. Выберите **Учетные данные Windows PowerShell** в качестве **ТИПА УЧЕТНЫХ ДАННЫХ** и **ElasticScaleCredential** в качестве имени. Описание является необязательным.  
5. Щелкните стрелку в правом нижнем углу окна. 

    Примечание. Чтобы использовать модули Runbook без изменений, используйте в точности такие имена переменных, какие указаны в инструкции. В модулях Runbook есть ссылки на имена переменных. 
5. Вставьте имя пользователя и пароль (два раза) для сервера баз данных SQL Azure, на котором вы хотите запустить примеры эластичности сегментов. 
 
6. Чтобы создать переменную ресурса, щелкните **ДОБАВИТЬ ПАРАМЕТР**, затем выберите **ДОБАВИТЬ ПЕРЕМЕННУЮ**. 

    ![Add variable][7]
7. Для данного примера необходимо создать переменную для полного имени сервера баз данных SQL Azure, на котором будут располагаться диспетчер сопоставления сегментов и сегментированные базы данных. Выберите **строку** как **ТИП ПЕРЕМЕННОЙ**и введите **SqlServerName**. Щелкните стрелку, чтобы продолжить. 
8. Введите полное доменное имя сервера БД SQL Azure в качестве ЗНАЧЕНИЯ и щелкните флажок. 
9. Вы создали учетные данные и переменный ресурс, которые будут использоваться в модулях runbook для эластичности сегментов.  Перейдите к следующему шагу. У вас должен получиться следующий результат: 
    

## Передайте модули Runbook PowerShell в службу автоматизации Azure. 

Передайте четыре предоставленных учебных модуля Runbook для PowerShell. 

1. Чтобы передать новый модуль runbook для службы автоматизации Azure, нажмите кнопку **МОДУЛИ RUNBOOK** на ленте. 
2. В нижней части экрана щелкните ссылку **ИМПОРТ**. 
3. Перейдите к папке, содержащей файл, выберите **SetupShardedEnvironment.ps1** и установите флажок. 
4. Повторите шаги 2 и 3 для трех оставшихся модулей для PowerShell (**ProvisionByDate.ps1**, **ProvisionBySize.ps1** и **ReduceServiceTier.ps1**). 
5. Перейдите к следующему шагу. 

## Настройте сегментированную среду. 

Следующий шаг - выполнение модуля runbook **SetupShardedEnvironment**, подготавливающего сегментированную среду вместе с базой данных диспетчера сопоставления сегментов, сопоставлением сегментов по диапазонам и сегмента на текущий день.   

1. Выберите модуль **SetupShardedEnvironment**, щелкнув его имя. 
2. Нажмите кнопку **АВТОР** на ленте. 
3. На этом экране вы увидите код модуля runbook (и при необходимости сможете изменить его). Чтобы настроить сегментированную среду, нажмите кнопку **ТЕСТ** в нижней части экрана. Подтвердите сохранение и тестирование модуля runbook. 
4. На панели вывода вы можете просмотреть состояние задания. После завершения на указанном вами сервере баз данных SQL Azure будет размещена база данных диспетчера сопоставления сегментов, а также база данных сегмента. Модуль**SetupShardedEnvironment** предназначен лишь для провизионирования сегментированной среды и не предназначен для повторных запусков по расписанию. Перейдите к следующему шагу.  

## Протестируйте модули Runbook службы автоматизации. 

Проверьте успешное выполнение всех модулей Runbook перед публикацией и планированием запуска модулей. 

1. Щелкните **RUNBOOK** на ленте в верхней части страницы. 
2. Выберите модуль **ProvisionByDate**.
3. Щелкните **АВТОР** на ленте в верхней части страницы. 
4. Щелкните **СОХРАНИТЬ**, затем **ТЕСТ**.
5. Повторите эти действия для файла **ReduceServiceTier**. 

    Внимание! Так как и **ProvisionBySize**, и **ProvisionByDate** подготавливают новые сегменты (используя разные алгоритмы), в этот раз нет необходимости запускать **ProvisionByDate**. 

## Опубликуйте модуль Runbook. 
Следующий шаг - публикация модуля runbook, дающая возможность запланировать его выполнение на периодической основе. 

1. В нижней части страницы нажмите кнопку **ОПУБЛИКОВАТЬ**. 
2. Щелкните **Опубликовано**. 
3. Перейдите к следующему шагу.
 
## Запланируйте выполнение модуля Runbook. 

Последний шаг - создание расписания и связывание его с опубликованным выше модулем Runbook. 

1. Щелкните **РАСПИСАНИЕ** в верхней части страницы. 
2. Щелкните **СВЯЗАТЬ С НОВЫМ РАСПИСАНИЕМ**.
3. Назовите расписание соответствующим образом и нажмите кнопку со стрелкой вправо.
4. Настройте расписание.
5. По завершении щелкните флажок в нижней части окна.
6. Когда задание будет выполнено в соответствии с назначенным ранее расписанием, щелкните ссылку **ЗАДАНИЯ** в ленте в верхней части страницы и выберите запланированное задание. 

## Заключение 

Теперь вы успешно создали и упаковали модуль PowerShell, передали модуль PowerShell для службы автоматизации Azure в качестве ресурса, а также создали, протестировали и опубликовали модуль Runbook и запланировали его выполнение.  Для мониторинга исправности и состояния модуля Runbook используйте вкладки панели мониторинга и заданий. 

Приведенные примеры демонстрируют лишь малую долю возможностей, которые дает сочетание эластичного масштабирования, баз данных SQL Azure и службы автоматизации Azure. Экспериментируйте с этими примерами и развивайте их дальше - так вы сможете добиться в своем приложении баз данных SQL Azure вертикального или горизонтального масштабирования либо обоих видов масштабирования сразу. 

[AZURE.INCLUDE [elastic-scale-include](../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-scripting/zip.png
[2]: ./media/sql-database-elastic-scale-scripting/dll.png
[3]: ./media/sql-database-elastic-scale-scripting/lookslikethis.png
[4]: ./media/sql-database-elastic-scale-scripting/automation.png
[5]: ./media/sql-database-elastic-scale-scripting/prompt.png
[6]: ./media/sql-database-elastic-scale-scripting/success.png
[7]: ./media/sql-database-elastic-scale-scripting/add-variable.png
[8]: ./media/sql-database-elastic-scale-scripting/sign-up.png
[9]: ./media/sql-database-elastic-scale-scripting/add-credential.png
[10]: ./media/sql-database-elastic-scale-scripting/assets.png

<!--HONumber=47-->
