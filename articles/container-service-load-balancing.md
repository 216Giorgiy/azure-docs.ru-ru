<properties
   pageTitle="Балансировка нагрузки кластера службы контейнеров Azure | Microsoft Azure"
   description="Балансировка нагрузки кластера службы контейнеров Azure."
   services="container-service"
   documentationCenter=""
   authors="rgardler"
   manager="timlt"
   editor=""
   tags="acs, azure-container-service"
   keywords="Контейнеры, микрослужбы, DC/OS, Azure"/>

<tags
   ms.service="container-service"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/18/2016"
   ms.author="rogardle"/>

# Балансировка нагрузки кластера службы контейнеров Azure

В этой статье мы настроим веб-интерфейс, который можно увеличивать в масштабе для предоставления служб за Azure Load Balancer.


## Предварительные требования

[Разверните экземпляр службы контейнера Azure](container-service-deployment.md) с типом оркестратора DCOS. [Убедитесь, что клиент может подключиться к кластеру](container-service-connect.md) [AZURE.INCLUDE [Установите интерфейс командной строки DC/OS](../../includes/container-service-install-dcos-cli-include.md)].


## Балансировка нагрузки.

В кластере службы контейнеров доступны два уровня балансировки нагрузки: с помощью Azure Load Balancer для общедоступных точек входа, которые используются конечными пользователями; с помощью базового балансировщика нагрузки Marathon, который направляет входящие запросы к экземплярам контейнера, обслуживающим запросы. Масштабирование контейнеров с предоставлением службы предусматривает динамическое приспособление балансировщика нагрузки Marathon.

## Балансировщик нагрузки Marathon 

Балансировщик нагрузки Marathon динамически изменяет свою конфигурацию в соответствии с развернутыми контейнерами. Это решение также устойчиво к сбою в работе контейнера или агента. В случае сбоя Mesos просто перезапустит контейнер в другом расположении и перенастроит балансировщик нагрузки Marathon.

Чтобы установить балансировщик нагрузки Marathon, выполните следующую команду с клиентского компьютера:

```bash
dcos package install marathon-lb 
``` 

Установив пакет балансировщика нагрузки, мы может развернуть простой веб-сервер с помощью следующей конфигурации:


```json
{ 
  "id": "web", 
  "container": { 
    "type": "DOCKER", 
    "docker": { 
      "image": "tutum/hello-world", 
      "network": "BRIDGE", 
      "portMappings": [ 
        { "hostPort": 0, "containerPort": 80, "servicePort": 10000 } 
      ], 
      "forcePullImage":true 
    } 
  }, 
  "instances": 3, 
  "cpus": 0.1, 
  "mem": 65, 
  "healthChecks": [{ 
      "protocol": "HTTP", 
      "path": "/", 
      "portIndex": 0, 
      "timeoutSeconds": 10, 
      "gracePeriodSeconds": 10, 
      "intervalSeconds": 2, 
      "maxConsecutiveFailures": 10 
  }], 
  "labels":{ 
    "HAPROXY_GROUP":"external",
    "HAPROXY_0_VHOST":"YOUR FQDN",
    "HAPROXY_0_MODE":"http" 
  } 
}

```

Ключевые моменты.
  * Параметру HAProxy\_0\_VHOST нужно задать значение полного доменного имени балансировщика нагрузки для агентов в следующем формате: `<acsName>agents.<region>.cloudapp.azure.com`. Например, если кластер службы контейнеров создан с именем `myacs` в регионе `West US`, полное доменное имя будет таким: `myacsagents.westus.cloudapp.azure.com`. Это значение также можно получить, выполнив в группе ресурсов, созданной для службы контейнеров на [портале Azure](https://portal.azure.com), поиск балансировщика нагрузки, в имени которого содержится agent.
  * Параметру servicePort следует назначить порт с номером >= 10 000. Таким образом мы определим службу, запущенную в этом контейнере. Балансировщик нагрузки Marathon сможет определять службы, для которых он должен балансировать нагрузку.
  * Укажите для метки HAPROXY\_GROUP значение external.
  * Задайте параметру hostPort значение 0. Таким образом балансировщик нагрузки Marathon будет произвольно выделять доступный порт.

Скопируйте этот объект JSON в файл с именем `hello-web.json`, а затем разверните с его помощью контейнер:

```bash
dcos marathon app add hello-web.json 
``` 

## Azure Load Balancer 

По умолчанию Azure Load Balancer использует порты 80, 8080 и 443. При использовании одного из этих трех портов (как это было сделано в примере выше) дополнительные действия не требуются. Будет использоваться полное доменное имя агента балансировщика нагрузки, а при каждом обновлении — один из трех веб-серверов, выбранный с помощью циклического перебора. Но если используется другой порт, вам нужно добавить для него в Azure Load Balancer правило циклического перебора и зонд для порта. Это можно сделать в [интерфейсе командной строки Azure XPLAT](../xplat-cli-azure-resource-manager.md) с помощью команд `azure lb rule create` и `azure lb probe create`.


## Дополнительные сценарии

Возможно, вам потребуется использовать другие домены для предоставления других служб. Например:

mydomain1.com -> Azure LB:80 -> marathon-lb:10001 -> mycontainer1:33292 mydomain2.com -> Azure LB:80 -> marathon-lb:10002 -> mycontainer2:22321

Подробные сведения об этом см. в документации по [виртуальным узлам](https://mesosphere.com/blog/2015/12/04/dcos-marathon-lb/), которые позволяют связать домены с конкретными путями балансировщика нагрузки Marathon.

Кроме того, можно предоставить другие порты, повторно сопоставив их с соответствующей службой за балансировщиком нагрузки Marathon. Например:

Azure lb:80 -> marathon-lb:10001 -> mycontainer:233423 Azure lb:8080 -> marathon-lb:1002 -> mycontainer2:33432
 

## Дальнейшие действия

Дополнительные сведения о балансировщике нагрузки Marathon см. в [этой записи блога](https://mesosphere.com/blog/2015/12/04/dcos-marathon-lb/).

<!---HONumber=AcomDC_0525_2016-->
