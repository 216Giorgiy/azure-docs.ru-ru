---
title: Создание пространства разработки Kubernetes в облаке с помощью .NET Core и Visual Studio | Документы Майкрософт
titleSuffix: Azure Dev Spaces
services: azure-dev-spaces
ms.service: azure-dev-spaces
ms.component: azds-kubernetes
author: ghogen
ms.author: ghogen
ms.date: 05/11/2018
ms.topic: tutorial
description: Быстрая разработка в Kubernetes с использованием контейнеров и микрослужб в Azure
keywords: Docker, Kubernetes, Azure, AKS, Azure Kubernetes Service, containers
manager: douge
ms.openlocfilehash: c2d92f26bec2045e7f1e8afff189d58d8c29f25a
ms.sourcegitcommit: d7725f1f20c534c102021aa4feaea7fc0d257609
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2018
ms.locfileid: "37099482"
---
# <a name="get-started-on-azure-dev-spaces-with-net-core-and-visual-studio"></a>Начало работы в Azure Dev Spaces и .NET Core и Visual Studio

Из этого руководства вы узнаете, как выполнить следующие задачи:

- Настройка Azure Dev Spaces с помощью управляемого кластера Kubernetes в Azure.
- итеративно разрабатывать код в контейнерах с помощью Visual Studio.
- независимо разработать две отдельные службы и использовать обнаружение службы DNS Kubernetes для вызова другой службы;
- эффективно разработать и протестировать код в командной среде.

[!INCLUDE[](includes/see-troubleshooting.md)]

[!INCLUDE[](includes/portal-aks-cluster.md)]

## <a name="get-the-visual-studio-tools"></a>Получение средств Visual Studio
1. Установите последнюю версию [Visual Studio 2017](https://www.visualstudio.com/vs/).
1. Убедитесь, что выбрана следующая рабочая нагрузка в установщике Visual Studio:
    * ASP.NET и веб-разработка.
1. Установка [Средств Visual Studio для Kubernetes](https://aka.ms/get-azds-visualstudio)

## <a name="create-a-web-app-running-in-a-container"></a>Создание веб-приложения для работы в контейнере

В этом разделе вы создадите веб-приложение ASP.NET Core и запустите его в контейнере в Kubernetes.

### <a name="create-an-aspnet-web-app"></a>Создание веб-приложения ASP.NET

Создайте новый проект в Visual Studio 2017. В настоящее время проект должен быть **веб-приложением ASP.NET Core**. Присвойте проекту имя **webfrontend**.

![](media/get-started-netcore-visualstudio/NewProjectDialog1.png)

Выберите шаблон **Веб-приложение (модель-представление-контроллер)** и выберите **.NET Core** и **ASP.NET Core 2.0** в двух раскрывающихся списках в верхней части диалогового окна. Нажмите кнопку **ОК** , чтобы создать проект.

![](media/get-started-netcore-visualstudio/NewProjectDialog2.png)


### <a name="enable-dev-spaces-for-an-aks-cluster"></a>Включение Dev Spaces для кластера AKS

В только что созданном проекте в раскрывающемся списке параметров запуска выберите **Azure Dev Spaces**, как показано ниже.

![](media/get-started-netcore-visualstudio/LaunchSettings.png)

В появившемся диалоговом окне убедитесь, что вы вошли в систему с соответствующей учетной записью, а затем выберите существующий кластер Kubernetes.

![](media/get-started-netcore-visualstudio/Azure-Dev-Spaces-Dialog.PNG)

В раскрывающемся списке **Пространство** оставьте пока значение по умолчанию (`default`). Позже вы узнаете больше об этом параметре. Установите флажок **Publicly Accessible** (Общедоступное), чтобы веб-приложение было доступно через общедоступную конечную точку. Этот параметр не является обязательным, но он будет полезен для демонстрации некоторых концепций далее в этом пошаговом руководстве. Но не волнуйтесь, вы в любом случае сможете выполнить отладку веб-сайта с помощью Visual Studio.

![](media/get-started-netcore-visualstudio/Azure-Dev-Spaces-Dialog2.png)

Нажмите кнопку **ОК**, чтобы выбрать или создать кластер.

Если выбран кластер, который еще не был настроен для работы с Azure Dev Spaces, вы увидите сообщение с вопросом, хотите ли вы настроить его.

![](media/get-started-netcore-visualstudio/Add-Azure-Dev-Spaces-Resource.png)

Нажмите кнопку **ОК**.

 Эта задача запустится в фоновом режиме. Выполнение может занять несколько минут. Чтобы увидеть, находится ли кластер в процессе создания, наведите указатель мыши на значок **фоновые задачи** в левом нижнем углу строки состояния, как показано на следующем изображении.

![](media/get-started-netcore-visualstudio/BackgroundTasks.PNG)

> [!Note]
> Пока не будет создано пространство разработки, выполнить отладку приложения нельзя.

### <a name="look-at-the-files-added-to-project"></a>Просмотр файлов, добавленных в проект
Пока вы ожидаете завершения создания пространства разработки, просмотрите файлы, которые были добавлены в ваш проект при выборе пространства разработки.

Во-первых, вы можете увидеть, что была добавлена папка с именем `charts`, в которой создана [диаграмма Helm](https://docs.helm.sh) для вашего приложения. Эти файлы используются для развертывания приложения в пространство разработки.

Вы увидите добавленный файл с именем `Dockerfile`. Этот файл содержит сведения, необходимые для упаковки приложения в стандартном формате Docker.

Наконец вы увидите файл с именем `azds.yaml`, содержащий конфигурацию, которая использовалась при разработке и требуется для пространства разработки.

![](media/get-started-netcore-visualstudio/ProjectFiles.png)

## <a name="debug-a-container-in-kubernetes"></a>Отладка контейнера в Kubernetes
После успешного создания пространства разработки вы можете приступить к отладке приложения. Установите точку останова в коде, например, в строке 20 в файле `HomeController.cs`, где установлена ​​переменная `Message`. Нажмите клавишу **F5**, чтобы запустить отладку. 

Visual Studio будет взаимодействовать с пространством разработки для создания и развертывания приложения, а затем откроет браузер с работающим веб-приложением. Может показаться, что контейнер работает локально, но на самом деле он выполняется в пространстве разработки в Azure. В адресе указано localhost, так как Azure Dev Spaces создает временный туннель SSH к контейнеру, работающему в AKS.

Перейдите по ссылке **About** (Сведения) в верхней части страницы, чтобы вызвать точку останова. У вас есть полный доступ к отладочной информации, как если бы код выполнялся локально, например к стеку вызовов, локальным переменным, информации об исключениях и т. д.

## <a name="iteratively-develop-code"></a>Итерационная разработка кода

Azure Dev Spaces — это не просто среда выполнения кода в Kubernetes. Она позволяет быстро и итеративно видеть, как изменения вашего кода вступают в силу в среде Kubernetes в облаке.

### <a name="update-a-content-file"></a>Обновление файла содержимого
1. Найдите файл `./Views/Home/Index.cshtml` и внесите изменения в HTML. Например, измените строку 70 `<h2>Application uses</h2>` строкой примерно такого содержания: `<h2>Hello k8s in Azure!</h2>`
1. Сохраните файл.
1. Вернитесь в браузер и обновите страницу. Должна отобразиться веб-страница с обновленным HTML.

Что произошло? Изменения файлов содержимого, таких как HTML и CSS, не требуют повторной компиляции в веб-приложении .NET Core, поэтому активный сеанс F5 автоматически синхронизирует любые измененные файлы содержимого в запущенный контейнер в AKS, чтобы можно было сразу же видеть изменения содержимого.

### <a name="update-a-code-file"></a>Обновление файла кода
Для обновления файлов кода требуется немного больше работы, так как приложение .NET Core должно перестроить и создать обновленные двоичные файлы приложений.

1. Остановите отладчик в Visual Studio.
1. Откройте файл кода с именем `Controllers/HomeController.cs` и измените сообщение, которое будет отображаться на странице About (Сведения): `ViewData["Message"] = "Your application description page.";`
1. Сохраните файл.
1. Нажмите клавишу **F5**, чтобы снова запустить отладку. 

Вместо того, чтобы перестраивать и повторно развертывать новый образ контейнера при каждой правке кода, что часто занимает много времени, Azure Dev Spaces пошагово перекомпилирует код в существующем контейнере, чтобы ускорить цикл редактирования и отладки.

В браузере обновите веб-приложение и перейдите на страницу About (Сведения). Вы должны увидеть настраиваемое сообщение в пользовательском интерфейсе.


## <a name="call-another-container"></a>Вызов другого контейнера
В этом разделе вы создадите вторую службу, `mywebapi`, к которой будет обращаться `webfrontend`. Каждая служба будет выполняться в отдельных контейнерах. Затем вы выполните отладку в обоих контейнерах.

![](media/common/multi-container.png)

### <a name="download-sample-code-for-mywebapi"></a>Скачайте пример кода для *mywebapi*.
Ради экономии времени давайте загрузим образец кода из репозитория GitHub. Перейдите к https://github.com/Azure/dev-spaces и выберите **Clone or download** (Клонировать или скачать), чтобы скачать репозиторий GitHub. Код для этого раздела находится в папке `samples/dotnetcore/getting-started/mywebapi`.

### <a name="run-mywebapi"></a>Запуск *mywebapi*
1. Откройте проект `mywebapi` в *отдельном окне Visual Studio*.
1. Выберите **Azure Dev Spaces** в раскрывающемся списке параметров запуска, как вы это делали ранее для проекта `webfrontend`. Вместо того, чтобы создавать новый кластер AKS, в этот раз выберите уже созданный. Как и ранее, для поля "Пространство" оставьте значение по умолчанию (`default`) и нажмите кнопку **ОК**. В окне выходных данных можно заметить, что Visual Studio начинает подготавливать эту новую службу в пространстве разработки, чтобы ускорить процессы при запуске отладки.
1. Нажмите клавишу F5 и подождите, пока выполнится сборка и развертывание службы. Вы узнаете, что служба готова, когда строка состояния Visual Studio станет оранжевой.
1. Обратите внимание на URL-адрес конечной точки, отображаемый на панели **Azre Dev Spaces for AKS** (Azre Dev Spaces для AKS) в окне **Выходные данные**. Он должен иметь примерно следующий вид: http://localhost:\<portnumber\>. Может показаться, что контейнер работает локально, но на самом деле он выполняется в пространстве разработки в Azure.
2. Когда контейнер `mywebapi` готов, откройте в браузере адрес localhost и добавьте `/api/values` к URL-адресу, чтобы вызвать API GET по умолчанию для `ValuesController`. 
3. Если все шаги были успешными, вы должны увидеть ответ от службы `mywebapi`, который выглядит так:

    ![](media/get-started-netcore-visualstudio/WebAPIResponse.png)

### <a name="make-a-request-from-webfrontend-to-mywebapi"></a>Запрос из *webfrontend* к *mywebapi*
Давайте теперь напишем код в `webfrontend`, который отправляет запрос к `mywebapi`. Переключитесь в окно Visual Studio, в котором есть проект `webfrontend`. В файле `HomeController.cs` *замените* код метода About следующим кодом:

   ```csharp
   public async Task<IActionResult> About()
   {
      ViewData["Message"] = "Hello from webfrontend";

      using (var client = new System.Net.Http.HttpClient())
            {
                // Call *mywebapi*, and display its response in the page
                var request = new System.Net.Http.HttpRequestMessage();
                request.RequestUri = new Uri("http://mywebapi/api/values/1");
                if (this.Request.Headers.ContainsKey("azds-route-as"))
                {
                    // Propagate the dev space routing header
                    request.Headers.Add("azds-route-as", this.Request.Headers["azds-route-as"] as IEnumerable<string>);
                }
                var response = await client.SendAsync(request);
                ViewData["Message"] += " and " + await response.Content.ReadAsStringAsync();
            }

      return View();
   }
   ```

В предыдущем примере код перенаправляет заголовок `azds-route-as` из входящего запроса в исходящий. Позже вы увидите, как это повышает эффективность разработки в сценариях командной работы.

### <a name="debug-across-multiple-services"></a>Отладка в нескольких службах
1. На этом этапе служба `mywebapi` по-прежнему должна выполняться с подключенным отладчиком. Если это не так, нажмите клавишу F5 в проекте `mywebapi`.
1. Установите точку останова в методе `Get(int id)` в файле `Controllers/ValuesController.cs`, который обрабатывает запросы GET `api/values/{id}`.
1. В проекте `webfrontend`, куда вы вставили код выше, установите точку останова до отправки запроса GET к `mywebapi/api/values`.
1. Нажмите клавишу F5 в проекте `webfrontend`. Visual Studio снова откроет в браузере соответствующий порт localhost, и появится веб-приложение.
1. Перейдите по ссылке **About** (Сведения) в верхней части страницы, чтобы вызвать точку останова в проекте `webfrontend`. 
1. Нажмите клавишу F10, чтобы продолжить. Точка останова запустится в проекте `mywebapi`.
1. Нажмите клавишу F5, чтобы продолжить и вернуться в код проекта `webfrontend`.
1. Повторное нажатие клавиши F5 завершит запрос и вернет страницу в браузере. В веб-приложении на странице About (Сведения) будет отображаться объединенное сообщение от двух служб: "Hello from webfrontend and Hello from mywebapi".

Все готово! Теперь у вас есть многоконтейнерное приложение, где каждый контейнер можно разрабатывать и развертывать отдельно.

## <a name="learn-about-team-development"></a>Сведения о коллективной разработке

До сих пор вы запускали код приложения, как если бы вы были единственным разработчиком, работающим над этим приложением. В этом разделе вы узнаете, как Azure Dev Spaces упрощает разработку в команде:
* По мере необходимости для работы в одной среде можно объединить команды разработчиков, которые работают в общем пространстве разработки или в различных пространствах.
* Поддерживает изолированную итерацию кода каждым разработчиком без воздействия на работу команды.
* Позволяет выполнять комплексное тестирование кода перед его фиксацией без необходимости создавать макеты или моделировать зависимости.

### <a name="challenges-with-developing-microservices"></a>Сложности при разработке микрослужб
На данный момент пример вашего приложения не очень сложный. Но в реальном мире проблемы появятся по мере увеличения количества служб и участников команды разработки.

Представьте процесс разработки службы, которая взаимодействует с десятками других служб.

- Выполнение всей разработки в локальной среде может показаться нереальным. У вашего компьютера разработки может не хватить ресурсов для запуска всего приложения. Или, возможно, конечные точки вашего приложения должны быть публично доступными (например, ваше приложение отвечает веб-перехватчику из приложения SaaS).
- Вы можете попытаться запустить только те службы, от которых вы зависите, но это означает, что вам нужно знать все перекрытие зависимостей (например, зависимости зависимостей). Сложность в создании и запуске зависимостей может возникнуть по причине того, что их разрабатывали не вы.
- Некоторые разработчики прибегают к моделированию или макетированию многих зависимостей служб. Иногда это может помочь, но управление этими макетами вскоре может начать отнимать время и ресурсы. Это также приводит к тому, что ваша среда разработки не только будет отличаться от рабочей среды, но и может содержать небольшие ошибки.
- По этой причине выполнение любого типа сквозного тестирования становится затруднительным. Фактически интеграционное тестирование можно выполнить только после фиксации, что означает, что вы обнаружите проблемы позже в цикле разработки.

    ![](media/common/microservices-challenges.png)

### <a name="work-in-a-shared-dev-space"></a>Работа в общей среде разработки
С помощью Azure Dev Spaces можно настроить *общую среду разработки* в Azure. Каждый разработчик может сосредоточиться только на своей части приложения и итеративно разрабатывать *код до фиксации* в среде разработки, в которой уже содержатся все другие службы и облачные ресурсы, от которых зависят сценарии. Зависимости всегда актуальны, и разработчикам следует работать так же, как в рабочей среде.

### <a name="work-in-your-own-space"></a>Работа в собственном пространстве
При разработке кода для службы и перед его фиксацией он будет содержать большое количество ошибок. Вы будете итеративно корректировать, тестировать его и экспериментировать с решениями. Azure Dev Spaces предоставляет концепцию **пространства**, которое позволяет работать изолированно, не мешая работе участников вашей команды.

Выполните следующую команду, чтобы убедиться, что службы `webfrontend` и `mywebapi` выполняются **в пространстве разработки `default`**.
1. Закройте все сеансы отладки (F5) для обеих служб, но оставьте проекты открытыми в окнах Visual Studio.
2. Переключитесь в окно Visual Studio с проектом `mywebapi` и нажмите клавиши CTRL+F5, чтобы запустить службу без присоединенного отладчика.
3. Переключитесь в окно Visual Studio с проектом `webfrontend` и нажмите клавиши CTRL+F5, чтобы запустить его также.

> [!Note]
> Иногда необходимо обновить браузер после того, как веб-страница изначально отобразится после нажатия клавиш CTRL+F5.

Любой, кто открывает общедоступный URL-адрес и переходит к веб-приложению, будет вызывать написанный вами путь кода, который проходит через обе службы, используя пространство по умолчанию `default`. Предположим, вы хотите продолжить разработку `mywebapi`. Как это можно сделать, не вмешиваясь в работу других разработчиков, которые используют это же пространство разработки? Чтобы сделать это, настройте собственное пространство.

### <a name="create-a-new-dev-space"></a>Создание пространства разработки
В среде Visual Studio можно создать дополнительные пространства, которые будут использоваться при нажатии клавиш CTRL+F5 или F5 при работе со службой. Вы можете назвать пространство любым именем (например, `sprint4` или `demo`).

Для создания пространства выполните следующие действия:
1. Переключитесь в окно Visual Studio, в котором есть проект `mywebapi`.
2. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Свойства**.
3. Выберите вкладку **Отладка** слева, чтобы отобразить параметры Azure Dev Spaces.
4. Здесь можно изменить или создать кластер и (или) пространство, которое будет использоваться при нажатии клавиш CTRL+F5 или F5. *Убедитесь, что выбрано ранее созданное пространство Azure Dev Space*.
5. В раскрывающемся списке пространства выберите **<Create New Space…>** (Создать новое пространство…).

    ![](media/get-started-netcore-visualstudio/Settings.png)

6. В диалоговом окне **Add Space** (Добавление пространства) введите имя для пространства и нажмите кнопку **ОК**. Вы можете использовать свое имя (например, "scott") для нового пространства, чтобы люди, которые работают в одной среде с вами, могли идентифицировать ваше пространство.

    ![](media/get-started-netcore-visualstudio/AddSpace.png)

7. Теперь вы должны увидеть свой кластер AKS и новое пространство, выбранное на странице свойств проекта.

    ![](media/get-started-netcore-visualstudio/Settings2.png)

### <a name="update-code-for-mywebapi"></a>Обновление кода *mywebapi*

1. В проекте `mywebapi` измените код на метод `string Get(int id)` в файле `Controllers/ValuesController.cs` следующим образом:
 
    ```csharp
    [HttpGet("{id}")]
    public string Get(int id)
    {
        return "mywebapi now says something new";
    }
    ```

2. Установите точку останова в этом обновленном блоке кода (это может быть точка, созданная ранее).
3. Нажмите клавишу F5 для запуска службы `mywebapi`. В вашем кластере будет запущена служба, использующая выбранное пространство, в данном случае — `scott`.

Ниже приведена схема, которая поможет вам понять, как работают разные пространства. Путь фиолетового цвета отображает запрос через пространство `default`, которое используется по умолчанию, если к URL-адресу не добавлено пространство. Путь розового цвета отображает запрос через пространство `default/scott`.

![](media/common/Space-Routing.png)

Эта встроенная возможность Azure Dev Spaces позволяет выполнять комплексное тестирование кода в общей среде, не требуя от каждого разработчика повторно создавать множество служб в своем пространстве. Для такой маршрутизации требуется, чтобы заголовки распространения передавались в код приложения, как показано на предыдущем шаге этого руководства.

### <a name="test-code-running-in-the-defaultscott-space"></a>Тестирование кода, выполняемого в пространстве `default/scott`
Чтобы проверить свою новую версию `mywebapi` в сочетании с `webfrontend`, откройте в браузере URL-адрес общедоступной точки доступа `webfrontend` (например, http://webfrontend.123456abcdef.eastus.aksapp.io)) и перейдите на страницу About (Сведения). Вы увидите исходное сообщение "Hello from webfrontend and Hello from mywebapi".

Теперь добавьте часть "scott.s" в URL-адрес, чтобы получилось http://scott.s.webfrontend.123456abcdef.eastus.aksapp.io, и обновите браузер. Должна сработать точка останова, заданная в проекте `mywebapi`. Нажмите клавишу F5, чтобы продолжить. В браузере вы должны увидеть новое сообщение "Hello from webfrontend and mywebapi now says something new". Это происходит, так как путь к обновленному коду в `mywebapi` используется в пространстве `default/scott`.

[!INCLUDE[](includes/well-done.md)]

[!INCLUDE[](includes/clean-up.md)]
