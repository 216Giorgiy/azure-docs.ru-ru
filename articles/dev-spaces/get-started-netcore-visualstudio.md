---
title: Создание среды разработки Kubernetes в облаке с помощью .NET Core и Visual Studio | Документация Майкрософт
titleSuffix: Azure Dev Spaces
services: azure-dev-spaces
ms.service: azure-dev-spaces
ms.component: azds-kubernetes
author: ghogen
ms.author: ghogen
ms.date: 05/11/2018
ms.topic: tutorial
description: Быстрая разработка в Kubernetes с использованием контейнеров и микрослужб в Azure
keywords: Docker, Kubernetes, Azure, AKS, Azure Kubernetes Service, containers
manager: douge
ms.openlocfilehash: 012efcbd3fa87268f3a68fdac524ce8310d10120
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34362062"
---
# <a name="get-started-on-azure-dev-spaces-with-net-core-and-visual-studio"></a>Начало работы в Azure Dev Spaces и .NET Core и Visual Studio

В этом руководстве вы узнаете как:

- создать среду в Azure на основе Kubernetes, которая оптимизирована для разработки;
- итеративно разрабатывать код в контейнерах с помощью Visual Studio;
- независимо разработать две отдельные службы и использовать обнаружение службы DNS Kubernetes для вызова другой службы;
- эффективно разработать и протестировать код в командной среде.

[!INCLUDE[](includes/see-troubleshooting.md)]

[!INCLUDE[](includes/portal-aks-cluster.md)]

## <a name="get-the-visual-studio-tools"></a>Получение средств Visual Studio
1. Установите последнюю версию [Visual Studio 2017](https://www.visualstudio.com/vs/).
1. Убедитесь, что выбрана следующая рабочая нагрузка в установщике Visual Studio:
    * ASP.NET и веб-разработка.
1. Установите [расширение Visual Studio для Azure Dev Spaces](https://aka.ms/get-azds-visualstudio).

Теперь вы готовы создать веб-приложение ASP.NET с помощью Visual Studio.

## <a name="create-an-aspnet-web-app"></a>Создание веб-приложения ASP.NET

Создайте новый проект в Visual Studio 2017. В настоящее время проект должен быть **веб-приложением ASP.NET Core**. Присвойте проекту имя **webfrontend**.

![](media/get-started-netcore-visualstudio/NewProjectDialog1.png)

Выберите шаблон **Веб-приложение (модель-представление-контроллер)** и выберите **.NET Core** и **ASP.NET Core 2.0** в двух раскрывающихся списках в верхней части диалогового окна. Нажмите кнопку **ОК** , чтобы создать проект.

![](media/get-started-netcore-visualstudio/NewProjectDialog2.png)


## <a name="create-a-dev-environment-in-azure"></a>Создание среды разработки в Azure

В Azure Dev Spaces вы можете создавать среды разработки на основе Kubernetes, которые полностью управляются Azure и оптимизированы для разработки. В только что созданном проекте из раскрывающегося списка параметров запуска выберите **Azure Dev Spaces**, как показано ниже.

![](media/get-started-netcore-visualstudio/LaunchSettings.png)

В появившемся диалоговом окне убедитесь, что вы вошли в систему с соответствующей учетной записью, а затем выберите существующий кластер Kubernetes.

![](media/get-started-netcore-visualstudio/Azure-Dev-Spaces-Dialog.PNG)

В раскрывающемся списке **Пространство** оставьте пока значение по умолчанию (`default`). Позже вы узнаете больше об этом параметре. Установите флажок **Publicly Accessible** (Общедоступное), чтобы веб-приложение было доступно через общедоступную конечную точку. Этот параметр не является обязательным, но он будет полезен для демонстрации некоторых концепций далее в этом пошаговом руководстве. Но не волнуйтесь, вы в любом случае сможете выполнить отладку веб-сайта с помощью Visual Studio.

![](media/get-started-netcore-visualstudio/Azure-Dev-Spaces-Dialog2.png)

Нажмите кнопку **ОК**, чтобы выбрать или создать кластер.

Если выбран кластер, который еще не был настроен для работы с Azure Dev Spaces, вы увидите сообщение с вопросом, хотите ли вы настроить его.

![](media/get-started-netcore-visualstudio/Add-Azure-Dev-Spaces-Resource.png)

Нажмите кнопку **ОК**.

 Эта задача запустится в фоновом режиме. Выполнение может занять несколько минут. Чтобы увидеть, находится ли кластер в процессе создания, наведите указатель мыши на значок **фоновые задачи** в левом нижнем углу строки состояния, как показано на следующем изображении.

![](media/get-started-netcore-visualstudio/BackgroundTasks.PNG)

> [!Note]
> Пока среда разработки не будет успешно создана, вы не сможете отлаживать свое приложение.

## <a name="look-at-the-files-added-to-project"></a>Просмотр файлов, добавленных в проект
Пока вы ожидаете создания среды разработки, просмотрите файлы, которые были добавлены в ваш проект при выборе среды разработки.

Во-первых, вы можете увидеть, что была добавлена папка с именем `charts`, в которой создана [диаграмма Helm](https://docs.helm.sh) для вашего приложения. Эти файлы используются для развертывания приложения в среду разработки.

Вы увидите добавленный файл с именем `Dockerfile`. Этот файл содержит сведения, необходимые для упаковки приложения в стандартном формате Docker. Также был создан файл `HeaderPropagation.cs`. Мы обсудим его позже в руководстве. 

Наконец, вы увидите файл с именем `azds.yaml`, содержащий сведения о конфигурации, необходимые для среды разработки. Например, должно ли приложение быть доступным через общедоступную конечную точку.

![](media/get-started-netcore-visualstudio/ProjectFiles.png)

## <a name="debug-a-container-in-kubernetes"></a>Отладка контейнера в Kubernetes
После успешного создания среды разработки вы сможете приступить к отладке приложения. Установите точку останова в коде, например, в строке 20 в файле `HomeController.cs`, где установлена ​​переменная `Message`. Нажмите клавишу **F5**, чтобы запустить отладку. 

Visual Studio будет взаимодействовать со средой разработки для сборки и развертывания приложения, а затем откроет браузер с работающим веб-приложением. Может показаться, что контейнер выполняется локально, хотя фактически он выполняется в среде разработки в Azure. В адресе указано localhost, потому что Azure Dev Spaces создает временный туннель SSH к контейнеру, работающему в Azure.

Перейдите по ссылке **About** (Сведения) в верхней части страницы, чтобы вызвать точку останова. У вас есть полный доступ к отладочной информации, как если бы код выполнялся локально, например к стеку вызовов, локальным переменным, информации об исключениях и т. д.

## <a name="call-another-container"></a>Вызов другого контейнера
В этом разделе вы создадите вторую службу, `mywebapi`, к которой будет обращаться `webfrontend`. Каждая служба будет выполняться в отдельных контейнерах. Затем вы выполните отладку в обоих контейнерах.

![](media/common/multi-container.png)

## <a name="download-sample-code-for-mywebapi"></a>Скачайте пример кода для *mywebapi*.
Ради экономии времени давайте загрузим образец кода из репозитория GitHub. Перейдите к https://github.com/Azure/dev-spaces и выберите **Clone or download** (Клонировать или скачать), чтобы скачать репозиторий GitHub. Код для этого раздела находится в папке `samples/dotnetcore/getting-started/mywebapi`.

## <a name="run-mywebapi"></a>Запуск *mywebapi*
1. Откройте проект `mywebapi` в *отдельном окне Visual Studio*.
1. Выберите **Azure Dev Spaces** в раскрывающемся списке параметров запуска, как вы это делали ранее для проекта `webfrontend`. Вместо создания новой среды разработки, выберите ту, которую вы уже создали. Как и ранее, для поля "Пространство" оставьте значение по умолчанию (`default`) и нажмите кнопку **ОК**. В окне "Выходные данные" вы можете заметить, что Visual Studio начинает подготавливать эту новую службу в среде разработки, чтобы ускорить работу при начале отладки.
1. Нажмите клавишу F5 и подождите, пока выполнится сборка и развертывание службы. Вы узнаете, что служба готова, когда строка состояния Visual Studio станет оранжевой.
1. Обратите внимание на URL-адрес конечной точки, отображаемый на панели **Azre Dev Spaces for AKS** (Azre Dev Spaces для AKS) в окне **Выходные данные**. Он должен иметь примерно следующий вид: http://localhost:\<portnumber\>. Может показаться, что контейнер выполняется локально, хотя фактически он выполняется в среде разработки в Azure.
2. Когда контейнер `mywebapi` готов, откройте в браузере адрес localhost и добавьте `/api/values` к URL-адресу, чтобы вызвать API GET по умолчанию для `ValuesController`. 
3. Если все шаги были успешными, вы должны увидеть ответ от службы `mywebapi`, который выглядит так:

    ![](media/get-started-netcore-visualstudio/WebAPIResponse.png)

## <a name="make-a-request-from-webfrontend-to-mywebapi"></a>Запрос из *webfrontend* к *mywebapi*
Давайте теперь напишем код в `webfrontend`, который отправляет запрос к `mywebapi`. Переключитесь в окно Visual Studio, в котором есть проект `webfrontend`. В файле `HomeController.cs` *замените* код метода About следующим кодом:

   ```csharp
   public async Task<IActionResult> About()
   {
      ViewData["Message"] = "Hello from webfrontend";

      // Use HeaderPropagatingHttpClient instead of HttpClient so we can propagate
      // headers in the incoming request to any outgoing requests
      using (var client = new HeaderPropagatingHttpClient(this.Request))
      {
          // Call *mywebapi*, and display its response in the page
          var response = await client.GetAsync("http://mywebapi/api/values/1");
          ViewData["Message"] += " and " + await response.Content.ReadAsStringAsync();
      }

      return View();
   }
   ```

Обратите внимание на то, как используется обнаружение службы DNS Kubernetes для обращения к службе в качестве `http://mywebapi`. **Код в вашей среде разработки выполняется так же, как он будет выполняться в рабочей среде**.

В приведенном выше примере кода также используется класс `HeaderPropagatingHttpClient`. Этот вспомогательный класс является файлом `HeaderPropagation.cs`, который был добавлен в ваш проект, когда вы настроили его для использования Azure Dev Spaces. `HeaderPropagatingHttpClient` получен из известного класса `HttpClient` и добавляет функции для распространения определенных заголовков из существующего объекта ASP.NET HttpRequest в исходящий объект HttpRequestMessage. Позже вы увидите, как это повышает эффективность разработки в сценариях командной работы.

## <a name="debug-across-multiple-services"></a>Отладка в нескольких службах
1. На этом этапе служба `mywebapi` по-прежнему должна выполняться с подключенным отладчиком. Если это не так, нажмите клавишу F5 в проекте `mywebapi`.
1. Установите точку останова в методе `Get(int id)` в файле `ValuesController.cs`, который обрабатывает запросы GET `api/values/{id}`.
1. В проекте `webfrontend`, куда вы вставили код выше, установите точку останова до отправки запроса GET к `mywebapi/api/values`.
1. Нажмите клавишу F5 в проекте `webfrontend`. Visual Studio снова откроет в браузере соответствующий порт localhost, и появится веб-приложение.
1. Перейдите по ссылке **About** (Сведения) в верхней части страницы, чтобы вызвать точку останова в проекте `webfrontend`. 
1. Нажмите клавишу F10, чтобы продолжить. Точка останова запустится в проекте `mywebapi`.
1. Нажмите клавишу F5, чтобы продолжить и вернуться в код проекта `webfrontend`.
1. Повторное нажатие клавиши F5 завершит запрос и вернет страницу в браузере. В веб-приложении на странице About (Сведения) будет отображаться объединенное сообщение от двух служб: "Hello from webfrontend and Hello from mywebapi".

Все готово! Теперь у вас есть многоконтейнерное приложение, где каждый контейнер можно разрабатывать и развертывать отдельно.

## <a name="learn-about-team-development"></a>Сведения о коллективной разработке

До сих пор вы запускали код приложения, как если бы вы были единственным разработчиком, работающим над этим приложением. В этом разделе вы узнаете, как Azure Dev Spaces упрощает разработку в команде:
* Дает возможность команде разработчиков работать в одной среде разработки.
* Поддерживает изолированную итерацию кода каждым разработчиком без воздействия на работу команды.
* Позволяет выполнять комплексное тестирование кода перед его фиксацией без необходимости создавать макеты или моделировать зависимости.

### <a name="challenges-with-developing-microservices"></a>Сложности при разработке микрослужб
На данный момент пример вашего приложения не очень сложный. Но в реальном мире проблемы появятся по мере увеличения количества служб и участников команды разработки.

Представьте процесс разработки службы, которая взаимодействует с десятками других служб.

- Выполнение всей разработки в локальной среде может показаться нереальным. У вашего компьютера разработки может не хватить ресурсов для запуска всего приложения. Или, возможно, конечные точки вашего приложения должны быть публично доступными (например, ваше приложение отвечает веб-перехватчику из приложения SaaS).
- Вы можете попытаться запустить только те службы, от которых вы зависите, но это означает, что вам нужно знать все перекрытие зависимостей (например, зависимости зависимостей). Сложность в создании и запуске зависимостей может возникнуть по причине того, что их разрабатывали не вы.
- Некоторые разработчики прибегают к моделированию или макетированию многих зависимостей служб. Иногда это может помочь, но управление этими макетами вскоре может начать отнимать время и ресурсы. Кроме того, это приводит к тому, что ваша среда разработки отличается от рабочей среды и в нее могут проникать несерьезные ошибки.
- По этой причине выполнение любого типа сквозного тестирования становится затруднительным. Фактически интеграционное тестирование можно выполнить только после фиксации, что означает, что вы обнаружите проблемы позже в цикле разработки.

    ![](media/common/microservices-challenges.png)

### <a name="work-in-a-shared-development-environment"></a>Работа в общей среде разработки
В Azure Dev Spaces вы можете настроить *общую среду разработки* в Azure. Каждый разработчик может сосредоточиться только на своей части приложения и может итеративно разрабатывать *код до фиксации* в среде, которая уже содержит все другие службы и облачные ресурсы, от которых зависят сценарии. Зависимости всегда актуальны, и разработчикам следует работать также, как в рабочей среде.

### <a name="work-in-your-own-space"></a>Работа в собственном пространстве
При разработке кода для службы и перед его фиксацией он будет содержать большое количество ошибок. Вы будете итеративно корректировать, тестировать его и экспериментировать с решениями. Azure Dev Spaces предоставляет концепцию **пространства**, которое позволяет работать изолированно, не мешая работе участников вашей команды.

Выполните следующую команду, чтобы убедиться, что службы `webfrontend` и `mywebapi` выполняются в среде разработки  **и в `default`пространстве**.
1. Закройте все сеансы отладки (F5) для обеих служб, но оставьте проекты открытыми в окнах Visual Studio.
2. Переключитесь в окно Visual Studio с проектом `mywebapi` и нажмите клавиши CTRL+F5, чтобы запустить службу без присоединенного отладчика.
3. Переключитесь в окно Visual Studio с проектом `webfrontend` и нажмите клавиши CTRL+F5, чтобы запустить его также.

> [!Note]
> Иногда необходимо обновить браузер после того, как веб-страница изначально отобразится после нажатия клавиш CTRL+F5.

Любой, кто открывает общедоступный URL-адрес и переходит к веб-приложению, будет вызывать написанный вами путь кода, который проходит через обе службы, используя пространство по умолчанию `default`. Предположим, вы хотите продолжить разработку `mywebapi`. Как вы можете это сделать, не вмешиваясь в работу других разработчиков, которые используют эту же среду разработки? Чтобы сделать это, настройте собственное пространство.

### <a name="create-a-new-space"></a>Создание пространства
В среде Visual Studio можно создать дополнительные пространства, которые будут использоваться при нажатии клавиш CTRL+F5 или F5 при работе со службой. Вы можете назвать пространство любым именем (например, `sprint4` или `demo`).

Для создания пространства выполните следующие действия:
1. Переключитесь в окно Visual Studio, в котором есть проект `mywebapi`.
2. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Свойства**.
3. Выберите вкладку **Отладка** слева, чтобы отобразить параметры Azure Dev Spaces.
4. Здесь можно изменить или создать кластер и/или пространство, которое будет использоваться при нажатии клавиш CTRL+F5 или F5. *Убедитесь, что выбрано ранее созданное пространство Azure Dev Space*.
5. В раскрывающемся списке пространства выберите **<Create New Space…>** (Создать новое пространство…).

    ![](media/get-started-netcore-visualstudio/Settings.png)

6. В диалоговом окне **Add Space** (Добавление пространства) введите имя для пространства и нажмите кнопку **ОК**. Вы можете использовать свое имя (например, "scott") для нового пространства, чтобы люди, которые работают в одной среде с вами, могли идентифицировать ваше пространство.

    ![](media/get-started-netcore-visualstudio/AddSpace.png)

7. Теперь вы должны увидеть свою среду разработки и новое пространство, выбранное на странице свойств проекта.

    ![](media/get-started-netcore-visualstudio/Settings2.png)

### <a name="update-code-for-mywebapi"></a>Обновление кода *mywebapi*

1. В проекте `mywebapi` измените код на метод `string Get(int id)` в файле `ValuesController.cs` следующим образом:
 
    ```csharp
    [HttpGet("{id}")]
    public string Get(int id)
    {
        return "mywebapi now says something new";
    }
    ```

2. Установите точку останова в этом обновленном блоке кода (это может быть точка, созданная ранее).
3. Нажмите клавишу F5 для запуска службы `mywebapi`. В вашей среде разработки будет запущена служба с использованием выбранного пространства. В этом случае `scott`.

Ниже приведена схема, которая поможет вам понять, как работают разные пространства. Синий путь показывает запрос через пространство `default`, которое используется по умолчанию, если к URL-адресу не добавлено пространство. Зеленый путь показывает запрос через пространство `scott`.

![](media/common/Space-Routing.png)

Эта встроенная возможность Azure Dev Spaces позволяет выполнять комплексное тестирование кода в общей среде, не требуя от каждого разработчика повторно создавать множество служб в своем пространстве. Для такой маршрутизации требуется, чтобы заголовки распространения передавались в код приложения, как показано на предыдущем шаге этого руководства.

### <a name="test-code-running-in-the-scott-space"></a>Тестирование кода, выполняемого в пространстве `scott`
Чтобы проверить свою новую версию `mywebapi` в сочетании с `webfrontend`, откройте в браузере URL-адрес общедоступной точки доступа `webfrontend` (например, http://webfrontend-teamenv.123456abcdef.eastus.aksapp.io)) и перейдите на страницу About (Сведения). Вы увидите исходное сообщение "Hello from webfrontend and Hello from mywebapi".

Теперь добавьте часть "scott.s" в URL-адрес, чтобы получилось http://scott.s.webfrontend-teamenv.123456abcdef.eastus.aksapp.io, и обновите браузер. Должна сработать точка останова, заданная в проекте `mywebapi`. Нажмите клавишу F5, чтобы продолжить. В браузере вы должны увидеть новое сообщение "Hello from webfrontend and mywebapi now says something new". Это происходит, так как путь к обновленному коду в `mywebapi` используется в пространстве `scott`.

[!INCLUDE[](includes/well-done.md)]

[!INCLUDE[](includes/clean-up.md)]
