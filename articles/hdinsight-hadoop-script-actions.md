<properties 
	pageTitle="Разработка действий скриптов с помощью HDInsight| Azure" 
	description="Дополнительные сведения о настройке кластеров Hadoop с помощью действия скрипта." 
	services="hdinsight" 
	documentationCenter="" 
	authors="bradsev" 
	manager="paulettm" 
	editor="cgronlun"/>

<tags 
	ms.service="hdinsight" 
	ms.workload="big-data" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="12/19/2014" 
	ms.author="bradsev"/> 

# Разработка действий скриптов с помощью HDInsight 

Действия скриптов (Script Actions) предоставляют функциональные возможности Azure HDInsight, которые используются для установки дополнительного программного обеспечения, работающего в кластере Hadoop, или для изменения конфигурации приложений, установленных в кластере. Script Actions - это скрипты, выполняемые на узлах кластера во время развертывания кластеров HDInsight. Они будут выполнены, как только узлы в кластере завершат конфигурацию HDInsight. Действие скрипта выполняется из учетной записи с полномочиями системного администратора и предоставляет права полного доступа к узлам кластера. Каждый кластер может обеспечиваться перечнем действий скриптов для их выполнения в указанном порядке.

Script Action можно развернуть с помощью пакета SDK для HDInsight .NET или Azure PowerShell.  Дополнительные сведения см. в разделе [Настройка кластера HDInsight с помощью действий скриптов][hdinsight-cluster-customize].


## Содержание

- [Рекомендации по разработке скриптов](#bestPracticeScripting)
- [Вспомогательные методы для пользовательских скриптов](#helpermethods)
- [Контрольный список для развертывания Script Action](#deployScript)
- [Запуск Script Action](#runScriptAction)
- [Образцы пользовательских скриптов](#sampleScripts) 
- [Способы проверки пользовательского скрипта с использованием эмулятора HDInsight](#testScript)
- [Способы отладки пользовательского скрипта](#debugScript)
- [Дополнительные материалы](#seeAlso)


## <a name="bestPracticeScripting"></a>Рекомендации по разработке скриптов

При разработке пользовательского скрипта для кластера HDInsight следует иметь в виду некоторые рекомендации.

* [Проверка версии Hadoop](#bPS1)
* [Стабильные ссылки на ресурсы скрипта](#bPS2)
* [Скрипт настройки кластера должен быть идемпотентным](#bPS3)
* [Расположение установленных пользовательских компонентов ](#bPS4)
* [Архитектура кластера: обеспечения высокого уровня доступности](#bPS5)
* [Настройка пользовательских компонентов для использования WASB](#bPS6)

### <a name="bPS1"></a>Проверка версии Hadoop
Только HDInsight версии 3.1 (Hadoop 2.4) и выше поддерживает использование действия скрипта для установки пользовательских компонентов в кластере. В пользовательском скрипте необходимо использовать вспомогательный метод **Get HDIHadoopVersion** для проверки версии Hadoop, и только затем продолжить выполнение других задач в скрипте.


### <a name="bPS2"></a>Стабильные ссылки на ресурсы скрипта 
Пользователям следует убедиться, что все скрипты и другие артефакты, используемые при настройке кластера, доступны в период существования кластера и версии этих файлов не изменялись на протяжении данного периода. Эти ресурсы необходимы, если требуется восстановить узлы в кластере из образа. Рекомендуется скачивать и архивировать все материалы в учетную запись хранения, управляемую пользователем. Это может быть учетная запись хранения по умолчанию или любые дополнительные учетные записи хранения, указанные во время развертывания настроенного кластера.
В приведенных в документации примерах настроенного кластера Spark и R мы создали локальную копию ресурсов в этой учетной записи хранения: https://hdiconfigactions.blob.core.windows.net/.


### <a name="bPS3"></a>Скрипт настройки кластера должен быть идемпотентным
Нужно допускать, что потребуется восстановить из образа узлы кластера HDInsight в период существования этого кластера. Скрипт настройки кластера выполняется при каждом восстановлении кластера из образа. Этот скрипт должен быть рассчитан на идемпотентность. Имеется в виду, что при восстановлении из образа скрипт обеспечивает возврат кластера к прежним настройкам, присущим ему во время первого запуска скрипта после изначального создания этого кластера. Например, если пользовательский скрипт во время своего первого запуска установил приложение в папку D:\AppLocation, то при каждом последующем запуске и восстановлении из образа скрипт должен проверить, существует ли приложение в папке D:\AppLocation, и только после этого переходить к следующим шагам.


### <a name="bPS4"></a>Расположение установленных пользовательских компонентов 
Если узлы кластера восстанавливаются из образа, диск ресурсов C:\ и системный диск D:\ могут быть переформатированы, что приведет к потере находящихся на них данных и приложений. Это также может произойти, если узел виртуальной машины Azure, являющийся частью кластера, выходит из строя и заменяется новым узлом. Компоненты можно установить на диске D:\ или в папке C:\apps на кластере. Все расположения на диске C:\ зарезервированы. Укажите расположение, где должны устанавливаться приложения или библиотеки в рамках скрипта настройки кластера. 


### <a name="bPS5"></a>Архитектура кластера: обеспечения высокого уровня доступности

В целях обеспечения высокой доступности HDInsight имеет активно-пассивную архитектуру, в которой один головной узел находится в активном режиме (где выполняются службы HDInsight), а другой головной узел находится в режиме ожидания (на нем службы HDInsight не запущены). Узлы переключаются между активным и пассивным режимами в случае сбоев в службах службы HDInsight. Если с помощью действия скрипта на обоих головных узлах устанавливаются службы для обеспечения высокой доступности, следует помнить о том, что механизм отработки отказа HDInsight не сможет автоматически выполнить отработку отказа для этих установленных пользователем служб. Поэтому службы HDInsight, установленные пользователем на головных узлах, к которым предъявляется требование высокой доступности, должны иметь собственный механизм отработки отказа в режиме "активный - пассивный" или должны работать в режиме "активный - активный". 

Команда действия скрипта HDInsight выполняется на обоих головных узлах, если роль головного узла указана в качестве значения параметра *ClusterRoleCollection* (см. раздел [Запуск Script Action](#runScriptAction) ниже). Поэтому при разработке пользовательского скрипта убедитесь, что в скрипте учтены эти особенности установки. Не следует создавать проблемы, устанавливая и запуская на обоих головных узлах одинаковые службы, которые в итоге будут конкурировать друг с другом. Кроме того, нужно помнить о том, что программное обеспечение, установленное с помощью действий скриптов, должно быть устойчивым к таким сбоям, как потеря данных при восстановлении из образа. Приложения должны быть рассчитаны на работу с высокодоступными данными, распределенными на множестве узлов. Обратите внимание, что как минимум пятая часть узлов в кластере может быть восстановлена из образа одновременно.


### <a name="bPS6"></a>Настройка пользовательских компонентов для использования WASB
Конфигурация по умолчанию для пользовательских компонентов, устанавливаемых на узлах кластера, может предполагать использование хранилища HDFS. Следует изменить конфигурацию, чтобы в ней использовалось хранилища BLOB-объектов Azure (WASB). При восстановлении кластера из образа файловая система HDFS форматируется, в результате чего будут потеряны все хранящиеся в ней данные. Используя вместо этого WASB, вы обеспечиваете сохранность таких данных.

## <a name="helpermethods"></a>Вспомогательные методы для пользовательских скриптов 

Действие скрипта предоставляет следующие вспомогательные методы, которые можно использовать при создании пользовательских скриптов.

Вспомогательный метод | Описание
-------------- | -----------
**Save-HDIFile** | Скачивает файл с указанным URI в расположение на локальном диске, который сопоставлен с узлом ВМ Azure, назначенным данному кластеру
**Expand-HDIZippedFile** | Распаковывает ZIP-файл
**Invoke-HDICmdScript** | Запускает скрипт из cmd.exe
**Write-HDILog** | Записывает выходные данные из пользовательского скрипта, используемого для действия скрипта
**Get-Services** | Получает список служб, запущенных на том компьютере, где выполняется скрипт
**Get-Service** | Используя имя определенной службы в качестве входных данных, возвращает подробные сведения об этой службе (имя службы, идентификатор процесса, состояние и т. п.) на том компьютере, где выполняется скрипт
**Get-HDIServices** | Получает список служб HDInsight, запущенных на том компьютере, где выполняется скрипт
**Get-HDIService** | Используя имя определенной службы HDInsight в качестве входных данных, возвращает подробные сведения об этой службе (имя службы, идентификатор процесса, состояние и т. п.) на том компьютере, где выполняется скрипт
**Get-ServicesRunning** | Получает список служб, запущенных на том компьютере, где выполняется скрипт
**Get-ServiceRunning** | Проверяет, запущена ли служба с определенным именем на том компьютере, где выполняется скрипт
**Get-HDIServicesRunning** | Получает список служб HDInsight, запущенных на том компьютере, где выполняется скрипт
**Get-HDIServiceRunning** | Проверяет, запущена ли служба HDInsight с определенным именем на том компьютере, где выполняется скрипт
**Get-HDIHadoopVersion** | Получает версию Hadoop, установленную на том компьютере, где выполняется скрипт
**Test-IsHDIHeadNode** | Проверяет, является ли тот компьютер, где выполняется скрипт, головным узлом
**Test-IsActiveHDIHeadNode** | Проверяет, является ли тот компьютер, где выполняется скрипт, активным головным узлом
**Test-IsHDIDataNode** | Проверяет, является ли тот компьютер, где выполняется скрипт, узлом данных
**Edit-HDIConfigFile** | Изменяет файлы конфигурации hive-site.xml, core-site.xml, hdfs-site.xml, mapred-site.xml или yarn-site.xml
 

## <a name="deployScript"></a>Контрольный список для развертывания Script Action
Ниже приведены шаги, которые использовались при подготовке к развертыванию этих скриптов.

1. Поместите файлы, содержащие пользовательские скрипты, в месте, доступном из узлов кластера во время развертывания. Это может быть любая из используемых по умолчанию или дополнительных учетных записей хранения, указанных во время развертывания кластера, либо любой другой общедоступный контейнер хранилища.
2. Добавьте проверки в скрипты, чтобы гарантировать, что они выполняются идемпотентно, а значит, скрипт сможет многократно выполняться на одном и том же узле.
3. Используйте командлет Powershell **Write-Output** для печати в STDOUT и STDERR. Не используйте **Write-Host**.
4. Используйте папку для временных файлов, например $env: TEMP, чтобы сохранить скачанный файл, используемый скриптом. После выполнения скриптов очистите папку.
5. Устанавливайте пользовательское программное обеспечения только в следующих расположениях: D:/ или C:/apps. Не следует производить установку в другие расположения на диске C:, так как они зарезервированы. Обратите внимание, что установка файлов на диске C: вне папки C:/apps может привести к сбою установки во время восстановления узла из образа.
6. В случае изменений параметров на уровне операционной системы или файлов конфигурации службы Hadoop может потребоваться перезапуск служб HDInsight. За счет этого службы HDInsight смогут автоматически установить любые параметры уровня операционной системы, например заданные в скриптах переменные среды.


## <a name="runScriptAction"></a>Запуск Script Action

Действия скриптов можно использовать для настройки кластеров HDInsight с помощью портала управления Azure, PowerShell или пакета SDK HDInsight .NET. Инструкции см. в разделе [Использование действия скрипта](./hdinsight-hadoop-customize-cluster/#howto). 


## <a name="sampleScripts"></a>Образцы пользовательских скриптов

Корпорация Майкрософт предоставляет примеры скриптов для установки компонентов в кластере HDInsight. Примеры скриптов и инструкции по их использованию доступны по приведенным ниже ссылкам:

- [Установка и использование Spark 1.0 на кластерах HDInsight][hdinsight-install-spark]
- [Установка и использование R на кластерах HDInsight Hadoop][hdinsight-r-scripts]
- [Установка и использование Solr в кластерах HDInsight](../hdinsight-hadoop-solr-install)
- [Установка и использование Giraph в кластерах HDInsight](../hdinsight-hadoop-giraph-install)  

> [AZURE.NOTE] Пример скрипта работает только с кластером HDInsight версии 3.1 или более поздней. Дополнительные сведения о версиях кластера HDInsight см. в разделе [Версии кластера HDInsight](http://azure.microsoft.com/ru-ru/documentation/articles/hdinsight-component-versioning/).

## <a name="testScript"></a>Способы проверки пользовательского скрипта с использованием эмулятора HDInsight

Простой способ тестирования пользовательского скрипта перед его использованием в команде действия скрипта HDInsight заключается в запуске этого скрипта в эмуляторе HDInsight. Эмулятор можно установить на локальном компьютере или в виртуальной машине Azure IaaS Windows Server 2012 R2. Помните, что Windows Server 2012 R2 - это такая же виртуальная машина, которую HDInsight использует для узлов.

В этом разделе описаны процедуры локального использования эмулятора HDInsight для проведения тестирования, однако в виртуальной машине тестирование проводится аналогичным образом.

**Установите эмулятор HDInsight**: чтобы запустить действия скриптов локально, необходим установленный эмулятор HDInsight. Инструкции по его установке см. в разделе [Приступая к работе с эмулятором HDInsight](http://azure.microsoft.com/ru-ru/documentation/articles/hdinsight-get-started-emulator/)

**Задайте политику выполнения для Azure PowerShell:** откройте Microsoft Azure PowerShell и выполните (с правами администратора) следующую команду, чтобы задать политику выполнения *LocalMachine* со значением *Unrestricted*.
 
	Set-ExecutionPolicy Unrestricted -Scope LocalMachine

Эта политика должна быть неограниченной, так как скрипты не подписаны.

**Скачайте действие скрипта**, которое требуется выполнить, в локальное расположение. Скрипты Spark и R, которые можно выполнять локально, доступны, например, по следующим ссылкам:

* https://hdiconfigactions.blob.core.windows.net/sparkconfigactionv02/spark-installer-v02.ps1
* https://hdiconfigactions.blob.core.windows.net/rconfigactionv02/r-installer-v02.ps1

**Запустите скрипты действий**: откройте новый экземпляр Azure PowerShell в режиме администратора и запустите скрипт установки Spark или R из локального расположения, где он был сохранен.

**Примеры использования**
При использовании кластеров Spark и R необходимые файлы данных могут отсутствовать в эмуляторе HDInsight, поэтому может потребоваться передать соответствующие TXT-файлы с данными по некоторому пути в HDFS и затем использовать этот путь для доступа к данным. Например:

	val file = sc.textFile("/example/data/gutenberg/davinci.txt")


Обратите внимание, что в некоторых случаях пользовательский скрипт может фактически зависеть от компонентов HDInsight, таких как идентификация активности определенных служб Hadoop. В этом случае необходимо проверить пользовательские скрипты, развернув их на фактическом кластере HDInsight.


## <a name="debugScript"></a>Способы отладки пользовательского скрипта

Журналы ошибок скрипта хранятся вместе с другими выходными данными в учетной записи хранения по умолчанию, заданной для кластера при его создании. Журналы хранятся в таблице с именем *u<\cluster-name-fragment><\time-stamp>setuplog*. Это статистические журналы, содержащие записи из всех узлов (рабочих и главного), на которых выполняется сценарий в кластере.

Вы также можете осуществить удаленный доступ к узлам кластера для просмотра пользовательских скриптов STDOUT и STDERR. Журналы на каждом узле относятся только к данному конкретному узлу и хранятся в **C:\HDInsightLogs\DeploymentAgent.log**. В эти файлы журналов записываются все выходные данные пользовательского скрипта. Фрагмент журнала для Spark Script Action выглядит, как в следующем примере:

	Microsoft.Hadoop.Deployment.Engine.CustomPowershellScriptCommand; Details : BEGIN: Invoking powershell script https://configactions.blob.core.windows.net/sparkconfigactions/spark-installer.ps1.; 
	Version : 2.1.0.0; 
	ActivityId : 739e61f5-aa22-4254-aafc-9faf56fc2692; 
	AzureVMName : HEADNODE0; 
	IsException : False; 
	ExceptionType : ; 
	ExceptionMessage : ; 
	InnerExceptionType : ; 
	InnerExceptionMessage : ; 
	Exception : ;
	...

	Starting Spark installation at: 09/04/2014 21:46:02 Done with Spark installation at: 09/04/2014 21:46:38;
	
	Version : 2.1.0.0; 
	ActivityId : 739e61f5-aa22-4254-aafc-9faf56fc2692; 
	AzureVMName : HEADNODE0; 
	IsException : False; 
	ExceptionType : ; 
	ExceptionMessage : ; 
	InnerExceptionType : ; 
	InnerExceptionMessage : ; 
	Exception : ;
	...
	
	Microsoft.Hadoop.Deployment.Engine.CustomPowershellScriptCommand; 
	Details : END: Invoking powershell script https://configactions.blob.core.windows.net/sparkconfigactions/spark-installer.ps1.; 
	Version : 2.1.0.0; 
	ActivityId : 739e61f5-aa22-4254-aafc-9faf56fc2692; 
	AzureVMName : HEADNODE0; 
	IsException : False; 
	ExceptionType : ; 
	ExceptionMessage : ; 
	InnerExceptionType : ; 
	InnerExceptionMessage : ; 
	Exception : ;

 
Из данных журнала следует, что действие скрипта Spark было выполнено на виртуальной машине с именем HEADNODE0 и во время выполнения исключения не возникали.

В случае сбоя при выполнении, в файле журнала будут содержаться выходные данные со сведениями о нем. Информация в этих журналах может быть полезной при отладке скрипта.


## <a name="seeAlso"></a>Дополнительные материалы

[Настройка кластеров HDInsight с помощью действия скрипта][hdinsight-cluster-customize] 


[hdinsight-provision]: ../hdinsight-provision-clusters/
[hdinsight-cluster-customize]: ../hdinsight-hadoop-customize-cluster
[hdinsight-install-spark]: ../hdinsight-hadoop-spark-install/
[hdinsight-r-scripts]: ../hdinsight-hadoop-r-scripts/
[powershell-install-configure]: ../install-configure-powershell/
<!--HONumber=42-->
