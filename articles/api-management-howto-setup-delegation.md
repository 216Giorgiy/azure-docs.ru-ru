<properties pageTitle="How to delegate user registration and product subscription" metaKeywords="" description="Learn how to delegate user registration and product subscription to a third party in Azure API Management." metaCanonical="" services="" documentationCenter="API Management" title="How to delegate user registration and product subscription in Azure API Management" authors="antonba" solutions="" manager="" editor="" />

<tags ms.service="api-management" ms.workload="mobile" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="antonba"></tags>

# Как делегировать регистрацию пользователя и подписку на продукт

Делегирование позволяет использовать ваш существующий веб-сайт для обработки входа и регистрации разработчика и подписки на продукты вместо применения встроенной функции на портале разработчика. Это позволяет вашему веб-сайту владеть пользовательскими данными и проверять достоверность этих шагов настраиваемым образом.

## Содержание раздела

-   [Делегирование входа и регистрации разработчика][Делегирование входа и регистрации разработчика]
-   [Делегирование подписки на продукт][Делегирование подписки на продукт]

## <a name="delegate-signin-up"> </a>Делегирование входа и регистрации разработчика

Для делегирования входа и регистрации разработчика на существующем веб-сайте будет нужно создавать специальную конечную точку делегирования на своем сайте, которая действует как точка входа для любого подобного запроса, инициируемого с портала разработчика API Management.

Итоговый рабочий процесс будет иметь следующий вид:

1.  Разработчик щелкает ссылку для входа или регистрации на портале разработчика API Management
2.  Браузер перенаправляется в конечную точку делегирования
3.  В свою очередь, конечная точка делегирования перенаправляется или представляет интерфейс пользователя, который предлагает пользователю войти в систему или зарегистрироваться
4.  При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Сначала следует настроить API Management так, чтобы он направлял запросы через конечную точку делегирования. На портале API Management Publisher под заголовком **Портал разработчика** в расположенном слева меню, щелкните **Делегирование**, а затем **Делегировать вход и регистрацию**.

![Страница «Делегирование»][Страница «Делегирование»]

-   Выберите для себя нужный URL-адрес своей специальной конечной точки делегирования и введите его в поле **URL-адрес конечной точки делегирования**.

-   В поле **Ключ проверки подлинности делегирования** введите секретный ключ, который будет использоваться для вычисления сигнатуры, благодаря которой будет можно убедиться, что запрос действительно поступает из Azure API Management.

Теперь необходимо создать **конечную точку делегирования**. Для этого следует выполнить несколько действий:

1.  Получите запрос в следующей форме:

    > *<http://www.yourwebsite.com/apimdelegation?operation=SignIn&redirectUrl>={URL-адрес исходной страницы}&salt={строка}&sid={строка}*

    Запросите параметры для входа или регистрации:

    -   **operation**: идентифицирует тип запроса на делегирование (в этом случае может быть только «SignIn»)
    -   **redirectUrl**: URL-адрес страницы, на которой пользователь щелкнул ссылку входа или регистрации
    -   **salt**: специальная «соленая строка», используемая для вычисления хэша безопасности
    -   **sig**: вычисленный хэш безопасности, который должен использоваться для сравнения с вашим собственным вычисленным хэшем

2.  Убедитесь, что запрос поступает из Azure API Management (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

    -   Вычислите хэш HMAC-SHA512 строки на основании параметров запроса **redirectUrl** и **salt**:

        > HMAC(**redirectUrl** + '\\n' + **salt**)

    -   Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. В противном случае, отклоните запрос.

3.  Убедитесь, что вы получаете запрос на вход или регистрацию: параметр запроса **operation** будет иметь значение **SignIn**.

4.  Предоставление пользователю интерфейса для входа или регистрации

5.  Если пользователь регистрируется, для него необходимо создать соответствующую учетную запись в API Management. Выполните операцию [Создание пользователя][Создание пользователя] с помощью интерфейса API Management REST API. После этого убедитесь, что вы ввели тот же идентификатор пользователя, что и идентификатор, который указан в вашем хранилище пользователей, или идентификатор, который можно отслеживать.

6.  После успешной проверки подлинности пользователя:

    -   [запросите маркер единого входа (SSO)][запросите маркер единого входа (SSO)] через API Management REST API

    -   добавьте параметр запроса returnUrl в URL-адреса SSO, который вы получили из вызова API, указанного выше:

        > например, <https://customer.portal.azure-api.net/signin-sso?token&returnUrl=/return/url>

    -   перенаправьте пользователя на вышеупомянутый URL-адрес

## <a name="delegate-product-subscription"> </a>Делегирование подписки на продукт

Делегирование подписки на продукт похоже на делегированию входа/регистрации пользователя. Итоговый рабочий процесс будет иметь следующий вид:

1.  Разработчик выбирает продукт на портале разработчика API Management и щелкает кнопку «Подписка»
2.  Браузер перенаправляется в конечную точку делегирования
3.  Конечная точка делегирования выполняет требуемые шаги подписки на продукт. Эту процедуру выполняете вы. В нее могут входить перенаправление на другую страницу для запроса сведений о выставлении счетов, формулирование дополнительных вопросов или просто сохранение информации без выполнения действий пользователя
4.  При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Чтобы включить функцию на странице **Делегирование** щелкните **Делегировать подписку на продукт**.

Затем убедитесь, что конечная точка делегирования выполняет следующие действия:

1.  Получите запрос в следующей форме:

    > *<http://www.yourwebsite.com/apimdelegation?operation>={operation}&productId={продукт, подлежащий подписке}&userId={пользователь, выполняющий запрос}&salt={строка}&sid={строка}*

    Параметры запроса для подписки на продукт:

    -   **operation**: идентифицирует тип запроса на делегирование. Для запросов подписки на продукт допустимыми являются следующие параметры:

        -   "Subscribe": запрос подписки пользователя на заданный продукт с предоставленным идентификатором (см. ниже)
        -   "Unsubscribe": запрос отказа от подписки пользователя на продукт
        -   "Renew": запрос на обновление подписки (например, в случае истечения срока)
    -   **productId**: идентификатор продукта, подписку на который запрашивает пользователь
    -   **userId**: идентификатор пользователя, для которого отправлен запрос
    -   **salt**: специальная «соленая строка», используемая для вычисления хэша безопасности
    -   **sig**: вычисленный хэш безопасности, который должен использоваться для сравнения с вашим собственным вычисленным хэшем

2.  Убедитесь, что запрос поступает из Azure API Management (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

    -   Вычислите хэш HMAC-SHA512 строки на основании параметров запроса **productId**, **userId** и **salt**:

        > HMAC(**productId** + '\\n' + **userId** + '\\n' + **salt**)

    -   Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. В противном случае, отклоните запрос.

3.  Выполните процедуру обработки подписки на продукт на основании типа операции, запрашиваемой в параметре **operation** - например, выставление счетом, дополнительные вопросы и т. д.

4.  В случае успешной подписки пользователя на продукт на вашей стороне подпишите пользователя на продукт API Management путем [вызова интерфейса REST API для подписки на продукт][вызова интерфейса REST API для подписки на продукт].

5.  Перенаправьте пользователя обратно на адрес **redirectUrl**, который был указан при получении запроса.

  [Делегирование входа и регистрации разработчика]: #delegate-signin-up
  [Делегирование подписки на продукт]: #delegate-product-subscription
  [Страница «Делегирование»]: ./media/api-management-howto-setup-delegation/api-management-delegation-signin-up.png
  [Создание пользователя]: http://go.microsoft.com/fwlink/?LinkId=507655#CreateUser
  [запросите маркер единого входа (SSO)]: http://go.microsoft.com/fwlink/?LinkId=507409
  [вызова интерфейса REST API для подписки на продукт]: http://go.microsoft.com/fwlink/?LinkId=507655#SSO
