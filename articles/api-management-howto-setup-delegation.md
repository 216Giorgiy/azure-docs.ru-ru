<properties pageTitle="Как делегировать регистрацию пользователя и подписку на продукт" metaKeywords="" description="Learn how to delegate user registration and product subscription to a third party in Azure API Management." metaCanonical="" services="api-management" documentationCenter="API Management" title="How to delegate user registration and product subscription in Azure API Management" authors="antonba" solutions="" manager="dwrede" editor="" />

<tags ms.service="api-management" ms.workload="mobile" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="antonba" />

# Как делегировать регистрацию пользователя и подписку на продукт

Делегирование позволяет выполнять обработку входа и регистрации разработчика и подписку на продукты с помощью вашего существующего веб-сайта, а не с помощью встроенной функции на портале разработчика. В результате этого веб-сайт будет владеть пользовательскими данными и проверять эти шаги в соответствии с вашими настройками.


## Содержание раздела

-   [Делегирование входа и регистрации разработчика][]
-   [Делегирование подписки на продукт][]

## <a name="delegate-signin-up"> </a>Делегирование входа и регистрации разработчика

Для делегирования входа и регистрации разработчика на существующем веб-сайте будет нужно создавать специальную конечную точку делегирования на своем сайте, которая действует как точка входа для любого подобного запроса, инициируемого с портала разработчика API Management.

Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик щелкает ссылку для входа или регистрации на портале разработчика API Management
2. Браузер перенаправляется в конечную точку делегирования
3. В свою очередь, конечная точка делегирования перенаправляется или представляет интерфейс пользователя, который предлагает пользователю войти в систему или зарегистрироваться
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс


Сначала следует настроить API Management так, чтобы он направлял запросы через вашу конечную точку делегирования. На портале издателя API Management щелкните **Безопасность** и перейдите на вкладку **Делегирование**. Для активации параметра "Делегирование входа и регистрации" установите соответствующий флажок.

![Delegation page][api-management-delegation-signin-up]

* Выберите необходимый URL-адрес своей специальной конечной точки делегирования и введите его в поле**URL-адрес конечной точки делегирования**. 

* В поле **Ключ проверки подлинности делегирования** введите секретный ключ для вычисления сигнатуры, благодаря которой можно будет убедиться, что запрос действительно поступает из Azure API Management. Можно нажать кнопку **создать** - и API Management сгенерирует для вас случайный ключ.

Теперь необходимо создать **конечную точку делегирования**. Для этого следует выполнить несколько действий.

1. Получите запрос в следующей форме:

	> *http://www.yourwebsite.com/apimdelegation?operation=SignIn&returnUrl={URL of source page}&salt={string}&sid={string}*

	Запросите параметры для входа или регистрации:
	- **operation**: идентифицирует тип запроса на делегирование (в данном случае может быть только SignIn)
	- **returnUrl**: URL-адрес страницы, на которой пользователь щелкнул ссылку входа или регистрации
	- **salt**: специальная строка соли, используемая для вычисления хэша безопасности
	- **sig**: вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем

2. Убедитесь, что запрос поступает из Azure API Management (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

	* Вычислите хэш HMAC-SHA512 строки на основе **returnUrl** и параметров запроса **salt** ([на приведенном ниже примере кода]).
        > Код HMAC(**salt** + '\n' + **returnUrl**)
		 
	* Сравните вычисленный выше хэш со значением параметра запроса**sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.

2. Убедитесь, что вы получаете запрос на вход или регистрацию: параметр запроса **operation** должен иметь значение **SignIn**.

3. Предоставление пользователю интерфейса для входа или регистрации

4. Если пользователь регистрируется, для него необходимо создать соответствующую учетную запись в API Management. Выполните операцию [Создание пользователя] с помощью интерфейса API Management REST API. После этого убедитесь, что введенный вами идентификатор пользователя совпадает с идентификатором, указанным в вашем хранилище пользователей, или с идентификатором, который можно отслеживать.

5. После успешной проверки подлинности пользователя:

	* [запросите маркер единого входа (SSO)] через API Management REST API

	* добавьте параметр запроса returnUrl в URL-адреса SSO, который вы получили из вызова API, указанного выше:
		> например, https://customer.portal.azure-api.net/signin-sso?token&returnUrl=/return/url 

	* перенаправьте пользователя на вышеупомянутый URL-адрес


## <a name="delegate-product-subscription"> </a>Делегирование подписки на продукт

Процедура делегирования подписки на продукт похожа на процедуру делегирования входа или регистрации пользователя. Итоговый рабочий процесс будет иметь следующий вид.

1. Разработчик выбирает продукт на портале разработчика API Management и щелкает кнопку "Подписка"
2. Браузер перенаправляется в конечную точку делегирования
3. Конечная точка делегирования выполняет требуемые шаги подписки на продукт. Эту процедуру выполняете вы. В нее могут входить перенаправление на другую страницу для запроса сведений о выставлении счетов, формулирование дополнительных вопросов или просто сохранение информации без выполнения действий пользователя
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Чтобы включить функцию на странице **Делегирование**, щелкните **Делегировать подписку на продукт**.

Затем убедитесь, что конечная точка делегирования выполняет следующие действия:


1. Получите запрос в следующей форме:

	> *http://www.yourwebsite.com/apimdelegation?operation={operation}&productId={product to subscribe to}&userId={user making request}&salt={string}&sid={string}*

	Параметры запроса для подписки на продукт:
	- **operation**: идентифицирует тип запроса на делегирование. Допустимые параметры для запросов подписки на продукт указаны ниже.
		- "Подписаться": запрос подписки пользователя на указанный продукт с предоставленным идентификатором (см. ниже)
		- "Отказаться от подписки": запрос отказа от подписки пользователя на продукт
		- "Возобновить": запрос на возобновление подписки (например, в случае истечения срока действия)
	- **productId**: идентификатор продукта, подписку на который запрашивает пользователь
	- **userId**: идентификатор пользователя, которому отправлен запрос
	- **salt**: специальная строка соли, используемая для вычисления хэша безопасности
	- **sig**: вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем


2. Убедитесь, что запрос поступает из Azure API Management (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

	* Вычислите хэш HMAC-SHA512 строки на основании параметров запроса **productId**, **userId** и **salt**.
		> HMAC(**salt** + '\n' + **productId** + '\n' + **userId**)
		 
	* Сравните вычисленный выше хэш со значением параметра запроса**sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.
	
3. Выполните процедуру обработки подписки на продукт на основании типа операции, запрашиваемой в параметре **operation**, например выставление счета, дополнительные вопросы и т. д.

4. В случае успешной подписки пользователя на продукт на вашей стороне подпишите пользователя на продукт API Management путем [вызова интерфейса REST API].

5. Перенаправьте пользователя обратно на адрес **redirectUrl**, который был указан при получении запроса.

## <a name="delegate-example-code"> </a> Пример кода ##

В этих примерах кода показано, как получить *ключ проверки делегирования*, который устанавливается на странице делегирования портала API Management, и как создать HMAC, который затем используется для проверки подписи, подтверждающей действительность переданного returnUrl. Тот же код с незначительными изменениями подходит для productId и userId.

**Код C# для создания хэша returnUrl**

	using System.Security.Cryptography;

	string key = "delegation validation key";
	string returnUrl = "returnUrl query parameter";
	string salt = "salt query parameter";
	string signature;
	using (var encoder = new HMACSHA512(Convert.FromBase64String(key)))
	{
		signature = encoder.ComputeHash(Encoding.UTF8.GetBytes(salt + "\n" + returnUrl));
		// change to (salt + "\n" + productId + "\n" + userId) for point 2 above
	}

**Код NodeJS для создания хэша returnUrl**

	var crypto = require('crypto');
	
	var key = 'delegation validation key'; 
	var returnUrl = 'returnUrl query parameter';
	var salt = 'salt query parameter';
	
	var hmac = crypto.createHmac('sha512', new Buffer(key, 'base64'));
	var digest = hmac.update(salt + '\n' + returnUrl).digest();
	// change to (salt + '\n' + productId + '\n' + userId) for point 2 above
	
	var signature = digest.toString('base64');

[Делегирование входа и регистрации разработчика]: #delegate-signin-up
[Делегирование подписки на продукт]: #delegate-product-subscription
[запрос маркера единого входа (SSO)]: http://go.microsoft.com/fwlink/?LinkId=507409
[создание пользователя]: http://go.microsoft.com/fwlink/?LinkId=507655#CreateUser
[вызов API REST для подписки на продукт]: http://go.microsoft.com/fwlink/?LinkId=507655#SSO
[Дальнейшие действия]: #next-steps
[пример кода приведен ниже]: #delegate-example-code

[api-management-delegation-signin-up]: ./media/api-management-howto-setup-delegation/api-management-delegation-signin-up.png
