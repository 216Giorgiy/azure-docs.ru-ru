<properties
   pageTitle="Выполнение запланированной задачи очистки с помощью функций Azure | Microsoft Azure"
   description="Использование функций Azure для создания функции C#, которая срабатывает по таймеру событий."
   services="azure-functions"
   documentationCenter="na"
   authors="ggailey777"
   manager="erikre"
   editor=""
   tags=""
   />

<tags
   ms.service="functions"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="multiple"
   ms.workload="na"
   ms.date="06/05/2016"
   ms.author="glenga"/>
   
# Выполнение запланированной задачи очистки с помощью функций Azure

В этой статье показано, как с помощью функций Azure создать новую функцию на C#, которая срабатывает по таймеру событий и очищает строки в таблице базы данных. Новая функция создается на основе стандартного шаблона на портале функций Azure. Для выполнения этого сценария необходимо также задать строку подключения к базе данных как параметр службы приложений в приложении-функции.

## Предварительные требования 

Для создания функций необходима активная учетная запись Azure. Если у вас ее нет, воспользуйтесь [бесплатной учетной записью Azure](https://azure.microsoft.com/free/).

В этом разделе демонстрируется команда Transact-SQL, которая выполняет операцию массовой очистки в таблице *TodoItems* базы данных SQL. Эта же таблица TodoItems создается при выполнении шагов, описанных в [кратком учебнике по созданию мобильных приложений службы приложений Azure](../app-service-mobile/app-service-mobile-ios-get-started.md). Также можно воспользоваться образцом базы данных. Если вы решили использовать другую таблицу, необходимо изменить команду.

Получить строку подключения, используемую в серверной части мобильного приложения, можно на портале в разделе **Все параметры** > **Параметры приложения** > **Строки подключения** > **Показать значения строк подключения** > **MS\_TableConnectionString**. Строку подключения также можно получить непосредственно из базы данных SQL на портале в разделе **Все параметры** > **Свойства** > **Показать строки подключения к базам данных** > **ADO.NET (проверка подлинности SQL)**.

В этом сценарии к базе данных применяется массовая операция. Чтобы функция обрабатывала отдельные операции CRUD в таблице мобильных приложений, следует использовать привязку таблицы мобильного приложения.

## Настройка строки подключения к базе данных SQL в приложении-функции

Выполнение функций в Azure происходит с помощью приложения функций. Рекомендуется хранить строки подключения и другие секретные данные в параметрах приложения-функции. Это позволяет предотвратить случайное раскрытие данных, если код функции заканчивается в каком-то другом репозитории.

1. Перейдите на [портал функций Azure](https://functions.azure.com/signin) и войдите, используя свою учетную запись Azure.

2. Если у вас есть готовое приложение-функция, выберите его в списке **приложений функций** и нажмите кнопку **Открыть**. Чтобы создать приложение-функцию, введите уникальное **имя** нового приложения-функции или воспользуйтесь созданным; выберите предпочтительный **регион**, а затем щелкните **Create + get started** (Создать + приступить к работе).

3. В приложении-функции щелкните **Function app settings** (Параметры приложения-функции) > **Go to App Service settings** (Перейти к параметрам службы приложений).

	![Колонка параметров приложения-функции](./media/functions-create-an-event-processing-function/functions-app-service-settings.png)

4. В приложении-функции выберите **Все параметры**, прокрутите вниз до пункта **Параметры приложения**, затем в разделе **Строки подключения** введите `sqldb_connection` в поле **Имя**, вставьте строку подключения в поле **Значение**, а затем нажмите кнопку **Сохранить** и закройте колонку приложения-функции, чтобы вернуться на портал функций.

    ![Строка подключения как параметр службы приложений](./media/functions-create-an-event-processing-function/functions-app-service-settings-connection-strings.png)

Теперь можно добавить код функции C#, который подключается к базе данных SQL.

## Создание активируемой по таймеру функции на основе шаблона

1. В приложении-функции щелкните **+ New Function** (Создать функцию) > **TimerTrigger - C#** > **Создать**. Таким образом будет создана функция с именем по умолчанию, которая выполняется согласно расписанию по умолчанию — каждую минуту. 

	![Создание активируемой по таймеру функции](./media/functions-create-an-event-processing-function/functions-create-new-timer-trigger.png)

2. В области **Код** на вкладке **Разработка** добавьте следующие ссылки на сборки в верхней части существующего кода функции:

		#r "System.Configuration"
		#r "System.Data"

3. Добавьте в функцию следующие операторы `using`:

		using System.Configuration;
		using System.Data.SqlClient;
		using System.Threading.Tasks; 

4. Замените имеющуюся функцию **Run** следующим кодом:

		public static async Task Run(TimerInfo myTimer, TraceWriter log)
		{
		    var str = ConfigurationManager.ConnectionStrings["sqldb_connection"].ConnectionString;
		    using (SqlConnection conn = new SqlConnection(str))
		    {
		        conn.Open();
		        var text = "DELETE from dbo.TodoItems WHERE Complete='True'";
		        using (SqlCommand cmd = new SqlCommand(text, conn))
		        {
					// Execute the command and log the # rows deleted.
		            var rows = await cmd.ExecuteNonQueryAsync();
		            log.Info($"{rows} rows were deleted");
		        }
		    }
		}

5. Нажмите кнопку **Сохранить**. Выполнение следующей функции можно просмотреть в окне **Журналы**. Затем запомните число строк, удаленных из таблицы TodoItems.

6. (Необязательно) Используя [приложение из краткого учебника по созданию мобильных приложений](../app-service-mobile/app-service-mobile-ios-get-started.md), отметьте дополнительные элементы как "завершенные", а затем вернитесь в окно **Журналы** и убедитесь, что такое же число строк удаляется функцией во время следующего выполнения.

##Дальнейшие действия

Дополнительные сведения о функциях Azure см. в следующих статьях.

+ [Справочник разработчика по функциям Azure](functions-reference.md) Справочник программиста по созданию функций, а также определению триггеров и привязок.
+ [Тестирование функций Azure](functions-test-a-function.md) Описание различных средств и методов тестирования функций.
+ [Масштабирование функций Azure](functions-scale.md) Обсуждение планов обслуживания, доступных для использования с функциями Azure (включая динамический план обслуживания), а также выбор подходящего плана.  

[AZURE.INCLUDE [Начало работы](../../includes/functions-get-help.md)]

<!---HONumber=AcomDC_0615_2016-->