---
title: "Вызов функции из PowerApps | Документация Майкрософт"
description: "Создание пользовательского соединителя и вызов функции с его помощью."
services: functions
keywords: "облачные приложения, облачные службы, PowerApps, бизнес-процессы, бизнес-приложение"
documentationcenter: 
author: mgblythe
manager: cfowler
editor: 
ms.assetid: 
ms.service: functions
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/25/2017
ms.author: mblythe
ms.custom: 
ms.openlocfilehash: 1e262fde37b68bcfcee3c974deb91bd07965de19
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="call-a-function-from-powerapps"></a>Вызов функции из PowerApps
Платформа [PowerApps](https://powerapps.microsoft.com) позволяет бизнес-экспертами создавать приложения без традиционного кода. Профессиональные разработчики могут расширить возможности PowerApps с помощью функций Azure, избавляя при этом разработчиков приложений PowerApps от технических деталей.

В рамках этой статьи вы создадите приложение для обслуживания ветроэлектрических установок. Здесь показано, как вызвать функцию, определенную в статье [Создание определения OpenAPI функции](functions-openapi-definition.md). Функция определяет экономичность аварийного ремонта ветроэлектрической установки.

![Готовое приложение в PowerApps](media/functions-powerapps-scenario/finished-app.png)

Сведения о вызове этой же функции из Microsoft Flow вы найдете в статье [Call a function from Microsoft Flow](functions-flow-scenario.md) (Вызов функции из Microsoft Flow).

В этой статье:

> [!div class="checklist"]
> * Подготовка демонстрационных данных в Excel.
> * импортировали определения API;
> * добавили подключения к API;
> * создали приложения и добавили источники данных;
> * Добавление элементов управления для просмотра данных в приложении.
> * Добавление элементов управления для вызова функции и отображения данных.
> * запустили приложения для определения экономичности аварийного ремонта ветроэлектрической установки.

## <a name="prerequisites"></a>Предварительные требования

+ Активная [учетная запись PowerApps](https://powerapps.microsoft.com/tutorials/signup-for-powerapps.md) с такими же учетными данными, что и в учетной записи Azure. 
+ Excel (источник данных вашего приложения).
+ Выполните шаги, описанные в руководстве [Создание определения OpenAPI функции](functions-openapi-definition.md).


## <a name="prepare-sample-data-in-excel"></a>Подготовка демонстрационных данных в Excel
Сначала необходимо подготовить демонстрационные данные, используемые в приложении. Скопируйте приведенную ниже таблицу в Excel. 

| Название      | Широта  | Долгота  | Дата_последнего_обслуживания | MaxOutput Максимальная_мощность | Требуется_обслуживание | Ожидаемые_затраты | Заметки_об_осмотре                            |
|------------|-----------|-------------|-----------------|-----------|-----------------|-----------------|--------------------------------------------|
| Турбина 1  | 47.438401 | -121.383767 | 23.02.2017       | 2850      | Да             | 6               | Это вторая проблема в этом месяце.       |
| Турбина 4  | 47.433385 | -121.383767 | 08.05.2017        | 5400      | Да             | 6               |                                            |
| Турбина 33 | 47.428229 | -121.404641 | 20.06.2017       | 2800      |                 |                 |                                            |
| Турбина 34 | 47.463637 | -121.358824 | 19.02.2017       | 2800      | Да             | 7               |                                            |
| Турбина 46 | 47.471993 | -121.298949 | 02.03.2017        | 1200      |                 |                 |                                            |
| Турбина 47 | 47.484059 | -121.311171 | 02.08.2016        | 3350      |                 |                 |                                            |
| Турбина 55 | 47.438403 | -121.383767 | 02.10.2016       | 2400      | Да             | 40               | У нас есть некоторые элементы. |

1. В Excel выделите данные, а затем на вкладке **Главная** щелкните **Форматирование таблицы**.

    ![Форматирование таблицы](media/functions-powerapps-scenario/format-table.png)

1. Выберите любой стиль и нажмите кнопку **ОК**.

1. Выделите таблицу и на вкладке **Конструктор** введите `Turbines` в качестве **имени таблицы**.

    ![Имя таблицы](media/functions-powerapps-scenario/table-name.png)

1. Откройте книгу Excel.

[!INCLUDE [Export an API definition](../../includes/functions-export-api-definition.md)]

## <a name="add-a-connection-to-the-api"></a>Добавление подключения к API
Пользовательский API (пользовательский соединитель) доступен в PowerApps, но чтобы использовать его в приложении, к нему нужно подключиться.

1. На сайте [web.powerapps.com](https://web.powerapps.com) щелкните **Подключения**.

    ![Подключения PowerApps](media/functions-powerapps-scenario/powerapps-connections.png)

1. Нажмите кнопку **Создать подключение**, прокрутите вниз до соединителя **Ремонт турбин** и выберите его.

    ![Новое подключение](media/functions-powerapps-scenario/new-connection.png)

1. Введите ключ API и нажмите кнопку **Создать**.

    ![Создание подключения](media/functions-powerapps-scenario/create-connection.png)

> [!NOTE]
> Если приложение используется совместно с другими пользователями, каждый, кто работает в нем, должен также ввести ключ API, чтобы подключиться к API. Это поведение может измениться в будущем. В связи с этим мы обновим этот раздел.

## <a name="create-an-app-and-add-data-sources"></a>Создание приложения и добавление источников данных
Теперь вы можете создать приложение в PowerApps, а затем добавить данные Excel и пользовательский API в качестве источников данных приложения.

1. На сайте [web.powerapps.com](https://web.powerapps.com) на панели слева нажмите кнопку **Создать приложение**.

1. В разделе **Пустое приложение** нажмите кнопку **Макет для телефона**.

    ![Создание приложения для планшета](media/functions-powerapps-scenario/create-phone-app.png)

    Приложение откроется в интернет-версии PowerApps Studio. На снимке экрана ниже приведены различные части PowerApps Studio. На нем показано готовое приложение. Сначала в средней области вы увидите пустое окно.

    ![PowerApps Studio](media/functions-powerapps-scenario/powerapps-studio.png)

    **(1) Левая панель навигации** — иерархическое представление всех элементов управления в каждом окне.

    **(2) Средняя область** — окно, в котором вы работаете.

    **(3) Правая панель** — область параметров, таких как макет и источники данных.

    **(4) Свойства** — раскрывающийся список свойств, к которым применяются формулы.

    **(5) Строка формул** — строка ввода формул (как в Excel), которые определяют поведение приложения.
    
    **(6) Лента** — область добавления элементов управления и настройки элементов макета.

1. Добавьте файл Excel в качестве источника данных.

    1. На панели справа на вкладке **Данные** щелкните **Добавить источник данных**.

        ![Добавление источника данных](media/functions-powerapps-scenario/add-data-source.png)

    1. Щелкните **Добавить статические данные для приложения**.

        ![Добавление источника данных](media/functions-powerapps-scenario/add-static-data.png)

        Обычно читаются и записываются данные из внешнего источника, но в этом примере вы добавляете данные Excel как статические данные.

    1. Перейдите в сохраненный файл Excel, выберите таблицу **Турбины** и щелкните **Подключить**.

        ![Добавление источника данных](media/functions-powerapps-scenario/choose-table.png)

1. Добавьте пользовательский API в качестве источника данных.

    1. На вкладке **Данные** щелкните **Добавить источник данных**.

    1. Щелкните **Ремонт турбин**.

        ![Соединитель ремонта турбин](media/functions-powerapps-scenario/turbine-connector.png)

## <a name="add-controls-to-view-data-in-the-app"></a>Добавление элементов управления для просмотра данных в приложении
Теперь, когда источники данных доступны в приложении, добавьте в приложение окно, чтобы просмотреть данные о турбине.

1. На вкладке**Главная** щелкните **Новый экран** > **Окно списка**.

    ![Окно списка](media/functions-powerapps-scenario/list-screen.png)

    PowerApps добавит окно, в котором содержится *коллекция* элементов и другие элементы управления, позволяющие выполнять поиск, сортировку и фильтрацию.

1. Измените строку заголовка на `Turbine Repair` и измените размер коллекции, чтобы в ней было достаточно места для нескольких элементов управления.

    ![Изменение заголовка и размера коллекции](media/functions-powerapps-scenario/gallery-title.png)

1. Выберите коллекцию и в области справа на вкладке **Данные** измените источник данных с **CustomGallerySample** на **Турбины**.

    ![Изменение источника данных](media/functions-powerapps-scenario/change-data-source.png)

    Набор данных не содержит изображения, поэтому измените макет, чтобы лучше разместить данные. 

1. В области справа измените значение **Макет** на **Заголовок, подзаголовок и текст**.

    ![Изменение макета коллекции](media/functions-powerapps-scenario/change-layout.png)

1. В качестве последнего шага в области справа измените поля, отображаемые в коллекции.

    ![Изменение полей коллекции](media/functions-powerapps-scenario/change-fields.png)
    
    + **Текст1** — "Дата последнего обслуживания".
    + **Подзаголовок2** — "Требуется_обслуживание".
    + **Заголовок2** — "Заголовок". 

1. Выберите коллекцию. В качестве значения свойства **TemplateFill** задайте следующую формулу: `If(ThisItem.IsSelected, Orange, White)`.

    ![Формула заливки шаблона](media/functions-powerapps-scenario/formula-fill.png)

    Теперь проще просматривать выбранный элемент коллекции.

    ![Выбранный элемент](media/functions-powerapps-scenario/selected-item.png)

1. В приложении не требуется исходное окно. В области слева наведите указатель мыши на раздел **Экран1**, щелкните **...**, а затем **Удалить**.

    ![Удаление окна](media/functions-powerapps-scenario/delete-screen.png)

Существует много других видов форматирования, которое вы обычно выполняете в рабочем приложении, но мы перейдем к важной части этого сценария — вызове функции.

## <a name="add-controls-to-call-the-function-and-display-data"></a>Добавление элементов управления для вызова функции и отображения данных
У вас есть приложение, которое отображает сводные данные для каждой турбины, поэтому теперь пришло время добавить элементы управления, с помощью которых можно вызвать созданную вами функцию и отобразить возвращаемые данные. Вы можете получить доступ к функции в зависимости от способа ее имени в определении OpenAPI. В этом случае она называется `TurbineRepair.CalculateCosts()`.

1. На ленте на вкладке **Вставка** щелкните **Кнопка**. На этой же вкладке щелкните **Метка**.

    ![Кнопка "Вставка" и метка](media/functions-powerapps-scenario/insert-controls.png)

1. Перетащите кнопку и метку под коллекцию и измените размер метки. 

1. Выделите текст кнопки и измените его на `Calculate costs`. Приложение должно выглядеть как на следующем изображении.

    ![Приложения с кнопкой](media/functions-powerapps-scenario/move-button-label.png)

1. Выберите кнопку и введите следующую формулу для свойства **OnSelect** кнопки.

    ```
    If (BrowseGallery1.Selected.ServiceRequired="Yes", ClearCollect(DetermineRepair, TurbineRepair.CalculateCosts({hours: BrowseGallery1.Selected.EstimatedEffort, capacity: BrowseGallery1.Selected.MaxOutput})))
    ```
    Эта формула выполняется при нажатии кнопки, а если элемент выбранной коллекции имеет значение  **параметра** Требуется_обслуживание`Yes`, она выполняет следующее:

    + Удаляет значение `DetermineRepair` *коллекции*, чтобы удалить данные предыдущих вызовов. (Коллекция — это табличная переменная).

    + Назначает коллекции данные, возвращенные путем вызова функции `TurbineRepair.CalculateCosts()`. 
    
        Значения, передаваемые в функцию, берутся из полей **EstimatedEffort** и **MaxOutput** элемента, выбранного в коллекции. Эти поля не отображаются в коллекции, но их по-прежнему можно использовать в формулах.

1. Выберите метку и введите формулу ниже для свойства **Текст** метки.

    ```
    "Repair decision: " & First(DetermineRepair).message & " | Cost: " & First(DetermineRepair).costToFix & " | Revenue: " & First(DetermineRepair).revenueOpportunity
    ```
    В этой формуле используется функция `First()`. Она обеспечивает доступ к первой (и единственной) строке коллекции `DetermineRepair`. Эта функция возвращает три значения: `message`, `costToFix` и `revenueOpportunity`. Перед первым запуском приложения эти значения пусты.

    Готовое приложение должно выглядеть, как на следующем изображении.

    ![Готовое приложение перед запуском](media/functions-powerapps-scenario/finished-app-before-run.png)


## <a name="run-the-app"></a>Запуск приложения
Вы создали приложение. Пришло время запустить его и увидеть вызовы функции в действии.

1. В правом верхнем углу PowerApps Studio нажмите кнопку выполнения: ![Кнопка запуска приложения](media/functions-powerapps-scenario/f5-arrow-sm.png).

1. Выберите турбину со значением `Yes` параметра **Требуется_обслуживание**, а затем нажмите кнопку **Расчет затрат**. Вы должны увидеть следующий результат:

    ![Готовое приложение в PowerApps](media/functions-powerapps-scenario/finished-app.png)

1. Попробуйте выбрать другие турбины, чтобы увидеть остальные данные, возвращаемые функцией.

## <a name="next-steps"></a>Дальнейшие действия
В этой статье вы выполнили следующие действия:

> [!div class="checklist"]
> * подготовили демонстрационные данные в Excel;
> * импортировали определения API;
> * добавили подключения к API;
> * создали приложения и добавили источники данных;
> * добавили элементы управления для просмотра данных в приложении;
> * добавили элементы управления для вызова функции и отображения данных;
> * запустили приложения для определения экономичности аварийного ремонта ветроэлектрической установки.

Дополнительные сведения о PowerApps см. в статье [Введение в PowerApps](https://powerapps.microsoft.com/tutorials/getting-started/).

Дополнительные сведения о других сценариях использования службы "Функции Azure" см. в статьях [Call a function from Microsoft Flow](functions-flow-scenario.md) (Вызов функции из Microsoft Flow) и [Создание функции, интегрируемой с Azure Logic Apps](functions-twitter-email.md).