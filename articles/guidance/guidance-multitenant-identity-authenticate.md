<properties
   pageTitle="Проверка подлинности в мультитенантных приложениях | Microsoft Azure"
   description="Проверка подлинности пользователей Azure AD в мультитенантных приложениях"
   services=""
   documentationCenter="na"
   authors="MikeWasson"
   manager="roshar"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="mwasson"/>

# Проверка подлинности в мультитенантных приложениях

Этот материал входит в [цикл статей](guidance-multitenant-identity.md). К статьям прилагается полный [пример приложения].

В этой статье описана проверка подлинности пользователей Azure Active Directory (Azure AD) в мультитенантных приложениях с помощью OpenID Connect (OIDC).

## Обзор

[Эталонная реализация](guidance-multitenant-identity-tailspin.md) является приложением ASP.NET Core 1.0. Для выполнения потока проверки подлинности OIDC приложение использует встроенное ПО промежуточного слоя OpenID Connect. На схеме ниже в общих чертах представлен процесс входа пользователя в систему.

![Поток проверки подлинности](media/guidance-multitenant-identity/auth-flow.png)

1.	В приложении пользователь нажимает кнопку "Вход". Это действие обрабатывается контроллером MVC.
2.	Контроллер MVC возвращает действие **ChallengeResult**.
3.	ПО промежуточного слоя перехватывает **ChallengeResult** и создает ответ 302, который перенаправляет пользователя на страницу входа в Azure AD.
4.	Для пользователя выполняется проверка подлинности с помощью Azure AD.
5.	Azure AD отправляет маркер идентификатора в приложение.
6.	ПО промежуточного слоя проверяет маркер идентификатора. Теперь пользователь прошел проверку подлинности внутри приложения.
7.	ПО промежуточного слоя перенаправляет пользователя назад в приложение.

## Регистрация приложения с помощью Azure AD

Чтобы активировать OpenID Connect, поставщик SaaS регистрирует приложение в собственном клиенте Azure AD.

Чтобы зарегистрировать приложение, выполните инструкции, приведенные в статье [Интеграция приложений в Azure Active Directory](../active-directory/active-directory-integrating-applications.md) в разделе "Регистрация приложения на классическом портале управления Azure".

На странице **Настройка** выполните указанные ниже действия.

-	Запишите идентификатор клиента.
-	Для параметра **Приложение является мультитенантным** укажите значение **Да**.
-	Задайте для параметра **URL-адрес ответа** URL-адрес, по которому Azure AD будет отправлять ответ после проверки подлинности. Можно использовать базовый URL-адрес приложения.
  -	Примечание. Путь URL-адреса может быть каким угодно, при условии что имя узла совпадает с именем развернутого приложения.
  -	Можно задать несколько URL-адресов ответа. При разработке можно использовать адрес `localhost` для локального запуска приложения.
-	Создайте секрет клиента. Для этого в разделе **Ключи** щелкните раскрывающийся список **Выбрать длительность** и выберите значение "1 год" или "2 года". Ключ отобразится после нажатия кнопки **Сохранить**. Обязательно скопируйте значение, так как оно не будет отображаться после перезагрузки страницы конфигурации.

## Настройка ПО промежуточного слоя для проверки подлинности

В этом разделе описана настройка ПО промежуточного слоя в ASP.NET Core 1.0 для мультитенантной проверки подлинности с помощью OpenID Connect.

В классе запуска добавьте ПО промежуточного слоя OpenID Connect:

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.AutomaticAuthenticate = true;
    options.AutomaticChallenge = true;
    options.ClientId = [client ID];
    options.Authority = "https://login.microsoftonline.com/common/";
    options.CallbackPath = [callback path];
    options.PostLogoutRedirectUri = [application URI];
    options.SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = false
    };
    options.Events = [event callbacks];
});
```

> [AZURE.NOTE] См. файл [Startup.cs](https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps/blob/master/src/Tailspin.Surveys.Web/Startup.cs).

Дополнительные сведения о классе запуска см. в разделе [Application Startup](https://docs.asp.net/en/latest/fundamentals/startup.html) (Запуск приложения) документации по ASP.NET Core 1.0.

Задайте для ПО промежуточного слоя указанные ниже параметры.

- **ClientId**. Идентификатор клиента приложения, который был получен при регистрации приложения в Azure AD.
- **Центр**. Для мультитенантного приложения установите значение `https://login.microsoftonline.com/common/`. Это URL-адрес для общей конечной точки Azure AD, который позволяет пользователям выполнять вход из любого клиента Azure AD. Дополнительные сведения об общей конечной точке см. в [этой публикации блога](http://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).
- В **TokenValidationParameters** задайте для параметра **ValidateIssuer** значение False. Это означает, что приложение будет отвечать за проверку значения издателя в маркере идентификатора. (Промежуточный слой продолжает выполнять проверку самого маркера.) Дополнительные сведения о проверке издателя см. в разделе [Issuer validation](guidance-multitenant-identity-claims.md#issuer-validation) (Проверка издателя).
- **CallbackPath**. Установите для этого параметра значение, эквивалентное пути для URL-адреса ответа, который зарегистрирован в Azure AD. Например, если зарегистрирован URL-адрес ответа `http://contoso.com/aadsignin`, для **CallbackPath** должно быть задано значение `aadsignin`. Если этот параметр не задан, по умолчанию будет использоваться значение `signin-oidc`.
- **PostLogoutRedirectUri**. Укажите URL-адрес для перенаправления пользователей после выхода. Это должна быть страница, на которой разрешены анонимные запросы (как правило, используется домашняя страница).
- **SignInScheme**. Задайте для этого параметра значение `CookieAuthenticationDefaults.AuthenticationScheme`. Этот параметр означает, что после проверки подлинности пользователя его утверждения локально сохраняются в файле cookie. Благодаря этому файлу cookie пользователь остается в системе во время сеанса браузера.
- **События.** Обратные вызовы событий — см. раздел [События проверки подлинности](#authentication-events).

Также добавьте в конвейер ПО промежуточного слоя проверки подлинности для файлов cookie. Это ПО промежуточного слоя записывает утверждения пользователей в файл cookie и считывает этот файл при следующей загрузке страницы.

```csharp
app.UseCookieAuthentication(options =>
{
    options.AutomaticAuthenticate = true;
    options.AutomaticChallenge = true;
    options.AccessDeniedPath = "/Home/Forbidden";
});
```

## Инициирование потока проверки подлинности

Чтобы запустить поток проверки подлинности в ASP.NET MVC, контроллер должен вернуть действие **ChallengeResult**:

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

После этого ПО промежуточного слоя возвращает ответ 302 (найдено), который выполняет перенаправление к конечной точке проверки подлинности.

## Сеанс пользователя

Как упоминалось выше, при первом входе пользователя в систему ПО промежуточного слоя проверки подлинности для файлов cookie записывает в файл cookie утверждения пользователя. После этого HTTP-запросы проходят проверку подлинности с помощью считывания файла cookie.

По умолчанию ПО промежуточного слоя для файлов cookie записывает [файл cookie сеанса][session-cookie], который удаляется, как только пользователь закрывает браузер. При следующем посещении сайта пользователям потребуется повторно войти в систему. Однако если задать для параметра **IsPersistent** в действии **ChallengeResult** значение True, ПО промежуточного слоя запишет постоянный файл cookie, и пользователь останется в системе после закрытия браузера. Срок действия файла cookie можно настроить — см. раздел [Controlling cookie options][cookie-options] (Управление параметрами файла cookie). Постоянные файлы cookie более удобны для пользователей, но могут оказаться неподходящими для определенных приложений (например, для банковского приложения), при использовании которых необходимо каждый раз выполнять вход в систему.

## ПО промежуточного слоя OpenID Connect

ПО промежуточного слоя OpenID Connect в ASP.NET скрывает большую часть данных протокола. Этот раздел содержит определенные сведения о реализации, которые помогут понять, что такое поток протокола.

Для начала рассмотрим поток проверки подлинности с точки зрения ASP.NET (не учитывая сведения потока протокола OIDC между приложением и Azure AD). Этот процесс показан на схеме ниже.

![Поток входа в систему](media/guidance-multitenant-identity/sign-in-flow.png)

Здесь представлено два контроллера MVC. Контроллер Account обрабатывает запросы на вход, а контроллер Home обслуживает домашнюю страницу.

Ниже представлен процесс проверки подлинности.

1. Пользователь нажимает кнопку "Вход", и браузер отправляет запрос GET. Например, `GET /Account/SignIn/`.
2. Контроллер Account возвращает значение `ChallengeResult`.
3. ПО промежуточного слоя OIDC возвращает ответ HTTP 302, выполняя перенаправление в Azure AD.
4. Браузер отправляет запрос на проверку подлинности в Azure AD.
5. Пользователь выполняет вход в Azure AD, и Azure AD отправляет обратно ответ после проверки подлинности.
6. ПО промежуточного слоя OIDC создает субъект утверждений и передает его в ПО промежуточного слоя проверки подлинности для файлов cookie.
7. ПО промежуточного слоя для файлов cookie сериализует субъект утверждений и задает файл cookie.
8. ПО промежуточного слоя OIDC выполняет перенаправление по URL-адресу обратного вызова приложения.
10. Браузер следует перенаправлению и отправляет в запросе файл cookie.
11. ПО промежуточного слоя десериализует файл cookie до субъекта утверждений и задает для `HttpContext.User` значение, равное субъекту утверждений. Запрос перенаправляется в контроллер MVC.

### Билет проверки подлинности

Если проверка подлинности прошла успешно, ПО промежуточного слоя OIDC создает билет проверки подлинности с субъектом, который содержит утверждения пользователя. Доступ к билету можно получить в событии **AuthenticationValidated** или **TicketReceived**.

> [AZURE.NOTE] До полного завершения потока проверки подлинности `HttpContext.User` продолжает содержать анонимный субъект, _не_ являющийся данными пользователя, проходящего проверку подлинности. Коллекция утверждений анонимного субъекта пуста. После завершения проверки подлинности и перенаправления приложения ПО промежуточного слоя для файлов cookie выполняет десериализацию файла cookie проверки подлинности и задает для `HttpContext.User` значение субъекта утверждений, который представляет пользователя, прошедшего проверку подлинности.

### События проверки подлинности

В процессе проверки подлинности ПО промежуточного слоя OpenID Connect создает последовательность событий:

- **RedirectToAuthenticationEndpoint**. Вызывается непосредственно перед тем, как ПО промежуточного слоя выполнит перенаправление в конечную точку проверки подлинности. Это событие можно использовать для изменения URL-адреса перенаправления (например, чтобы добавить параметры запроса). С примером можно ознакомиться в разделе [Adding the admin consent prompt](guidance-multitenant-identity-signup.md#adding-the-admin-consent-prompt) (Добавление запроса на согласие администратора).

- **AuthorizationResponseReceived**. Вызывается после того, как ПО промежуточного слоя получит ответ после проверки подлинности от поставщика удостоверений (IdP), но перед тем, как ПО промежуточного слоя проверит ответ.

- **AuthorizationCodeReceived**. Вызывается с кодом авторизации.

- **TokenResponseReceived**. Вызывается после того, как ПО промежуточного слоя получит маркер доступа от IdP. Применяется только к потоку кода авторизации.

- **AuthenticationValidated**. Вызывается после того, как ПО промежуточного слоя выполнит проверку маркера идентификатора. Теперь в приложении есть набор проверенных утверждений о пользователе. Это событие можно использовать для дополнительной проверки или преобразования утверждений. См. статью, посвященную [работе с утверждениями](guidance-multitenant-identity-claims.md).

- **UserInformationReceived**. Вызывается, если ПО промежуточного слоя получает профиль пользователя из конечной точки сведений о пользователе. Применяется только к потоку кода авторизации и только если в параметрах ПО промежуточного слоя установлено значение `GetClaimsFromUserInfoEndpoint = true`.

- **TicketReceived**. Вызывается при завершении проверки подлинности. Это последнее событие, при условии что проверка подлинности завершается успешно. После обработки этого события пользователь входит в приложение.

- **AuthenticationFailed**. Вызывается, если пользователь не проходит проверку подлинности. Это событие используется для обработки сбоев проверки подлинности — например, путем перенаправления на страницу ошибки.

Чтобы предоставить функции обратного вызова для этих событий, настройте параметр **События** в ПО промежуточного слоя. Существует два способа объявления обработчиков событий: встроенное объявление с лямбда-выражениями или объявление в классе, производном от **OpenIdConnectEvents**.

Встроенное объявление с лямбда-выражениями:

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    // Other options not shown.

    options.Events = new OpenIdConnectEvents
    {
        OnTicketReceived = (context) =>
        {
             // Handle event
             return Task.FromResult(0);
        },
        // other events
    }
});
```

Производное от **OpenIdConnectEvents**:

```csharp
public class SurveyAuthenticationEvents : OpenIdConnectEvents
{
    public override Task TicketReceived(TicketReceivedContext context)
    {
        // Handle event
        return base.TicketReceived(context);
    }
    // other events
}

// In Startup.cs:
app.UseOpenIdConnectAuthentication(options =>
{
    // Other options not shown.

    options.Events = new SurveyAuthenticationEvents();
});
```

Второй подход рекомендуется в том случае, если обратные вызовы события сопровождаются существенной логикой, чтобы они не загромождали класс запуска. Этот подход используется в эталонной реализации — см. файл [SurveyAuthenticationEvents.cs](https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps/blob/master/src/Tailspin.Surveys.Web/Security/SurveyAuthenticationEvents.cs).

### Конечные точки OpenID Connect

Azure AD поддерживает функцию [Обнаружение OpenID](https://openid.net/specs/openid-connect-discovery-1_0.html), при применении которой поставщик удостоверений (IdP) возвращает документ метаданных JSON из [известной конечной точки](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig). Документ метаданных содержит указанные ниже сведения.

-	URL-адрес конечной точки авторизации. Это расположение, в которое приложение выполняет перенаправление для проверки подлинности пользователя.
-	URL-адрес конечной точки "конец сеанса", где приложение переходит к выполнению выхода пользователя из системы.
-	URL-адрес получения ключей подписывания, которые клиент использует для проверки маркеров OIDC, полученных от поставщика удостоверений.

По умолчанию ПО промежуточного слоя OIDC имеет сведения о том, как получить эти метаданные. Задайте параметр **Центр** в ПО промежуточного слоя, и оно сформирует URL-адрес для метаданных. (URL-адрес метаданных можно переопределить, задав параметр **MetadataAddress**.)

### Потоки OpenID Connect

По умолчанию ПО промежуточного слоя OIDC использует гибридный поток с режимом ответа на отправку формы.

-	_Гибридный поток_ означает, что клиент может получить маркер идентификатора и код авторизации в одном процессе обмена данными с сервером авторизации.
-	_Режим ответа на отправку формы_ означает, что сервер авторизации использует HTTP-запрос POST для отправки маркера идентификатора и кода авторизации для приложения. Значения представлены в закодированном формате URL-адреса (тип содержимого = application/x-www-form-urlencoded).

Когда ПО промежуточного слоя OIDC выполняет перенаправление в конечную точку авторизации, URL-адрес перенаправления включает все требующиеся для OIDC параметры строки запроса. Для гибридных потоков:

-	client\_id. Это значение устанавливается для параметра **ClientId**.
-	scope = "openid profile". Означает, что это запрос OIDC, для которого требуется профиль пользователя.
-	response\_type = "code id\_token". Определяет гибридный поток.
-	response\_mode = "form\_post". Определяет ответ на отправку формы.

Чтобы указать другой поток, в параметрах задайте свойство **ResponseType**. Например:

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

[cookie-options]: https://docs.asp.net/en/latest/security/authentication/cookie.html#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[пример приложения]: https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps

<!---HONumber=AcomDC_0302_2016-->