<properties
   pageTitle="Федерация со службой AD FS клиента | Microsoft Azure"
   description="Создание федерации с AD FS клиента в мультитенантном приложении"
   services=""
   documentationCenter="na"
   authors="MikeWasson"
   manager="roshar"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="mwasson"/>

# Федерация со службой AD FS клиента

Этот материал входит в [цикл статей]. К статьям прилагается полный [пример приложения].

В этой статье описывается, каким образом мультитенантное приложение SaaS поддерживает проверку подлинности через службы федерации Active Directory (AD FS) для создания федерации со службой AD FS клиента.

## Обзор

Azure Active Directory (Azure AD) упрощает процесс входа пользователей из клиентов Azure AD, включая клиентов Office 365 и Dynamics CRM Online. Но как быть с пользователями, использующими локальную службу Active Directory в корпоративной интрасети?

Одним из вариантов для таких пользователей является синхронизация локальной службы AD с Azure AD с помощью [Azure AD Connect]. Но, возможно, некоторым клиентам не удастся реализовать этот подход ввиду особенностей корпоративной ИТ-политики или по другим причинам. В этом случае следует рассмотреть другой вариант — создание федерации с помощью служб федерации Active Directory (AD FS).

Чтобы реализовать этот сценарий, необходимо выполнить приведенные ниже условия.

-	У клиента должна быть доступная через Интернет ферма AD FS.
-	Поставщик SaaS развертывает собственную ферму AD FS.
-	Клиент и поставщик SaaS должны установить [доверие федерации]. Этот процесс выполняется в ручную.

В отношении доверия существуют три основные роли.

-	AD FS клиента является [партнером по учетным записям], отвечающим за проверку подлинности пользователей в службе AD клиента и за создание маркеров безопасности с утверждениями пользователей.
-	AD FS поставщика SaaS является [партнером по ресурсам], который доверяет партнеру по учетным записям и получает утверждения пользователей.
-	Приложение настроено в качестве проверяющей стороны (RP) в службе AD FS поставщика SaaS.

	![Доверие федерации](media/guidance-multitenant-identity/federation-trust.png)

> [AZURE.NOTE] В этой статье предполагается, что в качестве протокола проверки подлинности приложение использует OpenID Connect. Другим вариантом является использование WS-Federation.

> Для использования OpenID Connect поставщик SaaS должен работать с AD FS 4.0 в Windows Server 2016 (в настоящее время доступна предварительная версия продукта). AD FS 3.0 не поддерживает OpenID Connect.

> ASP.NET Core 1.0 не имеет встроенной поддержки WS-Federation.

Пример использования WS-Federation в ASP.NET 4 см. на веб-сайте по адресу: https://github.com/Azure-Samples/active-directory-dotnet-webapp-wsfederation

## Поток проверки подлинности

1.	Когда пользователь нажимает кнопку входа, приложение выполняет перенаправление в конечную точку OpenID Connect в службе AD FS поставщика SaaS.
2.	Пользователь вводит имя пользователя организации ("`alice@corp.contoso.com`"). AD FS использует обнаружение домашней области для перенаправления в службу AD FS клиента, где пользователь вводит свои учетные данные.
3.	AD FS клиента отправляет утверждения пользователя в AD FS поставщика SaaS с помощью WF-Federation (или SAML).
4.	Утверждения отправляются из AD FS в приложение с помощью OpenID Connect. Для этого необходимо сменить протокол WS-Federation.

## Ограничения

На момент написания этой статьи приложение имеет ограниченный набор утверждений в id\_token OpenID. Служба AD FS 4.0 по-прежнему доступна только в предварительной версии, поэтому этот список может измениться. Но если приложению требуются дополнительные утверждения, получить их в данный момент невозможно. Это необходимо иметь в виду перед выполнением дальнейших действий.

В настоящее время в id\_token отправляются перечисленные ниже утверждения.

Утверждение | Описание
------|-------------
aud | Аудитория — приложение, для которого были выпущены утверждения.
authenticationinstant | [Время выполнения проверки подлинности]
c\_hash | Значение хэш-кода
exp | [Время окончания срока действия]
iat | [Время выдачи]
iss | Издатель Значением этого утверждения всегда является AD FS партнера по ресурсам, а не AD FS клиента. (Другими словами, это утверждение будет определять поставщика SaaS как издателя, а не клиента.)
name | Имя пользователя. Пример: `john@corp.fabrikam.com`.
nameidentifier | [Идентификатор имени]
nonce | Специальный сеанс.
upn | Имя участника-пользователя (UPN). Пример: john@corp.fabrikam.com

Обратите внимание, что утверждение "iss" не указывает AD FS клиента. Чтобы узнать домен клиента, необходимо взглянуть на имя участника-пользователя. Далее в этой статье описывается процедура установки отношения доверия между RP (приложением) и партнером по учетным записям (клиентом).

## Развертывание AD FS

Поставщик SaaS может развернуть AD FS локально или на виртуальных машинах Azure. В целях обеспечения безопасности и доступности важно учесть приведенные далее рекомендации.

-	Для обеспечения максимальной доступности службы AD FS следует развернуть по меньшей мере два сервера AD FS и два прокси-сервера AD FS.
-	Контроллеры домена и серверы AD FS не должны быть напрямую доступны из Интернета. Они должны находиться в виртуальной сети с прямым доступом к ним.
-	Для публикации серверов AD FS в Интернете необходимо использовать прокси-службы веб-приложений (ранее — прокси AD FS).

Настройка аналогичной топологии в Azure выполняется с использованием виртуальных сетей, групп безопасности сети, виртуальных машин и групп доступности. Дополнительные сведения см. в статье [Рекомендации по развертыванию Windows Server Active Directory на виртуальных машинах Azure](MSDN).

## Настройка приложения для использования проверки подлинности OpenID Connect в AD FS

Поставщик SaaS должен включить OpenID Connect между приложением и AD FS. Для этого нужно добавить группу приложений в AD FS. Подробные инструкции можно найти в этой [записи блога] в разделе "Настройка веб-приложения для входа OpenId Connect в AD FS". Затем настройте ПО промежуточного слоя OpenID Connect. Конечной точкой метаданных является `https://domain/adfs/.well-known/openid-configuration`, где домен представляет собой домен AD FS поставщика SaaS.

Как правило, эту точку можно объединять с другими конечными точками OpenID Connect (например AAD). Чтобы различать эти точки и отправлять пользователя в нужную конечную точку проверки подлинности, потребуется две разные кнопки входа или какой-либо другой способ определения соответствующей точки.

## Настройка партнера по ресурсам AD FS

Поставщик SaaS должен выполнить приведенные далее действия для каждого клиента, который хочет подключаться через ADFS.

1.	Добавление отношения доверия поставщика утверждений.
2.	Добавление правил утверждений.
3.	Включение обнаружения домашней области.

Ниже приведено более подробное описание этих шагов.

### Добавление отношения доверия поставщика утверждений

1.	В диспетчере серверов щелкните **Сервис**, а затем выберите пункт **Управление AD FS**.
2.	В дереве консоли в разделе **AD FS** щелкните правой кнопкой мыши **Отношения доверия поставщиков утверждений**. Выберите **Добавить отношение доверия поставщика утверждений**.
3.	Щелкните **Запустить**, чтобы запустить мастер.
4.	Выберите параметр "Импорт данных о поставщике утверждений, опубликованных в Интернете или локальной сети". Введите URI конечной точки метаданных федерации клиента. (Пример: `https://contoso.com/FederationMetadata/2007-06/FederationMetadata.xml`.) Эти данные необходимо получить от клиента.
5.	Завершите работу мастера, оставив значения по умолчанию.

### Изменение правил утверждений

1.	Щелкните правой кнопкой мыши только что добавленное отношение доверия поставщика утверждений и выберите команду **Изменить правила утверждений**.
2.	Щелкните **Добавить правило**.
3.	Выберите "Пропуск или фильтрация входящего утверждения" и нажмите кнопку **Далее**. ![Мастер добавления правил преобразования утверждений](media/guidance-multitenant-identity/edit-claims-rule.png)
4.	Введите имя правила.
5.	В поле "Тип входящего утверждения" выберите **UPN**.
6.	Выберите "Пропускать все значения утверждений". ![Мастер добавления правил преобразования утверждений](media/guidance-multitenant-identity/edit-claims-rule2.png)
7.	Нажмите кнопку **Готово**
8.	Повторите шаги 2–7 и укажите **Тип утверждения привязки** для типа входящего утверждения.
9.	Нажмите кнопку **ОК**, чтобы завершить работу мастера.

### Включение обнаружения домашней области
Выполните следующий сценарий PowerShell:

```
Set-ADFSClaimsProviderTrust -TargetName "name" -OrganizationalAccountSuffix @("suffix")
```

где "name" — понятное имя доверия поставщика утверждений, а "suffix" — суффикс UPN для AD клиента (например "corp.fabrikam.com").

В рамках этой конфигурации конечные пользователи могут ввести учетную запись организации, и AD FS автоматически выберет соответствующего поставщика утверждений. См. раздел "Настройка поставщика удостоверений для использования определенных суффиксов электронной почты" статьи [Настройка страниц входа AD FS].

## Настройка партнера по учетным записям AD FS

Клиент должен выполнить приведенные ниже действия.

1.	Добавление отношение доверия с проверяющей стороной (RP).
2.	Добавление правил утверждений.

### Добавление отношения доверия с проверяющей стороной

1.	В диспетчере серверов щелкните **Сервис**, а затем выберите пункт **Управление AD FS**.
2.	В дереве консоли в разделе **AD FS** щелкните правой кнопкой мыши **Отношения доверия с проверяющей стороной**. Выберите **Добавить отношение доверия с проверяющей стороной**.
3.	Выберите **С поддержкой утверждений** и нажмите кнопку **Запустить**.
4.	На странице **Выбор источника данных** выберите параметр "Импорт данных о поставщике утверждений, опубликованных в Интернете или локальной сети". Введите URI конечной точки метаданных федерации поставщика SaaS. ![Мастер добавления отношений доверия с проверяющей стороной](media/guidance-multitenant-identity/add-rp-trust.png)
5.	На странице **Указание отображаемого имени** введите любое имя.
6.	На странице **Выбор политики управления доступом** выберите политику. Можно выбрать всех пользователей в организации или определенную группу безопасности. ![Мастер добавления отношений доверия с проверяющей стороной](media/guidance-multitenant-identity/add-rp-trust2.png)
7.	Чтобы завершить работу мастера, нажмите кнопку **Далее**.

### Добавление правил утверждений

1.	Щелкните правой кнопкой мыши добавленное отношение доверия с проверяющей стороной, а затем выберите команду **Изменить политику выдачи утверждений**.
2.	Щелкните **Добавить правило**.
3.	Выберите "Отправка атрибутов LDAP в виде утверждений" и нажмите кнопку **Далее**. ![Мастер добавления правил преобразования утверждений](media/guidance-multitenant-identity/add-claims-rules.png)
4.	Введите имя правила, например "UPN".
5.	В разделе **Хранилище атрибутов** выберите **Active Directory**.
6.	В разделе **Сопоставление атрибутов LDAP**:
  -	В поле **Атрибут LDAP** выберите **Имя участника-пользователя**.
  - В поле **Тип исходящего утверждения** выберите **UPN**. ![Мастер добавления правил преобразования утверждений](media/guidance-multitenant-identity/add-claims-rules2.png)
7.	Нажмите кнопку **Готово**
8.	Щелкните **Добавить правило** еще раз.
9.	Выберите "Отправлять утверждения с помощью настраиваемого правила" и нажмите кнопку **Далее**.
10.	Введите имя правила, например "Утверждение привязки".
11.	В разделе **Настраиваемое правило** введите приведенный ниже код.

	```
    EXISTS([Type == "http://schemas.microsoft.com/ws/2014/01/identity/claims/anchorclaimtype"])=>
      issue (Type = "http://schemas.microsoft.com/ws/2014/01/identity/claims/anchorclaimtype",
             Value = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn");
	```

    Это правило сопоставляет утверждение UPN с утверждением привязки.

12.	Нажмите кнопку **Готово**
13.	Нажмите кнопку **ОК**, чтобы завершить работу мастера.

<!-- Links -->
[цикл статей]: guidance-multitenant-identity.md
[Azure AD Connect]: ../active-directory/active-directory-aadconnect.md
[доверие федерации]: https://technet.microsoft.com/library/cc738707.aspx
[партнером по учетным записям]: https://technet.microsoft.com/library/cc758463(v=ws.10).aspx
[партнером по ресурсам]: https://technet.microsoft.com/library/cc758463(v=ws.10).aspx
[Время выполнения проверки подлинности]: https://msdn.microsoft.com/library/system.security.claims.claimtypes.authenticationinstant%28v=vs.110%29.aspx
[Время окончания срока действия]: http://tools.ietf.org/html/draft-ietf-oauth-json-web-token-25#section-4.1.4
[Время выдачи]: http://tools.ietf.org/html/draft-ietf-oauth-json-web-token-25#section-4.1.6
[Идентификатор имени]: https://technet.microsoft.com/library/ee913589.aspx
[Guidelines for Deploying Windows Server Active Directory on Azure Virtual Machines]: https://msdn.microsoft.com/library/azure/jj156090.aspx
[записи блога]: http://www.cloudidentity.com/blog/2015/08/21/OPENID-CONNECT-WEB-SIGN-ON-WITH-ADFS-IN-WINDOWS-SERVER-2016-TP3/
[Настройка страниц входа AD FS]: https://technet.microsoft.com/library/dn280950.aspx
[пример приложения]: https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps

<!---HONumber=AcomDC_0302_2016-->