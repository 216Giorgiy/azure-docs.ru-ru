<properties
   pageTitle="Настройка производительности запросов и объединения данных с помощью Elasticsearch в Azure | Microsoft Azure"
   description="Набор рекомендаций по оптимизации производительности поисковых операций и запросов для Elasticsearch."
   services=""
   documentationCenter="na"
   authors="mabsimms"
   manager="marksou"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/29/2016"
   ms.author="masimms"/>
   
# Настройка производительности запросов и объединения данных с помощью Elasticsearch в Azure


Этот материал входит в [цикл статей, посвященных вопросам Elasticsearch](guidance-elasticsearch.md).

Elasticsearch обеспечивает поддержку поиска в данных, что является основной причиной использования этого решения. Пользователи должны иметь возможность быстро находить искомую информацию. Кроме того, система должна предоставлять возможность задавать вопросы о данных, искать корреляции и принимать бизнес-решения на основе анализа. Все это позволяет превратить простую информацию в ценные данные.

В этом документе описаны рекомендации, которые следует учитывать при выборе метода оптимизации производительности поисковых операций и запросов в системе.

Все рекомендации по повышению производительности в значительной мере зависят от сценариев, которые применимы в конкретном случае, объема индексируемых данных, а также скорости, с которой приложения и пользователи запрашивают данные. Чтобы оценить преимущества для конкретных сценариев, следует тщательно проверять результаты любого изменения конфигурации или структуры индексирования, используя собственные данные и рабочие нагрузки. В связи с этим здесь также описывается ряд тестов производительности, выполненных для одного конкретного сценария с разными конфигурациями. Вы можете адаптировать использованный подход для оценки производительности собственных систем. Подробное описание этих тестов см. в [приложении](#appendix-the-query-and-aggregation-performance-test).

## Рекомендации по повышению производительности индексирования и запросов

В этом разделе приведены некоторые распространенные факторы, которые следует учитывать при проектировании индексов, которые должны поддерживать быстрое выполнение поисковых операций и запросов.

### Использование одного индекса для нескольких типов данных

В индекс Elasticsearch можно добавлять данные разного типа. Тем не менее рекомендуется создавать отдельный индекс для каждого типа. Учтите следующие моменты.

- Для разных типов могут указываться разные анализаторы, поэтому не всегда понятно, какой из них следует использовать Elasticsearch, если запрос выполняется на уровне индекса, а не на уровне типа. Дополнительные сведения см. в разделе [Avoiding Type Gotchas](https://www.elastic.co/guide/en/elasticsearch/guide/current/mapping.html#_avoiding_type_gotchas) (Сложности при использовании разных типов).

- Сегменты индексов, содержащих несколько типов, скорее всего, будут больше сегментов индексов с одним типом. При выполнении запросов размер сегмента играет немалую роль: чем больше сегмент, тем больше усилий требуется Elasticsearch для фильтрации данных.

- Если объемы данных разных типов слишком отличаются, данные одного типа могут фрагментарно распределиться по нескольким сегментам, что снижает эффективность операций поиска, извлекающих эти данные.

    ![](./media/guidance-elasticsearch/query-performance1.png)

    ***Рис. 1. Результаты использования одного индекса для разных типов***

    Рис. 1 демонстрирует этот сценарий. В верхней части схемы представлено использование одного индекса для документов типа А и Б. Документов типа А намного больше. Тем не менее при поиске последних будут запрашиваться все четыре сегмента. В нижней части схемы показан результат при создании отдельных индексов для каждого типа. В этом случае при поиске документов типа А требуется доступ только к двум сегментам.

- Если сегменты небольшие, данные распределяются более равномерно, что упрощает распределение нагрузки между узлами для Elasticsearch.

- Различные типы могут иметь разные сроки хранения. Поэтому архивация старых данных, которые размещены в одних сегментах с активными данными, может оказаться непростой задачей.


Тем не менее использование одного индекса для разных типов может предоставлять преимущества, если:

- при поиске постоянно запрашиваются разные типы, содержащиеся в одном индексе;

- количество документов каждого типа небольшое. Обработка отдельного набора сегментов для каждого типа может создать значительную нагрузку.


### Оптимизация типов индексов

Индекс Elasticsearch содержит копию исходных документов JSON, которые использовались для его заполнения. Сведения о них хранятся в поле [*\_source*](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-source-field.html#mapping-source-field) каждого индексированного элемента. Эти данные недоступны для поиска, но они возвращаются по умолчанию при выполнении запросов *get* и *search*. Тем не менее данные, хранящиеся в этом поле, повышают нагрузку и занимают место, из-за чего увеличивается размер сегментов и объем операций ввода-вывода. Поле *\_source* можно отключить по отдельности для каждого типа:

```http
PUT my_index
{
  "mappings": {
    "my_type": {
      "_source": {
        "enabled": false
      }
    }
  }
}
```
Отключение этого поля исключает возможность выполнять следующие операции:

- обновление данных в индексе с помощью API *обновления*;

- выполнение операций поиска, возвращающих выделенные данные;

- повторная индексация из одного индекса Elasticsearch непосредственно в другой;

- изменение сопоставлений или параметров анализа;

- отладка запросов путем просмотра исходного документа.


### Повторная индексация данных

Количество доступных для индекса сегментов в конечном счете определяет его емкость. Можно изначально предположить (учитывая конкретный случай), сколько сегментов потребуется, но всегда следует заранее рассматривать стратегию повторного индексирования документа. Во многих случаях повторное индексирование следует планировать с учетом увеличения объема данных. В целях оптимизации поиска изначально можно не выделять большое количество сегментов для индекса и вместо этого выделять новые сегменты по мере увеличения объема данных. Иногда, если оценка увеличения объема данных оказалась неточной, повторное индексирование необходимо выполнять по ходу.

> [AZURE.NOTE] Повторная индексация может быть необязательна для данных, которые быстро устаревают. В этом случае приложение может создавать новый индекс для каждого периода времени. Такими данными могут быть, например, журналы производительности или данные аудита, которые каждый день можно сохранять в новом индексе.

<!-- -->

По сути, повторная индексация представляет собой создание нового индекса на основе данных в старом индексе и последующее удаление старого индекса. Если индекс большой, этот процесс может занять некоторое время. При необходимости в течение этого периода следует обеспечить доступность данных для поиска. По этой причине следует создать [псевдоним для каждого индекса](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html) и настроить получение запрашиваемых данных с использованием этих псевдонимов. При повторной индексации укажите псевдоним старого индекса, а по завершении этой процедуры замените его на новый индекс. Этот подход также удобен для доступа к данным на основе времени, для которых создается новый индекс каждый день. Для доступа к текущим данным следует использовать псевдоним, который меняется на псевдоним нового индекса при его создании.

### Управление сопоставлениями

В Elasticsearch сопоставления используются, чтобы определить способ интерпретации данных в каждом поле документа. Каждый тип имеет свои собственные сопоставления, что фактически определяет его схему. Elasticsearch использует эти сведения для создания обращенных индексов для каждого поля в документах типа. Каждое поле в любом документе содержит сведения о типе данных (например, *строка*, *дата* или *длинное целое*) и значение. Сопоставления можно самостоятельно задать при создании индекса. Кроме того, они могут быть выведены в Elasticsearch при добавлении новых документов в тип. Тем не менее необходимо учитывать следующие моменты.

- Сопоставления, созданные динамически, могут привести к ошибкам в зависимости от способа интерпретации полей при добавлении документов в индекс. Например, документ 1 содержит поле А с числом, а Elasticsearch добавляет сопоставление, которое указывает, что тип этого поля — *длинное целое*. Если в следующем добавляемом документе поле А содержит нечисловые данные, произойдет сбой. В этом случае при добавлении первого документа тип поля А, вероятно, нужно было интерпретировать, как "строка". Этих проблем можно избежать, указав это сопоставление при создании индекса.

- При создании документов следует учитывать, что слишком большие сопоставления вызывают значительную нагрузку во время операций поиска, занимают большой объем памяти и приводят к отрицательному результату поисковых запросов. Используйте единое соглашение об именовании для полей документов одного типа. К примеру, не используйте в документах разные варианты имени поля, такие как first\_name, FirstName и forename. Используйте одинаковое имя во всех документах. Кроме того, не следует использовать значения в качестве ключей (это распространенный подход в базах данных, состоящих из групп столбцов, однако он может привести к снижению эффективности и сбоям при использовании с Elasticsearch). Дополнительные сведения см. в разделе [Mapping Explosion](https://www.elastic.co/blog/found-crash-elasticsearch#mapping-explosion) (Избыточное сопоставление).

- При необходимости используйте значение *not\_analyzed*, чтобы избежать разметки. Например, если в документе содержится строковое поле *data* со значением ABC-DEF, можно попытаться выполнить поиск всех документов, соответствующих этому значению, следующим образом:

  ```http
  GET /myindex/mydata/_search
  {
    "query" : {
      "filtered" : {
        "filter" : {
          "term" : {
            "data" : "ABC-DEF"
          }
        }
      }
    }
  }
  ```

    However, this search will fail to return the expected results due to the way in which the string ABC-DEF is tokenized when it is indexed; it will be effectively split into two tokens, ABC and DEF, by the hyphen. This feature is designed to support full text searching, but if you want the string to be interpreted as a single atomic item you should disable tokenization when the document is added to the index. You can use a mapping such as this:

  ```http
  PUT /myindex
  {
    "mappings" : {
      "mydata" : {
        "properties" : {
          "data" : {
            "type" : "string",
            "index" : "not_analyzed"
          }
        }
      }
    }
  }
  ```

  Дополнительные сведения см. в статье [Finding Exact Values](https://www.elastic.co/guide/en/elasticsearch/guide/current/_finding_exact_values.html#_term_filter_with_text) (Поиск точных значений).


### Использование значений doc values

При выполнении большинства запросов и операций объединения требуется, чтобы данные были отсортированы в рамках операции поиска. Для сортировки необходима возможность сопоставления одного или несколько значений со списком документов. Чтобы упростить этот процесс, Elasticsearch может загрузить все значения поля, используемого в качестве ключа сортировки, в память. Эти данные называются *fielddata*. Кэширование fielddata в памяти позволяет сократить число операций ввода-вывода. Кроме того, это может быть быстрее, чем многократное считывание одних и тех же данных с диска. Тем не менее если поле поддерживает большое количество элементов, данные fielddata, сохраненные в памяти, могут потреблять большой объем пространства кучи, что, вероятно, повлияет на возможность выполнения других одновременных операций или вызовет сбой Elasticsearch из-за переполнения хранилища.

В качестве альтернативного подхода Elasticsearch также поддерживает значения *doc values*. Эти значения подобны элементам fielddata в памяти, за исключением того, что они хранятся на диске и создаются, когда данные сохраняются в индексе (fielddata создаются динамически при выполнении запроса). doc values не потребляют пространство кучи. Поэтому их удобно использовать для запросов, которые сортируют или объединяют данные в полях, которые могут содержать большое количество уникальных значений. Кроме того, благодаря уменьшению нагрузки на кучу может сократиться разница между производительностью получения данных с диска и считывания их из памяти, сбор мусора будет выполняться реже, а также уменьшится степень влияния на другие одновременные операции, которые используют память.

Чтобы включить или отключить значения doc values, в индексе необходимо задать соответствующее значение атрибута *doc\_values* в разделе свойств, как показано ниже:

```http
PUT /myindex
{
  "mappings" : {
    "mydata" : {
      "properties" : {
        "data" : {
          ...
          "doc_values": true
        }
      }
    }
  }
}
```
> [AZURE.NOTE] Атрибут doc\_values активирован по умолчанию в Elasticsearch 2.0.0 и более поздней версии.

Эффективность использования этого атрибута, скорее всего, сильно зависит от конкретных данных и сценариев запросов. Чтобы точно определить, подходит ли вам этот метод, понадобится провести тестирование производительности. Следует также отметить, что значения doc values не поддерживают проанализированные строковые поля. Дополнительные сведения см. в статье [Doc Values](https://www.elastic.co/guide/en/elasticsearch/guide/current/doc-values.html#doc-values) (Формат doc\_values).

### Использование реплик для уменьшения количества конфликтов из-за запросов

Распространенный метод повышения производительности запросов заключается в создании большого числа реплик каждого индекса. Таким образом, при запросе данные будут извлекаться из реплик. Тем не менее использование этого метода может существенно ухудшить производительность операций приема данных, поэтому в сценариях со смешанными рабочими нагрузками его следует использовать с осторожностью. Если же реплики распределены между узлами и не конкурируют за ресурсы с основными сегментами, которые являются частью одного индекса, этот метод достаточно эффективный. Помните, что можно динамически увеличивать и уменьшать число реплик для индекса.

### Кэширование запросов к сегментам

Elasticsearch может кэшировать в память запрашиваемые локальные данные в каждом сегменте. Благодаря этому операции поиска, которые извлекают одни и те же данные, выполняются быстрее, так как данные можно считывать из памяти, а не с диска. Такой способ кэширования данных позволяет повысить производительность некоторых операций поиска за счет сокращения объема доступной памяти для других одновременных задач. Кроме того, данные, извлекаемые из кэша, могут быть устаревшими. Данные в кэше становятся недействительны, только когда сегмент обновляется и данные меняются. Частота обновления соответствует значению параметра индекса *refresh\_interval*.

По умолчанию кэширование запросов для индекса отключено, но его можно включить следующим образом:

```http
PUT /myindex/_settings
{
  "index.requests.cache.enable": true
}
```

Кэширование запросов к сегментам наиболее эффективно использовать по отношению к относительно статичным данным, например историческим данным или данным журнала.

### Использование клиентских узлов

Все запросы обрабатывает первый узел, который их получает. Этот узел отправляет дальнейшие запросы на все узлы, содержащие сегменты запрашиваемых индексов, а затем собирает результаты, чтобы вернуть ответ. Если запрос включает в себя объединение данных или выполнение сложных вычислений, за соответствующую обработку отвечает начальный узел. Если требуется поддержка относительно небольшого числа сложных запросов, можно создать пул клиентских узлов, чтобы снизить нагрузку на узлы данных. И наоборот, если необходимо обрабатывать большое количество простых запросов, отправляйте эти запросы прямо в узлы данных и используйте балансировщик нагрузки для их равномерного распределения.

### Настройка запросов

Ниже приведены рекомендации по повышению производительности запросов в Elasticsearch.

- По возможности не используйте запросы, содержащие подстановочные знаки.

- Если одно поле используется для полнотекстового поиска и поиска точного совпадения, сохраните данные поля в анализируемой и неанализируемой формах. Для полнотекстового поиска используйте анализируемое поле, а для поиска точного совпадения — неанализируемое поле.

- Запрашивайте возврат только необходимых данных. Если приложению требуется только информация, хранящаяся в подмножестве полей объемных документов, запрашивайте возврат только этого подмножества, а не всех документов. Этот подход позволяет снизить необходимый показатель пропускной способности сети кластера.

- По возможности используйте при поиске данных фильтры, а не запросы. Фильтр просто определяет, соответствует ли документ заданным условиям, тогда как запрос также оценивает степень соответствия такого документа. Значения, создаваемые с помощью фильтра, сохраняются в виде точечного рисунка, который указывает, соответствует ли документ условиям. Кроме того, эти значения могут кэшироваться в Elasticsearch. Если такие же условия фильтра будут применяться впоследствии, точечный рисунок можно извлечь из кэша и использовать для быстрого получения соответствующих документов. Дополнительные сведения см. в разделе [Internal Filter Operation](https://www.elastic.co/guide/en/elasticsearch/guide/current/_finding_exact_values.html#_internal_filter_operation) (Операции при выполнении фильтра).

- Для выполнения статического сравнения следует использовать фильтры *bool*, а для динамически вычисляемых фильтров, например таких, которые включают выполнение скриптов, или фильтров *geo-**, — только фильтры *and*, *or* и *not*.

- Если в запросе используются фильтры *bool*, а также *and*, *or* или *not* с фильтрами *geo-**, размещайте фильтры *and*, *or* и *not geo-** в конце, чтобы они обрабатывали наименьший набор данных.

    Точно так же используйте *post\_filter* для выполнения дорогостоящих операций фильтрации. Эти фильтры будут выполняться в последнюю очередь.

- Вместо аспектов рекомендуется использовать объединения. Избегайте вычисления анализируемых агрегатов и таких, которые имеют много возможных значений.

    > **Примечание**. Функция использования аспектов удалена в Elasticsearch версии 2.0.0.

- Если для приложения не требуется точное число совпадений, предпочтительнее применять объединение типа *cardinality*, а не *value\_count*. Точное число может быстро измениться. Кроме того, большинству приложений требуется лишь приблизительное количество.

- По возможности не используйте скрипты. Использование скриптов в запросах и фильтрах может быть дорогостоящим. К тому же результаты не кэшируются. Долговыполняющиеся скрипты могут бесконечно использовать потоки операций поиска, из-за чего последующие запросы будут помещаться в очередь. В случае переполнения очереди дальнейшие запросы будут отклонены.

## Тестирование и анализ производительности операций объединения и поиска

В этом разделе описаны результаты тестов, выполненных для кластеров и индексов в различных конфигурациях. Это были тесты двух типов.

- **Тест *приема и запроса***. При запуске этого теста индекс был пустой. Затем он заполнялся по мере выполнения операций массовой вставки (в результате каждой операции добавлялась 1000 документов). В то же время каждые 5 секунд выполнялись запросы для поиска документов, добавленных за последние 15 минут, и создания сводных данных. Этот тест обычно выполнялся в течение 24 часов. Этого времени достаточно, чтобы смоделировать ресурсоемкую рабочую нагрузку, включающую задачи приема данных больших объемов и запросы, выполняющиеся практически в режиме реального времени.

- **Тест *запроса***. Этот тест аналогичен тесту *приема и запроса*, однако процедура приема опускается, а индекс на каждом узле предварительно заполняется документами в количестве 100 млн. Набор выполняемых запросов изменен, а поиск документов не ограничивается теми, которые были добавлены за последние 15 минут, так как теперь используются статические данные. Тесты выполнялись в течение 90 минут. Чтобы определить шаблон производительности в этом случае, требуется меньше времени ввиду фиксированного объема данных.

---

У всех документов в индексе была одинаковая схема. В следующей таблице перечислены поля в схеме:

Имя | Тип | Примечания |
  ----------------------------- | ------------ | -------------------------------------------------------- |
 План | Строка | В рамках теста создается 200 уникальных организаций. |
 CustomField1–CustomField5 |Строка |Это пять строковых полей, для которых задается пустая строка.|
 DateTimeRecievedUtc |Timestamp |Дата и время добавления документа.|
 Узел |Строка |Для этого поля задается пустая строка.|
 HttpMethod |Строка |Для этого поля задается одно из следующих значений: POST, GET, PUT.|
 HttpReferrer |Строка |Для этого поля задается пустая строка.|
 HttpRequest |Строка |Это поле заполняется произвольным текстом длиной от 10 до 200 символов.|
 HttpUserAgent |Строка |Для этого поля задается пустая строка.|
 HttpVersion |Строка |Для этого поля задается пустая строка.|
 OrganizationName |Строка |Для этого поля задается значение поля Organization.|
 SourceIp |IP-адрес |Это поле содержит IP-адрес, указывающий на источник данных. |
 SourceIpAreaCode |Длинное целое |Для этого поля задается значение 0.|
 SourceIpAsnNr |Строка |Для этого поля задается значение "AS#####".|
 SourceIpBase10 |Длинное целое |Для этого поля задается значение 500.|
 SourceIpCountryCode |Строка |Это поле содержит двухзначный код страны. |
 SourceIpCity |Строка |Это поле содержит строку, определяющую город в стране. |
 SourceIpLatitude |Double |Это поле содержит случайное значение.|
 SourceIpLongitude |Double |Это поле содержит случайное значение.|
 SourceIpMetroCode |Длинное целое |Для этого поля задается значение 0.|
 SourceIpPostalCode |Строка |Для этого поля задается пустая строка.|
 SourceLatLong |Географическая точка |Для этого поля задается случайная географическая точка.|
 SourcePort |Строка |В этом поле указывается случайное число в виде строки.|
 TargetIp |IP-адрес |Это поле заполняется случайным IP-адресом в диапазоне 0.0.100.100–255.9.100.100.|
 SourcedFrom |Строка |Для этого поля задается строка MonitoringCollector.|
 TargetPort |Строка |В этом поле указывается случайное число в виде строки.|
 Rating |Строка |Это поле заполняется одним из 20 разных строковых значений, которое выбирается случайным образом.|
 UseHumanReadableDateTimes |Логический |Для этого поля задается значение false.|
 
Запросы, приведенные ниже, выполнялись в составе пакетной операции при каждой итерации теста. В остальной части статьи для ссылки на эти запросы будут использоваться имена, выделенные курсивом. Обратите внимание, что в тестах *запроса* не применялось ограничение по времени (документы, добавленные за последние 15 минут).

- Сколько документов с каждым значением поля *Rating* введены за последние 15 минут (*число по оценке*)?

- Сколько документов добавлены в течение каждого 5-минутного интервала за последние 15 минут (*число по времени*)?

- Сколько документов с каждым значением поля *Rating* добавлены для каждой страны за последние 15 минут (*число по странам*)?

- Какие 15 организаций наиболее часто встречаются в документах, добавленных за последние 15 минут (*15 самых распространенных организаций*)?

- Сколько разных организаций встречаются в документах, добавленных за последние 15 минут (*число уникальных организаций*)?

- Сколько документов добавлены за последние 15 минут (*общее число добавлений*)?

- Сколько разных значений *SourceIp* встречаются в документах, добавленных за последние 15 минут (*число уникальных IP-адресов*)?


Определение индекса и сведения о запросах см. в [приложении](#appendix-the-query-and-aggregation-performance-test).

Тесты предназначены определить влияние следующих переменных показателей:

- **Тип диска**. Тесты выполнены на шестиузловом кластере с виртуальными машинами серии D4 на базе стандартного хранилища (жесткие диски) и на таком же кластере с виртуальными машинами серии DS4 на базе хранилища класса Premium (SSD).

- **Увеличение размера виртуальной машины**. Тесты выполнены на шестиузловом кластере, состоящем из виртуальных машин серии DS3 (*небольшой* кластер), а затем на таком же кластере с виртуальными машинами серии DS4 (*средний* кластер) и виртуальными машинами серии DS14 (*большой* кластер). В следующей таблице приведены основные характеристики виртуальной машины для каждого SKU:

 HDInsight | SKU виртуальной машины | Количество ядер | Количество дисков данных | ОЗУ (ГБ) |
---------|---------------|-----------------|----------------------|----------|
 Малый | Standard DS3 | 4 | 8 | 14 |
 Средний | Standard DS4 | 8 | 16 | 28 |
 Крупный | Standard DS14 | 16 | 32 | 112 |

- **Горизонтальное масштабирование кластера**. Тесты выполнены для кластеров с виртуальными машинами DS14 и 1, 3 и 6 узлами.

- **Число реплик индекса**. Тесты выполнены с использованием индексов, настроенных с 1 и 2 репликами.

- **Значения doc values**. Изначально при выполнении тестов для параметра индекса *doc\_values* задано значение *true* (значение по умолчанию). Затем для выполнения некоторых тестов значение *doc\_values* изменено на *false*.

- **Кэширование**. При выполнении тестов для индекса было включено кэширование запросов к сегментам.

- **Число сегментов**. Тесты выполнены с разным количеством сегментов, чтобы определить, в каком случае запросы выполняются эффективнее: если индексы содержат меньшее количество больших сегментов или большее количество небольших сегментов.


## Результаты производительности по типу диска

Для оценки производительности диска использовался тест *приема и запроса*, который выполнялся на шестиузловом кластере с виртуальными машинами серии D4 (HDD) и DS4 (SSD). Конфигурация Elasticsearch в обоих кластерах была одинаковой. Данные были распределены по 16 дискам на каждом узле. Для виртуальной машины Java, где был запущен Elasticsearch, на каждом узле было выделено 14 ГБ ОЗУ. Оставшийся объем памяти (также 14 ГБ) предназначался для операционной системы. Каждый тест выполнялся в течение 24 часов. Этого периода достаточно, чтобы влияние увеличения объема данных стало очевидным и система стабилизировалась. В таблице ниже приведены показатели времени отклика для разных операций, выполненных в рамках теста.

 HDInsight | Операции и запросы | Среднее время отклика (мс) |
---------|----------------------------|----------------------------|
 D4 | Прием | 978 |
 | Число по оценке | 103 |
 | Число по времени | 134 |
 | Число по странам | 199 |
 | 15 самых распространенных организаций | 137 |
 | Число уникальных организаций | 139 |
 | Число уникальных IP-адресов | 510 |
 | Общее число добавлений | 89
 DS4 | Прием | 511 |
 | Число по оценке | 187 |
 | Число по времени | 411 |
 | Число по странам | 402 |
 | 15 самых распространенных организаций | 307 |
 | Число уникальных организаций | 320 |
 | Число уникальных IP-адресов | 841 |
 | Общее число добавлений | 236 |

На первый взгляд можно предположить, что кластер DS4 выполнил намного меньше запросов, чем кластер D4, и в некоторых случаях время отклика было в два раза больше (или хуже). Однако еще рано делать окончательные выводы. В следующей таблице приведено число операций приема на каждый кластер (при каждой операции загружается 1000 документов):

 HDInsight | Число операций приема |
---------|-------------------------|
 D4 | 264 769 |
 DS4 | 503 157 |

Во время теста кластер DS4 загрузил почти вдвое больше данных, чем кластер D4. Таким образом, при анализе времени отклика для каждой операции следует также учитывать, сколько документов проверяется во время каждого запроса и сколько документов возвращаются. Это динамические показатели, так как объем документов в индексе постоянно увеличивается. Чтобы определить сравнительные показатели, нельзя просто разделить 503 137 на 264 769 (число операций приема для каждого кластера), а затем умножить результат на среднее время отклика для каждого запроса, выполненного кластером D4, так как при этом не учитывается число одновременных операций ввода-вывода, выполняемых во время приема. Вместо этого необходимо определить физический объем данных, записываемых на диск и считываемых из него, во время выполнения теста. План тестирования JMeter позволяет получить эти сведения для каждого узла. Сводные результаты приведены в таблице ниже.

 HDInsight | Среднее число записанных и считанных байт по каждой операции |
---------|----------------------------------------------|
 D4 | 13 471 557 |
 DS4 | 24 643 470 |

Согласно этим данным, кластер DS4 поддерживал скорость ввода-вывода, которая приблизительно в 1,8 раз превышает этот показатель по кластеру D4. Учитывая то, что все остальные ресурсы одинаковые, эта разница должна быть связана с используемыми дисками (SSD и жесткие диски).

Чтобы обосновать это предположение, на следующих графиках показано, как выполнялись операции ввода-вывода с течением времени для каждого кластера:

![](./media/guidance-elasticsearch/query-performance2.png)

<!-- -->

***Рис. 2. Активность диска кластеров D4 и DS4***

На графике для кластера D4 видны значительные отличия, особенно во время первой части теста. Вероятно, это обусловлено регулированием, выполняемым для снижения скорости ввода-вывода. На начальных стадиях тестирования запросы обрабатываются быстро, так как объем данных для анализа небольшой. Поэтому диски в кластере D4, скорее всего, функционировали на грани предела операций ввода-вывода, несмотря на то, что не каждая такая операция возвращала большой объем данных. Кластер DS4 может поддерживать высокую скорость операций ввода-вывода без существенного увеличения степени регулирования, при этом скорость операций ввода-вывода более постоянная. Чтобы подтвердить эту теорию, на следующих графиках показано, как операции ввода-вывода диска время от времени блокировали ЦП (время ожидания диска, показанное на графиках, — это промежуток времени, когда ЦП ожидал ввода-вывода).

![](./media/guidance-elasticsearch/query-performance3.png)

***Рис. 3. Время ожидания дисковых операций ввода-вывода ЦП для кластеров D4 и DS4***

Важно понимать, что есть две основные причины, по которым операции ввода-вывода блокировали ЦП.

- Считывание данных с диска или их запись на диск подсистемой ввода-вывода.

- Регулирование подсистемы ввода-вывода в среде размещения. Максимальная пропускная способность жестких дисков Azure — 500 операций ввода-вывода, а накопителей SSD Azure — 5000 операций ввода-вывода.


Для кластера D4 время ожидания операций ввода-вывода во время первой части теста в обратном порядке соотносится со скоростью операций ввода-вывода. Периоды низкой скорости операций ввода-вывода соответствуют длительным периодам, в течение которых ЦП был заблокирован. Это означает, что операции ввода-вывода регулируются. По мере добавления большего количества данных в кластер ситуация меняется, и во время второй части теста пики времени ожидания операций ввода-вывода соответствуют пикам пропускной способности ввода-вывода. На этом этапе ЦП блокируется, чтобы выполнить фактические операции ввода-вывода. Опять же, при использовании кластера DS4 время ожидания операций ввода-вывода гораздо более равномерное и каждый пик совпадает с эквивалентным пиком производительности ввода-вывода, а не достигается за счет ухудшения показателя последнего. Это значит, что регулирования практически или совсем не происходит.

Есть еще один фактор, который следует рассмотреть. При тестировании кластера D4 возникли 10 584 ошибки приема и 21 ошибка запроса. При тестировании кластера DS4 никакие ошибки не наблюдались.

## Результаты производительности при увеличении размера

В рамках тестирования с увеличением размера тесты выполнялись на шестиузловых кластерах с виртуальными машинами DS3, DS4 и DS14. Эти SKU выбраны, так как виртуальная машина DS4 содержит в два раза больше ядер ЦП и памяти, чем DS3, а виртуальная машина DS14 предоставляет вдвое больше ресурсов ЦП и в четыре раза больший объем памяти. В следующей таблице приводится сравнение основных показателей по всем SKU.

 SKU | Число ядер ЦП | Память (ГБ) | Максимальное число дисковых операций ввода-вывода | Максимальная пропускная способность (МБ/с)|
------|-------------|-------------|---------------|--------------|
 DS3 | 4\. | 14 | 12 800| 128 |
 DS4 | 8 | 28 | 25 600| 256 |
 DS14 | 16 | 112 | 50 000| 512 |

В таблице ниже приведены результаты тестирования для небольшого (DS3), среднего (DS4) и большого (DS14) кластеров. Для хранения данных в каждой виртуальной машине использовались SSD. Каждый тест выполнялся в течение 24 часов.

> **Примечание**. В этой таблице содержится число успешных запросов каждого типа (неудачные запросы не учтены). Число попыток запросов, выполненных для каждого типа запроса в рамках теста, примерно одинаковое. Это связано с тем, что план тестирования JMeter предусматривает одно выполнение каждого запроса ("число по оценке", "число по времени", "число по странам", "15 самых распространенных организаций", "число уникальных организаций", "число уникальных IP-адресов" и "общее число добавлений") совместно в едином блоке, который называется *тестовой транзакцией* (эта транзакция не зависит от задачи, которая выполняет операцию приема в отдельном потоке). Каждая итерация плана тестирования выполняет одну тестовую транзакцию. Таким образом, количество выполненных тестовых транзакций представляет собой показатель времени отклика самого медленного запроса в каждой транзакции.

| HDInsight | Операции и запросы | Количество запросов | Среднее время отклика (мс) |
|--------------|----------------------------|--------------------|----------------------------|
| Небольшой (DS3) | Прием | 207 284 | 3328 |
| | Число по оценке | 18 444 | 268 |
| | Число по времени | 18 444 | 340 |
| | Число по странам | 18 445 | 404 |
| | 15 самых распространенных организаций | 18 439 | 323 |
| | Число уникальных организаций | 18 437 | 338 |
| | Число уникальных IP-адресов | 18 442 | 468 |
| | Общее число добавлений | 18 428 | 294   
|||||
| Средний (DS4) | Прием | 503 157 | 511 |
| | Число по оценке | 6958 | 187 |
| | Число по времени | 6958 | 411 |
| | Число по странам | 6958 | 402 |
| | 15 самых распространенных организаций | 6958 | 307 |
| | Число уникальных организаций | 6956 | 320 |
| | Число уникальных IP-адресов | 6955 | 841 |
| | Общее число добавлений | 6958 | 236 |
|||||
| Большой (DS14) | Прием | 502 714 | 511 |
| | Число по оценке | 7041 | 201 |
| | Число по времени | 7040 | 298 |
| | Число по странам | 7039 | 363 |
| | 15 самых распространенных организаций | 7038 | 244 |
| | Число уникальных организаций | 7037 | 283 |
| | Число уникальных IP-адресов | 7037 | 681 |
| | Общее число добавлений | 7038 | 200 |

Согласно этим показателям, производительность кластеров DS4 и DS14 в рамках этого теста примерно одинаковая. Время отклика запросов для кластера DS3 изначально существенно выше, а количество выполненных запросов значительно превышает аналогичные показатели по кластерам DS4 и DS14. Тем не менее некоторые показатели привлекают особое внимание: скорость приема и последующее количество документов, по которым выполнялся поиск. Скорость приема в кластере DS3 гораздо более ограничена, и по завершении теста база данных содержала только около 40 % документов, считанных в каждом из двух других кластеров. Это может быть связано с разницей в объеме вычислительных ресурсов, а также пропускной способности сети и диска виртуальной машины DS3 по сравнению с виртуальными машинами DS4 и DS14. С учетом того, что виртуальная машина DS4 предоставляет в два раза больше ресурсов, чем виртуальная машина DS3, а виртуальная машина DS14 — в два раза больше ресурсов (в четыре раза больше памяти), чем виртуальная машина DS4, остается единственный вопрос: почему разница в скорости приема между кластерами DS4 и DS14 значительно меньше подобной разницы между кластерами DS3 и DS4? Это может быть вызвано ограничениями использования сети и пропускной способности виртуальных машин Azure. На графиках ниже можно увидеть эти показатели для всех трех кластеров:

![](./media/guidance-elasticsearch/query-performance4.png)

***Рис. 4 Использование сети для кластеров DS3, DS4 и DS14 в ходе тестирования *приема и запроса****

<!-- -->

Ограничения пропускной способности сети виртуальных машин Azure не установлены официально и могут отличаться, но тот факт, что сетевая активность кластеров DS4 и DS14 остановилась на отметке примерно в 2,75 Гбит/с, означает, что такой предел достигнут. Это и стало основным фактором ограничения пропускной способности. Что же касается кластера DS3, сетевая активность была существенно ниже, поэтому низкая производительность, скорее всего, связана с ограничениями других ресурсов.

Чтобы устранить влияние операций приема и продемонстрировать, как производительность запросов зависит от увеличения количества узлов, выполнен набор тестов запроса с использованием тех же узлов. В следующей таблице приведены результаты, полученные для каждого кластера:

> [AZURE.NOTE] Не следует сравнивать производительность и количество выполненных запросов в рамках теста *запроса* с аналогичными показателями в рамках теста *приема и запроса*. Ведь запросы изменены и объем используемых документов отличается.

| HDInsight | Операции и запросы | Количество запросов | Среднее время отклика (мс) |
|--------------|----------------------------|--------------------|----------------------------|
| Небольшой (DS3) | Число по оценке | 464 | 11 758 |
| | Число по времени | 464 | 14 699 |
| | Число по странам | 463 | 14 075 |
| | 15 самых распространенных организаций | 464 | 11 856 |
| | Число уникальных организаций | 462 | 12 314 |
| | Число уникальных IP-адресов | 461 | 19 898 |
| | Общее число добавлений | 462 | 8882  
|||||
| Средний (DS4) | Число по оценке | 1045 | 4489 |
| | Число по времени | 1045 | 7292 |
| | Число по странам | 1053 | 7564 |
| | 15 самых распространенных организаций | 1055 | 5066 |
| | Число уникальных организаций | 1051 | 5231 |
| | Число уникальных IP-адресов | 1051 | 9228 |
| | Общее число добавлений | 1051 | 2180 |
|||||
| Большой (DS14) | Число по оценке | 1842 | 1927 |
| | Число по времени | 1839 | 4483 |
| | Число по странам | 1838 | 4761 |
| | 15 самых распространенных организаций | 1842 | 2117 |
| | Число уникальных организаций | 1837 | 2393 |
| | Число уникальных IP-адресов | 1837 | 7159 |
| | Общее число добавлений | 1837 | 642 |

На этот раз тенденции среднего времени отклика в разных кластерах более понятны. Показатели использования сети значительно меньше 2,75 Гбит/с, ранее наблюдавшихся для кластеров DS4 и DS14 (что, возможно, служило причиной перегрузки сети в тестах приема и запроса), и 1,5 Гбит/с для кластера DS3. На самом деле, этот показатель приближен к отметке в 200 Мбит/с для всех кластеров, как видно на следующих графиках.

![](./media/guidance-elasticsearch/query-performance5.png)

***Рис. 5. Использование сети для кластеров DS3, DS4 и DS14 в ходе тестирования *запросов****

Теперь ограничивающим фактором для кластеров DS3 и DS4 выступает показатель загрузки ЦП, который большую часть времени близок к 100 %. Средний коэффициент загрузки ЦП в кластере DS14 — чуть более 80 %. Это по-прежнему высокий показатель, однако, исходя из этой цифры, преимущества использования дополнительных ядер ЦП очевидны. Следующие графики демонстрируют шаблоны загрузки ЦП для кластеров DS3, DS4 и DS14.

![](./media/guidance-elasticsearch/query-performance6.png)

***Рис. 6. Загрузка ЦП для кластеров DS3 и DS14 при выполнении теста *запроса****

## Результаты производительности при горизонтальном масштабировании

Чтобы продемонстрировать, каким образом система масштабируется по мере добавления узлов, выполнены тесты для кластеров DS14 с 1, 3 и 6 узлами. На этот раз использовался только тест *запроса*, который выполнялся в течение 90 минут с нагрузкой в 100 млн документов.

> [AZURE.NOTE] Дополнительные сведения о влиянии горизонтального масштабирования на операции приема данных см. в статье [Maximizing Data Ingestion Performance with Elasticsearch on Azure](https://github.com/mspnp/azure-guidance/blob/master/Elasticsearch-Data-Ingestion-Performance.md) (Максимальное увеличение производительности приема данных с помощью Elasticsearch в Azure).

| HDInsight | Операции и запросы | Количество запросов | Среднее время отклика (мс) |
|---------|----------------------------|--------------------|----------------------------|
| 1 узел | Число по оценке | 288 | 6216 |
| | Число по времени | 288 | 28 933 |
| | Число по странам | 288 | 29 455 |
| | 15 самых распространенных организаций | 288 | 9058 |
| | Число уникальных организаций | 287 | 19 916 |
| | Число уникальных IP-адресов | 284 | 54 203 |
| | Общее число добавлений | 287 | 3333 |
|||||
| 3 узла | Число по оценке | 1194 | 3427 |
| | Число по времени | 1194 | 5381 |
| | Число по странам | 1191 | 6840 |
| | 15 самых распространенных организаций | 1196 | 3819 |
| | Число уникальных организаций | 1190 | 2938 |
| | Число уникальных IP-адресов | 1189 | 12 516 |
| | Общее число добавлений | 1191 | 1272 |
|||||
| 6 узлов | Число по оценке | 1842 | 1927 |
| | Число по времени | 1839 | 4483 |
| | Число по странам | 1838 | 4761 |
| | 15 самых распространенных организаций | 1842 | 2117 |
| | Число уникальных организаций | 1837 | 2393 |
| | Число уникальных IP-адресов | 1837 | 7159 |
| | Общее число добавлений | 1837 | 642 |

Число узлов существенно влияет на производительность запросов кластера, хотя и нелинейным образом. Кластер с 3 узлами выполняет примерно в 4 раза больше запросов, а шестиузловой кластер — в 6 раз больше запросов, чем кластер с 1 узлом. Чтобы упростить объяснение такой нелинейности, приведены следующие графики, на которых показана загрузка ЦП в трех кластерах.

![](./media/guidance-elasticsearch/query-performance7.png)

***Рис. 7. Загрузка ЦП для кластеров с 1, 3 и 6 узлами при выполнении теста *запроса****

Кластеры с одним и тремя узлами используют все ресурсы ЦП. Коэффициент загрузки ЦП в кластере с 6 узлами также высокий, однако в этом кластере еще есть доступная вычислительная мощность. В этом случае на пропускную способность, скорее всего, влияют другие факторы. Это можно подтвердить, выполнив тесты для кластеров с 9 и 12 узлами. Вероятно, доступной вычислительной мощности будет еще больше.

В таблице выше также видно, как отличается среднее время отклика для запросов. Это самый информативный показатель при тестировании масштабирования системы с учетом определенных типов запросов. Некоторые запросы гораздо более эффективны, если используется большее количество узлов. Это может зависеть от соотношения числа узлов и документов в расширяемом кластере. Во время проведения наших тестов каждый кластер содержал 100 млн документов. При выполнении операций поиска, включающих объединение данных, Elasticsearch обрабатывает данные, полученные в процессе объединения, и помещает их в буфер памяти на каждом узле. Чем больше узлов, тем меньший объем данных, которые можно извлекать, обрабатывать и помещать в буфер на каждом узле.

## Результаты производительности в зависимости от числа реплик

Тестирование *приема и запроса* выполнялось для индекса с одной репликой. Оно также было повторно проведено для шестиузловых кластеров DS4 и DS14 с использованием индекса, настроенного с двумя репликами. Все тесты выполнялись в течение 24 часов. В следующей таблице приведены результаты для одной и двух реплик:

| HDInsight | Операции и запросы | Среднее время отклика (мс) при использовании 1 реплики | Среднее время отклика (мс) при использовании 2 реплик | Разница во времени отклика в % |
|---------|----------------------------|----------------------------------------|-----------------------------------------|-------------------------------|
| DS4 | Прием | 511 | 655 | +28 % |
| | Число по оценке | 187 | 168 | –10 % |
| | Число по времени | 411 | 309 | –25 % |
| | Число по странам | 402 | 562 | +40 % |
| | 15 самых распространенных организаций | 307 | 366 | +19 % |
| | Число уникальных организаций | 320 | 378 | +18 % |
| | Число уникальных IP-адресов | 841 | 987 | +17 % |
| | Общее число добавлений | 236 | 236 | +0 % |
||||||
| DS14 | Прием | 511 | 618 | +21 % |
| | Число по оценке | 201 | 275 | +37 % |
| | Число по времени | 298 | 466 | +56 % |
| | Число по странам | 363 | 529 | +46 % |
| | 15 самых распространенных организаций | 244 | 407 | +67 % |
| | Число уникальных организаций | 283 | 403 | +42 % |
| | Число уникальных IP-адресов | 681 | 823 | +21 % |
| | Общее число добавлений | 200 | 221 | +11 % |

С увеличением числа реплик скорость приема снизилась. Этого следовало ожидать, так как Elasticsearch записывает больше копий каждого документа, создавая дополнительные дисковые операции ввода-вывода. Это видно на приведенных ниже графиках для кластера DS14 с индексами, настроенными с 1 и 2 репликами. Средняя скорость выполнения операций ввода-вывода для индекса с 1 репликой — 16 896 573 байт в секунду. Средняя скорость выполнения операций ввода-вывода для индекса с 2 репликами — 33 986 843 байт в секунду, т. е. в два раза больше.

![](./media/guidance-elasticsearch/query-performance8.png)

***Рис. 8. Скорость выполнения операций ввода-вывода для узлов с 1 и 2 репликами в ходе тестирования *приема и запроса****

| HDInsight | Запрос | Среднее время отклика (мс) при использовании 1 реплики | Среднее время отклика (мс) при использовании 2 реплик |
|---------|----------------------------|----------------------------------------|-----------------------------------------|
| DS4 | Число по оценке | 4489 | 4079 |
| | Число по времени | 7292 | 6697 |
| | Число по странам | 7564 | 7173 |
| | 15 самых распространенных организаций | 5066 | 4650 |
| | Число уникальных организаций | 5231 | 4691 |
| | Число уникальных IP-адресов | 9228 | 8752 |
| | Общее число добавлений | 2180 | 1909 |
|||||
| DS14 | Число по оценке | 1927 | 2330 |
| | Число по времени | 4483 | 4381 |
| | Число по странам | 4761 | 5341 |
| | 15 самых распространенных организаций | 2117 | 2560 |
| | Число уникальных организаций | 2393 | 2546 |
| | Число уникальных IP-адресов | 7159 | 7048 |
| | Общее число добавлений | 642 | 708 |

Согласно этим показателям, среднее время отклика для кластера DS4 снизилось, а для кластера DS14 — увеличилось. Чтобы лучше интерпретировать эти результаты, необходимо учитывать количество запросов, выполненных в рамках каждого теста.

| HDInsight | Запрос | Число выполненных запросов при использовании 1 реплики | Число выполненных запросов при использовании 2 реплик |
|---------|----------------------------|------------------------------|-------------------------------|
| DS4 | Число по оценке | 1054 | 1141 |
| | Число по времени | 1054 | 1139 |
| | Число по странам | 1053 | 1138 |
| | 15 самых распространенных организаций | 1055 | 1141 |
| | Число уникальных организаций | 1051 | 1136 |
| | Число уникальных IP-адресов | 1051 | 1135 |
| | Общее число добавлений | 1051 | 1136 |
|||||
| DS14 | Число по оценке | 1842 | 1718 |
| | Число по времени | 1839 | 1716 |
| | Число по странам | 1838 | 1714 |
| | 15 самых распространенных организаций | 1842 | 1718 |
| | Число уникальных организаций | 1837 | 1712 |
| | Число уникальных IP-адресов | 1837 | 1712 |
| | Общее число добавлений | 1837 | 1712 |

Согласно этим данным, количество запросов, выполненных кластером DS4, увеличилось, а показатель среднего времени отклика ухудшился. При этом для кластера DS14 наблюдается обратная ситуация. Одним важным аспектом является то, что загрузка ЦП в кластере DS4 с 1 и 2 репликами была распределена неравномерно. Некоторые узлы использовали ЦП почти на 100 %, в то время как у других оставалась доступная вычислительная мощность. Улучшение производительности, скорее всего, связано с повышенной возможностью распределения задач обработки по узлам кластера. На следующих графиках можно увидеть разницу в показателях обработки ЦП для виртуальных машин с наименьшей и наибольшей нагрузками (3 и 4 узла):

![](./media/guidance-elasticsearch/query-performance9.png)

***Рис. 9. Загрузка ЦП по узлам кластера DS4, которые используются реже и чаще всего, при выполнении теста *запроса****

Для кластера DS14 наблюдалась иная тенденция. Загрузка ЦП в рамках обоих тестов была ниже на всех узлах, а вторая реплика лишь увеличивала нагрузку и не предоставляла ощутимых преимуществ.

![](./media/guidance-elasticsearch/query-performance10.png)

***Рис. 10. Загрузка ЦП по узлам кластера DS14, которые используются реже и чаще всего, при выполнении теста *запроса****

На основе полученных результатов можно сделать такой вывод: прежде чем принять решение об использовании нескольких реплик, необходимо тщательно протестировать производительность системы. Если вы не готовы рисковать потерей данных в случае сбоя узла, следует создать по крайней мере одну реплику каждого индекса. Однако в зависимости от рабочих нагрузок и аппаратных ресурсов кластера дополнительные реплики могут увеличить нагрузку на систему без каких-либо существенных преимуществ.

## Результаты производительности при использовании значений doc values

Тесты *приема и запросов* проводились с включенными значениями doc values. Как результат, в Elasticsearch данные сортировки полей сохранялись на диск. Затем тесты были выполнены с отключенными значениями doc values. Таким образом, в Elasticsearch динамически создавались и кэшировались в памяти данные fielddata. Все тесты выполнялись в течение 24 часов. В следующей таблице приводится сравнение полученного времени отклика для шестиузловых кластеров с виртуальными машинами D4, DS4 и DS14 (кластер D4 использует обычные жесткие диски, а кластеры DS4 и DS14 — SSD).

| HDInsight | Операции и запросы | Среднее время отклика (мс) при включенных значениях doc values | Среднее время отклика (мс) при отключенных значениях doc values | Разница во времени отклика в % |
|---------|----------------------------|-------------------------------------------------|--------------------------------------------------|-------------------------------|
| D4 | Прием | 978 | 835 | –15 % |
| | Число по оценке | 103 | 132 | +28 % |
| | Число по времени | 134 | 189 | +41 % |
| | Число по странам | 199 | 259 | +30 % |
| | 15 самых распространенных организаций | 137 | 184 | +34 % |
| | Число уникальных организаций | 139 | 197 | +42 % |
| | Число уникальных IP-адресов | 510 | 604 | +18 % |
| | Общее число добавлений | 89 | 134 | +51 % |
||||||
| DS4 | Прием | 511 | 581 | +14 % |
| | Число по оценке | 187 | 190 | +2 % |
| | Число по времени | 411 | 409 | –0,5 % |
| | Число по странам | 402 | 414 | +3 % |
| | 15 самых распространенных организаций | 307 | 284 | –7 % |
| | Число уникальных организаций | 320 | 313 | –2 % |
| | Число уникальных IP-адресов | 841 | 955 | +14 % |
| | Общее число добавлений | 236 | 281 | +19 % |
||||||
| DS14 | Прием | 511 | 571 | +12 % |
| | Число по оценке | 201 | 232 | +15 % |
| | Число по времени | 298 | 341 | +14 % |
| | Число по странам | 363 | 457 | +26 % |
| | 15 самых распространенных организаций | 244 | 338 | +39 % |
| | Число уникальных организаций | 283 | 350 | +24 % |
| | Число уникальных IP-адресов | 681 | 909 | +33 % |
| | Общее число добавлений | 200 | 245 | +23 % |

В следующей таблице приведено количество выполненных операций приема в рамках тестов:

| HDInsight | Число операций приема при включенных значениях doc values | Число операций приема при отключенных значениях doc values | Разница в числе операций приема в % |
|---------|----------------------------------------------|-----------------------------------------------|-----------------------------------------|
| D4 | 264 769 | 408 690 | +54 % |
| DS4 | 503 137 | 578 237 | +15 % |
| DS14 | 502 714 | 586 472 | +17 % |

Скорость приема лучше при отключенных значениях doc values, так как во время добавления документов на диск записывается меньше данных. Повышение производительности особенно заметно для виртуальной машины D4, использующей для хранения данных жесткие диски. Время отклика операций приема для этой машины уменьшилось на 15 % (см. первую таблицу в этом разделе). Это может быть связано с уменьшением нагрузки на жесткие диски, которые, скорее всего, выполняли практически максимальное число операций ввода-вывода при включенных значениях doc values. Дополнительные сведения см. в разделе о результатах тестов по типу диска. На графиках ниже показана производительность операций ввода-вывода виртуальных машин D4 при включенных (значения хранятся на диске) и отключенных значениях doc values (значения хранятся в памяти):

![](./media/guidance-elasticsearch/query-performance11.png)

***Рис. 11. Активность диска для кластера D4 при включенных и отключенных значениях doc values***

Напротив, число принятых документов для виртуальных машин с SSD немного больше, а время отклика операций приема увеличено. За некоторыми исключениями, время отклика запросов также было хуже. Вероятность того, что накопители SSD могут выполнять максимальное количество операций ввода-вывода при включенных значениях doc values, гораздо меньше, поэтому изменения производительности, скорее всего, связаны с увеличенной активностью обработки и накладными расходами на управление кучей виртуальной машины Java. Это можно доказать, сравнив загрузку ЦП при включенных и отключенных значениях doc values. Следующие графики демонстрируют эти показатели для кластера DS4. При включенных значениях doc values коэффициент загрузки ЦП достигает 30–40 %, а при отключенных — 40–50 % (то же самое наблюдается для кластера DS14):

![](./media/guidance-elasticsearch/query-performance12.png)

***Рис. 12. Загрузка ЦП для кластера DS4 при включенных и отключенных значениях doc values***

Чтобы различить влияние использования значений doc values на производительность запросов и приема данных, выполнено по два теста запроса для кластеров DS4 и DS14 при включенных и отключенных значениях doc values. В таблице ниже приведены результаты этих тестов.

| HDInsight | Операции и запросы | Среднее время отклика (мс) при включенных значениях doc values | Среднее время отклика (мс) при отключенных значениях doc values | Разница во времени отклика в % |
|---------|----------------------------|-------------------------------------------------|--------------------------------------------------|-------------------------------|
| DS4 | Число по оценке | 4489 | 3736 | –16 % |
| | Число по времени | 7293 | 5459 | –25 % |
| | Число по странам | 7564 | 5930 | –22 % |
| | 15 самых распространенных организаций | 5066 | 3874 | –14 % |
| | Число уникальных организаций | 5231 | 4483 | –2 % |
| | Число уникальных IP-адресов | 9228 | 9474 | +3 % |
| | Общее число добавлений | 2180 | 1218 | –44 % |
||||||
| DS14 | Число по оценке | 1927 | 2144 | +11 % |
| | Число по времени | 4483 | 4337 | –3 % |
| | Число по странам | 4761 | 4840 | +2 % |
| | 15 самых распространенных организаций | 2117 | 2302 | +9 % |
| | Число уникальных организаций | 2393 | 2497 | +4 % |
| | Число уникальных IP-адресов | 7159 | 7639 | +7 % |
| | Общее число добавлений | 642 | 633 | –1 % |

Помните, что в Elasticsearch, начиная с версии 2.0, значения doc values включены по умолчанию. В тестах, проводимых в кластере DS4, отключение значений doc values в целом оказывает положительное влияние, тогда как в кластере DS14 наоборот (два случая, когда производительность была лучше при отключенных значениях doc values, не являются показательными).

В обоих случаях коэффициент загрузки ЦП в кластере DS4 составлял примерно 100 % в рамках двух тестов. Это означает, что кластер использует много ресурсов ЦП. Тем не менее число обработанных запросов уменьшилось с 7369 до 5894 (на 20 %). См. таблицу ниже. Помните, что если значения doc values отключены, Elasticsearch будет динамически создавать данные fielddata в памяти, потребляя ресурсы ЦП. При этой конфигурации значительно снижается скорость дисковых операций ввода-вывода, но повышается нагрузка на ЦП, который уже практически полностью загружен. Поэтому в этом случае запросы выполняются быстрее, если значения doc values отключены, однако число запросов меньше.

В тестах для кластера DS14 с включенными и отключенными значениями doc values загрузка ЦП была высокой, но не достигала 100 %. В тестах с включенными значениями doc values число выполненных запросов было немного выше (приблизительно на 4 %):

| HDInsight | Запрос | Число выполненных запросов при включенных значениях doc values | Число выполненных запросов при отключенных значениях doc values |
|---------|----------------------------|---------------------------------------|----------------------------------------|
| DS4 | Число по оценке | 1054 | 845 |
| | Число по времени | 1054 | 844 |
| | Число по странам | 1053 | 842 |
| | 15 самых распространенных организаций | 1055 | 846 |
| | Число уникальных организаций | 1051 | 839 |
| | Число уникальных IP-адресов | 1051 | 839 |
| | Общее число добавлений | 1051 | 839  
||||| |
| DS14 | Число по оценке | 1772 | 1842 |
| | Число по времени | 1772 | 1839 |
| | Число по странам | 1770 | 1838 |
| | 15 самых распространенных организаций | 1773 | 1842 |
| | Число уникальных организаций | 1769 | 1837 |
| | Число уникальных IP-адресов | 1768 | 1837 |
| | Общее число добавлений | 1769 | 1837 |

## Результаты производительности при кэшировании запросов к сегментам

Чтобы показать, каким образом кэширование данных индекса в памяти каждого узла может повлиять на производительность, на 6-узловом кластере DS4 и DS14 с включенным кэшированием индекса проведен тест *запроса и приема*. Дополнительные сведения см. в разделе [Кэширование запросов к сегментам](#using-the-shard-request-cache). Эти результаты сравнивались с результатами предыдущих тестов, при выполнении которых использовался тот же индекс, но кэширование индекса было отключено. Результаты приведены в таблице ниже. Обратите внимание, что здесь представлены данные только для первых 90 минут теста. Этого времени было достаточно, чтобы сформировалась тенденция, и, скорее всего, продолжение теста не принесло бы никаких дополнительных сведений.

| HDInsight | Операции и запросы | Среднее время отклика (мс) при отключенном кэшировании индекса | Среднее время отклика (мс) при включенном кэшировании индекса | Разница во времени отклика в % |
|---------|----------------------------|---------------------------------------------------|--------------------------------------------------|-------------------------------|
| DS4 | Прием | 504 | 3260 | +547 % |
| | Число по оценке | 218 | 273 | +25 % |
| | Число по времени | 450 | 314 | –30 % |
| | Число по странам | 447 | 397 | –11 % |
| | 15 самых распространенных организаций | 342 | 317 | –7 % |
| | Число уникальных организаций | 370 | 324 | –12 % |
| | Число уникальных IP-адресов | 760 | 355 | –53 % |
| | Общее число добавлений | 258 | 291 | +12 % |
||||||
| DS14 | Прием | 503 | 3365 | +569 % |
| | Число по оценке | 234 | 262 | +12 % |
| | Число по времени | 357 | 298 | –17 % |
| | Число по странам | 416 | 383 | –8 % |
| | 15 самых распространенных организаций | 272 | 324 | –7 % |
| | Число уникальных организаций | 330 | 321 | –3 % |
| | Число уникальных IP-адресов | 674 | 352 | –48 % |
| | Общее число добавлений | 227 | 292 | +29 % |

На основе этих данных можно выделить две интересные особенности.

-  При включении кэширования индекса скорость приема данных существенно снижается.

-  Кэширование индекса вовсе не обязательно улучшает время отклика запросов всех типов и может оказать неблагоприятное воздействие на некоторые статистические операции, такие как операции, выполняемые во время запросов числа по оценке и общего числа добавлений.
 

Чтобы понять причину такого поведения системы, следует учесть число успешно выполненных запросов в рамках теста в каждом из случаев. В следующей таблице представлены эти данные.

| HDInsight | Операции и запросы | Число операций или запросов при отключенном кэшировании индекса | Число операций или запросов при включенном кэшировании индекса |
|---------|----------------------------|-------------------------------------------------|------------------------------------------------|
| DS4 | Прием | 38 611 | 13 232 |
| | Число по оценке | 524 | 18 704 |
| | Число по времени | 523 | 18 703 |
| | Число по странам | 522 | 18 702 |
| | 15 самых распространенных организаций | 521 | 18 706 |
| | Число уникальных организаций | 521 | 18 700 |
| | Число уникальных IP-адресов | 521 | 18 699 |
| | Общее число добавлений | 521 | 18 701  
|||| |
| DS14 | Прием | 38 769 | 12 835 |
| | Число по оценке | 528 | 19 239 |
| | Число по времени | 528 | 19 239 |
| | Число по странам | 528 | 19 238 |
| | 15 самых распространенных организаций | 527 | 19 240 |
| | Число уникальных организаций | 524 | 19 234 |
| | Число уникальных IP-адресов | 524 | 19 234 |
| | Общее число добавлений | 527 | 19 236 |

Как видно, хотя скорость приема при включенном кэшировании была в 3 раза меньше скорости при отключенном кэшировании, число выполненных запросов увеличилось в 34 раза. Для запросов больше не требуется такое количество дисковых операций ввода-вывода, и они не конкурируют за ресурсы диска. Это отображено на графиках на рис. 13 ниже, где представлены тенденции операций ввода-вывода для всех четырех случаев.

![](./media/guidance-elasticsearch/query-performance13.png)

***Рис. 13. Операции ввода-вывода диска в ходе тестирования *приема и запроса* с включенным и отключенным кэшированием индекса***

Уменьшение количества дисковых операций ввода-вывода также означает, что ЦП тратит меньше времени на ожидание завершения этих операций, что видно на рис. 14.

![](./media/guidance-elasticsearch/query-performance14.png)

***Рис. 14. Время ЦП, потраченное на ожидание завершения дисковых операций ввода-вывода в ходе тестирования *приема и запроса* с включенным и отключенным кэшированием индекса***

Уменьшение количества дисковых операций ввода-вывода означает, что Elasticsearch может потратить гораздо больше времени на обслуживание запросов на основе данных, содержащихся в памяти. А это, в свою очередь, повышает загрузку ЦП. Это становится очевидно, если рассмотреть загрузку ЦП во всех четырех случаях. На следующих графиках показано, что загрузка ЦП более устойчивая при включенном кэшировании.

![](./media/guidance-elasticsearch/query-performance15.png)

***Рис. 15. Загрузка ЦП в ходе тестирования *приема и запроса* с включенным и отключенным кэшированием индекса***

Количество сетевых операций ввода-вывода для обоих случаев в ходе проведения тестов одинаковое. В ходе проведения тестов без кэширования наблюдалось постепенное снижение этого количества, но при выполнении тестов в течение более продолжительного периода (24 часа) этот показатель остановился на отметке приблизительно в 2,75 Гбит/с. Эти данные для кластеров DS4 представлены на рисунке ниже (данные для кластеров DS14 были схожи).

![](./media/guidance-elasticsearch/query-performance16.png)

***Рис. 16. Объемы сетевого трафика в ходе проведения теста *приема и запроса* с включенным и отключенным кэшированием индекса***

Как описано в разделе о тесте с [увеличением размера](#performance-results-scaling-up), ограничения пропускной способности сети виртуальных машин Azure не установлены официально и могут отличаться, но, исходя из среднего уровня загрузки ЦП и активности диска, можно предположить, что использование сети — это ограничивающий фактор в этом сценарии.

Кэширование больше подходит для сценариев, где данные изменяются редко. Чтобы определить влияние кэширования в этом сценарии, тесты *запроса* проводились с включенным кэшированием. Ниже приведены результаты (эти тесты выполнялись в течение 90 минут, а в индексах теста содержалось 100 млн документов).

| HDInsight | Запрос | Среднее время отклика (мс) | Число выполненных запросов |
|---------|----------------------------|----------------------------|-------------------------|
| | | **Кэширование отключено** | **Кэширование включено** |
| DS4 | Число по оценке | 4489 | 210 |
| | Число по времени | 7292 | 211 |
| | Число по странам | 7564 | 231 |
| | 15 самых распространенных организаций | 5066 | 211 |
| | Число уникальных организаций | 5231 | 211 |
| | Число уникальных IP-адресов | 9228 | 218 |
| | Общее число добавлений | 2180 | 210  
|||| |
| DS14 | Число по оценке | 1927 | 211 |
| | Число по времени | 4483 | 219 |
| | Число по странам | 4761 | 236 |
| | 15 самых распространенных организаций | 2117 | 212 |
| | Число уникальных организаций | 2393 | 212 |
| | Число уникальных IP-адресов | 7159 | 220 |
| | Общее число добавлений | 642 | 211 |

Различия в производительности в ходе тестирования без кэширования обусловлены разницей в количестве доступных ресурсов для виртуальных машин DS14 и DS4. В обоих случаях в ходе тестирования с кэшированием среднее время отклика значительно сократилось, так как данные извлекались непосредственно из памяти. Стоит также отметить, что показатели времени отклика в ходе тестирования кластеров DS4 и DS14 с кэшированием были очень схожи, несмотря на то, что в тесте без кэширования результаты отличались. Показатели времени отклика для каждого запроса в рамках тестов также практически не отличаются. Они составляют приблизительно 220 мс. Показатели скорости дисковых операций ввода-вывода и загрузки ЦП для обоих кластеров очень низкие. Так как все данные хранятся в памяти, требуется незначительное количество операций ввода-вывода или обработки. Показатели скорости сетевых операций ввода-вывода совпали с результатами тестов без кэширования. Это подтверждает, что пропускная способность сети может быть ограничивающим фактором в этом тесте. На следующих графиках представлены эти данные для кластера DS4. Профиль кластера DS14 очень похож.

![](./media/guidance-elasticsearch/query-performance17.png)

***Рис. 17. Операции ввода-вывода, загрузка ЦП и сети в ходе тестирования *запросов* с включенным кэшированием индекса***

На основе данных, приведенных в таблице выше, можно предположить, что архитектура DS14 приносит меньше преимуществ по сравнению с архитектурой DS4. Количество примеров, созданных в кластере DS14, примерно на 5 % меньше, чем в кластере DS4. Но это может быть обусловлено ограничениями сети, которые могут немного меняться со временем.

## Результаты производительности в зависимости от числа сегментов

Цель этого теста — определить, влияет ли количество сегментов, созданных для индекса, на производительность запросов этого индекса.

Отдельные тесты, проводимые ранее, продемонстрировали, что конфигурация сегментов индекса может влиять на скорость приема данных. Эти тесты описаны в статье [Maximizing Data Ingestion Performance with Elasticsearch on Azure](https://github.com/mspnp/azure-guidance/blob/master/Elasticsearch-Data-Ingestion-Performance.md) (Максимальное увеличение производительности приема данных с помощью Elasticsearch в Azure). Тесты для определения производительности запросов проводились по похожим принципам, но только на 6-узловом кластере с виртуальными машинами DS14. Такой подход позволяет свести к минимуму количество переменных. Таким образом, любые различия в производительности связаны с объемом сегментов.

Тест *запроса* проводился на копиях того же индекса, настроенного с таким количеством основных сегментов: 7, 13, 23, 37 и 61. В индексе содержались 100 млн документов и одна реплика, которая удваивает количество сегментов в кластере. Каждый тест выполнялся в течение 90 минут. В следующей таблице представлены эти результаты. Показатель среднего времени отклика — это время отклика тестовой транзакции JMeter, которая включает в себя полный набор запросов, выполняемых каждой итерацией теста. Дополнительные сведения см. в разделе [Результаты производительности при увеличении размера](#performance-results-scaling-up).

| Число сегментов | Структура сегментов (сегментов на каждый узел, включая реплики) | Число выполненных запросов | Среднее время отклика (мс) |
|---------------------------|----------------------------------------------------|-----------------------------|------------------------|
| 7 (14 с репликами) | 3-2-2-2-2-3 | 7461 | 40524 |
| 13 (26) | 5-4-5-4-4-4 | 7369 | 41 055 |
| 23 (46) | 7-8-8-7-8-8 | 14 193 | 21 283 |
| 37 (74) | 13-12-12-13-12-12 | 13 399 | 22 506 |
| 61 (122) | 20-21-20-20-21-20 | 14 743 | 20 445 |

Эти результаты показывают, что показатели производительности кластера с 13 (26) и 23 (46) сегментами существенно отличаются. Показатели пропускной способности первого практически вдвое ниже, а показатели времени отклика — вдвое выше. Скорее всего, это связано с конфигурацией виртуальных машин и структур, используемых в Elasticsearch для обработки поисковых запросов. Поисковые запросы ставятся в очередь, и каждый из них обрабатывается одним потоком поиска. Количество потоков поиска, созданных узлом Elasticsearch, зависит от количества процессоров, доступных на компьютере, где размещен узел. Исходя из результатов, можно предположить, что если на узле всего 4 или 5 сегментов, ресурсы обработки используются лишь частично. Это подтверждают показатели загрузки ЦП, наблюдаемые в ходе этого тестирования. Следующее изображение — это снимок, взятый из Marvel при тестировании кластера с 13 (26) сегментами.

![](./media/guidance-elasticsearch/query-performance18.png)

***Рис. 18. Загрузка ЦП в ходе тестирования *запросов* в кластере с 7 (14) сегментами***

Сравните эти данные с результатами теста для кластера с 23 (46) сегментами.

![](./media/guidance-elasticsearch/query-performance19.png)

***Рис. 19. Загрузка ЦП в ходе тестирования *запросов* в кластере с 23 (46) сегментами***

При тестировании кластера с 23 (46) сегментами показатели загрузки ЦП были гораздо больше. Каждый узел содержит 7 или 8 сегментов. Архитектура DS14 предоставляет 16 процессоров, и Elasticsearch лучше использует это число ядер при наличии дополнительных сегментов. На основании данных, приведенных в таблице выше, можно предположить, что увеличение количества сегментов может незначительно повысить производительность, однако эти показатели следует рассматривать с учетом дополнительной нагрузки из-за обслуживания большого количества сегментов. "Золотая середина" этих тестов достигается, если оптимальное число сегментов на каждом узле соответствует половине числа ядер ЦП, доступных на каждом узле. Однако помните, что эти результаты достигнуты только при выполнении запросов. Если система импортирует данные, необходимо также учитывать влияние сегментирования на производительность операций приема данных. Дополнительные сведения относительно этого аспекта см. в статье [Maximizing Data Ingestion Performance with Elasticsearch on Azure](https://github.com/mspnp/azure-guidance/blob/master/Elasticsearch-Data-Ingestion-Performance.md) (Максимальное увеличение производительности приема данных с помощью Elasticsearch в Azure).

## Сводка

Elasticsearch предоставляет многие варианты структуризации и настройки индексов для поддержки крупномасштабных операций запросов. В этом документе приведены некоторые распространенные конфигурации и методы настройки базы данных для запросов. Однако следует иметь в виду, что в отличие от поддержки приема данных больших объемов между оптимизацией базы данных и поддержкой быстрого извлечения данных предполагается некоторый компромисс. Иногда то, что подходит для выполнения запросов, может оказать неблагоприятное воздействие на операции вставки и наоборот. В системе со смешанными рабочими нагрузками необходимо определить баланс и настроить системные параметры соответствующим образом.

Кроме того, то, какие конфигурации и методы подходят в том или ином случае, зависит от структуры данных и ограничений оборудования (или наоборот), на основе которого создана система. Многие тесты, описанные в данном документе, иллюстрируют, как выбор аппаратной платформы может повлиять на пропускную способность, а также, каким образом некоторые стратегии могут быть эффективными в одних случаях и неблагоприятными — в других. Чтобы определить наиболее оптимальное сочетание, очень важно изучить доступные варианты, а затем выполнить тщательное тестирование производительности, используя собственные данные.

Наконец, помните, что база данных Elasticsearch не обязательно является статической. Скорее всего, со временем ее объем увеличится. А стратегии, используемые для структурирования данных, необходимо регулярно пересматривать. К примеру, может потребоваться увеличить или уменьшить размер либо повторно выполнить индексацию данных с помощью дополнительных сегментов. Будьте готовы к тому, что по мере увеличения размера и уровня сложности системы нужно постоянно тестировать производительность, чтобы обеспечить соответствие всем соглашениям об уровне обслуживания, гарантируемым клиентам.

## Приложение. Тест производительности запросов и объединения

В этом приложении описан тест производительности, выполненный для кластера Elasticsearch. Тесты выполнены с помощью средства JMeter на отдельных виртуальных машинах. Подробные сведения о конфигурации тестовой среды описаны в документе How-To: Create a Performance Testing Environment for Elasticsearch (Практическое руководство. Создание среды тестирования производительности для Elasticsearch). Чтобы провести тест, можно создать план тестирования JMeter вручную, следуя указаниям в этом приложении, или использовать автоматизированные скрипты тестов, которые доступны отдельно. Дополнительные сведения см. в документе How-To: Run the Automated Elasticsearch Query Tests (Практическое руководство. Выполнение автоматизированных тестов запроса Elasticsearch).

Ниже приведен набор запросов, выполненных в рамках рабочей нагрузки запросов данных наряду с крупномасштабной передачей документов (данные загружены с помощью теста JUnit по методу для тестов приема данных, описанному в статье [Maximizing Data Ingestion Performance with Elasticsearch on Azure](https://github.com/mspnp/azure-guidance/blob/master/Elasticsearch-Data-Ingestion-Performance.md) (Максимальное увеличение производительности приема данных с помощью Elasticsearch в Azure)). Цель этой рабочей нагрузки — смоделировать рабочую среду, где постоянно добавляются новые данные и выполняется поиск. При этом запросы настроены для получения только недавних данных из документов, добавленных за последние 15 минут.

Каждый документ сохранен в одном индексе с именем *idx* типа *doc*. Следующий запрос HTTP можно использовать для создания индекса. Во многих тестах значения параметров *number\_of\_replicas* и *number\_of\_shards* отличались от представленных ниже. Кроме того, для тестов, в которых использовались fielddata, а не значения doc values, для каждого свойства был указан атрибут *"doc\_values": false*.

> **Важно!** Каждый раз перед выполнением теста индекс удалялся и создавался заново.

``` http
PUT /idx
{  
    "settings" : {
        "number_of_replicas": 1,
        "refresh_interval": "30s",
        "number_of_shards": "5",
        "index.translog.durability": "async"    
    },
    "doc": {
        "mappings": {
            "event": {
                "_all": {
                    "enabled": false
                },
                "_timestamp": {
                    "enabled": true,
                    "store": true,
                    "format": "date_time"
                },
                "properties": {
                    "Organization": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "CustomField1": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "CustomField2": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "CustomField3": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "CustomField4": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "CustomField5": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "DateTimeReceivedUtc": {
                        "type": "date",
                        "format": "dateOptionalTime"
                    },
                    "Host": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "HttpMethod": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "HttpReferrer": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "HttpRequest": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "HttpUserAgent": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "HttpVersion": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "OrganizationName": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceIp": {
                        "type": "ip"
                    },
                    "SourceIpAreaCode": {
                        "type": "long"
                    },
                    "SourceIpAsnNr": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceIpBase10": {
                        "type": "long"
                    },
                    "SourceIpCity": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceIpCountryCode": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceIpLatitude": {
                        "type": "double"
                    },
                    "SourceIpLongitude": {
                        "type": "double"
                    },
                    "SourceIpMetroCode": {
                        "type": "long"
                    },
                    "SourceIpPostalCode": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceIpRegion": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourceLatLong": {
                        "type": "geo_point",
                        "doc_values": true,
                        "lat_lon": true,
                        "geohash": true
                    },
                    "SourcePort": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "SourcedFrom": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "TargetIp": {
                        "type": "ip"
                    },
                    "TargetPort": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "Rating": {
                        "type": "string",
                        "index": "not_analyzed"
                    },
                    "UseHumanReadableDateTimes": {
                        "type": "boolean"
                    }
                }
            }
        }
    }
}
```

Ниже указаны запросы, выполненные в ходе тестирования.
* Сколько документов с каждым значением поля Rating введены за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "bool": {
        "must": [
          {
            "range": {
              "DateTimeReceivedUtc": {
                "gte": "now-15m",
                "lte": "now"
              }
            }
          }
        ],
        "must_not": [],
        "should": []
      }
    },
    "from": 0,
    "size": 0,
    "aggs": {
      "2": {
        "terms": {
          "field": "Rating",
          "size": 5,
          "order": {
            "_count": "desc"
          }
        }
      }
    }
  }
  ```

* Сколько документов добавлены в течение каждого 5-минутного интервала за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "bool": {
        "must": [
          {
            "range": {
              "DateTimeReceivedUtc": {
                "gte": "now-15m",
                "lte": "now"
              }
            }
          }
        ],
        "must_not": [],
        "should": []
      }
    },
    "from": 0,
    "size": 0,
    "sort": [],
    "aggs": {
      "2": {
        "date_histogram": {
          "field": "DateTimeReceivedUtc",
          "interval": "5m",
          "time_zone": "America/Los_Angeles",
          "min_doc_count": 1,
          "extended_bounds": {
            "min": "now-15m",
            "max": "now"
          }
        }
      }
    }
  }
  ```

* Сколько документов с каждым значением поля Rating добавлены для каждой страны за последние 15 минут?

  ```HTTP
  GET /idx/doc/_search
  {
    "query": {
      "filtered": {
        "query": {
          "query_string": {
            "query": "*",
            "analyze_wildcard": true
          }
        },
        "filter": {
          "bool": {
            "must": [
              {
                "query": {
                  "query_string": {
                    "query": "*",
                    "analyze_wildcard": true
                  }
                }
              },
              {
                "range": {
                  "DateTimeReceivedUtc": {
                    "gte": "now-15m",
                    "lte": "now"
                  }
                }
              }
            ],
            "must_not": []
          }
        }
      }
    },
    "size": 0,
    "aggs": {
      "2": {
        "terms": {
          "field": "Rating",
          "size": 5,
          "order": {
            "_count": "desc"
          }
        },
        "aggs": {
          "3": {
            "terms": {
              "field": "SourceIpCountryCode",
              "size": 15,
              "order": {
                "_count": "desc"
              }
            }
          }
        }
      }
    }
  }
  ```

* Какие 15 организаций наиболее часто встречаются в документах, добавленных за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "filtered": {
        "query": {
          "query_string": {
            "query": "*",
            "analyze_wildcard": true
          }
        },
        "filter": {
          "bool": {
            "must": [
              {
                "query": {
                  "query_string": {
                    "query": "*",
                    "analyze_wildcard": true
                  }
                }
              },
              {
                "range": {
                  "DateTimeReceivedUtc": {
                    "gte": "now-15m",
                    "lte": "now"
                  }
                }
              }
            ],
            "must_not": []
          }
        }
      }
    },
    "size": 0,
    "aggs": {
      "2": {
        "terms": {
          "field": "Organization",
          "size": 15,
          "order": {
            "_count": "desc"
          }
        }
      }
    }
  }
  ```

* Сколько разных организаций встречаются в документах, добавленных за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "filtered": {
        "query": {
          "query_string": {
            "query": "*",
            "analyze_wildcard": true
          }
        },
        "filter": {
          "bool": {
            "must": [
              {
                "query": {
                  "query_string": {
                    "query": "*",
                    "analyze_wildcard": true
                  }
                }
              },
              {
                "range": {
                  "DateTimeReceivedUtc": {
                    "gte": "now-15m",
                    "lte": "now"
                  }
                }
              }
            ],
            "must_not": []
          }
        }
      }
    },
    "size": 0,
    "aggs": {
      "2": {
        "cardinality": {
          "field": "Organization"
        }
      }
    }
  }
  ```

* Сколько документов добавлены за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "filtered": {
        "query": {
          "query_string": {
            "query": "*",
            "analyze_wildcard": true
          }
        },
        "filter": {
          "bool": {
            "must": [
              {
                "query": {
                  "query_string": {
                    "analyze_wildcard": true,
                    "query": "*"
                  }
                }
              },
              {
                "range": {
                  "DateTimeReceivedUtc": {
                    "gte": "now-15m",
                    "lte": "now"
                  }
                }
              }
            ],
            "must_not": []
          }
        }
      }
    },
    "size": 0,
    "aggs": {}
  }
  ```

* Сколько разных значений SourceIp встречаются в документах, добавленных за последние 15 минут?

  ```http
  GET /idx/doc/_search
  {
    "query": {
      "filtered": {
        "query": {
          "query_string": {
            "query": "*",
            "analyze_wildcard": true
          }
        },
        "filter": {
          "bool": {
            "must": [
              {
                "query": {
                  "query_string": {
                    "query": "*",
                    "analyze_wildcard": true
                  }
                }
              },
              {
                "range": {
                  "DateTimeReceivedUtc": {
                    "gte": "now-15m",
                    "lte": "now"
                  }
                }
              }
            ],
            "must_not": []
          }
        }
      }
    },
    "size": 0,
    "aggs": {
      "2": {
        "cardinality": {
          "field": "SourceIp"
        }
      }
    }
  }
  ```

<!---HONumber=AcomDC_0302_2016-->