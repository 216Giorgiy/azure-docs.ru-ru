<properties
   pageTitle="Создание и развертывание дискретизатора JUnit для JMeter для тестирования производительности Elasticsearch | Microsoft Azure"
   description="Руководство по использованию дискретизатора JUnit для создания и отправки данных в кластер Elasticsearch."
   services=""
   documentationCenter="na"
   authors="mabsimms"
   manager="marksou"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/05/2016"
   ms.author="mabsimms"/>
   
# Создание и развертывание дискретизатора JUnit для JMeter для тестирования производительности Elasticsearch

Этот материал входит в [цикл статей, посвященных вопросам Elasticsearch](guidance-elasticsearch-introduction.md).

В этом документе описывается, как создать и использовать дискретизатор JUnit для создания и отправки данных в кластер Elasticsearch в рамках плана тестирования JMeter. Это исключительно гибкий подход к нагрузочному тестированию, позволяющий создавать большие объемы тестовых данных без использования внешних файлов.

> [AZURE.NOTE] С помощью этого подхода разработаны нагрузочные тесты, используемые для оценки производительности приема данных, описанной в документе "Максимальное увеличение производительности приема данных с помощью Elasticsearch в Azure". В этом документе представлены сведения о коде JUnit.

Для тестирования производительности приема данных код JUnit разрабатывался в Eclipse (Mars), а зависимости определялись в Maven. Ниже описан пошаговый процесс установки Eclipse, настройки Maven, создания теста JUnit и его развертывания как дискретизатора запросов JUnit в тесте JMeter.

> [AZURE.NOTE] Подробные сведения о структуре и конфигурации тестовой среды см. в инструкциях по созданию среды тестирования производительности для Elasticsearch.

## Установка необходимых компонентов

На компьютер разработки нужно установить [среду выполнения Java (JRE)](http://www.java.com/en/download/ie_manual.jsp). Вам потребуется установить также [интегрированную среду разработки Eclipse для разработчиков Java](https://www.eclipse.org/downloads/index.php?show_instructions=TRUE).

> [AZURE.NOTE] Если в качестве среды разработки используется основная виртуальная машина JMeter, описанная в разделе о [настройке среды для тестирования производительности](#overview), скачайте установщик Eclipse для 32-разрядной версии Windows.

## Создание проекта JUnit для нагрузочного тестирования Elasticsearch

1.  Запустите интегрированную среду разработки Eclipse, если она еще не запущена, и закройте страницу *приветствия*.

2.  В меню *File* (Файл) выберите команду *New* (Создать), а затем — пункт *Java Project* (Проект Java).

![](./media/guidance-elasticsearch-jmeter-deploy7.png)

3.  В окне *New Java Project* (Создание проекта Java) введите имя проекта, щелкните *Use default JRE* (Использовать среду JRE по умолчанию) и нажмите кнопку *Finish* (Готово).

![](./media/guidance-elasticsearch-jmeter-deploy8.png)

4.  В окне *Package Explorer* (Обозреватель пакетов) разверните узел с именем проекта. Убедитесь, что он содержит папку с именем *src* и ссылку на указанную среду JRE.

![](./media/guidance-elasticsearch-jmeter-deploy9.png)

5.  Щелкните правой кнопкой мыши папку *src*, щелкните *New* (Создать) и выберите пункт *JUnit Test Case* (Тестовый случай JUnit).

![](./media/guidance-elasticsearch-jmeter-deploy10.png)

6.  В окне *New JUnit Test Case* (Создание тестового случая JUnit) установите переключатель *New Junit 4 test* (Создать тест Junit 4), введите имя пакета (оно может совпадать с именем проекта, но должно начинаться со строчной буквы) и имя тестового класса, а затем выберите параметры создания заглушек метода, необходимых для теста. Оставьте поле *Class under test* (Тестируемый класс) пустым и нажмите кнопку *Finish* (Готово).

![](./media/guidance-elasticsearch-jmeter-deploy11.png)

7.  Если откроется диалоговое окно *New JUnit Test Case* (Создание тестового случая JUnit), добавьте библиотеку JUnit 4 в путь сборки и нажмите кнопку *OK*.

![](./media/guidance-elasticsearch-jmeter-deploy12.png)

8.  В окне редактора Java должен появиться "скелет" программы для теста JUnit.

![](./media/guidance-elasticsearch-jmeter-deploy13.png)

9.  В окне *Package Explorer* (Обозреватель пакетов) щелкните правой кнопкой мыши узел проекта, выберите пункт *Configure* (Настройка), а затем — *Convert to Maven Project* (Преобразовать в проект Maven).

> [AZURE.NOTE] Maven упрощает управление внешними зависимостями, с которыми связан проект (например, клиентские библиотеки Java для Elasticsearch).

![](./media/guidance-elasticsearch-jmeter-deploy14.png)

10.  В диалоговом окне *Create new POM* (Создание POM) в раскрывающемся списке *Packaging* (Упаковка) выберите пункт *jar* и нажмите кнопку *Finish* (Готово).

![](./media/guidance-elasticsearch-jmeter-deploy15.png)

11.  В нижней области редактора POM может появиться предупреждение *Build path specifies execution environment J2SE-1.5. There are no JREs installed in the workspace that are strictly compatible with this environment* (В пути сборки указана среда выполнения J2SE-1.5. В рабочей области не установлены среды JRE, которые полностью совместимы с этой средой). Появление такого сообщения зависит от версии Java, установленной на компьютере разработки. Если ваша версия Java выше 1.5, можно игнорировать это предупреждение.

![](./media/guidance-elasticsearch-jmeter-deploy16.png)

12.  В редакторе POM разверните окно *Properties* (Свойства) и нажмите кнопку *Create* (Создать).

![](./media/guidance-elasticsearch-jmeter-deploy17.png)

13.  В диалоговом окне *Add Property* (Добавление свойства) в поле *Name* (Имя) введите *es.version*, в поле *Value* (Значение) введите *1.7.2* и нажмите кнопку *OK*. Это версия клиентской библиотеки Java для Elasticsearch, которая будет использоваться. Эта версия может быть впоследствии изменена. Определив ее как свойство POM и добавив ссылку на это свойство в других расположениях проекта, вы сможете быстро изменить версию.

![](./media/guidance-elasticsearch-jmeter-deploy18.png)

14.  В нижней части редактора POM щелкните вкладку *Dependencies* (Зависимости) и рядом со списком *Dependencies* (Зависимости) нажмите кнопку *Add* (Добавить).

![](./media/guidance-elasticsearch-jmeter-deploy19.png)

15.  В диалоговом окне *Select Dependency* (Выбор зависимости) в поле *Group Id* (Идентификатор группы) введите *org.elasticsearch*, в поле *Artifact Id* (Идентификатор артефакта) введите *elasticsearch*, в поле *Version* (Версия) введите *\\${es.version}* и нажмите кнопку *OK*. Сведения о клиентской библиотеке Java для Elasticsearch хранятся в центральном интернет-репозитории Maven. При создании проекта эта конфигурация будет автоматически скачивать библиотеку и ее зависимости.

![](./media/guidance-elasticsearch-jmeter-deploy20.png)

16.  В меню *File* (Файл) выберите команду *Save All* (Сохранить все). Проект будет сохранен и скомпилирован, а все указанные в Maven зависимости — скачаны. Убедитесь, что в обозревателе пакетов появилась папка *Maven Dependencies* (Зависимости Maven). Если развернуть эту папку, вы увидите jar-файлы, скачанные для клиентской библиотеки Java для Elasticsearch.

![](./media/guidance-elasticsearch-jmeter-deploy21.png)


## Импорт существующего тестового проекта JUnit в Eclipse

> [AZURE.NOTE] Эта процедура предполагает, что вы уже скачали проект Maven, который был создан с помощью Eclipse.

1.  Запустите интегрированную среду разработки Eclipse.

2.  В меню *File* (Файл) щелкните команду *Import* (Импорт).

![](./media/guidance-elasticsearch-jmeter-deploy22.png)

3.  В диалоговом окне *Select* (Выбор) разверните папку *Maven*, щелкните пункт *Existing Maven Projects* (Существующие проекты Maven) и нажмите кнопку *Далее*.

![](./media/guidance-elasticsearch-jmeter-deploy23.png)

4.  В окне *Maven Projects* (Проекты Maven) укажите папку с проектом (папка с файлом pom.xml), выберите команду *Select All* (Выделить все) и нажмите кнопку *Finish* (Готово).

![](./media/guidance-elasticsearch-jmeter-deploy24.png)

5.  В обозревателе пакетов разверните узел, соответствующий проекту. Убедитесь, что проект содержит папку с именем *src*. В этой папке хранится исходный код для теста JUnit. Проект можно скомпилировать и развернуть, следуя инструкциям из раздела [Развертывание теста JUnit в JMeter](#deploying-a-junit-test-to-jmeter).

![](./media/guidance-elasticsearch-jmeter-deploy25.png)

## Развертывание теста JUnit в JMeter

> [AZURE.NOTE] В этом проекте предполагается, что вы уже создали проект с именем LoadTest, который содержит класс теста JUnit с именем BulkLoadTest.java и принимает параметры конфигурации, передаваемые в конструктор в виде одной строки (именно этот механизм поддерживается средством JMeter).

1.  В интегрированной среде разработки Eclipse в обозревателе пакетов щелкните правой кнопкой мыши узел проекта и выберите пункт *Export* (Экспорт).

![](./media/guidance-elasticsearch-jmeter-deploy26.png)

2.  В мастере экспорта на странице *Select* (Выбор) разверните узел *Java*, выберите пункт *JAR file* (JAR-файл) и нажмите кнопку *Next* (Далее).

![](./media/guidance-elasticsearch-jmeter-deploy27.png)

3.  На странице *JAR File Specification* (Спецификация JAR-файла) в области *Select the resources to export* (Выберите ресурсы для экспорта) откройте экспортируемый проект и снимите все флажки, кроме установленного для папки *src*. Также снимите флажки *.classpath*, *.project* и *pom.xml*. В поле *JAR file* (JAR-файл) укажите имя и расположение JAR-файла (у него должно быть расширение .jar), нажмите кнопку *Finish* (Готово).

![](./media/guidance-elasticsearch-jmeter-deploy28.png)

4.  В проводнике Windows скопируйте созданный JAR-файл на основную виртуальную машину Java JMeter и сохраните его в папку *apache-jmeter-2.13\\lib\\junit*, которая, в свою очередь, расположена в папке установки JMeter. Дополнительные сведения см. в разделе об [установке и настройке JMeter на основной виртуальной машине](#_Installing_and_Configuring).

5.  Вернитесь в Eclipse, разверните окно обозревателя пакетов и запишите все JAR-файлы и их расположения, перечисленные в папке *Maven Dependencies* (Зависимости Maven) проекта. Обратите внимание, что список файлов, показанных на рисунке ниже, может изменяться в зависимости от используемой версии Elasticsearch.

![](./media/guidance-elasticsearch-jmeter-deploy29.png)

6.  В проводнике Windows скопируйте каждый JAR-файл, указанный в папке зависимостей Maven, в папку *apache-jmeter-2.13\\lib\\junit* на основной виртуальной машине JMeter.

> [AZURE.NOTE] Если папка l*ib\\junit* уже содержит старые версии этих файлов, удалите их. Иначе ссылки могут указывать на неправильные JAR-файлы и тест JUnit выполнить не удастся.

7.  Если сейчас на основной виртуальной машине запущено средство JMeter, закройте его.

8.  Повторно откройте JMeter.

9.  В окне JMeter щелкните правой кнопкой мыши *Test Plan* (План тестирования), последовательно выберите *Add* (Добавить) и *Threads (Users)* (Потоки (пользователи)), а затем щелкните *Thread Group* (Группа потоков).

![](./media/guidance-elasticsearch-jmeter-deploy30.png)

10.  В узле *Test Plan* (План тестирования) щелкните правой кнопкой мыши пункт *Thread-Group* (Группа потоков) и последовательно выберите *Add* (Добавить), *Sampler* (Дискретизатор) и *JUnit Request* (Запрос JUnit).

![](./media/guidance-elasticsearch-jmeter-deploy31.png)

11.  На странице *JUnit Request* (Запрос JUnit) установите флажок *Search for JUnit4 annotations (instead of JUnit 3)* (Поиск заметок JUnit 4 (вместо JUnit 3)). В раскрывающемся списке *Classname* (Имя класса) выберите класс нагрузочного теста JUnit (указан в виде *&lt;пакет&gt;.&lt;класс&gt;*). В раскрывающемся списке *Test Method* (Метод тестирования) выберите метод тестирования JUnit (метод, который фактически выполняет действия, связанные с тестом, и отмечен в проекте Eclipse заметкой *@test*). В поле *Constructor String Label* (Метка строки конструктора) введите значения, которые будут передаваться в конструктор. Сведения на рисунке ниже приведены исключительно для справки. Указанные пользователем значения *имени класса*, *метода тестирования* и *метки строки конструктора*, вероятно, будут отличаться от представленных на рисунке.

![](./media/guidance-elasticsearch-jmeter-deploy32.png)

> [AZURE.NOTE]  Если необходимый класс отсутствует в раскрывающемся списке *Classname* (Имя класса), это может означать, что JAR-файл не экспортирован надлежащим образом, не помещен в папку *lib\\junit* или в этой папке отсутствуют некоторые из зависимых JAR-файлов. В таком случае повторно экспортируйте проект из Eclipse и убедитесь, что выбран ресурс *src*. Скопируйте JAR-файл в папку *lib\\junit* и убедитесь, что все зависимые JAR-файлы, перечисленные в Maven, скопированы в папку *lib*.

12.  Закройте JMeter. Сохранять план тестирования не нужно.

13.  Скопируйте JAR-файл с тестовым классом JUnit в папку */home/&lt;имя\_пользователя&gt;/apache-jmeter-2.13/lib/junit* на каждой виртуальной машине, подчиненной JMeter. *&lt;Имя\_пользователя&gt;* — это имя пользователя с правами администратора, указанное при создании виртуальной машины. Дополнительные сведения см. в разделе о [создании виртуальных машин, подчиненных JMeter](#_Creating_the_JMeter_2).

14.  Скопируйте зависимые JAR-файлы для тестового класса JUnit в папку */home/&lt;имя\_пользователя&gt;/apache-jmeter-2.13/lib/junit* на каждой виртуальной машине, подчиненной JMeter. Не забудьте предварительно удалить из этой папки все более ранние версии JAR-файлов.

> [AZURE.NOTE] Для копирования файлов с компьютера Windows на компьютер Ubuntu можно использовать служебную программу pscp.

<!---HONumber=AcomDC_0211_2016-->