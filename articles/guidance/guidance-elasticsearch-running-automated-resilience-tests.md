<properties
   pageTitle="Выполнение автоматических тестов устойчивости Elasticsearch | Microsoft Azure"
   description="Описание выполнения тестов устойчивости в существующей среде."
   services=""
   documentationCenter="na"
   authors="mabsimms"
   manager="marksou"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/18/2016"
   ms.author="masimms"/>

# Выполнение автоматических тестов устойчивости Elasticsearch

Этот материал входит в [цикл статей, посвященных вопросам Elasticsearch](guidance-elasticsearch.md).

В рамках [тестирования устойчивости и восстановления] выполнено несколько тестов в примере кластера Elasticsearch, чтобы определить, насколько хорошо система справляется с некоторыми простыми формами сбоя и насколько хорошо она восстанавливается. Проведены тесты для четырех разных сценариев.

- **Сбой и перезапуск узла без потери данных**. Работа узла данных останавливается, и в течение 5 минут он перезапускается. Elasticsearch настроен таким образом, чтобы в течение этого периода не выполнялось повторное выделение отсутствующих сегментов. Поэтому при перемещении сегментов не выполняются дополнительные операции ввода-вывода. При перезапуске узла в ходе восстановления его сегменты обновляются.

- **Сбой узла с катастрофической потерей данных**. Работа узла данных останавливается, а его данные удаляются для моделирования масштабного сбоя диска. Затем узел перезапускается (через 5 минут) и заменяет исходный узел. В этом случае требуется восстановить отсутствующие данные для этого узла, а также может потребоваться переместить сегменты на других узлах.

- **Сбой и перезапуск узла без потери данных с повторным выделением сегментов**. Работа узла данных останавливается, а его сегменты выделяются другим узлам. Затем узел перезапускается и выполняется повторное выделение для перераспределения ресурсов кластера.

- **Последовательное обновление**. Работа каждого узла в кластере останавливается, и через короткий промежуток времени он перезапускается. Это позволяет смоделировать перезагрузку компьютеров после обновления программного обеспечения. В любой момент времени останавливается работа только одного узла. Повторное выделение сегментов не выполняется, пока узел не работает.

Для этих тестов написан сценарий, позволяющий запускать их в автоматическом режиме. Здесь содержатся сведения о том, как можно повторить тесты в собственной среде.

## Предварительные требования

Для выполнения автоматических тестов требуются перечисленные ниже элементы.

- Кластер Elasticsearch.

- Настройка среды JMeter в соответствии с руководством [Performance testing guidance] (Руководство по тестированию производительности).

- Следующие компоненты должны быть установлены на главной виртуальной машине JMeter:

    - среда выполнения Java 7;

    - Nodejs 4.x.x или более поздней версии;

    - программы командной строки Git.

## Принцип работы сценариев

Сценарии тестирования выполняются на главной виртуальной машине JMeter. При выборе теста для выполнения сценарий выполняет следующую последовательность операций.

1.  Запускает план тестирования JMeter и передает заданные параметры.

2.  Копирует сценарий, который выполняет операции, необходимые для тестирования, в указанную виртуальную машину в кластере. Это может быть любая виртуальная машина с общедоступным IP-адресом или виртуальная машина *Jumpbox*, если кластер создан с помощью [шаблона быстрого запуска Elasticsearch в Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch).

3.  Запускает сценарий на виртуальной машине (или Jumpbox).

На схеме ниже показана структура тестовой среды и кластера Elasticsearch. Обратите внимание, что сценарии тестирования подключаются к каждому узлу кластера по протоколу SSH для выполнения различных операций Elasticsearch, таких как остановка работы узла и его перезапуск.

![](./media/guidance-elasticsearch/resilience-testing1.png)

## Настройка тестов JMeter

Перед выполнением тестов устойчивости следует скомпилировать и развернуть тесты JUnit, расположенные в папке *resiliency/jmeter/tests*. На эти тесты ссылается план тестирования JMeter. Дополнительные сведения см. в разделе об импорте существующего тестового проекта JUnit в Eclipse в статье [Deploying a JMeter JUnit Sampler for Testing Elasticsearch Performance][] (Развертывание дискретизатора JUnit JMeter для тестирования производительности Elasticsearch).

Существует две версии тестов JUnit, которые содержатся в следующих папках:

- **Elasticsearch17**. При выполнении проекта в этой папке создается файл Elasticsearch17.jar. Используйте этот JAR-файл для тестирования Elasticsearch, начиная с версии 1.7.

- **Elasticsearch20**. При выполнении проекта в этой папке создается файл Elasticsearch20.jar. Используйте этот JAR-файл для тестирования Elasticsearch версии 2.0.0 и более поздних версий.

Скопируйте соответствующий JAR-файл вместе с остальными зависимостями на компьютеры JMeter. Этот процесс описан в разделе о развертывании теста JUnit в JMeter в статье [Considerations for JMeter] (Рекомендации для JMeter).

## Настройка безопасности виртуальной машины для каждого узла

Для сценариев тестирования требуется, чтобы сертификат проверки подлинности был установлен на каждом узле Elasticsearch в кластере. Таким образом сценарии смогут запускаться автоматически без запроса имени пользователя или пароля при подключении к различным виртуальным машинам.

Войдите на один из узлов кластера Elasticsearch (или виртуальную машину Jumpbox) и выполните следующую команду, чтобы создать ключ проверки подлинности:

```Shell
ssh-keygen -t rsa
```

После подключения к узлу Elasticsearch (или Jumpbox) выполните следующие команды для каждого узла в кластере Elasticsearch. Замените `<username>` на имя допустимого пользователя на каждой виртуальной машине, а `<nodename>` — на DNS-имя IP-адреса виртуальной машины, на которой размещен узел Elasticsearch. Обратите внимание, что при выполнении этих команд вам будет предложено ввести пароль пользователя. Дополнительные сведения см. в статье [SSH login without password](http://www.linuxproblem.org/art_9.html) (Вход через SSH без пароля).

```Shell
ssh <username>@<nodename> mkdir -p .ssh (
cat .ssh/id\_rsa.pub | ssh <username>*@<nodename> 'cat &gt;&gt; .ssh/authorized\_keys'
```

## Скачивание и настройка сценариев тестирования

Сценарии тестирования доступны в репозитории Git. Выполните указанные ниже действия, чтобы скачать и настроить сценарии.

На главной виртуальной машине JMeter, где будут выполняться тесты, откройте окно рабочего стола Git (Git BASH) и клонируйте репозиторий, который содержит сценарии, следующим образом:

```Shell
git clone https://github.com/mspnp/azure-guidance.git
```

Перейдите в папку *resiliency-tests* и выполните следующую команду, чтобы установить зависимости, необходимые для выполнения тестов:

```Shell
npm install
```

Если главная виртуальная машина JMeter работает под управлением Windows, [скачайте инструмент PLINK](http://the.earth.li/~sgtatham/putty/latest/x86/plink.exe) и скопируйте его в папку *resiliency-tests/lib*.

Если главная виртуальная машина JMeter работает под управлением Linux, не нужно скачивать PLINK, но вам потребуется настроить вход через SSH без пароля между главной виртуальной машиной JMeter и узлом Elasticsearch или использованной виртуальной машиной Jumpbox. Для этого необходимо выполнить указания в разделе [Настройка безопасности виртуальной машины для каждого узла](#configuring-vm-security-for-each-node).

Измените файл `config.js` и следующие параметры конфигурации с учетом своей тестовой среды и кластера Elasticsearch. Это общие параметры для всех тестов.

| Имя | Описание | Значение по умолчанию |
| ---- | ----------- | ------------- |
| `jmeterPath` | Локальный путь к месту установки JMeter | `C:/apache-jmeter-2.13` |
| `resultsPath` | Относительный каталог, куда сценарий записывает результат | `results` |
| `verbose` | Указывает, используется ли для выходных данных сценария режим подробного протоколирования | `true` |
| `remote` | Указывает, как выполняются тесты JMeter: локально или на удаленных серверах | `true` |
| `cluster.clusterName` | Имя кластера ElasticSearch. | `elasticsearch` |
| `cluster.jumpboxIp` | IP-адрес виртуальной машины Jumpbox |-| | `cluster.username` | Пользователь-администратор, созданный при развертывании кластера |-| | `cluster.password` | Пароль пользователя-администратора |-| | `cluster.loadBalancer.ip` | IP-адрес балансировщика нагрузки Elasticsearch |-| | `cluster.loadBalancer.url` | Базовый URL-адрес балансировщика нагрузки |-|

## Выполнение тестов

Перейдите в папку *resiliency-tests* и выполните следующую команду:

```Shell
node app.js
```

Откроется меню, аналогичное следующему:

![](./media/guidance-elasticsearch/resilience-testing2.png)

Введите количество сценариев для выполнения: `11`, `12`, `13` или `21`.

После выбора сценария тест будет запускаться автоматически. Результат сохраняется в виде набора CSV-файлов в папке, созданной в каталоге *results*. Для каждого выполнения создается отдельная папка результатов. Для анализа и графического представления этих данных можно использовать Excel.

[Running Elasticsearch on Azure]: guidance-elasticsearch-running-on-azure.md
[Tuning Data Ingestion Performance for Elasticsearch on Azure]: guidance-elasticsearch-tuning-data-ingestion-performance.md
[Performance testing guidance]: guidance-elasticsearch-performance-testing-environment.md
[JMeter guidance]: guidance-elasticsearch-implementing-jmeter.md
[Considerations for JMeter]: guidance-elasticsearch-deploy-jmeter-junit-sampler.md
[Query aggregation and performance]: guidance-elasticsearch-query-aggregation-performance.md
[Resilience and Recovery]: guidance-elasticsearch-resilience-recovery.md
[тестирования устойчивости и восстановления]: guidance-elasticsearch-resilience-testing.md
[Deploying a JMeter JUnit Sampler for Testing Elasticsearch Performance]: guidance-elasticsearch-deploying-jmeter-junit-sampler.md

<!---HONumber=AcomDC_0224_2016-->