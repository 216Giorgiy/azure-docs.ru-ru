<properties
   pageTitle="Работа с удостоверениями на основе утверждений в мультитенантных приложениях | Microsoft Azure"
   description="Использование утверждений для проверки издателя и авторизации"
   services=""
   documentationCenter="na"
   authors="MikeWasson"
   manager="roshar"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="mwasson"/>

# Работа с удостоверениями на основе утверждений в мультитенантных приложениях

Этот материал входит в [цикл статей]. К статьям прилагается полный [пример приложения].

## Утверждения в Azure AD

Когда пользователь выполняет вход, Azure AD отправляет маркер идентификатора, содержащий набор утверждений о пользователе. Утверждение представляет собой фрагмент данных, выраженный в виде пары "ключ-значение". Например: `email`=`bob@contoso.com`. У утверждений есть издатель (в этом случае — Azure AD), который является сущностью, проверяющей подлинность пользователя и создающей утверждения. Доверие к утверждениям основано на доверии к издателю. (И наоборот, если вы не доверяете издателю, вы не доверяете утверждениям!)

На высоком уровне:

1.	Пользователь проходит проверку подлинности.
2.	Поставщик удостоверений отправляет набор утверждений.
3.	Приложение нормализует или расширяет утверждения (необязательно).
4.	Приложение использует утверждения для принятия решений об авторизации.

В OpenID Connect управление набором утверждений, который вы получаете, осуществляется с помощью [параметра области] запроса на проверку подлинности. Однако Azure AD выдает через OpenID Connect лишь ограниченный набор утверждений. См. статью [Поддерживаемые маркеры и типы утверждений]. Чтобы получить дополнительные сведения о пользователе, необходимо использовать API Graph Azure AD.

Ниже приведены некоторые утверждения из AAD, которые могут иметь особое значение для приложения.

Тип утверждения в маркере идентификатора |	Описание
-----------------------|--------------
aud | Для кого выдан маркер. Это будет идентификатор клиента приложения. Как правило, на это утверждение не следует обращать внимание, так как его автоматически проверяет ПО промежуточного слоя. Пример: `"91464657-d17a-4327-91f3-2ed99386406f"`
groups | Список групп AAD, членом которых является пользователь. Пример: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`
iss | [Издатель] маркера OIDC. Пример: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`
name | Отображаемое имя пользователя. Пример: `"Alice A."`
oid | Идентификатор объекта для пользователя в AAD. Это значение является неизменяемым идентификатором пользователя без возможности повторного использования. Используйте это значение, а не адрес электронной почты, так как адрес может измениться. Если в приложении используется API Graph Azure AD, идентификатор объекта является значением, применяемым для запроса сведений о профиле. Пример: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`
roles | Список ролей приложения для пользователя. Пример: `["SurveyCreator"]`
tid | Идентификатор клиента. Это значение является уникальным идентификатором для клиента в Azure AD. Пример: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`
unique\_name | Читаемое отображаемое имя пользователя. Пример: `"alice@contoso.com"`
upn | Имя участника-пользователя. Пример: `"alice@contoso.com"`

В этой таблице типы утверждений указаны в том виде, в каком они отображаются в маркере идентификатора. В ASP.NET Core 1.0 ПО промежуточного слоя OpenID Connect преобразует некоторые типы утверждений при заполнении коллекции утверждений для участника-пользователя:

-	oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`
-	tid > `http://schemas.microsoft.com/identity/claims/tenantid`
-	unique\_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`
-	upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`

## Преобразования утверждений

Во время потока проверки подлинности может потребоваться изменить утверждения, получаемые от поставщика удостоверений. В ASP.NET Core 1.0 можно выполнить преобразование утверждений в событии **AuthenticationValidated** из ПО промежуточного слоя OpenID Connect. (См. статью [События проверки подлинности].)

Все утверждения, добавленные во время **AuthenticationValidated**, хранятся в файле cookie сеанса проверки подлинности. Они не возвращаются обратно в Azure AD.

Ниже приведено несколько примеров преобразования утверждений.

-	**Нормализация утверждений** или обеспечение согласованности утверждений среди пользователей. Это особенно важно при получении утверждений от нескольких поставщиков удостоверений, которые могут использовать разные типы утверждений для схожих сведений. Например, Azure AD отправляет утверждение "upn", содержащее адрес электронной почты пользователя. Другие поставщики удостоверений могут отправлять утверждение "email". Следующий код преобразует утверждение "upn" в утверждение "email":

    ```csharp
    var email = principal.FindFirst(ClaimTypes.Upn)?.Value;
    if (!string.IsNullOrWhiteSpace(email))
    {
      identity.AddClaim(new Claim(ClaimTypes.Email, email));
    }
    ```

- Добавление **значений утверждений по умолчанию** для утверждений, которые отсутствуют. Например, назначение пользователю роли по умолчанию. В некоторых случаях это может упростить логику авторизации.
- Добавление **настраиваемых типов утверждений** со сведениями о пользователе, относящимися к конкретному приложению. Например, можно сохранить некоторые сведения о пользователе в базе данных. Настраиваемое утверждение с этой информацией можно добавить в билет проверки подлинности. Утверждение хранится в файле cookie, поэтому его необходимо получать из базы данных один раз в каждом сеансе входа. С другой стороны, также необходимо избежать создания чрезмерно больших файлов cookie, поэтому следует добиваться компромисса между размером файла cookie и поисками в базе данных.   

После завершения процесса проверки подлинности утверждения будут доступны в `HttpContext.User`. На этом этапе их следует рассматривать как доступную только для чтения коллекцию. Например, использовать их для принятия решений об авторизации.

## Проверка издателя
В OpenID Connect утверждение издателя ("iss") определяет поставщика удостоверений, выдавшего маркер идентификатора. В рамках проверки подлинности OIDC осуществляется проверка соответствия утверждения издателя фактическому издателю. Эту задачу выполняет ПО промежуточного слоя OIDC.

В Azure AD значение издателя является уникальным для каждого клиента AD (`https://sts.windows.net/<tenantID>`). Таким образом, приложение должно дополнительно проверять, представляет ли издатель клиента, который может входить в приложение.

В однотенантном приложении можно просто проверить, что издатель является вашим собственным клиентом. На самом деле ПО промежуточного слоя OIDC выполняет эту задачу автоматически, по умолчанию. В мультитенантном приложении необходимо разрешить использование нескольких издателей, соответствующих разным клиентам. Ниже приведен общий подход.

-	В параметрах ПО промежуточного слоя OIDC задайте параметру **ValidateIssuer** значение "false". Автоматическая проверка будет отключена.
-	Во время регистрации клиента сохраните клиента и поставщика в базе данных пользователя.
-	При каждом входе пользователя выполняйте поиск издателя в базе данных. Если издатель не найден, значит, клиент еще не зарегистрирован. Перенаправьте его на страницу регистрации.
-  Кроме того, определенных клиентов можно поместить в черный список. В него могут входить клиенты, которые, к примеру, не оплатили подписку.

Более подробное описание см. в статье [Регистрация и адаптация клиентов].

## Использование утверждений для авторизации

За счет утверждений удостоверение пользователя больше не является монолитной сущностью. Например, пользователь может иметь адрес электронной почты, номер телефона, день рождения, пол и т. д. Возможно, у поставщика удостоверений хранятся все эти сведения. Однако выполняя проверку подлинности пользователя, в виде утверждений вы получите, как правило, подмножество этих данных. В этой модели удостоверение пользователя представляет собой просто набор утверждений. При принятии решений об авторизации пользователя вам потребуются определенные наборы утверждений. Другими словами, вопрос "Может ли пользователь X выполнять действие Y" в конечном счете принимает вид "Есть ли у пользователя X утверждение Z".

Ниже приведено несколько основных шаблонов для проверки утверждений.

-  Проверка наличия у пользователя конкретного утверждения с конкретным значением:

    ```csharp
    if (User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
    ```
    Этот код проверяет, имеет ли пользователь утверждение Role со значением "Admin". Он правильно обрабатывает случай, когда у пользователя нет утверждения Role или есть несколько утверждений Role.

    Класс **ClaimTypes** определяет константы для часто используемых типов утверждений. Однако для типа утверждения можно использовать любое строковое значение.

-	Получение одного значения для типа утверждения, если предполагается наличие не более одного значения:
    ```csharp
     string email = User.FindFirst(ClaimTypes.Email)?.Value;
    ```
-	Получение всех значений для типа утверждения:

    ```csharp
     IEnumerable<Claim> groups = User.FindAll("groups");
    ```

Дополнительные сведения об использовании утверждений в процессе авторизации см. в статье [Авторизация].

## Дополнительные ресурсы

- [Авторизация на основе утверждений]


<!-- Links -->
[цикл статей]: guidance-multitenant-identity.md
[параметра области]: http://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[Поддерживаемые маркеры и типы утверждений]: ../active-directory/active-directory-token-and-claims.md
[Издатель]: http://openid.net/specs/openid-connect-core-1_0.html#IDToken
[События проверки подлинности]: guidance-multitenant-identity-authenticate.md#authentication-events
[Регистрация и адаптация клиентов]: guidance-multitenant-identity-signup.md
[Авторизация]: guidance-multitenant-identity-authorize.md
[Авторизация на основе утверждений]: https://docs.asp.net/en/latest/security/authorization/claims.html
[пример приложения]: https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps

<!---HONumber=AcomDC_0302_2016-->