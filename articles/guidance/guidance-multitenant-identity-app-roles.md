<properties
   pageTitle="Роли приложения | Microsoft Azure"
   description="Выполнение авторизации с помощью ролей приложения"
   services=""
   documentationCenter="na"
   authors="MikeWasson"
   manager="roshar"
   editor=""
   tags=""/>

<tags
   ms.service="guidance"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="mwasson"/>

#  Роли приложения в мультитенантных приложениях

Этот материал входит в [цикл статей]. К статьям прилагается полный [пример приложения].

Роли приложения используются для назначения разрешений пользователям. Например, приложение [Tailspin Surveys][Tailspin] определяет указанные далее роли.

- Администратор. Может выполнять все операции CRUD в любом опросе, принадлежащем этому клиенту.
- Создатель. Может создавать опросы.
- Читатель. Может читать все опросы, принадлежащие этому клиенту.

В конечном счете роли преобразуются в разрешения во время [авторизации]. Однако сначала нужно ответить на первый вопрос, касающийся назначения ролей и управления ими. Мы определили три основных варианта:

-	[роли приложения Azure AD](#roles-using-azure-ad-app-roles);
-	[группы безопасности Azure AD](#roles-using-azure-ad-security-groups);
-	[диспетчер ролей приложения](#roles-using-an-application-role-manager).

## Роли, использующие роли приложения Azure AD

Это подход, который использовался в приложении Tailspin Surveys.

Здесь поставщик SaaS определяет роли приложения, добавляя их в манифест приложения. После регистрации клиента администратор каталога AD клиента назначает роли пользователям. Когда пользователь входит в систему, назначенные роли отправляются в виде утверждений.

> [AZURE.NOTE] Если у клиента установлена служба Azure AD Premium, администратор может назначить роль группе безопасности, и участники группы будут наследовать роль приложения. Это удобный способ управления ролями, поскольку владельцу группы не нужно быть администратором AD.

Преимущества этого подхода:

-	Простая модель программирования.
-	Роли соответствуют конкретному приложению. Утверждения ролей для одного приложения не отправляются в другое приложение.
-	Если клиент удаляет приложение из своего клиента AD, роли также удаляются.
-	Приложению не требуются дополнительные разрешения Active Directory, кроме разрешения на чтение профиля пользователя.

Недостатки:

- Клиенты, не имеющие Azure AD Premium, не могут назначать роли группам безопасности. Для этих клиентов все назначения пользователей должен выполнять администратор AD.
- При наличии серверного веб- API, который не зависит от веб-приложения, назначения ролей для веб-приложения не применяются к веб-API. Более подробное описание этого момента см. в статье [Защита серверного веб-API].

### Реализация

**Определение ролей.** Поставщик SaaS объявляет роли приложения в манифесте приложения. Например, вот запись манифеста для приложения Surveys:

```
"appRoles": [
  {
    "allowedMemberTypes": [
      "User"
    ],
    "description": "Creators can create Surveys",
    "displayName": "SurveyCreator",
    "id": "1b4f816e-5eaf-48b9-8613-7923830595ad",
    "isEnabled": true,
    "value": "SurveyCreator"
  },
  {
    "allowedMemberTypes": [
      "User"
    ],
    "description": "Administrators can manage the Surveys in their tenant",
    "displayName": "SurveyAdmin",
    "id": "c20e145e-5459-4a6c-a074-b942bbd4cfe1",
    "isEnabled": true,
    "value": "SurveyAdmin"
  }
],
```

Свойство `value` отображается в утверждении роли. Свойство `id` является уникальным идентификатором для определенной роли. Всегда создает новое значение GUID для `id`.

**Назначение пользователей**. Во время регистрации нового клиента приложение регистрируется в клиенте AD. На этом этапе администратор AD этого клиента может назначить роли пользователям.

> [AZURE.NOTE] Как отмечалось ранее, клиенты с Azure AD Premium также могут назначать роли группам безопасности.

На следующем снимке портала Azure показаны три пользователя. Элис назначили роль напрямую. Боб унаследовал роль, являясь членом группы безопасности "Администраторы опросов", которой назначена роль. Чарльзу не назначена никакая роль.

![Назначенные пользователи](media/guidance-multitenant-identity/role-assignments.png)

> [AZURE.NOTE] Кроме того, приложение может назначать роли программным способом с помощью API Graph Azure AD. Однако для этого приложение должно получить разрешения на запись в каталог AD клиента. Приложение с этими разрешениями может доставить много неприятностей, а клиент ожидает, что приложение не создаст путаницу в каталоге. Возможно, многие клиенты не захотят предоставлять этот уровень доступа.

**Получение утверждения ролей**. При входе пользователя в систему приложение получает назначенные роли пользователя в утверждении с типом `http://schemas.microsoft.com/ws/2008/06/identity/claims/role`.

Пользователь может иметь несколько ролей или вообще не иметь ролей. Создавая код авторизации, не следует предполагать, что у пользователя есть только одно утверждение роли. Наоборот, напишите код, который проверяет наличие значения определенного утверждения, как показано ниже.

```csharp
if (context.User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
```

## Роли, использующие группы безопасности Azure AD

В этом случае роли представлены в виде групп безопасности AD. Приложение назначает разрешения пользователям на основе их членства в группах безопасности.

Преимущества:

-	этот подход позволяет клиентам, у которых не установлена служба Azure AD Premium, использовать группы безопасности для управления назначениями ролей.

Недостатки:

- сложность. Поскольку каждый клиент отправляет разные утверждения групп, приложение должно отслеживать соответствие групп безопасности ролям приложения для каждого клиента.
- Если клиент удаляет приложение из своего клиента AD, группы безопасности остаются в каталоге AD.

### Реализация

В манифесте приложения задайте свойству `groupMembershipClaims` значение "SecurityGroup". Это необходимо для получения утверждений членства в группах из Azure AD.

```
{
   // ...
   "groupMembershipClaims": "SecurityGroup",
}
```

При регистрации нового клиента приложение указывает на необходимость создания групп безопасности для ролей, требуемых для приложения. Затем клиент должен ввести идентификаторы объектов групп в приложение. Приложение хранит их в таблице, которая сопоставляет идентификаторы групп с ролями приложения для каждого клиента.

> [AZURE.NOTE] Кроме того, приложение может создавать группы программным способом с помощью API Graph Azure AD. В этом случае вероятность появления ошибок значительно уменьшается. Однако для этого приложение должно получить для всех групп разрешения на чтение и запись в каталог AD клиента. Возможно, многие клиенты не захотят предоставлять этот уровень доступа.

При входе пользователя:

1.	Приложение получает группы пользователя в виде утверждений. Значением каждого утверждения является идентификатор объекта группы.
2.	Azure AD ограничивает количество групп, отправляемых в маркере. Если количество групп превышает этот предел, Azure AD отправляет специальное утверждение об "избыточности". Если такое утверждение присутствует, приложение должно отправить запрос в API Graph Azure AD на получение всех групп, которым принадлежит этот пользователь. Дополнительные сведения см. в разделе "Избыточность утверждений групп" статьи [Авторизация в облачных приложениях с помощью групп AD].
3.	Приложение начинает поиск идентификаторов объектов в своей базе данных, чтобы найти соответствующие роли приложения для назначения пользователю.
4.	Приложение добавляет участнику-пользователю значение настраиваемого утверждения, выражающее роль приложения. Например: `survey_role` = "SurveyAdmin".

Политики авторизации должны использовать настраиваемое утверждение роли, а не утверждение группы.

## Роли, использующие диспетчер ролей приложения

При использовании этого подхода роли приложения не хранятся в Azure AD. Приложение сохраняет назначения ролей для каждого пользователя в своей базе данных, например с помощью класса **RoleManager** в ASP.NET Identity.

Преимущества:

-	приложение полностью контролирует назначение ролей и пользователей.

Недостатки:

- более сложный и трудный в обслуживании подход;
- группы безопасности AD нельзя использовать для управления назначениями ролей;
- хранит сведения о пользователе в базе данных приложения, где по мере добавления или удаления пользователей может нарушиться синхронизация с каталогом AD клиента.   

Для данного подхода существует множество примеров. Например, см. статью [Создание приложения ASP.NET MVC с проверкой подлинности и базой данных SQL и его развертывание в службе приложений Azure].


## Дополнительные ресурсы

-	[Авторизация в веб-приложении с помощью ролей приложений Azure AD и утверждений ролей]
-	[Авторизация в облачных приложениях с помощью групп AD]
-	[Управление доступом на основе ролей в облачных приложениях с помощью Azure AD]
-	[Поддерживаемые маркеры и типы утверждений]. Описание утверждений ролей и групп в Azure AD.
-	[Основные сведения о манифесте приложения Azure Active Directory]

<!-- Links -->
[Tailspin]: guidance-multitenant-identity-tailspin.md
[цикл статей]: guidance-multitenant-identity.md
[авторизации]: guidance-multitenant-identity-authorize.md
[Защита серверного веб-API]: guidance-multitenant-identity-web-api.md
[Авторизация в облачных приложениях с помощью групп AD]: http://www.dushyantgill.com/blog/2014/12/10/authorization-cloud-applications-using-ad-groups/
[Создание приложения ASP.NET MVC с проверкой подлинности и базой данных SQL и его развертывание в службе приложений Azure]: ../app-service-web/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database.md
[Основные сведения о манифесте приложения Azure Active Directory]: ../active-directory/active-directory-application-manifest.md
[Поддерживаемые маркеры и типы утверждений]: ../active-directory/active-directory-token-and-claims.md
[Управление доступом на основе ролей в облачных приложениях с помощью Azure AD]: http://www.dushyantgill.com/blog/2014/12/10/roles-based-access-control-in-cloud-applications-using-azure-ad/
[Авторизация в веб-приложении с помощью ролей приложений Azure AD и утверждений ролей]: https://github.com/Azure-Samples/active-directory-dotnet-webapp-roleclaims
[пример приложения]: https://github.com/Azure-Samples/guidance-identity-management-for-multitenant-apps

<!---HONumber=AcomDC_0302_2016-->