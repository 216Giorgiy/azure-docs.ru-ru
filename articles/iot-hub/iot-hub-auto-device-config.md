---
title: Настройка и мониторинг устройств Интернета вещей в масштабе с помощью Центра Интернета вещей Azure | Документация Майкрософт
description: Использование автоматических конфигураций устройств Центра Интернета вещей Azure для назначения конфигурации нескольким устройствам
services: iot-hub
documentationcenter: ''
author: ChrisGMsft
manager: timlt
editor: ''
ms.service: iot-hub
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 04/13/2018
ms.author: chrisgre
ms.openlocfilehash: 7146fba69857c3a612ce1b3dbb83387c1f3068d6
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
---
# <a name="configure-and-monitor-iot-devices-at-scale---preview"></a>Настройка и мониторинг устройств Центра Интернета вещей в масштабе (предварительная версия)

Автоматическое управление устройствами в Центре Интернета вещей Azure автоматизирует многие повторяющиеся и сложные задачи управления большим парком устройств на протяжении всего их жизненного цикла. Благодаря автоматическому управлению устройствами вы можете указать нужный набор устройств на основе их свойств, определить желаемую конфигурацию и позволить Центру Интернета вещей обновлять устройства, когда они попадают в область.  Это выполняется с использованием автоматической конфигурации устройства, которая также позволят вам подытожить завершение и соответствие требованиям, обрабатывать слияние и конфликты и развертывать конфигурации с помощью поэтапного подхода.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматические конфигурации устройств работают, обновляя набор двойников устройств с указанием требуемых свойств и предоставляя сводку на основе сообщаемых свойств двойников устройств.  В результате производится новый класс и документ JSON, называемый _Configuration_, который состоит из трех частей:

* **Целевое условие** определяет область обновляемых двойников устройств. Целевое условие задается как запрос в тегах двойников устройств или как сообщаемые свойства.

* **Целевое содержимое** определяет требуемые свойства, которые необходимо добавить или обновить в целевых двойниках устройств. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются как запросы в сообщаемых свойствах двойников устройств.  Системные метрики — это метрики по умолчанию, которые измеряют состояние обновления двойника, например количество целевых двойников и количество двойников, которые были успешно обновлены. 

## <a name="implement-device-twins-to-configure-devices"></a>Реализация двойников устройств для настройки устройств

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  Руководство по использованию двойников устройств см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей][lnk-device-twin].

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием конфигурации необходимо указать устройства, на которые вы хотите повлиять. Центр Интернета вещей Azure определяет устройства с помощью тегов в двойнике устройства. Каждое устройство может иметь несколько тегов. Их можно определить любым способом, который лучше всего подходит для вашего решения. Например, если вы управляете устройствами в разных расположениях, вы можете добавить следующие теги в двойник устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="create-a-configuration"></a>Создание конфигурации

1. Найдите нужный Центр Интернета вещей на [портале Azure][lnk-portal]. 
1. Выберите **Device configuration (preview)** (Конфигурация устройства (предварительная версия)).
1. Щелкните **Добавить конфигурацию**.

Процедура создания конфигурации состоит из пяти шагов. В следующих разделах описан каждый из этих шагов. 

### <a name="step-1-name-and-label"></a>Шаг 1. Имя и метка

1. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.
1. Добавьте метки для отслеживания конфигураций. Метки представляют собой пары **имени** и **значения**, которые описывают конфигурацию. Например, `HostPlatform, Linux` или `Version, 3.0.1`.
1. Нажмите кнопку **Далее**, чтобы перейти ко второму шагу. 

### <a name="step-2-specify-settings"></a>Шаг 2. Указание параметров

В этом разделе определяется целевое содержимое, которое необходимо настроить в целевых двойниках устройств. Для каждого набора параметров есть два вида входных данных. Первый — это путь к двойнику устройства, который представляет собой путь к разделу JSON, где будут заданы два требуемых свойства.  Второй — это содержимое JSON, которое должно быть вставлено в этот раздел. Например, заполните поля Device Twin Path (Путь к двойнику устройства) и Content (Содержимое) следующим образом:

![Указание пути к двойнику устройства и содержимого](./media/iot-hub-auto-device-config/create-configuration-full-browser.png)

Вы также можете установить индивидуальные параметры, указав весь путь и значение содержимого без скобок. Например, задайте для параметра Device Twin Path (Путь к двойнику устройства) значение `properties.desired.chiller-water.temperature`, а для Content (Содержимое) — `66`.

Если две или несколько конфигураций указывают на один и тот же путь, то будет использоваться содержимое из конфигурации с наивысшим приоритетом (приоритет определяется на шаге 4).

Если вы хотите удалить свойство, укажите для него значение `null`.

Вы можете добавить дополнительные параметры, щелкнув **Add Device Twin Setting** (Добавить параметр двойника устройства).

### <a name="step-3-specify-metrics-optional"></a>Шаг 3. Указание метрик (необязательно)

Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров.

1. Введите имя для параметра **Имя метрики**.
1. Введите запрос для параметра **Metric Criteria** (Критерии метрики).  Запрос основан на сообщаемых свойствах двойников устройств.  Метрика представляет количество строк, возвращаемых запросом.

Например: `SELECT deviceId FROM devices WHERE properties.reported.chillerWaterSettings.status='pending'`

Вы можете включить предложение с указанием того, что конфигурация была применена, например: `SELECT deviceId FROM devices WHERE configurations.yourconfigname.status='Applied'`


### <a name="step-4-target-devices"></a>Шаг 4. Назначение устройств

С помощью свойств тегов ваших двойников устройств можно назначить конкретные устройства, к которым будет применяться эта конфигурация.  Вы также можете указать на устройства с помощью сообщаемых свойств двойников устройств.

Так как несколько конфигураций могут предназначаться для одного устройства, каждой конфигурации необходимо присвоить номер приоритета. Если возникает конфликт, побеждает конфигурация с наивысшим приоритетом. 

1. Введите положительное целое число для **приоритета** конфигурации. Наивысшее числовое значение считается наивысшим приоритетом. Когда обе конфигурации имеют одинаковый номер приоритета, побеждает та, которая была создана недавно. 
1. Введите **условие назначения**, чтобы определить, для каких устройств будет предназначена эта конфигурация. Условие основано на тегах двойника устройства или его сообщаемых свойствах и должно соответствовать формату выражения. Например, `tags.environment='test'` или `properties.reported.chillerProperties.model='4000x'`. 
1. Нажмите кнопку **Далее**, чтобы перейти к последнему шагу.

### <a name="step-5-review-configuration"></a>Шаг 5. Просмотр конфигурации

Просмотрите сведения о конфигурации, а затем выберите **Отправить**.

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы просмотреть сведения о конфигурации и узнать, какое устройство ее использует, сделайте следующее:

1. Найдите нужный Центр Интернета вещей на [портале Azure][lnk-portal]. 
1. Выберите **Device configuration (preview)** (Конфигурация устройства (предварительная версия)).
1. Проверьте список конфигураций. Для каждой конфигурации можно просмотреть следующие сведения:
   * **Идентификатор**. Имя конфигурации.
   * **Целевое условие**. Тег, используемый для определения целевых устройств.
   * **Приоритет**. Номер приоритета, назначенный для конфигурации.
   * **Время создания**. Метка времени, когда была создана конфигурация. Метка времени используется, чтобы разорвать связи, если две конфигурации имеют одинаковый приоритет. 
   * **Системные метрики**. Метрики, которые вычисляются Центром Интернета вещей и не могут быть настроены разработчиками. Целевое условие указывает количество двойников устройств, которые соответствуют целевому состоянию. Применяет заданное количество двойников устройств, которые были изменены конфигурацией, а также могут содержать частичные изменения в случае, если они были сделаны отдельной конфигурацией с более высоким приоритетом. 
   * **Пользовательские метрики**. Метрики, заданные разработчиком в качестве запросов к сообщаемым свойствам двойников устройств.  Для каждой конфигурации можно определить до пяти пользовательских метрик. 
   
1. Выберите конфигурацию, которую следует отслеживать.  
1. Проверьте сведения о конфигурации. С помощью вкладок можно просмотреть конкретные сведения об устройствах, к которым применена конфигурация: 
   * **Целевое условие**. Устройства, которые соответствуют целевому условию. 
   * **Метрики**. Список системных и пользовательских метрик.  Вы можете просмотреть список устройств для каждой метрики, выбрав метрику в раскрывающемся списке, а затем щелкнув **View Devices** (Просмотреть устройства).
   * **Device Twin Settings** (Параметры двойников устройств). Параметры двойников устройств, настроенные с помощью конфигурации. 
   * **Configuration Labels** (Метки конфигурации). Пары "ключ — значение", используемые для описания конфигурации.  Метки не влияют на функциональность. 

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:
* Если двойник устройства не соответствует предыдущему условию назначения, однако соответствует новому и эта конфигурация имеет самый высокий приоритет для двойника устройства, то она будет применена к двойнику устройства. 
* Если двойник устройства больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойник устройства будет изменен с помощью следующей конфигурации с наивысшим приоритетом. 
* Если двойник устройства, работающий в настоящее время в этой конфигурации, больше не удовлетворяет целевому условию и не соответствует целевому условию любых других конфигураций, параметры из конфигурации будут удалены и никакие другие изменения не будут сделаны в двойнике. 

Чтобы изменить конфигурацию, сделайте следующее: 

1. Найдите нужный Центр Интернета вещей на [портале Azure][lnk-portal]. 
1. Выберите **Device configuration (preview)** (Конфигурация устройства (предварительная версия)). 
1. Выберите конфигурацию, которую следует изменить. 
1. Внесите изменения в следующие поля: 
   * Условие назначения 
   * Метки 
   * Приоритет 
   * Метрики
1. Щелкните **Сохранить**.
1. Следуйте указаниям раздела [Мониторинг конфигурации] для отслеживания выполнения изменений. 

## <a name="delete-a-configuration"></a>Удаление конфигурации

Когда вы удаляете конфигурацию, все двойники устройств принимают следующую конфигурацию с самым высоким приоритетом. Если двойники устройств не соответствуют целевому условию любой другой конфигурации, то другие параметры не применяются. 

1. Найдите нужный Центр Интернета вещей на [портале Azure][lnk-portal]. 
1. Выберите **Device configuration (preview)** (Конфигурация устройства (предварительная версия)). 
1. Установите флажок, чтобы выбрать конфигурацию, которую необходимо удалить. 
1. Нажмите кнопку **Удалить**.
1. Появится запрос на подтверждение.

## <a name="next-steps"></a>Дополнительная информация
В этой статье вы узнали, как настроить и отслеживать устройства Центра Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме][lnk-bulkIDs]
* [Метрики Центра Интернета вещей][lnk-metrics]
* [Мониторинг операций][lnk-monitor]

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей][lnk-devguide]
* [Развертывание ИИ на пограничных устройствах с использованием Azure IoT Edge][lnk-iotedge]

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure][lnk-dps]

[lnk-device-twin]: iot-hub-devguide-device-twins.md
[lnk-bulkIDs]: iot-hub-bulk-identity-mgmt.md
[lnk-metrics]: iot-hub-metrics.md
[lnk-monitor]: iot-hub-operations-monitoring.md

[lnk-devguide]: iot-hub-devguide.md
[lnk-iotedge]: ../iot-edge/tutorial-simulate-device-linux.md
[lnk-dps]: https://azure.microsoft.com/documentation/services/iot-dps
[lnk-portal]: https://portal.azure.com
