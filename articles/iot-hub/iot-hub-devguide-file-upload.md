---
title: "Общие сведения об отправке файлов в Центре Интернета вещей Azure | Документация Майкрософт"
description: "Руководство разработчика. Воспользуйтесь функцией отправки файлов в Центре Интернета вещей для управления передачей файлов с устройства в контейнер больших двоичных объектов службы хранилища Azure."
services: iot-hub
documentationcenter: .net
author: dominicbetts
manager: timlt
editor: 
ms.assetid: a0427925-3e40-4fcd-96c1-2a31d1ddc14b
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/04/2017
ms.author: dobett
translationtype: Human Translation
ms.sourcegitcommit: 9ded95283b52f0fc21ca5b99df8e72e1e152fe1c
ms.openlocfilehash: c56a568fa003ec45e92279e070e6309763071827
ms.lasthandoff: 02/17/2017


---
# <a name="file-uploads-with-iot-hub"></a>Отправка файлов с помощью Центра Интернета вещей

## <a name="overview"></a>Обзор

Как описано в статье о [конечных точках Центра Интернета вещей][lnk-endpoints], устройства могут инициировать передачу файлов путем отправки уведомления через конечную точку, доступную для устройства (**/devices/{deviceId}/files**).  Когда устройство уведомляет Центр Интернета вещей о завершении отправки, Центр создает уведомления об отправке файлов. Затем они в виде сообщений передаются пользователю через конечную точку, обращенную к службе (**/messages/servicebound/filenotifications**).

Вместо функций брокера сообщений центр IoT выполняет роль диспетчера для связанной учетной записи хранения Azure. Устройство запрашивает из центра IoT маркер хранилища, относящийся к файлу, который должно отправить устройство. Для отправки файла в хранилище устройство использует код URI SAS, а по завершении загрузки отправляет соответствующее уведомление в центр IoT. Центр IoT проверяет, отправлен ли файл, и добавляет уведомление о его передаче в новую конечную точку, обращенную к службе.

Перед отправкой файла в Центр Интернета вещей с устройства необходимо настроить центр, [связав учетную запись хранения Azure][lnk-associate-storage] с ним.

После этого устройство сможет [инициализировать отправку][lnk-initialize] и [уведомить Центр Интернета вещей][lnk-notify] о завершении передачи. Служба может дополнительно создавать [ уведомительные сообщения][lnk-service-notification], когда устройство будет уведомлять Центр Интернета вещей о завершении передачи.

### <a name="when-to-use"></a>Сценарии использования

Передача файлов используется для отправки файлов мультимедиа и больших пакетов телеметрии, передаваемых периодически подключаемыми устройствами или сжатых для экономии пропускной способности.

Дополнительные сведения см. в [руководстве по обмену данными, отправляемыми с устройства в облако][lnk-d2c-guidance], если сомневаетесь между использованием сообщаемых свойств, сообщений, отправляемых с устройства в облако, или передачей файла.

## <a name="associate-an-azure-storage-account-with-iot-hub"></a>Связывание учетной записи хранения Azure с Центром Интернета вещей

Чтобы использовать функции отправки файлов, сначала необходимо связать учетную запись хранения Azure с центром IoT. Это можно сделать на [портале Azure][lnk-management-portal] или программно (с помощью [интерфейсов REST API поставщика ресурсов Центра Интернета вещей][lnk-resource-provider-apis]). После привязки учетной записи хранения к Центру Интернета вещей служба возвращает универсальный код ресурса (URI) SAS на устройство, получив от него запрос на отправку файла.

> [!NOTE]
> [Пакеты SDK для Azure IoT][lnk-sdks] автоматически управляют получением кода URI SAS, отправкой файла и уведомлением Центра Интернета вещей о завершении отправки.


## <a name="initialize-a-file-upload"></a>Инициализация отправки файла
У Центра Интернета вещей есть конечная точка, предназначенная для выполнения устройствами запросов на URI SAS хранилища, куда необходимо отправить файл. Устройство инициирует передачу файла, отправив запрос POST в Центр Интернета вещей по адресу `{iot hub}.azure-devices.net/devices/{deviceId}/files` со следующим текстом в формате JSON:

```json
{
    "blobName": "{name of the file for which a SAS URI will be generated}"
}
```

Центр Интернета вещей возвращает следующие данные, которые устройство использует для передачи файла:

```json
{
    "correlationId": "somecorrelationid",
    "hostname": "contoso.azure-devices.net",
    "containerName": "testcontainer",
    "blobName": "test-device1/image.jpg",
    "sasToken": "1234asdfSAStoken"
}
```

### <a name="deprecated-initialize-a-file-upload-with-a-get"></a>Инициализация передачи файла с использованием запроса GET (не рекомендуется)

> [!NOTE]
> В этом разделе описаны нерекомендуемые возможности получения кода URI SAS из Центра Интернета вещей. Следует использовать метод POST, описанный выше.

Центр IoT располагает двумя конечными точками REST для поддержки отправки файлов. Одна предназначена для получения кода URI SAS для хранения, а другая — для уведомления центра IoT о завершении загрузки. Устройство инициирует передачу файла, отправив запрос GET в центр IoT по адресу `{iot hub}.azure-devices.net/devices/{deviceId}/files/{filename}`. Центр Интернета вещей возвращает код URI SAS, относящийся к отправляемому файлу, и идентификатор корреляции, который будет использоваться по завершении отправки.

## <a name="notify-iot-hub-of-a-completed-file-upload"></a>Уведомление центра IoT о завершении отправки файла

Устройство отвечает за отправку файла в хранилище при помощи пакетов SDK службы хранилища Azure. По завершении отправки устройство отправляет запрос POST в Центр Интернета вещей по адресу `{iot hub}.azure-devices.net/devices/{deviceId}/files/notifications` со следующим текстом JSON:

```json
{
    "correlationId": "{correlation ID received from the initial request}",
    "isSuccess": bool,
    "statusCode": XXX,
    "statusDescription": "Description of status"
}
```

Значение `isSuccess` является логическим и указывает, успешно ли загружен файл. Код состояния для `statusCode` является состоянием отправки файла в хранилище и `statusDescription` соответствует `statusCode`.

## <a name="reference-topics"></a>Справочные материалы

Далее предоставлены дополнительные сведения о передаче файлов с устройства.

## <a name="file-upload-notifications"></a>Уведомления об отправке файлов

Когда устройство отправляет файл и уведомляет центр IoT о завершении отправки, служба при необходимости создает сообщение с уведомлением, которое содержит имя и расположение файла.

Как описано в разделе [Конечные точки][lnk-endpoints], Центр Интернета вещей доставляет уведомления об отправке файлов через конечную точку, доступную для службы (**/messages/servicebound/fileuploadnotifications**), в виде сообщений. Семантика получения уведомлений об отправке файлов идентична семантике, используемой для сообщений, отправляемых из облака на устройство, и предусматривает такой же [жизненный цикл сообщения][lnk-lifecycle]. Каждое сообщение, полученное из конечной точки уведомления об отправке файла, — это запись JSON с перечисленными ниже свойствами.

| Свойство | Описание |
| --- | --- |
| EnqueuedTimeUtc |Метка времени, указывающая, когда было создано уведомление. |
| deviceId |**DeviceId** устройства, с которого был отправлен файл. |
| BlobUri |Код URI переданного файла. |
| BlobName |Имя переданного файла. |
| LastUpdatedTime |Метка времени, указывающая, когда файл был в последний раз обновлен. |
| BlobSizeInBytes |Размер переданного файла. |

**Пример**. В этом примере показан текст уведомления об отправке файла.

```json
{
    "deviceId":"mydevice",
    "blobUri":"https://{storage account}.blob.core.windows.net/{container name}/mydevice/myfile.jpg",
    "blobName":"mydevice/myfile.jpg",
    "lastUpdatedTime":"2016-06-01T21:22:41+00:00",
    "blobSizeInBytes":1234,
    "enqueuedTimeUtc":"2016-06-01T21:22:43.7996883Z"
}
```

## <a name="file-upload-notification-configuration-options"></a>Параметры конфигурации уведомлений об отправке файла

Каждый центр IoT предоставляет перечисленные ниже параметры конфигурации уведомлений об отправке файлов.

| Свойство | Описание | Диапазон и значение по умолчанию |
| --- | --- | --- |
| **enableFileUploadNotifications** |Позволяет указать, следует ли записывать уведомления об отправке файлов в конечную точку файловых уведомлений. |Bool. По умолчанию: True. |
| **fileNotifications.ttlAsIso8601** |Значение TTL по умолчанию для уведомлений об отправке файлов. |Интервал ISO_8601 — до 48 часов (минимум 1 минута). Значение по умолчанию — 1 час. |
| **fileNotifications.lockDuration** |Длительность блокировки для очереди уведомлений об отправке файлов. |5–300 секунд (минимум 5 секунд). Значение по умолчанию — 60 секунд. |
| **fileNotifications.maxDeliveryCount** |Максимальное количество доставок для очереди уведомлений об отправке файлов. |От 1 до 100. Значение по умолчанию — 100. |

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* Статья [IoT Hub endpoints][lnk-endpoints] (Конечные точки Центра Интернета вещей) содержит сведения о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Throttling and quotas][lnk-quotas] (Регулирование и квоты) содержит сведения о квотах, применимых к службе Центра Интернета вещей, и ожидаемом поведении регулирования при использовании службы.
* В статье [Пакеты SDK для устройств и служб Интернета вещей Azure][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Справочник по языку запросов для двойников и заданий][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.
* Статья [Поддержка MQTT в центре IoT][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как передавать файлы с устройств с помощью Центра Интернета вещей, вас могут заинтересовать следующие статьи в руководстве разработчика для Центра Интернета вещей:

* [Manage device identities in IoT Hub][lnk-devguide-identities] (Управление удостоверениями устройств в Центре Интернета вещей)
* [Управление доступом к Центру Интернета вещей][lnk-devguide-security]
* [Основные сведения о двойниках устройств (предварительная версия)][lnk-devguide-device-twins]
* [Вызов прямого метода на устройстве (предварительная версия)][lnk-devguide-directmethods]
* [Schedule jobs on multiple devices][lnk-devguide-jobs] (Планирование заданий на нескольких устройствах)

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующее руководство по Центру Интернета вещей:

* [Учебник: как передать файлы из устройств в облако с помощью центра IoT][lnk-fileupload-tutorial]

[lnk-resource-provider-apis]: https://docs.microsoft.com/rest/api/iothub/iothubresource
[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md
[lnk-management-portal]: https://portal.azure.com
[lnk-fileupload-tutorial]: iot-hub-csharp-csharp-file-upload.md
[lnk-associate-storage]: iot-hub-devguide-file-upload.md#associate-an-azure-storage-account-with-iot-hub
[lnk-initialize]: iot-hub-devguide-file-upload.md#initialize-a-file-upload
[lnk-notify]: iot-hub-devguide-file-upload.md#notify-iot-hub-of-a-completed-file-upload
[lnk-service-notification]: iot-hub-devguide-file-upload.md#file-upload-notifications
[lnk-lifecycle]: iot-hub-devguide-messaging.md#message-lifecycle
[lnk-d2c-guidance]: iot-hub-devguide-d2c-guidance.md

[lnk-devguide-identities]: iot-hub-devguide-identity-registry.md
[lnk-devguide-security]: iot-hub-devguide-security.md
[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md

