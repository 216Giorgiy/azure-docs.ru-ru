<properties
	pageTitle="Управление устройствами в центре IoT: ";двойники"; | Microsoft Azure"
	description="В учебнике по использованию Azure IoT Hub для управления устройствами описывается, как использовать ";двойники"; устройств."
	services="iot-hub"
	documentationCenter=".net"
	authors="ellenfosborne"
	manager="timlt"
	editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="dotnet"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="04/29/2016"
 ms.author="elfarber"/>

# Учебник по использованию "двойников" устройств (предварительная версия)

Управление устройствами центра IoT Azure позволяет использовать "двойники" устройств — представление физического устройства на стороне службы. Ниже представлена схема, демонстрирующая различные компоненты "двойника" устройства.

![][img-twin]

В этом учебнике рассматриваются свойства устройств. Дополнительные сведения о других компонентах см. в статье [Overview of Azure IoT Hub device management][lnk-dm-overview] (Общие сведения об управлении устройствами с помощью центра IoT Azure).

Свойства устройства — это предопределенный словарь свойств, описывающих физическое устройство. Физическое устройство определяет каждое свойство устройства и является полномочным хранилищем для всех соответствующих значений. Согласованное представление этих свойств хранится в "двойнике" устройства в облаке. Согласованность и актуальность свойств зависят от параметров синхронизации, описанных ниже. Примерами свойства устройства могут служить версия встроенного ПО, уровень заряда аккумулятора и наименование производителя.

## Синхронизация свойств устройства

Физическое устройство — это полномочный источник свойств устройства. Выбранные значения на физическом устройстве автоматически синхронизируются с "двойником" устройства в центре IoT по шаблону *наблюдения/уведомления*, описанному LWM2M.

Если физическое устройство подключается к центру IoT, служба запускает *наблюдение* за свойствами выбранного устройства. Затем физическое устройство *уведомляет* центр IoT об изменениях в свойствах устройства. Для реализации гистерезиса **pmin** (минимальное время между уведомлениями) составляет 5 минут. Это означает, что физическое устройств уведомляет центр IoT о каждом свойстве не чаще, чем раз в 5 минут, даже если свойство изменилось. Для сохранения актуальности данных **pmax** (максимальное время между уведомлениями) составляет 6 часов. Это означает, что физическое устройств уведомляет центр IoT о каждом свойстве не реже, чем раз в 6 часов, даже если свойство за это время не изменилось.

При отключении физического устройства синхронизация прекращается. При повторном подключении устройства к службе синхронизация перезапускается. Для контроля за актуальностью данных время последнего обновления свойства всегда можно проверить.

Полный список свойств устройства, наблюдение за которыми выполняется автоматически, приводится ниже:

![][img-observed]

## Пример запроса "двойника" устройства

Следующий пример дополняет учебник [Приступая к работе с функцией управления устройствами центра IoT Azure][lnk-get-started]. Он предназначен для работы с другими виртуальными устройствами и включает "двойник" устройства для чтения и изменения свойств виртуального устройства.

### Предварительные требования 

Перед запуском этого примера необходимо выполнить действия, описанные в статье [Приступая к работе с функцией управления устройствами центра IoT Azure][lnk-get-started]. Это означает, что виртуальные устройства должны быть запущены. Если эта процедура уже выполнялась, виртуальные устройства необходимо перезапустить.

### Запуск примера

Чтобы запустить пример, необходимо выполнить процесс **DeviceTwin.exe**. Эта функция считывает свойства устройства из "двойника" и с физического устройства. Кроме того, она изменяет свойство устройства на физическом устройстве. Чтобы запустить пример, выполните следующие действия.

1.  В корневой папке, куда клонирован репозиторий **azure-iot-sdks**, откройте папку **azure-iot-sdks\\csharp\\service\\samples\\bin**.  

2.  Запустите `DeviceTwin.exe <IoT Hub Connection String>`.

В окне командной строки отобразится использование "двойника" устройства. В этом примере выполняется следующая процедура:

1.  Печать всех свойств устройства в "двойнике" устройства.

2.  Полное чтение: чтение свойства, соответствующего уровню заряда аккумулятора устройства (три раза).

3.  Полная запись: запись свойства **Timezone** на физическое устройство.

4.  Полное чтение: чтение свойства **Timezone** с физического устройства, чтобы проверить, не изменилось ли оно.

### Неполное чтение

Между *неполным* чтением и *полным* чтением и записью существует различие. При неполном чтении возвращается значение запрошенного свойства из "двойника" устройства, сохраненного в центре IoT Azure. Это значение берется из предыдущей операции уведомления. Запись не может быть неполной, поскольку физическое устройство — это полномочный источник свойств устройства. Неполное чтение — это просто чтение свойства из "двойника" устройства:

```
device.DeviceProperties[DevicePropertyNames.BatteryLevel].Value.ToString();
```

Чтобы определить актуальность этих значений, можно проверить время последнего обновления:

```
device.DeviceProperties[DevicePropertyNames.BatteryLevel].LastUpdatedTime.ToString();
```

Точно так же можно считывать свойства службы, которые хранятся только в "двойнике" устройства. Они не синхронизируются с устройством.

### Полное чтение

Полное чтение запускает задание устройства, которое считывает значение запрошенного свойства из физического устройства. Задания устройств впервые представлены в статье [Общие сведения об управлении устройствами Azure IoT][lnk-dm-overview] и подробно описаны в [учебнике по использованию заданий устройств для обновления встроенного ПО устройств][lnk-dm-jobs]. Полное чтение позволяет получить более актуальное значение свойства устройства, поскольку актуальность не ограничивается периодичностью уведомлений. Задание отправляет сообщение на физическое устройство и передает в "двойник" устройства последнее значение заданного свойства. Оно не обновляет "двойник" устройства полностью.

```
JobResponse jobResponse = await deviceJobClient.ScheduleDevicePropertyReadAsync(Guid.NewGuid().ToString(), deviceId, propertyToRead);
```

Полное чтение свойств или тегов службы невозможно, поскольку они не синхронизируются с устройством.

### Полная запись

Если вы хотите изменить доступное для записи свойство устройства, используйте полную запись — она запускает задание устройства, которое записывает значение на физическое устройство. Не все свойства устройств доступны для записи. Полный список см. в приложении А, [Introducing the Azure IoT Hub device management client library][lnk-dm-library] (Знакомство с клиентской библиотекой управления устройствами в центре IoT Azure).

Задание отправляет на физическое устройство сообщение для обновления указанного свойства. "Двойник" устройства не обновляется сразу после завершения задания. Это происходит при следующем уведомлении. После синхронизации изменение в "двойнике" устройства можно определить, используя неполную запись.

```
JobResponse jobResponse = await deviceJobClient.ScheduleDevicePropertyWriteAsync(Guid.NewGuid().ToString(), deviceId, propertyToSet, setValue);
```

### Сведения о реализации эмулятора устройств

Рассмотрим, что нужно сделать на стороне устройства для того, чтобы реализовать шаблон наблюдения/уведомления и полного чтения/записи.

Поскольку свойства устройства синхронизируются исключительно через клиентскую библиотеку управления устройствами в центре IoT Azure, вам нужно только вызвать API для настройки свойства устройства (в данном случае это уровень заряда аккумулятора) с обычной периодичностью. Когда служба выполняет полное чтение, возвращается последнее установленное значение. Когда служба выполняет полную запись, вызывается метод set. Пример см. в **iotdm\_simple\_sample.c**:

```
int level = get_batterylevel();  // call to platform specific code 
set_device_batterylevel(0, level);
```

Вместо применения метода set можно реализовать обратный вызов. Дополнительные сведения об этом варианте см. в статье [Introducing the Azure IoT Hub device management library][lnk-dm-library] (Знакомство с библиотекой управления устройствами в центре IoT Azure).

## Дальнейшие действия

Дополнительные сведения о возможностях управления устройствами центра IoT Azure можно просмотреть в руководствах:

- [How to find device twins using queries][lnk-tutorial-queries] (Поиск "двойников" устройств с использованием запросов)

- [How to use device jobs to update device firmware][lnk-dm-jobs] (Использование заданий устройства для обновления встроенного ПО устройства)

- Клиентская библиотека управления устройствами в центре IoT Azure содержит полноценный пример кода с использованием [устройства Intel Edison][lnk-edison].

<!-- images and links -->
[img-twin]: media/iot-hub-device-management-device-twin/image1.png
[img-observed]: media/iot-hub-device-management-device-twin/image2.png

[lnk-dm-overview]: iot-hub-device-management-overview.md
[lnk-dm-library]: iot-hub-device-management-library.md
[lnk-get-started]: iot-hub-device-management-get-started.md
[lnk-tutorial-queries]: iot-hub-device-management-device-query.md
[lnk-dm-jobs]: iot-hub-device-management-device-jobs.md
[lnk-edison]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c/iotdm_client/samples/iotdm_edison_sample

<!---HONumber=AcomDC_0504_2016-->