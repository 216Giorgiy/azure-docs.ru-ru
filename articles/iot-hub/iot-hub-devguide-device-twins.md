---
title: Руководство разработчика. Общие сведения о двойниках устройств | Microsoft Docs
description: Руководство разработчика Центра Интернета вещей Azure. Синхронизация данных состояния и конфигурации Центра Интернета вещей и устройств с помощью двойников устройств
services: iot-hub
documentationcenter: .net
author: fsautomata
manager: timlt
editor: ''

ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/30/2016
ms.author: elioda

---
# <a name="understand-device-twins---preview"></a>Основные сведения о двойниках устройств (предварительная версия)
## <a name="overview"></a>Обзор
*Двойники устройств* — это документы JSON, хранящие сведения о состоянии устройства (метаданные, конфигурации и условия). Центр Интернета вещей сохраняет двойник устройства для каждого устройства, подключаемого к Центру Интернета вещей. В этой статье описываются:

* структура двойника устройства: *теги*, *требуемые* и *сообщаемые свойства*;
* операции, которые приложения устройств и серверные части могут выполнить на двойнике устройства.

> [!NOTE]
> На данный момент доступ к двойникам устройств можно получить только на устройствах, подключающихся к Центру Интернета вещей по протоколу MQTT. Указания по преобразованию существующего приложения устройства для использования MQTT см. в статье [Поддержка MQTT][lnk-devguide-mqtt].
> 
> 

### <a name="when-to-use"></a>Сценарии использования
Двойники устройства используются для выполнения следующих действий:

* Сохранение метаданных устройства в облаке, например расположения развертывания торгового автомата.
* Сообщение сведений о текущем состоянии приложения устройства, таких как доступные возможности и условия, например подключение устройства по сети мобильной связи или Wi-Fi.
* Синхронизация состояния длительных рабочих процессов в приложении устройства и серверной части, например при указании новой версии встроенного ПО в серверной части и сообщении различных этапов процесса обновления в приложении устройства.
* Выполнение запроса метаданных, конфигурации или состояния устройства.

Используйте [сообщения, отправляемые с устройства в облако][lnk-d2c], в последовательностях событий с метками времени, например во временных рядах данных датчика или оповещениях. Используйте [методы отправки сообщений из облака на устройство][lnk-methods] для интерактивного управления устройствами, например для включения вентилятора.

## <a name="device-twins"></a>Двойники устройства
Двойники устройств хранят сведения об устройствах:

* Устройства и серверные части могут использовать их для синхронизации условий и конфигурации устройства.
* Серверная часть приложения может использовать их для выполнения запроса и указания длительных операций.

Жизненный цикл двойника устройства связан с соответствующим [удостоверением устройства][lnk-identity]. Двойники неявно создаются и удаляются при создании или удалении удостоверения устройства в Центре Интернета вещей.

Двойник устройства является документом JSON, содержащим следующие компоненты:

* **Теги**. Чтение и запись документа JSON осуществляется в серверной части. Теги не видны для приложений устройств.
* **Требуемые свойства**. Используются вместе с сообщаемыми свойствами для синхронизации конфигурации или условий устройства. Требуемые свойства задаются только в серверной части приложения, а их чтение осуществляется в приложении устройства. Приложение устройства может также в режиме реального времени получать уведомления об изменениях в требуемых свойствах.
* **Сообщаемые свойства**. Используется вместе с требуемыми свойствами для синхронизации конфигурации или условий устройства. Сообщаемые свойства задаются только в приложении устройства, а их чтение и запрос осуществляется в серверной части приложения.

Кроме того, корень двойника устройства содержит свойства только для чтения из соответствующего удостоверения, содержащиеся в [реестре удостоверений устройства][lnk-identity].

![][img-twin]

Ниже приведен пример документа JSON двойника устройства:

        {
            "deviceId": "devA",
            "generationId": "123",
            "status": "enabled",
            "statusReason": "provisioned",
            "connectionState": "connected",
            "connectionStateUpdatedTime": "2015-02-28T16:24:48.789Z",
            "lastActivityTime": "2015-02-30T16:24:48.789Z",

            "tags": {
                "$etag": "123",
                "deploymentLocation": {
                    "building": "43",
                    "floor": "1"
                }
            },
            "properties": {
                "desired": {
                    "telemetryConfig": {
                        "sendFrequency": "5m"
                    },
                    "$metadata" : {...},
                    "$version": 1
                },
                "reported": {
                    "telemetryConfig": {
                        "sendFrequency": "5m",
                        "status": "success"
                    }
                    "batteryLevel": 55,
                    "$metadata" : {...},
                    "$version": 4
                }
            }
        }

В корневом объекте содержатся системные свойства и объекты контейнера для `tags`, `reported` и `desired properties`. Контейнер `properties` содержит некоторые элементы только для чтения (`$metadata`, `$etag` и `$version`), описанные в разделах [Метаданные двойника][lnk-twin-metadata] и [Оптимистичный параллелизм][lnk-concurrency] соответственно.

### <a name="reported-property-example"></a>Пример сообщаемых свойств
В примере выше двойник устройства содержит свойство `batteryLevel`, сообщаемое приложением устройства. Это свойство позволяет выполнить запрос и работать на устройствах на основе последних сообщенных сведений об уровне заряда аккумулятора. Другой пример: приложение устройства сообщает о возможностях и вариантах подключения устройства.

Обратите внимание, как сообщаемые свойства упрощают сценарии, в которых серверной части нужно последнее известное значение свойства. Используйте [сообщения, отправленные с устройства в облако][lnk-d2c], если серверной части нужно обработать данные телеметрии устройства в виде последовательности событий с метками времени, например временные ряды.

### <a name="desired-configuration-example"></a>Пример требуемой конфигурации
В приведенном выше примере требуемые и сообщаемые свойства `telemetryConfig` используются в серверной части и приложении устройства для синхронизации конфигурации телеметрии для этого устройства. Например:

1. Серверная часть приложения задает требуемое свойство со значением требуемой конфигурации. Ниже приведен фрагмент документа с требуемым свойством:
   
        ...
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            ...
        },
        ...
2. Приложение устройства получает уведомление об изменении немедленно, если оно подключено, или при первом повторном подключении. Затем приложение устройства сообщает об обновленной конфигурации (или об условии ошибки с помощью свойства `status`). Ниже представлена часть сообщаемого свойства:
   
        ...
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            }
            ...
        }
        ...
3. Серверная часть приложения может отслеживать результаты конфигурации на множестве устройств, [отправляя запросы][lnk-query] на двойники.

> [!NOTE]
> Фрагменты выше являются примерами возможного способа кодирования конфигурации устройства и его состояния, оптимизированные для удобства чтения. Центр Интернета вещей не использует специальную схему для требуемых и сообщаемых свойств в двойниках устройств.
> 
> 

Зачастую двойники используются для синхронизации длительных операций, например обновления встроенного ПО. Дополнительные сведения о синхронизации и отслеживании длительных операций на устройствах с помощью свойств см. в статье [Настройка устройств с помощью требуемых свойств][lnk-twin-properties].

## <a name="back-end-operations"></a>Операции в серверной части
Серверная часть выполняет действия в двойнике с помощью следующих атомарных операций, доступных по протоколу HTTP:

1. **Получить двойник по идентификатору**. Эта операция возвращает содержимое документа двойника, включая теги, а также требуемые, сообщаемые и системные свойства.
2. **Частично обновить двойник**. Эта операция позволяет серверной части частично обновить теги или требуемые свойства двойника. Частичное обновление выражается в качестве документа JSON, который добавляет или обновляет все указанные свойства. Свойства, для которых указано значение `null`, удаляются. Например, следующий код создает требуемое свойство со значением `{"newProperty": "newValue"}`, перезаписывает существующее значение `existingProperty` на `"otherNewValue"` и полностью удаляет `otherOldProperty`. Другие существующие требуемые свойства или теги не изменяются:
   
        {
            "properties": {
                "desired": {
                    "newProperty": {
                        "nestedProperty": "newValue"
                    },
                    "existingProperty": "otherNewValue",
                    "otherOldProperty": null
                }
            }
        }
3. **Заменить требуемые свойства**. Эта операция позволяет серверной части полностью перезаписать все существующие требуемые свойства и заменить новый документ JSON для `properties/desired`.
4. **Заменить теги**. Аналогично операции замены требуемых свойств эта операция позволяет серверной части полностью перезаписать все существующие теги и заменить новый документ JSON для `tags`.

Все указанные выше операции поддерживают [оптимистичный параллелизм][lnk-concurrency] и требуют разрешения **ServiceConnect**, как указано в статье о [безопасности][lnk-security].

Помимо выполнения этих операций серверная часть может выполнять запросы к двойникам с помощью [языка запросов][lnk-query] по типу SQL и выполнять операции с большими наборами двойников с помощью [заданий][lnk-jobs].

## <a name="device-operations"></a>Операции с устройствами
Приложение устройства выполняет действия в двойнике с помощью следующих атомарных операций:

1. **Получить двойник**. Эта операция возвращает содержимое документа двойника (включая теги, а также требуемые, сообщаемые и системные свойства) для подключенного устройства.
2. **Частично обновить сообщаемые свойства**. Эта операция позволяет частично обновить сообщаемые свойства подключенного устройства. JSON обновляется так же, как и при частичном обновлении требуемых свойств в серверной части.
3. **Отслеживать требуемые свойства**. Для подключенного устройства можно настроить немедленное получение уведомлений об обновлениях нужного свойства в момент такого обновления. Устройство выполняет такое же обновление (частичное обновление или полная замена), как и при выполнении в серверной части.

Указанные выше операции требуют разрешения **DeviceConnect**, как указано в статье о [безопасности][lnk-security].

[Пакеты SDK для устройств Azure IoT][lnk-sdks] упрощают использование указанных выше операций на многих языках и платформах. Дополнительные сведения о примитивах Центра Интернета вещей для синхронизации требуемых свойств см. в разделе [Процедура при повторном подключении устройства][lnk-reconnection].

> [!NOTE]
> На данный момент доступ к двойникам устройств можно получить только на устройствах, подключающихся к Центру Интернета вещей по протоколу MQTT.
> 
> 

## <a name="reference"></a>Справочные материалы
### <a name="tags-and-properties-format"></a>Формат тегов и свойств
Теги, а также требуемые и сообщаемые свойства являются объектами JSON, на которые накладываются следующие ограничения:

* Все ключи в объектах JSON являются строками Юникода из 128 знаков с учетом регистра. Разрешено использовать все знаки, кроме управляющих символов Юникода (сегменты C0 и C1), а также `'.'`, `' '` и `'$'`.
* Все значения в объекте JSON могут быть следующих типов JSON: логический, число, строка и объект. Запрещено использовать массивы.

### <a name="twin-size"></a>Размер двойника
Центр Интернета вещей ограничивает размер значений `tags`, `properties/desired` и `properties/reported` до 8 КБ. Это ограничение не относится к элементам только для чтения.
Размер вычисляется путем подсчета всех знаков, кроме управляющих символов Юникода (сегменты C0 и C1) и пространства со знаком `' '`, если оно находится вне строковой константы.
Центр Интернета вещей отклонит с ошибкой все операции, увеличивающие размер этих документов сверх ограничения.

### <a name="twin-metadata"></a>Метаданные двойника
Центр Интернета вещей сохраняет метку времени последнего обновления для каждого объекта JSON в требуемых и сообщаемых свойствах. Метки времени указываются в формате UTC и кодируются в формате [ISO8601](`YYYY-MM-DDTHH:MM:SS.mmmZ`).
Например:

        {
            ...
            "properties": {
                "desired": {
                    "telemetryConfig": {
                        "sendFrequency": "5m"
                    },
                    "$metadata": {
                        "telemetryConfig": {
                            "sendFrequency": {
                                "$lastUpdated": "2016-03-30T16:24:48.789Z"
                            },
                            "$lastUpdated": "2016-03-30T16:24:48.789Z"
                        },
                        "$lastUpdated": "2016-03-30T16:24:48.789Z"
                    },
                    "$version": 23
                },
                "reported": {
                    "telemetryConfig": {
                        "sendFrequency": "5m",
                        "status": "success"
                    }
                    "batteryLevel": "55%",
                    "$metadata": {
                        "telemetryConfig": {
                            "sendFrequency": "5m",
                            "status": {
                                "$lastUpdated": "2016-03-31T16:35:48.789Z"
                            },
                            "$lastUpdated": "2016-03-31T16:35:48.789Z"
                        }
                        "batteryLevel": {
                            "$lastUpdated": "2016-04-01T16:35:48.789Z"
                        },
                        "$lastUpdated": "2016-04-01T16:24:48.789Z"
                    },
                    "$version": 123
                }
            }
            ...
        }

Эти сведения хранятся на каждом уровне (а не только в конечных элементах структуры JSON) для сохранения обновлений, удаляющих ключи объекта.

### <a name="optimistic-concurrency"></a>Оптимистичный параллелизм
Теги, а также требуемые и сообщаемые свойства поддерживают оптимистичный параллелизм.
Теги содержат ETag (согласно [RFC7232]), являющийся представлением JSON тега. Его можно использовать в операциях условного обновления в серверной части, чтобы обеспечить согласованность.

В требуемых и сообщаемых свойствах отсутствует ETag, но они содержат значение `$version`, которое гарантированно будет добавочным. Аналогично ETag для обеспечения согласованности обновлений компонент, выполняющий обновление (например, приложение устройства для сообщаемого свойства или серверная сторона для требуемого свойства), использует версию.

Версии также полезны, если агент, выполняющий отслеживание (например, приложение устройства, отслеживающее требуемые свойства), должен устранить состояние гонки между результатом извлечения и отправкой уведомлений об обновлении. Дополнительные сведения см. в разделе [Процедура при повторном подключении устройства][lnk-reconnection].

### <a name="device-reconnection-flow"></a>Процедура при повторном подключении устройства
Центр Интернета вещей не сохраняет уведомления об обновлении требуемых свойств для отключенных устройств. Это значит, что подключающееся устройство должно получить весь документ требуемых свойств и подписаться на уведомления об обновлениях. Учитывая возможность возникновения состояния гонки между уведомлениями об обновлениях и полным извлечением, следуйте процедуре ниже:

1. Приложение устройства подключается к Центру Интернета вещей.
2. Приложение устройства подписывается на уведомления об обновлениях требуемых свойств.
3. Приложение устройства получает весь документ требуемых свойств.

Приложение устройства может игнорировать все уведомления со значением `$version`, которое меньше значения версии полного полученного документа или равно ему. Это возможно, так как Центр Интернета вещей гарантирует постоянное увеличение версий.

> [!NOTE]
> Эта логика уже реализована в [пакетах SDK для устройств Azure IoT][lnk-sdks]. Это описание полезно, только если приложение устройства не может использовать пакеты SDK для устройств Azure IoT и должно программировать интерфейс MQTT напрямую.
> 
> 

### <a name="additional-reference-material"></a>Дополнительные справочные материалы
Другие справочные статьи в руководстве для разработчиков:

* Статья [Конечные точки Центра Интернета вещей][lnk-endpoints] содержит информацию о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Throttling and quotas][lnk-quotas] (Регулирование и квоты) содержит информацию о квотах, применимых к службе Центра Интернета вещей, и ожидаемом поведении регулирования при использовании службы.
* В статье [Пакеты SDK для устройств и служб Центра Интернета вещей][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Язык запросов для двойников, методов и заданий][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках, методах и заданиях устройств из Центра Интернета вещей.
* Статья [Поддержка MQTT в Центре Интернета вещей][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия
Теперь, когда вы узнали о двойниках устройств, вас могут заинтересовать следующие статьи руководства для разработчиков:

* [Вызов прямого метода на устройстве][lnk-methods]
* [Планирование заданий на нескольких устройствах][lnk-jobs]

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующие руководства по Центру Интернета вещей:

* [How to use the device twin][lnk-twin-tutorial] (Использование двойников устройств)
* [How to use twin properties][lnk-twin-properties] (Использование свойств двойников)

<!-- links and images -->

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-jobs]: iot-hub-devguide-jobs.md
[lnk-identity]: iot-hub-devguide-identity-registry.md
[lnk-d2c]: iot-hub-devguide-messaging.md#device-to-cloud-messages
[lnk-methods]: iot-hub-devguide-direct-methods.md
[lnk-security]: iot-hub-devguide-security.md

[ISO8601]: https://en.wikipedia.org/wiki/ISO_8601
[RFC7232]: https://tools.ietf.org/html/rfc7232
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md

[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-twin-tutorial]: iot-hub-node-node-twin-getstarted.md
[lnk-twin-properties]: iot-hub-node-node-twin-how-to-configure.md
[lnk-twin-metadata]: iot-hub-devguide-device-twins.md#twin-metadata
[lnk-concurrency]: iot-hub-devguide-device-twins.md#optimistic-concurrency
[lnk-reconnection]: iot-hub-devguide-device-twins.md#device-reconnection-flow

[img-twin]: media/iot-hub-devguide-device-twins/twin.png


<!--HONumber=Oct16_HO2-->


