<properties
	pageTitle="Обработка сообщений, отправляемых с устройства в облако, в центре IoT | Microsoft Azure"
	description="Этот учебник поможет изучить полезные шаблоны обработки сообщений, отправляемых с устройства в облако, в центре IoT"
	services="iot-hub"
	documentationCenter=".net"
	authors="dominicbetts"
	manager="timlt"
	editor=""/>

<tags
     ms.service="iot-hub"
     ms.devlang="csharp"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="04/29/2016"
     ms.author="dobett"/>

# Учебник: как обрабатывать сообщения, отправляемые с устройства в облако, с помощью центра IoT

## Введение

Центр IoT Azure — полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств IoT и серверной частью приложения. В других учебниках ([Приступая к работе с центром IoT] и [Отправка сообщений с облака на устройства в центре IoT]) описаны базовые функции центра IoT по отправке сообщений с устройства в облако и с облака на устройство.

Этот учебник основан на коде, показанном в учебнике [Приступая к работе с центром IoT]. В нем демонстрируется два масштабируемых шаблона, которые можно использовать для обработки сообщений, отправляемых с устройства в облако:

- Надежное хранилище сообщений, отправляемых с устройства в облако, в [хранилище BLOB-объектов Azure]. Очень распространенный сценарий, подразумевающий реализацию "*холодного*" анализа, где телеметрические данные хранятся в больших двоичных объектах, которые используются в качестве входных данных для процедур анализа. Эти процедуры могут управляться такими инструментами, как [фабрика данных Azure] или стек [HDInsight (Hadoop)].

- Надежная обработка *интерактивных* сообщений, отправляемых с устройства в облако. Сообщения, отправляемые с устройства в облако, являются интерактивными, если они немедленно инициируют набор действий в серверной части приложения. Например, устройство может отправить аварийный сигнал, который активирует вставку билета в системе CRM. В отличие от сообщений *точек данных*, которые просто поступают в модуль аналитики. Например, телеметрическое сообщение о температуре с устройства, которое должно быть сохранено для последующего анализа, является сообщением точки данных.

Так как для получения сообщений, отправляемых с устройства в облако, центр IoT предоставляет конечную точку, совместимую с [концентраторами событий][lnk-event-hubs], в этом учебнике используется экземпляр класса [EventProcessorHost]. Этот экземпляр:

* надежно хранит сообщения *точек данных* в хранилище BLOB-объектов Azure;
* перенаправляет *интерактивные* сообщения, отправляемые с устройства в облако, в [очередь служебной шины Azure] для немедленной обработки.

Служебная шина помогает обеспечить надежную обработку интерактивных сообщений, так как она обеспечивает контрольные точки для каждого сообщения и дедупликацию на основе временных интервалов.

> [AZURE.NOTE] Экземпляр **EventProcessorHost** — только один из способов обработки интерактивных сообщений. Другие варианты включают в себя [Azure Service Fabric][lnk-service-fabric] и [Azure Stream Analytics][lnk-stream-analytics].

В конце этого учебника у вас будет три консольных приложения Windows:

* **SimulatedDevice**, измененная версия приложения, созданного в учебнике [Приступая к работе с центром IoT]. Приложение отправляет сообщения точек данных с устройства в облако один раз в секунду и интерактивные сообщения с устройства в облако каждые 10 секунд. Это приложение использует протокол AMQPS для обмена данными с центром IoT.
* **ProcessDeviceToCloudMessages** использует класс [EventProcessorHost] для получения сообщений от конечной точки, совместимой с концентратором событий. Затем приложение надежно сохраняет сообщения точек данных в большом двоичном объекте Azure и перенаправляет интерактивные сообщения в очередь служебной шины.
* **ProcessD2CInteractiveMessages** удаляет интерактивные сообщения из очереди служебной шины.

> [AZURE.NOTE] Для центра IoT существуют пакеты SDK для многих платформ устройств и языков (включая C, Java и JavaScript). Пошаговые указания по замене виртуального устройства в этом учебнике физическим устройством, а также по подключению устройств к центру IoT Azure в целом см. в [Центре разработчиков для Azure IoT].

Содержимое данного учебника можно применить к другим способам использования сообщений, совместимых с концентраторами событий, например в проектах [HDInsight (Hadoop)]. Дополнительные сведения см. в [руководстве разработчика по центру Azure IoT — в разделе "Отправка сообщений с устройства в облако"].

Для работы с этим учебником требуется:

+ Microsoft Visual Studio 2015.

+ Активная учетная запись Azure. <br/>Если у вас нет подписки Azure, всего за несколько минут можно создать [бесплатную учетную запись](https://azure.microsoft.com/free/).

Кроме того, у вас должны быть базовые знания о [службе хранилища Azure] и [служебной шине Azure].


[AZURE.INCLUDE [iot-hub-process-d2c-device-csharp](../../includes/iot-hub-process-d2c-device-csharp.md)]


[AZURE.INCLUDE [iot-hub-process-d2c-cloud-csharp](../../includes/iot-hub-process-d2c-cloud-csharp.md)]

## Запуск приложений

Теперь все готово к запуску приложений.

1.	В обозревателе решений Visual Studio щелкните правой кнопкой мыши решение и выберите пункт **Назначить запускаемые проекты**. Выберите **Несколько запускаемых проектов**, а затем действие **Запуск** для проектов **ProcessDeviceToCloudMessages**, **SimulatedDevice** и **ProcessD2CInteractiveMessages**.

2.	Нажмите клавишу **F5** для запуска трех консольных приложений. Приложение **ProcessD2CInteractiveMessages** должно обработать каждое интерактивное сообщение, отправленное из приложения **SimulatedDevice**.

  ![Три консольных приложения][50]

> [AZURE.NOTE] Чтобы увидеть обновления в файле больших двоичных объектов, может потребоваться уменьшить значение константы **MAX\_BLOCK\_SIZE** в классе **StoreEventProcessor** (например, до **1024**). Причина в том, что на достижение предельного размера блока с данными, отправляемыми виртуальным устройством, уходит некоторое время. Если указать меньший размер блока, создание и обновление большого двоичного объекта выполняется быстрее. Тем не менее, наличие блоков большего размера делает приложение более масштабируемым.

## Дальнейшие действия

В этом учебнике мы рассмотрели надежную обработку сообщений точек данных и интерактивных сообщений, отправляемых с устройства в облако, с помощью класса [EventProcessorHost].

Учебник [Как передать файлы из устройств в облако с помощью центра IoT] основан на этом учебнике: в нем используется аналогичная логика обработки сообщений. В нем также описывается шаблон, использующий сообщения, отправляемые с облака на устройство, для упрощения отправки файлов с устройств.

Дополнительная информация о центре IoT приведена в следующих статьях:

* [Обзор центра IoT]
* [Руководство разработчика по центру IoT]
* [Руководство по центру IoT]
* [Поддерживаемые платформы устройств и языки][Supported devices]
* [Центр разработчика IoT Azure]

<!-- Images. -->
[50]: ./media/iot-hub-csharp-csharp-process-d2c/run1.png


<!-- Links -->

[хранилище BLOB-объектов Azure]: ../storage/storage-dotnet-how-to-use-blobs.md
[фабрика данных Azure]: https://azure.microsoft.com/documentation/services/data-factory/
[HDInsight (Hadoop)]: https://azure.microsoft.com/documentation/services/hdinsight/
[Service Bus Queue]: ../service-bus/service-bus-dotnet-how-to-use-queues/
[EventProcessorHost]: http://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.eventprocessorhost(v=azure.95).aspx



[руководстве разработчика по центру Azure IoT — в разделе "Отправка сообщений с устройства в облако"]: iot-hub-devguide.md#d2c

[службе хранилища Azure]: https://azure.microsoft.com/documentation/services/storage/
[служебной шине Azure]: https://azure.microsoft.com/documentation/services/service-bus/



[Отправка сообщений с облака на устройства в центре IoT]: iot-hub-csharp-csharp-c2d.md
[Как передать файлы из устройств в облако с помощью центра IoT]: iot-hub-csharp-csharp-file-upload.md

[Обзор центра IoT]: iot-hub-what-is-iot-hub.md
[Руководство по центру IoT]: iot-hub-guidance.md
[Руководство разработчика по центру IoT]: iot-hub-devguide.md
[Приступая к работе с центром IoT]: iot-hub-csharp-csharp-getstarted.md
[Supported devices]: iot-hub-tested-configurations.md
[Центр разработчика IoT Azure]: https://azure.microsoft.com/develop/iot
[Центре разработчиков для Azure IoT]: https://azure.microsoft.com/develop/iot
[lnk-service-fabric]: https://azure.microsoft.com/documentation/services/service-fabric/
[lnk-stream-analytics]: https://azure.microsoft.com/documentation/services/stream-analytics/
[lnk-event-hubs]: https://azure.microsoft.com/documentation/services/event-hubs/

<!---HONumber=AcomDC_0601_2016-->