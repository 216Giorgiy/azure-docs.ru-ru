<properties
	pageTitle="Обработка сообщений, отправляемых с устройства в облако, в центре IoT | Microsoft Azure"
	description="Этот учебник поможет изучить полезные шаблоны обработки сообщений, отправляемых с устройства в облако, в центре IoT"
	services="iot-hub"
	documentationCenter=".net"
	authors="fsautomata"
	manager="timlt"
	editor=""/>

<tags
     ms.service="iot-hub"
     ms.devlang="csharp"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="09/29/2015"
     ms.author="elioda"/>

# Учебник: как обрабатывать сообщения, отправляемые с устройства в облако, с помощью центра IoT

## Введение

Центр IoT Azure — полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств IoT и серверной частью приложения. В предыдущих учебниках ([Приступая к работе с центром IoT] и [Отправка сообщений с облака на устройства в центре IoT]) описаны базовые функции центра IoT по отправке сообщений с устройства в облако и с облака на устройство, а также описан доступ к этим сообщениям из устройств и облачных компонентов.

Этот учебник основан на коде, который содержится в учебнике [Приступая к работе с центром IoT]. Он представляет два шаблона обработки сообщений, отправляемых с устройства в облако.

Первый шаблон представляет собой надежное хранилище сообщений, отправляемых с устройства в облако, в [больших двоичных объектах Azure]. Этот сценарий очень часто используется при реализации *холодного* анализа, при котором данные, размещенные в больших двоичных объектах, используются в качестве входных данных для анализа с помощью таких средств, как [фабрика данных Azure] или стек [Hadoop].

Второй шаблон реализует надежную обработку *интерактивных* сообщений, отправляемых из устройства в облако. Сообщения, отправляемые из устройства в облако, называются *интерактивными*, если они немедленно инициируют набор событий в серверной части приложения, в отличие от сообщений *точек данных*, которые поступают в модуль аналитики. Например, аварийный сигнал, поступающий от устройства, который должен активировать вставку билета в системе CRM, является *интерактивным* сообщением, отправляемым из устройства в облако, а сообщение телеметрии, содержащее результаты измерения температуры, является сообщением *точки данных*.

Так как для получения сообщений, отправляемых с устройства в облако, центр IoT предоставляет конечную точку, совместимую с концентраторами событий, в этом учебнике используется [EventProcessorHost] для размещения класса обработчика событий, который:

* надежно хранит сообщения *точек данных* в больших двоичных объектах Azure; и
* направляет *интерактивные* сообщения, отправляемые из устройства в облако, в [очередь служебной шины] для немедленной обработки.

С помощью [служебной шины][Service Bus Queue] очень удобно гарантировать надежную обработку интерактивных сообщений, так как она обеспечивает контрольные точки для каждого сообщения и дедупликацию на основе временных окон.

В конце этого учебника у вас будет три консольных приложения Windows:

* **SimulatedDevice**, измененная версия приложения, созданного в учебнике [Приступая к работе с центром IoT]. Оно отправляет сообщения *точек данных* из устройства в облако один раз в секунду и *интерактивные* сообщения из устройства в облако каждые 10 секунд.
* **ProcessDeviceToCloudMessages**, которое использует [EventProcessorHost] для надежного хранения сообщения *точек данных* в большом двоичном объекте Azure и направляет *интерактивные* сообщения в очередь служебной шины.
* **ProcessD2cInteractiveMessages**, которое удаляет сообщения из очереди.

> [AZURE.NOTE]Для центра IoT существуют пакеты SDK для многих платформ устройств и языков (включая C, Java и Javascript). Эти пакеты работают на основе пакетов SDK для устройств IoT Azure. Пошаговые указания по подключению устройства к коду этого учебника и к центру IoT Azure в целом см. в [Центре разработчика IoT в Azure].

> [AZURE.NOTE]Содержимое данного руководства можно применить к другим способам использования сообщений, совместимых с концентраторами событий, например в проектах [Hadoop], таких как Storm. Для получения дополнительных сведений обратитесь к документу [Руководство по центру IoT. Совместимость с концентраторами событий].

Чтобы пройти этот учебник, требуется:

+ Microsoft Visual Studio 2015;

+ Активная учетная запись Azure. <br/>Если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Подробные сведения см. на странице [Бесплатная пробная версия Azure](http://azure.microsoft.com/pricing/free-trial/?WT.mc_id=A0E0E5C02&amp;returnurl=http%3A%2F%2Fazure.microsoft.com%2Fru-RU%2Fdevelop%2Fiot%2Ftutorials%2Fprocess-d2c%2F target="\_blank").

Также предполагается, что у вас есть некоторые знания о [хранилище Azure] и [служебной шине Azure].


[AZURE.INCLUDE [iot-hub-process-d2c-device-csharp](../../includes/iot-hub-process-d2c-device-csharp.md)]


[AZURE.INCLUDE [iot-hub-process-d2c-cloud-csharp](../../includes/iot-hub-process-d2c-cloud-csharp.md)]

## Запуск приложений

Теперь все готово к запуску приложений.

1.	В Visual Studio щелкните правой кнопкой мыши на вашем решении и выберите **Настроить запускаемые при включении проекты**. Выберите **Несколько запускаемых проектов**, а затем выберите действие **Запуск** для приложений **ProcessDeviceToCloudMessages**, **SimulatedDevice** и **ProcessD2cInteractiveMessages**.

2.	Нажмите клавишу **F5**, и вы увидите, что все приложения запустятся. Каждое интерактивное сообщение, отправляемое виртуальным устройством, должно обрабатываться обработчиком интерактивных сообщений.

  ![][50]

> [AZURE.NOTE]Чтобы увидеть обновление файла большого двоичного объекта, может потребоваться изменить значение константы `MAX_BLOCK_SIZE` в `StoreEventProcessor` на меньшее (т. е. `1024`). Причина в том, что на достижение предельного размера блока с данными, отправляемыми виртуальным устройством, уходит некоторое время. Сделав это изменение, вы должны увидеть создание и обновление большого двоичного объекта в контейнере хранилища.

## Дальнейшие действия

В этом учебнике вы научились надежно обрабатывать сообщения *точек данных* и *интерактивные* сообщения, отправляемые из устройства в облако, с помощью [EventProcessorHost]. Аналогичную логику обработки сообщений можно реализовать с помощью учебника

- [Передача файлов из устройств] — в нем описан шаблон использования сообщений, отправляемых с облака в устройства, для упрощения передачи файлов с устройств.

Дополнительная информация о центре IoT приведена в следующих статьях:

* [Обзор центра IoT]
* [Руководство разработчика по центру IoT]
* [Руководство по центру IoT]
* [Поддерживаемые платформы устройств и языки][Supported devices]
* [Центр разработчика IoT Azure]

<!-- Images. -->
[50]: ./media/iot-hub-csharp-csharp-process-d2c/run1.png


<!-- Links -->

[больших двоичных объектах Azure]: https://azure.microsoft.com/ru-RU/documentation/articles/storage-dotnet-how-to-use-blobs/
[фабрика данных Azure]: https://azure.microsoft.com/ru-RU/documentation/services/data-factory/
[Hadoop]: https://azure.microsoft.com/ru-RU/documentation/services/hdinsight/
[Service Bus Queue]: https://azure.microsoft.com/ru-RU/documentation/articles/service-bus-dotnet-how-to-use-queues/
[очередь служебной шины]: https://azure.microsoft.com/ru-RU/documentation/articles/service-bus-dotnet-how-to-use-queues/
[EventProcessorHost]: http://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.eventprocessorhost(v=azure.95).aspx

[Transient Fault Handling]: https://msdn.microsoft.com/ru-RU/library/hh680901(v=pandp.50).aspx
[Обработка временного сбоя]: https://msdn.microsoft.com/ru-RU/library/hh680901(v=pandp.50).aspx

[Руководство по центру IoT. Совместимость с концентраторами событий]: iot-hub-guidance.md#eventhubcompatible

[хранилище Azure]: https://azure.microsoft.com/ru-RU/documentation/services/storage/
[служебной шине Azure]: https://azure.microsoft.com/ru-RU/documentation/services/service-bus/

[Azure preview portal]: https://portal.azure.com/

[Отправка сообщений с облака на устройства в центре IoT]: iot-hub-csharp-csharp-c2d.md
[Process Device-to-Cloud messages]: iot-hub-csharp-csharp-process-d2c.md
[Обработка сообщений, передаваемых с устройства в облако]: iot-hub-csharp-csharp-process-d2c.md
[Передача файлов из устройств]: iot-hub-csharp-csharp-file-upload.md

[Обзор центра IoT]: iot-hub-what-is-iot-hub.md
[Руководство по центру IoT]: iot-hub-guidance.md
[Руководство разработчика по центру IoT]: iot-hub-devguide.md
[IoT Hub Supported Devices]: iot-hub-supported-devices.md
[Приступая к работе с центром IoT]: iot-hub-csharp-csharp-getstarted.md
[Supported devices]: https://github.com/Azure/azure-iot-sdks/blob/master/doc/tested_configurations.md
[Центр разработчика IoT Azure]: http://www.azure.com/develop/iot
[Центре разработчика IoT в Azure]: http://www.azure.com/develop/iot

<!----HONumber=Nov15_HO3-->