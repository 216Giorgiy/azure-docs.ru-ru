<properties
 pageTitle="Разделы руководства разработчика для центра IoT | Microsoft Azure"
 description="Руководство разработчика для центра IoT Azure, содержащее информацию о конечных точках центра IoT, его безопасности, реестре удостоверений устройств и обмене сообщениями."
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="multiple"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="09/29/2015"
 ms.author="elioda"/>

# Руководство разработчика по центру Azure IoT (IoT — Интернет вещей)

Центр IoT Azure — полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств IoT и серверной частью приложения.

Центр Azure IoT обеспечивает:

* безопасную связь — используются учетные данные безопасности, уникальные для каждого устройства, и контроль доступа;
* глобальный надежный обмен сообщениями между облаком и устройством в обоих направлениях;
* простое подключение устройств, так как используются библиотеки устройств для большинства популярных языков и платформ.

В этом документе приведена информация по таким темам.

- [Конечные точки](#endpoints). Раздел содержит информацию о конечных точках, которые каждый центр IoT предоставляет для операций управления и среды выполнения.
- [Реестр удостоверений устройств](#device-identity-registry). Раздел содержит сведения о том, какая информация хранится в реестре удостоверений каждого устройства центра IoT и как эту информацию можно использовать и изменять.
- [Безопасность](#security). Раздел содержит информацию о модели безопасности, используемой для устройств и облачных компонентов, которые обеспечивают доступ к функциям центра IoT.
- [Обмен сообщениями](#messaging). Раздел содержит информацию о функциях обмена сообщениями (между устройством и облаком в обоих направлениях), которые предоставляет центр IoT.
- [Квоты и регулирование](#throttling). Раздел содержит информацию о том, какие квоты применяются при использовании центра IoT.

## Конечные точки <a id="endpoints"></a>

Центр IoT Azure — это служба с несколькими клиентами. Она предоставляет возможность пользоваться своими функциями разным субъектам. На схеме ниже показаны разные конечные точки, которые предоставляет центр IoT.

![Конечные точки центра IoT][img-endpoints]

Ниже приведено описание конечных точек.

* **Поставщик ресурсов** центра IoT предоставляет интерфейс [диспетчера ресурсов Azure][lnk-arm], который позволяет владельцам подписки Azure создавать и удалять центры IoT, а также обновлять их свойства. Свойства центра IoT управляют политиками безопасности на уровне центра (в отличие от контроля доступа на уровне устройства; см. раздел [Контроль доступа](#accesscontrol)) и рабочими параметрами двустороннего обмена сообщениями между облаком и устройством. Поставщик ресурсов также позволяет [экспортировать удостоверения устройств](#importexport).
* **Управление удостоверениями устройств**. Каждый центр IoT предоставляет набор конечных точек HTTP REST, которые позволяют управлять удостоверениями устройств (создавать, получать, обновлять и удалять их). Удостоверения устройств нужны для аутентификации устройств и контроля доступа к ним. Дополнительные сведения см. в разделе [Реестр удостоверений устройств](#device-identity-registry).
* **Конечные точки устройств**. Для каждого устройства, подготовленного в реестре удостоверений устройств, центр IoT предоставляет набор конечных точек, которые используются для двустороннего обмена сообщениями с участием этого устройства. Эти конечные точки сейчас предоставляются в протоколах HTTP и [AMQP][lnk-amqp]\:
    - *Отправка сообщений с устройства в облако*. Эта конечная точка используется для отправки сообщений с устройства в облако. Дополнительные сведения см. в разделе [Отправка сообщений с устройства в облако](#d2c).
    - *Получение сообщений из облака на устройство*. Эта конечная точка используется устройством для получения целевых сообщений из облака. Дополнительные сведения см. в разделе [Отправка сообщений из облака на устройство](#c2d).
* **Конечные точки службы**. Каждый центр IoT также предоставляет набор конечных точек, используемых в серверной части приложения (*службе*) для взаимодействия с устройствами. Эти конечные точки в настоящее время доступны только при использовании протокола [AMQP][lnk-amqp].
    - *Получение сообщений с устройства в облако*. Эта конечная точка совместима с [концентраторами событий Azure][lnk-event-hubs]. С ее помощью можно читать все сообщения, которые ваши устройства отправляют в облако. Дополнительные сведения см. в разделе [Отправка сообщений с устройства в облако](#d2c).
    - *Отправка сообщений из облака на устройство и получение уведомлений о доставке*. Эти конечные точки позволяют серверной части приложения отправлять надежные сообщения из облака на устройство и получать уведомления о доставке или истечении срока действия. Дополнительные сведения см. в разделе [Отправка сообщений из облака на устройство](#c2d).

Статья [Интерфейсы API и пакеты SDK центра IoT][lnk-apis-sdks] описывает способы получения доступа к этим конечным точкам.

Наконец, следует отметить, что все конечные точки центра IoT предоставляются по протоколу [TLS][lnk-tls]. Кроме того, конечные точки не предоставляются по незашифрованным и незащищенным каналам.

### Чтение из конечных точек, совместимых с концентраторами событий <a id="eventhubcompatible"></a>

При использовании [пакета SDK служебной шины Azure для .NET](https://www.nuget.org/packages/WindowsAzure.ServiceBus) или [концентраторов событий и узла обработчика событий][] вы можете использовать любые строки подключения к центру IoT с нужными разрешениями, а затем использовать `messages/events` в качестве имени концентратора событий.

При использовании пакетов SDK (или интеграций продуктов), которые не поддерживают центр IoT, следует получить конечную точку, совместимую с концентраторами событий, и имя концентратора событий в разделе параметров центра IoT на [портале предварительной версии Azure][]\:

1. В выноске концентратора IoT щелкните элемент **Параметры**, а затем выберите пункт **Обмен сообщениями**.
2. В разделе **Параметры отправки сообщений с устройства в облако** вы увидите поля **Конечная точка, совместимая с концентраторами событий**, **Имя, совместимое с концентраторами событий** и **Разделы**.

    ![][img-eventhubcompatible]

> [AZURE.NOTE]Иногда для пакета SDK требуется указать значение **Имя узла** или **Пространство имен**. В этом случае удалите схему из поля **Конечная точка, совместимая с концентраторами событий**. Например, если конечная точка, совместимая с концентраторами событий, — это `sb://iothub-ns-myiothub-1234.servicebus.windows.net/`, **именем узла** будет `iothub-ns-myiothub-1234.servicebus.windows.net`, а **пространством имен** — `iothub-ns-myiothub-1234`.

Затем можно использовать любую политику безопасности общего доступа, с разрешениями **ServiceConnect**, которые позволяют выполнять подключение к указанному концентратору событий.

Если нужно создать строку подключения к концентратору событий с помощью указанной выше информации, вы можете использовать такой образец:

        Endpoint={Event Hub-compatible endpoint};SharedAccessKeyName={iot hub policy name};SharedAccessKey={iot hub policy key}


Далее приведен список пакетов SDK и интеграций, которые можно использовать с центром IoT:

* [клиент концентраторов событий Java](https://github.com/hdinsight/eventhubs-client);
* [воронка Apache Storm](../hdinsight/hdinsight-storm-develop-csharp-event-hub-topology.md), ссылка на которую доступна [здесь](https://github.com/apache/storm/tree/master/external/storm-eventhubs);
* [интеграция Apache Spark](../hdinsight/hdinsight-apache-spark-csharp-apache-zeppelin-eventhub-streaming.md).

## Реестр удостоверений устройств

В каждом центре IoT есть реестр удостоверений устройств, который используется для создания в службе ресурсов, уникальных для отдельного устройства (например, очередь с сообщениями, отправленными из облака на устройство), и который обеспечивает доступ к конечным точкам, обращенным к устройствам (см. раздел [Контроль доступа](#accesscontrol)).

На высоком уровне реестр удостоверений устройств является коллекцией с поддержкой REST, состоящей из ресурсов удостоверений устройств. Следующие разделы содержат подробную информацию о свойствах ресурсов удостоверений устройств, а также об операциях, которые реестр позволяет выполнять с удостоверениями.

> [AZURE.NOTE]Дополнительные сведения о протоколе HTTP и пакетах SDK, которые могут взаимодействовать с реестром удостоверений устройств, см. в статье [Интерфейсы API и пакеты SDK центра IoT][lnk-apis-sdks].

### Свойства удостоверений устройств <a id="deviceproperties"></a>

Удостоверения устройств отображаются как JSON-документы с нижеуказанными свойствами.

| Свойство | Параметры | Описание |
| -------- | ------- | ----------- |
| deviceId | Обязательно, при обновлениях доступно только для чтения | Строка с учетом регистра (длиной до 128 символов), состоящая из букв и цифр в 7-битовом формате ASCII + `{'-', ':', '.', '+', '&percnt;', '_', '&num;', '&ast;', '?', '!', '(', ')', ',', '=', '&commat;', ';', '&dollar;', '''}`. |
| generationId | Обязательно, только для чтения | Созданная концентратором строка с учетом регистра (длиной до 128 символов). Позволяет различать устройства с одинаковым свойством **deviceId**, которые были удалены, а затем созданы повторно. |
| etag | Обязательно, только для чтения | Строка, выполняющая функцию ненадежного заголовка ETag для удостоверения устройства (согласно [RFC7232][lnk-rfc7232]).|
| auth | необязательный | Составной объект, содержащий сведения об аутентификации и материалы безопасности. |
| auth.symkey | необязательный | Составной объект, содержащий первичный и вторичный ключи, хранящиеся в формате base64. |
| status | обязательно | Может иметь значение **Включено** или **Отключено**. Если указано значение **Включено**, устройство может подключаться. Если указано значение **Отключено**, устройство не может подключаться ни к одной конечной точке, обращенной к устройству. |
| statusReason | необязательный | 128-символьная строка, указывающая причину, по которой выбран тот или иной статус удостоверения устройства. Разрешены все символы UTF-8. |
| statusUpdateTime | Только для чтения | Дата и время последнего обновления статуса. |
| connectionState | Только для чтения | Значения **Подключено** или **Отключено** отображают статус подключения устройства для центра IoT. |
| connectionStateUpdatedTime | Только для чтения | Дата и время последнего обновления состояния подключения. |
| lastActivityTime | Только для чтения | Дата и время последнего подключения устройства, получения сообщения на устройство и отправки сообщения с него. |

> [AZURE.NOTE]Статус подключения отображает статус подключения для центра IoT. При некоторых состояниях и конфигурациях сети этот статус может быть задержан.

### Операции с удостоверениями устройства

Реестр удостоверений устройств центра IoT поддерживает такие операции:

* создание удостоверения устройства;
* обновление удостоверения устройства;
* получение удостоверения устройства по идентификатору;
* удаление удостоверения устройства;
* отображение списка, содержащего до 1000 удостоверений.

Все эти операции позволяют использовать оптимистический параллелизм (согласно [RFC7232][lnk-rfc7232]).

> [AZURE.IMPORTANT]Единственный способ получить все удостоверения, которые содержит реестр удостоверений концентратора, — использовать функцию [Экспорт](#importexport).

Реестр удостоверений устройств в концентраторе не содержит метаданные приложений, к нему можно получить доступ как к словарю (используя в качестве ключа свойство **deviceId**), также он не поддерживает выразительные запросы. Любое решение IoT включает собственное хранилище, содержащее метаданные приложений (например, данные о комнате, в которой установлен датчик температуры, в решении интеллектуального здания).

### Отключение устройств

Чтобы отключить устройства, обновите в реестре свойство **status** удостоверения. Обычно отключение используется в двух сценариях.

1. В процессе оркестрации подготовки. Дополнительные сведения см. в руководстве [Центр IoT Azure — подготовка][lnk-guidance-provisioning].
2. Если по какой-либо причине вы решите, что безопасность устройства нарушена или оно является временно неавторизованным.

### Экспорт удостоверений устройства <a id="importexport"></a>

Экспорт — это долгосрочная задача, использующая предоставленный клиентом контейнер больших двоичных объектов, необходимых для чтения и записи данных удостоверений устройства.

Вы можете выполнить массовый экспорт удостоверений устройств из реестра удостоверений центра IoT, используя асинхронные операции в конечной точке поставщика ресурсов центра IoT (см. раздел [Конечные точки](#endpoints)).

Операции, которые можно выполнять с заданиями экспорта:

* создание задания экспорта;
* получение статуса выполняющегося задания;
* отмена выполняющегося задания.

> [AZURE.NOTE]В любой момент времени на концентраторе может быть запущена только одна задача.

Подробные сведения об API-интерфейсах импорта и экспорта см. в статье [Центр IoT Azure — интерфейсы API поставщика ресурсов][lnk-resource-provider-apis].

#### Задания

Все задания экспорта имеют нижеуказанные свойства.

| Свойство | Параметры | Описание |
| -------- | ------- | ----------- |
| jobId | Формируется системой, игнорируется при создании | |
| creationTime | Формируется системой, игнорируется при создании | |
| endOfProcessingTime | Формируется системой, игнорируется при создании | |
| type | Только для чтения | **экспорт.** |
| status | Формируется системой, игнорируется при создании | **В очереди**, **Запущено**, **Завершено**, **Сбой**. |
| ход выполнения | Формируется системой, игнорируется при создании | Целое значение, обозначающее процент выполнения. |
| outputBlobContainerURI | Обязательно для всех заданий | Универсальный код ресурса (URI) подписанного URL-адреса большого двоичного объекта с доступом на запись к контейнеру BLOB-объектов (см. статьи [Создание и использование подписи общего доступа с помощью службы BLOB-объектов][lnk-createuse-sas] и [Создание подписанного URL-адреса в Java][lnk-sas-java]). Используется для вывода статуса задания и результатов. |
| includeKeysInExport | необязательный | Если задано значение **true**, ключи включены в выходные данные экспорта. В противном случае экспортируются ключи со значением **null**. Значение по умолчанию — **false**. |
| failureReason | Формируется системой, игнорируется при создании | Если для статуса отображается значение **Failed**, эта строка содержит причину. |

#### Задания экспорта

В качестве параметра заданий экспорта указан универсальный код ресурса (URI) подписанного URL-адреса большого двоичного объекта. Этот параметр предоставляет доступ на запись к контейнеру больших двоичных объектов и используется для вывода результата операции.

Выходные данные записываются в указанный контейнер больших двоичных объектов в файле с именем `job_{job_id}_devices.txt`. Этот файл содержит удостоверения устройств, сериализованные в формате JSON (как указано в разделе [Свойства удостоверений устройств](#deviceproperties)). Для материалов безопасности устанавливается значение **null**, если для параметра **includeKeysInExport** задано значение **false**.

**Пример**:

    {"deviceId":"devA","auth":{"symKey":{"primaryKey":"123"}},"status":"enabled"}
    {"deviceId":"devB","auth":{"symKey":{"primaryKey":"234"}},"status":"enabled"}
    {"deviceId":"devC","auth":{"symKey":{"primaryKey":"345"}},"status":"enabled"}
    {"deviceId":"devD","auth":{"symKey":{"primaryKey":"456"}},"status":"enabled"}


## Безопасность <a id="security"></a>

В этом разделе описаны возможности защиты центра Azure IoT.

### Контроль доступа <a id="accesscontrol"></a>

Центр IoT использует следующий набор *разрешений*, чтобы предоставить доступ к каждой из своих конечных точек. Разрешения ограничивают доступ к центру IoT на основе функций.

* **RegistryRead**. Это разрешение предоставляет доступ на чтение к реестру удостоверений устройств. Дополнительные сведения см. в разделе [Реестр удостоверений устройств](#device-identity-registry).
* **RegistryReadWrite**. Предоставляет доступ на чтение и запись к реестру удостоверений устройств. Дополнительные сведения см. в разделе [Реестр удостоверений устройств](#device-identity-registry).
* **ServiceConnect**. Предоставляет доступ к конечным точкам обмена данными и мониторинга, обращенным к облачной службе. Например, это разрешение позволяет облачным службам получать сообщения с устройств, отправлять сообщения на устройства и получать соответствующие уведомления о доставке.
* **DeviceConnect**. Предоставляет доступ к конечным точкам обмена данными, обращенным к устройству. Например, это разрешение позволяет отправлять сообщения с устройства в облако и получать сообщения, отправленные из облака на устройство. Это разрешение обычно используют устройства.

Разрешения предоставляются следующими способами.

* **Политики общего доступа на уровне концентратора**. *Политики общего доступа* могут предоставлять любое сочетание разрешений, из перечисленных в предыдущем разделе. Политики можно задавать на [портале управления Azure][lnk-management-portal] или программным путем, используя [API-интерфейсы поставщика ресурсов центра IoT Azure][lnk-resource-provider-apis]. По умолчанию для только что созданного центра IoT заданы такие политики:

    - *iothubowner*: политика со всеми разрешениями;
    - *service*: политика с разрешением **ServiceConnect**;
    - *device*: политика с разрешением **DeviceConnect**;
    - *registryRead*: политика с разрешением **RegistryRead**;
    - *registryReadWrite*: политика с разрешениями **RegistryRead** и **RegistryWrite**.

* **Учетные данные безопасности на уровне отдельного устройства**. Каждый центр IoT содержит [реестр удостоверений устройств](#device-identity-registry). Для каждого устройства в этом реестре вы можете задать учетные данные безопасности, дающие вам разрешения **DeviceConnect**, которые соответствуют конечным точкам устройств.

**Пример**. Решение IoT обычно содержит компонент управления устройствами, который использует политику *registryReadWrite*, а также компонент обработчика событий и компонент бизнес-логики устройства среды выполнения. Оба компонента используют политику *service*. Отдельные устройства подключаются с помощью учетных данных, которые хранятся в реестре удостоверений центра IoT.

Информацию по вопросам безопасности центра IoT см. в статье [Центр IoT Azure: руководство][lnk-guidance-security].

### Аутентификация

Центр Azure IoT предоставляет доступ к конечным точкам, проверяя маркер на соответствие политикам общего доступа и учетным данным безопасности в реестре удостоверений устройств.

Учетные данные безопасности, например симметричные ключи, никогда не отправляются по сети.

> [AZURE.NOTE]Безопасность для поставщика ресурсов центра IoT Azure обеспечивается с помощью подписки Azure (это касается всех поставщиков в [диспетчере ресурсов Azure][lnk-azure-resource-manager]).

#### Формат маркера безопасности <a id="tokenformat"></a>

Маркер безопасности имеет следующий формат:

	SharedAccessSignature sig={signature-string}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}

Это ожидаемые значения:

| Значение | Описание |
| ----- | ----------- |
| {signature} | Строка подписи HMAC-SHA256 в форме: `{URL-encoded-resourceURI} + "\n" + expiry` |
| {resourceURI} | Префикс URI (по сегменту) для конечных точек, доступ к которым можно получить с помощью этого маркера. Например, `/events` |
| {expiry} | Строки в формате UTF8, отображающие количество секунд с начала эры 00:00:00 (в формате UTC) 1 января 1970 г. |
| {URL-encoded-resourceURI} | Закодированный как URL-адрес URI ресурса (строчные символы) |
| {policyName} | Имя политики общего доступа, к которой относится этот маркер. Отсутствует, если маркеры относятся к учетным данным реестра устройства. |

**Обратите внимание**, что префикс универсального кода ресурса (URI) вычисляется по сегменту, а не по символу. Например, `/a/b` — это префикс для `/a/b/c`, а не для `/a/bc`.

#### Особенности протокола

Поддерживаемые протоколы (например, AMQP и HTTP) передают маркеры разными способами.

Аутентификация HTTP реализуется посредством включения допустимого маркера в заголовок запроса **Авторизация**. Маркер может передаваться и с помощью параметра запроса **Авторизация**.

При использовании [AMQP][lnk-amqp] центр IoT поддерживает механизм [SASL PLAIN][lnk-sasl-plain] и стандарт [защиты AMQP на основе утверждений][lnk-cbs].

Стандарт защиты AMQP на основе утверждений определяет, как следует передавать эти маркеры.

Для SASL PLAIN **имя пользователя** может быть следующим:

* `{policyName}&commat;sas.root.{iothubName}` — если маркеры являются маркерами уровня концентратора;
* `{deviceId}` — если маркеры являются маркерами уровня устройства.

В обоих случаях поле пароля содержит маркер, как описано в разделе [Формат маркера](#tokenformat).

> [AZURE.NOTE] [Пакеты SDK центра IoT Azure][lnk-apis-sdks] автоматически создают маркеры при подключении к службе. В некоторых случаях пакеты SDK работают не со всеми протоколами и для них доступны не все способы аутентификации. Дополнительные сведения см. в документации по [пакетам SDK центра IoT Azure][lnk-apis-sdks].

#### Сравнение SASL PLAIN с CBS

При использовании SASL PLAIN клиент, подключающийся к центру IoT, может использовать по одному маркеру для каждого TCP-подключения. Когда срок действия маркера истекает, TCP-подключение к службе разрывается и выполняется попытка повторного подключения. Хотя это поведение и не является проблематичным для серверной части приложения, оно может навредить приложению на стороне устройства по следующим причинам.

*  Шлюзы обычно подключаются от имени многих устройств. Если используется SASL PLAIN, шлюзам нужно создать отдельное TCP-подключение для каждого устройства, подключающегося к центру IoT. Это значительно повышает потребление электроэнергии и сетевых ресурсов и увеличивает задержку подключения устройства.
* Если потребление ресурсов увеличится, устройства с ограниченными ресурсами должны будут выполнять повторное подключение после истечения срока действия маркера.

### Определение области действия учетных данных на уровне концентратора

Чтобы определить область действия для политик безопасности на уровне концентратора, создайте маркеры с помощью универсального кода (URI) ограниченного ресурса. Например, конечная точка для отправки сообщений с устройства в облако — это `/devices/{deviceId}/events`. Кроме того, вы можете использовать политику общего доступа на уровне концентратора, с разрешениями **DeviceConnect**. С ее помощью можно подписать маркер, значением resourceURI которого является `/devices/{deviceId}`. В результате будет создан маркер, который можно использовать только для отправки устройств от имени устройства с кодом **deviceId**.

Этот механизм похож на [политику издателя концентраторов событий][lnk-event-hubs-publisher-policy]. Он позволяет реализовывать методы настраиваемой проверки подлинности (как объясняется в разделе о безопасности руководства [Центр IoT Azure][lnk-guidance-security]).

## Обмен сообщениями

Центр IoT предоставляет примитивы обмена сообщениями, с помощью которых можно обеспечить двухстороннее взаимодействие между серверной частью приложения (*служба* или *облако*) и устройствами. Эти функции мы называем [С устройства в облако](#d2c) и [Из облака на устройство](#c2d).

Основные свойства функции обмена сообщениями в центре IoT — надежность и устойчивость сообщений. Поэтому они сохраняются, если на стороне устройства прерывается подключение и если наступает момент пиковой загрузки на стороне облака при обработке событий. Центр IoT реализует гарантии *как минимум однократной* доставки при двухстороннем обмене сообщениями между устройством и облаком.

Центр IoT поддерживает несколько обращенных к устройству протоколов (например, AMQP и HTTP/1). Для поддержки эффективного взаимодействия по протоколам центр IoT задает общий формат сообщений, поддерживаемый всеми обращенными к устройству протоколами.

### Формат сообщений <a id="messageformat"></a>

Сообщения центра IoT включают в себя следующие компоненты.

* Набор *свойств системы.* Это свойства, которые центр IoT интерпретирует или задает. Этот набор определяется предварительно.
* Набор *свойств приложения*. Это словарь свойств строки, которые приложение может задать и использовать, не десериализируя основную часть. Центр IoT не изменяет эти свойства.
* Непрозрачная двоичная основная часть.

Дополнительные сведения о разных способах кодировки сообщения в разных протоколах см. в статье [Интерфейсы API и пакеты SDK центра IoT][lnk-apis-sdks].

Это набор системных свойств в сообщениях центра IoT.

| Свойство | Описание |
| -------- | ----------- |
| MessageId | Задаваемый пользователем идентификатор сообщения, обычно используемый для шаблонов типа запрос-ответ. Формат: строка с учетом регистра (длиной до 128 символов), состоящая из букв и цифр в 7-битовом формате ASCII + `{'-', ':',’.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`. |
| Порядковый номер | Число (уникальное для каждой очереди устройства), которое центр IoT назначает каждому сообщению, отправленному из облака на устройство. |
| Кому | Используется, чтобы указать назначение для сообщений, отправляемых [из облака на устройство](#c2d).|
| ExpiryTimeUtc | Дата и время истечения срока действия сообщения. |
| EnqueuedTime | Время, когда центр IoT получил сообщение. |
| CorrelationId | Свойство-строка, обычно содержащая идентификатор сообщения, используемый в запросе, основанном на вопрос-ответном шаблоне. |
| UserId | Используется для указания источника сообщения. Если сообщения создает центр IoT, для этого параметра задается значение `{iot hub name}`. |
| Ack | Используется в сообщениях, отправляемых из облака на устройство, чтобы запросить у центра IoT отправку отзыва после того, как сообщение будет использовано устройством. Возможные значения: **none** (по умолчанию) — отзывы не создаются; **positive** — отзыв будет получен, когда исходное сообщение будет передано; **negative** — отзыв будет получен, когда истечет срок действия исходного сообщения (или будет превышен лимит доставок) и при этом устройство его не примет; **full**: активированы значения positive и negative. Дополнительную информацию см. в разделе [Отзыв на сообщение](#feedback). |
| ConnectionDeviceId | Задается центром IoT для сообщений, отправляемых с устройства в облако. Содержит идентификатор **deviceId** устройства, отправившего сообщение. |
| ConnectionDeviceGenerationId | Задается центром IoT для сообщений, отправляемых с устройства в облако. Содержит идентификатор **generationId** (см. раздел [Свойства удостоверений устройств](#deviceproperties)) устройства, отправившего сообщение. |
| ConnectionAuthMethod | Задается центром IoT для сообщений, отправляемых с устройства в облако. Сведения о методе аутентификации, используемом для аутентификации устройства, отправляющего сообщение. Дополнительные сведения см. в разделе, посвященном [защите сообщений, отправляемых с устройства в облако, от спуфинга](#antispoofing).|

### Выбор протокола связи <a id="amqpvshttp"></a>

Центр IoT поддерживает протоколы [AMQP][lnk-amqp] и HTTP/1 для обмена данными на стороне устройства. Далее приведен список рекомендаций по их применению.

* **Шаблон сообщения из облака на устройство**. Протокол HTTP/1 не позволяет отправлять данные по инициативе сервере. Таким образом, при использовании протокола HTTP/1 устройства опрашивают центр IoT на предмет наличия сообщений из облака на устройство. Это очень неэффективно для устройства и центра IoT. Сейчас действуют такие инструкции: при использовании HTTP/1 следует задать интервал опроса для каждого устройства, который будет выполняться реже одного раза в 25 минут. С другой стороны, протокол AMQP поддерживает отправку сообщений по инициативе сервера из облака на устройство и позволяет незамедлительно передавать сообщения из центра IoT на устройство. Если задержка доставки является проблемой, лучше использовать протокол AMQP. С другой стороны, если устройство едва подключается, подойдет и протокол HTTP/1.
* **Шлюзы поля**. Учитывая ограничения протокола HTTP/1 в отправке сообщений по инициативе сервера, он непригоден при [использовании шлюзов поля][lnk-azure-gateway-guidance].
* **Устройства с небольшим количеством ресурсов**. Библиотеки HTTP/1 намного меньше библиотек AMQP. Поэтому, если у устройства мало ресурсов (например, менее 1 МБ ОЗУ), единственным доступным протоколом может быть HTTP/1.
* **Обход сети**. Обычно протокол AMQP прослушивает порт 5672. Это может вызвать проблемы в сетях, закрытых для других протоколов.
* **Объем полезных данных**. Протокол AMQP — это двоичный протокол, который занимает значительно меньше места, чем HTTP/1.

На высоком уровне мы рекомендуем использовать AMQP всегда, когда это возможно, и использовать HTTP/1, если ресурсы устройства или конфигурация сети не поддерживают AMQP. Кроме того, при использовании HTTP/1 нужно задать такую частоту опроса, чтобы он выполнялся реже одного раза в 25 минут для каждого устройства. Во время разработки допускается большая частота опроса.

И наконец, следует рассмотреть [шлюз протокола IoT Azure][lnk-azure-protocol-gateway], который позволяет развернуть высокопроизводительный шлюз MQTT, напрямую взаимодействующий с центром IoT. MQTT поддерживает отправку сообщений по инициативе сервера (что позволяет мгновенно отправлять сообщения из облака на устройство). Кроме того, этот шлюз доступен для устройств с очень малым объемом ресурсов. Основной недостаток этого подхода — необходимость самостоятельно размещать шлюз протокола и управлять им.

### Отправка сообщений с устройства в облако<a id="d2c"></a>

Как описано в разделе [Конечные точки](#endpoints), сообщения, поступающие с устройства в облако, отправляются через конечную точку, обращенную к устройству (в частности, `/devices/{deviceId}/messages/events`). Устройства получают их через конечную точку, обращенную к службе (`/messages/events`), то есть совместимую с [концентраторами событий][lnk-event-hubs]. Таким образом, чтобы получать сообщения, вы можете использовать стандартную интеграцию концентраторов событий и пакетов SDK.

Реализация отправки сообщений с устройства в облако в центре IoT похожа на реализацию в [концентраторах событий][lnk-event-hubs]. При этом сообщения центра IoT, отправляемые с устройства в облако, больше похожи на *события* концентраторов событий, чем на *сообщения* [служебной шины][lnk-servicebus].

Далее перечислены следствия этой реализации.

* Подобно *событиям* концентраторов событий, сообщения с устройства в облако устойчивы и хранятся в центре IoT до 7 дней (см. раздел [Параметры конфигурации сообщений, отправляемых с устройства в облако](#d2cconfiguration)).
* Сообщения, отправляемые с устройства в облако, секционируются по разделам, заданным во время создания (см. раздел [Параметры конфигурации сообщений, отправляемых с устройства в облако](#d2cconfiguration)).
* Подобно тому, как это происходит с концентраторами событий, клиенты, читающие сообщения, отправляемые с устройства в облако, должны работать с секциями и назначением контрольных точек. См. раздел [Концентраторы событий — использование событий][lnk-event-hubs-consuming-events].
* Как и в случае с событиями концентраторов событий, размер сообщений, поступающих с устройства в облако, не может превышать 256 КБ; их можно объединять в пакеты, чтобы оптимизировать отправку. Размер пакетов не может превышать 256 КБ, а сами пакеты не могут содержать более 500 сообщений.

При этом сообщения центра IoT, отправляемые с устройства в облако, и сообщения, отправляемые концентраторами событий, существенно различаются.

* Как объяснено в разделе [Безопасность](#security), центр IoT позволяет проводить аутентификацию каждого устройства и осуществлять контроль доступа.
* Центр IoT позволяет одновременно подключать миллионы устройств (см. раздел [Квоты и регулирование](#throttling)), тогда как концентраторы событий позволяют выполнять максимум 5000 подключений по протоколу AMQP в одном пространстве имен.
* Центр IoT не позволяет выполнять произвольное секционирование с помощью **PartitionKey**. Сообщения, отправляемые с устройства в облако, секционируются по исходному идентификатору **deviceId**.
* Масштабирование центра IoT немного отличается от масштабирования концентраторов событий. Дополнительную информацию см. в статье [Масштабирование центра IoT][lnk-guidance-scale].

Обратите внимание: это не означает, что центр IoT может заменить концентраторы событий во всех случаях. Например, иногда при вычислениях для обработки событий может понадобиться перераспределить события на основании другого свойства или поля, чтобы проанализировать потоки данных. В этом случае с помощью концентратора событий можно отделить друг от друга две секции конвейера обработки потока.

Сведения об использовании обмена сообщениями с устройства в облако см. в статье [Интерфейсы API и пакеты SDK центра IoT][lnk-apis-sdks].

#### Трафик, передающийся без использования телеметрии

Часто устройства отправляют не только точки данных телеметрии в серверную часть приложения, но также и *интерактивные* сообщения и запросы, выполнение и обработку которых осуществляет та часть приложения, которая отвечает за бизнес-логику. Хорошим примером являются критические оповещения, которые активируют определенное действие в серверной части, или ответы устройства на команды.

Дополнительные сведения об оптимальных методах обработки таких сообщений см. в разделе [Обработка сообщений, отправляемых с устройства в облако][lnk-guidance-d2c-processing] руководства по центру IoT.

#### Параметры конфигурации сообщений, отправляемых с устройства в облако <a id="d2cconfiguration"></a>

Центр IoT позволяет управлять сообщениями, отправляемыми с устройств в облако, с помощью приведенных ниже свойств.

* **Количество секций**. Это свойство можно задать во время создания, чтобы определить количество секций для приема событий сообщений, отправляемых с устройства в облако.
* **Время хранения**. Это свойство определяет время хранения сообщений, отправляемых с устройства в облако. По умолчанию задан 1 день, но это значение можно увеличить до 7.

Кроме того, как и концентраторы событий, центр IoT позволяет управлять группами потребителей в конечной точке, которая получает сообщения, отправляемые с устройства в облако.

Вы можете изменить все эти свойства на [портале предварительной версии Azure][lnk-management-portal] или программно (с помощью [API-интерфейсов поставщика ресурсов в центре IoT Azure][lnk-resource-provider-apis]).

#### Свойства для защиты от спуфинга <a id="antispoofing"></a>

Чтобы избежать спуфинга устройств при работе с сообщениями, отправляемыми с устройства в облако, центр IoT отмечает все сообщения такими свойствами:

* **ConnectionDeviceId**;
* **ConnectionDeviceGenerationId**;
* **ConnectionAuthMethod**.

Первые два свойства содержат параметры **deviceId** и **generationId** исходного устройства (согласно разделу [Свойства удостоверений устройств](#deviceproperties)).

Свойство **ConnectionAuthMethod** содержит сериализованный объект JSON, имеющий такие свойства:

    {
        "scope": "{ hub | device}",
        "type": "{ symkey | sas}",
        "issuer": "iothub"
    }

### Отправка сообщений из облака на устройство <a id="c2d"></a>

Как уже подробно объяснялось в разделе [Конечные точки](#endpoints), сообщения, отправляемые из облака на устройство, передаются через обращенную к службе конечную точку (`/messages/devicebound`), а их получение выполняется с помощью ряда обращенных к устройству конечных точек (`/devices/{deviceId}/messages/devicebound`).

Каждое сообщение, отправляемое из облака на устройство, адресовано отдельному устройству, т. е. для свойства **to** задается значение `/devices/{deviceId}/messages/devicebound`.

**Важно!** Одна очередь устройства может содержать не более 50 сообщений, отправляемых из облака на устройство. Попытка отправить на устройство большее количество сообщений приведет к ошибке.

#### Жизненный цикл сообщения <a id="message lifecycle"></a>

Чтобы реализовать гарантию *как минимум однократной* доставки, сообщения, отправляемые из облака на устройство, хранятся в очередях устройств. Сами устройства должны явно подтвердить *завершение* доставки, чтобы центр IoT мог удалить сообщения из очереди. Это гарантирует устойчивость к сбоям подключения и ошибкам устройств.

На следующей схеме показан жизненный цикл сообщений, отправляемых из облака на устройство.

![Жизненный цикл сообщений, отправляемых из облака на устройство][img-lifecycle]

Когда служба отправляет сообщение, считается, что оно *поставлено в очередь*. Когда устройству нужно *получить* сообщение, центр IoT *блокирует* сообщение (состояние со значением **Невидимое**), чтобы другие потоки на том же устройстве начали получать другие сообщения. Когда поток устройства завершает обработку устройства, он уведомляет центр IoT, *завершая* сообщение. Кроме того, поток может *отклонить* сообщение, что создает для него состояние **Не востребовано**, или *отказаться* от него, в результате чего сообщение отправляется обратно в очередь (состояние **Поставлено в очередь**).

Так как при обработке сообщения потоком может произойти ошибка и центр IoT не будет уведомлен, сообщения автоматически переходят из состояния **Невидимое** в состояние **Поставлено в очередь** после *истечения срока видимости (или блокировки)* (по умолчанию 1 минута). Состояние сообщения может изменяться с **Поставлено в очередь** на **Невидимое** и наоборот столько раз, сколько указано в свойстве *Максимальное количество доставок* центра IoT. Когда достигается это значение, состояние сообщения автоматически изменяется на «Не востребовано». То же самое происходит и в случае, когда истекает время действия сообщения (см. раздел [Срок жизни](#ttl)).

Руководство по сообщениям, отправляемым из облака на устройство, см. в статье. [Отправка сообщений из облака на устройство с помощью центра IoT Azure][lnk-getstarted-c2d-tutorial]. Справочную информацию о том, как разные API-интерфейсы и пакеты SDK предоставляют функцию отправки сообщений из облака на устройство, см. в статье [Интерфейсы API и пакеты SDK центра IoT][lnk-apis-sdks].

> [AZURE.NOTE]Обычно, если потеря сообщения, отправляемого из облака на устройство, никак не влияет на логику приложения, это сообщение нужно завершить. Это может произойти в разных случаях: например, когда содержимое сообщения успешно сохранено в локальном хранилище, когда операция успешно выполнена или когда сообщение содержит временную информацию, потеря которой не влияет на функциональность приложения. Иногда при работе с долгосрочной задачей сообщение, отправляемое из облака на устройство, завершается после того, как описание задачи сохраняется в локальном хранилище. После этого серверной части приложения отправляются уведомления (одно или несколько) на различных этапах выполнения задачи.

#### Срок жизни <a id="ttl"></a>

Каждое сообщение из облака на устройство имеет срок действия. Его может быть явно задавать служба (в свойстве **ExpiryTimeUtc**) или центр IoT, в котором задан *срок жизни* по умолчанию, указанный в соответствующем свойстве центра IoT. См. раздел [Параметры конфигурации сообщений, отправляемых из облака на устройство](#c2dconfiguration).

#### Отзыв на сообщение <a id="feedback"></a>

При отправке сообщений из облака на устройство служба может запросить отзыв на каждое сообщение, уведомляющий о его конечном состоянии. Если для свойства **Ack** задано значение **positive**, центр IoT создает отзыв на сообщение только в том случае, если сообщение, отправляемое из облака на устройство, имеет состояние **Завершено**. Если для свойства **Ack** задано значение **negative**, центр IoT создает отзыв на сообщение только в том случае, если сообщение, отправляемое из облака на устройство, имеет состояние **Не востребовано**. Если для свойства **Ack** задано значение **full**, центр IoT создает отзыв на сообщение в любом случае.

Как описывалось в разделе [Конечные точки](#endpoints), отзывы приходят в виде сообщений через обращенную к службе конечную точку (`/messages/servicebound/feedback`). Семантика получения отзыва идентична семантике, используемой для сообщений, отправляемых из облака на устройство, с тем же [жизненным циклом сообщения](#жизненный цикл сообщения). Когда это возможно, отзывы на сообщения группируются в одно сообщение, имеющее приведенный ниже формат.

Каждое сообщение, полученное из конечной точки отзыва, имеет следующие свойства.

| Свойство | Описание |
| -------- | ----------- |
| EnqueuedTime | Метка времени, указывающая, когда был создан пакет. |
| UserId | `{iot hub name}` |
| ContentType | `application/vnd.microsoft.iothub.feedback.json` |

Основная часть — это сериализованный массив записей JSON, каждая из которых имеет следующие свойства:

| Свойство | Описание |
| -------- | ----------- |
| EnqueuedTimeUtc | Метка времени, указывающая, когда отобразился результат сообщения. Например, устройство завершило его или истек срок его действия. |
| OriginalMessageId | Идентификатор **MessageId** сообщения, которое отправляется из облака на устройство и к которому относится эта информация. |
| Описание | Строковые значения для предыдущих результатов. |
| DeviceId | Идентификатор **DeviceId** целевого устройства, которому отправляется сообщение из облака и к которому относится этот отзыв. |
| DeviceGenerationId | Идентификатор **DeviceGenerationId** целевого устройства сообщения, которому отправляется сообщение из облака и к которому относится этот отзыв. |

**Важно!** Служба должна указать идентификатор **MessageId** для сообщения, отправляемого из облака на устройство, чтобы соотнести свой отзыв с исходным сообщением.

**Пример**. Ниже приведен пример текста сообщения отзыва.

    [
        {
            "OriginalMessageId": "0987654321",
            "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
            "Description": "Success",
            "DeviceId": "123",
            "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
        },
        {
            ...
        },
        ...
    ]

#### Параметры конфигурации сообщений, отправляемых из облака на устройство <a id="c2dconfiguration"></a>

Каждый центр IoT предоставляет следующие параметры конфигурации для отправки сообщений из облака на устройство.

| Свойство | Описание | Диапазон и значение по умолчанию |
| -------- | ----------- | ----------------- |
| defaultTtlAsIso8601 | Заданный по умолчанию срок жизни для сообщений, отправляемых из облака на устройство. | Интервал ISO\_8601 — до 2 устройств (минимум 1 минута). Значение по умолчанию — 1 час. |
| maxDeliveryCount | Лимит доставки для очереди доставки сообщений, отправляемых из облака на устройство, для каждого отдельного устройства. | От 1 до 100. Значение по умолчанию — 10. |
| feedback.ttlAsIso8601 | Хранение отзывов, направленных службе. | Интервал ISO\_8601 — до 2 устройств (минимум 1 минута). Значение по умолчанию — 1 час. |
| feedback.maxDeliveryCount | Лимит доставок для очереди отзывов. | От 1 до 100. Значение по умолчанию — 100. |

## Квоты и регулирование <a id="throttling"></a>

Каждая подписка Azure может использовать не более 10 центров IoT.

Каждый центр IoT подготавливается с определенным количеством единиц в определенной единице хранения (SKU). Дополнительные сведения см. на странице [Цены в центре Azure IoT][lnk-pricing]. SKU и количество единиц определяют максимальную дневную квоту отправляемых сообщений и максимальное количество удостоверений устройств в реестре удостоверений. Количество одновременно подключенных устройств ограничено количеством удостоверений в реестре.

Кроме того, эти значения определяют лимиты регулирования, которые центр IoT применяет по отношению к операциям.

### Квота реестра удостоверений устройств

Центр IoT позволяет изменять устройства (создавать, обновлять, удалять) не более 1100 раз на одну единицу в день (вне зависимости от SKU).

### Регулирование операций

Регулирование операции — это ограничение скорости, выражаемое в виде диапазона (в минутах). Оно нужно для того, чтобы избежать применения не по назначению. Центр IoT пытается избежать ошибок возврата, когда это возможно. Однако если регулирование нарушается слишком долго, он начинает возвращать исключения.

Ниже приведен список случаев принудительного регулирования. Значения обозначают тот или иной концентратор.

| Регулирование | Значение концентратора |
| -------- | ------------- |
| Операции с реестром удостоверений (создание, извлечение, перечисление, обновление и удаление), импорт и экспорт отдельных элементов или пакетов | 100/мин/единица, до 5000/мин |
| Подключение устройств | 100/с/единица |
| Отправка с устройства в облако | 2000/мин/единица (для S2), 60/мин/единица (для S1). Минимум 100/с |
| Операции при отправке из облака на устройство (отправка, получение, отправка отзыва) | 100/мин/единица |

**Примечание**. В любой момент времени можно увеличить квоты или лимиты регулирования, увеличив количество подготовленных единиц в центре IoT.

## Дальнейшие действия

Вы ознакомились с общими сведениями о разработке, касающимися центра IoT. Чтобы узнать больше, перейдите по этим ссылкам:

- [Приступая к работе с центром IoT (руководство)][lnk-get-started]
- [Платформы ОС и совместимость оборудования][lnk-compatibility]
- [Центр разработчика IoT Azure][lnk-iotdev]
- [Планирование реализации IoT][lnk-guidance]

[концентраторов событий и узла обработчика событий]: http://blogs.msdn.com/b/servicebus/archive/2015/01/16/event-processor-host-best-practices-part-1.aspx

[портале предварительной версии Azure]: https://portal.azure.com

[img-summary]: ./media/iot-hub-devguide/summary.png
[img-endpoints]: ./media/iot-hub-devguide/endpoints.png
[img-lifecycle]: ./media/iot-hub-devguide/lifecycle.png
[img-eventhubcompatible]: ./media/iot-hub-devguide/eventhubcompatible.png

[lnk-compatibility]: https://github.com/Azure/azure-iot-sdks/blob/master/doc/tested_configurations.md
[lnk-apis-sdks]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md
[lnk-azure-hub-sdks]: https://msdn.microsoft.com/library/mt488521.aspx
[lnk-pricing]: https://azure.microsoft.com/pricing/details/iot-hub
[lnk-resource-provider-apis]: https://msdn.microsoft.com/library/mt548492.aspx
[lnk-reference-architecture]: iot-hub-what-is-azure-iot.md

[lnk-azure-gateway-guidance]: iot-hub-guidance.md#fieldgateways
[lnk-guidance-provisioning]: iot-hub-guidance.md#provisioning
[lnk-guidance-scale]: iot-hub-scaling.md
[lnk-guidance-security]: iot-hub-guidance.md#customauth

[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md
[lnk-get-started]: iot-hub-csharp-csharp-getstarted.md
[lnk-guidance]: iot-hub-guidance.md
[lnk-getstarted-c2d-tutorial]: iot-hub-csharp-csharp-c2d.md

[lnk-amqp]: https://www.amqp.org/
[lnk-arm]: ../resource-group-overview.md
[lnk-azure-resource-manager]: https://azure.microsoft.com/documentation/articles/resource-group-overview/
[lnk-cbs]: https://www.oasis-open.org/committees/download.php/50506/amqp-cbs-v1%200-wd02%202013-08-12.doc
[lnk-createuse-sas]: ../storage/storage-dotnet-shared-access-signature-part-2/
[lnk-event-hubs-publisher-policy]: https://code.msdn.microsoft.com/Service-Bus-Event-Hub-99ce67ab
[lnk-event-hubs]: http://azure.microsoft.com/services/event-hubs/
[lnk-event-hubs-consuming-events]: ../event-hubs/event-hubs-programming-guide.md#event-consumers
[lnk-guidance-d2c-processing]: iot-hub-csharp-csharp-process-d2c.md
[lnk-management-portal]: https://portal.azure.com
[lnk-rfc7232]: https://tools.ietf.org/html/rfc7232
[lnk-sas-java]: https://msdn.microsoft.com/library/azure/Hh875756.aspx
[lnk-sasl-plain]: http://tools.ietf.org/html/rfc4616
[lnk-servicebus]: http://azure.microsoft.com/services/service-bus/
[lnk-tls]: https://tools.ietf.org/html/rfc5246
[lnk-iotdev]: https://azure.microsoft.com/develop/iot/

<!----HONumber=Nov15_HO3-->