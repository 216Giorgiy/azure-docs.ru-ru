<properties
 pageTitle="Центр IoT Azure: руководство | Microsoft Azure"
 description="Рекомендации для решений, в которых используется центр IoT Azure."
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="kevinmil"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="09/29/2015"
 ms.author="elioda"/>

# Центр IoT Azure: руководство

## Сравнение центра IoT и концентратора событий
Одним из основных способов использования центра IoT Azure (IoT — «Интернет вещей») является сбор телеметрических данных с устройств. По этой причине центр IoT часто сравнивают с [концентратором событий], который представляет собой службу обработки событий, передающую в облако огромные количества данных о событиях с низкой задержкой и высокой надежностью.

Однако между службами имеется множество различий, которые подробно описаны в следующих разделах.

| Область | Центр IoT | Концентраторы событий |
| ---- | ------- | ---------- |
| Модели связи | Передача событий с устройства в облако и передача сообщений из облака на устройство. | Только передача событий (обычно учитывается при передаче данных с устройства в облако). |
| Безопасность | Идентификация каждого устройства и управление доступом с возможностью отзыва. См. руководство для разработчиков центра IoT, раздел [Безопасность]. | [Политики общего доступа][Event Hub - security], действующие для всего концентратора событий, с ограниченными возможностями отзыва посредством [политик издателя][Event Hub publisher policies]. В контексте решений IoT часто требуется реализовать настраиваемое решение для поддержки учетных данных отдельных устройств и принять меры против спуфинга. |
| Масштаб | Оптимизация центров IoT позволяет им поддерживать миллионы одновременно подключенных устройств. | Концентраторы событий поддерживают меньшее число одновременных подключений: до 5 000 подключений AMQP (согласно [квот шины обслуживания]). С другой стороны, концентраторы событий позволяют пользователям указывать раздел для каждого отправляемого сообщения. |
| Пакеты SDK для устройств | Центр IoT предоставляет [пакеты SDK для устройств][Azure IoT Hub SDKs] под большое количество платформ и языков. | Поддержка концентраторов событий реализована в .NET и языке C. Концентраторы событий предоставляют интерфейсы передачи AMQP и HTTP. |

В заключение скажем, что, даже если единственным вариантом использования является передача телеметрических данных от устройства в облако, центр IoT предоставляет службу, специально разработанную для подключения устройств IoT. Для центра IoT будут и дальше появляться новые возможности для IoT, ориентированные на такие сценарии. Концентраторы событий предназначены для приема огромных объемов событий, как в контексте обмена данными между разными ЦОД, так и в пределах одного ЦОД. Использование центра IoT вместе с концентраторами событий не является экзотикой. В таких случаях центр IoT обрабатывает передачу данных с устройств в облако, а концентраторы событий — дальнейшую передачу событий в модули обработки в реальном времени.

## Подготовка устройств <a id="provisioning"></a>
Решения IoT хранят информацию об устройствах во многих различных системах и хранилищах. Одним из таких хранилищ выступает [реестр удостоверений центра IoT][IoT Hub Developer Guide - identity registry]. Как и в других хранилищах, в реестре хранится информация об устройствах для конкретного приложения. Процесс создания необходимой информации об устройствах во всех этих системах мы называем *подготовкой*.

Существует множество требований и стратегий для подготовки устройств (см. [руководство по управлению устройствами центра IoT] для получения дополнительных сведений). [Реестр удостоверений центра IoT][IoT Hub Developer Guide - identity registry] предоставляет интерфейсы API, необходимые для интеграции центра IoT в ваш процесс подготовки.

## Полевые шлюзы <a id="fieldgateways"></a>
Полевой шлюз — это специализированное устройство или программное обеспечение общего назначения, которое служит средством реализации обмена данными, а также, по возможности, системой управления локальными устройствами и центром обработки данных, получаемых от устройств. Полевой шлюз может локально обрабатывать данные и управлять устройствами; с другой стороны он может фильтровать или агрегировать данные телеметрии устройств и таким образом уменьшать объем данных, передаваемых в серверную часть.

В сферу ответственности полевого шлюза входит сам полевой шлюз и все присоединенные к нему устройства. Как можно догадаться из названия, полевые шлюзы функционируют за пределами ЦОД и обычно привязаны к тому или иному местоположению. Полевой шлюз отличается от обычного маршрутизатора трафика тем, что ему отведена активная роль в управлении доступом и потоком информации. Это значит, что он является ориентированным на приложения объектом, а также терминалом сетевых подключений или сеансов (например, шлюзы в этом контексте могут помогать в подготовке устройств, преобразовании данных, трансляции протоколов и обработке правил событий). Устройства NAT и брандмауэры, напротив, не могут считаться полевыми шлюзами, так как они не являются явными терминалами подключений или сеансов. Они просто маршрутизируют (или запрещают) подключения или сеансы, которые через них выполняются.

### Прозрачные и непрозрачные полевые шлюзы
В отношении удостоверений устройств полевой шлюз называется *прозрачным*, если в реестре удостоверений центра IoT существуют удостоверения других устройств, входящих в сферу ответственности шлюза. Полевой шлюз называется *непрозрачным*, если единственным удостоверением в реестре удостоверений центра IoT является удостоверение полевого шлюза.

Важно отметить, что использование *непрозрачных* шлюзов препятствует [защите удостоверений устройств от спуфинга][IoT Hub Developer Guide - Anti-spoofing] средствами центра IoT. Кроме того, поскольку все устройства, входящие в сферу ответственности полевого шлюза, представлены в центре IoT как единое устройство, ограничения и квоты к ним будут применяться как к единому устройству.

### Дополнительные рекомендации

При реализации полевого шлюза можно использовать пакеты SDK для устройств IoT Azure. Некоторые пакеты SDK предоставляют специальные функции для полевых шлюзов, например возможность мультиплексировать данные, поступающие от нескольких устройств, в одном канале к центру IoT. Как описано в руководстве для разработчиков центра IoT в разделе [Выбор протокола связи], не стоит использовать HTTP/1 в качестве транспортного протокола для полевых шлюзов.

## Использование настраиваемых схем и служб для проверки подлинности устройств <a id="customauth"></a>
Центр IoT Azure позволяет настроить контроль доступа и учетные данные безопасности для каждого устройства посредством [реестра удостоверений устройств][IoT Hub Developer Guide - identity registry]. Если в решение IoT уже были вложены значительные средства для реализации настраиваемого реестра удостоверений устройств и/или схемы проверки подлинности, оно все равно позволяет воспользоваться преимуществами других функций центра IoT. Для этого нужно создать *службу маркеров* для центра IoT.

Служба маркеров — это саморазвертываемая облачная служба, которая использует политику общего доступа центра IoT с разрешениями **DeviceConnect** для создания маркеров *уровня устройства*.

  ![][img-tokenservice]

Ниже приведены основные этапы для схемы службы маркеров.

1. Создание [политики общего доступа центра IoT][IoT Hub Developer Guide - Security] с разрешениями **DeviceConnect** для вашего центра IoT. Эту политику служба маркеров будет использовать для подписания маркеров.
2. Когда устройству требуется доступ к центру IoT, оно запрашивает у службы маркеров подписанный маркер. Устройство может использовать существующую настраиваемую схему проверки подлинности или реестр удостоверений устройств.
3. Служба маркеров возвращает маркер, созданный согласно требованиям к безопасности, описанным в [руководстве для разработчиков центра IoT]. `/devices/{deviceId}` используется как `resourceURI`, а в качестве `deviceId` указывается устройство, подлинность которого проверяется.
4. Устройство использует маркер для подключения к центру IoT.

При необходимости служба маркеров может задать срок действия маркера. По истечении срока действия центр IoT прекратит обслуживание подключения, а устройству придется запросить новый маркер у службы маркеров. Очевидно, что короткий срок действия увеличит нагрузку как на устройство, так и на службу маркеров.

Стоит отметить, что в центре IoT по-прежнему необходимо создать удостоверение устройства. В противном случае устройство не сможет подключиться. Это также означает, что управление доступом на уровне отдельных устройств (путем отключения удостоверений устройств, как описано в руководстве для разработчиков центра IoT в разделе [Реестр удостоверений устройств]) продолжает работать, даже если устройство проходит проверку подлинности с помощью маркера. Это уменьшает риск существования маркеров с длительным сроком действия.

### Сравнение с настраиваемым шлюзом
Вариант со службой маркеров позволяет центру IoT обрабатывать большую часть трафика решения, поэтому такой вариант является рекомендованным способом внедрения настраиваемого реестра удостоверений или схемы проверки подлинности с использованием центра IoT. Тем не менее существуют случаи, когда настраиваемая схема проверки подлинности настолько тесно переплетена с протоколом (например, [TLS-PSK]), что для обработки всего трафика требуется отдельная служба (*настраиваемый шлюз*). Дополнительные сведения см. в статье [Шлюз протокола].

## Масштабирование центра IoT
Центр IoT может поддерживать до миллиона одновременно подключенных устройств, увеличивая число единиц S1 или S2 для центра IoT до 2 000. Дополнительные сведения см. на станице [Цены на центр IoT][lnk-pricing].

Каждая единица центра IoT позволяет размещать в реестре определенное количество удостоверений устройств, которые могут быть все одновременно подключены, и передавать определенное количество сообщений в день.

Для надлежащего масштабирования решения необходимо учитывать конкретную модель использования центра IoT. В частности, необходимо учитывать требования к пиковой пропускной способности для таких категорий операций:

* сообщения с устройств в облако;
* сообщения из облака на устройства;
* операции с реестром удостоверений.

Помимо этих сведений о пропускной способности, не забудьте изучить документ [Квоты и ограничения центра IoT] и спроектировать свое решение соответствующим образом.

### Пропускная способность для передачи сообщений с устройств в облако и из облака на устройства
Лучший способ определить размер решения центра IoT — оценить трафик в пересчете на одно устройство.

Для сообщений, передаваемых с устройства в облако, следует соблюдать такие правила.

| Уровень | Непрерывная пропускная способность | Непрерывная скорость отправки |
| ---- | -------------------- | ------------------- |
| S1 | до 8 Кбит/ч на одно устройство | в среднем 4 сообщения в час на одно устройство |
| S2 | до 4 Кбит/мин на одно устройство | в среднем 2 сообщения в минуту на одно устройство |

При получении сообщений, отправленных с устройства в облако, серверная часть приложения может ожидать следующую максимальную пропускную способность (для всех считывателей).

| Уровень | Непрерывная пропускная способность |
| ---- | -------------------- |
| S1 | до 120 Кбит/мин на единицу, минимум 2 Мбит/с |
| S2 | до 4 Мбит/мин на единицу, минимум 2 Мбит/с |

Скорость передачи сообщений из облака на устройства масштабируется по количеству устройств, когда каждое устройство получает до 5 сообщений в минуту.

### Пропускная способность для операций с реестром удостоверений
Операции с реестром удостоверений центра IoT не должны выполняться в среде выполнения, так как они в основном связаны с подготовкой устройств. Конкретные показатели пиковой пропускной способности см. в разделе [Квоты и ограничения центра IoT].

### Сегментирование
Хотя один центр IoT может обслуживать миллионы устройств, иногда для существующего решения требуются особые характеристики производительности. Такие, которые не может гарантировать один центр IoT. В этом случае рекомендуется распределить устройства между несколькими центрами IoT, чтобы выровнять пиковые показатели трафика и получить необходимую пропускную способность или скорость операций.

## Высокий уровень доступности и аварийное восстановление
Будучи службой Azure, центр IoT отличается высоким уровнем доступности, который достигается за счет использования избыточности в одном регионе Azure. При этом к решению не выдвигаются никакие дополнительные требования. Кроме того, Azure предоставляет ряд возможностей для создания решений с функциями аварийного восстановления или межрегиональной доступностью. Чтобы обеспечивать глобальную межрегиональную высокую доступность для устройств или пользователей, решения должны разрабатываться и подготавливаться соответствующим образом. В статье [Техническое руководство по непрерывности бизнес-процессов для Azure] описаны встроенные функции Azure, которые позволяют обеспечить непрерывность бизнес-процессов и возможности аварийного восстановления. В статье [Аварийное восстановление и высокий уровень доступности для приложений Azure] содержатся требования к архитектуре, которая позволит достичь высокого уровня доступности приложений Azure и реализовать для них возможности аварийного восстановления.

## Отработка отказа между регионами с помощью центра IoT
Полное освещение топологий развертывания в решениях IoT выходит за рамки этого раздела, но, чтобы раскрыть тему высокого уровня доступности и аварийного восстановления, мы рассмотрим модель развертывания с *отработкой отказа между регионами*.

В модели с отработкой отказа между регионами серверная часть решения работает преимущественно в одном центре обработки данных. Чтобы реализовать возможности отработки отказа, еще один центр IoT и еще одна серверная часть развертываются в другом ЦОД в другом регионе. Если в основном ЦОД произойдет сбой или подключение устройства к основному ЦОД по какой-то причине будет нарушено, будут задействованы резервные ресурсы. Устройства используют дополнительную конечную точку службы всякий раз, когда основной шлюз недоступен. Использование дополнительного региона при отработках отказов позволяет еще больше повысить уровень доступности решения.

Если говорить в общем, то, чтобы реализовать модель с отработкой отказа между регионами, вам потребуется следующее.

* **Дополнительный центр IoT и логика маршрутизации устройств**. В случае нарушения работы службы в основном регионе устройства должны подключаться к дополнительному региону. Учитывая, что состояние большинства задействованных служб отслеживается, чаще всего процесс отработки отказа между регионами запускают администраторы решений. Лучший способ сообщить устройствам новую конечную точку и сохранить контроль над процессом — заставить устройства регулярно получать из *дежурной* службы текущую активную конечную точку. Дежурной службой может быть простое реплицируемое веб-приложение, доступность которого обеспечивается посредством перенаправления DNS-трафика (например, с помощью [диспетчера трафика Azure]).
* **Репликация реестра удостоверений**. Дополнительный центр IoT будет работоспособен только в том случае, если в нем будут все удостоверения устройств и эти удостоверения смогут подключаться к решению. Решение должно хранить геореплицированные резервные копии удостоверений устройств и передавать их в дополнительный центр IoT до перевода устройств на другую конечную точку. В этом случае вам очень пригодится функция центра IoT для экспорта удостоверений. Дополнительные сведения см. в руководстве для разработчиков центра IoT в разделе [Реестр удостоверений устройств].
* **Логика объединения**. Когда основной регион снова станет доступным, все состояния и данные, которые были созданы в дополнительном регионе, необходимо перенести обратно в основной. Это главным образом относится к удостоверениям устройств и метаданным приложений, которые необходимо добавить в основной центр IoT и, вероятно, другие хранилища приложений в основном регионе. Чтобы упростить эту процедуру, обычно рекомендуется использовать идемпотентные операции. Это сводит к минимуму количество побочных эффектов не только от итогового согласованного распределения событий, но и от дублирования данных или беспорядочной доставки событий. Кроме того, логику приложения необходимо спроектировать таким образом, чтобы потенциальные несоответствия или незначительно устаревшие состояния считались допустимыми. Это связано как с целевыми точками восстановления (RPO), так и с тем что, восстановление системы требует времени. В статье [Безаварийность: рекомендации по устойчивой облачной архитектуре] содержатся дополнительные рекомендации по этой теме.




[img-tokenservice]: media/iot-hub-guidance/tokenservice.png

[IoT Hub Developer Guide - identity registry]: iot-hub-devguide.md#identityregistry
[Реестр удостоверений устройств]: iot-hub-devguide.md#identityregistry
[Выбор протокола связи]: iot-hub-devguide.md#amqpvshttp
[IoT Hub Developer Guide - Security]: iot-hub-devguide.md#security
[Безопасность]: iot-hub-devguide.md#security
[руководстве для разработчиков центра IoT]: iot-hub-devguide.md#security
[IoT Hub Developer Guide - Anti-spoofing]: iot-hub-devguide.md#antispoofing
[Шлюз протокола]: iot-hub-protocol-gateway.md
[Квоты и ограничения центра IoT]: iot-hub-devguide.md#throttling

[руководство по управлению устройствами центра IoT]: iot-hub-device-management.md
[концентратором событий]: ../event-hubs/event-hubs-what-is-event-hubs/
[диспетчера трафика Azure]: https://azure.microsoft.com/documentation/services/traffic-manager/
[Event Hub - security]: ../event-hubs/event-hubs-authentication-and-security-model-overview/
[Event Hub publisher policies]: ../event-hubs-overview/#common-publisher-tasks
[квот шины обслуживания]: ../service-bus/service-bus-quotas/
[Azure IoT Hub SDKs]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md

[TLS-PSK]: https://tools.ietf.org/html/rfc4279

[Техническое руководство по непрерывности бизнес-процессов для Azure]: https://msdn.microsoft.com/library/azure/hh873027.aspx
[Аварийное восстановление и высокий уровень доступности для приложений Azure]: https://msdn.microsoft.com/library/azure/dn251004.aspx
[Безаварийность: рекомендации по устойчивой облачной архитектуре]: https://msdn.microsoft.com/library/azure/jj853352.aspx

[lnk-pricing]: https://azure.microsoft.com/pricing/details/iot-hub

<!---HONumber=Oct15_HO1-->