<properties
 pageTitle="Центр IoT: руководство | Microsoft Azure"
 description="Разделы, посвященные шлюзам, подготовке устройств и проверке подлинности для разработки решений IoT с помощью центра IoT Azure."
 services="iot-hub"
 documentationCenter=""
 authors="dominicbetts"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="07/19/2016"
 ms.author="dobett"/>

# Разработка решения

Эта статья содержит сведения о разработке следующих возможностей в решении для Интернета вещей (IoT):

- Подготовка устройств
- Шлюзы поля
- Проверка подлинности устройства
- Пульс устройства

## Подготовка устройств

IoT решения хранят такие данные об отдельных устройствах, как:

- удостоверения устройств и ключи проверки подлинности;
- тип и версия оборудования устройства;
- состояние устройства;
- версии и возможности программного обеспечения;
- журнал команд устройства.

Данные устройства, которые хранятся в заданном решении IoT, зависят от конкретных требований этого решения. Но в решении как минимум должны сохраняться удостоверения устройства и ключи проверки подлинности. Центр IoT Azure имеет [реестр удостоверений][lnk-devguide-identityregistry], который может хранить значения для каждого устройства, например идентификаторы, ключи проверки подлинности и коды состояния. Решение может использовать другие службы Azure, такие как таблицы, большие двоичные объекты или Azure DocumentDB, для хранения любых дополнительных данных устройств.

*Подготовка устройств* — это процесс добавления исходных данных устройства в хранилища в решении. Чтобы новое устройство могло подключиться к центру, необходимо добавить новый идентификатор устройства и ключи в [реестр удостоверений центра IoT][lnk-devguide-identityregistry]. В рамках процесса подготовки может потребоваться инициализировать данные устройства в других хранилищах решения.

[API реестра удостоверений центра IoT][lnk-devguide-identityregistry] позволяют интегрировать центр IoT в процесс подготовки.

## Шлюзы поля

В решении IoT *полевой шлюз* располагается между устройствами и центром IoT. Обычно он находится ближе к устройствам. Устройства взаимодействуют напрямую с полевым шлюзом с помощью протоколов, поддерживаемых устройствами. Полевой шлюз взаимодействует с центром IoT с помощью протокола, поддерживаемого центром IoT. Полевой шлюз может представлять собой специализированное оборудование или маломощный компьютер с программным обеспечением, которое выполняет полный сценарий действий шлюза.

Полевой шлюз отличается от обычного маршрутизатора трафика (например, устройства преобразования сетевых адресов (NAT) или брандмауэра) тем, что ему отведена активная роль в управлении доступом и потоком информации в решении. Например, полевой шлюз может выполнять следующие задачи.

- **Добавить поддержку для новых и устаревших устройств**: существуют миллионы новых и устаревших датчиков и приводов, которые не могут отправлять данные непосредственно в облако. Эти устройства либо используют протокол, не подходящий для Интернета, либо не реализуют шифрование, либо не могут хранить сертификаты удостоверений. Использование шлюза снижает нагрузку и уменьшает стоимость подключения этих устройств.
- **Выполнить анализ операций**: существует множество операций, которые можно выполнить локально, чтобы уменьшить обмен данных с облаком. К таким операциям относятся фильтрация, пакетная обработка и сжатие данных. Также может возникнуть необходимость выполнения некоторых вычислений, например очистки данных или оценки модели машинного обучения с данными в режиме реального времени в локальной среде.
- **Минимизировать задержку**: когда вы пытаетесь предотвратить отключение производственной линии или восстановить электропитание, важны миллисекунды. Анализ данных рядом с устройством для сбора данных позволит предотвратить аварию и избежать масштабного системного сбоя.
- **Сэкономить пропускную способность сети**: типичная нефтедобывающая платформа создает от 1 ТБ до 2 ТБ данных каждый день. Boeing 787 создает 500 ГБ данных за каждый рейс. Передавать большие объемы данных из тысяч или сотен тысяч пограничных устройств в облако непрактично. К тому же это не требуется, поскольку для многих операций анализа не требуется обработка и хранение данных на уровне облака.
- **Работать надежно**: данные IoT все чаще используются для решений, касающихся безопасности граждан и важной инфраструктуры. На целостность и доступность инфраструктуры и данных не могут отрицательно влиять периодические подключения и отключения от облака. Храня, собирая и обрабатывая данные локально и затем при необходимости отправляя их в облако, можно создавать надежные решения.
- **Решить вопросы безопасности и конфиденциальности**: устройства IoT и данные, которые они создают, должны быть защищены. Шлюзы могут предоставлять услуги, например изоляцию устройств от Интернета, предоставление служб шифрования и идентификации для устройств, которые не могут предоставить эти услуги, защиту данных, которые накоплены или сохранены локально, и удаление персональных сведений перед отправкой данных в Интернет.

### Дополнительные рекомендации

Для реализации полевого шлюза можно использовать [пакеты SDK для IoT Azure][lnk-gateway-sdk]. Эти пакеты SDK для устройств предлагают определенные функции, такие как возможность мультиплексировать обмен данными из нескольких устройств в рамках одного и того же подключения к центру IoT.

## Настраиваемая проверка подлинности устройства

[Реестр удостоверений устройств][lnk-devguide-identityregistry] центра IoT позволяет настроить контроль доступа и учетные данные безопасности для каждого устройства с помощью [маркеров][lnk-sas-token]. Если в решение IoT уже были вложены значительные средства для реализации настраиваемого реестра удостоверений устройств и (или) схемы проверки подлинности, эту инфраструктуру можно интегрировать в центр IoT. Для этого нужно создать *службу маркеров*. Таким образом можно использовать и другие функции IoT в решении.

Служба маркеров — это пользовательская облачная служба. Она использует *политику общего доступа центра IoT* с разрешениями **DeviceConnect** для создания маркеров *уровня устройства*. Эти маркеры позволяют устройству подключиться к центру IoT.

  ![Этапы для схемы службы маркеров.][img-tokenservice]

Ниже приведены основные этапы для схемы службы маркеров.

1. Создание [политики общего доступа центра IoT][lnk-devguide-security] с разрешениями **DeviceConnect** для вашего центра IoT. Эту политику можно создать на [портале Azure][lnk-portal] или программными средствами. Эту политику служба маркеров будет использовать для подписания создаваемых маркеров.
2. Когда устройству требуется доступ к центру IoT, оно запрашивает у службы маркеров подписанный маркер. Для определения удостоверения устройства, используемого службой маркеров для создания маркера, устройство может использовать настраиваемую схему проверки подлинности или реестр удостоверений устройств.
3. Служба маркеров возвращает маркер. Маркер создается пользователем согласно [требованиям к безопасности, описанным в руководстве для разработчиков центра IoT][lnk-devguide-security]. `/devices/{deviceId}` используется как `resourceURI`, а в качестве `deviceId` указывается устройство, подлинность которого проверяется. Служба маркеров использует политики общего доступа для создания маркера.
4. Устройство использует маркер для подключения к центру IoT.

> [AZURE.NOTE] Для создания маркера в службе маркеров можно использовать класс .NET [SharedAccessSignatureBuilder][lnk-dotnet-sas] или класс Java [IotHubServiceSasToken][lnk-java-sas].

При необходимости служба маркеров может задать срок действия маркера. По истечении срока действия маркера центр IoT разрывает подключение к устройству. После этого устройство должно запросить новый маркер у службы маркеров. Короткий срок действия увеличит нагрузку как на устройство, так и на службу маркеров.

Кроме того, чтобы устройство могло подключаться к вашему центру, его необходимо добавить в реестр удостоверений устройств центра IoT, даже если для подключения устройство использует маркер, а не ключ. Поэтому контроль доступа на уровне отдельных устройств путем включения или отключения удостоверений устройств в разделе [Реестр удостоверений центра IoT][lnk-devguide-identityregistry] продолжает работать, если устройство проходит проверку подлинности с помощью маркера. Это уменьшает риск существования маркеров с длительным сроком действия.

### Сравнение с настраиваемым шлюзом

Вариант со службой маркеров является рекомендованным способом внедрения настраиваемого реестра удостоверений или схемы проверки подлинности с использованием центра IoT. Причина состоит в том, что так центр IoT продолжает обрабатывать большую часть трафика решения. Однако существуют случаи, когда настраиваемая схема проверки подлинности настолько тесно переплетена с протоколом, что для обработки всего трафика требуется отдельная служба (*настраиваемый шлюз*). В качестве примера можно привести [Протокол безопасности транспортного уровня (TLS) и предварительные общие ключи (PSK)][lnk-tls-psk]. Дополнительные сведения см. в разделе [Шлюз протокола][lnk-protocols].

## Пульс устройства <a id="heartbeat"></a>

В [реестре удостоверений центра IoT][lnk-devguide-identityregistry] есть поле **connectionState**. Поле **connectionState** используется только в процессе разработки и отладки. Во время выполнения решения IoT не должны запрашивать это поле (например, чтобы проверить подключение устройства и сделать выбор между сообщением из облака на устройство и SMS). Если решению IoT необходимо определять, подключено ли устройство (во время выполнения либо с более высокой точностью, чем позволяет свойство **connectionState**), в него необходимо внедрить *шаблон пульса*.

При использовании шаблона пульса устройство отправляет сообщения с устройства в облака с заданной периодичностью (например не реже, чем каждый час). Если отправка данных при этом не требуется, устройство отправляет с устройства в облака пустое сообщение (обычно содержащее свойство, идентифицирующее его как пульс). На стороне службы решение хранит карту последнего пульса, полученного по каждому устройству, и сообщает о проблеме, если устройство не получает сообщение пульса в ожидаемое время.

Более сложные варианты могут включать в себя данные [мониторинга операций][lnk-devguide-opmon], позволяющие определять, какие устройства пытаются, но не могут установить подключение. Внедряя в решение шаблон пульса, учитывайте [квоты и ограничения центра IoT][].

> [AZURE.NOTE] Если состояние подключения устройства нужно решению IoT исключительно для того, чтобы определить, отправлять ли сообщения из облака на устройство, и сообщения не вещаются на большие наборы устройств, то следует рассмотреть заметно более простой способ — использовать небольшое время окончания срока действия. Это позволяет добиться того же результата, что и обслуживание реестра состояний подключения устройств, действующего по принципу пульса, но со значительно большей эффективностью. Запрашивая подтверждения сообщений у центра IoT, также можно узнать, какие устройства могут получать сообщения, а какие находятся не в сети или в неработоспособны. Дополнительные сведения о сообщениях C2D см. в [руководстве разработчика по центру IoT][lnk-devguide-messaging].

## Дальнейшие действия

Дополнительные сведения о планировании развертывания центра IoT см. в следующих руководствах:

- [Поддержка MQTT в центре IoT][lnk-mqtt]
- [Поддерживаемые устройства][lnk-devices]
- [Поддержка дополнительных протоколов для центра IoT][lnk-protocols]
- [Сравнение центра IoT и концентраторов событий][lnk-compare]
- [Масштабирование центра IoT][lnk-scaling]

Для дальнейшего изучения возможностей центра IoT см. следующие статьи:

- [Руководство разработчика по центру Azure IoT (IoT — Интернет вещей)][lnk-devguide]
- [Обзор управления устройствами центра IoT с помощью примера пользовательского интерфейса][lnk-dmui]
- [Пакет SDK для шлюза IoT (бета-версия): отправка сообщений с устройства в облако через виртуальное устройство с помощью Linux][lnk-gateway]
- [Управление центрами IoT через портал Azure][lnk-portal-manage]
- [Все аспекты безопасности решения IoT][lnk-securing]

[img-tokenservice]: ./media/iot-hub-guidance/tokenservice.png

[lnk-devguide-identityregistry]: iot-hub-devguide.md#identityregistry
[lnk-devguide-opmon]: iot-hub-operations-monitoring.md

[lnk-devguide-security]: iot-hub-devguide.md#security
[lnk-tls-psk]: https://tools.ietf.org/html/rfc4279

[lnk-portal]: https://portal.azure.com
[lnk-devguide-messaging]: iot-hub-devguide.md#messaging
[lnk-dotnet-sas]: https://msdn.microsoft.com/library/microsoft.azure.devices.common.security.sharedaccesssignaturebuilder.aspx
[lnk-java-sas]: http://azure.github.io/azure-iot-sdks/java/service/api_reference/com/microsoft/azure/iot/service/auth/IotHubServiceSasToken.html
[квоты и ограничения центра IoT]: iot-hub-devguide.md#throttling
[lnk-gateway-sdk]: https://github.com/Azure/azure-iot-gateway-sdk

[lnk-mqtt]: iot-hub-mqtt-support.md
[lnk-devices]: iot-hub-tested-configurations.md
[lnk-protocols]: iot-hub-protocol-gateway.md
[lnk-compare]: iot-hub-compare-event-hubs.md
[lnk-scaling]: iot-hub-scaling.md
[lnk-devguide]: iot-hub-devguide.md
[lnk-dmui]: iot-hub-device-management-ui-sample.md
[lnk-gateway]: iot-hub-linux-gateway-sdk-simulated-device.md
[lnk-portal-manage]: iot-hub-manage-through-portal.md
[lnk-sas-token]: iot-hub-sas-tokens.md
[lnk-securing]: iot-hub-security-ground-up.md

<!---HONumber=AcomDC_0727_2016-->