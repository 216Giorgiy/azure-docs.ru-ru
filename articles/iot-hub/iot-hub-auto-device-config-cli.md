---
title: Настройка и мониторинг устройств Интернета вещей в масштабе с помощью Центра Интернета вещей (CLI) Azure | Документация Майкрософт
description: Использование автоматических конфигураций устройств Центра Интернета вещей Azure для назначения конфигурации нескольким устройствам
author: ChrisGMsft
manager: bruz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 04/13/2018
ms.author: chrisgre
ms.openlocfilehash: f81ef3c231874f314d6fe023ba247a0bcff61e90
ms.sourcegitcommit: a2ae233e20e670e2f9e6b75e83253bd301f5067c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2018
ms.locfileid: "42143854"
---
# <a name="configure-and-monitor-iot-devices-at-scale-using-the-azure-cli"></a>Настройка и мониторинг устройств Центра Интернета вещей в масштабе с помощью Azure CLI

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в Центре Интернета вещей Azure автоматизирует многие повторяющиеся и сложные задачи управления большим парком устройств на протяжении всего их жизненного цикла. Благодаря автоматическому управлению устройствами вы можете указать нужный набор устройств на основе их свойств, определить желаемую конфигурацию и позволить Центру Интернета вещей обновлять устройства, когда они попадают в область.  Это выполняется с использованием автоматической конфигурации устройства, которая также позволят вам подытожить завершение и соответствие требованиям, обрабатывать слияние и конфликты и развертывать конфигурации с помощью поэтапного подхода.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматические конфигурации устройств работают, обновляя набор двойников устройств с указанием требуемых свойств и предоставляя сводку на основе сообщаемых свойств двойников устройств.  В результате производится новый класс и документ JSON, называемый *Configuration*, который состоит из трех частей:

* **Целевое условие** определяет область обновляемых двойников устройств. Целевое условие задается как запрос в тегах двойников устройств или как сообщаемые свойства.

* **Целевое содержимое** определяет требуемые свойства, которые необходимо добавить или обновить в целевых двойниках устройств. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются как запросы в сообщаемых свойствах двойников устройств.  Системные метрики — это метрики по умолчанию, которые измеряют состояние обновления двойника, например количество целевых двойников и количество двойников, которые были успешно обновлены. 

## <a name="cli-prerequisites"></a>Технические условия CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure. 
* [Azure CLI 2.0](https://docs.microsoft.com/cli/azure/install-azure-cli) в среде. Вам понадобится как минимум Azure CLI 2.0 версии 2.0.24 или более поздней. Для проверки используйте `az –-version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack. 
* [Расширение Интернета вещей для Azure CLI 2.0](https://github.com/Azure/azure-iot-cli-extension).

## <a name="implement-device-twins-to-configure-devices"></a>Реализация двойников устройств для настройки устройств

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  Руководство по использованию двойников устройств см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием конфигурации необходимо указать устройства, на которые вы хотите повлиять. Центр Интернета вещей Azure определяет устройства с помощью тегов в двойнике устройства. Каждое устройство может иметь несколько тегов. Их можно определить любым способом, который лучше всего подходит для вашего решения. Например, если вы управляете устройствами в разных расположениях, вы можете добавить следующие теги в двойник устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="define-the-target-content-and-metrics"></a>Определение целевого содержимого и метрик

Целевое содержимое и запросы метрики указываются в виде документов JSON, которые описывают свойства установки и передаваемые свойства измерения двойника устройства.  Для создания автоматической конфигурации устройства, используя интерфейс командной строки Azure 2.0, сохраните локально содержимое назначения и метрики в формате ТХТ. При запуске команды, чтобы применить конфигурацию к устройству, используйте путь к файлу, приведенный в следующем разделе. 

Ниже приведен пример основного целевого содержимого.

```json
{
  "content": {
    "deviceContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Ниже приведены примеры запросов метрики.

```json
{
  "queries": {
    "Compliant": "select deviceId from devices where configurations.[[chillersettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'",
    "Error": "select deviceId from devices where configurations.[[chillersettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='error'",
    "Pending": "select deviceId from devices where configurations.[[chillersettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='pending'"
  }
}
```

## <a name="create-a-configuration"></a>Создание конфигурации

Создавая конфигурацию, состоящую из целевого содержимого и метрик, вы настраиваете целевые устройства. 

Создайте конфигурацию с помощью следующей команды.

```cli
   az iot hub configuration create --config-id [configuration id] \
     --labels [labels] --content [file path] --hub-name [hub name] \
     --target-condition [target query] --priority [int] \
     --metrics [metric queries]
```

* --**config-id** — имя конфигурации, которая будет создана в центре IoT. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

* --**labels** — добавление меток для облегчения отслеживания конфигураций. Метка представляет собой пару имя и значение, которые описывают развертывание. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

* --**content** — встроенный JSON или путь к целевому содержимому, которому должны быть заданы двойные требуемые свойства. 

* --**hub-name** — имя центра IoT, в котором будет создана конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

* --**target-condition** — введите целевое условие, чтобы определить, для каких устройств будет предназначена эта конфигурация. Условие основывается на тегах двойника устройства и (или) его требуемых свойствах и должно соответствовать формату выражения. Например, `tags.environment='test'` или `properties.desired.devicemodel='4000x'`. 

* --**priority** — положительные целые числа. Если одному устройству назначены две или более конфигурации, будет применяться конфигурация с самым высоким числовым значением параметра Priority.

* --**metrics** — путь к запросам метрик. Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров. 

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы отобразить содержимое конфигурации, используйте следующую команду.

```cli
az iot hub configuration show --config-id [configuration id] \
  --hub-name [hub name]
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

Проверьте конфигурацию в командном окне. Свойство **metrics** перечисляет количество каждой метрики, которое оценивается каждым центром.

* **targetedCount** — это система метрики, которая определяет количество двойников устройств в Центре Интернета вещей, которые соответствуют условию назначения.

* **appliedCount** — это система метрики, которая определяет количество устройств, в которых применено целевое содержимое.

* **Your custom metric** — любые определенные пользователем метрики будут считаться пользовательскими метриками.

Вы можете отобразить список идентификаторов устройств или объектов для каждого из показателей, используя следующую команду.

```cli
az iot hub configuration show-metric --config-id [configuration id] \
   --metric-id [metric id] --hub-name [hub name] --metric-type [type] 
```

* --**config-id** — имя существующего развертывания в центре IoT.

* --**metric-id** — имя метрики, для которой нужно отобразить список идентификаторов устройств, например `appliedCount`.

* --**hub-name** — имя центра IoT, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**metric-type** — возможные значения типа метрики: `system` или `user`.  Метрики систем: `targetedCount` и `appliedCount`. Все другие метрики — это пользовательские метрики.

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:

* Если двойник устройства не соответствует предыдущему условию назначения, однако соответствует новому и эта конфигурация имеет самый высокий приоритет для двойника устройства, то она будет применена к двойнику устройства. 

* Если двойник устройства больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойник устройства будет изменен с помощью следующей конфигурации с наивысшим приоритетом. 

* Если двойник устройства, работающий в настоящее время в этой конфигурации, больше не удовлетворяет целевому условию и не соответствует целевому условию любых других конфигураций, параметры из конфигурации будут удалены и никакие другие изменения не будут сделаны в двойнике. 

Обновите конфигурацию с помощью следующей команды.

```cli
az iot hub configuration update --config-id [configuration id] \
   --hub-name [hub name] --set [property1.property2='value']
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**set** — обновление свойства в конфигурации. Можно обновлять следующие свойства.

    * targetCondition — например `targetCondition=tags.location.state='Oregon'`

    * метки; 

    * priority

## <a name="delete-a-configuration"></a>Удаление конфигурации

Когда вы удаляете конфигурацию, все двойники устройств принимают следующую конфигурацию с самым высоким приоритетом. Если двойники устройств не соответствуют целевому условию любой другой конфигурации, то другие параметры не применяются. 

Удалите конфигурацию с помощью следующей команды.

```cli
az iot hub configuration delete --config-id [configuration id] \
   --hub-name [hub name] 
```
* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

## <a name="next-steps"></a>Дополнительная информация

В этой статье вы узнали, как настроить и отслеживать устройства Центра Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Общие сведения о метриках Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure](/azure/iot-dps)
