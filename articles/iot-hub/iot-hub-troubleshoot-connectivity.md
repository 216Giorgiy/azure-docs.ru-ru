---
title: Диагностирование отключений от Центра Интернета вещей и устранение неполадок
description: Сведения о диагностировании и устранении распространенных ошибок с подключением устройств к Центру Интернета вещей
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 07/19/2018
ms.author: jlian
ms.openlocfilehash: eb186f4b6e1d742c9cae51e68b3d3dbda1bb751c
ms.sourcegitcommit: d4c076beea3a8d9e09c9d2f4a63428dc72dd9806
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/01/2018
ms.locfileid: "39400157"
---
# <a name="detect-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Обнаружение отключений от Центра Интернета вещей и устранение неполадок

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложения на стороне устройства, физические сети, протоколы, оборудование и Центр Интернета вещей могут быть причиной проблем. В этом документе содержатся рекомендации по обнаружению и устранению неполадок, связанных с подключением устройств, на стороне облака, а не на стороне устройства.

## <a name="get-alerts-and-error-logs"></a>Получение оповещений и журналов ошибок

Azure Monitor можно использовать, чтобы получать оповещения и делать записи в журналах при отключении устройства.

### <a name="turn-on-diagnostic-logs"></a>Включение журналов диагностики 

Чтобы записывать в журнал события и ошибки с подключением устройства, включите диагностику для Центра Интернета вещей. 

1. Войдите на [портале Azure](https://portal.azure.com).
1. Перейдите в Центр Интернета вещей.
1. Выберите **Параметры диагностики**.
1. Затем выберите **Turn on diagnostics** (Включить диагностику).
1. Включите сбор данных журналов **подключений**. 
1. Чтобы упростить анализ, включите параметр **Send to Log Analytics** (Отправить в Log Analytics) ([см. сведения о ценах](https://azure.microsoft.com/pricing/details/log-analytics/)). В приведенном ниже примере используется Log Analytics.

   ![Рекомендуемые параметры][2]

Дополнительные сведения см. в статье [Мониторинг работоспособности Центра Интернета вещей Azure и быстрая диагностика неполадок](iot-hub-monitor-resource-health.md).

### <a name="set-up-alerts-for-the-connected-devices-count-metric"></a>Настройка оповещений о метриках для подключенных устройств

Чтобы получать предупреждения при отключении устройств, настройте оповещения для метрики *Подключенные устройства*. 

1. Войдите на [портале Azure](https://portal.azure.com).
1. Перейдите в Центр Интернета вещей.
1. Выберите **Оповещения (классические)**.
1. Щелкните **Добавить оповещение метрики (классическое)**.
1. Заполните форму и нажмите кнопку **ОК**. 

   ![Рекомендуемое оповещение метрики][3]

Дополнительные сведения см. в статье [Что такое классические оповещения в Microsoft Azure?](../monitoring-and-diagnostics/monitoring-overview-alerts.md)

## <a name="resolve-common-connectivity-errors"></a>Устранение распространенных ошибок подключения

Если журналы диагностики и оповещения для подключенных устройств включены, в случае сбоя вы получите предупреждение. В этом разделе описано, как устранить распространенные проблемы, когда вы получите предупреждение. В приведенных ниже шагах предполагается, что вы настроили Log Analytics для своих журналов диагностики. 

1. Перейдите в рабочую область для **Log Analytics** на портале Azure.
1. Щелкните **Поиск по журналам**.
1. Чтобы изолировать журналы ошибок подключения для Центра Интернета вещей, введите этот запрос в поле, а затем щелкните **Запустить**.

    ```
    search *
    | where ( Type == "AzureDiagnostics" and ResourceType == "IOTHUBS")
    | where ( Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок][4]

1. Сведения в этой таблице помогут вам понять и устранить распространенные ошибки.

    | Ошибка | Первопричина | Способы устранения: |
    |---------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | 404104 DeviceConnectionClosedRemotely | Подключение было закрыто устройством, но Центру Интернета вещей причина неизвестна. Общие причины: истекло время ожидания протоколов MQTT и AMQP, а также потеря сетевых подключений. | Убедитесь, что устройство может подключиться к Центру Интернета вещей с помощью [проверки подключения](tutorial-connectivity.md). Если с подключением все в порядке, но устройство время от времени отключается, убедитесь, что вы используете правильную логику поддержания подключения устройства для выбранного протокола (MQTT/AMPQ). |
    | 401003 IoTHubUnauthorized | Центру Интернета вещей не удалось выполнить проверку подлинности подключения. | Убедитесь, что срок действия SAS или другого используемого маркера безопасности не истек. [Пакеты SDK для Azure IoT](iot-hub-devguide-sdks.md) автоматически создают маркеры без специальной настройки. |
    | 409002 LinkCreationConflict | Для одного и того же устройства существует несколько подключений. Когда для устройства появляется новый запрос на подключение, Центр Интернета вещей закрывает предыдущее с этой ошибкой. | Выполняйте новый запрос на подключение, только если подключение закрыто. |
    | 500001 ServerError | В Центре Интернета вещей возникла ошибка на стороне сервера. Скорее всего, эта ошибка временная. Пока команда Центра Интернета вещей работает над поддержкой гарантий [Соглашения об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/iot-hub/), в работе небольших подмножеств узлов Центра Интернета вещей иногда могут возникать сбои. Если устройство пытается подключиться к узлу со сбоем, возникает эта ошибка. | Чтобы устранить временную ошибку, повторно выполните попытку подключения с устройства. Чтобы [автоматически управлять повторами](iot-hub-reliability-features-in-sdks.md), используйте последнюю версию [пакетов SDK для Azure IoT](iot-hub-devguide-sdks.md).<br><br>Рекомендации по исправлению временных ошибок и повторном подключении см. в [этой статье](/azure/architecture/best-practices/transient-faults.md).  <br><br>Если проблема повторится после повторного подключения, проверьте параметр [Работоспособность ресурсов](iot-hub-monitor-resource-health.md#use-azure-resource-health) и [Состояние Azure](https://azure.microsoft.com/status/history/), чтобы узнать, нет ли известной проблемы в работе Центра Интернета вещей. Если такой проблемы нет, но ошибка не устранена, [обратитесь в службу поддержки](https://azure.microsoft.com/support/options/) для дальнейшего исследования. |
    | 500008 GenericTimeout | Центру Интернета вещей не удалось завершить запрос на подключение до истечения времени ожидания. Подобно 500001 ServerError, эта ошибка, скорее всего, временная. | Выполните инструкции по устранению неполадок для ошибки 500001 ServerError, чтобы определить первопричину и устранить эту ошибку.|

## <a name="other-steps-to-try"></a>Дополнительные шаги

Если приведенные выше шаги не помогли, попробуйте еще несколько вариантов:

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.
* Убедитесь, что ваши устройства **включены**. На портале Azure выберите "Центр Интернета вещей > Устройства IoT".
* Получите помощь на форуме [Центра Интернета вещей Azure](https://social.msdn.microsoft.com/Forums/azure/home?forum=azureiothub), [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или от [службы поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий ниже, если сведения в этом руководстве не были полезны.

<!-- Images -->
[1]: ../../includes/media/iot-hub-diagnostics-settings/turnondiagnostics.png
[2]: ./media/iot-hub-troubleshoot-connectivity/diagnostic-settings-recommendation.png
[3]: ./media/iot-hub-troubleshoot-connectivity/metric-alert.png
[4]: ./media/iot-hub-troubleshoot-connectivity/diag-logs.png
