<properties
 pageTitle="Создание маркеров безопасности центра IoT | Microsoft Azure"
 description="Описание различных типов маркеров безопасности, используемых центром IoT, и процедуры их создания."
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="03/02/2016"
 ms.author="elioda"/>

# Использование маркеров безопасности центра IoT

Центр IoT использует маркеры безопасности для проверки подлинности устройств и служб, чтобы избежать отправки ключей по сети. Кроме того, маркеры безопасности ограничены по времени и области действия. [Пакеты SDK Azure для центра IoT][lnk-apis-sdks] автоматически создают маркеры без специальной конфигурации. Однако в некоторых случаях требуется, чтобы пользователь напрямую создал и использовал маркеры. В их число входит непосредственное использование AMQP, MQTT или HTTP или реализация шаблона службы маркеров, как описано в [руководстве по центру IoT][lnk-guidance-security].

Содержание статьи

* Формат маркеров безопасности и способы их создания.
* Основные варианты использования маркеров безопасности для проверки подлинности устройств и серверных служб.

## Структура маркера безопасности
Маркеры безопасности используются для предоставления устройствам и службам ограниченного по времени доступа к определенным функциям в центре IoT. Чтобы гарантировать подключение только авторизованных устройств и служб, маркеры безопасности должны быть подписаны с помощью ключа политики общего доступа или симметричного ключа, сохраненного с удостоверением устройства в реестре удостоверений.

Маркер, подписанный с помощью ключа политики общего доступа, предоставляет доступа ко всем функциям, связанным с разрешениями политики общего доступа. См. [раздел "Безопасность" руководства для разработчиков центра IoT][lnk-devguide-security]. С другой стороны, маркер, подписанный с помощью симметричного ключа удостоверения устройства, предоставляет только разрешение **DeviceConnect** для связанного удостоверения устройства.

Маркер безопасности имеет следующий формат:

    SharedAccessSignature sig={signature-string}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}

Это ожидаемые значения:

| Значение | Описание |
| ----- | ----------- |
| {signature} | Строка подписи HMAC-SHA256 формата `{URL-encoded-resourceURI} + "\n" + expiry`. **Важно!** Ключ шифруется в кодировке base64 и используется для вычислений HMAC-SHA256. |
| {resourceURI} | Начинающийся с имени узла центра IoT \(без протокола\) префикс URI \(по сегменту\) для конечных точек, доступ к которым можно получить с помощью этого маркера. Например, `myHub.azure-devices.net/devices/device1` |
| {expiry} | Строки в формате UTF8, отображающие количество секунд с начала эры 00:00:00 \(в формате UTC\) 1 января 1970 г. |
| {URL-encoded-resourceURI} | Строчное URL-кодирование строчного URL ресурса |
| {policyName} | Имя политики общего доступа, к которой относится этот маркер. Отсутствует, если маркеры относятся к учетным данным реестра устройства. |

**Обратите внимание**, что префикс универсального кода ресурса \(URI\) вычисляется по сегменту, а не по символу. Например, `/a/b` — это префикс для `/a/b/c`, а не для `/a/bc`.

Это функция Node, которая вычисляет маркер на основе входных данных `resourceUri, signingKey, policyName, expiresInMins`. В следующих разделах будет показано, как инициализировать различные входные данные для различных сценариев использования маркеров.

    var crypto = require('crypto');

    var generateSasToken = function(resourceUri, signingKey, policyName, expiresInMins) {
        resourceUri = encodeURIComponent(resourceUri.toLowerCase()).toLowerCase();

        // Set expiration in seconds
        var expires = (Date.now() / 1000) + expiresInMins * 60;
        expires = Math.ceil(expires);
        var toSign = resourceUri + '\n' + expires;

        // using crypto
        var decodedPassword = new Buffer(signingKey, 'base64').toString('binary');
        const hmac = crypto.createHmac('sha256', decodedPassword);
        hmac.update(toSign);
        var base64signature = hmac.digest('base64');
        var base64UriEncoded = encodeURIComponent(base64signature);

        // construct autorization string
        var token = "SharedAccessSignature sr=" + resourceUri + "&sig="
        + base64UriEncoded + "&se=" + expires;
        if (policyName) token += "&skn="+policyName;
        // console.log("signature:" + token);
        return token;
    };

> [AZURE.NOTE] Поскольку срок действия маркера проверяется на компьютерах центра IoT, важно обеспечить минимальное смещение на часах компьютера, где создается маркер.

## Использование маркеров SAS в качестве устройства

Существует два способа получения разрешений **DeviceConnect** для центра IoT с маркерами безопасности: с помощью ключа удостоверения устройства или ключа политики общего доступа.

Кроме того, следует отметить, что все функциональные возможности, доступные с устройств, намеренно предоставляются в конечных точках с префиксом `/devices/{deviceId}`.

> [AZURE.IMPORTANT] Единственный способ проверки подлинности конкретного устройства в центре IoT предполагает использование симметричного ключа удостоверения устройства. В случаях, когда для доступа к функциям устройства применяется политика общего доступа, решение должно считать компонент, который выдает маркер безопасности, доверенным компонентом.

Далее указаны конечные точки, доступные с устройства \(вне зависимости от протокола\).

| Конечная точка | Функции |
| ----- | ----------- |
| `{iot hub host name}/devices/{deviceId}/messages/events` | Отправка сообщений с устройства в облако. |
| `{iot hub host name}/devices/{deviceId}/devicebound` | Получение сообщений из облака на устройство. |

### Использование симметричного ключа в реестре удостоверений

Если для создания маркера используется симметричный ключ удостоверения устройства, элемент policyName \(`skn`\) пропускается.

Например, маркер, созданный для доступа ко всем функциям устройства, должен иметь следующие параметры:

* URI ресурса: `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписи: любой симметричный ключ для удостоверения `{device id}`;
* имя политики не требуется;
* время окончания срока действия.

Далее приведен пример использования функции Node:

    var endpoint ="myhub.azure-devices.net/devices/device1";
    var deviceKey ="...";

    var token = generateSasToken(endpoint, deviceKey, null, 60);

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697

> [AZURE.NOTE] Можно создать маркер безопасности с помощью средства .NET —[обозревателя устройств][lnk-device-explorer].

### Использование политики общего доступа

При создании маркера из политики общего доступа в поле имени политики `skn` должно быть указано имя используемой политики. Также требуется, чтобы эта политика предоставляла разрешение **DeviceConnect**.

Существует два основных сценария использования политик общего доступа для доступа к возможностям устройств:

* [облачный шлюз протоколов][lnk-azure-protocol-gateway],
* [службы маркеров][lnk-devguide-security], используемые для реализации настраиваемых схем проверки подлинности.

Так как политика общего доступа может предоставлять доступ для подключения в качестве любого устройства, при создании маркеров безопасности важно использовать правильный URI ресурса. Этот момент имеет особое значение для служб маркеров, которые должны определять область действия маркера для конкретного устройства с помощью URI ресурса. Он менее критичен для шлюзов протоколов, так как они уже обрабатывают трафик для всех устройств.

Например, служба маркеров, использующая предварительно созданную политику общего доступа с именем **device**, создаст маркер со следующими параметрами:

* URI ресурса: `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписи: один из ключей политики `device`;
* имя политики: `device`;
* время окончания срока действия.

Далее приведен пример использования функции Node:

    var endpoint ="myhub.azure-devices.net/devices/device1";
    var policyName = 'device';
    var policyKey = '...';

    var token = generateSasToken(endpoint, policyKey, policyName, 60);

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697&skn=device

Шлюз протокола может использовать этот же маркер для всех устройств, задав `myhub.azure-devices.net/devices` в качестве URI ресурса.

## Использование маркеров безопасности из компонентов службы

Компоненты служб могут создавать маркеры безопасности с помощью политик общего доступа, предоставляющих соответствующие разрешения, как описано в [разделе по безопасности в руководстве разработчика центра IoT][lnk-devguide-security].

Ниже приведены функции службы, предоставляемые в конечных точках.

| Конечная точка | Функции |
| ----- | ----------- |
| `{iot hub host name}/devices` | Создание, обновление, извлечение и удаление удостоверений устройств. |
| `{iot hub host name}/messages/events` | Получение сообщений с устройства в облако. |
| `{iot hub host name}/servicebound/feedback` | Получение ответа на сообщения, отправляемые из облака на устройство. |
| `{iot hub host name}/devicebound` | Отправка сообщений из облака на устройство. |

Например, служба, использующая предварительно созданную политику общего доступа с именем **device**, создаст маркер со следующими параметрами:

* URI ресурса: `{IoT hub name}.azure-devices.net/devices`;
* ключ подписи: один из ключей политики `registryRead`;
* имя политики: `registryRead`;
* время окончания срока действия.

    var endpoint ="myhub.azure-devices.net/devices"; var policyName = 'device'; var policyKey = '...';

    var token = generateSasToken\(endpoint, policyKey, policyName, 60\);

Результат, предоставляющий доступ для чтения всех идентификаторов устройств, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices&sig=JdyscqTpXdEJs49elIUCcohw2DlFDR3zfH5KqGJo4r4%3D&se=1456973447&skn=registryRead


[lnk-apis-sdks]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md
[lnk-guidance-security]: iot-hub-guidance.md#customauth
[lnk-devguide-security]: iot-hub-devguide.md#security
[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdks/blob/master/tools/DeviceExplorer/doc/how_to_use_device_explorer.md

<!---HONumber=AcomDC_0413_2016-->