---
title: "Общие сведения об обмене сообщениями в Центре Интернета вещей Azure | Документация Майкрософт"
description: "Руководство разработчика для Центра Интернета вещей. Обмен сообщениями между устройством и облаком. Содержит сведения о форматах сообщений и поддерживаемых протоколах связи."
services: iot-hub
documentationcenter: .net
author: dominicbetts
manager: timlt
editor: 
ms.assetid: 3fc5f1a3-3711-4611-9897-d4db079b4250
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/02/2017
ms.author: dobett
translationtype: Human Translation
ms.sourcegitcommit: eeb56316b337c90cc83455be11917674eba898a3
ms.openlocfilehash: ac3f4d2220c1902f00049ce237468ddee992209d
ms.lasthandoff: 04/03/2017


---
# <a name="send-and-receive-messages-with-iot-hub"></a>Отправка и получение сообщений в Центре Интернета вещей
## <a name="overview"></a>Обзор
Центр Интернета вещей предоставляет следующие примитивы обмена сообщениями для взаимодействия с устройством:

* [С устройства в облако][lnk-d2c]: с устройства во внутреннее приложение.
* [Из облака на устройство][lnk-c2d]: из внутреннего приложения (*службы* или *облака*).

Основные свойства функции обмена сообщениями в центре IoT — надежность и устойчивость сообщений. Эти свойства сохраняются, если на стороне устройства прерывается подключение и если наступает момент пиковой загрузки на стороне облака при обработке событий. Центр IoT гарантирует *как минимум однократную* доставку при двухстороннем обмене сообщениями между устройством и облаком.

Центр Интернета вещей поддерживает несколько [протоколов для устройств][lnk-protocols] (таких как MQTT, AMQP и HTTP). Для поддержки эффективного взаимодействия по протоколам Центр Интернета вещей задает [общий формат сообщений][lnk-message-format], поддерживаемый всеми протоколами для устройств.

Центр Интернета вещей предоставляет встроенную и [совместимую с концентраторами событий конечную точку][lnk-compatible-endpoint], с помощью которой внутренние приложения считывают сообщения, отправляемые в Центр с устройства в облако. Также можно создать пользовательские конечные точки в Центре Интернета вещей, связав с Центром другие службы в подписке.

### <a name="when-to-use"></a>Сценарии использования
Для отправки телеметрии и оповещений с учетом временных рядов из приложения для устройства используйте сообщения, отправляемые с устройства в облако, а для отправки односторонних уведомлений в приложение для устройства — сообщения, отправляемые из облака на устройство.

Дополнительные сведения см. в [руководстве по обмену данными, отправляемыми с устройства в облако][lnk-d2c-guidance], если сомневаетесь между использованием сообщаемых свойств, сообщений, отправляемых с устройства в облако, или передачей файла.
Чтобы принять решение об использовании требуемых свойств, прямых методов или сообщений, отправляемых из облака на устройство, см. сведения в [руководстве по обмену данными между облаком и устройством][lnk-c2d-guidance].

Сравнение службы Центра Интернета вещей со службой концентраторов событий см. в статье [Сравнение центра IoT и концентраторов событий][lnk-compare].

## <a name="device-to-cloud-messages"></a>Отправка сообщений с устройства в облако
Отправка сообщений с устройства в облако осуществляется через обращенную к устройству конечную точку (**/devices/{deviceId}/messages/events**). Затем правила маршрутизации направляют сообщения в одну из конечных точек, доступных для службы, в Центре Интернета вещей. Для определения маршрута правила маршрутизации используют свойства сообщений, отправляемых с устройства в облако, которые проходят через Центр. По умолчанию сообщения направляются во встроенную конечную точку, доступную для службы (/messages/events), которая совместима с [концентраторами событий][lnk-event-hubs]. Таким образом, чтобы получать сообщения, отправляемые из устройства в облако, можно использовать стандартную [интеграцию концентраторов событий и пакетов SDK][lnk-compatible-endpoint].

Для реализация отправки сообщений с устройства в облако Центр Интернета вещей использует модель потоковой передачи сообщений. Сообщения Центра Интернета вещей, отправляемые с устройства в облако, больше похожи на *события* [концентраторов событий][lnk-event-hubs], чем на *сообщения* [служебной шины][lnk-servicebus], где большое количество событий проходит через службу и может считываться несколькими модулями чтения.

Далее перечислены следствия этой реализации.

* Подобно событиям концентраторов событий, сообщения, отправляемые с устройства в облако, устойчивы и хранятся в конечной точке по умолчанию **messages/events** Центра Интернета вещей до семи дней.
* Подобно событиям концентраторов событий, размер сообщений, поступающих с устройства в облако, не может превышать 256 КБ, и их можно объединять в пакеты, чтобы оптимизировать отправку. Размер пакетов не может превышать 256 КБ.

При этом сообщения центра IoT, отправляемые с устройства в облако, и сообщения, отправляемые концентраторами событий, существенно различаются.

* Как объяснено в разделе [Управление доступом к Центру Интернета вещей][lnk-devguide-security], Центр Интернета вещей обеспечивает аутентификацию и контроль доступа для каждого устройства.
* В Центре Интернета вещей можно создать до 10 пользовательских конечных точек. Сообщения доставляются в конечные точки, исходя из маршрутов, настроенных в Центре Интернета вещей.
* Центр Интернета вещей позволяет одновременно подключать миллионы устройств (см. статью [Quotas and throttling][lnk-quotas] (Квоты и регулирование)), а концентраторы событий позволяют выполнять максимум 5000 подключений по протоколу AMQP в одном пространстве имен.
* Центр IoT не позволяет выполнять произвольное секционирование с помощью **PartitionKey**. Сообщения, отправляемые с устройства в облако, секционируются по исходному идентификатору **deviceId**.
* Масштабирование центра IoT немного отличается от масштабирования концентраторов событий. Дополнительные сведения см. в статье [Масштабирование центра IoT][lnk-guidance-scale].

Сведения об использовании обмена сообщениями между устройством и облаком см. в статье [Azure IoT SDKs][lnk-sdks] (Пакеты SDK для Azure IoT).

Дополнительные сведения о настройке маршрутизации сообщений см. в разделе [Правила маршрутизации](#routing-rules).

> [!NOTE]
> При использовании протокола HTTP для отправки сообщений с устройства в облако имена и значения свойств могут содержать только буквенно-цифровые знаки ASCII и знаки ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.
> 
> 

### <a name="non-telemetry-traffic"></a>Трафик, передающийся без использования телеметрии
Часто устройства отправляют не только точки данных телеметрии, но и сообщения и запросы, требующие отдельного выполнения и обработки в той части приложения, которая отвечает за бизнес-логику. Например, устройство отправляет критические оповещения, которые должны активировать определенное действие в серверной части. Можно легко создать правило маршрутизации для отправки таких сообщений в конечную точку, назначенную для их обработки.

Дополнительные сведения о том, как лучше всего обработать такие сообщения, см. в статье [Учебник: как обрабатывать сообщения, отправляемые с устройства центра IoT в облако, с помощью .Net][lnk-d2c-tutorial].

### <a name="routing-rules"></a>Правила маршрутизации

Центр Интернета вещей позволяет направлять сообщения в конечные точки Центра Интернета вещей, исходя из свойств этих сообщений. Правила маршрутизации обеспечивают гибкость, позволяя отправлять сообщения в нужном направлении без установки каких-либо дополнительных служб обработки сообщений или написания дополнительного кода. Каждое настраиваемое правило маршрутизации имеет следующие свойства:

* **Имя**. Уникальное имя, которое определяет правило.
* **Источник**. Источник потока данных, в отношении которого выполняются действия. Например, телеметрия устройства.
* **Условие**. Выражение запроса для правила маршрутизации, которое выполняется для свойств сообщения и используется для определения, соответствует ли сообщение конечной точке. Дополнительные сведения о создании условия маршрутизации см. в статье [Справочник по языку запросов Центр Интернета вещей для двойников устройств и заданий][lnk-devguide-query-language].
* **Конечная точка**. Имя конечной точки, в которую Центр Интернета вещей отправляет сообщения, соответствующие условию. Конечные точки должны находиться в одном регионе с Центром Интернета вещей, в противном случае может взиматься плата за межрегиональный трафик.

Одно сообщение может соответствовать условиям в нескольких правилах маршрутизации. В таких случаях Центр Интернета вещей доставляет сообщение в конечную точку, связанную с каждым из этих правил. Центр Интернета вещей также выполняет автоматическую дедупликацию доставки сообщений. То есть, если сообщение соответствует нескольким правилам, имеющим общее назначение, то оно записывается в это назначение только один раз.

Дополнительные сведения о создании пользовательских конечных точек в Центре Интернета вещей см. в статье [Руководство. Конечные точки Центра Интернета вещей][lnk-devguide-endpoints].

### <a name="built-in-endpoint-messagesevents"></a>Встроенная конечная точка: messages/events

Центр Интернета вещей позволяет управлять встроенной конечной точкой обмена сообщениями **messages/events**, совместимой с концентраторами событий, с помощью приведенных ниже свойств.

* **Количество секций**. Это свойство можно задать во время создания, чтобы определить количество [разделов][lnk-event-hub-partitions] для приема событий сообщений, отправляемых с устройства в облако.
* **Время хранения**. Это свойство задает время в днях, в течение которого сообщения хранятся в Центре Интернета вещей. Значение по умолчанию — один день, но это значение можно увеличить до семи дней.

Центр Интернета вещей также предоставляет возможность управлять группами потребителей во встроенной конечной точке, которая получает сообщения, отправляемые с устройства в облако.

По умолчанию все сообщения, которые явно не соответствуют правилу маршрутизации сообщений, записываются во встроенную конечную точку. Если отключить этот резервный маршрут, то сообщения, которые явно не соответствуют ни одному правилу маршрутизации сообщений, будут удаляться.

Вы можете изменить период хранения на [портале Azure][lnk-management-portal] или программно (с помощью [интерфейсов REST API поставщика ресурсов Центра Интернета вещей][lnk-resource-provider-apis]).

### <a name="anti-spoofing-properties"></a>Свойства для защиты от спуфинга
Чтобы избежать спуфинга устройств при работе с сообщениями, отправляемыми с устройства в облако, центр IoT отмечает все сообщения такими свойствами:

* **ConnectionDeviceId;**
* **ConnectionDeviceGenerationId;**
* **ConnectionAuthMethod.**

Первые два свойства содержат параметры **deviceId** и **generationId** исходного устройства (согласно разделу [Device identity properties][lnk-device-properties] (Свойства удостоверений устройств)).

Свойство **ConnectionAuthMethod** содержит сериализованный объект JSON, имеющий такие свойства:

```
{
  "scope": "{ hub | device}",
  "type": "{ symkey | sas}",
  "issuer": "iothub"
}
```

## <a name="cloud-to-device-messages"></a>Получение сообщений из облака на устройство
Сообщения из облака на устройство можно отправлять через конечную точку, обращенную к службе (**/messages/devicebound**). Устройства получают их через конечную точку конкретного устройства (**/devices/{deviceId}/messages/devicebound**).

Каждое сообщение, отправляемое из облака на устройство, адресовано отдельному устройству, то есть для свойства **to** задается значение **/devices/{deviceId}/messages/devicebound**.

> [!IMPORTANT]
> Одна очередь устройства содержит не более 50 сообщений, отправляемых из облака на устройство. Попытка отправить на устройство большее количество сообщений приведет к ошибке.
> 
> [!NOTE]
> При отправке сообщений из облака на устройство имена и значения свойств могут содержать только буквенно-цифровые знаки ASCII и знаки ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.
> 
> 

### <a name="message-lifecycle"></a>Жизненный цикл сообщения
Чтобы гарантировать как минимум однократную доставку, Центр Интернета вещей помещает в очереди устройств сообщения, отправляемые из облака на устройство. Сами устройства должны явно подтвердить *завершение* доставки, чтобы центр IoT мог удалить сообщения из очереди. Это гарантирует устойчивость к сбоям подключения и ошибкам устройств.

На следующей схеме показан жизненный цикл сообщений, отправляемых с облака в устройство.

![Жизненный цикл сообщений, отправляемых из облака на устройство][img-lifecycle]

Когда служба отправляет сообщение, считается, что оно *поставлено в очередь*. Когда устройству нужно *получить* сообщение, Центр Интернета вещей *блокирует* сообщение (устанавливает состояние **Невидимо**), чтобы другие потоки на том же устройстве начали получать другие сообщения. Когда поток устройства завершает обработку сообщения, он уведомляет центр IoT путем *завершения* сообщения.

Устройство также может:

* *отклонить* сообщение, в результате чего центр IoT переводит его в состояние **Deadlettered** (Не доставлено); Примечание. Устройства, подключающиеся по протоколу MQTT, не могут отклонять сообщения, отправляемые из облака на устройство.
* *прервать* сообщение, в результате чего центр IoT помещает его в очередь с состоянием **Enqueued**(Поставлено в очередь).

При обработке сообщения потоком может произойти ошибка без уведомления центра IoT. В этом случае состояние сообщения автоматически меняется с **Невидимо** на **Enqueued** (Поставлено в очередь) после *истечения срока видимости (или блокировки)*. Значение по умолчанию — одна минута.

Состояние сообщения может изменяться с **Enqueued** (Поставлено в очередь) на **Невидимо** и наоборот столько раз, сколько указано в свойстве **Максимальное число доставок** Центра Интернета вещей. После выполнения такого количества изменений Центр Интернета вещей устанавливает для сообщения состояние **Deadlettered** (Не доставлено). Таким же образом Центр Интернета вещей устанавливает для сообщения состояние **Deadlettered** (Не доставлено) после истечения срока действия сообщения (см. раздел [Срок действия сообщения (срок жизни)][lnk-ttl]).

Инструкции по сообщениям, отправляемым из облака на устройство, см. в статье [Учебник: как отправлять сообщения из облака на устройства с помощью центра IoT и .Net][lnk-c2d-tutorial]. Справочную информацию о том, как разные пакеты SDK для Azure IoT предоставляют функцию отправки сообщений из облака на устройство, см. в статье [Azure IoT SDKs][lnk-sdks] (Пакеты SDK для Azure IoT).

> [!NOTE]
> Обычно, если потеря сообщения, отправляемого с облака в устройство, никак не влияет на логику приложения, эти сообщения завершаются. Например, когда содержимое сообщения успешно сохранено в локальном хранилище, или когда операция успешно выполнена. Сообщение может также содержать временные сведения, потеря которых не влияет на функциональность приложения. Иногда при работе с долгосрочной задачей сообщение, отправляемое с облака в устройство, можно завершить после того, как описание задачи сохранится в локальном хранилище. После этого на различных этапах выполнения задачи в серверную часть решения отправляется одно или несколько сообщений (с устройства в облако).
> 
> 

### <a name="message-expiration-time-to-live"></a>Срок действия сообщения (срок жизни)
Каждое сообщение из облака на устройство имеет срок действия. Его может задавать служба (в свойстве **ExpiryTimeUtc**) или Центр Интернета вещей, в котором задан *срок жизни* по умолчанию, указанный в соответствующем свойстве Центра Интернета вещей. Ознакомьтесь с разделом [Параметры конфигурации сообщений, отправляемых из облака на устройство][lnk-c2d-configuration].

> [!NOTE]
> Распространенный способ воспользоваться сроком действия, чтобы сообщения не отправлялись на отключенные устройства — задать короткий срок жизни. Этот подход позволяет добиться того же результата, что и поддержание состояния подключения устройства, но при этом обладает большей эффективностью. При запросе подтверждения сообщений Центр Интернета вещей сообщает о том, какие устройства могут получать сообщения, а какие находятся в автономном режиме или в состоянии сбоя.
> 
> 

### <a name="message-feedback"></a>Отзыв на сообщение
При отправке сообщений с облака в устройство служба может запросить отзыв на каждое сообщение, уведомляющий о его конечном состоянии.

* Если для свойства **Ack** задать значение **positive**, то Центр Интернета вещей создаст отзыв на сообщение, только если сообщение, отправляемое из облака на устройство, имеет состояние **Завершено**.
* Если для свойства **Ack** задать значение **negative**, то Центр Интернета вещей создаст отзыв на сообщение, только если сообщение, отправляемое из облака на устройство, имеет состояние **Deadletterd** (Не доставлено).
* Если для свойства **Ack** задать значение **full**, то Центр Интернета вещей создаст отзыв на сообщение в любом случае.

> [!NOTE]
> Если свойство **Ack** имеет значение **full** и отзыв не получен, то это означает, что срок действия отзыва истек. Служба не знает, что случилось с исходным сообщением. На практике служба должна убедиться, что может обработать отзыв до истечения срока его действия. Максимальный срок действия составляет два дня, и этого времени достаточно для повторного запуска службы при сбое.
> 
> 

Как описано в статье [Endpoints][lnk-endpoints] (Конечные точки), Центр Интернета вещей предоставляет отзывы в виде сообщений через конечную точку, доступную для службы (**/messages/servicebound/feedback**). Семантика получения отзыва идентична семантике, используемой для сообщений, отправляемых из облака на устройство, с тем же [жизненным циклом сообщения][lnk-lifecycle]. По возможности отзывы на сообщения группируются в одно сообщение, имеющее приведенный ниже формат:

| Свойство | Описание |
| --- | --- |
| EnqueuedTime |Метка времени, указывающая, когда было создано сообщение. |
| UserId |`{iot hub name}` |
| ContentType |`application/vnd.microsoft.iothub.feedback.json` |

Основная часть — это сериализованный массив записей JSON, каждая из которых имеет следующие свойства:

| Свойство | Описание |
| --- | --- |
| EnqueuedTimeUtc |Метка времени, указывающая, когда отобразился результат сообщения. Например, устройство завершило его или истек срок его действия. |
| OriginalMessageId |**MessageId** сообщения, которое отправляется из облака на устройство и к которому относится эта информация. |
| StatusCode |Обязательная строка. Используется в отзывах, созданных центром IoT. <br/> 'Success' <br/> 'Expired' <br/> 'DeliveryCountExceeded' <br/> 'Rejected' <br/> 'Purged' |
| Описание |Строковые значения **StatusCode**. |
| deviceId |**DeviceId** целевого устройства, которому отправляется сообщение из облака и к которому относится этот отзыв. |
| DeviceGenerationId |**DeviceGenerationId** целевого устройства, которому отправляется сообщение из облака и к которому относится этот отзыв. |

> [!IMPORTANT]
> Служба должна указать идентификатор **MessageId** для сообщения, отправляемого из облака на устройство, чтобы соотнести свой отзыв с исходным сообщением.
> 
> 

Ниже приведен пример текста сообщения отзыва.

```
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

### <a name="cloud-to-device-configuration-options"></a>Параметры конфигурации сообщений, отправляемых из облака на устройство
Каждый центр IoT предоставляет следующие параметры конфигурации для отправки сообщений из облака на устройство.

| Свойство | Описание | Диапазон и значение по умолчанию |
| --- | --- | --- |
| defaultTtlAsIso8601 |Заданный по умолчанию срок жизни для сообщений, отправляемых из облака на устройство. |Интервал ISO_8601 — до 2 устройств (минимум 1 минута). Значение по умолчанию — 1 час. |
| maxDeliveryCount |Лимит доставки для очереди доставки сообщений, отправляемых из облака на устройство, для каждого отдельного устройства. |От 1 до 100. Значение по умолчанию — 10. |
| feedback.ttlAsIso8601 |Хранение отзывов, направленных службе. |Интервал ISO_8601 — до 2 устройств (минимум 1 минута). Значение по умолчанию — 1 час. |
| feedback.maxDeliveryCount |Лимит доставок для очереди отзывов. |От 1 до 100. Значение по умолчанию — 100. |

Дополнительные сведения см. в статье о [создании Центров Интернета вещей][lnk-portal].

## <a name="read-device-to-cloud-messages"></a>Чтение сообщений, отправленных с устройства в облако
Центр Интернета вещей предоставляет встроенную конечную точку **messages/events**, с помощью которой внутренние службы считывают сообщения, отправляемые в Центр с устройства в облако. Эта конечная точка совместима с концентраторами событий, поэтому можно использовать любой из механизмов для чтения сообщений, который поддерживает служба концентраторов событий.

Можно также создать пользовательские конечные точки в Центре Интернета вещей. Сейчас Центр Интернета вещей поддерживает использование следующих служб в качестве пользовательских конечных точек: концентраторы событий, очереди служебной шины и разделы служебной шины. Дополнительные сведения о считывании данных из этих служб см. в статьях, посвященных [концентраторам событий][lnk-getstarted-eh], [очередям служебной шины][lnk-getstarted-queue] и [разделам служебной шины][lnk-getstarted-topic].

### <a name="reading-from-the-built-in-endpoint"></a>Считывание данных из встроенной конечной точки

При использовании [пакета SDK служебной шины Azure для .NET][lnk-servicebus-sdk] или [концентраторов событий и узла обработчика событий][lnk-eventprocessorhost] вы можете использовать любые строки подключения к Центру Интернета вещей с нужными разрешениями. А затем использовать **messages/events** в качестве имени концентратора событий.

При использовании пакетов SDK (или интеграции продуктов), которые не поддерживают Центр Интернета вещей, следует получить совместимые с концентраторами событий конечную точку и имя в разделе параметров Центра Интернета вещей на [портале Azure][lnk-management-portal]:

1. В колонке Центра Интернета вещей щелкните **Конечные точки**.
2. В разделе **Built-in endpoints** (Встроенные конечные точки) щелкните **События**. Колонка содержит следующие значения: **Event Hub-compatible endpoint** (Конечная точка, совместимая с концентраторами событий), **Event Hub-compatible name** (Имя, совместимое с концентраторами событий), **Разделы**, **Время хранения** и **Группы потребителей**.
   
    ![Параметры отправки сообщений с устройства в облако][img-eventhubcompatible]

> [!NOTE]
> Для пакета SDK для Центра Интернета вещей требуется указать конечную точку Центра Интернета вещей, и эта точка — **messages/events**, как показано в колонке **Конечные точки**.
>
>

> [!NOTE]
> Если для используемого пакета SDK требуется указать **имя узла** или **пространство имен**, то удалите схему из **конечной точки, совместимой с концентраторами событий**. Например, если конечная точка, совместимая с концентратором событий, — **sb://iothub-ns-myiothub-1234.servicebus.windows.net/**, то **именем узла** будет **iothub-ns-myiothub-1234.servicebus.windows.net**, а **пространством имен** — **iothub-ns-myiothub-1234**.
> 
>

Затем можно использовать любую политику общего доступа с разрешениями **ServiceConnect**, которые позволяют подключаться к указанному концентратору событий.

Если нужно создать строку подключения к концентратору событий с помощью указанных выше сведений, можно использовать следующий образец:

```
Endpoint={Event Hub-compatible endpoint};SharedAccessKeyName={iot hub policy name};SharedAccessKey={iot hub policy key}
```

Ниже приведен список пакетов SDK и интеграций, которые можно применять к совместимым с концентратором событий конечным точкам, которые предоставляет центр IoT:

* [клиент концентраторов событий Java;](https://github.com/hdinsight/eventhubs-client)
* [Воронка Apache Storm](../hdinsight/hdinsight-storm-develop-csharp-event-hub-topology.md). Вы можете просмотреть [источник воронки](https://github.com/apache/storm/tree/master/external/storm-eventhubs) на портале GitHub.
* [интеграция Apache Spark.](../hdinsight/hdinsight-apache-spark-eventhub-streaming.md)

## <a name="reference-topics"></a>Справочные материалы
В следующих материалах приводятся дополнительные сведения об обмене сообщениями с Центром Интернета вещей.

## <a name="message-format"></a>Формат сообщений
Сообщения центра IoT включают в себя следующие компоненты.

* Набор *свойств системы*. Свойства, которые интерпретирует или задает Центр Интернета вещей. Этот набор определяется предварительно.
* Набор *свойств приложения*. Словарь свойств строки, которые приложение может задать и использовать без необходимости десериализации текста сообщения. Центр IoT никогда не изменяет эти свойства.
* Непрозрачная двоичная основная часть.

Дополнительные сведения о разных способах кодировки сообщений в разных протоколах см. в статье [Azure IoT SDKs][lnk-sdks] (Пакеты SDK для Azure IoT).

В следующей таблице указаны системные свойства в сообщениях Центра Интернета вещей.

| Свойство | Description (Описание) |
| --- | --- |
| MessageId |Задаваемый пользователем идентификатор сообщения, используемый для шаблонов типа запрос-ответ. Формат: строка с учетом регистра (длиной до 128 знаков), состоящая из букв и цифр в 7-битовом формате ASCII + `{'-', ':',’.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`. |
| Порядковый номер |Число (уникальное для каждой очереди устройства), которое центр IoT назначает каждому сообщению, отправленному из облака на устройство. |
| Кому |Место назначения, которое указывается в сообщениях, отправляемых [из облака на устройство][lnk-c2d]. |
| ExpiryTimeUtc |Дата и время истечения срока действия сообщения. |
| EnqueuedTime |Дата и время получения сообщения, отправленного [из облака на устройство][lnk-c2d], Центром Интернета вещей. |
| CorrelationId |Строковое свойство в сообщении ответа, которое обычно содержит идентификатор сообщения запроса в шаблонах "запрос-ответ". |
| UserId |Идентификатор, используемый для указания источника сообщений. Если сообщения создает центр IoT, для этого параметра задается значение `{iot hub name}`. |
| Ack |Генератор отзывов на сообщения. Это свойство используется в сообщениях, отправляемых из облака в устройство, чтобы запросить у центра IoT отправку отзыва после того, как сообщение будет использовано устройством. Возможные значения: **none** (по умолчанию) — отзывы не создаются, **positive** — отзыв будет получен, когда исходное сообщение будет передано, **negative** — отзыв будет получен, когда истечет срок действия исходного сообщения (или будет превышен лимит доставок) и при этом устройство его не примет, **full** — активированы значения positive и negative. Дополнительные сведения см. в разделе [Отзыв на сообщение][lnk-feedback]. |
| ConnectionDeviceId |Центр IoT устанавливает этот идентификатор в сообщениях, отправляемых с устройства в облако. Содержит идентификатор **deviceId** устройства, отправившего сообщение. |
| ConnectionDeviceGenerationId |Центр IoT устанавливает этот идентификатор в сообщениях, отправляемых с устройства в облако. Содержит идентификатор **generationId** (согласно разделу [Device identity properties][lnk-device-properties] (Свойства удостоверений устройств)) устройства, отправившего сообщение. |
| ConnectionAuthMethod |Центр IoT устанавливает этот метод проверки подлинности в сообщениях, отправляемых с устройства в облако. Это свойство содержит сведения о методе проверки подлинности, используемом для аутентификации устройства, отправляющего сообщение. Дополнительные сведения см. в разделе [Свойства для защиты от спуфинга][lnk-antispoofing]. |

## <a name="message-size"></a>Размер сообщения

Центр Интернета вещей измеряет размер сообщения вне зависимости от протокола, учитывая только фактический объем полезных данных. Размер в байтах вычисляется как сумма следующих показателей:

* размер текста в байтах;
* размер в байтах всех значений свойств системы сообщений;
* размер в байтах всех имен и значений свойств пользователей.

Обратите внимание, что имена и значения свойств ограничены символами ASCII, то есть длина строк равна размеру в байтах.

## <a name="communication-protocols"></a>Протоколы связи
Центр Интернета вещей позволяет устройствам использовать протоколы [MQTT][lnk-mqtt], MQTT через WebSocket, [AMQP][lnk-amqp], AMQP через WebSocket и HTTP для обмена данными на стороне устройства. Ниже в таблице приведены общие рекомендации по выбору протокола.

| Протокол | Когда следует выбрать этот протокол |
| --- | --- |
| MQTT <br> MQTT через WebSocket |Используйте для всех устройств, которые не требуют подключения одновременно нескольких устройств (на каждом из которых используются собственные учетные данные) с помощью одного TLS-соединения. |
| AMQP <br> AMQP через WebSocket |Используйте на собственных или облачных шлюзах, чтобы воспользоваться преимуществами мультиплексирования подключений на устройствах. |
| HTTP |Используйте для устройств, которые не поддерживают другие протоколы. |

При выборе протокола для связи на стороне устройства учитывайте следующие факторы:

* **Шаблон сообщения из облака на устройство**. Протокол HTTP не позволяет отправлять данные по инициативе сервера. Таким образом, при использовании протокола HTTP устройства опрашивают Центр Интернета вещей на предмет наличия сообщений из облака на устройство. Этот подход неэффективен для устройства и Центра Интернета вещей. Согласно текущим рекомендациям для протокола HTTP каждое устройство должно выполнять опрос не реже, чем раз в 25 минут. С другой стороны, протоколы MQTT и AMQP поддерживают отправку сообщений по инициативе сервера при получении сообщений из облака на устройство. Они позволяют незамедлительно передавать сообщения из центра IoT на устройство. Если задержка доставки является проблемой, лучше использовать протокол MQTT или AMQP. Для редко подключаемых устройств также подходит протокол HTTP.
* **Шлюзы поля**. Протоколы MQTT и HTTP не позволяют подключать по TLS-соединению одновременно несколько устройств (на каждом из которых используются собственные учетные данные). Таким образом, эти протоколы не вполне подходят для [ситуаций с использованием полевого шлюза][lnk-azure-gateway-guidance], так как требуют отдельного TLS-подключения между полевым шлюзом и Центром Интернета вещей для каждого устройства, подключаемого к полевому шлюзу.
* **Устройства с небольшим количеством ресурсов**. Библиотеки MQTT и HTTP уступают по объему библиотекам AMQP, а значит, только их можно использовать для устройств с ограниченными ресурсами (например, если размер ОЗУ меньше 1 МБ).
* **Обход сети**. Для стандартного протокола AMQP используется порт 5671, в то время как протокол MQTT прослушивает порт 8883, что может вызвать проблемы в сетях, закрытых для протоколов, отличных от HTTP. В подобных случаях можно использовать протоколы HTTP, MQTT через WebSocket и AMQP через WebSocket.
* **Объем полезных данных**. MQTT и AMQP — это двоичные протоколы, позволяющие передавать более компактные полезные данные, чем HTTP.

> [!NOTE]
> При использовании протокола HTTP каждое устройство должно проверять наличие сообщений, передаваемых из облака на устройство, не реже, чем раз в 25 минут. Тем не менее, во время разработки частота такой проверки может быть выше.
> 
> 

## <a name="port-numbers"></a>Номера портов
Устройства могут взаимодействовать с центром IoT в Azure с использованием различных протоколов. Как правило, выбор протокола определяется конкретными требованиями решения. В следующей таблице перечислены исходящие порты, которые должны быть открыты, чтобы устройство могло воспользоваться определенным протоколом.

| Протокол | Порт |
| --- | --- |
| MQTT |8883 |
| MQTT через WebSocket |443 |
| AMQP |5671 |
| AMQP через WebSocket |443 |
| HTTP |443 |
| LWM2M (Управление устройствами) |5684 |

После создания Центра Интернета вещей в регионе Azure IP-адрес центра остается неизменным в течение всего времени его существования. Однако для обеспечения качества обслуживания при перемещении корпорацией Майкрософт центра IoT в другую единицу масштабирования центру назначается новый IP-адрес.

## <a name="notes-on-mqtt-support"></a>Примечания о поддержке протокола MQTT
В центре IoT протокол MQTT 3.1.1 реализован со следующими ограничениями и особенностями:

* **QoS 2 не поддерживается**. Если приложение для устройства публикует сообщение со **вторым уровнем качества обслуживания**, то Центр Интернета вещей закрывает сетевое подключение. Если приложение для устройства подписывается на раздел со **вторым уровнем качества обслуживания**, то Центр Интернета вещей присваивает пакету **SUBACK** уровень качества обслуживания не выше первого.
* **Сообщения retain не сохраняются**. Если приложение для устройства публикует сообщение с флагом RETAIN, имеющим значение 1, то Центр Интернета вещей добавляет в сообщение свойство приложения **x-opt-retain**. В этом случае Центр Интернета вещей не сохранит сообщение, а передаст его во внутреннее приложение.

Дополнительные сведения см. в статье [Поддержка MQTT в центре IoT][lnk-devguide-mqtt].

И, наконец, обратите внимание на [шлюз протокола Azure IoT][lnk-azure-protocol-gateway], с помощью которого можно развернуть высокопроизводительный настраиваемый шлюз протокола, который взаимодействует с Центром Интернета вещей напрямую. Шлюз протокола Azure IoT позволяет настроить протокол устройства для уже существующих развертываний MQTT или других настраиваемых протоколов. Однако при этом подходе необходимо запустить настраиваемый шлюз протокола и управлять им.

## <a name="additional-reference-material"></a>Дополнительные справочные материалы
Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* Статья [IoT Hub endpoints][lnk-endpoints] (Конечные точки Центра Интернета вещей) содержит сведения о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Throttling and quotas][lnk-quotas] (Регулирование и квоты) содержит сведения о квотах, применимых к службе Центра Интернета вещей, и ожидаемом поведении регулирования при использовании службы.
* В статье [Пакеты SDK для устройств и служб Интернета вещей Azure][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Справочник по языку запросов для двойников и заданий][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.
* Статья [Поддержка MQTT в центре IoT][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия
Теперь, когда вы узнали, как отправлять и получать сообщения с помощью Центра Интернета вещей, вас могут заинтересовать следующие статьи в руководстве разработчика для Центра Интернета вещей:

* [Upload files from a device][lnk-devguide-upload] (Передача файлов с устройства)
* [Manage device identities in IoT Hub][lnk-devguide-identities] (Управление удостоверениями устройств в Центре Интернета вещей)
* [Управление доступом к Центру Интернета вещей][lnk-devguide-security]
* [Основные сведения о двойниках устройств (предварительная версия)][lnk-devguide-device-twins]
* [Вызов прямого метода на устройстве (предварительная версия)][lnk-devguide-directmethods]
* [Schedule jobs on multiple devices][lnk-devguide-jobs] (Планирование заданий на нескольких устройствах)

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующие руководства по Центру Интернета вещей:

* [Приступая к работе с Центром Интернета вещей Azure][lnk-getstarted-tutorial]
* [Учебник: как отправлять сообщения из облака на устройства с помощью центра IoT и .Net][lnk-c2d-tutorial]
* [Учебник: как обрабатывать сообщения, отправляемые с устройства центра IoT в облако, с помощью .Net][lnk-d2c-tutorial]

[img-lifecycle]: ./media/iot-hub-devguide-messaging/lifecycle.png
[img-eventhubcompatible]: ./media/iot-hub-devguide-messaging/eventhubcompatible.png

[lnk-resource-provider-apis]: https://msdn.microsoft.com/library/mt548492.aspx
[lnk-azure-gateway-guidance]: iot-hub-devguide-endpoints.md#field-gateways
[lnk-guidance-scale]: iot-hub-scaling.md
[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md
[lnk-amqp]: http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf
[lnk-mqtt]: http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.pdf
[lnk-event-hubs]: http://azure.microsoft.com/documentation/services/event-hubs/
[lnk-event-hubs-consuming-events]: ../event-hubs/event-hubs-programming-guide.md#event-consumers
[lnk-management-portal]: https://portal.azure.com
[lnk-servicebus]: http://azure.microsoft.com/documentation/services/service-bus/
[lnk-eventhub-partitions]: ../event-hubs/event-hubs-overview.md#partitions
[lnk-portal]: iot-hub-create-through-portal.md
[lnk-getstarted-eh]: ../event-hubs/event-hubs-csharp-ephcs-getstarted.md
[lnk-getstarted-queue]: ../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md
[lnk-getstarted-topic]: ../service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions.md

[lnk-c2d-guidance]: iot-hub-devguide-c2d-guidance.md
[lnk-d2c-guidance]: iot-hub-devguide-d2c-guidance.md

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md
[lnk-d2c]: iot-hub-devguide-messaging.md#device-to-cloud-messages
[lnk-c2d]: iot-hub-devguide-messaging.md#cloud-to-device-messages
[lnk-compatible-endpoint]: iot-hub-devguide-messaging.md#read-device-to-cloud-messages
[lnk-protocols]: iot-hub-devguide-messaging.md#communication-protocols
[lnk-message-format]: iot-hub-devguide-messaging.md#message-format
[lnk-device-properties]: iot-hub-devguide-identity-registry.md#device-identity-properties
[lnk-ttl]: iot-hub-devguide-messaging.md#message-expiration-time-to-live
[lnk-c2d-configuration]: iot-hub-devguide-messaging.md#cloud-to-device-configuration-options
[lnk-lifecycle]: iot-hub-devguide-messaging.md#message-lifecycle
[lnk-feedback]: iot-hub-devguide-messaging.md#message-feedback
[lnk-antispoofing]: iot-hub-devguide-messaging.md#anti-spoofing-properties
[lnk-compare]: iot-hub-compare-event-hubs.md

[lnk-devguide-upload]: iot-hub-devguide-file-upload.md
[lnk-devguide-identities]: iot-hub-devguide-identity-registry.md
[lnk-devguide-security]: iot-hub-devguide-security.md
[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-servicebus-sdk]: https://www.nuget.org/packages/WindowsAzure.ServiceBus
[lnk-eventprocessorhost]: http://blogs.msdn.com/b/servicebus/archive/2015/01/16/event-processor-host-best-practices-part-1.aspx
[lnk-devguide-query-language]: iot-hub-devguide-query-language.md
[lnk-devguide-endpoints]: iot-hub-devguide-endpoints.md

[lnk-getstarted-tutorial]: iot-hub-csharp-csharp-getstarted.md
[lnk-c2d-tutorial]: iot-hub-csharp-csharp-c2d.md
[lnk-d2c-tutorial]: iot-hub-csharp-csharp-process-d2c.md
[lnk-event-hub-partitions]: ../event-hubs/event-hubs-what-is-event-hubs.md#partitions

