<properties
 pageTitle="Управление устройствами IoT | Microsoft Azure"
 description="Общие сведения об использовании центра IoT и набора IoT Suite для управления устройствами IoT."
 services="iot-hub,iot-suite"
 documentationCenter=""
 authors="juanjperez"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="11/10/2015"
 ms.author="sethm"/>

# Управление устройствами IoT с помощью Azure IoT Suite и центра Azure IoT

Центр IoT Azure и Azure IoT Suite предоставляют базовые возможности управления устройствами для решений IoT в любых масштабах, а также различными устройствами и их топологиями. Под управлением устройствами в этой статье подразумевается управление устройствами IoT.

## Введение

Поставщики услуг, предприятия и любые другие организации, использующие устройства IoT, пользуются возможностями управления устройствами для выполнения следующих бизнес-процессов:

* регистрация и обнаружение устройств IoT;
* подключение;
* удаленная настройка и обновление программного обеспечения на устройствах. Например, для управления устройствами на производственных предприятиях или нефтяных месторождениях используются политики для удаленной настройки и обновления устройств, а также цепочки одобрений, нормативные требования аудита, наличие физических мер безопасности и т. д.

При использовании управления устройствами для своего решения IoT рассмотрите следующие возможности и определите важность каждой из них для достижения собственных бизнес-целей.

* **[Подготовка и обнаружение устройства](#device-provisioning-and-discovery)** — процесс, с помощью которого устройство регистрируется в системе.
* **[Реестр и модели устройств](#device-registry-and-device-models)** — способ представления моделями устройств структурированного использования метаданных для связи устройств, определения ролей в системе и методов проверки.
* **[Управление доступом устройств](#device-access-management)** — способ управления доступом устройств к ресурсам из облачных служб.
* **[Удаленное управление](#remote-control)** — способ получения доступа удаленными пользователями к устройствам и управление их изменением.
* **[Удаленное администрирование](#remote-administration-and-monitoring)** — процесс, с помощью которого администратор определяет работоспособность группы устройств.  
* **[Удаленная настройка](#remote-configuration)** — способ изменения конфигурации устройства администратором.
* **[Удаленное обновление программного обеспечения и встроенного ПО](#remote-firmware-and-software-update)** — процесс, с помощью которого администратор может обновить встроенное ПО и программное обеспечение устройства.

В следующих разделах каждая из этих возможностей управления устройствами рассматривается более подробно, а также предоставляется высокоуровневая модель для реализации этих возможностей с помощью центра IoT Azure.

## Подготовка и обнаружение устройств

Подготовка устройства в центре IoT Azure выполняется с помощью интерфейса API реестра. После регистрации устройства и предоставления или получения ключа оно сможет подключаться к центру IoT с помощью этого ключа. Центр IoT Azure взаимодействует только с зарегистрированными устройствами, которые указывают авторизованные учетные данные. Администраторы могут отключить доступ устройства к центру IoT Azure на портале администрирования.

Если позволяет способ производства, подготовки и развертывания устройства IoT, можно использовать процесс начальной загрузки. Чтобы упростить подключение и отложить процесс назначения устройства определенному центру IoT, интегрируйте службу начальной загрузки в свое решение. Во время изготовления устройства потенциальное место его использования может быть еще неизвестным. Это лишь один пример многочисленных потенциально сложных рабочих процессов, которые облегчают определение устройств центрами IoT Azure, а также интеграцию в существующие бизнес-процессы.

При использовании службы начальной загрузки устройство IoT запускается и создает запрос, который может в конечном счете предоставить доступ к назначенному центру IoT Azure. Запрос должен содержать учетные данные начальной загрузки устройства и другие необходимые данные. Для авторизованных устройств служба начальной загрузки регистрирует устройство в назначенном центре IoT Azure и предоставляет сведения о подключении устройству, которое отправляет запрос на начальную загрузку. Центр IoT предоставляет сведения о подключении устройству, отправляющему запрос на начальную загрузку.

## Реестр и модели устройств

Термин *модель устройства* означает модель, включающую свойства устройства, которые облачная служба может прочитать или записать. Она также включает команды устройства, которые облачная служба может выполнить удаленно. В описанной далее модели, управляемой посредством службы, устройство не имеет сведений о модели, но облачные службы могут отслеживать и использовать метаданные устройств.

Хранение сведений об устройстве и связанных метаданных является крайне важным для системы IoT и роли реестра устройств. Особенно это касается предыдущих моделей устройств, которые невозможно заменить, или устройств, для которых не используются модели. В этом случае взаимодействие службы IoT с группой устройств может обеспечить модель, управляемая службой. Если устройства работают с использованием определенной модели, реестр устройств служит согласованным представлением данных устройства, где оно является главным. В этом случае служба сообщает устройству о необходимых изменениях, которые можно внести только после того, как устройство подтвердит их.

### Модель, управляемая службой

Если устройство подключается к центру IoT Azure и не предоставляет модель устройства, очень важно реализовать реестр устройств для отслеживания зарегистрированных устройств и связанных с ними метаданных. В этом случае реестр устройств является единственным местом хранения метаданных устройства. Примеры метаданных устройства, которые вам, возможно, потребуется отслеживать: логическая топология (например, дом 109, 4-й этаж), функция устройства (например, датчик двери) или любая другая информация, содержащаяся в тегах.

### Модель, управляемая устройством

Чтобы решение IoT могло эффективно использовать возможности вашего устройства IoT, после подключения к центру IoT устройство должно описать себя в облаке. Ниже показаны два типа моделей устройств, используемых в решении IoT.

#### Модель самоопределяющегося устройства

Инженер устройства (или разработчик, использующий эмулятор устройства) использует модель самоопределяющегося устройства для проверки возможностей устройства в процессе его создания. Сначала инженер может создать устройство с несколькими свойствами и поддержкой нескольких команд, а позже расширить его возможности. Точно так же инженер может создать несколько устройств, каждое из которых будет обладать уникальными возможностями и использовать самоопределяющуюся модель. В этом случае инженеру не потребуется регистрировать структуру моделей устройств. Значительные изменения в самоопределяющихся моделях могут вызвать трудности при увеличении количества устройств.

#### Модель предварительно определенного устройства

Если рабочую среду IoT требуется развернуть в сети, в которой действуют ограничения по питанию или обработке, лучше использовать именно модель предварительно определенных устройств. Она отличается минимальной обработкой и энергопотреблением устройств. Минимальный сетевой трафик также позволяет устройствам передавать данные через разнородные сети (Wi-Fi, 2G, 3G, 4G, BLE, Sat и т. д.). Это особенно удобно при использовании ограниченной и дорогой инфраструктуры (например, спутниковой связи). При реализации модели предварительно определенных устройств инженер может отправлять сведения об устройстве, закодированные одним или двумя байтами, которые служат ключом для модели предварительно определенного устройства. Лаконичность этого подхода повышает эффективность на один-два порядка по сравнению с моделью самоопределяющегося устройства.

### Предварительно настроенное решение удаленного мониторинга и модель его устройства

Предварительно настроенное решение удаленного мониторинга Azure IoT Suite реализует модель самоопределяющегося устройства. Эта модель позволяет выполнять быстрые итерации в процессе определения и совершенствования возможностей вашего устройства.

Код, с помощью которого предварительно настроенное решение удаленного мониторинга создает объект устройства и отправляет его в службу, можно найти в файле **Simulator/Simulator.WorkerRole/SimulatorCore/Devices/DeviceBase.cs**. Пример создания самоописательной модели устройства и последующей ее отправки в центр IoT Azure можно увидеть в методах `SendDeviceInfo` и `GetDeviceInfo`.

Код, с помощью которого облачная служба обрабатывает события, связанные с моделью устройства, расположен в файле **EventProcessor/EventProcessor.WorkerRole/Processors/DeviceManagementProcessor.cs**. Основная часть операций по обработке сообщений, связанных с моделью устройства и отправляемых на сервер предварительно настроенного решения, осуществляется в методе `ProcessJToken`.

После получения сообщения, связанного с моделью устройства, методы `UpdateDeviceFromSimulatedDeviceInfoPacketAsync` и `UpdateDeviceFromRealDeviceInfoPacketAsync` из файла **DeviceManagement/Infrastructure/BusinessLogic/DeviceLogic.cs** обновляют реестр устройства. Интерфейсы API реестра устройства в предварительно настроенном решении удаленного мониторинга можно найти в файле **DeviceManagement/Web/WebApiControllers/DeviceApiController.cs**.

### Модели устройств шлюза поля

Шлюзы поля часто используются для обеспечения подключения и преобразования протоколов для устройств, которые не могут или не должны подключаться к Интернету напрямую. Если устройство, которое вы создаете, является шлюзом поля, оно может представлять устройства, которые подключаются с помощью шлюза поля, при любых взаимодействиях с центром IoT Azure. Изготовитель шлюза поля отвечает за реализацию преобразования протоколов устройств и протоколов, поддерживаемых службой IoT. Если вы хотите использовать шлюз поля для подключения устройств BLE (Bluetooth c низким энергопотреблением), необходимо реализовать интерфейс BLE для устройств и интерфейс центра IoT Azure.

## Управление доступом к устройству

Предварительно настроенное решение IoT Suite управляет доступом к различным функциям устройства, включая права на чтение и запись свойств устройства и права на выполнение команд. В предварительно настроенных решениях этот доступ контролируется с помощью Azure Active Directory (AAD) на портале администрирования устройства. Безопасность доступа на основе ролей можно включить посредством расширения использования AAD в предварительно настроенном решении.

## Удаленное управление

В сценариях для предварительно настроенных решений Azure IoT Suite удаленное управление не рассматривается. Тем не менее, ниже приведен детальный анализ возможностей удаленного управления решением IoT.

Как правило, в сценариях ИТ удаленное управление используется лишь для помощи удаленным пользователям или для удаленной настройки серверов. В сценариях IoT большинство устройств работают без участия пользователей, поэтому удаленное управление используется для удаленной настройки и диагностики. Удаленное управление можно реализовать с помощью двух моделей.

* **Прямое подключение.** Чтобы включить удаленное управление с помощью прямого подключения к устройству (например, SSH в Linux, удаленный рабочий стол в Windows или средства удаленной отладки), необходимо иметь возможность создавать подключение к устройству. Учитывая угрозы безопасности при доступности устройства через Интернет, рекомендуем использовать службу ретрансляции (например, [ретранслятор служебной шины](service-bus-relay-overview.md) Azure) для подключения к устройству и обмена трафиком с ним. Так как подключение ретрансляции является исходящим подключением с устройства, оно помогает ограничить уязвимость открытых TCP-портов на устройстве.

* **Отправка команд устройству.** Для удаленного управления с помощью отправки команд устройству используется существующее подключение и канал связи между устройством и центром IoT Azure. Чтобы включить удаленное управление с помощью отправки команд устройству, необходимо выполнить следующие требования.
  * Программное обеспечение, которое работает на устройстве, должно сообщить службе IoT о доступности команд на устройстве. Обычно это определено в модели устройства.
  * Программное обеспечение, работающее на устройстве, должно реализовывать команды удаленного управления. Эти команды должны соответствовать модели «запрос» (из службы IoT на устройство) — «ответ» (с устройства в службу IoT). После выполнения команд состояние устройства может измениться. Возможно, это новое состояние потребуется обновить в реестре устройства.

Если устройство является основным хранилищем настроек и состояния устройства, реестр устройств использует согласованную модель. Изменения в состоянии устройства должны отправляться в реестр устройства. Состояние реестра устройства можно принудительно обновить по запросу службы IoT. Устройство также может автоматически обновить службу после обнаружения изменений в состоянии системы. Автоматическое обновление службы устройством может повысить сетевой трафик и увеличить использование процессора устройства и питания.

## Удаленное администрирование и мониторинг

Большинство устройств IoT различает рабочие роли и роли пользователей управления. Удаленное администрирование является методом, с помощью которого администраторы могут отслеживать состояние устройств, настраивать потоки данных из устройств в бизнес-процессы и приложения (например, CRM, ERP, системы обслуживания и т. д.). Кроме того, состояние или настройки устройств можно удаленно обновлять с помощью команд.

Предварительно настроенные решения Azure IoT Suite предоставляют веб-сайт Azure, который можно использовать в качестве отправной точки для интерфейса администрирования устройства. Интерфейс администрирования можно расширить, используя сценарии в вертикальном решении IoT.

Администраторы определяют границы работоспособности устройства как функцию рабочих данных устройства (обычно они меняются быстро) и метаданных устройства (обычно они меняются медленно). С помощью правил можно включить систему оповещений о работоспособности устройства, реализованную с помощью подсистемы обработки потока (например, [Azure Stream Analytics](https://azure.microsoft.com/services/stream-analytics/)), а не стратегии опроса.

## Удаленная настройка

Удаленное изменение настроек устройства может быть важным на нескольких этапах жизненного цикла устройства: подготовка, диагностика и интеграция в бизнес-процессы. Изменения удаленной конфигурации включаются с помощью сочетания модели устройства и возможностей службы IoT удаленно обновлять состояние экземпляра модели устройства.

В предварительно настроенном решении удаленного мониторинга устройство сообщает о поддержке следующих команд для удаленной настройки:

* ChangeKey
* ChangeConfig
* ChangeSystemProperties

Эти команды не отображаются как доступные команды устройства на портале администрирования предварительно настроенного решения. Это происходит потому, что команды выполняются удаленно определенными частями портала. После получения команды устройство отправляет подтверждение службе. После обработки команды устройство отправляет ответ с результатом, сообщающий службе об успешном или неуспешном выполнении команды. Если при выполнении команды происходит ошибка, отправляется код ошибки. На этом этапе подтверждается требуемое состояние устройства и обновляется реестр.

## Удаленное обновление программного обеспечения и встроенного ПО

Удаленное обновление программного обеспечения и встроенного ПО — важная функция системы IoT. Обновления позволяют устанавливать на устройства последние, наиболее безопасные версии программного обеспечения. Удаленное обновление встроенного ПО и программного обеспечения на устройстве является примером распределенного длительного процесса, который обычно включает в себя бизнес-процессы. Например, в случае обновления встроенного ПО на устройстве, которое управляет топливным насосом высокой мощности, может потребоваться выполнение дополнительных действий в смежных системах для перенаправления топлива во время выполнения и проверки обновления.

### Анализ обновления встроенного ПО

Ниже приведен пример возможной реализации обновления встроенного ПО, которая может отвечать потребностям вашего бизнеса. Целью этого примера является рассмотрение самого процесса без конкретной реализации. В этой статье не рассматриваются требования к обновлениям, которые могут учитывать множество деловых и технических факторов.

Обновления устройств инициируются в службе IoT, затем в определенное время о них сообщается устройствам с помощью команд. Если устройство явно поддерживает удаленное обновление программного обеспечения или встроенного ПО, служба IoT отправит команды обновления в соответствии с определенными бизнес-процессами и политиками. После получения соответствующей команды устройству необходимо загрузить пакет обновления, развернуть его, перезагрузиться с развернутой конфигурацией (в случае обновления встроенного ПО) или запустить новый пакет программного обеспечения. Затем нужно убедиться, что новое программное обеспечение или встроенное ПО работает правильно. Это многоэтапный процесс. Устройство должно информировать службу IoT о своем состоянии по мере продвижения по каждому этапу.

Для доставки пакета обновления может использоваться служба хранилища, например служба хранилища Azure или сеть доставки содержимого (CDN). Прежде чем применять обновления программного обеспечения или встроенного ПО, обязательно проверьте целостность загруженного пакета, чтобы убедиться, что пакет получен из ожидаемого источника.

После завершения обновления встроенного ПО устройство должно проверить работоспособность и подтвердить рабочее состояние. В противном случае программное обеспечение устройства должно выполнить откат к последнему рабочему состоянию. Это может быть последнее рабочее состояние или образ встроенного ПО устройства (так называемое *эталонное состояние*), который хранится в разделе хранилища.

## Дальнейшие действия

Дополнительные сведения о центре IoT в Azure см. по следующим ссылкам:

* [Приступая к работе с центром IoT][]
* [Что такое центр IoT в Azure?][]
* [Подключение устройства][]

[Приступая к работе с центром IoT]: iot-hub-csharp-csharp-getstarted.md
[Что такое центр IoT в Azure?]: iot-hub-what-is-iot-hub.md
[Подключение устройства]: https://azure.microsoft.com/develop/iot/

<!---HONumber=AcomDC_1203_2015-->