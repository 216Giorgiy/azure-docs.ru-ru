<properties
 pageTitle="Управление устройствами IoT | Microsoft Azure"
 description="Общие сведения об управлении устройствами с помощью центра IoT Azure"
 services="iot-hub"
 documentationCenter=".net"
 authors="juanjperez"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="09/29/2015"
 ms.author="juanpere"/>

# Управление устройствами IoT с помощью Azure IoT Suite и центра Azure IoT

## Введение
Центр IoT Azure и Azure IoT Suite предоставляют базовые возможности управления устройствами для решений IoT в любых масштабах, а также различными устройствами и их топологиями. Под управлением устройствами в этой статье подразумевается управление устройствами IoT.

Поставщики услуг и предприятия или любые другие организации, использующие устройства IoT, пользуются возможностями управления устройствами для выполнения следующих бизнес-процессов: регистрации и обнаружения устройств IoT, подключения, удаленной настройки и обновления программного обеспечения на устройствах. Например, для управления устройствами на производственных предприятиях или нефтяных месторождениях будут использоваться политики для удаленной настройки и обновления устройств, а также цепочки одобрений, нормативные требования аудита, наличие физических мер безопасности и т. д.

При использовании управления устройствами для своего решения IoT рассмотрите следующие возможности и определите важность каждой из них для достижения собственных бизнес-целей.

* Подготовка и обнаружение устройства — процесс, с помощью которого устройство регистрируется в системе.
* Реестр и модели устройств — способ представления моделями устройств структурированного использования метаданных для связи устройств, определения ролей в системе, методов проверки.
* Управление доступом устройств — способ управления доступом устройств к ресурсам из облачных служб.
* Удаленное управление — способ получения доступа удаленными пользователями к устройствам и управление их изменением.
* Удаленное администрирование — процесс, с помощью которого администратор определяет работоспособность группы устройств.  
* Удаленная настройка — способ изменения конфигурации устройства администратором.
* Удаленное обновление программного обеспечения и встроенного ПО — процесс, с помощью которого администратор может обновить встроенное ПО и программное обеспечение устройства.

В следующих разделах каждая из этих возможностей управления устройствами рассматривается более подробно, а также предоставляется высокоуровневая модель для их реализации с помощью центра IoT Azure.

## Подготовка и обнаружение устройств
Подготовка устройства в центре IoT Azure выполняется с помощью API реестра. После регистрации устройства и предоставления или получения ключа оно сможет подключаться к центру IoT с помощью этого ключа. Центр IoT Azure взаимодействует только с зарегистрированными устройствами, которые предоставляют авторизованные учетные данные. Администраторы могут отключить доступ устройства к центру IoT Azure на портале администрирования.

Если позволяет способ производства, подготовки и развертывания устройства IoT, можно использовать процесс начальной загрузки. Чтобы упростить подключение и отложить процесс назначения устройства определенному центру IoT Azure, интегрируйте службу начальной загрузки в свое решение. Во время производства устройства может быть еще неизвестно, где именно оно будет работать. Это лишь один пример многочисленных потенциально сложных рабочих процессов, которые облегчают определение устройств центрами IoT Azure, а также интеграцию в существующие бизнес-процессы.

При использовании службы начальной загрузки устройство IoT запускается и может в конечном счете предоставлять доступ к назначенному центру IoT Azure. Запрос должен включать учетные данные начальной загрузки устройства и другие данные, необходимые для авторизованных устройств. С их помощью служба начальной загрузки должна зарегистрировать устройство в назначенном центре IoT Azure и предоставить сведения о подключении устройству, которое запрашивает начальную загрузку. Центр IoT предоставляет сведения о подключении устройству, отправляющему запрос на начальную загрузку. Для авторизованных устройств служба начальной загрузки регистрирует устройство в назначенном центре IoT Azure и предоставляет сведения о подключении устройству, которое отправляет запрос на начальную загрузку. Центр IoT предоставляет сведения о подключении устройству, отправляющему запрос на начальную загрузку.

## Реестр и модели устройств

Под использованием фразовой модели устройства имеется в виду модель, обладающая свойствами, доступными для чтения и записи с помощью команд облачной службы и устройства. Облачная служба может выполнять эти команды удаленно. В описанной ниже модели, управляемой посредством службы, устройство не имеет сведений о модели, но облачные службы могут отслеживать метаданные устройств и использовать их.

Хранение сведений об устройстве и связанных метаданных является крайне важным для системы IoT и роли реестра устройств. Особенно это касается предыдущих моделей устройств, которые невозможно заменить, или устройств, не использующих модели устройств. В этом случае взаимодействие с группой устройств может обеспечить модель, управляемая с помощью службы IoT. Если устройства работают с использованием определенной модели, реестр устройств служит согласованным представлением данных устройства, где оно является главным. В этом случае служба сообщает устройству о необходимых изменениях, которые можно внести только после того, как устройство подтвердит их.

### Модель, управляемая службой
Если устройство подключается к центру IoT Azure и не предоставляет модель устройства, очень важно реализовать реестр устройств для отслеживания зарегистрированных устройств и связанных с ними метаданных. В этом случае реестр устройств является единственным местом хранения метаданных устройства. Примерами метаданных устройства, которые вам, возможно, потребуется отслеживать, могут быть логическая топология (например, дом 109, 4-й этаж), функция устройства (например, датчик двери) или любая другая информация, содержащаяся в тегах.

### Модель, управляемая устройством
Чтобы решение IoT могло эффективно использовать возможности вашего устройства IoT, после подключения к центру IoT Azure оно должно описать себя в облаке. Ниже показаны два типа моделей устройств, используемых в решении IoT.

#### Модель самоопределяющегося устройства
Инженер устройства (или разработчик, использующий эмулятор устройства) использует модель самоопределяющегося устройства для проверки возможностей устройства в процессе его создания. Сначала инженер может создать устройство с несколькими свойствами и поддержкой нескольких команд, а позже расширить его возможности. Точно так же инженер может создать несколько устройств, каждое из которых будет обладать уникальными возможностями и использовать самоопределяющуюся модель. Таким образом, ему не придется регистрировать структуру моделей устройств. Значительные изменения в самоопределяющихся моделях могут вызвать трудности при увеличении количества устройств.

#### Модель предварительно определенного устройства
Если рабочую среду IoT требуется развернуть в сети, в которой действуют ограничения по питанию и обработке, лучше использовать именно модель предварительно определенных устройств. Она отличается минимальной обработкой и энергопотреблением устройств. Минимальный сетевой трафик также позволяет устройствам передавать данные через разнородные сети (Wi-Fi, 2G, 3G, 4G, BLE, Sat и т. д.). Это особенно удобно при использовании ограниченной и дорогой инфраструктуры (например, спутниковой связи). При реализации модели предварительно определенных устройств инженер может отправлять сведения об устройстве, закодированные одним или двумя байтами, которые служат ключом для модели предварительно определенного устройства. Лаконичность этого подхода повышает эффективность на один-два порядка по сравнению с моделью самоопределяющегося устройства.

### Предварительно настроенное решение удаленного мониторинга и модель его устройства
Предварительно настроенное решение удаленного мониторинга Azure IoT Suite реализует модель самоопределяющегося устройства. Эта модель позволяет выполнять быстрые итерации в процессе определения и совершенствования возможностей вашего устройства.

Файл Simulator/Simulator.WorkerRole/SimulatorCore/Devices/DeviceBase.cs содержит код, с помощью которого предварительно настроенное решение удаленного мониторинга создает объект устройства и отправляет его в службу. Пример создания самоописательной модели устройства и последующей ее отправки в центр IoT Azure можно увидеть в методах SendDeviceInfo и GetDeviceInfo.

Файл EventProcessor/EventProcessor.WorkerRole/Processors/DeviceManagementProcessor.cs содержит код, с помощью которого облачная служба обрабатывает события, связанные с моделью устройства. Метод с именем ProcessJToken является основой работы модели устройства. Сообщения, связанные с моделью, отправляются серверу предварительно настроенного решения.

После получения сообщения, связанного с моделью устройства, методы UpdateDeviceFromSimulatedDeviceInfoPacketAsync и UpdateDeviceFromRealDeviceInfoPacketAsync из файла DeviceManagement/Infrastructure/BusinessLogic/DeviceLogic.cs обновляют реестр устройства. API реестра устройства в предварительно настроенном решении удаленного мониторинга можно найти в файле DeviceManagement/Web/WebApiControllers/DeviceApiController.cs.

### Модели устройств шлюза поля
Шлюзы поля часто используются для обеспечения подключения и преобразования протоколов для устройств, которые не могут или не должны подключаться к Интернету напрямую. Если устройство, которое вы создаете, является шлюзом поля, оно может представлять устройства, которые подключаются с его помощью (шлюз поля), при любых взаимодействиях с центром IoT Azure. Изготовитель шлюза поля отвечает за реализацию преобразования протоколов устройств и протоколов, поддерживаемых службой IoT. Если вы хотите использовать шлюз поля для подключения устройств BLE (Bluetooth c низким энергопотреблением), необходимо реализовать интерфейс BLE и интерфейс центра IoT Azure.

## Управление доступом к устройству
Предварительно настроенное решение Azure IoT Suite управляет доступом к различным функциям устройства, включая права на чтение и запись свойств устройства и права на выполнение команд. В предварительно настроенных решениях этот доступ контролируется с помощью Azure Active Directory (AAD) на портале администрирования устройства. Безопасность доступа на основе ролей можно включить посредством расширения использования AAD в предварительно настроенном решении.

## Удаленное управление
В сценариях для предварительно настроенных решений Azure IoT Suite удаленное управление не рассматривается. Тем не менее ниже приведен детальный анализ возможностей удаленного управления решением IoT.

Как правило, в сценариях ИТ удаленное управление используется лишь для помощи удаленным пользователям или для удаленной настройки серверов. В сценариях IoT большинство устройств работают без участия пользователей, поэтому удаленное управление используется для удаленной настройки и диагностики. Удаленное управление можно реализовать с помощью двух моделей.

* Прямое подключение. Чтобы включить удаленное управление с помощью прямого подключения к устройству (например, SSH в Linux, удаленный рабочий стол в Windows или средства удаленной отладки), необходимо иметь возможность создавать подключение к устройству. Учитывая угрозы безопасности при доступности устройства через Интернет, рекомендуем использовать службу ретрансляции (например, ретранслятор служебной шины) для подключения к устройству и обмена трафиком с ним. Так как подключение ретрансляции является исходящим подключением с устройства, оно помогает ограничить уязвимость открытых TCP-портов на устройстве.

* Отправка команд устройству. Для удаленного управления с помощью отправки команд устройству используется существующее соединение и канал связи между устройством и центром IoT Azure. Чтобы включить удаленное управление с помощью отправки команд устройству, необходимо выполнить следующие требования.
  * Программное обеспечение, которое работает на устройстве, должно сообщить службе IoT о доступности команд на устройстве. Обычно это определено в модели устройства.
  * Программное обеспечение, работающее на устройстве, должно реализовывать команды удаленного управления. Эти команды должны соответствовать модели «запрос» (из службы IoT на устройство) — «ответ» (с устройства в службу IoT). После выполнения команд состояние устройства может измениться. Это новое состояние может требовать обновления в реестре устройства.

Если устройство является основным хранилищем настроек и состояния устройства, реестр устройств использует согласованную модель. Изменения в состоянии устройства должны отправляться в реестр устройства. Состояние реестра устройства можно принудительно обновить по запросу службы IoT. Устройство также может автоматически обновить службу после обнаружения изменений в состоянии системы. Автоматическое обновление службы устройством может повысить сетевой трафик и увеличить использование процессора устройства и питания.

## Удаленное администрирование и мониторинг
Большинство устройств IoT различает рабочие роли и роли пользователей управления. Удаленное администрирование является интерфейсом, с помощью которого администраторы могут отслеживать состояние устройств, настраивать потоки данных из устройств в бизнес-процессы и приложения (например, CRM, ERP, обслуживание систем и т. д.). Кроме того, состояние или настройки устройств можно удаленно обновлять с помощью команд.

Предварительно настроенные решения Azure IoT Suite предоставляют веб-сайт Azure, который можно использовать в качестве отправной точки интерфейса администрирования устройства. Интерфейс администрирования можно расширить, используя сценарии в вертикальном решении IoT.

Администраторы определяют границы работоспособности устройства как функцию рабочих данных (обычно быстрое перемещение) и метаданных устройства (обычно медленное перемещение). В отличие от стратегии опроса, систему оповещений о работоспособности устройства можно включить с помощью правил, реализованных с помощью подсистемы обработки потока (например, аналитики потока Azure).

## Удаленная настройка
Удаленное изменение настроек устройства может быть важным на нескольких этапах жизненного цикла устройства: подготовка, диагностика и интеграция в бизнес-процессы. Изменения удаленной конфигурации включаются с помощью сочетания модели устройства и возможностей службы IoT удаленно обновлять состояние экземпляра модели устройства.

В предварительно настроенном решении удаленного мониторинга устройство сообщает о поддержке следующих команд для удаленной настройки:

* ChangeKey
* ChangeConfig
* ChangeSystemProperties

Эти команды не отображаются как доступные команды устройства на портале администрирования предварительно настроенного решения. Это происходит, потому что команды выполняются удаленно определенными частями портала. После получения команды устройство отправляет подтверждение службе. После обработки команды устройство отправляет ответ с результатом, сообщающий службе об успешном или неуспешном выполнении команды. Если при выполнении команды произошла ошибка, отправляется код ошибки. На этом этапе подтверждается требуемое состояние устройства и обновляется реестр.

## Удаленное обновление программного обеспечения и встроенного ПО
Удаленное обновление программного обеспечения и встроенного ПО играет очень важную роль в системе IoT, так как позволяет устройствам использовать самое новое и безопасное ПО. Удаленное обновление встроенного ПО и программного обеспечения на устройстве является примером распределенного длительного процесса, который обычно включает в себя бизнес-процессы. Например, в случае обновления встроенного ПО на устройстве, которое управляет топливным насосом высокой мощности, может потребоваться выполнение дополнительных действий в смежных системах для перенаправления топлива во время выполнения и проверки обновления.

### Анализ обновления встроенного ПО
Ниже приведен возможный способ реализации обновления встроенного ПО, который может отвечать потребностям вашего бизнеса. Целью этого примера является рассмотрение самого процесса без конкретной реализации. В этой статье не рассматривается планирование потребностей обновления с учетом множества деловых и технических факторов.

Обновления устройств инициируются в службе IoT, затем в определенное время о них сообщается устройствам с помощью команд. Если устройство явно поддерживает удаленное обновление встроенного ПО или программного обеспечения, служба IoT отправит команды обновления в соответствии с определенными бизнес-процессами и политиками. После получения соответствующей команды устройству необходимо загрузить пакет обновления, развернуть его, перезагрузиться с развернутым пакетом (в случае обновления встроенного ПО) или запустить новый пакет программного обеспечения. Затем нужно убедиться, что новое встроенное ПО или программное обеспечение работает правильно. Этот процесс многоэтапный. Устройство должно информировать службу IoT о своем состоянии по мере продвижения по каждому этапу.

Пакет обновления можно доставить через службу хранилища, например с помощью хранилища Azure или сети доставки содержимого (CDN). Прежде чем применять обновления программного обеспечения или встроенного ПО, обязательно проверьте целостность загруженного пакета, чтобы убедиться, что пакет получен из ожидаемого источника.

После завершения обновления встроенного ПО устройство должно проверить работоспособность и подтвердить рабочее состояние. В противном случае программное обеспечение устройства должно выполнить откат к последнему рабочему состоянию. Последним рабочим состоянием может быть последнее рабочее состояние или образ встроенного ПО устройства (так называемое «эталонное состояние»), который хранится в разделе хранилища.

<!---HONumber=Oct15_HO1-->