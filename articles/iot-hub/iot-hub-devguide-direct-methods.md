---
title: Руководство разработчика. Прямые методы | Microsoft Docs
description: Руководство разработчика по Центру Интернета вещей Azure. Использование прямых методов для вызова кода на устройствах
services: iot-hub
documentationcenter: .net
author: nberdy
manager: timlt
editor: ''

ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/30/2016
ms.author: nberdy

---
# <a name="invoke-a-direct-method-on-a-device-(preview)"></a>Вызов прямого метода на устройстве (предварительная версия)
## <a name="overview"></a>Обзор
Центр Интернета вещей дает возможность вызова методов на устройствах из облака. Методы представляют собой взаимодействие типа "запрос-ответ" с устройством, подобное вызову HTTP тем, что об успешном завершении или сбое становится известно немедленно (после указанного пользователем времени ожидания). Таким образом пользователь узнает о состоянии вызова. Это используется в сценариях, где действия, выполняемые немедленно, отличаются в зависимости от возможности ответа устройства, например отправка SMS для пробуждения устройства, работающего в автономном режиме (при этом отправка SMS обходится дороже, чем вызов метода).

Метод можно считать удаленным вызовом процедуры непосредственно на устройстве. Из облака можно вызывать только методы, реализованные на устройстве. Если облако попытается вызвать метод на устройстве, в котором он не определен, вызов метода завершается ошибкой.

Каждый метод устройства предназначен для одного устройства. [Задания][lnk-devguide-jobs] предоставляют способ вызова методов на нескольких устройствах и помещения в очередь вызванных методов для отключенных устройств.

Любой пользователь с разрешениями на **подключение службы** в Центре Интернета вещей может вызвать метод на устройстве.

### <a name="when-to-use"></a>Сценарии использования
Методы устройств похожи на [сообщения, отправляемые из облака на устройство][lnk-devguide-messages] в том, что оба эти компонента позволяют серверной части облака передавать сведения на устройство. Однако они коренным образом отличаются друг от друга. По сути, методы являются синхронными и неустойчивыми, а сообщения, отправляемые из облака на устройство, — асинхронные и обладают устойчивостью до 48 часов.

Методы следуют модели "запрос-ответ" и они недолговечны. Неустойчивость обеспечивает два очевидных преимущества при управлении устройствами:

* **Немедленный отзыв при выполнении метода.** Это означает, что не нужно управлять корреляцией между запросами и ответами.
* **Более высокая пропускная способность.** Это означает, что операции могут выполняться быстрее, так как Центр Интернета вещей не обеспечивает устойчивость. При использовании Центра Интернета вещей повышается число вызовов методов на компонент по сравнению с сообщениями, отправляемыми из облака на устройство.

Сообщения, отправляемые из облака на устройство, не являются командами для устройства. Облачная служба просто передает некоторые сведения для устройства, которые оно может использовать в свободное время. Устройство может отвечать или не отвечать на эти сведения. Время ожидания сообщений, отправляемых из облака на устройство, гораздо больше (до 48 часов), а срок действия методов истекает гораздо быстрее.

Используйте методы устройства для немедленного вызова команды на устройстве, а задания — для запланированного вызова.

## <a name="method-lifecycle"></a>Жизненный цикл метода
Методы реализуются на устройстве. Чтобы процесс создания экземпляра прошел удачно, может потребоваться указать входные данные в полезных данных метода или не указывать их. Вызов прямого метода осуществляется через обращенный к службе URI (`{iot hub}/twins/{device id}/methods/`). Устройство получает прямые методы через раздел MQTT для устройства (`$iothub/methods/POST/{method name}/`). В будущем, возможно, будет реализована поддержка методов в дополнительных сетевых протоколах на стороне устройства.

> [!NOTE]
> При вызове прямого метода на устройстве имена и значения свойств могут содержать только печатаемые буквенно-цифровые знаки US-ASCII, кроме любого из следующих: ``{'$', '(', ')', '<', '>', '@', ',', ';', ':', '\', '"', '/', '[', ']', '?', '=', '{', '}', SP, HT}``.
> 
> 

Методы синхронные, и после истечения времени ожидания (значение по умолчанию — 30 секунд, которое можно увеличить до 3600 секунд) они либо выполняются успешно, либо завершаются с ошибкой. Методы полезны в интерактивных сценариях, когда нужно, чтобы устройство отвечало, только если оно находится в сети и принимает команды, такие как включение света с помощью телефона. В этих случаях об успешном или неудачном выполнении нужно узнавать немедленно, чтобы облачная служба смогла как можно быстрее отреагировать с учетом результата. В результате выполнения метода устройство может возвратить некоторый текст сообщения. Однако это действие не является обязательным для метода. Упорядочивание или обеспечение какой-либо семантики параллелизма при вызове метода не гарантировано.

При вызове метода устройства со стороны облака используется только протокол HTTP, а при вызове со стороны устройства — только протокол MQTT.

## <a name="reference"></a>Справочные материалы
### <a name="service-facing"></a>Обращение к службе
#### <a name="method-invocation"></a>Вызов метода
Вызов прямого метода на устройстве является вызовом HTTP, включающим следующие элементы:

* *URI* конкретного устройства (`{iot hub}/twins/{device id}/methods/`);
* *метод* POST;
* *заголовки*, содержащие сведения об авторизации, идентификатор запроса, тип и кодировку содержимого;
* прозрачный *текст* JSON в следующем формате:

```
{
    "methodName": "reboot",
    "timeoutInSeconds": 200,
    "payload": {
        "input1": "someInput",
        "input2": "anotherInput"
    }
}
```

  Время ожидания измеряется в секундах. Если время ожидания не указано, то используется значение по умолчанию (30 секунд).

#### <a name="response"></a>Ответ
Серверная часть получает ответ, включающий в себя следующие элементы:

* *код состояния HTTP*, который используется для ошибок, поступающих из Центра Интернета вещей, включая ошибку 404 для неподключенных устройств;
* *заголовки*, содержащие Etag, идентификатор запроса, тип и кодировку содержимого;
* *текст* JSON в следующем формате:

```
{
    "status" : "OK",
    "payload" : {...}
}
```

   Значения `status` и `body` предоставляются устройством и используются для ответа, который содержит код состояния устройства и/или описание.

### <a name="device-facing"></a>Обращение к устройству
#### <a name="method-invocation"></a>Вызов метода
Устройства получают запросы на прямой метод в разделе MQTT: `$iothub/methods/POST/{method name}/?$rid={request id}`.

Устройство получает текст следующего формата:

```
{
    "input1": "someInput",
    "input2": "anotherInput"
}
```

Запросы метода имеют нулевой уровень качества обслуживания.

#### <a name="response"></a>Ответ
Устройство отправляет ответы в `$iothub/methods/res/{status}/?$rid={request id}`, где:

* свойство `status` — это состояние выполнения метода, которое поддерживает устройство;
* свойство `$rid` — это идентификатор запроса из вызова метода, полученного от Центра Интернета вещей.

Текст задает устройство. Он может находиться в любом состоянии.

### <a name="additional-reference-material"></a>Дополнительные справочные материалы
Другие справочные статьи в руководстве для разработчиков:

* Статья [Конечные точки Центра Интернета вещей][lnk-endpoints] содержит информацию о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Throttling and quotas][lnk-quotas] (Регулирование и квоты) содержит информацию о квотах, применимых к службе Центра Интернета вещей, и ожидаемом поведении регулирования при использовании службы.
* В статье [Пакеты SDK для устройств и служб Центра Интернета вещей][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Язык запросов для двойников, методов и заданий][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках, методах и заданиях устройств из Центра Интернета вещей.
* Статья [Поддержка MQTT в Центре Интернета вещей][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия
Теперь, когда вы узнали, как использовать прямые методы, вас могут заинтересовать следующие статьи руководства для разработчиков:

* [Планирование заданий на нескольких устройствах][lnk-devguide-jobs]

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующее руководство по Центру Интернета вещей:

* [Use cloud-to-device methods][lnk-methods-tutorial] (Использование методов передачи сообщений из облака на устройство)

<!-- links and images -->

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md

[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-methods-tutorial]: iot-hub-c2d-methods.md
[lnk-devguide-messages]: iot-hub-devguide-messaging.md



<!--HONumber=Oct16_HO2-->


