---
title: "Сохранение сообщений Центра Интернета вещей в хранилище данных Azure | Документация Майкрософт"
description: "Использование приложения-функции Azure для сохранения сообщений Центра Интернета вещей в хранилище таблиц Azure. Сообщения Центра Интернета вещей содержат такие сведения, как данные датчиков, отправленные из устройства Интернета вещей."
services: iot-hub
documentationcenter: 
author: shizn
manager: timtl
tags: 
keywords: "хранилище данных Центра Интернета вещей, хранилище для данных датчиков Центра Интернета вещей"
ms.assetid: 62fd14fd-aaaa-4b3d-8367-75c1111b6269
ms.service: iot-hub
ms.devlang: arduino
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 03/27/2017
ms.author: xshi
translationtype: Human Translation
ms.sourcegitcommit: 432752c895fca3721e78fb6eb17b5a3e5c4ca495
ms.openlocfilehash: de47a15dd4009b9a33a53fd981bc178eaa50c035
ms.lasthandoff: 03/30/2017


---
# <a name="save-iot-hub-messages-that-contain-information-like-sensor-data-to-azure-table-storage"></a>Сохранение сообщений Центра Интернета вещей, содержащих такие сведения, как данные датчиков, в хранилище таблиц Azure

> [!Note]
> Прежде чем приступить к работе с данным руководством, ознакомьтесь со статьей [Подключение Adafruit Feather HUZZAH ESP8266 к Центру Интернета вещей Azure в облаке](/iot-hub-arduino-huzzah-esp8266-get-started.md). В [этом руководстве](/iot-hub-arduino-huzzah-esp8266-get-started.md) описывается настройка устройства Интернета вещей и Центра Интернета вещей, а также развертывание примера приложения для выполнения на устройстве. Приложение отправляет собранные с датчиков данные в Центр Интернета вещей.

## <a name="what-you-will-learn"></a>Новые знания

Вы узнаете, как создать учетную запись хранения Azure и приложение-функцию Azure для сохранения сообщений Центра Интернета вещей в хранилище таблиц Azure.

## <a name="what-you-will-do"></a>Выполняемая задача

- Создайте учетную запись хранения Azure.
- Выполните подготовку к подключению Центра Интернета вещей для чтения сообщений.
- Создайте и разверните приложение-функцию Azure.

## <a name="what-you-will-need"></a>Необходимые условия

- Ознакомьтесь с руководством о [подключении платы ESP8266 к Центру Интернета вещей Azure](/iot-hub-arduino-huzzah-esp8266-get-started.md), по завершении которого у вас должны быть:
  - Активная подписка Azure.
  - Центр Интернета вещей Azure в подписке;
  - работающее приложение, отправляющее сообщения в Центр Интернета вещей Azure.

## <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

1. На портале Azure выберите **Создать** > **Хранилище** > **Учетная запись хранения**.
1. Введите необходимые сведения для учетной записи хранения:

   ![Создание учетной записи хранения на портале Azure](media\iot-hub-store-data-in-azure-table-storage\1_azure-portal-create-storage-account.png)

   **Имя**. Имя учетной записи хранения. Оно должно быть глобально уникальным.

   **Группа ресурсов**. Выберите ту же группу ресурсов, которую использует Центр Интернета вещей.

   **Закрепить на панели мониторинга**. Установите этот флажок, чтобы быстро открывать Центр Интернета вещей с помощью панели мониторинга.
1. Щелкните **Создать**.

## <a name="prepare-for-iot-hub-connection-to-read-messages"></a>Подготовка к подключению Центра Интернета вещей для чтения сообщений

Центр Интернета вещей предоставляет встроенную совместимую с концентратором событий конечную точку, с помощью которой приложение считывает сообщения Центра Интернета вещей. В то же время, чтобы считывать данные из Центра Интернета вещей, приложения используют группы получателей. Прежде чем создавать приложение-функцию Azure для считывания данных из Центра Интернета вещей, вам необходимо сделать следующее:

- получить строку подключения конечной точки Центра Интернета вещей;
- создать группу потребителей для Центра Интернета вещей.

### <a name="get-the-connection-string-of-your-iot-hub-endpoint"></a>Получение строки подключения конечной точки Центра Интернета вещей

1. Откройте Центр Интернета вещей.
1. В области **Центр Интернета вещей** в разделе **Сообщения** щелкните **Конечные точки**.
1. В правой области в разделе **Built-in endpoints** (Встроенные конечные точки) выберите **События**.
1. В области **Свойства** обратите внимание на следующие значения:
   - Конечная точка, совместимая с концентраторами событий
   - имя, совместимое с концентраторами событий.

   ![Получение строки подключения конечной точки Центра Интернета вещей на портале Azure](media\iot-hub-store-data-in-azure-table-storage\2_azure-portal-iot-hub-endpoint-connection-string.png)

1. В области **Центр Интернета вещей** в разделе **Параметры** выберите **Политики общего доступа**.
1. Щелкните **iothubowner**.
1. Запишите значение **первичного ключа**.
1. Используйте строку подключения конечной точки Центра Интернета вещей в следующем формате:

   `Endpoint=<Event Hub-compatible endpoint>;SharedAccessKeyName=iothubowner;SharedAccessKey=<Primary key>`

   > [!Note]
   > Замените значения `<Event Hub-compatible endpoint>` и `<Primary key>` значениями, которые вы записали.

### <a name="create-a-consumer-group-for-your-iot-hub"></a>Создание группы потребителей для Центра Интернета вещей

1. Откройте Центр Интернета вещей.
1. В области **Центр Интернета вещей** в разделе **Сообщения** щелкните **Конечные точки**.
1. В правой области в разделе **Built-in endpoints** (Встроенные конечные точки) выберите **События**.
1. В области **Свойства** в разделе **Группы потребителей** введите имя и запишите его.
1. Щелкните **Сохранить**.

## <a name="create-and-deploy-an-azure-function-app"></a>Создание и развертывание приложения-функции Azure

1. На [портале Azure](https://portal.azure.com/) щелкните **Создать** > **Вычисления** > **Приложение-функция**.
1. Введите необходимые сведения для приложения-функции.

   ![Создание приложения-функции на портале Azure](media\iot-hub-store-data-in-azure-table-storage\3_azure-portal-create-function-app.png)

   **Имя приложения**. Имя приложения-функции. Оно должно быть глобально уникальным.

   **Группа ресурсов**. Выберите ту же группу ресурсов, которую использует Центр Интернета вещей.

   **Учетная запись хранения**. Созданная вами учетная запись хранения.

   **Закрепить на панели мониторинга**. Установите этот флажок, чтобы быстро открывать приложение-функцию с помощью панели мониторинга.
1. Щелкните **Создать**.
1. Когда приложение-функция будет создано, откройте его.
1. Создайте новую функцию приложения-функции.
   1. Щелкните **Новая функция**.
   1. Для параметра **Язык** выберите **JavaScript**, а для **Сценарий** — **Обработка данных**.
   1. Щелкните шаблон **EventHubTrigger-JavaScript**.
   1. Введите необходимые сведения для шаблона.

      **Присвойте имя функции**. Имя функции.

      **Имя концентратора событий**. Имя, совместимое с концентратором событий, которое вы записали ранее.

      **Подключение к концентратору событий**. Щелкните новое подключение, чтобы добавить строку подключения конечной точки Центра Интернета вещей, которую вы создали.
   1. Щелкните **Создать**.
1. Настройте выходные данные функции.
   1. Щелкните **Интегрировать** > **Новое выходное значение** > **Хранилище таблиц Azure** > **Выбрать**.

      ![Добавление хранилища таблиц в приложение-функцию на портале Azure](media\iot-hub-store-data-in-azure-table-storage\4_azure-portal-function-app-add-output-table-storage.png)
   1. Введите необходимые сведения.

      **Имя таблицы**. Используйте `deviceData` для имени.

      **Подключение к учетной записи хранения**. Щелкните **Новые** и выберите свою учетную запись хранения.
   1. Щелкните **Сохранить**.
1. В разделе **Триггеры** щелкните **Концентратор событий Azure (myEventHubTrigger)**.
1. В разделе **Группа пользователей концентратора событий** введите имя созданной вами группы получателей, а затем щелкните **Сохранить**.
1. Выберите **Разработка**, а затем щелкните **Просмотреть файлы**.
1. Щелкните **Добавить**, чтобы добавить новый файл с именем `package.json`, вставьте сведения, приведенные ниже, а затем щелкните **Сохранить**.

   ```json
   {
      "name": "iothub_save_message_to_table",
      "version": "0.0.1",
      "private": true,
      "main": "index.js",
      "author": "Microsoft Corp.",
      "dependencies": {
         "azure-iothub": "1.0.9",
         "azure-iot-common": "1.0.7",
         "moment": "2.14.1"
      }
   }
   ```
1. Замените код в `index.js` следующим кодом, а затем щелкните **Сохранить**.

   ```javascript
   'use strict';

   // This function is triggered each time a message is revieved in the IoTHub.
   // The message payload is persisted in an Azure Storage Table
   var moment = require('moment');

   module.exports = function (context, iotHubMessage) {
      context.log('Message received: ' + JSON.stringify(iotHubMessage));
      context.bindings.outputTable = {
      "partitionKey": moment.utc().format('YYYYMMDD'),
         "rowKey": moment.utc().format('hhmmss') + process.hrtime()[1] + '',
         "message": JSON.stringify(iotHubMessage)
      };
      context.done();
   };
   ```
1. Щелкните **Параметры приложения-функции** > **Открыть консоль для разработчиков**.

   Вы должны находиться в папке `wwwroot` приложения-функции.
1. Перейдите в папку функции, выполнив команду ниже.

   ```bash
   cd <your function name>
   ```
1. Установите пакет NPM, выполнив команду ниже.

   ```bash
   npm install
   ```

   > [!Note]
   > Установка может занять некоторое время.

Вы создали приложение-функцию. Оно сохраняет сообщения, которые получает Центр Интернета вещей, в хранилище таблиц Azure.

> [!Note]
> Используйте кнопку **Выполнить** для тестирования приложения-функции. Если вы нажмете кнопку **Выполнить**, в Центр Интернета вещей будет отправлено тестовое сообщение. Доставка сообщения должна активировать запуск приложения-функции, после чего сообщение сохранится в хранилище таблиц Azure. В области **Журналы** записываются сведения о процессе.

## <a name="verify-your-message-in-your-table-storage"></a>Проверка сообщений в хранилище таблиц

1. Выполните пример приложения на устройстве, чтобы отправить сообщения в Центр Интернета вещей.
1. [Скачайте и установите обозреватель хранилищ Microsoft Azure](http://storageexplorer.com/).
1. Откройте обозреватель хранилищ Microsoft Azure, щелкните **Add an Azure Account (Добавление учетной записи Azure)** > **Вход**, а затем выполните вход в свою учетную запись Azure.
1. Щелкните подписку Azure > **Учетные записи хранения** > ваша учетная запись хранения > **Таблицы** > **deviceData**.

   Вы должны увидеть сообщения, отправленные с устройства в Центр Интернета вещей, в таблице `deviceData`.

## <a name="next-steps"></a>Дальнейшие действия

Вы успешно создали учетную запись хранения Azure и приложение-функцию Azure для сохранения сообщений, поступающих в Центр Интернета вещей, в хранилище таблиц Azure.

Чтобы продолжить знакомство с центром IoT и изучить другие сценарии IoT, см. следующие ресурсы:

- [Управление обменом сообщениями между устройством и облаком с помощью обозревателя Центра Интернета вещей](iot-hub-explorer-cloud-device-messaging.md)
