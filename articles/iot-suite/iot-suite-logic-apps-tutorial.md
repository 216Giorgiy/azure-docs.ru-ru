.<properties
  pageTitle="Azure IoT Suite и приложения логики | Microsoft Azure"
  description="Руководство по подключению приложений логики к Azure IoT Suite для бизнес-процесса."
  services=""
  suite="iot-suite"
  documentationCenter=""
  authors="aguilaaj"
  manager="timlt"
  editor=""/>

.<tags
  ms.service="iot-suite"
  ms.devlang="na"
  ms.topic="article"
  ms.tgt_pltfrm="na"
  ms.workload="na"
  ms.date="08/16/2016"
  ms.author="araguila"/>
  
# Руководство. Подключение приложения логики к предварительно настроенному решению для удаленного мониторинга Azure IoT Suite

Предварительно настроенное решение для удаленного мониторинга [Microsoft Azure IoT Suite][lnk-internetofthings] позволяет быстро начать работу с полным набором возможностей, которыми обладает решение IoT. В этом учебнике описаны действия по добавлению приложения логики к предварительно настроенному решению для удаленного мониторинга Microsoft Azure IoT Suite. Эти шаги показывают, как продвинуть свое решение IoT еще дальше, подключив его к бизнес-процессу.

_Если вы ищете пошаговое руководство по подготовке предварительно настроенного решения для удаленного мониторинга, обратитесь к разделу [Руководство. Приступая к работе с предварительно настроенными решениями IoT][lnk-getstarted]._

Перед началом работы с данным учебником необходимо выполнить описанные ниже действия.

- Подготовьте в своей подписке Azure предварительно настроенное решение для удаленного мониторинга.

- Создайте учетную запись SendGrid для отправки сообщений электронной почты, которые будут запускать бизнес-процесс. Бесплатную пробную учетную запись можно создать на сайте [SendGrid](https://sendgrid.com/), нажав кнопку **Try for Free** (Попробовать бесплатно). После регистрации бесплатной пробной учетной записи необходимо создать в SendGrid [ключ API](https://sendgrid.com/docs/User_Guide/Settings/api_keys.html), который предоставляет разрешения на отправку электронной почты. Ключ API используется далее в этом учебнике.

Если вы уже подготовили предварительно настроенное решение для удаленного мониторинга, то перейдите к группе ресурсов для этого решения на [портале Azure][lnk-azureportal]. Имя группы ресурсов совпадает с именем решения, которое было выбрано при подготовке решения для удаленного мониторинга. В группе ресурсов можно просмотреть все подготовленные ресурсы Azure для вашего решения (за исключением приложения Azure Active Directory, которое можно найти на классическом портале Azure). На следующем рисунке показан пример колонки **Группа ресурсов** для предварительного настроенного решения для удаленного мониторинга:

.![](media/iot-suite-logic-apps-tutorial/resourcegroup.png)

Для начала настройте приложение логики, которое будет использоваться с предварительно настроенным решением.

## Настройка приложения логики

1. Щелкните __Добавить__ в верхней части колонки группы ресурсов на портале Azure.

2. Найдите __Приложение логики__, выберите его и нажмите кнопку **Создать**.

3. Заполните поле __Имя__. Затем укажите те же **Подписку** и **Группу ресурсов**, которые использовались при подготовке решения для удаленного мониторинга. Щелкните __Создать__.

    .![](media/iot-suite-logic-apps-tutorial/createlogicapp.png)

4. После завершения развертывания приложение логики отобразится в качестве ресурса в вашей группе ресурсов.

5. Щелкните приложение логики, чтобы перейти к колонке "Приложение логики". Выберите шаблон **Blank Logic App** (Пустое приложение логики). При этом откроется **Конструктор Logic Apps**.

    .![](media/iot-suite-logic-apps-tutorial/logicappsdesigner.png)

6. Выберите __Запрос__. Это действие указывает, что в качестве триггера выступает входящий HTTP-запрос с полезными данными в определенном формате JSON.

7. Вставьте следующий код в поле "Схема JSON текста запроса":

    ```
    {
      "$schema": "http://json-schema.org/draft-04/schema#",
      "id": "/",
      "properties": {
        "DeviceId": {
          "id": "DeviceId",
          "type": "string"
        },
        "measuredValue": {
          "id": "measuredValue",
          "type": "integer"
        },
        "measurementName": {
          "id": "measurementName",
          "type": "string"
        }
      },
      "required": [
        "DeviceId",
        "measurementName",
        "measuredValue"
      ],
      "type": "object"
    }
    ```
    
    Примечание. Сохранив приложение логики, можно скопировать URL-адрес метода HTTP POST, но сначала необходимо добавить действие.

8. Нажмите кнопку __+ Новый шаг__ под своим триггером. Затем выберите **Добавить действие**.

    .![](media/iot-suite-logic-apps-tutorial/logicappcode.png)

9. Найдите действие **SendGrid - Send email** (SendGrid — отправить письмо) и щелкните его.

    .![](media/iot-suite-logic-apps-tutorial/logicappaction.png)

10. Введите имя подключения, например **SendGridConnection**, укажите **ключ API SendGrid**, созданный при настройке учетной записи SendGrid, и нажмите кнопку **Create** (Создать).

    .![](media/iot-suite-logic-apps-tutorial/sendgridconnection.png)

11. Добавьте свои адреса электронной почты в поля **From** (От) и **To** (Кому). В поле **Subject** (Тема) добавьте **Remote monitoring alert [DeviceId]** (Оповещение удаленного мониторинга [DeviceId]). В поле **Email Body** (Текст сообщения электронной почты) укажите **Device [DeviceId] has reported [measurementName] with value [measuredValue].** (Устройство [DeviceId] передало значение [measuredValue] для измерения [measurementName]). Параметры **[DeviceId]**, **[measurementName]** и **[measuredValue]** можно добавить с помощью раздела **You can insert data from previous steps** (Можно вставить данные из предыдущих шагов).

    .![](media/iot-suite-logic-apps-tutorial/sendgridaction.png)

12. Нажмите кнопку __Сохранить__ в верхнем меню.

13. Щелкните триггер **Запрос** и скопируйте значение __HTTP POST на этот URL-адрес__. Этот URL-адрес потребуется далее в этом учебнике.

> [AZURE.NOTE] Приложения логики позволяют запускать [множество действий различных типов][lnk-logic-apps-actions], в том числе действия в Office 365.

## Настройка веб-задания EventProcessor

В этом разделе вы подключите предварительно настроенное решение к созданному приложению логики. Чтобы выполнить эту задачу, необходимо добавить URL-адрес для вызова приложения логики к действию, которое запускается, когда значение датчика устройства превышает пороговое значение.

1. С помощью клиента git клонируйте последнюю версию [репозитория github azure-iot-remote-monitoring][lnk-rmgithub]. Например:

    ```
    git clone https://github.com/Azure/azure-iot-remote-monitoring.git
    ```

2. В Visual Studio откройте файл __RemoteMonitoring.sln__ из локальной копии репозитория.

3. Откройте файл __ActionRepository.cs__ в папке **Infrastructure\\Repository**.

4. Измените словарь **actionIds**, указав в нем значение __HTTP POST на этот URL-адрес__, которое вы записали из приложения логики.

    ```
    private Dictionary<string,string> actionIds = new Dictionary<string, string>()
    {
        { "Send Message", "<Http Post to this UR>" },
        { "Raise Alarm", "<Http Post to this UR> }
    };
    ```

5. Сохраните изменения в решении и закройте Visual Studio.

## Развертывание из командной строки

В этом разделе вы развернете обновленную версию решения для удаленного мониторинга, заменив ту версию, которая в настоящее время работает в Azure.

1. Следуйте инструкциям [по настройке для разработчиков][lnk-devsetup], чтобы настроить свою среду для развертывания.

2.  Для локального развертывания следуйте инструкциям [по локальному развертыванию][lnk-localdeploy].

3.  Для развертывания в облако с обновлением существующего развертывания в облаке следуйте инструкциям [по развертыванию в облаке][lnk-clouddeploy]. В качестве имени развертывания используйте имя исходного развертывания. Например, если исходное развертывание называлось **demologicapp**, используйте следующую команду:

    .``
    build.cmd cloud release demologicapp
    ``
    
    При запуске сценария сборки обязательно используйте те же учетную запись, подписку, регион Azure и экземпляр Active Directory, которые применялись при подготовке решения.

## Проверка приложения логики в действии

При подготовке предварительно настроенного решения для удаленного мониторинга в нем по умолчанию настроены два правила. Оба правила применяются к устройству **SampleDevice001**:

* Температура > 38,00
* Влажность > 48,00

Правило для температуры активирует действие **Raise Alarm**, а правило для влажности — действие **SendMessage**. При условии, что для обоих действий в классе **ActionRepository** используется один и тот же URL-адрес, приложение логики срабатывает для каждого правила. Оба правила используют SendGrid для отправки электронной почты с подробными сведениями о предупреждении на адрес, указанный в поле **Кому**.

> [AZURE.NOTE] Приложение логики будет срабатывать при каждом превышении порогового значения. Чтобы избежать получения ненужных электронных сообщений, можно отключить правила на портале решения или отключить приложение логики на [портале Azure][lnk-azureportal].

Наряду с получением электронных писем вы также можете наблюдать за работой приложения логики на портале:

.![](media/iot-suite-logic-apps-tutorial/logicapprun.png)

## Дальнейшие действия

Теперь когда вы использовали приложение логики для подключения предварительно настроенного решения к бизнес-процессу, можете ознакомиться с дополнительными сведениями о настройке таких решений:

- [Использование динамической телеметрии с предварительно настроенным решением для удаленного мониторинга][lnk-dynamic]
- [Метаданные сведений об устройстве в предварительно настроенном решении для удаленного мониторинга][lnk-devinfo]

[lnk-dynamic]: iot-suite-dynamic-telemetry.md
[lnk-devinfo]: iot-suite-remote-monitoring-device-info.md

[lnk-internetofthings]: https://azure.microsoft.com/documentation/suites/iot-suite/
[lnk-getstarted]: iot-suite-getstarted-preconfigured-solutions.md
[lnk-azureportal]: https://portal.azure.com
[lnk-logic-apps-actions]: ../connectors/apis-list.md
[lnk-rmgithub]: https://github.com/Azure/azure-iot-remote-monitoring
[lnk-devsetup]: https://github.com/Azure/azure-iot-remote-monitoring/blob/master/Docs/dev-setup.md
[lnk-localdeploy]: https://github.com/Azure/azure-iot-remote-monitoring/blob/master/Docs/local-deployment.md
[lnk-clouddeploy]: https://github.com/Azure/azure-iot-remote-monitoring/blob/master/Docs/cloud-deployment.md

<!---HONumber=AcomDC_0817_2016-->