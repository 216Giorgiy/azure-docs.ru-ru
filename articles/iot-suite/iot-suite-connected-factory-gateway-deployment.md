---
title: "Развертывание шлюза подключенных фабрики - Azure | Документы Microsoft"
description: "Развертывание шлюза под управлением Windows или Linux, для обеспечения подключения к подключенной фабрики предварительно настроенных решений."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 12/11/2017
ms.author: dobett
ms.openlocfilehash: 1506488193638400af7c71b3ecd00e99512daa62
ms.sourcegitcommit: 85012dbead7879f1f6c2965daa61302eb78bd366
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/02/2018
---
# <a name="deploy-an-edge-gateway-for-the-connected-factory-preconfigured-solution-on-windows-or-linux"></a>Развернуть шлюз для решения подключенных фабрики предварительно настроен в Windows или Linux

Компоненты, необходимые два программного обеспечения для развертывания шлюза edge для *подключенных фабрики* предварительно настроенных решений:

- *Прокси OPC* устанавливает соединение с подключенной фабрики. OPC прокси-сервер ожидает команды и управления сообщения от интеграции браузер OPC, работающей на портале решения подключенных фабрики.

- *Издатель OPC* соединяется с существующие локальные серверы OPC UA и пересылает сообщения телеметрии на их основе подключенной фабрики. Можно подключиться OPC классический устройствами с помощью [OPC классический адаптер для OPC UA](https://github.com/OPCFoundation/UA-.NETStandard/blob/master/ComIOP/README.md).

Оба компонента с открытым исходным кодом и доступны в качестве источника на GitHub и как контейнеры Docker на DockerHub:

| GitHub | DockerHub |
| ------ | --------- |
| [Издатель OPC](https://github.com/Azure/iot-edge-opc-publisher) | [Издатель OPC](https://hub.docker.com/r/microsoft/iot-edge-opc-publisher/)   |
| [OPC прокси-сервера](https://github.com/Azure/iot-edge-opc-proxy)         | [OPC прокси-сервера](https://hub.docker.com/r/microsoft/iot-edge-opc-proxy/) |

Не следует соблюдать это общедоступный IP-адрес или открыть входящие порты в брандмауэре шлюза для любого компонента. Компоненты OPC прокси-сервер и издатель OPC использовать только исходящий порт 443.

Шаги в этой статье показано, как развернуть шлюз с помощью Docker в Windows или Linux. Шлюз обеспечивает возможность подключения к подключенной фабрики предварительно настроенных решений. Можно также использовать компоненты без подключенных фабрики.

> [!NOTE]
> Оба компонента можно использовать в качестве модули в [Azure IoT Edge](https://github.com/Azure/iot-edge).

## <a name="choose-a-gateway-device"></a>Выберите устройство шлюза

Если у вас еще нет устройства шлюза, то корпорация Майкрософт рекомендует приобрести коммерческий шлюз у одного из ее партнеров. Список устройств, совместимые с помощью решения для подключенных фабрики шлюза, [каталога устройства Azure IoT](https://catalog.azureiotsuite.com/?q=opc). Настройте шлюз, следуя приложенным к устройству инструкциям.

Кроме того используйте следующие инструкции, чтобы вручную настроить существующее устройство шлюза.

## <a name="install-and-configure-docker"></a>Установка и настройка Docker

Установка [Docker для Windows](https://www.docker.com/docker-windows) на устройстве под управлением Windows шлюза или используйте диспетчер пакетов, чтобы установить docker на устройстве шлюза под управлением Linux.

Во время установки Docker для Windows выберите накопитель на хост-компьютере для совместного использования с помощью Docker. На следующем рисунке показан общий доступ к **D** диска в системе Windows, чтобы разрешить доступ к диску узла из внутри контейнера docker:

![Установка Docker для Windows](./media/iot-suite-connected-factory-gateway-deployment/image1.png)

> [!NOTE]
> Кроме того, этот этап можно выполнить после установки docker из **параметры** диалогового окна. Щелкните правой кнопкой мыши **Docker** значок на панели задач Windows и выберите **параметры**.

При использовании Linux, дополнительная настройка не требуется для доступа к файловой системе.

В Windows создайте папку на диске, совместно использующих Docker, в Linux создать папку в корневой файловой системы. В данном пошаговом руководстве в эту папку как `<SharedFolder>`.

При ссылке на `<SharedFolder>` в команде Docker, обязательно используйте правильный синтаксис для вашей операционной системы. Ниже приведены два примера, один для Windows и один для Linux.

- Если выполняется с помощью папки `D:\shared` в Windows как ваш `<SharedFolder>`, синтаксис команд Docker `//d/shared`.

- Если выполняется с помощью папки `/shared` в Linux, как ваш `<SharedFolder>`, синтаксис команд Docker `/shared`.

Дополнительные сведения см. [использовать тома](https://docs.docker.com/engine/admin/volumes/volumes/) docker ссылку на модуль.

## <a name="configure-the-opc-components"></a>Настройка компонентов OPC

Прежде чем устанавливать компоненты OPC, выполните следующие действия для подготовки вашей среды:

1. Для завершения развертывания шлюза необходимо **iothubowner** строка подключения центр IoT в развертывании подключенных фабрики. В [портал Azure](http://portal.azure.com/), перейдите к концентратору IoT в группе ресурсов, созданные при развертывании решения подключенных фабрики. Щелкните **Политики общего доступа** для доступа к строке подключения **iothubowner**:

    ![Поиск строки подключения Центра Интернета вещей](./media/iot-suite-connected-factory-gateway-deployment/image2.png)

    Копировать **строки первичного ключа подключения** значение.

1. Чтобы обеспечить взаимодействие между контейнеры docker, необходимо сетевого bridge определяемых пользователем. Создание моста сети для вашего контейнеров, выполните следующие команды в командной строке:

    ```cmd/sh
    docker network create -d bridge iot_edge
    ```

    Чтобы проверить **iot_edge** мост сеть создана, выполните следующую команду:

    ```cmd/sh
    docker network ls
    ```

    Ваш **iot_edge** сетевого bridge включается в список сетей.

Чтобы запустить издатель OPC, выполните следующую команду в командной строке:

```cmd/sh
docker run --rm -it -v <SharedFolder>:/docker -v x509certstores:/root/.dotnet/corefx/cryptography/x509stores --network iot_edge --name publisher -h publisher -p 62222:62222 --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-publisher:2.1.3 publisher "<IoTHubOwnerConnectionString>" --lf /docker/publisher.log.txt --as true --si 1 --ms 0 --tm true --vc true --di 30
```

- [OPC издателя GitHub](https://github.com/Azure/iot-edge-opc-publisher) и [docker запуска ссылку](https://docs.docker.com/engine/reference/run/) представлены дополнительные сведения о:

  - Параметры командной строки docker, прежде чем имя контейнера (`microsoft/iot-edge-opc-publisher:2.1.3`).
  - Значения параметров командной строки издателя OPC указано после имени контейнера (`microsoft/iot-edge-opc-publisher:2.1.3`).

- `<IoTHubOwnerConnectionString>` — **Iothubowner** общую строку соединения политики доступа на портале Azure. Эта строка подключения, скопированные на предыдущем шаге. Требуется только в этой строке подключения при первом запуске издателя OPC. При последующих запусках следует пропустить его так, как он представляет угрозу безопасности.

- `<SharedFolder>` Используется и его синтаксис описан в разделе [установить и настроить Docker](#install-and-configure-docker). OPC издатель использует `<SharedFolder>` для чтения файл конфигурации издателя OPC, записать файл журнала и сделать оба эти файлы недоступны за пределами контейнера.

- Издатель OPC считывает конфигурацию от **publishednodes.json** файл, который следует поместить в `<SharedFolder>/docker` папки. Этот файл конфигурации определяет OPC UA узел данных на заданном сервере OPC UA, должна быть подписана на издателе OPC.

- Каждый раз, когда сервер OPC UA уведомляет издателя OPC изменения данных, новое значение отправляется центр IoT. В зависимости от параметров пакетной обработки OPC издателя, возможно, сначала собираются данные перед отправкой данных в пакете центр IoT.

- Полный синтаксис **publishednodes.json** файл описан на [издатель OPC](https://github.com/Azure/iot-edge-opc-publisher) страницы на сайте GitHub.

    В следующем фрагменте показано простой пример **publishednodes.json** файла. В этом примере показано, как опубликовать **CurrentTime** значения с сервера с именем узла OPC UA **win10pc**:

    ```json
    [
      {
        "EndpointUrl": "opc.tcp://win10pc:48010",
        "OpcNodes": [
          {
            "ExpandedNodeId": "nsu=http://opcfoundation.org/UA/;i=2258"
          }
        ]
      }
    ]
    ```

    В **publishednodes.json** файл UA OPC, сервер указан в URL-адресе конечной точки. При указании имени узла, с помощью метка в имени узла (например, **win10pc**) как в предыдущем примере вместо IP-адрес должен быть способен разрешить это метка в имени узла в IP-адрес разрешения сетевых адресов в контейнере.

- Docker не поддерживает разрешение имен NetBIOS, единственным разрешение имен DNS. Если в сети нет DNS-сервера, можно использовать решение, показанный в предыдущем примере командной строки. В предыдущем примере командной строки используется `--add-host` параметр, чтобы добавить запись в файл hosts контейнеров. Этот элемент позволяет выполнять поиск имени узла для заданного `<OpcServerHostname>`, разрешения для данного IP-адреса `<IpAddressOfOpcServerHostname>`.

- OPC UA используются сертификаты X.509 для проверки подлинности и шифрования. Необходимо поместить сертификат издателя OPC на сервере OPC агент пользователя, которому вы подключаетесь, чтобы убедиться, что она доверяет OPC издателя. Хранилище сертификатов издателя OPC находится в `<SharedFolder>/CertificateStores` папки. Можно найти сертификат издателя OPC в `trusted/certs` папки в `CertificateStores` папки.

  Действия по настройке сервера OPC UA зависят от устройства, которые вы используете. Обычно эти шаги описаны в руководстве пользователя сервера OPC UA.

Чтобы установить прокси OPC, выполните следующую команду в командной строке:

```cmd/sh
docker run -it --rm -v <SharedFolder>:/mapped --network iot_edge --name proxy --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-proxy:1.0.2 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db
```

Необходимо только один раз запустить установку на компьютере.

Используйте следующую команду для запуска OPC прокси-сервера:

```cmd/sh
docker run -it --rm -v <SharedFolder>:/mapped --network iot_edge --name proxy --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-proxy:1.0.2 -D /mapped/cs.db
```

Прокси-сервер OPC сохраняет строку подключения во время установки. При последующих запусках следует пропустить строку подключения, так как он представляет угрозу безопасности.

## <a name="enable-your-gateway"></a>Включить шлюз

Выполните следующие действия, чтобы включить шлюз в подключенной фабрики предварительно настроенных решений.

1. Если оба компонента работают, перейдите к **подключения сервер UA OPC** на портале фабрики подключенных решений. Эта страница доступна только администраторам в решении. Введите URL-адрес конечной точки издателя (opc.tcp://publisher: 62222) и нажмите кнопку **Connect**.

1. Установите отношение доверия между порталом подключенных фабрики и издатель OPC. Когда появится предупреждение о сертификате, нажмите кнопку **Продолжение**. После этого появится сообщение об ошибке, OPC издатель не является доверенным для веб-агент пользователя клиента. Чтобы устранить эту ошибку, скопируйте **веб-агент пользователя клиента** сертификат от `<SharedFolder>/CertificateStores/rejected/certs` папки `<SharedFolder>/CertificateStores/trusted/certs` папки на шлюзе. Необходимо перезапустить шлюз.

Теперь вы можете подключиться к шлюзу из облака, а также вы готовы добавить серверы OPC UA в решение.

## <a name="add-your-own-opc-ua-servers"></a>Добавьте серверы OPC UA

Для добавления собственных OPC США серверов для подключенных фабрики предварительно настроенных решений:

1. Перейдите к **подключение сервера OPC UA** на портале фабрики подключенных решений. Выполните те же действия, как в предыдущем разделе, чтобы установить отношение доверия между порталом подключенных фабрики и сервере OPC UA.

    ![Портал решения](./media/iot-suite-connected-factory-gateway-deployment/image4.png)

1. Обзор дерева узлов OPC UA OPC UA сервера щелкните правой кнопкой мыши узлы OPC, вы хотите отправить подключенных фабрики и выберите **публикации**.

1. Телеметрия теперь поступает с устройства шлюза. Можно просмотреть телеметрии в **расположения фабрики** представление портале подключенных фабрики в разделе **новую фабрику**.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об архитектуре подключенных фабрики предварительно настроенных решений см. в разделе [подключенных фабрики заранее настроенные Пошаговое руководство по решениям](https://docs.microsoft.com/en-us/azure/iot-suite/iot-suite-connected-factory-sample-walkthrough).

Прочитайте о [справочной реализации модуля издателя OPC](https://docs.microsoft.com/en-us/azure/iot-suite/iot-suite-connected-factory-publisher).