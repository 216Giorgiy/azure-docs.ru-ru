---
title: "Развертывание шлюза для подключенной фабрики Azure | Документация Майкрософт"
description: "Узнайте, как развернуть шлюз в ОС Windows или Linux, чтобы обеспечить подключение к предварительно настроенному решению подключенной фабрики."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/17/2018
ms.author: dobett
ms.openlocfilehash: 4606cb676c3ab7c8c8511579f43d251ff7d2ae8a
ms.sourcegitcommit: 7edfa9fbed0f9e274209cec6456bf4a689a4c1a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2018
---
# <a name="deploy-an-edge-gateway-for-the-connected-factory-preconfigured-solution-on-windows-or-linux"></a>Развертывание шлюза Edge для предварительно настроенного решения подключенной фабрики в ОС Windows или Linux

Для развертывания шлюза Edge в предварительно настроенном решении *подключенной фабрики* необходимы два программных компонента:

- *Прокси-сервер OPC* устанавливает подключение к подключенной фабрике. Затем прокси-сервер OPC ожидает команду и контрольные сообщения от встроенного браузера OPC, работающего на портале решения подключенной фабрики.

- *Издатель OPC* соединяется с существующими локальными серверами OPC UA и пересылает сообщения телеметрии от них в подключенную фабрику. Вы можете подключить классическое устройство OPC с помощью [адаптера классического устройства OPC для OPC UA](https://github.com/OPCFoundation/UA-.NETStandard/blob/master/ComIOP/README.md).

Оба компонента имеют открытый исходный код и доступны в виде файлов с исходным кодом на GitHub и в качестве контейнеров Docker на DockerHub:

| GitHub | DockerHub |
| ------ | --------- |
| [Издатель OPC](https://github.com/Azure/iot-edge-opc-publisher) | [Издатель OPC](https://hub.docker.com/r/microsoft/iot-edge-opc-publisher/)   |
| [Прокси-сервер OPC](https://github.com/Azure/iot-edge-opc-proxy)         | [Прокси-сервер OPC](https://hub.docker.com/r/microsoft/iot-edge-opc-proxy/) |

Для этих компонентов не требуется общедоступный IP-адрес или открытые входящие порты брандмауэра шлюза. Прокси-сервер OPC и издатель OPC используют только исходящий порт 443.

Описанные в этой статье действия показывают, как развернуть шлюз Edge с помощью Docker в ОС Windows или Linux. Шлюз обеспечивает подключение к предварительно настроенному решению подключенной фабрики. Компоненты также можно использовать без подключенной фабрики.

> [!NOTE]
> Оба компонента могут использоваться как модули в [Azure IoT Edge ](https://github.com/Azure/iot-edge).

## <a name="choose-a-gateway-device"></a>Выбор устройства шлюза

Если у вас еще нет устройства шлюза, то корпорация Майкрософт рекомендует приобрести коммерческий шлюз у одного из ее партнеров. Для получения списка устройств шлюза, совместимых с решением подключенной фабрики, посетите [каталог устройств Azure IoT](https://catalog.azureiotsuite.com/?q=opc). Настройте шлюз, следуя приложенным к устройству инструкциям.

Кроме того, можно воспользоваться приведенными ниже инструкциями, чтобы вручную настроить существующее устройство шлюза.

## <a name="install-and-configure-docker"></a>Установка и настройка Docker

Установите [Docker для ОС Windows](https://www.docker.com/docker-windows) на устройстве шлюза с ОС Windows или используйте диспетчер пакетов для установки Docker на устройстве шлюза с ОС Linux.

Во время установки Docker для ОС Windows выберите на хост-компьютере диск, который будет использоваться совместно с Docker. На следующем снимке экрана показано, как в системе Windows настроить совместное использование диска **D** для разрешения доступа из контейнера Docker к диску узла.

![Установка Docker для ОС Windows](./media/iot-suite-connected-factory-gateway-deployment/image1.png)

> [!NOTE]
> Можно также выполнить этот шаг после установки Docker из диалогового окна **Параметры**. Щелкните правой кнопкой мыши значок программы **Docker** на панели задач Windows и выберите **Параметры**. Если основные обновления Windows были развернуты в систему, например обновление Windows Fall Creators, отключите совместное использование дисков, а затем снова включите его, чтобы обновить права доступа.

При использовании ОС Linux для включения доступа к файловой системе дополнительная настройка не требуется.

В ОС Windows создайте папку на диске, к которому предоставлен доступ для Docker, а в ОС Linux создайте папку в корневой файловой системе. В данном пошаговом руководстве эта папка называется `<SharedFolder>`.

Ссылаясь на `<SharedFolder>` в команде Docker, используйте правильный синтаксис для операционной системы. Ниже приведено по примеру для каждой из операционных систем (Windows и Linux).

- Если в ОС Windows в качестве `<SharedFolder>` используется папка `D:\shared`, то правильный синтаксис для команд Docker — `d:/shared`.

- Если в ОС Linux в качестве `<SharedFolder>` используется папка `/shared`, то правильный синтаксис для команд Docker — `/shared`.

Дополнительные сведения об [использовании томов](https://docs.docker.com/engine/admin/volumes/volumes/) см. в справочных материалах по подсистеме Docker.

## <a name="configure-the-opc-components"></a>Настройка компонентов OPC

Прежде чем устанавливать компоненты OPC, выполните следующие действия для подготовки среды:

1. Для завершения развертывания шлюза необходима строка подключения Центра Интернета вещей **iothubowner** в развертывании подключенной фабрики. На [портале Azure](http://portal.azure.com/) перейдите в Центр Интернета вещей в группе ресурсов, созданной при развертывании решения подключенной фабрики. Щелкните **Политики общего доступа** для доступа к строке подключения **iothubowner**:

    ![Поиск строки подключения Центра Интернета вещей](./media/iot-suite-connected-factory-gateway-deployment/image2.png)

    Скопируйте значение поля **Строка подключения — первичный ключ**.

1. Чтобы обеспечить взаимодействие между контейнерами Docker, необходима пользовательская мостовая сеть. Чтобы создать мостовую сеть для контейнеров, выполните в командной строке следующую команду:

    ```cmd/sh
    docker network create -d bridge iot_edge
    ```

    Чтобы проверить, что мостовая сеть **iot_edge** создана, выполните следующую команду:

    ```cmd/sh
    docker network ls
    ```

    Мостовая сеть **iot_edge** будет добавлена в список сетей.

Чтобы запустить модуль "Издатель OPC", выполните в командной строке следующую команду:

```cmd/sh
docker run --rm -it -v <SharedFolder>:/docker -v x509certstores:/root/.dotnet/corefx/cryptography/x509stores --network iot_edge --name publisher -h publisher -p 62222:62222 --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-publisher:2.1.3 publisher "<IoTHubOwnerConnectionString>" --lf /docker/publisher.log.txt --as true --si 1 --ms 0 --tm true --vc true --di 30
```

- На странице [об издателе OPC на GitHub](https://github.com/Azure/iot-edge-opc-publisher) и в [справочнике по выполнению Docker](https://docs.docker.com/engine/reference/run/) содержится дополнительная информация о:

  - параметрах командной строки Docker, указываемых перед именем контейнера (`microsoft/iot-edge-opc-publisher:2.1.3`);
  - значении параметров командной строки "Издатель OPC", указываемых после имени контейнера (`microsoft/iot-edge-opc-publisher:2.1.3`).

- `<IoTHubOwnerConnectionString>` является строкой подключения политики общего доступа **iothubowner** на портале Azure. Эта строка подключения была скопирована на предыдущем шаге. Строка подключения нужна только для первого запуска издателя OPC. При последующих запусках желательно обходиться без нее, поскольку может возникнуть угроза безопасности.

- Используемая `<SharedFolder>` и ее синтаксис описаны в разделе [Установка и настройка Docker](#install-and-configure-docker). Издателю OPC `<SharedFolder>` нужна для чтения и записи собственного файла конфигурации, записи в файл журнала, а также обеспечения доступности этих файлов вне контейнера.

- Издатель OPC считывает свою конфигурацию из файла **publishednodes.json**, который необходимо поместить в папку `<SharedFolder>/docker` для чтения и записи. В этом файле конфигурации определено, на какие данные узла OPC UA на данном сервере OPC UA издатель OPC должен подписаться. Полный синтаксис файла **publishednodes.json** описан на странице [Издатель OPC](https://github.com/Azure/iot-edge-opc-publisher) в GitHub. При добавлении шлюза поместите пустой файл **publishednodes.json** в папку:

    ```json
    [
    ]
    ```

- Всякий раз, когда сервер OPC UA оповещает издателя OPC об изменении данных, в Центр Интернета вещей отправляется новое значение. В зависимости от параметров пакетной обработки издатель OPC может собирать данные в пакет перед их отправкой в Центр Интернета вещей.

- Docker не поддерживает разрешение имен NetBIOS, а только DNS. Если в сети отсутствует DNS-сервер, можно использовать обходной путь, показанный в предыдущем примере командной строки. Чтобы добавить запись в файл узлов контейнеров, в предыдущем примере командной строки использовался параметр `--add-host`. Эта запись позволяет искать имя узла для данного `<OpcServerHostname>`, разрешая текущий IP-адрес `<IpAddressOfOpcServerHostname>`.

- Для проверки подлинности и шифрования OPC UA использует сертификаты X.509. Чтобы сервер OPC UA, к которому вы подключаетесь, доверял издателю OPC, необходимо разместить на нем сертификат издателя OPC. Хранилище сертификатов издателя OPC находится в папке `<SharedFolder>/CertificateStores`. Сертификат издателя OPC размещен в подпапке `trusted/certs` папки `CertificateStores`.

  Шаги по настройке сервера OPC UA отличаются в зависимости от используемого устройства. Обычно эти шаги описаны в руководстве пользователя по серверу OPC UA.

Чтобы установить прокси-сервер OPC, выполните в командной строке следующую команду:

```cmd/sh
docker run -it --rm -v <SharedFolder>:/mapped --network iot_edge --name proxy --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-proxy:1.0.2 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db
```

Установку в системе необходимо выполнить только один раз.

Выполните следующую команду для запуска прокси-сервера OPC:

```cmd/sh
docker run -it --rm -v <SharedFolder>:/mapped --network iot_edge --name proxy --add-host <OpcServerHostname>:<IpAddressOfOpcServerHostname> microsoft/iot-edge-opc-proxy:1.0.2 -D /mapped/cs.db
```

Прокси-сервер OPC сохраняет строку соединения во время установки. При последующих запусках желательно обходиться без строки подключения, так как это создает угрозу безопасности.

## <a name="enable-your-gateway"></a>Включение шлюза

Чтобы включить шлюз в предварительно настроенном решении подключенной фабрики, выполните следующие шаги:

1. Когда оба компонента запущены, перейдите страницу **Connect your own OPC UA Server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики. Данная страница доступна только пользователям с правами администратора в решении. Введите URL-адрес конечной точки издателя (opc.tcp://publisher:62222) и нажмите кнопку **Подключение**.

1. Установите отношения доверия между порталом подключенной фабрики и издателем OPC. Когда появится предупреждение о сертификате, нажмите кнопку **Продолжить**. Затем отобразится сообщение об ошибке, информирующее о том, что издатель OPC не воспринимает веб-клиент UA как доверенный. Для решения этой проблемы скопируйте сертификат **веб-клиента UA** из папки `<SharedFolder>/CertificateStores/rejected/certs` в папку шлюза `<SharedFolder>/CertificateStores/trusted/certs`. Перезапускать шлюз не требуется.

Теперь вы можете подключиться к шлюзу из облака, а также вы готовы добавить серверы OPC UA в решение.

## <a name="add-your-own-opc-ua-servers"></a>Добавление собственных серверов OPC UA

Чтобы добавить собственные серверы OPC UA в предварительно настроенное решение подключенной фабрики, сделайте следующее:

1. Перейдите на страницу **Connect your own OPC UA server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики.

    1. Запустите сервер OPC UA, к которому нужно подключиться. Сервер OPC UA должен быть доступен из издателя и прокси-сервера OPC, запущенных в контейнере (просмотрите комментарии выше о разрешении имен).
    1. Введите URL-адрес конечной точки сервера OPC UA (`opc.tcp://<host>:<port>`) и щелкните **Подключиться**.
    1. При настройке подключения устанавливается отношение доверия между порталом подключенной фабрики (клиент OPC UA) и сервером OPC UA, который вы пытаетесь подключить. На панели мониторинга подключенной фабрики вы получите предупреждение об **отсутствии возможности проверить сертификат сервера для подключения**. Когда появится предупреждение о сертификате, нажмите кнопку **Продолжить**.
    1. Сложнее настроить конфигурацию сертификата сервера OPC UA, к которому вы пытаетесь подключиться. Для компьютерных серверов OPC UA на панели мониторинга может просто появиться диалоговое окно с предупреждением, которое можно принять. Для встраиваемых серверных систем OPC UA используйте документацию этого сервера, чтобы узнать о решении этого вопроса. Чтобы завершить настройку, может понадобиться сертификат клиента OPC UA портала подключенной фабрики. Администратор может загрузить этот сертификат на странице **подключения сервера OPC UA**.

        ![Портал решения](./media/iot-suite-connected-factory-gateway-deployment/image4.png)

1. Просмотрите дерево узлов OPC UA сервера OPC UA, щелкните правой кнопкой мыши узлы OPC UA, значения которых нужно передать подключенной фабрике, и выберите **Опубликовать**.

1. Телеметрия теперь поступает с устройства шлюза. Данные телеметрии можно просмотреть в представлении **Расположения фабрик** портала подключенной фабрики в разделе **Новая фабрика**.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об архитектуре предварительно настроенного решения подключенной фабрики см. в статье [Пошаговое руководство по работе с предварительно настроенным решением подключенной фабрики](https://docs.microsoft.com/azure/iot-suite/iot-suite-connected-factory-sample-walkthrough).

Прочитайте о [справочной реализации модуля издателя OPC](https://docs.microsoft.com/azure/iot-suite/iot-suite-connected-factory-publisher).