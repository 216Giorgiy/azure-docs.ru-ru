<properties
 pageTitle="Пошаговое руководство по предварительно настроенному решению удаленного мониторинга | Microsoft Azure"
 description="Описание предварительно настроенного решения удаленного мониторинга Azure IoT и его архитектура."
 services=""
 suite="iot-suite"
 documentationCenter=""
 authors="stevehob"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-suite"
 ms.devlang="na"
 ms.topic="get-started-article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="03/02/2016"
 ms.author="stevehob"/>

# Пошаговое руководство по работе с настроенным решением для удаленного мониторинга

## Введение

Предварительно настроенное решение удаленного мониторинга набора IoT Suite — это базовое решение для комплексного мониторинга бизнес-сценария, использующего несколько компьютеров в удаленных расположениях. Решение объединяет основные службы набора Azure IoT Suite для универсальной реализации бизнес-сценария. Оно является отправной точкой для клиентов, которые планируют реализовать этот тип решения IoT для удовлетворения конкретных бизнес-требований.

## Логическая архитектура

На следующей диаграмме показаны логические компоненты предварительно настроенного решения.

![](media/iot-suite-remote-monitoring-sample-walkthrough/remote-monitoring-architecture.png)


### Виртуальные устройства

В настроенном решении виртуальное устройство представляет собой устройство охлаждения (например, кондиционер воздуха в помещении или установку кондиционирования воздуха объекта). Каждое виртуальное устройство отправляет в центр IoT следующие сообщения телеметрии.


| Сообщение | Описание |
|----------|-------------|
| Запуск | При запуске устройство отправляет сообщение со **сведениями об устройстве**, например идентификатор устройства, метаданные устройства, список поддерживаемых команд и текущую конфигурацию. |


Виртуальные устройства отправляют в качестве метаданных следующие свойства.

| Свойство | Назначение |
|------------------------|--------- |
| Идентификатор устройства. | Идентификатор, предоставленный или назначенный при создании устройства в решении. |
| Производитель | Производитель устройства |
| Номер модели | Номер модели устройства |
| Серийный номер | Серийный номер устройства |
| Встроенное ПО | Текущая версия встроенного ПО на устройстве |
| Платформа | Архитектура платформы устройства |
| Процессор | Процессор, управляющий устройством |
| Установленное ОЗУ | Объем ОЗУ, установленного на устройстве |
| Состояние включенного центра | Свойство состояния центра IoT устройства |
| Время создания | Время создания устройства в решении |
| Время обновления | Время последнего обновления свойств устройства |
| Широта | Широта расположения устройства |
| Долгота | Долгота расположения устройства |

Симулятор заполняет эти свойства в виртуальных устройствах образцами данных. Каждый раз, когда симулятор инициализирует виртуальное устройство, оно отправляет предварительно определенные метаданные в центр IoT. Обратите внимание, что это приводит к перезаписи обновлений всех метаданных, выполненных на портале устройства.


Виртуальные устройства могут обрабатывать следующие команды, отправляемые из центра IoT.

| Команда | Описание |
|------------------------|-----------------------------------------------------|
| PingDevice | Отправляет на устройство _ping-запрос_ для проверки его активности |
| StartTelemetry | Запускает отправку данных телеметрии устройством |
| StopTelemetry | Останавливает отправку данных телеметрии устройством |
| ChangeSetPointTemp | Изменяет значение заданной точки, вокруг которой формируются случайные данные |
| DiagnosticTelemetry | Вызывает отправку симулятором устройства дополнительного значения телеметрии (externalTemp) |
| ChangeDeviceState | Изменяет свойство расширенного состояния устройства и отправляет с устройства сообщение со сведениями об устройстве |


Подтверждение команды устройством осуществляется через центр IoT.


### Задания в службе Azure Stream Analytics


**Задание 1. Сведения об устройстве**. Фильтрует сообщения с информацией об устройстве из входящего потока сообщений и отправляет их в конечную точку концентратора событий. Устройство отправляет сообщения с информацией об устройстве при запуске и в ответ на команду **SendDeviceInfo**. Это задание использует следующее определение запроса:

```
SELECT * FROM DeviceDataStream Partition By PartitionId WHERE  ObjectType = 'DeviceInfo'
```

**Задание 2. Правила**. Оценивает входящие телеметрические значения температуры и влажности и сравнивает с пороговым значением для устройства. Пороговые значения задаются в редакторе правил, который входит в решение. Каждая пара устройство/значение хранится с отметкой времени в большом двоичном объекте, который считывается обработчиком Stream Analytics как **Ссылочные данные**. Задание сравнивает все непустые значения с заданным пороговым значением для устройства. Если значение превышает условие «>», задание выводит событие **сигнал**, которое указывает, что пороговое значение превышено, и указывает устройство, значение и значения отметки времени. Это задание использует следующее определение запроса:

```
WITH AlarmsData AS 
(
SELECT
     Stream.DeviceID,
     'Temperature' as ReadingType,
     Stream.Temperature as Reading,
     Ref.Temperature as Threshold,
     Ref.TemperatureRuleOutput as RuleOutput,
     Stream.EventEnqueuedUtcTime AS [Time]
FROM IoTTelemetryStream Stream
JOIN DeviceRulesBlob Ref ON Stream.DeviceID = Ref.DeviceID
WHERE
     Ref.Temperature IS NOT null AND Stream.Temperature > Ref.Temperature

UNION ALL

SELECT
     Stream.DeviceID,
     'Humidity' as ReadingType,
     Stream.Humidity as Reading,
     Ref.Humidity as Threshold,
     Ref.HumidityRuleOutput as RuleOutput,
     Stream.EventEnqueuedUtcTime AS [Time]
FROM IoTTelemetryStream Stream
JOIN DeviceRulesBlob Ref ON Stream.DeviceID = Ref.DeviceID
WHERE
     Ref.Humidity IS NOT null AND Stream.Humidity > Ref.Humidity
)

SELECT *
INTO DeviceRulesMonitoring
FROM AlarmsData

SELECT *
INTO DeviceRulesHub
FROM AlarmsData
```

**Задание 3. Телеметрия**. Работает на входящем потоке телеметрии устройства в двух направлениях. Первый отправляет все сообщения телеметрии с устройств в постоянное хранилище BLOB-объектов. Второй вычисляет среднее, минимальное и максимальное значения влажности в течение пятиминутного скользящего окна. Эти данные также отправляются в хранилище больших двоичных объектов. Это задание использует следующее определение запроса:

```
WITH 
    [StreamData]
AS (
    SELECT
        *
    FROM 
      [IoTHubStream] 
    WHERE
        [ObjectType] IS NULL -- Filter out device info and command responses
) 

SELECT
    *
INTO
    [Telemetry]
FROM
    [StreamData]

SELECT
    DeviceId,
    AVG (Humidity) AS [AverageHumidity], 
    MIN(Humidity) AS [MinimumHumidity], 
    MAX(Humidity) AS [MaxHumidity], 
    5.0 AS TimeframeMinutes 
INTO
    [TelemetrySummary]
FROM
    [StreamData]
WHERE
    [Humidity] IS NOT NULL
GROUP BY
    DeviceId, 
    SlidingWindow (mi, 5)
```

### Обработчик событий

**Обработчик событий** обрабатывает информационные сообщения устройства и ответы на команды. Он использует следующую информацию:

- информационные сообщения устройства для обновления реестра устройства (хранится в базе данных DocumentDB) с текущей информацией об устройстве;
- сообщения об ответе на команды для обновления журнала команд устройства (хранится в базе данных DocumentDB).

## Пошаговое руководство

В этом разделе описываются компоненты решения, целевые варианты использования и приводятся примеры.

### Панель удаленного мониторинга
Эта страница в веб-приложении использует элементы управления javascript PowerBI (см. [Репозиторий визуальных элементов PowerBI](https://www.github.com/Microsoft/PowerBI-visuals)) для визуализации выходных данных из заданий Stream Analytics в хранилище больших двоичных объектов.


### Портал администрирования устройства

Это веб-приложение позволяет выполнять следующие действия.

- Подготовка нового устройства, которая задает уникальный идентификатор устройства и создает ключ проверки подлинности.
- Управление свойствами устройства, в том числе просмотр существующих свойств и их обновление.
- Отправка команд на устройство.
- Просмотр журнала команд для устройства.

### Наблюдение за поведением облачного решения
Чтобы просмотреть подготовленные ресурсы, перейдите на [портал Azure](https://portal.azure.com), а затем к группе ресурсов с указанным именем решения.

![](media/iot-suite-remote-monitoring-sample-walkthrough/azureportal_01.png)

При первом запуске образца отобразятся четыре предварительно настроенных виртуальных устройства:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_01.png)

Портал администрирования устройств можно использовать для добавления нового виртуального устройства:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_02.png)

Изначально состояние нового устройства на портале администрирования устройств имеет значение **Ожидание**:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_03.png)

Когда приложение завершит развертывание виртуального устройства, на портале администрирования устройств состояние устройства примет значение **Работает**, как показано на следующем снимке экрана. Задание **DeviceInfo** обработчика Stream Analytics отправляет сведения о состоянии устройства с устройства на портал администрирования устройства.

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_04.png)

С помощью портала решений можно отправлять команды на устройство, например команду **ChangeSetPointTemp**:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_05.png)

Когда устройство сообщает об успешном выполнении команды, значение состояния изменяется на **Успешно**:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_06.png)

На портале решения можно искать устройства с определенными характеристиками, например номер модели:

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_07.png)

Можно отключить устройство, а после отключения его можно удалить.

![](media/iot-suite-remote-monitoring-sample-walkthrough/solutionportal_08.png)

<!---HONumber=AcomDC_0309_2016-->