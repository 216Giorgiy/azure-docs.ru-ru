<properties
 pageTitle="Пошаговое руководство по предварительно настроенному решению удаленного мониторинга | Microsoft Azure"
 description="Описание предварительно настроенного решения удаленного мониторинга Azure IoT и его архитектура."
 services=""
 suite="iot-suite"
 documentationCenter=""
 authors="dominicbetts"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-suite"
 ms.devlang="na"
 ms.topic="get-started-article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="07/18/2016"
 ms.author="dobett"/>

# Пошаговое руководство по работе с настроенным решением для удаленного мониторинга

## Введение

[Предварительно настроенное решение][lnk-preconfigured-solutions] удаленного мониторинга набора IoT Suite — это реализация решения комплексного мониторинга для сценария с использованием нескольких компьютеров в удаленных расположениях. Это решение объединяет основные службы Azure, чтобы обеспечить универсальную реализацию бизнес-сценария. Вы можете использовать его в качестве отправной точки для своей собственной реализации. Решение можно [настроить][lnk-customize] в соответствии с потребностями конкретной организации.

В этой статье рассматриваются некоторые основные компоненты решения для удаленного мониторинга, чтобы вы смогли представить, как оно работает. Эти знания помогут вам устранить проблемы, возникшие с решением, спланировать настройку решения в соответствии с определенными требованиями, а также спланировать собственное решение IoT, использующее службы Azure.

## Логическая архитектура

На следующей диаграмме показаны логические компоненты предварительно настроенного решения.

![Логическая архитектура](media/iot-suite-remote-monitoring-sample-walkthrough/remote-monitoring-architecture.png)


## Виртуальные устройства

В настроенном решении виртуальное устройство представляет собой устройство охлаждения (например, кондиционер воздуха в помещении или установку кондиционирования воздуха объекта). При развертывании предварительно настроенного решения вы также автоматически подготавливаете четыре виртуальных устройства, которые выполняются в [веб-задании Azure][lnk-webjobs]. Эти устройства упрощают изучение поведения решения, не требуя развертывания физических устройств. Сведения о развертывании физического устройства см. в руководстве [Подключение устройства к предварительно настроенному решению для удаленного мониторинга][lnk-connect-rm].

Каждое виртуальное устройство может отправлять следующие типы сообщений в центр IoT.

| Сообщение | Описание |
|----------|-------------|
| Запуск | При запуске устройство отправляет сообщение со **сведениями об устройстве**, например идентификатор устройства, метаданные устройства, список поддерживаемых команд и текущую конфигурацию. |
| Присутствие | Устройство периодически отправляет сообщение о **присутствии**, чтобы сообщить, может ли оно определить присутствие датчика |
| Телеметрия | Устройство периодически отправляет сообщение **телеметрии** со значениями температуры и влажности, полученными от виртуальных датчиков, подключенных к виртуальному устройству |


Виртуальные устройства отправляют следующие свойства в сообщении со **сведениями об устройстве**.

| Свойство | Назначение |
|------------------------|--------- |
| Идентификатор устройства. | Идентификатор, предоставленный или назначенный при создании устройства в решении. |
| Производитель | Производитель устройства |
| Номер модели | Номер модели устройства |
| Серийный номер | Серийный номер устройства |
| Встроенное ПО | Текущая версия встроенного ПО на устройстве |
| Платформа | Архитектура платформы устройства |
| Процессор | Процессор, управляющий устройством |
| Установленное ОЗУ | Объем ОЗУ, установленного на устройстве |
| Состояние включенного центра | Свойство состояния центра IoT устройства |
| Время создания | Время создания устройства в решении |
| Время обновления | Время последнего обновления свойств устройства |
| Широта | Широта расположения устройства |
| Долгота | Долгота расположения устройства |

Симулятор заполняет эти свойства в виртуальных устройствах образцами данных. Каждый раз, когда симулятор инициализирует виртуальное устройство, оно отправляет предварительно определенные метаданные в центр IoT. Обратите внимание, что это приводит к перезаписи обновлений всех метаданных, выполненных на портале устройства.


Виртуальные устройства могут обрабатывать следующие команды, отправляемые с панели мониторинга решения через центр IoT.

| Команда | Описание |
|------------------------|-----------------------------------------------------|
| PingDevice | Отправляет на устройство _ping-запрос_ для проверки его активности |
| StartTelemetry | Запускает отправку данных телеметрии устройством |
| StopTelemetry | Останавливает отправку данных телеметрии устройством |
| ChangeSetPointTemp | Изменяет значение заданной точки, вокруг которой формируются случайные данные |
| DiagnosticTelemetry | Вызывает отправку симулятором устройства дополнительного значения телеметрии (externalTemp) |
| ChangeDeviceState | Изменяет свойство расширенного состояния устройства и отправляет с устройства сообщение со сведениями об устройстве |

Подтверждение команды устройством в серверной части решения осуществляется через центр IoT.

## Центр IoT

[Центр IoT][lnk-iothub] принимает данные, отправленные с устройств в облако, и предоставляет к ним доступ заданиям Azure Stream Analytics (ASA). Кроме того, центр IoT отправляет на устройства команды от имени портала устройства. Каждый поток заданий ASA использует отдельную группу потребителей центра IoT для считывания потока сообщений с устройств.

## Azure Stream Analytics

В решении удаленного мониторинга [Azure Stream Analytics][lnk-asa] отправляет сообщения, полученные с устройств в центре IoT, другим компонентам серверной части для обработки или хранения. Каждое задание ASA выполняет определенные функции в зависимости от содержимого сообщений.

**Задание 1. Сведения об устройстве**. Фильтрует сообщения со сведениями об устройстве из входящего потока сообщений и отправляет их в конечную точку концентратора событий. Устройство отправляет сообщения с информацией об устройстве при запуске и в ответ на команду **SendDeviceInfo**. Чтобы определить сообщения со **сведениями об устройстве**, задание использует следующее определение запроса:

```
SELECT * FROM DeviceDataStream Partition By PartitionId WHERE  ObjectType = 'DeviceInfo'
```

Это задание отправляет выходные данные в концентратор событий для дальнейшей обработки.

**Задание 2. Правила**. Оценивает входящие телеметрические значения температуры и влажности в сравнении с пороговыми значениями для устройства. Пороговые значения задаются в редакторе правил, доступном на панели мониторинга решения. Каждая пара "устройство/значение" хранится меткой времени в большом двоичном объекте, который считывается обработчиком Stream Analytics как **ссылочные данные**. Задание сравнивает все непустые значения с заданным пороговым значением для устройства. Если значение превышает условие ">", задание выводит событие **оповещения**, которое сигнализирует, что пороговое значение превышено, и указывает устройство, значение и метку времени. Чтобы определить сообщения телеметрии, которые должны активировать оповещение, задание использует следующее определение запроса:

```
WITH AlarmsData AS 
(
SELECT
     Stream.DeviceID,
     'Temperature' as ReadingType,
     Stream.Temperature as Reading,
     Ref.Temperature as Threshold,
     Ref.TemperatureRuleOutput as RuleOutput,
     Stream.EventEnqueuedUtcTime AS [Time]
FROM IoTTelemetryStream Stream
JOIN DeviceRulesBlob Ref ON Stream.DeviceID = Ref.DeviceID
WHERE
     Ref.Temperature IS NOT null AND Stream.Temperature > Ref.Temperature

UNION ALL

SELECT
     Stream.DeviceID,
     'Humidity' as ReadingType,
     Stream.Humidity as Reading,
     Ref.Humidity as Threshold,
     Ref.HumidityRuleOutput as RuleOutput,
     Stream.EventEnqueuedUtcTime AS [Time]
FROM IoTTelemetryStream Stream
JOIN DeviceRulesBlob Ref ON Stream.DeviceID = Ref.DeviceID
WHERE
     Ref.Humidity IS NOT null AND Stream.Humidity > Ref.Humidity
)

SELECT *
INTO DeviceRulesMonitoring
FROM AlarmsData

SELECT *
INTO DeviceRulesHub
FROM AlarmsData
```

Задание отправляет выходные данные в концентратор событий для дальнейшей обработки и сохраняет сведения о каждом оповещении в хранилище BLOB-объектов, откуда их может считывать панель мониторинга решения.

**Задание 3. Телеметрия**. Работает на входящем потоке телеметрии устройства, используя два метода. Первый отправляет все сообщения телеметрии с устройств в постоянное хранилище BLOB-объектов для долгосрочного хранения. Второй вычисляет среднее, минимальное и максимальное значения влажности в течение пятиминутного скользящего окна, а потом отправляет эти данные в хранилище BLOB-объектов. Панель мониторинга решения считывает данные телеметрии из хранилища BLOB-объектов, чтобы заполнить диаграммы. Это задание использует следующее определение запроса:

```
WITH 
    [StreamData]
AS (
    SELECT
        *
    FROM 
      [IoTHubStream] 
    WHERE
        [ObjectType] IS NULL -- Filter out device info and command responses
) 

SELECT
    *
INTO
    [Telemetry]
FROM
    [StreamData]

SELECT
    DeviceId,
    AVG (Humidity) AS [AverageHumidity], 
    MIN(Humidity) AS [MinimumHumidity], 
    MAX(Humidity) AS [MaxHumidity], 
    5.0 AS TimeframeMinutes 
INTO
    [TelemetrySummary]
FROM
    [StreamData]
WHERE
    [Humidity] IS NOT NULL
GROUP BY
    DeviceId, 
    SlidingWindow (mi, 5)
```

## Концентраторы событий

Задания ASA **Сведения об устройстве** и **Правила** выводят данные в концентраторы событий, чтобы надежно перенаправить их в **обработчик событий**, запущенный в веб-задании.

## Хранилище Azure

Решение использует хранилище BLOB-объектов Azure, чтобы сохранять все необработанные и сводные данные телеметрии с устройств в решении. Панель мониторинга считывает данные телеметрии из хранилища BLOB-объектов, чтобы заполнить диаграммы. Чтобы отобразить оповещения, панель мониторинга считывает данные из хранилища BLOB-объектов, регистрирующего события превышения настроенных пороговых значений телеметрии. Решение также использует хранилище BLOB-объектов для записи пороговых значений, которые пользователь задал на панели мониторинга.

## Веб-задания

В дополнение к размещению симуляторов устройств в веб-заданиях решения также размещается **обработчик событий**, работающий в веб-задании Azure, который обрабатывает сообщения с информацией об устройствах и ответы команд. Он использует следующую информацию:

- информационные сообщения устройства для обновления реестра устройства (хранится в базе данных DocumentDB) с текущей информацией об устройстве;
- сообщения об ответе на команды для обновления журнала команд устройства (хранится в базе данных DocumentDB).

## DocumentDB

Решение использует базу данных DocumentDB для хранения сведений о подключенных к нему устройствах, например метаданных устройства и журнала команд, отправленных на устройства с панели мониторинга.

## веб-приложений:

### Панель удаленного мониторинга
Эта страница в веб-приложении использует элементы управления JavaScript PowerBI (см. в [репозитории визуальных элементов PowerBI](https://www.github.com/Microsoft/PowerBI-visuals)) для визуализации данных телеметрии с устройств. Решение использует задание телеметрии ASA для записи данных телеметрии в хранилище BLOB-объектов.


### Портал администрирования устройства

Это веб-приложение позволяет выполнять следующие действия.

- Подготовка нового устройства. При этом задается уникальный идентификатор устройства и создается ключ проверки подлинности. Сведения об устройстве записываются в реестр удостоверений центра IoT и базу данных DocumentDB определенного решения.
- Управление свойствами устройства. При этом выполняется просмотр имеющихся свойств и их обновление.
- Отправка команд на устройство.
- Просмотр журнала команд для устройства.
- Включение и отключение устройств.

## Дальнейшие действия

В записях блога на сайте TechNet приведены дополнительные сведения о предварительно настроенном решении удаленного мониторинга:

- [IoT Suite - Under The Hood - Remote Monitoring (IoT Suite. Как работает удаленный мониторинг).](http://social.technet.microsoft.com/wiki/contents/articles/32941.iot-suite-under-the-hood-remote-monitoring.aspx)
- [IoT Suite - Remote Monitoring - Adding Live and Simulated Devices (IoT Suite. Удаленный мониторинг: добавление реальных и виртуальных устройств).](http://social.technet.microsoft.com/wiki/contents/articles/32975.iot-suite-remote-monitoring-adding-live-and-simulated-devices.aspx)

Дополнительные сведения об IoT Suite см. в следующих статьях.

- [Подключение устройства к предварительно настроенному решению для удаленного мониторинга][lnk-connect-rm]
- [Разрешения на сайте azureiotsuite.com][lnk-permissions]

[lnk-preconfigured-solutions]: iot-suite-what-are-preconfigured-solutions.md
[lnk-customize]: iot-suite-guidance-on-customizing-preconfigured-solutions.md
[lnk-iothub]: https://azure.microsoft.com/documentation/services/iot-hub/
[lnk-asa]: https://azure.microsoft.com/documentation/services/stream-analytics/
[lnk-webjobs]: https://azure.microsoft.com/documentation/articles/websites-webjobs-resources/
[lnk-connect-rm]: iot-suite-connecting-devices.md
[lnk-permissions]: iot-suite-permissions.md

<!---HONumber=AcomDC_0727_2016-->