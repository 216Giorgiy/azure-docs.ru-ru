<properties
   pageTitle="Интеграция Cloud Cruiser и API выставления счетов Microsoft Azure | Microsoft Azure"
   description="В нем описан уникальный опыт Cloud Cruiser — партнера по выставлению счетов Microsoft Azure — по интеграции API выставления счетов Azure в свои продукты. Эти сведения особенно полезны для клиентов Azure и Cloud Cruiser, которые хотели бы использовать Cloud Cruiser для Microsoft Azure Pack или уже рассматривают такой вариант."
   services=""
   documentationCenter=""
   authors="BryanLa"
   manager="mbaldwin"
   editor=""
   tags="billing"
   />

<tags
   ms.service="billing"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="billing"
   ms.date="08/16/2016"
   ms.author="mobandyo;sirishap;bryanla"/>

# Интеграция Cloud Cruiser и API выставления счетов Microsoft Azure

В этой статье описаны способы использования сведений, собранных из новых API выставления счетов Microsoft Azure , в Cloud Cruiser для моделирования и анализа стоимости рабочих процессов.

## API RateCard Azure
API RateCard предоставляет информацию о тарифах в Azure. После прохождения проверки подлинности с помощью подходящих учетных данных вы можете направить в API запрос для сбора метаданных по доступным в Azure службам, а также сведений о тарифах, связанных с вашим идентификатором запроса.

Ниже приведен образец ответа из API, отображающий цены на экземпляр A0 (Windows):

    {
		"MeterId": "0e59ad56-03e5-4c3d-90d4-6670874d7e29",
		"MeterName": "Compute Hours",
		"MeterCategory": "Virtual Machines",
		"MeterSubCategory": "A0 VM (Windows)",
		"Unit": "Hours",
		"MeterRates":
		{
			"0": 0.029
		},
		"EffectiveDate": "2014-08-01T00:00:00Z",
		"IncludedQuantity": 0.0
	},

### Интерфейс Cloud Cruiser для API RateCard Azure
Cloud Cruiser может по-разному использовать сведения, полученные API RateCard. В этой статье будет показано, как их использовать для моделирования и анализа стоимости рабочих процессов IaaS.

Для демонстрации данного варианта использования представьте себе рабочую нагрузку нескольких экземпляров, работающих в Microsoft Azure Pack (WAP). Целью является моделирование той же самой рабочей нагрузки в Azure и оценка затрат на осуществление такой миграции. Чтобы обеспечить такое моделирование, необходимо выполнить две основные задачи:

1. **Импорт и обработка информации о службе, собираемой посредством API RateCard** — эта задача также выполняется с книгами, где извлеченные из API RateCard сведения преобразуются и публикуются в новом тарифном плане. Этот новый тарифный план будет использоваться при моделировании для оценки цен Azure.

2. **Нормализация служб WAP и служб Azure для IaaS** — по умолчанию службы WAP основаны на отдельных ресурсах (ЦП, объем памяти, место на диске и т. д.), а службы Azure основаны на размере экземпляра (A0, A1, A2 и т. д.). Первую задачу может выполнить ядро извлечения, преобразования и загрузки Cloud Cruiser, которое называется книгами, где эти ресурсы могут объединяться по размерам экземпляров, аналогично службам экземпляров Azure.

### Импорт данных из API RateCard

Книги Cloud Cruiser предоставляют автоматический метод сбора и обработки информации из API RateCard. Книги извлечения, преобразования и загрузки позволяют настраивать сбор, преобразование и публикацию данных в базе данных Cloud Cruiser.

Каждая книга может иметь одну или несколько коллекций. Это позволяет сопоставлять данные из разных источников для дополнения или расширения данных об использовании. На двух снимках экрана ниже показано создание новой *коллекции* в существующей книге и импорт данных из API RateCard в эту *коллекцию*.

![Рис. 1. Создание новой коллекции][1]

![Рис. 2. Импорт данных из новой коллекции][2]

После импорта данных в книгу можно создать несколько действий и процессов преобразования для изменения и моделирования данных. В этом примере, поскольку нас интересует только инфраструктура как служба (IaaS), можно использовать действия преобразования для удаления ненужных строк или записей, относящихся к службам, отличным от IaaS.

На следующем снимке экрана показаны действия преобразования, используемые для обработки собранных из API RateCard данных:

![Рис. 3. Действия преобразования для обработки данных, собранных из API RateCard][3]

### Определение новых служб и тарифных планов

В Cloud Cruiser доступны различные способы определения служб. Один из вариантов заключается в импорте служб из данных об использовании. Этот метод широко распространен при работе с общедоступными облаками, где службы уже определены поставщиком.

Тарифный план — это набор тарифов или цен, которые, среди прочего, могут применяться к различным службам в определенные периоды действия или группам клиентов. Тарифные планы в Cloud Cruiser также можно использовать для создания моделей или сценариев "что если", чтобы понять, как изменения в службах могут повлиять на общую стоимость рабочей нагрузки.

В этом примере сведения о службе из API RateCard используются для определения новых служб в Cloud Cruiser. Аналогичным образом можно использовать связанные со службами тарифы для создания нового тарифного плана в Cloud Cruiser.

В конце процесса преобразования можно создать новое действие и публиковать данные из API RateCard в качестве новых служб и тарифов.

![Рис. 4. Публикация данных из API RateCard в качестве новых служб и тарифов][4]

### Проверка служб Azure и тарифов

После публикации служб и тарифов можно проверить список импортированных служб на вкладке *Службы* Cloud Cruiser:

![Рис. 5. Проверка новых служб][5]

На вкладке *Тарифные планы* можно ознакомиться с новым тарифным планом, который называется AzureSimulation и содержит тарифы, импортированные из API RateCard.

![Рис. 6. Проверка нового тарифного плана и связанных с ним тарифов][6]

### Нормализация WAP и служб Azure

По умолчанию WAP предоставляет сведения об использовании на основе уровня использования вычислительных ресурсов, ресурсов памяти и сетевых ресурсов. В Cloud Cruiser можно определить службы непосредственно на основе выделения или измеренного уровня использования этих ресурсов. Например, можно задать базовый тариф за каждый час использования ЦП или ставку за гигабайт памяти, выделенной для экземпляра.

В этом примере для сравнения затрат между WAP и Azure необходимо агрегировать использование ресурсов WAP в пакеты, которые затем можно будет сопоставить со службами Azure. Это преобразование можно легко реализовать в книгах:

![Рис. 7. Преобразование данных WAP для нормализации служб][7]

Последним действием в книге является публикация данных в базе данных Cloud Cruiser. На этом этапе данные об использовании собраны в пакеты (которые сопоставляются со службами Azure) и привязаны к тарифам по умолчанию для формирования расходов.

После завершения книги вы можете автоматизировать обработку данных, добавив новую задачу в планировщик и указав частоту и время выполнения книги.

![Рис. 8. Планирование книги][8]

### Создание отчетов для анализа моделирования стоимости рабочей нагрузки

По мере сбора данных об использовании и загрузке расходов в базу данных Cloud Cruiser можно использовать модуль Cloud Cruiser Insights — средство создания расширенных аналитических отчетов — для обеспечения нужного моделирования стоимости рабочей нагрузки.

Чтобы продемонстрировать этот сценарий, был создан следующий отчет:

![Сравнение стоимости][9]

На верхней диаграмме показано сравнение затрат с разбивкой по отдельным службам, а также сравнивается стоимость выполнения рабочей нагрузки для каждой конкретной между WAP (темно-синий цвет) и Azure (голубой цвет).

На нижней диаграмме показаны те же самые данные, но с разбивкой по отделам. Здесь указаны затраты каждого отдела на выполнение своей рабочей нагрузки в WAP и Azure, а также разница между этими двумя значениями — то есть экономия (зеленый цвет).

## API Usage Azure


### Введение

Недавно корпорация Майкрософт представила API Usage Azure. Теперь подписчики могут программным путем получать данные об использовании, чтобы иметь больше информации о потреблении ресурсов. Это хорошие новости для пользователей Cloud Cruiser, которые могут получить более подробный набор данных, доступных через этот API.

Cloud Cruiser может по-разному использовать интеграцию. В API доступны детализация (почасовая информация об использовании) и метаданные ресурсов, которые предоставляет необходимый набор данных для работы гибких моделей возвратных платежей и виртуальных счетов.

В этом учебнике мы покажем, как Cloud Cruiser может применять информацию API Usage. В частности, мы создадим новую группу ресурсов в Azure, сопоставим теги со структурой учетной записи и опишем процесс извлечения информации о тегах и ее обработки в Cloud Cruiser.
 
Конечной целью является возможность создания таких отчетов, как приведенный ниже, и анализа затрат и потребления на основе структуры учетной записи, заполненной тегами.

![Рис. 10 — отчет с разбивкой по тегам][10]

### Теги Microsoft Azure

Данные, доступные в API Usage Azure, включают не только сведения о потреблении, но и метаданные ресурсов, в том числе все теги, сопоставленные с ними. Теги предоставляют собой простой способ организации ресурсов. Чтобы они эффективно работали, должны быть соблюдены следующие условия.

- Теги правильно применяются к ресурсам во время подготовки.
- Теги правильно используются в возвратных платежах и виртуальных счетах для привязки использования к структуре учетной записи организации.

Выполнение этих двух требований может быть сложной задачей, особенно если подготовка ресурсов или учет расходов выполняются вручную. При использовании тегов клиенты чаще всего жалуются на теги с опечатками, а также на неправильные и отсутствующие теги. Эти ошибки могут значительно усложнить учет расходов.

Благодаря новому API Usage Azure Cloud Cruiser может извлекать информацию о маркировке ресурсов тегами. Затем с помощью сложного инструмента ETL, который называется «книгой», Cloud Cruiser устраняет распространенные ошибки маркировки. Во время выполнения шагов преобразования, в котором используются регулярные выражения и корреляция данных, Cloud Cruiser умеет определять ресурсы с неправильными тегами и применять правильные теги, заполняя пропуски и обеспечивая правильное сопоставление ресурсов с потребителем.

В области учета расходов Cloud Cruiser автоматизирует процедуру выставления виртуального счета и возвратного платежа и может использовать сведения о тегах для привязки использования к соответствующему потребителю (Подразделение, Отделение, Проект и т. д.). Автоматизация совершенствует процесс учета расходов и обеспечивает его согласованность и подконтрольность.
 

### Создание группы ресурсов с тегами в Microsoft Azure
Первым шагом в этом учебнике является создание новой группы ресурсов на портале Azure и создание новых тегов для сопоставления их с ресурсами. В этом примере мы создадим следующие теги: Department, Environment, Owner, Project.

На снимке экрана портала Azure ниже показан образец группы ресурсов с сопоставленными тегами.

![Рис. 11 — группа ресурсов с сопоставленными тегами на портале Azure][11]

На следующем шаге мы извлечем информацию из API Usage в Cloud Cruiser. В настоящее время API Usage предоставляет ответы в формате JSON. Ниже приведен пример извлеченных данных:


    {
      "id": "/subscriptions/bb678b04-0e48-4b44-XXXX-XXXXXXX/providers/Microsoft.Commerce/UsageAggregates/Daily_BRSDT_20150623_0000",
      "name": "Daily_BRSDT_20150623_0000",
      "type": "Microsoft.Commerce/UsageAggregate",
      "properties":
      {
        "subscriptionId": "bb678b04-0e48-4b44-XXXX-XXXXXXXXX",
        "usageStartTime": "2015-06-22T00:00:00+00:00",
        "usageEndTime": "2015-06-23T00:00:00+00:00",
        "meterName": "Compute Hours",
        "meterRegion": "",
        "meterCategory": "Virtual Machines",
        "meterSubCategory": "Standard_D1 VM (Non-Windows)",
        "unit": "Hours",
        "instanceData": "{"Microsoft.Resources":{"resourceUri":"/subscriptions/bb678b04-0e48-4b44-XXXX-XXXXXXXX/resourceGroups/DEMOUSAGEAPI/providers/Microsoft.Compute/virtualMachines/MyDockerVM","location":"eastus","tags":{"Department":"Sales","Project":"Demo Usage API","Environment":"Test","Owner":"RSE"},"additionalInfo":{"ImageType":"Canonical","ServiceType":"Standard_D1"}}}",
        "meterId": "e60caf26-9ba0-413d-a422-6141f58081d6",
        "infoFields": {},
        "quantity": 8

      },
	},


### Импорт данных из API Usage в Cloud Cruiser

В книгах Cloud Cruiser доступен автоматический метод сбора и обработки информации из API Usage. Книга ETL (извлечения, преобразования и загрузки) позволяет настраивать сбор, преобразование и публикацию данных в базе данных Cloud Cruiser.

Каждая книга может иметь одну или несколько коллекций. Это позволяет сопоставлять данные из разных источников для дополнения или расширения данных об использовании. В этом примере мы создадим новый лист в книге шаблона Azure (_UsageAPI)_ и зададим новую _коллекцию_ для импорта данных из API Usage.

![Рис. 3 — данные Usage API, импортированные на лист UsageAPI][12]

Обратите внимание, что в этой книге уже есть другие листы для импорта служб из Azure (_ImportServices_) и обработки сведений о потреблении из API Billing (_PublishData_).

Мы собираемся извлекать и обрабатывать информацию из API Usage на листе _UsageAPI_ и сопоставлять информацию с данными потребления из API Billing на листе _PublishData_.

### Обработка информации о тегах из API Usage

После импорта данных в книгу мы создадим шаги преобразования на листе _UsageAPI_ для обработки информации из API. Сначала мы используем процессор «разделитель JSON» для извлечения тегов из одного поля (по мере того как они импортируются из API) и создаем новые поля для каждого из них (Department, Project, Owner и Environment).

![Рис. 4 — создание новых полей для информации тега][13]

Обратите внимание, служба «Сети» отсутствует в сведениях тега (желтый прямоугольник). Но, глядя на поле _ResourceGroupName_, мы можем сказать, что эта служба входит в ту же группу ресурсов. Поскольку у нас есть теги для других ресурсов из той же группы ресурсов, мы используем эти сведения, чтобы применить отсутствующие теги к этому ресурсу позднее.

На следующем шаге мы создадим таблицу подстановки, которая будет сопоставлять информацию, полученную из тегов, с полем _ResourceGroupName_. Эта таблица подстановки будет использоваться на следующем шаге для обогащения данных потребления сведениями о тегах.

### Добавление сведений о тегах в данные потребления

Теперь перейдем на лист _PublishData_, который обрабатывает данные потребления из API Billing, и добавим поля, извлеченные из тегов. Это можно сделать путем поиска в таблице подстановки, созданной на предыдущем шаге, используя _ResourceGroupName_ в качестве поискового запроса.

![Рис. 5 — заполнение структуры учетной записи данными из результатов поиска][14]

Обратите внимание, для устранения проблемы отсутствующих тегов применены поля соответствующей структуры учетной записи для службы «Сети». Мы также заполнили поля структуры учетной записи для ресурсов нашей целевой группы значением Other (Другое), чтобы различать их в отчетах.

Теперь нужно просто добавить еще один шаг, чтобы опубликовать данные об использовании. Во время выполнения этого шага к сведениям об использовании будут применены соответствующие тарифы для каждой службы, определенные в нашем тарифном плане. Полученные в результате расходы будут загружены в базу данных.

Хорошая новость заключается в том, что этот процесс вам нужно выполнить только один раз. После заполнения книги необходимо добавить ее в планировщик, и он будет запускать ее каждый час или день в запланированное время. Затем вам нужно будет только создавать новые отчеты или редактировать существующие, чтобы визуализировать и анализировать данные для получения релевантной информации об использовании облака.

### Дальнейшие действия

+ Подробные инструкции по созданию книг и отчетов Cloud Cruiser см. в электронной [документации](http://docs.cloudcruiser.com/) по Cloud Cruiser (требуется действительное имя входа). Для получения дополнительных сведений о Cloud Cruiser обратитесь по адресу [info@cloudcruiser.com](mailto:info@cloudcruiser.com).
+ В статье [Получение ценных сведений о потреблении ресурсов Microsoft Azure](billing-usage-rate-card-overview.md) приведены общие сведения об API использования ресурсов и RateCard в Azure.
+ В статье [Справочник по API REST выставления счетов в Azure](https://msdn.microsoft.com/library/azure/1ea5b323-54bb-423d-916f-190de96c6a3c) приведены дополнительные сведения о двух API, которые входят в состав набора API, предоставляемого диспетчером ресурсов Azure.
+ Если вы хотите подробнее изучить код примера, посетите страницу "Образцы кода API выставления счетов Microsoft Azure" сайте [Образцы кодов Azure](https://azure.microsoft.com/documentation/samples/?term=billing).

### Подробнее
+ В статье [Обзор диспетчера ресурсов Azure](resource-group-overview.md) приведены дополнительные сведения о диспетчере ресурсов Azure.

.<!--Image references-->
 
[1]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Create-New-Workbook-Collection.png "Рис. 1. Создание новой коллекции"
[2]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Import-Data-From-RateCard.png "Рис. 2. Импорт данных из новой коллекции"
[3]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Transformation-Steps-Process-RateCard-Data.png "Рис. 3. Действия преобразования для обработки данных, собранных из API RateCard"
[4]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Publish-RateCard-Data-New-Services-Rates.png "Рис. 4. Публикация данных из API RateCard в качестве новых служб и тарифов"
[5]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Verify-Azure-Services-And-Pricing1.png "Рис. 5. Проверка новых служб"
[6]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Verify-Azure-Services-And-Pricing2.png "Рис. 6. Проверка нового тарифного плана и связанных с ним тарифов"
[7]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Transforming-WAP-Normalize-Services.png "Рис. 7. Преобразование данных WAP для нормализации служб"
[8]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Workbook-Scheduling.png "Рис. 8. Планирование книги"
[9]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Workload-Cost-Simulation-Report.png "Рис. 9. Образец отчета для сценария сравнения стоимости рабочей нагрузки"
[10]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/1_ReportWithTags.png "Рис. 10 — отчет с разбивкой по тегам"
[11]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/2_ResourceGroupsWithTags.png "Рис. 11 — группа ресурсов с сопоставленными тегами на портале Azure"
[12]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/3_ImportIntoUsageAPISheet.png "Рис. 12 — данные Usage API, импортированные на лист UsageAPI"
[13]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/4_NewTagField.png "Рис. 13 — создание новых полей для информации тега"
[14]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/5_PopulateAccountStructure.png "Рис. 14 — заполнение структуры учетной записи данными из результатов поиска"

<!---HONumber=AcomDC_0817_2016-->