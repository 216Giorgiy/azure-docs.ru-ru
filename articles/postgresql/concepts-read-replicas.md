---
title: Реплики чтения в Базе данных Azure для PostgreSQL
description: В этой статье описывается настройка реплик чтения в Базе данных Azure для PostgreSQL.
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/23/2019
ms.openlocfilehash: 9270c3290bd7be0bbb79d30aff8becc04dcfc603
ms.sourcegitcommit: 644de9305293600faf9c7dad951bfeee334f0ba3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/25/2019
ms.locfileid: "54904018"
---
# <a name="read-replicas-in-azure-database-for-postgresql"></a>Реплики чтения в Базе данных Azure для PostgreSQL

> [!IMPORTANT]
> Компонент "Реплика чтения" доступен в рамках общедоступной предварительной версии.

Компонент "Реплики чтения" позволяет реплицировать данные с сервера Базы данных Azure для PostgreSQL (главный сервер) на несколько (до пяти) серверов только для чтения (реплики чтения) в том же регионе Azure. Реплики чтения асинхронно обновляются с использованием собственной технологии репликации ядра PostgreSQL.

Каждая реплика является новым сервером и ими можно управлять точно так же, как обычными автономными серверами Базы данных Azure для PostgreSQL. Для каждой реплики чтения вы оплачиваете подготовленные вычислительные ресурсы, выраженные в виртуальных ядрах, и подготовленный объем хранилища, выраженный в ГБ/месяц.

## <a name="when-to-use-read-replicas"></a>Когда следует использовать реплики чтения
Поддержка реплик чтения предназначена для того, чтобы повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Например, можно изолировать в реплики рабочие нагрузки чтения, направив рабочие нагрузки записи в главную базу данных.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью, а значит это решение плохо подходит для рабочих нагрузок с интенсивной записью.

Реплики чтения используют асинхронную репликацию PostgreSQL, а значит не предназначены для сценариев, требующих синхронной репликации. Между поступлением данных на главный сервер и на реплики будет существенная задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="creating-a-replica"></a>Создание реплики
На главном сервере параметр **azure.replication_support** должен иметь значение REPLICA. Чтобы изменение этого параметра вступило в силу, перезапустите сервер. (Параметр **azure.replication_support** применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти").

При запуске рабочего процесса создания реплики создается пустой сервер Базы данных Azure для PostgreSQL. Этот сервер заполняется данными, которые были на главном сервере. Время на создание новой реплики зависит от объема данных на главном сервере и времени, прошедшего с момента последнего еженедельного полного резервного копирования. Этот процесс может занимать от нескольких минут до нескольких часов.

Реплики чтения используют физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

> [!NOTE]
> Если вы еще не настроили оповещения хранилища на серверах, мы рекомендуем настроить их сейчас. Это позволит получать сведения о приближении к заполнению хранилища на сервере, которое влияет на эффективность репликации.

[Узнайте, как создать реплику чтения на портале Azure](howto-read-replicas-portal.md).

## <a name="connecting-to-a-replica"></a>Подключение к реплике
Создаваемая реплика не наследует от главного сервера правила брандмауэра или конечную точку службы виртуальной сети. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует от главного сервера учетную запись администратора. Также на реплики чтения копируются все учетные записи пользователей с главного сервера. К реплике чтения можно подключиться только с помощью учетных записей пользователей, доступных на главном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу Базы данных Azure для PostgreSQL. Например, если используется сервер с именем myreplica, а пользователь с правами администратора имеет имя myadmin, подключение из psql будет выполняться следующим образом:

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```
Введите пароль для учетной записи пользователя, когда появится соответствующий запрос.

## <a name="monitoring-replication"></a>Мониторинг репликации
В Azure Monitor доступна метрика **Max Lag across Replicas** (Максимальная задержка между репликами). Эта метрика доступна только на главном сервере. Она отображает задержку между главным сервером и той репликой, которая последней обновила данные. 

Также мы предоставляем в Azure Monitor метрику **Replica Lag** (Задержка реплик). Эта метрика доступна только для реплик. 

Метрика вычисляется из представления pg_stat_wal_receiver:

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())
```
Не забывайте, что метрика задержки реплик показывает время с момента последнего воспроизведения транзакций. Если на главном сервере не выполняются транзакции, метрика будет отображать соответствующее время задержки.

Мы рекомендуем настроить отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, напрямую запросите у главного сервера значение задержки репликации в байтах по всем репликам.
В PostgreSQL 10 выполните эту команду:
```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), stat.replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

В PostgreSQL 9.6 и более ранних версий:
```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), stat.replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> В случае перезапуска главного сервера или реплики период, необходимый для перезапуска и наверстывания, будет отражаться в значении метрики задержки реплики.

## <a name="stopping-replication-to-a-replica"></a>Остановка репликации на реплику
Вы всегда можете остановить репликацию между главным сервером и репликой. В этом случае реплика перезагрузится, чтобы удалить параметры репликации. После остановки репликации, настроенной между главным сервером и репликой, эта реплика становится отдельным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Данные на отдельном сервере не синхронизируются с главным сервером.

Это сервер нельзя снова преобразовать в реплику.

Прежде, чем останавливать репликацию, убедитесь, что реплика имеет все нужные данные.

Процесс остановки репликации описан в [этом практическом руководстве](howto-read-replicas-portal.md).


## <a name="considerations"></a>Рекомендации

### <a name="preparing-for-replica"></a>Подготовка к репликации
На главном сервере параметр **azure.replication_support** должен иметь значение REPLICA, чтобы можно было создать реплику. Чтобы изменение этого параметра вступило в силу, перезапустите сервер. Этот параметр применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы решили остановить репликацию между основным сервером и репликой, для применения таких изменений реплика будет перезапущена. Вы не сможете снова преобразовать этот сервер в реплику.

### <a name="replicas-are-new-servers"></a>Реплики — это новые серверы
Реплики создаются как новые серверы Базы данных Azure для PostgreSQL. Существующие серверы нельзя преобразовать в реплики.

### <a name="replica-server-configuration"></a>Конфигурация сервера-реплики
Серверы-реплики создаются с помощью тех же конфигураций сервера, что и главный сервер, включая следующие аспекты:
- Ценовой уровень
- Поколение вычислительных ресурсов
- Виртуальные ядра
- Хранилище
- Срок хранения моментального снимка
- Вариант избыточности для резервного копирования
- Версия ядра PostgreSQL

После создания реплики вы можете независимо от главного сервера изменять для нее ценовую категорию (за исключением категории "Базовый"), поколение вычислительных ресурсов, число виртуальных ядер, объем хранилища и период хранения резервных копий.

> [!IMPORTANT]
> Прежде чем изменить параметры конфигурации на главном сервере, установите на каждой реплике такие же или более высокие значения. Это нужно для того, чтобы реплики справлялись с нагрузкой, соответствующей новым параметрам главного сервера.

В частности, Postgres требует, чтобы параметр max_connections на реплике имел значение не ниже, чем на главном сервере. При несоблюдении этого правила реплика не запустится. В Базе данных Azure для PostgreSQL значение max_connections устанавливается в зависимости от номера SKU. Чтобы получить дополнительные сведения, [изучите документацию по ограничениям](concepts-limits.md). 

Любое обновление, которое нарушает это правило, приведет к возникновению ошибки.


### <a name="deleting-the-master"></a>Удаление главного сервера
При удалении главного сервера все его реплики чтения становятся отдельными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

### <a name="other"></a>Другие
- Реплики чтения можно создавать только в том же регионе Azure, где расположен основной сервер.
- Создание реплики реплики не поддерживается.

## <a name="next-steps"></a>Дополнительная информация
- [Создание реплик чтения и управлении ими с помощью портала Azure](howto-read-replicas-portal.md).
