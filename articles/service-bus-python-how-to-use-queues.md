<properties linkid="develop-python-service-bus-queues" urlDisplayName="Service Bus Queues" pageTitle="How to use Service Bus queues (Python) - Azure" metaKeywords="Azure Service Bus queues, Azure queues, Azure messaging, Azure queues Python" description="Learn how to use Service Bus queues in Azure. Code samples written in Python." metaCanonical="" services="service-bus" documentationCenter="Python" title="How to Use Service Bus Queues" authors="huvalo" solutions="" manager="" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="python" ms.topic="article" ms.date="01/01/1900" ms.author="huvalo"></tags>

# Использование очередей Service Bus

В этом руководстве показано, как использовать очереди Service Bus. Примеры написаны на Python и используют модуль Python для Azure. Здесь описаны такие сценарии, как **создание очередей, отправка и получение сообщений**, а также **удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия][Дальнейшие действия].

## Оглавление

-   [Что такое очереди Service Bus?][Что такое очереди Service Bus?]
-   [Создание пространства имен службы][Создание пространства имен службы]
-   [Получение учетных данных управления по умолчанию для пространства имен][Получение учетных данных управления по умолчанию для пространства имен]
-   [Практическое руководство. Создать очередь][Практическое руководство. Создать очередь]
-   [Практическое руководство. Отправка сообщений в очередь][Практическое руководство. Отправка сообщений в очередь]
-   [Практическое руководство. Получение сообщений из очереди][Практическое руководство. Получение сообщений из очереди]
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений][Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]
-   [Дальнейшие действия][Дальнейшие действия]

[WACOM.INCLUDE [обслуживание-очередей-шины][обслуживание-очередей-шины]]

**Примечание.** Если нужно установить клиентские библиотеки или Python, см. [Руководство по установке Python][Руководство по установке Python].

## <a name="create-queue"> </a>Практическое руководство. Создание очереди

Объект **ServiceBusService** позволяет работать с очередями. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к Service Bus Azure программным способом:

    from azure.servicebus import *

Следующий код создает объект **ServiceBusService**. Замените атрибуты mynamespace, sharedaccesskeyname и sharedaccesskeyname на фактические значения пространства имен, название ключа сигнатуры общего доступа и его значение.

    bus_service = ServiceBusService(
        service_namespace='mynamespace',
        shared_access_key_name='sharedaccesskeyname',
        shared_access_key_value='sharedaccesskey')

Значения названия и ключа можно найти в сведениях о подключении на портале Azure или в окне "свойства" Visual Studio, если выбрать пространство имен шины обслуживания в обозревателе серверов (как показано в предыдущем разделе).

    bus_service.create_queue('taskqueue')

**create\_queue** также поддерживает дополнительные параметры, позволяющие переопределить настройки очереди по умолчанию, такие как срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди 5 ГБ и срок жизни 1 минуту.

    queue_options = Queue()
    queue_options.max_size_in_megabytes = '5120'
    queue_options.default_message_time_to_live = 'PT1M'

    bus_service.create_queue('taskqueue', queue_options)

## <a name="send-messages"> </a>Практическое руководство. Отправка сообщений в очередь

Чтобы отправить сообщение в очередь шины обслуживания, в приложении вызывается метод **send\_queue\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить тестовое сообщение в очередь с именем *taskqueue* с помощью **send\_queue\_message**.

    msg = Message('Test Message')
    bus_service.send_queue_message('taskqueue', msg)

Очереди шины обслуживания поддерживают максимальный размер сообщения в 256 КБ (максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, составляет 64 КБ). Ограничения на количество сообщений в очереди нет, но есть максимальный общий размер сообщений, содержащихся в очереди. Этот размер очереди, определяемый в момент ее создания, не должен превышать верхний предел в 5 ГБ.

## <a name="receive-messages"> </a>Практическое руководство. Получение сообщений из очереди

Сообщения извлекаются из очереди с помощью метода **receive\_queue\_message** объекта **ServiceBusService**.

    msg = bus_service.receive_queue_message('taskqueue', peek_lock=False)
    print(msg.body)

Сообщения удаляются из очереди по мере их чтения, если для параметра
**peek\_lock** задано значение **false**. Вы можете считать (просмотреть) и заблокировать сообщение без его удаления из очереди, установив параметру **peek\_lock** значение **True**.

Поведение по умолчанию — чтение и удаление сообщения как часть операции получения — является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку шина обслуживания помечает сообщение как используемое, то после того, как приложение перезапускается и снова начинает обрабатывать сообщения, оно пропустит сообщение, которое использовалось до сбоя.

Если параметр **peek\_lock** имеет значение **True**, получение становится операцией из двух этапов, что позволяет поддерживать приложения, неустойчивые к пропуску сообщений. Когда шина обслуживания получает запрос, выполняется поиск следующего принимаемого сообщения, которое затем блокируется, чтобы другие получатели его не получили, и затем возвращается приложению. После того как приложение закончит обработку сообщения (или надежно его сохранит для последующей обработки), шина завершает вторую стадию процесса приема сообщения, вызывая метод **delete** объекта **Message**. Метод **delete** помечает сообщение как использованное и удаляет его из очереди.

    msg = bus_service.receive_queue_message('taskqueue', peek_lock=True)
    print(msg.body)

    msg.delete()

## <a name="handle-crashes"> </a>Обработка сбоев приложения и нечитаемых сообщений

Шина обслуживания предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock** объекта **Message**. После этого шина обслуживания разблокирует сообщение в очереди и сделает его доступным для приема тем же или другим приложением-получателем.

Кроме того, с сообщением, заблокированным в очереди, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), то шина обслуживания автоматически разблокирует сообщение и сделает его доступным для приема.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки подобных случаев. Часто это достигается с помощью свойства сообщения **MessageId**, которое остается постоянным для различных попыток доставки.

## <a name="next-steps"> </a> Дальнейшие действия

Вы узнали основные сведения об очередях Service Bus. Для получения дополнительных сведений используйте следующие ссылки.

-   См. справочник MSDN: [Очереди, разделы и подписки.][Очереди, разделы и подписки.]

  [Дальнейшие действия]: #next-steps
  [Что такое очереди Service Bus?]: #what-are-service-bus-queues
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Практическое руководство. Создать очередь]: #create-queue
  [Практическое руководство. Отправка сообщений в очередь]: #send-messages
  [Практическое руководство. Получение сообщений из очереди]: #receive-messages
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #handle-crashes
  [обслуживание-очередей-шины]: ../includes/howto-service-bus-queues.md
  [Руководство по установке Python]: ../python-how-to-install/
  [Очереди, разделы и подписки.]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh367516.aspx
