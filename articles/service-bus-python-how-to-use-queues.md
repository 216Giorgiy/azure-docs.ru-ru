<properties urlDisplayName="Service Bus Queues" pageTitle="Использование очередей служебной шины (Python) - Azure" metaKeywords="Очереди служебной шины Azure, очереди Azure, обмен сообщениями Azure, очереди Azure Python" description="Узнайте, как использовать очереди Service Bus в Azure. Примеры кода написаны на Python." metaCanonical="" services="service-bus" documentationCenter="Python" title="How to Use Service Bus Queues" authors="huvalo" solutions="" manager="wpickett" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="python" ms.topic="article" ms.date="09/19/2014" ms.author="huvalo" />




# Использование очередей Service Bus
В этом руководстве показано, как использовать очереди Service Bus. Примеры
написаны на Python и используют модуль Python Azure. Здесь описаны такие сценарии,
как **создание очередей, отправка и получение сообщений**, а также
**удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия][].

## Оглавление

-   [Что такое очереди Service Bus?][]
-   [Создание пространства имен службы][]
-   [Получение учетных данных управления по умолчанию для пространства имен][]
-   [Практическое руководство. Создать очередь][]
-   [Практическое руководство. Отправка сообщений в очередь][]
-   [Практическое руководство. Получение сообщений из очереди][]
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений][]
-   [Дальнейшие действия][]

[WACOM.INCLUDE [howto-service-bus-queues](../includes/howto-service-bus-queues.md)]

**Примечание.** Если нужно установить клиентские библиотеки или Python, см. [Руководство по установке Python](../python-how-to-install/).


## <a name="create-queue"> </a>Создание очереди

Объект **ServiceBusService** позволяет работать с очередями. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к Service Bus Azure программным способом:

	from azure.servicebus import ServiceBusService, Message, Queue

Следующий код создает объект **ServiceBusService**. Замените "mynamespace", "sharedaccesskeyname" и "sharedaccesskey" настоящим пространством имен, именем и значением ключа подписанного URL-адреса (SAS).

	bus_service = ServiceBusService(
		service_namespace='mynamespace',
		shared_access_key_name='sharedaccesskeyname',
		shared_access_key_value='sharedaccesskey')

Значения для имени и параметра ключа SAS можно найти в сведениях о подключении к порталу Azure или в окне "Свойства" Visual Studio при выборе пространства имен шины обслуживания в обозревателе сервера (как показано в предыдущем разделе).

	bus_service.create_queue('taskqueue')

**create_queue** также поддерживает дополнительные параметры, которые
позволяют переопределить параметры очереди по умолчанию, например срок жизни сообщения
или максимальный размер очереди. В следующем примере показано, как задать
максимальный размер очереди 5 ГБ и срок жизни 1 минута:

	queue_options = Queue()
	queue_options.max_size_in_megabytes = '5120'
	queue_options.default_message_time_to_live = 'PT1M'

	bus_service.create_queue('taskqueue', queue_options)

## <a name="send-messages"> </a>Отправка сообщений в очередь

Чтобы отправить сообщение в очередь Service Bus, приложение вызывает
метод **send\_queue\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить тестовое сообщение в
очередь с именем *taskqueue using* **send\_queue\_message**:

	msg = Message(b'Test Message')
	bus_service.send_queue_message('taskqueue', msg)

Очереди служебной шины поддерживают максимальный размер сообщения 256 КБ (заголовок,
, которая содержит стандартные и настраиваемые свойства приложения и размер которой
максимальный размер 64 КБ). Ограничения на количество сообщений нет
содержится в очереди, но существует ограничение на общий размер сообщений
в очереди. Этот размер очереди определен во время создания,
верхнее ограничение - 5 ГБ.

## <a name="receive-messages"> </a>Получение сообщений из очереди

Сообщения принимаются из очереди с помощью **receive\_queue\_message**
метод объекта **ServiceBusService**:

	msg = bus_service.receive_queue_message('taskqueue', peek_lock=False)
	print(msg.body)

сообщения удаляются из очереди по мере их прочтения, когда параметр
**peek\_lock** установлен в **False**. Вы можете читать (peek) и фиксировать
сообщение, не удаляя его из очереди, задавая параметр
**peek\_lock** равным **True**.

Алгоритм чтения и удаления сообщения как части
при этом операция получения является простейшей моделью, оптимальной для сценариев,
в которых приложение может не обрабатывать сообщение в случае
сбоя. Чтобы разобраться, рассмотрим сценарий, в котором
получатель выдает запрос на получение, и у него возникает сбой до его
обработки. Так как служебная шина отметила сообщение, как используемое,
после перезапуска приложения и возобновления обработки сообщений
оно пропустит сообщение, отправленное до сбоя.


Если параметр **peek\_lock** задан равным **True**, получение становится
получение становится операцией из двух этапов, что позволяет поддерживать приложения,
неустойчивые к пропуску сообщений. Получив запрос, служебная шина
находит следующее сообщение, блокирует его, чтобы предотвратить
его получение другими получателями, и возвращает его приложению.
Закончив обработку сообщения (или надежно сохранив его
 для будущей обработки), приложение выполняет второй этап
процесса получения, вызывая метод **delete** объекта **Message**
. Метод **delete** пометит сообщение как находящееся в использовании
и удалит его из очереди.

	msg = bus_service.receive_queue_message('taskqueue', peek_lock=True)
	print(msg.body)

	msg.delete()

## <a name="handle-crashes"> </a>Обработка сбоев приложения и нечитаемых сообщений

служебная шина предоставляет функции, помогающие надлежащим образом исправить ошибки
в приложении или восстановиться после трудностей, возникших при обработке сообщения. Если
приложение-получатель не может обработать сообщение по какой-то причине,
тогда оно может вызвать метод **unlock** 
объекта **Message**. После этого служебная шина разблокирует
сообщение в очереди и сделает его доступным для приема
тем же приложением или другим приложением.
приложения.

Существует также время ожидания, связанное с сообщением, заблокированным в
и если приложение не сможет обработать сообщение в течение времени ожидания
время ожидания блокировки истекает (например, при сбое приложения), то служебная шина
разблокирует сообщение автоматически и сделает его доступным для
повторного получения.

Если сбой приложения происходит после обработки сообщения
но до вызова метода **delete**, то сообщение
будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют
**обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться
по крайней мере один раз, но в некоторых случаях это же сообщение может быть
доставлено повторно. Если повторная обработка недопустима,
рекомендуется добавить в приложение дополнительную логику
для обработки повторной доставки сообщений. Часто это достигается с помощью
свойства **MessageId** сообщения, которое остается постоянным для
различных попыток доставки.

## <a name="next-steps"> </a>Дальнейшие действия

Теперь, когда вы изучили основы использования очередей служебной шины, перейдите
по ссылкам на дополнительные сведения.

-   Справочник MSDN: [Очереди, разделы и подписки.][]

  [Дальнейшие действия]: #next-steps
  [Что такое очереди Service Bus?]: #what-are-service-bus-queues
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Практическое руководство. Создать очередь]: #create-queue
  [Практическое руководство. Отправка сообщений в очередь]: #send-messages
  [Практическое руководство. Получение сообщений из очереди]: #receive-messages
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #handle-crashes
  [Основные понятия очередей]: ../../../DevCenter/dotNet/Media/sb-queues-08.png
  [Портал управления Azure]: http://manage.windowsazure.com
  
  
  
  
  
  [Очереди, разделы и подписки.]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh367516.aspx
