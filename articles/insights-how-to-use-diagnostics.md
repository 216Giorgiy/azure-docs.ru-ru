<properties title="How to use diagnostics" pageTitle="How to use diagnostics" description="Learn how to set up diagnostics for your resources in Azure." authors="stepsic"  />

<tags ms.service="application-insights" ms.workload="tbd" ms.tgt_pltfrm="ibiza" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="stepsic" />

# Настройка диагностики

На портале предварительной версии Azure теперь можно настроить регулярное получение подробных данных мониторинга и диагностики для виртуальных машин Windows и учетных записей хранения.

## Сбор подробных данных по виртуальным машинам
1. На [портале предварительной версии Azure](https://portal.azure.com/) нажмите **Browse** (Обзор), а затем **Virtual machines** (Виртуальные машины). Выберите виртуальную машину, которую нужно отслеживать.
2. В области **Monitoring** (Мониторинг) есть несколько метрик по умолчанию, таких как **CPU percentage** (Процент ЦП), **Disk read and write** (Операций чтения и записи на диск) и **Network in and out** (Входящие и исходящие данные сети). Если щелкнуть любую из них, откроется колонка **Metric** (Метрика).
    ![Область Monitoring](./media/insights-how-to-use-diagnostics/Insights_VMMonitoringLens.png)
3. Колонка **Metric** содержит сведения о выбранных метриках. В верхней части выноски находится график, а под ним — таблица статистических показателей для этих метрик, таких как среднее, минимальное и максимальное значения. Ниже приведен список оповещений, определенных вами и отфильтрованных в соответствии с метриками, представленными в колонке.
    ![Колонка Metric](./media/insights-how-to-use-diagnostics/Insights_VMMetricBlade.png)
4. Чтобы включить подробную диагностику, нажмите кнопку **Settings** (Параметры). Появится колонка **Diagnostics** (Диагностика). Нажмите кнопку **ON** (Вкл.):
    ![Колонка Diagnostics](./media/insights-how-to-use-diagnostics/Insights_VMDiagnosticsBlade.png)
    - **Basic metrics** (Основные метрики): метрики работоспособности виртуальной машины, например, относящиеся к процессору и памяти.
    - **Per disk metrics** (Метрики дисков): метрики для всех дисков, подключенных к виртуальной машине.
    - **.NET metrics** (Метрики .NET): метрики приложений .NET и ASP.NET, выполняющихся на виртуальной машине.
    - **Network metrics** (Метрики сети): метрики, относящиеся к сетевым подключениям и веб-службам.
    - **Windows event application logs** (Журналы событий приложений Windows): события Windows, отправляемые в канал приложений.
    - **Windows event system logs** (Журналы системных событий Windows): события Windows, отправляемые в канал системы. Сюда также относятся события из [Microsoft Antimalware](http://go.microsoft.com/fwlink/?LinkID=404171&clcid=0x409).
    - **Windows event security logs** (Журналы событий безопасности Windows): события Windows, отправляемые в канал безопасности.
    - **Diagnostics infrastructure logs** (Журналы инфраструктуры диагностики): журналы инфраструктуры сбора диагностических данных.
    - **IIS logs** (Журналы IIS): журналы сервера IIS.
        Все метрики и записи журналов регистрируются с интервалом в одну минуту, так что у вас всегда будет актуальная информация о виртуальной машине.

Если для учетной записи хранения включен сбор диагностических данных, взимается обычная плата за хранение, транзакции и исходящий трафик. Однако эти функции не создают больших объемов данных, возможно, за исключением журналов IIS. Чтобы снизить затраты на исходящий трафик, мы требуем выбирать учетную запись хранения, которая находится в том же регионе, что и виртуальная машина.

После нажатия кнопки **ОК** данные начнут появляться в учетной записи хранения в течение нескольких минут. Диагностику невозможно включить для виртуальных машин с ОС Linux. Кроме того, для включения диагностики необходимо установить гостевой агент.

## Сбор подробных данных по учетным записям хранения

Сбор некоторых данных по учетным записям хранения был возможен и ранее, но теперь на портале предварительной версии Azure вы можете собирать данные с интервалом в одну минуту, чтобы точно знать, что происходит в этих учетных записях. Инструкции по включению сбора метрик аналогичны инструкциям для виртуальных машин.

1. Откройте колонку **Metric** (Метрика), щелкнув одну из диаграмм в колонке **Storage account** (Учетная запись хранения).
2. На панели команд нажмите кнопку **Diagnostics** (Диагностика).
3. Выберите данные, которые нужно собирать из учетной записи хранения.
    
	![Диагностика хранилища](./media/insights-how-to-use-diagnostics/Insights_StorageDiagnostics.png)
4. Нажмите кнопку **ОК**. Первые данные появятся через несколько минут.

## Визуализация диагностических данных

Включив диагностику, вы можете просмотреть полный список доступных метрик, щелкнув любую диаграмму правой кнопкой мыши и выбрав пункт **Edit query** (Изменить запрос).

![Изменение запроса](./media/insights-how-to-use-diagnostics/Insights_VMEditQuery.png)

Вы можете отобразить метрики на диаграмме и уменьшить временной диапазон до последнего часа (параметр **Past hour**), увеличить его до последней недели (**Past week**) или даже выбрать настраиваемый диапазон (**Custom**).

![Настраиваемый временной диапазон](./media/insights-how-to-use-diagnostics/Insights_VMCustomTime.png)

Вы заметите, что эти метрики значительно подробнее тех данных, которые были доступны раньше, и отображаются с минимальной задержкой.

На сегодняшний день нет возможности визуализировать метрики, которые состоят из нескольких значений, например, относящиеся к каждому процессу или каждому диску. Дополнительные сведения о настройке диаграмм мониторинга см. в разделе [Настройка мониторинга](http://go.microsoft.com/fwlink/?LinkID=394523&clcid=0x409).

## Вывод оповещений на основе диагностических данных

В дополнение к визуализации метрик вы можете получать оповещения по любой из них на портале предварительной версии. Прокрутите страницу вниз, чтобы перейти к разделу **Alert rules** (Правила оповещений) в колонке виртуальной машины или учетной записи хранения и щелкните **Add alert** (Добавить оповещение):

![Добавление оповещения](./media/insights-how-to-use-diagnostics/Insights_VMAlerts.png)

Затем можно выбрать любые метрики из тех, для которых включен сбор данных:

![Оповещение JIT](./media/insights-how-to-use-diagnostics/Insights_VMJITAlert.png)

На графике будет показан порог оповещения в сравнении со значением метрики за предыдущий день. Через несколько минут после нажатия кнопки **Save** (Сохранить) вы начнете получать оповещения в случае превышения порогового значения.

Обратите внимание: для метрик, которые отображаются только на портале предварительной версии, невозможно включить оповещения на полнофункциональном портале. В связи с этим на нем не видны некоторые правила оповещений, доступные на портале предварительной версии.

