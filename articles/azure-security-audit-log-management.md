<properties
   pageTitle="Управление журналами безопасности и аудита Microsoft Azure | Microsoft Azure"
   description="Эта статья содержит вводные сведения по созданию, сбору и анализу журналов безопасности из служб, размещенных в Azure. Она предназначена для ИТ-специалистов и аналитиков по вопросам безопасности, ежедневно сталкивающихся с различными аспектами управления информационными активами, включая сотрудников, отвечающих за меры по обеспечению безопасности и соответствия в организации."
   services="virtual-machines, cloud-services, storage"
   documentationCenter="na"
   authors="TerryLanfear"
   manager="msStevenPo"
   editor=""/>

<tags
   ms.service="azure-security"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="08/13/2015"
   ms.author="mnayak;tomsh;terrylan"/>

# Управление журналами безопасности и аудита Microsoft Azure

Azure позволяет клиентам осуществлять создание и сбор событий безопасности из ролей "инфраструктура как услуга" (IaaS) и "платформы как услуга" (PaaS) Azure в центральное хранилище своих подписок. Клиенты затем могут использовать [HDInsight](http://azure.microsoft.com/documentation/services/hdinsight/) для статистической обработки и анализа собранных событий. Кроме того, эти собранные события можно экспортировать в локальные системы управления сведениями о безопасности и событиями (SIEM) в целях непрерывного мониторинга.

Жизненный цикл ведения журнала безопасности, анализа и мониторинга в Azure включает в себя следующее:

- **Создания**: инструментирование приложений и инфраструктуры для вызова событий;
- **Сбор**: настройка Azure на сбор различных журналов безопасности в учетной записи хранилища;
- **Анализ**: использование средств Azure, таких как HDInsight, и локальных систем SIEM для анализа журналов и получения ценных сведений по безопасности;
- **Мониторинг и создание отчетов**: Azure предлагает централизованные системы мониторинга и анализа, которые позволяют получить более полное представление о ситуации и выдают своевременные оповещения.

В этой статье основное внимание уделено этапам создания и сбора жизненного цикла.

## Создание журналов
События безопасности создаются в журнале событий Windows для каналов **системы**, **безопасности** и **приложения** в виртуальных машинах. Чтобы убедиться, что события регистрируются без потери данных, очень важно правильно настроить размер журнала событий. Размер журнала должен быть основан на количестве событий, создаваемых параметрами политик аудита, и определенных политиках сбора событий. Дополнительные сведения см. в разделе [Планирование мониторинга аудита безопасности и управления им](http://technet.microsoft.com/library/ee513968.aspx#BKMK_4).

>[AZURE.NOTE]При использовании модуля пересылки событий Windows (WEF) или системы диагностики Azure (описано в разделе [Сбор журналов](#log-collection)) для извлечения журналов из облачных служб или виртуальных машин учитывайте возможное влияние простоев в работе системы. Например, если среда WEF на некоторое время переходит в нерабочее состояние, необходимо убедиться, что журнал имеет достаточный размер для регистрации данных в течение более длительного периода, либо подготовиться к возможным потерям данных журнала.

Для приложений облачных служб, развернутых в Azure, и виртуальных машин, созданных с помощью [Azure Virtual Machines Marketplace](http://azure.microsoft.com/marketplace/virtual-machines/#microsoft), набор событий безопасности операционной системы включен по умолчанию. Клиенты могут добавлять, удалять или изменять события, подлежащие аудиту, настроив политику аудита операционной системы. Дополнительные сведения см. в разделе [Справочник по параметрам политик безопасности](http://technet.microsoft.com/library/jj852210.aspx).

Для создания дополнительных журналов для операционной системы (например, изменений политики аудита) и компонентов Windows (например, служб IIS) можно использовать следующие методы:

- групповая политика — для развертывания параметров политики для виртуальных машин в Azure, присоединенных к домену;
- служба настройки требуемого состояния (DSC) — для отправки параметров политики и управления ими. Дополнительные сведения см. в статье об [Azure PowerShell DSC](http://blogs.msdn.com/b/powershell/archive/2014/08/07/introducing-the-azure-powershell-dsc-desired-state-configuration-extension.aspx).
- Код запуска роли развертывания службы — для развертывания параметров для облачных служб (сценарий PaaS).

Настройка задач запуска роли Azure позволяет коду выполняться до запуска роли. Задачу запуска для роли можно определить, добавив элемент **Startup** в определение роли в файле определения службы, как показано в следующем примере. Дополнительную информацию см. в статье [Выполнение задач запуска в Azure](http://msdn.microsoft.com/library/azure/hh180155.aspx).

Файл задач, предназначенный для выполнения в качестве задачи запуска (EnableLogOnAudit.cmd в следующем примере), должен быть включен в пакет сборки. При использовании Visual Studio добавьте файл в облачный проект, щелкните правой кнопкой мыши имя файла, выберите пункт **Свойства**, а затем установите для параметра **Копировать в выходной каталог** значение **Всегда копировать**.

    <Startup>
        <Task commandLine="EnableLogOnAudit.cmd" executionContext="elevated" taskType="simple" />
    </Startup>

Содержимое EnableLogOnAudit.cmd:

    @echo off
    auditpol.exe /set /category:"Logon/Logoff" /success:enable /failure:enable
    Exit /B 0

Используемый в предыдущем примере [Auditpol.exe](https://technet.microsoft.com/library/cc731451.aspx) представляет собой программу командной строки, входящую в состав операционной системы Windows Server, которая позволяет управлять параметрами политики аудита.

В дополнение к созданию журналов событий Windows можно настроить различные компоненты операционной системы Windows для создания журналов, которые важны для мониторинга и анализа безопасности. Например, журналы служб IIS и журналы http.err автоматически создаются для веб-ролей и могут быть настроены для сбора данных. Эти журналы предоставляют ценную информацию, которую можно использовать для идентификации несанкционированного доступа или атак, направленных против веб-роли. Дополнительные сведения см. в разделах [Настройка ведения журнала в IIS](http://technet.microsoft.com/library/hh831775.aspx) и [Расширенное ведение журналов для служб IIS — настраиваемое протоколирование](http://www.iis.net/learn/extensions/advanced-logging-module/advanced-logging-for-iis-custom-logging).

Чтобы изменить ведение журналов служб IIS в веб-роли, клиенты могут добавить задачу запуска в файл определения службы веб-роли. В следующем примере включается ведение журнала HTTP для веб-сайта с именем Contoso и указывается, что службы IIS должны регистрировать в журнале все запросы для веб-сайта Contoso.

Задачу, которая обновляет конфигурацию служб IIS, следует включить в файл определения службы веб-роли. Следующие изменения в файле определения службы выполняют задачу запуска, которая настраивает ведение журнала служб IIS посредством запуска сценария с именем ConfigureIISLogging.cmd.

    <Startup>
        <Task commandLine="ConfigureIISLogging.cmd" executionContext="elevated" taskType="simple" />
    </Startup>

Содержимое ConfigureIISLogging:cmd

    @echo off
    appcmd.exe set config "Contoso" -section:system.webServer/httpLogging /dontLog:"True" /commit:apphost
    appcmd.exe set config "Contoso" -section:system.webServer/httpLogging /selectiveLogging:"LogAll" /commit
    Exit /B 0


## <a name="log-collection"></a>Сбор журналов
Сбор журналов и событий безопасности из облачных служб или виртуальных машин в Azure осуществляется двумя основными способами:

- система диагностики Azure, которая собирает данные событий в клиентской учетной записи хранения Azure;
- модуль пересылки событий Windows (WEF) — технология на компьютерах под управлением Windows.

Некоторые ключевые различия между двумя этими технологиями приведены в следующей таблице. Необходимо выбрать подходящий метод реализации сбора журналов, учитывая собственные требования и указанные различия.

| Диагностика Azure | Модуль пересылки событий Windows |
|-----|-----|
|Поддерживает виртуальные машины Azure и облачные службы Azure | Поддерживает только виртуальные машины Azure, присоединенные к домену |
|Поддерживает различные форматы журналов, такие как журналы событий Windows, журналы [трассировки событий Windows](https://msdn.microsoft.com/library/windows/desktop/bb968803.aspx) (ETW) и журналы служб IIS. Дополнительные сведения см. в разделе [Источники данных, поддерживаемые системой диагностики Azure](#diagnostics) |Поддерживает только журналы событий Windows |
|Передает собранные данные в службу хранилища Azure |Перемещает собранные данные на центральные сервера сборщика |

##	Сбор данных событий безопасности с помощью модуля пересылки событий Windows
WEF для присоединенных к домену виртуальных машин Azure можно настроить с помощью параметров групповой политики по аналогии с присоединенными к домену локальными компьютерами. Дополнительные сведения см. в разделе [Гибридное облако](http://www.microsoft.com/server-cloud/solutions/hybrid-cloud.aspx).

При таком подходе организация может приобрести подписку IaaS, подключить ее к своей корпоративной сети с помощью [ExpressRoute](http://azure.microsoft.com/services/expressroute/) или VPN типа "сеть-сеть", а затем присоединить имеющиеся в Azure виртуальные машины к корпоративному домену. После этого можно настроить WEF с компьютеров, присоединенных к домену.

Пересылка событий делится на две части: источник и сборщик. Источник — это компьютер, где создаются журналы безопасности. Сборщик — это централизованный сервер, который собирает и объединяет журналы событий. ИТ-администраторы могут подписаться на события, чтобы иметь возможность получать и регистрировать события, которые перенаправляются с удаленных компьютеров (источник событий). Дополнительные сведения см. в разделе [Настройка компьютеров для пересылки и сбора событий](http://technet.microsoft.com/library/cc748890.aspx).

Собранные события Windows можно отправить в локальные средства анализа, например SIEM, для дальнейшего анализа.

## Сбор данных безопасности с помощью системы диагностики Azure
Система диагностики Azure позволяет собирать диагностические данные из рабочей роли или веб-роли облачной службы, а также из виртуальных машин, запущенных в Azure. Это готовое расширение гостевого агента, которое необходимо включить и настроить для сбора данных. Подписка клиента может включать в себя отправку данных в службу хранилища Azure.

В процессе транспортировки эти данные шифруются (по протоколу HTTPS). В примерах, приведенных в этом документе, используется система диагностики Azure 1.2. Для сбора данных безопасности рекомендуется выполнить обновление до версии 1.2 или более поздней. Дополнительные сведения см. в разделе [Сбор данных журнала с помощью системы диагностики Azure](http://msdn.microsoft.com/library/gg433048.aspx).

На следующей схеме показана высокоуровневая процедура для сбора данных безопасности, в которой используется система диагностики Azure, а также последующий анализ и мониторинг.

![][1]

Система диагностики Azure перемещает журналы из приложений облачных служб клиента и [виртуальных машин Azure](virtual-machines-about.md) в службу хранилища Azure. В зависимости от формата журнала некоторые данные хранятся в таблицах Azure, а некоторые — в BLOB-объектах. Данные, собираемые в [службе хранилища Azure](storage-introduction.md), можно загрузить в локальные системы SIEM с помощью клиентской библиотеки службы хранилища Azure для осуществления мониторинга и анализа.

Кроме того, можно использовать HDInsight для дальнейшего анализа данных в облаке. Ниже приведены некоторые примеры сбора данных безопасности, использующие систему диагностики Azure.

### Сбор данных безопасности из виртуальных машин Azure с помощью системы диагностики Azure

В следующих примерах система диагностики Azure 1.2 и командлеты Azure PowerShell используются для обеспечения сбора данных безопасности из виртуальных машин. Данные собираются из виртуальных машин с заданным интервалом (который можно настроить) и помещаются в службу хранилища Azure в подписке клиента. В этом разделе мы рассмотрим два сценария сбора журналов с использованием системы диагностики Azure:

1. настройка нового экземпляра конвейера сбора журналов безопасности на виртуальной машине;
2. обновление существующего конвейера сбора журналов безопасности до новой конфигурации на виртуальной машине.

#### Настройка нового экземпляра конвейера сбора журналов безопасности на виртуальной машине
В этом примере мы настраиваем новый экземпляр конвейера сбора журналов безопасности, который использует систему диагностики Azure, и определяем события сбоя входа (коды событий 4624 и 4625) из виртуальных машин. Вы можете выполнить следующие действия из своей среды разработки или использовать сеанс удаленного рабочего стола через протокол удаленного рабочего стола (RDP) для подключения к узлу в облаке.

##### Шаг 1. Установка пакета SDK Azure PowerShell
Пакет SDK Azure PowerShell предоставляет командлеты для настройки системы диагностики Azure на виртуальных машинах Azure. Необходимые командлеты доступны в Azure PowerShell версии 0.8.7 или более поздней версии. Дополнительные сведения см. в разделе [Установка и настройка Azure PowerShell](powershell-install-configure.md).

##### Шаг 2. Подготовка файла конфигурации
Подготовьте файл конфигурации на основе событий, которые требуется собирать. Ниже приведен пример файла конфигурации системы диагностики Azure для сбора событий Windows из канала **безопасности** с фильтрами, позволяющими собирать только события успешного и неудачного входа. Дополнительные сведения см. в разделе [Схема конфигурации системы диагностики Azure 1.2](http://msdn.microsoft.com/library/azure/dn782207.aspx).

Учетную запись хранения можно указать в файле конфигурации либо в качестве параметра при запуске командлетов Azure PowerShell для настройки системы диагностики Azure.

    <?xml version="1.0" encoding="utf-8" ?>
    <PublicConfig xmlns="http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration">
        <WadCfg>
            <DiagnosticMonitorConfiguration overallQuotaInMB="10000">
                <WindowsEventLog scheduledTransferPeriod="PT1M">
                    <DataSource name="Security!*[System[(EventID=4624 or EventID=4625)]]" />
                </WindowsEventLog>
            </DiagnosticMonitorConfiguration>
        </WadCfg>
    </PublicConfig>

При сохранении предыдущего содержимого в формате XML-файла выберите кодировку **UTF-8**. Если вы используете блокнот, параметр кодировки отображается в диалоговом окне "Сохранить как". В следующей таблице перечислены некоторые ключевые атрибуты файла конфигурации.

| Атрибут | Описание |
|----- |-----|
| overallQuotaInMB | Максимальный объем места на локальном диске, который может использовать система диагностики Azure (значение можно настроить). |
| scheduledTransferPeriod | Интервал между запланированными передачами в службу хранилища Azure, округленный с точностью до ближайшей минуты. |
| Имя | В WindowsEventLog этот атрибут является запросом XPath, описывающим собираемые события Windows. Сбор данных можно фильтровать путем добавления фильтра, например, по идентификатору события, имени поставщика или каналу. |

Все данные журнала событий Windows перемещаются в таблицу с именем **WADWindowsEventLogsTable**. В настоящее время система диагностики Azure не поддерживает переименование данной таблицы.

##### <a name="step3"></a> Шаг 3. Проверка XML-файла конфигурации
Используйте следующую процедуру, чтобы убедиться в отсутствии ошибок в XML-файле конфигурации и его совместимости со схемой диагностики Azure:

1. Чтобы скачать файл схемы, выполните следующую команду и затем сохраните файл.

    (Get-AzureServiceAvailableExtension -ExtensionName 'PaaSDiagnostics' -ProviderNamespace 'Microsoft.Azure.Diagnostics').PublicConfigurationSchema | Out-File -Encoding utf8 -FilePath 'WadConfigSchema.xsd'

2. После скачивания файла схемы можно проверить XML-файл конфигурации на соответствие этой схеме. Для проверки файла с помощью Visual Studio выполните следующие действия.
  - Откройте XML-файл в Visual Studio.
  - Нажмите клавишу F4, чтобы открыть **Свойства**
  - Щелкните **Схема**, **Добавить**, выберите скачанный файл схемы (WadConfigSchema.XSD) и нажмите кнопку **ОК**.

3.	В меню **Вид** щелкните **Список ошибок**, чтобы просмотреть все имеющиеся ошибки проверки.

##### <a name="step4"></a> Шаг 4. Настройка системы диагностики Azure
 Чтобы включить систему диагностики Azure и начать сбор данных, выполните следующие действия.

 1.	Чтобы открыть Azure PowerShell, введите **Add-AzureAccount** и нажмите клавишу ВВОД.
 2.	Войдите в систему с использованием учетной записи Azure.
 3.	Запустите следующий сценарий PowerShell. Не забудьте обновить значения storage\_name, key, config\_path, service\_name и vm\_name.

 ```PowerShell
$storage_name ="<Storage Name>"
$key = "<Storage Key>"
$config_path="<Path Of WAD Config XML>"
$service_name="<Service Name. Usually it is same as VM Name>"
$vm_name="<VM Name>"
$storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key
$VM1 = Get-AzureVM -ServiceName $service_name -Name $vm_name
$VM2 = Set-AzureVMDiagnosticsExtension -DiagnosticsConfigurationPath $config_path -Version "1.*" -VM $VM1 -StorageContext $storageContext
$VM3 = Update-AzureVM -ServiceName $service_name -Name $vm_name -VM $VM2.VM
 ```

##### Шаг 5. Создание событий
В демонстрационных целях мы создадим несколько событий входа в систему и убедимся, что данные поступают в службу хранилища Azure. Как показано выше в шаге 2, XML-файл настроен для сбора кодов событий 4624 (Успешный вход) и 4625 (Ошибка при входе) из канала **безопасности**.

 Для создания этих событий выполните следующие действия:

1.	откройте сеанс RDP для связи с виртуальной машиной;
2.	введите неверные учетные данные для создания нескольких событий неудачного входа (код события 4625);
3.	после нескольких неудачных попыток входа в систему введите правильные учетные данные для создания события успешного входа (код события 4624).

##### Шаг 6. Просмотр данных
Примерно через пять минут после выполнения предыдущих шагов данные должны начать поступать в пользовательскую учетную запись хранения в соответствии с конфигурацией в XML-файле. Существует множество разных средств для просмотра данных в службе хранилища Azure. Дополнительные сведения см. в следующих статьях:

- [Обзор ресурсов хранилища с помощью обозревателя сервера](http://msdn.microsoft.com/library/azure/ff683677.aspx)
- [Обозреватель хранилищ Azure 6, предварительная версия 3 (август 2014 г.)](http://azurestorageexplorer.codeplex.com/)

Чтобы просмотреть данные, выполните следующие действия:

1.	в Visual Studio (2013, 2012 и 2010 с пакетом обновления 1) щелкните элемент **Вид**, а затем **Обозреватель серверов**;
2.	перейдите к учетной записи хранения;
3.	щелкните **Таблицы** и дважды щелкните соответствующие таблицы для просмотра журналов безопасности, собранных из виртуальных машин; ![][2]

4.	щелкните правой кнопкой мыши таблицу с именем WADWindowsEventLogsTable и выберите пункт **Просмотр данных** для открытия представления таблицы, как показано ниже:

![][3]

**PartitionKey**, **RowKey** и **Timestamp** в предыдущей таблице хранилища являются системными свойствами.

- **PartitionKey** представляет собой метку времени в секундах и является уникальным идентификатором раздела в таблице.
- **RowKey** — это уникальный идентификатор сущности внутри раздела.

Вместе **PartitionKey** и **RowKey** однозначно идентифицируют каждую сущность в пределах таблицы.

- Метка времени представляет собой значение даты и времени, которое хранится на сервере для отслеживания времени последнего изменения сущности.

>[AZURE.NOTE]Максимальный размер строки в таблице службы хранилища Azure ограничен 1 МБ. Учетная запись хранения может содержать до 200 ТБ данных из больших BLOB-объектов, очередей и таблиц, если учетная запись была создана после июня 2012 г. Таким образом, размер таблицы может увеличиваться до 200 ТБ, если BLOB-объекты и очереди не занимают места в хранилище. Учетные записи, созданные до июня 2012 г., имеют ограничение в 100 ТБ.

Обозреватель хранилищ также позволяет редактировать данные в таблице. Дважды щелкните отдельную строку в представлении таблицы, чтобы открыть окно "Изменение сущности", как показано ниже:

![][4]

#### Обновление существующего конвейера сбора журналов безопасности до новой конфигурации на виртуальной машине
В этом разделе мы обновляем существующий конвейер сбора журналов безопасности системы диагностики Azure на виртуальной машине и определяем наличие ошибок журнала событий приложений Windows.

##### Шаг 1. Обновление файла конфигурации для включения нужных событий
Файл системы диагностики Azure, созданный в предыдущем примере, необходимо обновить для включения типов ошибок журнала событий приложений Windows.

>[AZURE.NOTE]Все существующие параметры конфигурации системы диагностики Azure должны быть объединены с новым файлом конфигурации. Параметры, заданные в новом файле, записываются поверх существующих конфигураций.

Для получения существующего параметра конфигурации можно использовать командлет **Get AzureVMDiagnosticsExtension**. Ниже приведен пример сценария Azure PowerShell для извлечения существующей конфигурации.

    $service_name="<VM Name>"
    $VM1 = Get-AzureVM -ServiceName $service_name
    $config = Get-AzureVMDiagnosticsExtension -VM $VM1 | Select -Expand PublicConfiguration | % {$_.substring($_.IndexOf(':"')+2,$_.LastIndexOf('",')-$_.IndexOf(':"')-2)}
    [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($config))
Обновите конфигурацию системы диагностики Azure для сбора ошибок журналов событий приложений Windows и критических событий следующим образом:

    <?xml version="1.0" encoding="utf-8" ?>
    <PublicConfig xmlns="http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration">
    <WadCfg>
        <DiagnosticMonitorConfiguration overallQuotaInMB="10000">
            <WindowsEventLog scheduledTransferPeriod="PT1M">
                <DataSource name="Application!*[System[(Level =2)]]" />
                <DataSource name="Security!*[System[(EventID=4624 or EventID=4625)]]" />
            </WindowsEventLog>
        </DiagnosticMonitorConfiguration>
    </WadCfg>
    </PublicConfig>

проверьте файл конфигурации, используя те же действия, что и в описанном выше [шаге 3 "Проверка XML-файла конфигурации"](#step3).

##### Шаг 2. Обновление системы диагностики Azure для использования нового файла конфигурации
Используйте командлеты **Set-AzureVMDiagnosticsExtension** и **Update-AzureVM** для обновления конфигурации, как показано выше в [шаге 4 "Настройка системы диагностики Azure"](#step4).

##### Шаг 3. Проверка параметров конфигурации
Выполните следующую команду, чтобы убедиться, что параметры конфигурации были обновлены:

    $service_name="<VM Name>"
    $VM1 = Get-AzureVM -ServiceName $service_name
    Get-AzureVMDiagnosticsExtension -VM $VM1

##### Шаг 4. Создание событий
Для этого примера выполните следующую команду, чтобы создать журнал событий приложения типа **Ошибка**:

    eventcreate /t error /id 100 /l application /d "Create event in application log for Demo Purpose"

![][5]

Откройте окно просмотра событий, чтобы убедиться, что это событие создано.

![][6]

##### Шаг 5. Просмотр данных
Откройте обозреватель серверов в Visual Studio для просмотра данных журнала. Вы должны увидеть **EventID 100**, созданный на **ContosoDesktop**, как показано ниже:

![][7]

## Сбор данных безопасности из облачных служб Azure с помощью системы диагностики Azure

Теперь мы будем использовать систем диагностики Azure для реализации тех же двух сценариев сбора журналов из облачных служб Azure, что и в предыдущем разделе, посвященном виртуальным машинам (IaaS):

1.	Настройка нового экземпляра конвейера журналов безопасности в облачной службе.
2.	Обновление существующего конвейера сбора журналов до новой конфигурации в облачной службе.

Пошаговое руководство в этом разделе содержит следующие этапы:

1.	создание облачной службы;
2.	настройка облачной службы для сбора журналов безопасности с помощью системы диагностики Azure;
3.	иллюстрирование создания и сбора событий безопасности в облачной службе;

    - добавление администратора в локальную группу с повышением привилегий;
    - создание нового процесса.
4.	Обновление существующего конвейера сбора журналов в облачной службе:

    - включение аудита событий брандмауэра узла (в качестве примера событий безопасности сети) с помощью средства Auditpol;
    - настройка собираемых данных аудита брандмауэра и отображение собранных событий в учетной записи хранения клиента;
5.	демонстрация распределения событий безопасности Windows и обнаружения пиковых значений;
6.	настройки сбора журналов служб IIS и проверка данных.

Все события и журналы собираются в учетную запись хранения клиента в Azure. Клиент может просматривать события и экспортировать их в локальные системы SIEM. Кроме того, можно осуществлять их статистическую обработку и анализ с помощью HDInsight.

### Настройка нового экземпляра конвейера сбора журналов в облачной службе
В этом примере мы настраиваем новый экземпляр конвейера сбора журналов безопасности, который использует систему диагностики Azure, и определяем добавление пользователя в локальную группу, а также события создания нового процесса в экземпляре облачной службы.

#### Шаг 1. Создание облачной службы (веб-роль) и развертывание

1.	На компьютере разработчика запустите Visual Studio 2013.
2.	Создайте новый проект облачной службы (в нашем примере используется ContosoWebRole).
3.	Выберите веб-роль **ASP.NET**.
4.	Выберите проект **MVC**.
5.	В обозревателе решений щелкните элемент **Роли**, затем дважды щелкните веб-роль (WebRole1), чтобы открыть окно **Свойства**.
6.	На вкладке **Конфигурация** снимите флажок **Включить диагностику**, чтобы отключить ту версию системы диагностики Azure, которая входит в состав Visual Studio 2013. ![][8]

7.	Создайте свое решение, чтобы проверить, что в нем нет ошибок.
8.	Откройте файл WebRole1/Controllers/HomeController.cs.
9.	Добавьте следующий метод, чтобы позволить этому примеру приложения регистрировать код состояния HTTP 500 в качестве примера события журнала служб IIS (он будет использоваться в примере служб IIS ниже):

    ```
    public ActionResult StatusCode500()
        {
            throw new InvalidOperationException("Response.StatusCode is 500");
        }
    ```

10.	 Щелкните правой кнопкой мыши имя проекта облачной службы и выберите пункт **Опубликовать**.

#### Шаг 2. Подготовка файла конфигурации
Теперь мы подготовим файл конфигурации системы диагностики Azure, чтобы добавить события, которые могут помочь в обнаружении следующих ситуаций:

- добавление нового пользователя в локальную группу;
- создание нового процесса.

```
<?xml version="1.0" encoding="UTF-8"?>
<PublicConfig xmlns="http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration">
    <WadCfg>
        <DiagnosticMonitorConfiguration overallQuotaInMB="25000">
            <WindowsEventLog scheduledTransferPeriod="PT1M">
                <DataSource name="Security!*[System[(EventID=4732 or EventID=4733 or EventID=4688)]]" />
            </WindowsEventLog>
        </DiagnosticMonitorConfiguration>
    </WadCfg>
</PublicConfig>
```

#### Шаг 3. Проверка XML-файла конфигурации
Проверьте файл конфигурации, используя те же действия, что и в описанном выше [шаге 3 "Проверка XML-файла конфигурации"](#step3).
#### Шаг 4. Настройка системы диагностики Azure
Запустите следующий сценарий Azure PowerShell, чтобы включить систему диагностики Azure (обязательно обновите значения storage\_name, key, config\_path и service\_name).

    $storage_name = "<storage account name>"
    $key = " <storage key>"
    $config_path="<path to configuration XML file>"
    $service_name="<Cloud Service Name>"
    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key
    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name

Чтобы убедиться, что ваша служба использует актуальную конфигурацию диагностики, выполните следующую команду Azure PowerShell:

    Get-AzureServiceDiagnosticsExtension -ServiceName <ServiceName>

#### Шаг 5. Создание событий
Для создания событий выполните следующие действия.

1.	Чтобы запустить сеанс удаленного рабочего стола для связи с экземпляром облачной службы, откройте в Visual Studio обозреватель серверов, щелкните правой кнопкой мыши экземпляр роли и выберите пункт "Подключиться с помощью удаленного рабочего стола".
2.	Откройте окно командной строки с повышенными привилегиями и выполните следующие команды, чтобы создать учетную запись локального администратора на виртуальной машине:


    net user contosoadmin <enterpassword> /add net localgroup administrators contosoadmin /add

3.	Откройте окно просмотра событий, откройте канал **безопасности** и обратите внимание на то, что событие 4732 было создано, как показано ниже:

![][9]

#### Шаг 6. Просмотр данных
Подождите около пяти минут, чтобы позволить агенту системы диагностики Azure передавать события в таблицу хранилища.

![][10]

Для проверки события создания процесса откройте блокнот. Как показано здесь, событие создания процесса было зарегистрировано в канале безопасности.

![][11]

Теперь вы можете просмотреть то же событие в своей учетной записи хранения, как показано ниже:

![][12]

### Обновление существующего конвейера сбора журналов в облачной службе до новой конфигурации
В этом разделе мы обновляем существующий конвейер сбора журналов безопасности системы диагностики Azure и определяем наличие событий изменения брандмауэра Windows в экземпляре облачной службы.

Чтобы обнаружить изменения брандмауэра, мы обновляем существующую конфигурацию для включения событий изменения брандмауэра.

#### Шаг 1. Получение существующей конфигурации
>[AZURE.NOTE]Новые параметры конфигурации записываются поверх существующей конфигурации. Поэтому крайне важно, чтобы все существующие параметры конфигурации системы диагностики Azure были объединены с новым файлом конфигурации.

Для получения существующего параметра конфигурации можно использовать командлет **Get-AzureServiceDiagnosticsExtension**.

    Get-AzureServiceDiagnosticsExtension -ServiceName <ServiceName>

#### Шаг 2. Обновление XML-файла конфигурации для включения событий брандмауэра

    <?xml version="1.0" encoding="UTF-8"?>
    <PublicConfig xmlns="http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration">
    <WadCfg>
        <DiagnosticMonitorConfiguration overallQuotaInMB="25000">
        <WindowsEventLog scheduledTransferPeriod="PT1M">
            <DataSource name="Security!*[System[(EventID=4732 or EventID=4733 or EventID=4688)]]" />
            <DataSource name="Security!*[System[(EventID &gt;= 4944 and EventID &lt;= 4958)]]" />
        </WindowsEventLog>
        </DiagnosticMonitorConfiguration>
    </WadCfg>
    </PublicConfig>

Проверьте содержимое XML-файла, используя тот же процесс проверки, который был описан выше в [шаге 3 "Проверка XML-файла конфигурации"](#step3).

#### Шаг 3. Обновление системы диагностики Azure для использования новой конфигурации

Запустите следующий сценарий Azure PowerShell, чтобы обновить систему диагностики Azure для использования новой конфигурации (не забудьте обновить значения storage\_name, key, config\_path и service\_name с учетом сведений сведения об облачной службе).

    Remove-AzureServiceDiagnosticsExtension -ServiceName <ServiceName> -Role <RoleName>
    $storage_name = "<storage account name>"
    $key = " <storage key>"
    $config_path="<path to configuration XML file>"
    $service_name="<Cloud Service Name>"
    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key
    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name

Чтобы убедиться, что ваша служба использует актуальную конфигурацию диагностики, выполните следующую команду Azure PowerShell:

    Get-AzureServiceDiagnosticsExtension -ServiceName <ServiceName>

#### Шаг 4. Включение событий брандмауэра

1.	Откройте сеанс удаленного рабочего стола для связи с экземпляром облачной службы.
2.	Откройте командную строку с повышенными привилегиями и выполните следующую команду:

    ```
    auditpol.exe /set /category:"Policy Change" /subcategory:"MPSSVC rule-level Policy Change" /success:enable /failure:enable
    ```

#### Шаг 5. Создание событий

1.	Откройте брандмауэр Windows и щелкните **Правила для входящих подключений**.
2.	Щелкните элемент **Добавить новое правило**, а затем элемент **Порт**.
3.	В поле **Локальные порты** введите значение **5000**, а затем три раза нажмите кнопку **Далее**.
4.	В поле **Имя** введите значение **Test5000**, а затем нажмите кнопку **Готово**.
5.	Откройте окно просмотра событий, откройте канал **безопасности** и обратите внимание на то, что событие с кодом 4946 было создано, как показано ниже:

![][13]

#### Шаг 6. Просмотр данных
Подождите около пяти минут, чтобы позволить агенту системы диагностики Azure передавать данные событий в таблицу хранилища.

![][14]

### Распределение событий безопасности Windows и обнаружение пиковых значений
После добавления событий в пользовательскую учетную запись хранения приложения могут использовать клиентские библиотеки хранилища для доступа к событиям и выполнения их статистической обработки. Пример кода для доступа к данным таблицы см. в разделе [Практическое руководство. Извлечение данных таблицы](storage-dotnet-how-to-use-tables.md).

Ниже приведен пример статистической обработки событий. Все пиковые значения в распределении событий можно дополнительно проанализировать для выявления недопустимых операций.

![][15]

### Сбор и обработка журналов служб IIS с помощью HDInsight
В этом разделе мы выполняем сбор журналов служб IIS из экземпляра веб-роли и перемещаем их в BLOB-объект Azure в учетной записи хранения клиента.

#### Шаг 1. Обновление файла конфигурации для включения сбора журналов служб IIS

    <?xml version="1.0" encoding="UTF-8"?>
    <PublicConfig xmlns="http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration">
    <WadCfg>
        <DiagnosticMonitorConfiguration overallQuotaInMB="25000">
        <Directories scheduledTransferPeriod="PT5M">
        <IISLogs containerName="iislogs" />
        </Directories>
        <WindowsEventLog scheduledTransferPeriod="PT1M">
            <DataSource name="Security!*[System[(EventID=4732 or EventID=4733 or EventID=4688)]]" />
            <DataSource name="Security!*[System[(EventID &gt;= 4944 and EventID &lt;= 4958)]]" />
        </WindowsEventLog>
        </DiagnosticMonitorConfiguration>
    </WadCfg>
    </PublicConfig>

**containerName** в предыдущей конфигурации системы диагностики Azure представляет собой имя контейнера BLOB-объектов, в который перемещаются журналы в рамках учетной записи хранения клиента.

Проверьте файл конфигурации, используя те же действия, что и в описанном выше [шаге 3 "Проверка XML-файла конфигурации"](#step3).


#### Шаг 2. Обновление системы диагностики Azure для использования новой конфигурации
Запустите следующий сценарий Azure PowerShell, чтобы обновить систему диагностики Azure для использования новой конфигурации (не забудьте обновить значения storage\_name, key, config\_path и service\_name с учетом сведений сведения об облачной службе).

    Remove-AzureServiceDiagnosticsExtension -ServiceName <ServiceName> -Role <RoleName>
    $storage_name = "<storage account name>"
    $key = " <storage key>"
    $config_path="<path to configuration XML file>"
    $service_name="<Cloud Service Name>"
    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key
    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name

Чтобы убедиться, что ваша служба использует актуальную конфигурацию диагностики, выполните следующую команду Azure PowerShell:

    Get-AzureServiceDiagnosticsExtension -ServiceName <ServiceName>

#### Шаг 3. Создание журналов служб IIS

1.	Откройте браузер и перейдите к веб-роли облачной службы (например, http://contosowebrole.cloudapp.net/).
2.	Перейдите на страницы **О программе** и **Контакт**, чтобы создать несколько событий журналов.
3.	Перейдите на страницу, которая создает код состояния 500 (например, http://contosowebrole.cloudapp.net/Home/StatusCode500). Вы увидите ошибку, например, приведенную ниже. Помните, что в шаге 1 раздела "Настройка нового экземпляра конвейера сбора журналов в облачной службе" был добавлен код для **StatusCode500**. ![][16]
4.	Откройте сеанс удаленного рабочего стола для связи с экземпляром облачной службы.
5.	Откройте диспетчер служб IIS.
6.	Ведение журналов служб IIS включено по умолчанию и настроено на ежечасное создание файлов, содержащих все поля в формате W3C. Нажмите кнопку **Обзор**, при этом будет доступен хотя бы один файл журнала, как показано ниже: ![][17]

7.	Подождите около пяти минут, чтобы дать агенту системы диагностики Azure время для отправки файла журнала в контейнер BLOB-объектов. Для проверки данных откройте **Обозреватель серверов** > **Хранилище** > **Учетная запись хранения** > **Большие двоичные объекты**. Как показано здесь, создается BLOB-объект **iislogs**: ![][18]

8.	Щелкните правой кнопкой мыши и выберите пункт **Просмотреть контейнер больших двоичных объектов**, чтобы отобразить файл журнала служб IIS, хранимый в этом BLOB-объекте: ![][19]
9.	После добавления событий служб IIS в учетную запись хранения клиента приложения, в которых используется анализ HDInsight, можно применять для выполнения статистической обработки событий. Следующий график является примером задачи статистической обработки событий, показывающей код состояния HTTP 500: ![][20]

## Рекомендации по сбору журналов безопасности
При сборе журналов безопасности придерживайтесь следующих рекомендаций.

- Выполните сбор журналов событий аудита, относящихся к вашему приложению службы.
- Настройте только данные, необходимые для мониторинга и анализа. Захват слишком большого объема данных может усложнить устранение неполадок, а также привести к росту затрат на службу или хранилище.
- Объедините существующие параметры конфигурации системы диагностики Azure с внесенными изменениями. Файл новой конфигурации записывается поверх параметров существующей конфигурации.
- Соблюдайте осторожность при выборе **запланированного интервала передачи**. Меньший интервал передачи повышает релевантность данных, однако может увеличивать затраты на хранение и обработку.

>[AZURE.NOTE]Еще одной переменной, оказывающей существенное влияние на объем собираемых данных, является уровень ведения журнала. Ниже приведен пример того, как можно фильтровать журналы по уровню ведения журнала.

    System!*[System[(Level =2)]]

Уровень ведения журнала является совокупным значением. Если для фильтра задано значение **Предупреждение**, также осуществляется сбор событий **Ошибка** и **Критическое**.

- Периодически удаляйте диагностические данные из хранилища Azure, если они больше не нужны.

>[AZURE.NOTE]Дополнительные сведения о диагностических данных см в разделе [Хранение и просмотр диагностических данных в службе хранилища Azure](https://msdn.microsoft.com/library/azure/hh411534.aspx). Контейнеры и таблицы, в которых хранятся диагностические данные, не отличаются от других контейнеров и таблиц, а удаление из них BLOB-объектов и сущностей осуществляется по аналогии с другими данными. Диагностические данные можно удалить программным образом с помощью одной из клиентских библиотек хранилища либо визуально с помощью [клиента обозревателя хранилищ](http://blogs.msdn.com/b/windowsazurestorage/archive/2014/03/11/windows-azure-storage-explorers-2014.aspx).

- Рекомендуется хранить данные служб и данные журналов безопасности в отдельных учетных записях хранения. Такая изоляция позволяет исключить возможность влияния операции сохранения данных журнала безопасности на производительность хранилища при обработке данных рабочей службы.
- Выберите продолжительность хранения журналов, исходя из политики обеспечения соответствия в организации, а также требований к анализу данных и мониторингу.

## Экспорт журналов безопасности в другую систему
Вы можете скачать данные BLOB-объектов с помощью клиентской библиотеки службы хранилища Azure и экспортировать их в локальную систему для обработки. Пример кода для управления данными BLOB-объектов см. в разделе [Использование хранилища BLOB-объектов из .NET](storage-dotnet-how-to-use-blobs.md).

Аналогичным образом вы можете скачать данные безопасности, находящиеся в таблицах Azure, с помощью клиентской библиотеки службы хранилища Azure. Дополнительные сведения о доступе к данным, хранящимся в таблицах, см. в разделе [Использование табличного хранилища из .NET](storage-dotnet-how-to-use-tables.md).

## Отчеты Azure Active Directory
Azure Active Directory (Azure AD) включает в себя набор отчетов по журналам безопасности, использования и аудита, позволяющих получить представление о целостности и безопасности клиента Azure AD. Например, Azure AD позволяет автоматически анализировать активность пользователей и выявлять аномальные случаи доступа, а затем предоставить эти сведения в виде предназначенных для клиента отчетов.

Эти отчеты доступны на [портале управления Azure](https://manage.windowsazure.com/) в области **Active Directory** > **Каталог**. Некоторые из этих отчетов бесплатны, другие предоставляются в рамах выпуска Azure AD Premium. Дополнительные сведения об отчетах Azure AD см. в разделе [Просмотр отчетов о доступе и использовании](http://msdn.microsoft.com/library/azure/dn283934.aspx).

## Журналы операций Azure
Журналы операций, относящиеся к ресурсам подписки Azure, также доступны в компоненте **Журналы операций** на портале управления.

Для просмотра компонента **Журналы операций** откройте [портал управления Azure](https://manage.windowsazure.com/), щелкните элемент **Службы управления** и затем элемент **Журналы операций**.

## <a name="diagnostics"></a> Источники данных, поддерживаемые системой диагностики Azure

| Источник данных | Описание |
|----- | ----- |
| Журналы IIS | Информация о веб-сайтах служб IIS |
| Журналы инфраструктуры системы диагностики Azure | Информация о системе диагностики Azure |
| Журналы неудачно завершенных запросов IIS | Информация о неудачно завершенных запросах, отправленных на сайт или в приложение служб IIS |
| Журналы событий Windows | Информация, отправляемая системой ведения журналов событий Windows |
| Счетчики производительности | Системные и пользовательские счетчики производительности |
| Аварийные дампы | Информация о состоянии процесса в случае сбоя приложения |
| Пользовательские журналы ошибок | Журналы, созданные вашим приложением или службой |
| .NET EventSource | События, созданные вашим кодом с использованием класса EventSource .NET |
| Трассировка событий Windows на основе манифестов | События трассировки событий Windows, созданные любым процессом |

## Дополнительные ресурсы
Следующие ресурсы содержат общие сведения о среде Microsoft Azure и связанных с ней службах корпорации Майкрософт:

- [Центр управления безопасностью Microsoft Azure](http://azure.microsoft.com/support/trust-center/)

    Сведения о внедрении механизмов обеспечения безопасности и конфиденциальности в Azure и о том, как Azure удовлетворяет широкому спектру международных и отраслевых стандартов обеспечения соответствия.

- [Домашняя страница Microsoft Azure](http://www.microsoft.com/windowsazure/)

    Общие сведения и ссылки по Microsoft Azure.

- [Центр документации Microsoft Azure](http://msdn.microsoft.com/windowsazure/default.aspx)

    Рекомендации по службам Azure и сценариям автоматизации.

- [Центр Microsoft Security Response Center (MSRC)](http://www.microsoft.com/security/msrc/default.aspx)

    Центр MSRC сотрудничает с партнерами и специалистами по вопросам безопасности из разных стран для предотвращения угроз безопасности и совершенствования защиты продуктов корпорации Майкрософт.

- [Адрес электронной почты центра Microsoft Security Response Center](mailto:secure@microsoft.com)

    Адрес электронной почты, по которому можно сообщить об уязвимостях системы безопасности корпорации Майкрософт, включая Microsoft Azure.

<!--Image references-->
[1]: ./media/azure-security-audit-log-management/sec-security-data-collection-flow.png
[2]: ./media/azure-security-audit-log-management/sec-storage-table-security-log.PNG
[3]: ./media/azure-security-audit-log-management/sec-wad-windows-event-logs-table.png
[4]: ./media/azure-security-audit-log-management/sec-edit-entity.png
[5]: ./media/azure-security-audit-log-management/sec-app-event-log-cmd.png
[6]: ./media/azure-security-audit-log-management/sec-event-viewer.png
[7]: ./media/azure-security-audit-log-management/sec-event-id100.png
[8]: ./media/azure-security-audit-log-management/sec-diagnostics.png
[9]: ./media/azure-security-audit-log-management/sec-event4732.png
[10]: ./media/azure-security-audit-log-management/sec-step6.png
[11]: ./media/azure-security-audit-log-management/sec-process-creation-event.png
[12]: ./media/azure-security-audit-log-management/sec-process-creation-event-storage.png
[13]: ./media/azure-security-audit-log-management/sec-event4946.png
[14]: ./media/azure-security-audit-log-management/sec-event4946-storage.png
[15]: ./media/azure-security-audit-log-management/sec-event-aggregation.png
[16]: ./media/azure-security-audit-log-management/sec-status-code500.png
[17]: ./media/azure-security-audit-log-management/sec-w3c-format.png
[18]: ./media/azure-security-audit-log-management/sec-blob-iis-logs.png
[19]: ./media/azure-security-audit-log-management/sec-view-blob-container.png
[20]: ./media/azure-security-audit-log-management/sec-hdinsight-analysis.png

<!---HONumber=August15_HO8-->