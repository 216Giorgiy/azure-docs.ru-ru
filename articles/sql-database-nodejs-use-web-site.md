<properties linkid="develop-nodejs-tutorials-web-site-with-sql-database" urlDisplayName="Website with SQL Database" pageTitle="Node.js website with SQL Database - Azure tutorial" metaKeywords="" description="Learn how to create a Node.js website that accesses a SQL Database and is deployed to Azure" metaCanonical="" services="web-sites,sql-database" documentationCenter="nodejs" title="Node.js Web Application using the Azure SQL Database" authors="larryfr" solutions="" manager="" editor="" />

<tags ms.service="sql-database" ms.workload="data-management" ms.tgt_pltfrm="na" ms.devlang="nodejs" ms.topic="article" ms.date="01/01/1900" ms.author="larryfr" />

# Веб-приложение Node.js, использующее базу данных SQL Azure

В этом учебном курсе показано, как использовать базу данных SQL, предоставляемую службой управления данными Azure, для хранения данных и доступа к ним из приложения [node][node], размещенного в Azure. Этот учебный курс разработан для читателей, обладающих определенным опытом использования Node и [Git][Git].

Вы узнаете:

-   Как использовать портал управления Azure для создания веб-сайта Azure и базы данных SQL

-   Как использовать для установки модулей Node диспетчер npm (node package manager)

-   Как работать с базой данных SQL с помощью модуля node-sqlserver

-   Как использовать параметры приложения для указания значений времени выполнения для приложения

В ходе учебного курса вы создадите простое веб-приложение для управления задачами, позволяющее создавать, извлекать и выполнять задачи. Эти задачи хранятся в базе данных SQL.

Файлы проекта для этого учебного курса будут храниться в каталоге с именем **tasklist**, завершенное приложение будет выглядеть примерно следующим образом:

![Веб-страница, показывающая пустой список задач][Веб-страница, показывающая пустой список задач]

<div class="dev-callout">
<b>Примечание.</b>
<p>Применяемый в этом учебнике драйвер Microsoft для Node.JS для SQL Server в данный момент доступен в качестве предварительной версии и использует компоненты времени выполнения, доступные только в операционных системах Microsoft Windows и Azure.</p>
</div>

<div class="dev-callout">
<strong>Примечание.</strong>
<p>Этот учебный курс ссылается на папку <strong>tasklist</strong>. Полный путь к этой папке опущен, поскольку семантика путей зависит от операционной системы. Эту папку нужно создать в легкодоступном месте локальной файловой системы, например <strong>~/node/tasklist</strong> или <strong>c:\node\tasklist</strong></p>
</div>

<div class="dev-callout">
<strong>Примечание.</strong>
<p>Во многих действиях из описанных ниже упоминается использование командной строки. Для выполнения этих действий используйте командную строку своей операционной системы, например <strong>cmd.exe</strong> (Windows) или <strong>Bash</strong> (Unix Shell). На компьютерах с OS X доступ к командной строке можно получить через приложение Terminal.</p>
</div>

## Предварительные требования

Перед выполнением инструкций, приведенных в этой статье, следует убедиться, что установлены следующие компоненты:

-   [node][node] версии 0.6.14 или выше

-   [Git][Git]

-   Библиотеки Microsoft SQL Server Native Client — предоставляются в составе [пакета дополнительных компонентов Microsoft SQL Server 2012][пакета дополнительных компонентов Microsoft SQL Server 2012]

-   Текстовый редактор

-   Веб-браузер

<!--div chunk="../../Shared/Chunks/create-account-and-websites-note.md" /-->

## Создание веб-сайта с базой данных

Для создания веб-сайта Azure и базы данных SQL выполните следующие действия.

1.  Войдите на [портал управления Azure][портал управления Azure].
2.  Щелкните значок **+ Создать** в нижнем левом углу портала.

    ![Создание веб-сайта Azure][Создание веб-сайта Azure]

3.  Щелкните **ВЕБ-САЙТ**, затем **НАСТРАИВАЕМОЕ СОЗДАНИЕ**.

    ![Настраиваемое создание нового веб-сайта][Настраиваемое создание нового веб-сайта]

    Введите значение в поле **URL-адрес**, выберите **Создать новую базу данных MySQL** в раскрывающемся списке **БАЗА ДАННЫХ** и выберите центр обработки данных для вашего веб-сайта в раскрывающемся списке **РЕГИОН**. Щелкните стрелку в нижней части диалогового окна.

    ![Заполните сведения о веб-сайте][Заполните сведения о веб-сайте]

4.  Введите значение **ИМЯ** для вашей базы данных, выберите **ВЫПУСК** [(WEB или BUSINESS)][(WEB или BUSINESS)], выберите **МАКС. РАЗМЕР** для базы данных, укажите значение параметра **СОРТИРОВКА** и выберите **СОЗДАТЬ сервер базы данных SQL**. Щелкните стрелку в нижней части диалогового окна.

    ![Заполните параметры базы данных SQL][Заполните параметры базы данных SQL]

5.  Введите имя и пароль администратора (и подтвердите пароль), выберите регион, где будет создан новый сервер базы данных SQL, и установите флажок **Разрешить службам Azure доступ к серверу**.

    ![Создать новый сервер базы данных SQL][Создать новый сервер базы данных SQL]

    После создания веб-сайта вы увидите текст **Веб-сайт [SITENAME] успешно создан**. Теперь можно включить публикацию Git.

6.  В списке веб-сайтов щелкните имя веб-сайта, чтобы открыть панель мониторинга "Быстрый запуск" для этого веб-сайта.

    ![Откройте панель мониторинга веб-сайта][Откройте панель мониторинга веб-сайта]

7.  В нижней части страницы "Быстрый запуск" щелкните **Настроить публикацию Git**.

    ![Настроить публикацию Git][Настроить публикацию Git]

8.  Чтобы включить публикацию Git, необходимо предоставить имя пользователя и пароль. Запишите создаваемые имя пользователя и пароль. (Если ранее уже был настроен репозиторий Git, этот шаг будет пропущен.)

    ![Создание учетных данных для публикации][Создание учетных данных для публикации]

    На настройку репозитория уйдет несколько секунд.

9.  После настройки репозитория появятся инструкции для передачи ваших файлов приложений в репозиторий. Запишите эти инструкции — они потребуются позже.

    ![Инструкции для Git][Инструкции для Git]

## Получение сведений о подключении к базе данных SQL

Чтобы подключиться к экземпляру базы данных SQL, которая работает на веб-сайтах Azure, необходимы сведения о подключении. Чтобы получить сведения о подключении к базе данных SQL, выполните следующие действия:

1.  На портале управления Azure щелкните **СВЯЗАННЫЕ РЕСУРСЫ**, затем имя базы данных.

    ![Связанные ресурсы][Связанные ресурсы]

2.  Щелкните **Просмотреть строки подключения**.

    ![Строка подключения][Строка подключения]

3.  В разделе **ODBC** открывшегося диалогового окна сохраните строку подключения, так как она понадобится позже.

## Разработка таблицы задач

Чтобы создать таблицу базы данных, используемую для хранения элементов приложения списка задач, выполните следующие действия:

1.  На портале управления Windows Azure выберите свою базу данных SQL и щелкните по элементу **УПРАВЛЕНИЕ** в нижней части страницы. В случае появления сообщения о том, что текущий IP-адрес не является частью правил брандмауэра, нажмите кнопку **ОК** для добавления этого IP-адреса.

    ![кнопка управления][кнопка управления]

2.  Выполните вход с помощью имени и пароля, выбранных ранее при создании сервера базы данных.

    ![имя для управления базой данных][имя для управления базой данных]

3.  В левой нижней части страницы выберите **Разработка**, затем выберите **Создать таблицу**.

    ![Новая таблица][Новая таблица]

4.  Введите значение "tasks" для параметра **Имя таблицы** и установите флажок **Удостоверение** для столбца **ИД**.

    ![установка "tasks" в качестве имени таблицы и выбор удостоверения][установка "tasks" в качестве имени таблицы и выбор удостоверения]

5.  Измените значение **Столбец1** на **имя**, а **Столбец2** на **категория**. Добавьте два новых столбца, нажав кнопку **Добавить столбец**. Первый новый столбец должен иметь имя **created** и тип **date**. Второй новый столбец должен иметь имя **completed** и тип **bit**. Оба новых столбца должны быть помечены как **Обязательный**.

    ![структура готовой таблицы][структура готовой таблицы]

6.  Нажмите кнопку **Сохранить**, чтобы сохранить внесенные в таблицу изменения. Теперь можно закрыть страницу управления базой данных SQL.

## Установка модулей и создание шаблонов

В этом разделе вы создадите новое приложение Node и добавите пакеты модулей с помощью npm. Для приложения списка задач будут использованы модули [express][express] и [node-sqlserver][node-sqlserver]. Модуль Express предоставляет платформу Model View Controller (Контроллер представления модели) для Node, а модули node-sqlserver предоставляют возможность подключения к базе данных SQL Azure.

### Установка модуля Express и формирование шаблонов

1.  В командной строке измените каталоги на каталог **tasklist**. Если каталог **tasklist** не существует, создайте его.

2.  Введите следующую команду для установки Express.

        npm install express -g

    <div class="dev-callout">
<strong>Примечание.</strong>
<p>При использовании параметра -g в некоторых операционных системах может появиться сообщение об ошибке <strong>Ошибка: EPERM, chmod '/usr/local/bin/express'</strong> и предложение попробовать использовать учетную запись с правами администратора. В этом случае необходимо с помощью команды <strong>sudo</strong> запустить npm с более высоким уровнем привилегий.</p>
</div>

    Результат этой команды должен выглядеть аналогично следующему:

        express@2.5.9 /usr/local/lib/node_modules/express
        ├── mime@1.2.4
        ├── mkdirp@0.3.0
        ├── qs@0.4.2
        └── connect@1.8.7

    <div class="dev-callout">
<strong>Примечание.</strong>
<p>Параметр -g, используемый при установке модуля express, устанавливает его глобальным образом. Это делается для того, чтобы получить возможность доступа к команде <strong>express</strong> для формирования скаффолдинга веб-сайта без необходимости вводить дополнительные сведения о путях.</p>
</div>

3.  Для создания шаблонов, которые будут использоваться для данного приложения, используйте команду **express**:

        express

    Результат этой команды должен выглядеть аналогично следующему:

        create : .
        create : ./package.json
        create : ./app.js
        create : ./public
        create : ./public/javascripts
        create : ./public/images
        create : ./public/stylesheets
        create : ./public/stylesheets/style.css
        create : ./routes
        create : ./routes/index.js
        create : ./views
        create : ./views/layout.jade
        create : ./views/index.jade

        dont forget to install dependencies:
        $ cd . && npm install

    После выполнения этой команды в каталоге **tasklist** должно появиться несколько новых папок и файлов.

### Установка дополнительных модулей

1.  В командной строке измените каталоги на папку **tasklist** и введите следующую команду для установки модулей, описанных в файле **package.json**:

        npm install

    Результат этой команды должен выглядеть аналогично следующему:

        express@2.5.8 ./node_modules/express
        ├── mime@1.2.4
        ├── qs@0.4.2
        ├── mkdirp@0.3.0
        └── connect@1.8.7
        jade@0.26.0 ./node_modules/jade
        ├── commander@0.5.2
        └── mkdirp@0.3.0

    Будут установлены все стандартные модули, необходимые для Express.

2.  Далее используйте следующую команду для добавления модуля nconf. Этот модуль будет использоваться приложением для считывания строки подключения к базе данных из файла конфигурации.

    npm install nconf -save

3.  Далее загрузите двоичную версию драйвера Microsoft для Node.JS для SQL Server из [центра загрузки][центра загрузки].

4.  Извлеките архив в каталог **tasklist\\node\_modules**.

5.  Запустите файл **msnodesql-install.cmd** в каталоге **tasklist\\node\_modules**. При этом будет создан подкаталог **msnodesql** в каталоге **node\_modules** и файлы драйвера будут перемещены в эту новую структуру каталога.

6.  Удалите файл **msnodesql-install.cmd**, так как он больше не нужен.

## Использование базы данных SQL в приложении Node

В этом разделе вы расширите возможности созданного базового приложения с помощью команды **express**, изменив имеющийся файл **app.js** и создав новый файл **index.js** для использования созданной ранее базы данных.

### Изменение контроллера

1.  В каталоге **tasklist/routes** откройте файл **index.js** в текстовом редакторе.

2.  Замените существующий код в файле **index.js** следующим кодом. При этом загружаются модули msnodesql и nconf, затем nconf используется для загрузки строки подключения либо из переменной среды с именем **SQL\_CONN**, либо из значения **SQL\_CONN** в файле **config.json**.

        var sql = require('msnodesql')
            , nconf = require('nconf');

        nconf.env()
             .file({ file: 'config.json' });
        var conn = nconf.get("SQL_CONN");

3.  Продолжайте добавление к файлу **index.js**, добавив методы **index** и **updateItem**. Метод **index** возвращает все незавершенные задачи из базы данных, а метод **updateItem** отмечает выбранные задачи как завершенные.

        exports.index = function(req, res) {
            var select = "select * from tasks where completed = 0";
            sql.query(conn, select, function(err, items) {
                if(err)
                    throw err;
                res.render('index', { title: 'My ToDo List ', tasks: items });
            });
        };

        exports.updateItem = function(req, res) {
            var item = req.body.item;
            if(item) {
                var insert = "insert into tasks (name, category, created, completed) values (?, ?, GETDATE(), 0)";
                sql.query(conn, insert, [item.name, item.category], function(err) {
                    if(err)
                        throw err;
                    res.redirect('/');
                });
            } else {
                var completed = req.body.completed;
                if(!completed.forEach)
                    completed = [completed];
                var update = "update tasks set completed = 1 where id in (" + completed.join(",") + ")";
                sql.query(conn, update, function(err) {
                    if(err)
                        throw err;
                    res.redirect('/');
                });
            }
        }

4.  Сохраните файл **index.js**.

### Изменение app.js

1.  В каталоге **tasklist** откройте файл **app.js** в текстовом редакторе. Этот файл был создан ранее с помощью команды **express**.

2.  Прокрутите файл app.js вниз до появления следующего кода.

        app.configure('development', function(){
        app.use(express.errorHandler());
        });

3.  Теперь вставьте следующий код.

        app.get('/', routes.index);
        app.post('/', routes.updateItem);

 При этом в метод **updateItem**, который был ранее добавлен в файл **index.js**, добавляется новый маршрут.

1.  Сохраните файл **app.js**.

### Изменение представления индекса

1.  Измените каталоги на каталог **views** и откройте файл **index.jade** в текстовом редакторе.

2.  Заменит содержимое файла **index.jade** на код, приведенный ниже. Он определяет представление для отображения существующих задач, а также форму для добавления новых задач и пометки существующих задач как завершенных.

        h1= title
        br

        form(action="/", method="post")
          table(class="table table-striped table-bordered")
            thead
              tr
                td Name
                td Category
                td Date
                td Complete
            tbody
            each task in tasks
              tr
                td #{task.name}
                td #{task.category}
                td #{task.created}
                td
                  input(type="checkbox", name="completed", value="#{task.ID}", checked=task.completed == 1)
          button(type="submit", class="btn") Update tasks
        hr

        form(action="/", method="post", class="well")
          label Item Name:
          input(name="item[name]", type="textbox")
          label Item Category:
          input(name="item[category]", type="textbox")
          br
          button(type="submit", class="btn") Add Item

3.  Сохраните и закройте файл **index.jade**.

### Изменение глобального макета

Файл **layout.jade** в каталоге **views** используется как глобальный шаблон для других файлов **.jade**. На этом шаге он будет изменен для использования [Twitter Bootstrap][Twitter Bootstrap] — набора средств, упрощающих разработку привлекательного веб-сайта.

1.  Загрузите и извлеките файлы [Twitter Bootstrap][1]. Скопируйте файл **bootstrap.min.css** из папки **bootstrap\\css** в каталог **public\\stylesheets** своего приложения tasklist.

2.  В папке **views** откройте файл **layout.jade** в текстовом редакторе и замените его содержимое на следующее:

        !!!html
        html
          head
            title= title
            meta(http-equiv='X-UA-Compatible', content='IE=10')
            link(rel='stylesheet', href='/stylesheets/style.css')
            link(rel='stylesheet', href='/stylesheets/bootstrap.min.css')
          body(class='app')
            div(class='navbar navbar-fixed-top')
              .navbar-inner
                .container
                  a(class='brand', href='/') My Tasks
            .container!= body

3.  Сохраните файл **layout.jade**.

### Создание файла конфигурации

Файл **config.json** содержит строку подключения, используемую для подключения к базе данных SQL, и считывается файлом **index.js** во время выполнения. Чтобы создать этот файл, выполните следующие действия:

1.  В каталоге **tasklist** создайте новый файл с именем **config.json** и откройте его в текстовом редакторе.

2.  Содержание файла **config.json** должно быть похоже на следующее:

        {
          "SQL_CONN" : "connection_string"
        }

    Замените **connection\_string** на возвращенное ранее значение строки подключения ODBC.

3.  Сохраните файл.

## Локальный запуск приложения

Для проверки приложения на локальном компьютере выполните следующие действия:

1.  В командной строке измените каталоги на каталог **tasklist**.

2.  Используйте следующую команду для локального запуска приложения:

        node app.js

3.  Откройте веб-браузер и перейдите по адресу <http://127.0.0.1:3000>. Должна появиться веб-страница, похожая на следующую:

    ![Веб-страница, показывающая пустой список задач][2]

4.  Используйте предоставленные поля **Имя элемента** и **Категория элемента** для ввода данных, а затем нажмите **Добавить элемент**.

5.  Страница должна обновиться, и элемент отобразится в списке задач.

    ![Изображение нового элемента в списке задач][Изображение нового элемента в списке задач]

6.  Чтобы завершить задачу, просто установите флажок в столбце "Завершено" и нажмите кнопку **Обновить задачи**.

7.  Чтобы остановить процесс Node, перейдите в командную строку и нажмите сочетание клавиш **CTRL** и **C**.

## Развертывание приложения в Azure

В этом разделе, чтобы опубликовать приложение в Azure, вы предпримете шаги по развертыванию, доступные после создания веб-сайта.

### Публикация приложения

1.  В окне командной строки перейдите в каталог **tasklist**, если он не является текущим.

2.  Используйте следующие команды, чтобы инициализировать локальный репозиторий git для приложения, добавить в него файлы приложения и передать эти файлы в Azure.

        git init
        git add .
        git commit -m "adding files"
        git remote add azure [URL for remote repository]
        git push azure master

    В конце развертывания должно появиться заявление, похожее на следующее:

        To https://username@tabletasklist.azurewebsites.net/TableTasklist.git
         * [new branch]      master -> master

3.  После завершения операции передачи перейдите на страницу **http://[имя сайта].azurewebsites.net/**, чтобы просмотреть ваше приложение.

### Переключение на переменную среды

Ранее был реализован код, выполняющий поиск переменной среды **SQL\_CONN** для строки подключения или загружающий значение из файла **config.json**. При следующих действиях в конфигурации веб-сайта будет создана пара "ключ/значение", обеспечивающая реальный доступ к приложению с помощью переменной среды.

1.  На портале управления Azure щелкните **Веб-сайты**, затем выберите свой веб-сайт.

    ![Откройте панель мониторинга веб-сайта][Откройте панель мониторинга веб-сайта]

2.  Щелкните **НАСТРОЙКА** и найдите на странице раздел **параметры приложения**.

    ![ссылка настройки][ссылка настройки]

3.  В разделе **параметры приложения** введите **SQL\_CONN** в поле **КЛЮЧ**, затем введите строку подключения ODBC в поле **ЗНАЧЕНИЕ**. Наконец, установите флажок.

    ![параметры приложения][параметры приложения]

4.  И наконец, щелкните значок **СОХРАНИТЬ** в нижней части страницы, чтобы принять это изменение в среде выполнения.

    ![сохранение параметров приложения][сохранение параметров приложения]

5.  В командной строке измените каталоги на каталог **tasklist** и введите следующую команду для удаления файла **config.json**:

        git rm config.json
        git commit -m "Removing config file"

6.  Выполните следующую команду, чтобы развернуть изменения в Azure:

        git push azure master

После развертывания изменений в Azure веб-приложение должно продолжить работать, поскольку оно теперь считывает строку подключения из записи **параметры приложения**. Для проверки измените значение записи **SQL\_CONN** в записи **параметры приложения** на неправильное значение. После сохранения этого значения веб-сайт должен перестать работать из-за неправильного значения строки подключения.

## Дальнейшие действия

-   [Веб-приложение Node.js с MongoDB][Веб-приложение Node.js с MongoDB]
-   [Веб-приложение Node.js с табличным хранилищем]    

## Дополнительные ресурсы

[Средства командной строки Azure для Mac и Linux]    


  [Средства командной строки Azure для Mac и Linux]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/
  [node]: http://nodejs.org
  [Git]: http://git-scm.com
  [Веб-страница, показывающая пустой список задач]: ./media/sql-database-nodejs-use-web-site/sql_todo_final.png
  [пакета дополнительных компонентов Microsoft SQL Server 2012]: http://www.microsoft.com/ru-ru/download/details.aspx?id=29065
  [портал управления Azure]: https://manage.windowsazure.com/
  [Создание веб-сайта Azure]: ./media/sql-database-nodejs-use-web-site/new_website.jpg
  [Настраиваемое создание нового веб-сайта]: ./media/sql-database-nodejs-use-web-site/custom_create.png
  [Заполните сведения о веб-сайте]: ./media/sql-database-nodejs-use-web-site/website_details_sqlazure.jpg
  [(WEB или BUSINESS)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee621788.aspx
  [Заполните параметры базы данных SQL]: ./media/sql-database-nodejs-use-web-site/database_settings.jpg
  [Создать новый сервер базы данных SQL]: ./media/sql-database-nodejs-use-web-site/create_server.jpg
  [Откройте панель мониторинга веб-сайта]: ./media/sql-database-nodejs-use-web-site/go_to_dashboard.png
  [Настроить публикацию Git]: ./media/sql-database-nodejs-use-web-site/setup_git_publishing.png
  [Создание учетных данных для публикации]: ./media/sql-database-nodejs-use-web-site/git-deployment-credentials.png
  [Инструкции для Git]: ./media/sql-database-nodejs-use-web-site/git-instructions.png
  [Связанные ресурсы]: ./media/sql-database-nodejs-use-web-site/linked_resources.jpg
  [Строка подключения]: ./media/sql-database-nodejs-use-web-site/connection_string.jpg
  [кнопка управления]: ./media/sql-database-nodejs-use-web-site/sql-manage.png
  [имя для управления базой данных]: ./media/sql-database-nodejs-use-web-site/sqlazurelogin.png
  [Новая таблица]: ./media/sql-database-nodejs-use-web-site/new-table.png
  [установка "tasks" в качестве имени таблицы и выбор удостоверения]: ./media/sql-database-nodejs-use-web-site/table-name-identity.png
  [структура готовой таблицы]: ./media/sql-database-nodejs-use-web-site/table-columns.png
  [express]: http://expressjs.com
  [node-sqlserver]: https://github.com/WindowsAzure/node-sqlserver
  [центра загрузки]: http://www.microsoft.com/ru-ru/download/details.aspx?id=29995
  [Twitter Bootstrap]: https://github.com/twbs/bootstrap
  [1]: http://getbootstrap.com/
  [2]: ./media/sql-database-nodejs-use-web-site/sql_todo_empty.png
  [Изображение нового элемента в списке задач]: ./media/sql-database-nodejs-use-web-site/sql_todo_list.png
  [http://[имя]: http://[site
  [ссылка настройки]: ./media/sql-database-nodejs-use-web-site/sql-task-configure.png
  [параметры приложения]: ./media/sql-database-nodejs-use-web-site/appsettings.png
  [сохранение параметров приложения]: ./media/sql-database-nodejs-use-web-site/savebutton.png
  [Веб-приложение Node.js с MongoDB]: ../store-mongolab-web-sites-nodejs-store-data-mongodb/
  [Публикация на веб-сайтах Azure с использованием репозитория Git]: ../CommonTasks/publishing-with-git
  [Веб-приложение Node.js с табличным хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/