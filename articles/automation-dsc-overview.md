<properties 
   pageTitle="Обзор DSC службы автоматизации Azure" 
   description="Обзор DSC службы автоматизации Azure, условий использования и известных проблем" 
   services="automation" 
   documentationCenter="dev-center-name" 
   authors="coreyp-at-msft" 
   manager="stevenka" 
   editor="tysonn"/>

<tags
   ms.service="automation"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="powershell"
   ms.workload="TBD" 
   ms.date="05/04/2015"
   ms.author="coreyp"/>

# Обзор DSC службы автоматизации Azure #

>[AZURE.IMPORTANT]**Возможности DSC службы автоматизации Azure в настоящий момент ограничены предварительной версией**, и использование этого компонента не поддерживается для рабочих нагрузок. Сейчас он поддерживает только командлеты и не имеет графического пользовательского интерфейса. Регистрируясь для использования предварительной версии DSC службы автоматизации Azure, вы подтверждаете, что этот компонент находится на стадии предварительной версии и к нему применяются ограниченные или другие условия обслуживания, как указано в [соглашении на обслуживание](https://go.microsoft.com/fwLink/p/?LinkID=389530&clcid=0x409), и что вы соглашаетесь на [дополнительные условия использования предварительной версии](https://go.microsoft.com/fwLink/p/?LinkID=247638&clcid=0x409). Хотя сейчас служба может использоваться бесплатно, в будущем будут введены соответствующие расценки.

## Что такое PowerShell DSC? ##
Desired State Configuration (DSC) — это новая платформа управления в Windows PowerShell, позволяющая управлять настройкой физических узлов и виртуальных машин с помощью декларативного синтаксиса PowerShell.

DSC предоставляет набор расширений языка Windows PowerShell, новые командлеты Windows PowerShell и ресурсы, которые можно использовать, чтобы декларативно указать, как должна быть настроена программная среда. Эта платформа также предоставляет средства для обслуживания существующих конфигураций и управления ими.

### Практическое применение ###
Ниже приведены некоторые примеры сценариев, где можно использовать встроенные ресурсы DSC для автоматизированной настройки и управления набором компьютеров (также известных как целевые узлы):

- Включение или отключение ролей и компонентов сервера.
- Управление параметрами реестра.
- Управление файлами и каталогами.
- Запуск и остановка процессов и служб, а также управление ими.
- Управление группами и учетными записями пользователей.
- Развертывание нового программного обеспечения.
- Управление переменными среды.
- Выполнение сценариев Windows PowerShell.
- Исправление конфигурации, которая отклонилась от требуемого состояния.
- Обнаружение фактического состояния конфигурации на заданном узле.

Кроме того, вы можете создать настраиваемые ресурсы для настройки состояния любого параметра приложения или системы.


Дополнительная информация о PowerShell DSC: [Конфигурация в мире разработки и операций — Windows PowerShell DSC](http://blogs.msdn.com/b/powershell/archive/2013/11/01/configuration-in-a-devops-world-windows-powershell-desired-state-configuration.aspx).

##Что такое DSC службы автоматизации Azure?##
В основе DSC службы автоматизации Azure заложены основополагающие принципы, представленные в PowerShell DSC и призванные еще больше упростить управление конфигурацией. DSC службы автоматизации Azure обеспечивает тот же слой управления в [PowerShell DSC](https://technet.microsoft.com/library/dn249912.aspx) <link>, что и служба автоматизации Azure сегодня предлагает для сценариев PowerShell.

DSC службы автоматизации Azure позволяет [создавать конфигурации требуемого состояния PowerShell и управлять ими](https://technet.microsoft.com/library/dn249918.aspx), импортировать [ресурсы DSC](https://technet.microsoft.com/library/dn282125.aspx) и создавать конфигурации узлов DSC (документы MOF), и все это в облаке. Эти элементы DSC будут помещаться на [опрашивающий сервер DSC](https://technet.microsoft.com/library/dn249913.aspx) службы автоматизации Azure, чтобы целевые узлы (например, физические компьютеры и виртуальные машины) в облаке или локальной среде могли извлекать их, автоматически согласовывать с указанным требуемым состоянием и сообщать службе автоматизации Azure об их соответствии требуемому состоянию.

## Терминология DSC службы автоматизации Azure ##
### Конфигурация ###
В PowerShell DSC появилась новая концепция — конфигурации. Конфигурации позволяют с помощью синтаксиса PowerShell определить требуемое состояние среды. Чтобы использовать DSC для настройки среды, сначала определите блок сценария Windows PowerShell с помощью ключевого слова configuration, затем укажите идентификатор и фигурные скобки ({}) для отделения блока.

![замещающий текст](./media/automation-dsc-overview/AADSC_1.png)

Внутри блока конфигурации можно определить блоки конфигурации узлов, задающие требуемую конфигурацию для набора узлов (компьютеров) в вашей среде, которые должны быть настроены совершенно одинаково. Таким образом конфигурация узла представляет предполагаемую «роль» для одного или нескольких узлов. Блок конфигурации узла начинается с ключевого слова node. После него указывается ключевое слово с именем роли, которая может быть переменной. После имени компьютера добавьте фигурные скобки {}, чтобы отделить блок конфигурации узла.

![замещающий текст](./media/automation-dsc-overview/AADSC_2.png)
 
Внутри блока конфигурации узла можно определить блоки ресурсов для настройки определенных ресурсов DSC. Блок ресурсов начинается с имени ресурса, затем идет идентификатор, которым вы хотите обозначить этот блок, и фигурные скобки {}, отделяющие блок.

![замещающий текст](./media/automation-dsc-overview/AADSC_3.png)

Дополнительная информация о ключевом слове configuration: [Общие сведения о ключевом слове Configuration в конфигурации требуемого состояния](http://blogs.msdn.com/b/powershell/archive/2013/11/05/understanding-configuration-keyword-in-desired-state-configuration.aspx "Общие сведения о ключевом слове Configuration в конфигурации требуемого состояния").

Выполнение (компиляция) конфигурации DSC создаст одну или несколько конфигураций узлов DSC (документов MOF), соответствующих узлам DSC, которые должны соответствовать желаемому состоянию.

DSC службы автоматизации Azure позволяет импортировать, создавать и компилировать конфигурации DSC в службе автоматизации Azure точно так же, как можно в ней импортировать, создавать и запускать модули Runbook.

Сейчас DSC службы автоматизации Azure предоставляет в **модуле PowerShell диспетчера ресурсов Azure** следующие командлеты для управления конфигурациями DSC:

- `Get-AzureAutomationDscConfiguration`
- `Import-AzureAutomationDscConfiguration`

>[AZURE.IMPORTANT]Конфигурация должна содержать только один блок конфигурации с тем же именем, что и конфигурация в DSC службы автоматизации Azure.

###Конфигурация узла###

При компиляции конфигурации DSC, в зависимости от блоков Node в ней, создается одна или несколько конфигураций узла. Конфигурация узла — это то же самое, что «MOF» или «документ конфигурации» (если вы знакомы с этими терминами PS DSC). Она представляет собой «роль», например, веб-сервера или рабочего процесса, которая предполагается для требуемого состояния одного или нескольких узлов.

Чтобы сообщить узлам PS DSC о конфигурациях узлов, которые они должны выполнять, следует использовать метод push или pull DSC. DSC службы автоматизации Azure полагается на метод pull DSC. При этом узлы запрашивают нужные конфигурации узла с опрашивающих серверов DSC службы автоматизации Azure. Так как узлы делают запрос в DSC службы автоматизации Azure, они могут находиться за брандмауэрами, все их входящие порты могут быть закрыты и т. д. Им требуется только исходящий доступ к Интернету.

Сейчас DSC службы автоматизации Azure предоставляет в **модуле PowerShell диспетчера ресурсов Azure** следующие командлеты для управления конфигурациями узлов: `Get-AzureAutomationDscNodeConfiguration`


###Узел###

Узел DSC — это любой компьютер, конфигурацией которого управляет DSC. Это может быть виртуальная машина Azure, локальная виртуальная машина или физический узел. Узлы применяют конфигурации узлов, чтобы принять и сохранить соответствие требуемому состоянию, определяемому ими. Также они могут сообщать на сервер отчетов о своем состоянии конфигурации и его соответствии.

DSC службы автоматизации Azure упрощает адаптацию узлов для управления с помощью DSC службы автоматизации Azure и позволяет на стороне сервера изменять конфигурацию узла, назначенную каждому узлу. Таким образом, когда узел в следующий раз проверит инструкции на сервере, он примет другую роль и соответственно изменит свою конфигурацию. Узлы также сообщают о своем состояния и о том, соответствует ли их конфигурация DSC службы автоматизации Azure.

Сейчас DSC службы автоматизации Azure предоставляет в [модуле PowerShell диспетчера ресурсов Azure](powershell-azure-resource-manager.md) следующие командлеты для управления узлами DSC:

-	`Get-AzureAutomationDscNode`  
-	`Register-AzureAutomationDscNode` (используется для адаптации виртуальных машин Azure вер. 2 в качестве узлов).
-	`Get-AzureAutomationDscOnboardingMetaconfig` (используется для адаптации узлов).
-	`Set-AzureAutomationDscNode` (используется для задания или обновления сопоставлений узлов и конфигураций узлов).
-	`Unregister-AzureAutomationDscNode`
-	`Get-AzureAutomationDscNodeReport`
-	`Export-AzureAutomationDscNodeReportContent`

Командлет `Get-AzureAutomationRegistrationInfo` можно использовать для получения URL-адреса регистрации и ключа, необходимых для адаптации классических виртуальных машины Azure в учетную запись службы автоматизации Azure с помощью расширения для виртуальных машин DSC службы автоматизации Azure на портале Azure или с помощью PowerShell.


Расширение для виртуальных машин DSC службы автоматизации Azure.

![замещающий текст](./media/automation-dsc-overview/AADSC_4.png)


PowerShell —

    # fill in correct values for your VM / Automation Account here
    $VMName = ""
    $ServiceName = ""
    $AutomationAccountName = ""
    $AutomationAccountResourceGroup = ""


    # get Azure Automation DSC registration info
    Switch-AzureMode AzureResourceManager

    $Account = Get-AzureAutomationAccount -ResourceGroupName $AutomationAccountResourceGroup -Name $AutomationAccountName

    $RegistrationInfo = $Account | Get-AzureAutomationRegistrationInfo


    # use the DSC extension to onboard the VM for management with Azure Automation DSC
    Switch-AzureMode AzureServiceManagement

    $VM = Get-AzureVM -Name $VMName -ServiceName $ServiceName

    $PublicConfiguration = ConvertTo-Json -Depth 8 @{
        SasToken = ""
        ModulesUrl = "https://eus2oaasibizamarketprod1.blob.core.windows.net/automationdscpreview/RegistrationMetaConfig.zip"
        ConfigurationFunction = "RegistrationMetaConfig.ps1\RegistrationMetaConfig"

        # update these DSC agent configurations if these defaults are not what you want. 
        # See https://technet.microsoft.com/ru-ru/library/dn249922.aspx?f=255&MSPPError=-2147217396 for more details
        Properties = @{
            RegistrationKey = $RegistrationInfo.PrimaryKey
            RegistrationUrl = $RegistrationInfo.Endpoint
            NodeConfigurationName = "configname.webserver"
            ConfigurationMode = "ApplyAndMonitor"
            ConfigurationModeFrequencyMins = 15
            RefreshFrequencyMins = 30
           RebootNodeIfNeeded = $False
           ActionAfterReboot = "ContinueConfiguration"
           AllowModuleOverwrite = $False
        }
    } 

    $VM = Set-AzureVMExtension `
        -VM $vm `
        -Publisher Microsoft.Powershell `
        -ExtensionName DSC `
        -Version 1.9 `
        -PublicConfiguration $PublicConfiguration

    $VM | Update-AzureVM
 

###Ресурс###
Ресурсы DSC — это стандартные блоки, которые можно использовать для определения конфигурации требуемого состояния Windows PowerShell DSC. DSC поставляется с набором встроенных функций для настройки ресурсов, в том числе файлов и папок, компонентов и ролей сервера, параметров реестра, переменных среды, служб и процессов. Дополнительная информация о полном списке встроенных ресурсов DSC и их использовании: [Встроенные ресурсы Windows PowerShell DSC](https://technet.microsoft.com/library/dn249921.aspx).

Ресурсы DSC можно также импортировать как часть модулей PowerShell, чтобы расширить набор встроенных ресурсов DSC . Ресурсы, не используемые по умолчанию, будет получены узлами DSC с опрашивающего сервера DSC, если конфигурация узла содержит ссылки на эти ресурсы. Чтобы узнать, как создавать пользовательские ресурсы, см. также: [Создание пользовательских ресурсов Windows PowerShell DSC](https://technet.microsoft.com/library/dn249927.aspx).

DSC службы автоматизации Azure поставляется с теми же встроенными ресурсами DSC, что и PS DSC. Можно добавить дополнительные ресурсы в DSC службы автоматизации Azure, импортировав модули PowerShell, содержащие ресурсы, в службу автоматизации Azure.

Сейчас DSC службы автоматизации Azure предоставляет в [модуле PowerShell диспетчера ресурсов Azure](powershell-azure-resource-manager.md) следующие командлеты для управления узлами DSC:

- `New-AzureAutomationModule`
- `Remove-AzureAutomationModule`
- `Set-AzureAutomationModule`
- `Get-AzureAutomationModule`

###Задание компиляции###
Задание компиляции в DSC службы автоматизации Azure представляет собой экземпляр компиляции конфигурации, используемый для создания одной или нескольких конфигураций узлов. Эти задания аналогичны заданиям Runbook службы автоматизации Azure, за исключением того, что в действительности они не выполняют какие-либо задачи, кроме создания конфигураций узлов. Любые созданные заданием компиляции конфигурации узлов автоматически размещаются на опрашивающем сервере DSC службы автоматизации Azure и перезаписывают предыдущие версии конфигураций узлов, если они существовали для этой конфигурации. Имя конфигурации узла, производимой заданием компиляции, имеет вид «<Configuration-name>.<Node configuration-block-name>». Например, компиляция указанной ниже конфигурации приведет к созданию одной конфигурации узла — MyConfiguration.webserver.


![замещающий текст](./media/automation-dsc-overview/AADSC_5.png)


>[AZURE.NOTE]Как модули Runbook, конфигурации можно публиковать. Это не связано с помещением элементов DSC на опрашивающий сервер DSC службы автоматизации Azure. Задания компиляции помещают элементы DSC на опрашивающий сервер DSC службы автоматизации Azure. Дополнительная информация о «публикация» в службе автоматизации Azure: [Публикация Runbook](https://msdn.microsoft.com/library/dn903765.aspx).


Сейчас DSC службы автоматизации Azure предоставляет в [модуле PowerShell диспетчера ресурсов Azure](powershell-azure-resource-manager.md) следующие командлеты для управления заданиями компиляции:

-	`Get-AzureAutomationDscCompilationJob`
-	`Get-AzureAutomationDscCompilationJobOutput`
-	`Start-AzureAutomationDscCompilationJob`

##Подводные камни и известные проблемы##

- Так как  DSC службы автоматизации Azure находится на стадии предварительной версии, при первом использовании этого компонента необходимо зарегистрироваться с помощью командлетов Azure PowerShell. Вы можете зарегистрироваться, вызвав два следующих командлета:

 - `Register-AzureProvider –ProviderNamespace Microsoft.Automation`
 - `Register-AzureProviderFeature -FeatureName dsc -ProviderNamespace Microsoft.Automation` 
 
>[AZURE.NOTE]Регистрация DSC службы автоматизации Azure может длиться до часа, после чего компонент станет доступным для использования.

- Сейчас DSC службы автоматизации Azure не поддерживает частичные или составные конфигурации DSC.

- Должна быть установлена последняя версия WMF 5, чтобы агент PowerShell DSC для Windows имел возможность обмениваться данными со службой автоматизации Azure. Агент PowerShell DSC для Linux в настоящее время не поддерживает обмен данными со службой автоматизации Azure. Скоро это должно быть изменено.

- Служба автоматизации Azure не поддерживает параллельное использование модулей PowerShell. Это значит, все конфигурации в учетной записи службы автоматизации должны работать с последней версией модуля PowerShell, импортированной в эту учетную запись, и с любыми ресурсами PowerShell DSC в этом модуле, которые используются в конфигурации.

- Традиционный опрашивающий сервер PowerShell DSC ожидает, что ZIP-файлы модуля размещаются на опрашивающем сервере в формате **ИмяМодуля_Версия.zip**. Служба автоматизации Azure ожидает, что модули PowerShell импортируются с именами в виде **ИмяМодуля.zip**. В [этой записи блога](http://azure.microsoft.com/blog/2014/12/15/authoring-integration-modules-for-azure-automation/) можно подробнее узнать о формате модуля интеграции, необходимом для импорта модуля в службу автоматизации Azure.

- Модули PowerShell, одновременно указывающие ресурсы DSC внутри модуля в формате «отдельная папка для каждой версии», сейчас не будут работать в службе автоматизации Azure.

- При импорте модулей PowerShell в службу автоматизации Azure с помощью  командлета `New-AzureAutomationModule` или `Set-AzureAutomationModule` импорт модулей осуществляется асинхронно. Даже если выполнение командлета завершено успешно, это не означает, что успешно завершен импорт модуля. Чтобы проверить успешность импорта, воспользуйтесь `Get-AzureAutomationModule –Name <ModuleName>` (обязательно укажите только проверяемый модуль, а не все модули) и убедитесь, что в поле **ProvisioningState** модуля указано успешное выполнение.

- Модули PowerShell, импортированные в службу автоматизации Azure, не могут содержать DOC- или DOCX-файлы. Некоторые модули PowerShell, содержащий ресурсы DSC, содержат эти файлы в справочных целях. Эти файлы надо удалить из модулей, прежде чем импортировать их в службу автоматизации Azure.

- Сейчас конфигурации в службе автоматизации Azure для значений параметров поддерживают только строки. Если вы хотите передать для значения параметра что-то, отличное от строки, передайте значение параметра как строку JSON, а в конфигурации используйте ConvertFrom-Json, чтобы преобразовать строку JSON обратно в нестроковое значение.

- При первоначальной регистрации узла в учетной записи службы автоматизации Azure или изменении узла для сопоставления с другой конфигурацией узла на стороне сервера его состояние будет соответствовать требуемой конфигурации, даже если оно фактически не соответствует конфигурации узла, с которой он сейчас сопоставлен. После того, как узел отправит свой первый отчет после регистрации или изменения сопоставления конфигурации узла, состояние узла можно будет считать надежным.

- Если при адаптации виртуальной машины Azure для управления через DSC автоматизации Azure с помощью `Register-AzureAutomationDscNode`, `Set-AzureAutomationDscExtension` или расширения для виртуальных машин DSC службы автоматизации Azure на портале предварительной версии Azure происходит сбой регистрации с сообщением **Имя компьютера не задано, и в каталоге конфигурации нет файлов конфигурации**, это ложный сигнал, и регистрация виртуальной машины в действительности выполнена успешно. Успешную регистрацию можно проверить с помощью командлета `Get-AzureAutomationDscNode`.

<!---HONumber=58-->