<properties title="Consistency levels in DocumentDB" pageTitle="Consistency levels in DocumentDB" description="DocumentDB has four consistency levels with associated performance levels to help application developers make predictable consistency-availability-latency trade-offs." metaKeywords="Optional" services="documentdb" solutions="data-management" authors="bradsev" " manager="jhubbard" editor="cgronlun" videoId="Optional" scriptId="Optional" />

<tags ms.service="documentdb" ms.workload="data-services" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="08/20/2014" ms.author="bradsev" />

 # Уровни согласованности в DocumentDB 
Разработчики часто сталкиваются с проблемой выбора между двумя крайностями согласованности, сильной и согласованностью в конечном счете. Реальность такова, что существуют еще несколько уровней согласованности между этими двумя крайностями. В большинстве реальных сценариев, приложения выигрывают от создания точных компромиссов между согласованностью, доступностью и временем ожидания. DocumentDB предлагает четыре четко определенных уровня согласованности с соответствующими уровнями производительности. Это позволяет разработчикам приложений сделать предсказуемый компромисс между согласованностью, доступностью и временем ожидания.

Все системные ресурсы, в том числе учетные записи баз данных, базы данных, коллекции, пользователи и разрешениям всегда сильно согласованы при чтении и для запросов. Уровни согласованности применяются только к определяемым пользователем ресурсам. Для запросов и операций чтения на заданных пользователем ресурсах, в том числе документах, вложениях, хранимых процедурах, триггерах и пользовательских функциях, DocumentDB предлагает четыре различных уровня согласованности: Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете). Эти разделенные, четко определенные уровни согласованности позволяют принимать обоснованные компромиссы между показателями согласованности, доступности и производительности. Эти уровни согласованности подкреплены предсказуемыми уровнями производительности, обеспечивающих получение устойчивых результатов для вашего приложения.

 ## Уровни согласованности 
Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (через все базы данных) под вашей учетной записи базы данных. По умолчанию все операции чтения и запросов к определенным пользователем ресурсам будут использовать уровень согласованности по умолчанию, заданный в учетной записи базы данных. Однако вы можете понизить уровень согласованности для конкретного запроса чтения/запроса, указав заголовок запроса [x-ms-consistency-level]. Есть четыре типа уровней согласованности, поддерживаемых протоколом репликации DocumentDB, они кратко описаны ниже.

 >[AZURE.NOTE] В следующих версиях мы намерены внедрить поддержку переопределения уровня согласованности по умолчанию для каждой коллекции.

 **Уровень согласованности Strong (сильная):** Сильный уровень согласованности гарантирует, что операция записи отображается только после ее завершения большинством необходимого набора реплик. Запись либо синхронно завершается первичной и необходимым набором вторичных реплик, либо прерывается. Операция чтения всегда признается большинством необходимого набора чтения, клиент никогда не сможет увидеть незафиксированную или частичную запись и всегда гарантированно получит последние записанные данные.

Сильный уровень согласованности обеспечивает абсолютную гарантию согласованности данных, но предлагает самый низкий уровень производительности операций чтения и записи.

**Уровень Bounded Staleness (ограниченная согласованность с запаздыванием)**: Ограниченная согласованность с запаздыванием гарантирует общий порядок распространения операций записи, при чтении возможно возникновение задержек от записи не более чем на К префиксов. Чтение всегда признается большинством необходимого набора реплик. Ответ на запрос чтения определяет ее относительную "свежесть" (в пересчете на К).

Ограниченная согласованность с запаздыванием обеспечивает более предсказуемое поведение согласованности чтения, предлагая самые низкие задержки для записи. Так как операции чтения признаны большинством из необходимого набора реплик, время задержки чтения не хуже, чем самое низкое время, предлагаемое системой.

**Уровень согласованности Session (сеанс)**: В отличие от глобальных моделей согласованности, предлагаемых сильной и ограниченной согласованностью, уровень "сеанса" подходит специально для конкретного сеанса клиента. Согласованности на уровне сеанса, как правило, достаточно, так как это обеспечивает гарантированное монотонные операции чтения и записи данных, способность читать свои собственные записи. Запрос чтения для согласованности на уровне сеанса формируется для реплик, которые могут обслужить запрошенную клиентом версию (является частью файла cookie сеанса).

Сеанс предоставляет предсказуемую согласованность чтения данных для сеанса, предлагая самые низкие задержки при записи. Чтение также имеет низкое время ожидания, за исключением редких случаев, операции чтения будут обслуживаться одной репликой.

**Уровень согласованности Eventual (в конечном счете)**: Согласованность в конечном счете является самой слабой формой согласованности, в котором клиент может получить значения, которые являются более старыми по отношению к полученным ранее, в течение времени. В отсутствие любых последующих операций записи, реплики в группе, в конечном счете сходятся. Запрос на чтение обслуживается любой вторичной репликой.

Согласованность в конечном счете оказывается самой слабо связанной согласованностью чтения, но предлагает наименьшую задержку как для чтения, так и для записи.

## Query Consistency 
По умолчанию для пользовательских ресурсов, уровень согласованности для запросов совпадает с уровнем согласованности для операций чтения. По умолчанию, индекс обновляется синхронно при каждой операции вставки, заменить или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как DocumentDB оптимизирован для операций записи и поддерживает устойчивые объемы записей документов вместе с синхронным обслуживанием индекса и обслуживанием согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления своих ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших коллекций.
<table> <thead> <tr class="header"> <th align="left">Режим индексирования</th> <th align="left">Операции чтения</th> <th align="left">Запросы</th> </tr> </thead> <tbody> <tr class="odd"> <td align="left">Режим согласованности (по умолчанию)</td> <td align="left">Выбор из Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете)</td> <td align="left">Выбор из Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете)</td> </tr> <tr class="even"> <td align="left">Отложенная</td> <td align="left">Выбор из Strong, Bounded Staleness, Session или Eventual</td> <td align="left">В конечном счете</td> </tr> </tbody> </table> <p\>Как и для запросов на чтение, можно снизить уровень согласованности конкретного запроса, задав заголовок запроса [x-ms-consistency-level].</p> <h2 id="references">Ссылки</h2> <ul> <li>Дог Тэрри (Doug Terry). Объяснение согласованности при репликации данных на примере игры в бейсбол (Replicated Data Consistency explained through baseball).<br /><a href="http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf"><a href="http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf" class="uri">http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf</a></a></li> <li\>Дог Тэрри (Doug Terry). Гарантии на уровне сеанса для слабо согласованных реплицируемых данных (Session Guarantees for Weakly Consistent Replicated Data).<br /><a href="http://www2.parc.com/csl/projects/bayou/pubs/sg-pdis-94/www/SessionGuaranteesPDIS\_1.html"\><a href="http://www2.parc.com/csl/projects/bayou/pubs/sg-pdis-94/www/SessionGuaranteesPDIS\_1.html" class="uri"\>http://www2.parc.com/csl/projects/bayou/pubs/sg-pdis-94/www/SessionGuaranteesPDIS\_1.html\</a></a></li> <li>Дэниел Абади (Daniel Abadi). Компромиссы согласованности в современных распределенных системах проектирования баз данных: Теорема CAP, это только начало...” (Consistency Tradeoffs in Modern Distributed Database Systems Design:CAP is only part of the story).<br /><a href="http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html"><a href="http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html" class="uri">http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html</a></a></li> <li>Питер Бейлис, Шиварам Венкатараман, Майкл Дж. Франклин, Джозеф М. Хеллерштейн, Ион Стойка. (Peter Bailis, Shivaram Venkataraman, Michael J. Franklin, Joseph M. Hellerstein, Ion Stoica). Вероятностное ограниченное запаздывание (PBS) для практических неполных кворумов. (Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums.)<br /><a href="http://vldb.org/pvldb/vol5/p776\_peterbailis\_vldb2012.pdf"><a href="http://vldb.org/pvldb/vol5/p776\_peterbailis\_vldb2012.pdf" class="uri"\>http://vldb.org/pvldb/vol5/p776\_peterbailis\_vldb2012.pdf\</a></a></li> <li>Вернер Вогелис (Werner Vogels). Возвращаясь к вопросу о согласованности в конечном счете. (Eventual Consistent - Revisited.)<br /><a href="http://allthingsdistributed.com/2008/12/eventually\_consistent.html"><a href="http://allthingsdistributed.com/2008/12/eventually\_consistent.html" class="uri">http://allthingsdistributed.com/2008/12/eventually\_consistent.html\</a></a></li> </ul>
