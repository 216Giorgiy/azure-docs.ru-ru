<properties linkid="dev-nodejs-how-to-service-bus-queues" urlDisplayName="Служба очередей" pageTitle="Использование службы очередей (Node.js) | Microsoft Azure" metaKeywords="Служба очередей Azure получает сообщения Node.js" description="Узнайте, как использовать службу очередей Azure для создания и удаления очередей, а также для вставки, получения и удаления сообщений. Примеры кода написаны на Node.js." metaCanonical="" services="storage" documentationCenter="Node.js" title="Использование службы очередей в Node.js" authors="" solutions="" manager="" editor="" />





# Использование службы очередей в Node.js

В этом руководстве показано, как реализовать типичные сценарии с использованием службы очередей Azure. Примеры написаны с помощью Node.js
API. Здесь описаны такие сценарии, как **вставка**, **просмотр**,
**получение** и **удаление** сообщений очереди, а также **создание и
удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия][].

## Оглавление

* [Что такое служба очередей][]   
* [Основные понятия][]   
* [Создание учетной записи хранения Azure][]   
* [Создание приложения Node.js][]   
* [Настройка приложения для доступа к хранилищу][]   
* [Настройка строки подключения к хранилищу Azure][]   
* [Практическое руководство. Создание очереди][]   
* [Практическое руководство. Вставка сообщения в очередь][]   
* [Практическое руководство. Просмотр следующего сообщения][]   
* [Практическое руководство. Удаление следующего сообщения из очереди][]   
* [Практическое руководство. Изменение содержимого сообщения в очереди][]   
* [Практическое руководство. Использование дополнительных параметров для удаления сообщений из очереди][]   
* [Практическое руководство. Получение длины очереди][]   
* [Практическое руководство. Удаление очереди][]   
* [Дальнейшие действия][]

## <a name="what-is"> </a>Что такое служба очередей

Служба очередей Azure — это служба хранения большого количества
сообщений, к которым можно получить доступ практически из любой точки мира с помощью вызовов
с проверкой подлинности по протоколу HTTP или HTTPS. Одно сообщение очереди может быть
размером до 64 КБ, а очередь может содержать миллионы сообщений до общего
ограничения емкости учетной записи хранилища, равного 100 ТБ. Наиболее частые способы
использования службы очередей включают:

-   <span>Создание списка невыполненных работ для асинхронной обработки</span>
-   Передача сообщений из веб-роли Azure в рабочую роль

## <a name="concepts"> </a>Основные понятия

Служба очереди содержит следующие компоненты:

![Queue1][Queue1]

-   **Формат URL-адреса.** К очередям можно обратиться, используя следующий формат
    URL-адреса:   
    
		http://storageaccount.queue.core.windows.net/queue  
      
    Следующий URL-адрес позволяет обратиться к одной из очередей на схеме:  
    
		http://myaccount.queue.core.windows.net/imagesToDownload

-   **Учетная запись хранилища.** Весь доступ к хранилищу 
    Azure осуществляется с помощью учетной записи хранения. Учетная запись хранения представляет собой самый высокий уровень
    пространства имен для доступа к очередям. Общий размер BLOB-объекта, таблицы
    и содержимого очереди в учетной записи хранения не может превышать 100 ТБ.

-   **Очередь.** Очередь содержит набор сообщений. Все сообщения должны находиться
    в очереди.

-   **Сообщение.** Сообщения в любом формате размером до 64 КБ.

## <a name="create-account"> </a>Создание учетной записи хранения Azure

Для выполнения операций хранилища необходимо использовать учетную запись хранения Azure. Выполнив
следующие шаги, вы создадите учетную запись хранения. (Можно также
создать учетную запись хранения [с помощью интерфейса API REST][].)

1.  Выполните вход на [портал управления Azure].

2.  В нижней части области навигации щелкните **+СОЗДАТЬ**.

	![+Создать][plus-new]

3.  Щелкните **Учетная запись хранения**, а затем **Быстрое создание**.

	![Диалоговое окно "Быстрое создание"][quick-create-storage]

4.  В поле URL-адреса введите имя дочернего домена для использования URI для
    учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это значение становится именем узла в URI, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.

5.  Выберите регион или территориальную группу, где требуется расположить
    хранилище. При использовании хранилища в приложении Azure
    выберите область, в которой будет разворачиваться
    приложение.

6.  Щелкните **Создать учетную запись хранения**.

## <a name="create-app"> </a>Создание приложения Node.js

Создайте пустое приложение Node.js. Инструкции по созданию приложения Node.js см. в статьях [Создание и развертывание приложения Node.js на веб-сайте Azure], [Облачная служба Node.js] (с помощью Windows PowerShell) или [Веб-сайт с WebMatrix].

## <a name="configure-access"> </a>Настройка приложения для доступа к хранилищу

Для использования хранилища Azure необходимо загрузить и использовать пакет Node.js Azure,
который содержит набор библиотек, взаимодействующих
со службами REST хранилища.

### Использование диспетчера пакета Node (NPM) для получения пакета

1.  Используя интерфейс командной строки, такой как **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix), перейдите в папку, в которой создан пример приложения.

2.  Введите в командной строке **npm install azure**, что должно привести к следующему результату:

        azure@0.7.5 node_modules\azure
		|-- dateformat@1.0.2-1.2.3
		|-- xmlbuilder@0.4.2
		|-- node-uuid@1.2.0
		|-- mime@1.2.9
		|-- underscore@1.4.4
		|-- validator@1.1.1
		|-- tunnel@0.0.2
		|-- wns@0.5.3
		|-- xml2js@0.2.7 (sax@0.5.2)
		|-- request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)

3.  Можно вручную выполнить команду **ls**, чтобы убедиться в создании папки
    **node\_modules**. В этой папке находится
    пакет **azure**, содержащий библиотеки, необходимые для
    доступа к хранилищу.

### Импорт пакета

С помощью программы Блокнот или другого текстового редактора добавьте следующее в начало
файла **Server.js** приложения, где планируется использовать хранилище:

    var azure = require('azure');

## <a name="setup-connection-string"> </a>Настройка подключения к хранилищу Azure

Модуль Azure считывает переменные среды AZURE\_STORAGE\_ACCOUNT и AZURE\_STORAGE\_ACCESS\_KEY для получения сведений, необходимых для подключения к учетной записи хранения Azure. Если эти переменные среды не заданы, при вызове **createQueueService** необходимо указать сведения об учетной записи.

Пример настройки переменных среды в файле конфигурации для облачной службы Azure см. в статье [Облачная служба Node.js с хранилищем].

Пример настройки переменных среды на портале управления для веб-сайта Azure см. в статье [Веб-приложение Node.js с хранилищем]

## <a name="create-queue"> </a>Практическое руководство. Создание очереди

Следующий пример кода создает объект **QueueService**, который позволяет работать с очередями.

    var queueService = azure.createQueueService();

Используйте метод **createQueueIfNotExists**, который возвращает
указанную очередь, если она уже существует, или создает новую
очередь с указанным именем, если она отсутствует.

	queueService.createQueueIfNotExists(queueName, function(error){
    	if(!error){
        	// Queue exists
	    }
	});

###Фильтры

Дополнительные операции фильтрации можно применить к выполняемым операциям, используя **QueueService**. К операциям фильтрации могут относиться ведение журнала, автоматически повтор и т. д. Фильтры являются объектами, реализующими метод со следующей сигнатурой:

		дескриптор функции (requestOptions, next)

Выполнив предварительную обработку параметров запроса, метод должен вызвать "next", передавая обратный вызов со следующей сигнатурой:

		функция (returnObject, finalCallback, next)

В этой функции обратного вызова и после обработки returnObject (ответ на запрос к серверу) функция обратного вызова должна либо вызвать "next", если он существует, чтобы продолжить обработку других фильтров, либо в противном случае просто вызвать "finalCallback" для завершения обращения к службе.

В Azure SDK для Node.js включены два фильтра, реализующие логику повторных попыток: **ExponentialRetryPolicyFilter** и **LinearRetryPolicyFilter** Следующий код создает объект **QueueService**, использующий **ExponentialRetryPolicyFilter**:

	var retryOperations = new azure.ExponentialRetryPolicyFilter();
	var queueService = azure.createQueueService().withFilter(retryOperations);

## <a name="insert-message"> </a>Практическое руководство. Вставка сообщения в очередь

Чтобы вставить сообщение в очередь, используйте метод **createMessage** для создания нового сообщения и добавления его в очередь.

	queueService.createMessage(queueName, "Hello world!", function(error){
	    if(!error){
	        // Message inserted
	    }
	});


## <a name="peek-message"> </a>Практическое руководство. Просмотр следующего сообщения

Вы можете просмотреть сообщение в начале очереди, не удаляя его из очереди, вызвав метод **peekMessages**. По умолчанию
**peekMessages** просматривает одно сообщение.

	queueService.peekMessages(queueName, function(error, messages){
		if(!error){
			// Messages peeked
			// Text is available in messages[0].messagetext
		}
	});


> [WACOM.NOTE] 
> Если использовать <strong>peekMessage</strong>, когда в очереди нет сообщений, сообщение об ошибке не отображается, однако сообщения не возвращаются.

## <a name="get-message"> </a>Практическое руководство. Удаление следующего сообщения из очереди

Ваш код удаляет сообщение из очереди в два этапа. При вызове
**getMessages** по умолчанию вы получаете следующее сообщение в очереди. Сообщения,
возвращаемые методом **getMessages**, становятся невидимыми для другого
кода, читающего сообщения из этой очереди. По умолчанию это сообщение остается
невидимым в течение 30 секунд. Чтобы завершить удаление сообщения из очереди,
необходимо вызвать метод **deleteMessage**. Этот двухэтапный процесс удаления
сообщения позволяет удостовериться, что если коду не удастся обработать сообщение из-за сбоя оборудования
или программного обеспечения, другой экземпляр кода сможет получить то же
сообщение и повторить попытку. Код вызывает метод **deleteMessage** сразу
после обработки сообщения.

	queueService.getMessages(queueName, function(error, messages){
	    if(!error){
	        // Process the message in less than 30 seconds, the message
	        // text is available in messages[0].messagetext 
			var message = messages[0]
	        queueService.deleteMessage(queueName
				, message.messageid
				, message.popreceipt
				, function(error){
	            	if(!error){
	                	// Message deleted
	            	}
	        	});
	    }
	});

> [WACOM.NOTE]
> Если использовать <b>getMessages</b>, когда в очереди нет сообщений, сообщение об ошибке не отображается, однако сообщения не возвращаются.

## <a name="change-contents"> </a>Практическое руководство. Изменение содержимого сообщения в очереди

Вы можете изменить содержимое сообщения непосредственно в очереди. Если сообщение представляет собой рабочую задачу, можно использовать эту функцию для обновления состояния рабочей задачи. Приведенный ниже код использует метод **updateMessage**,
чтобы обновить сообщение.

    queueService.getMessages(queueName, function(error, messages){
		if(!error){
			// Got the message
			var message = messages[0];
			queueService.updateMessage(queueName
				, message.messageid
				, message.popreceipt
				, 10
				, { messagetext: 'in your message, doing stuff.' }
				, function(error){
					if(!error){
						// Message updated successfully
					}
				});
		}
	});

## <a name="advanced-get"> </a>Практическое руководство. Использование дополнительных параметров для удаления сообщений из очереди

Способ извлечения сообщения из очереди можно настроить двумя способами.
Во-первых, можно получить пакет сообщений (до 32 сообщений). Во-вторых, можно задать более длительное или короткое время ожидания невидимости, чтобы предоставить коду больше или меньше времени на полную обработку каждого сообщения. В следующем примере кода метод
**getMessages** используется для получения 15 сообщений в одном вызове. Затем он обрабатывает
каждое сообщение с помощью цикла for. Он также задает время ожидания невидимости
5 минут для каждого сообщения.

    queueService.getMessages(queueName
		, {numofmessages: 15, visibilitytimeout: 5 * 60}
		, function(error, messages){
		if(!error){
			// Messages retreived
			for(var index in messages){
				// text is available in messages[index].messagetext
				var message = messages[index];
				queueService.deleteMessage(queueName
					, message.messageid
					, message.popreceipt
					, function(error){
						if(!error){
							// Message deleted
						}
					});
			}
		}
	});

## <a name="get-queue-length"> </a>Практическое руководство. Получение длины очереди

Вы можете узнать приблизительное количество сообщений в очереди. Метод
**getQueueMetadata** отправляет в службу очередей запрос на возврат метаданных
об очереди, а свойство **approximatemessagecount** ответа содержит
количество сообщений в очереди. Счетчик указывает
число лишь приблизительно, так как сообщения могут добавляться или
удаляться после ответа службы очередей на ваш запрос.

    queueService.getQueueMetadata(queueName, function(error, queueInfo){
		if(!error){
			// Queue length is available in queueInfo.approximatemessagecount
		}
	});

## <a name="delete-queue"> </a>Практическое руководство. Удаление очереди

Для удаления очереди и всех сообщений в ней вызовите метод
**deleteQueue** в объекте очереди.

    queueService.deleteQueue(queueName, function(error){
		if(!error){
			// Queue has been deleted
		}
	});

## <a name="next-steps"> </a>Дальнейшие действия

Вы изучили основные сведения о хранилище очередей. Дополнительные сведения о более сложных задачах по использованию хранилища можно найти по следующим ссылкам.

-   См. справочник MSDN: [Хранение данных и доступ к ним в Azure][].
-   Посетите блог [команды разработчиков хранилища Azure][].
-   Посетите репозиторий [Azure SDK для Node] на веб-сайте GitHub.

  [Azure SDK для Node]: https://github.com/WindowsAzure/azure-sdk-for-node
  [Дальнейшие действия]: #next-steps
  [Что такое служба очередей]: #what-is
  [Основные понятия]: #concepts
  [Создание учетной записи хранения Azure]: #create-account
  [Создание приложения Node.js]: #create-app
  [Настройка приложения для доступа к хранилищу]: #configure-access
  [Настройка строки подключения к хранилищу Azure]: #setup-connection-string
  [Практическое руководство. Создание очереди]: #create-queue
  [Практическое руководство. Вставка сообщения в очередь]: #insert-message
  [Практическое руководство. Просмотр следующего сообщения]: #peek-message
  [Практическое руководство. Удаление следующего сообщения из очереди]: #get-message
  [Практическое руководство. Изменение содержимого сообщения в очереди]: #change-contents
  [Практическое руководство. Использование дополнительных параметров для удаления сообщений из очереди]: #advanced-get
  [Практическое руководство. Получение длины очереди]: #get-queue-length
  [Практическое руководство. Удаление очереди]: #delete-queue
  [с помощью интерфейса API REST]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh264518.aspx
  [Портал управления Azure]: http://manage.windowsazure.com
  [Создание и развертывание приложения Node.js на веб-сайте Azure]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/
  [Облачная служба Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-app-with-storage/
  [Веб-приложение Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/
  
  [Queue1]: ./media/storage-nodejs-how-to-use-queues/queue1.png
  [plus-new]: ./media/storage-nodejs-how-to-use-queues/plus-new.png
  [quick-create-storage]: ./media/storage-nodejs-how-to-use-queues/quick-storage.png
  
  
  
  [Облачная служба Node.js]: {localLink:2221} "Веб-приложение с модулем Express"
  [Хранение данных и доступ к ним в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433040.aspx
  [Блог команды разработчиков хранилища Azure]: http://blogs.msdn.com/b/windowsazurestorage/
  [Веб-сайт с WebMatrix]: /ru-ru/develop/nodejs/tutorials/web-site-with-webmatrix/

