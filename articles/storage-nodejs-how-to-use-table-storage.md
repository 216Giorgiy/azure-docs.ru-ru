<properties linkid="dev-nodejs-how-to-table-services" urlDisplayName="Служба таблиц" pageTitle="Использование хранилища таблиц (Node.js) | Microsoft Azure" metaKeywords="служба хранилища таблиц в Azure, служба таблиц Node.js в Azure, служба таблиц Node.js" description="Узнайте, как использовать службу хранилища таблиц в Azure. Примеры кода написаны с помощью API-интерфейса Node.js." metaCanonical="" services="storage" documentationCenter="Node.js" title="Использование службы таблиц из Node.js" authors="" solutions="" manager="" editor="" />





# Использование службы таблиц из Node.js

В этом руководстве показано, как реализовать типичные сценарии с использованием службы таблиц Azure. Примеры написаны с помощью
API-интерфейса Node.js. Здесь описаны такие сценарии, как **создание и удаление
таблицы, вставка и запрос сущностей в таблице**. Дополнительные
сведения о таблицах см. в разделе [Дальнейшие действия][].

## Оглавление

* [Что такое служба таблиц?][]   
* [Основные понятия][]   
* [Создание учетной записи хранения Azure][]   
* [Создание приложения Node.js][]   
* [Настройка приложения для доступа к хранилищу][]   
* [Настройка подключения к хранилищу Azure][]   
* [Практическое руководство. Создание таблицы][]   
* [Практическое руководство. Добавление сущности в таблицу][]   
* [Практическое руководство. Обновление сущности][]   
* [Практическое руководство. Работа с группами сущностей][]   
* [Практическое руководство. Запрос сущности][]   
* [Практическое руководство. Запрос набора сущностей][]   
* [Практическое руководство. Запрос подмножества свойств сущности][]   
* [Практическое руководство. Удаление сущности][]   
* [Практическое руководство. Удаление таблицы][]   
* [Дальнейшие действия][]

## <a name="what-is"> </a>Что такое служба таблиц?

В службе таблицы Azure хранятся большие объемы структурированных данных. Эта служба принимает вызовы с проверкой подлинности,
отправленные изнутри и снаружи облака Azure. Таблицы Azure идеально подходят для
хранения нереляционных структурированных данных. Наиболее частые способы использования службы
таблиц включают:

-   Хранение большого объема структурированных данных (множество ТБ),
    автоматически масштабируемого в соответствии с требованиями к пропускной способности.
-   Хранение наборов данных, которые не требуют сложных соединений, внешних ключей
    или хранимых процедур, и могут быть денормализованы для обеспечения быстрого доступа.
-   Быстрый запрос данных, например профилей пользователей, с помощью кластеризованного индекса.

Службу таблиц можно использовать для хранения огромных наборов
структурированных нереляционных данных и осуществления запросов к ним; при увеличении объема
осуществляется масштабирование таблиц.

## <a name="concepts"> </a>Основные понятия

Служба таблиц содержит следующие компоненты:

![Table1][Table1]

-   **Формат URL-адреса**. Код обращается к таблицам в учетной записи, используя следующий
    формат адреса:
   
	    http://storageaccount.table.core.windows.net/table  
      
    К таблицам Azure можно обратиться напрямую, используя этот адрес с
    протоколом OData. Дополнительные сведения см. на странице [OData.org][]

-   **Учетная запись хранилища.** Весь доступ к хранилищу 
    Azure осуществляется с помощью учетной записи хранения. Общий размер BLOB-объекта, таблицы
    и содержимого очереди в учетной записи хранения не может превышать 100 ТБ.

-   **Таблица**. Таблица представляет собой неограниченную коллекцию сущностей. Таблицы
    не налагают схему на сущности. Это означает, что одна таблица может
    содержать сущности, которые имеют различные наборы свойств. Учетная запись
    может содержать множество таблиц.

-   **Сущность**. Сущность — это набор свойств, подобно строке базы
    данных. Сущность может быть размером до 1 МБ.

-   **Свойства**. Свойство представляет собой пару "имя-значение". Каждая сущность может содержать до 252 свойств для хранения данных. Каждая сущность имеет также
    три системных свойства, которые определяют ключ раздела, ключ строки
    и отметку времени. Сущности с тем же ключом раздела можно запросить быстрее,
    и они добавляются или обновляются с помощью атомарных операций. Ключ строки
    сущности — это ее уникальный код внутри раздела.

## <a name="create-account"> </a>Создание учетной записи хранения Azure

Для выполнения операций хранилища необходимо использовать учетную запись хранения Azure. Выполнив
следующие шаги, вы создадите учетную запись хранения. (Можно также
создать учетную запись хранения [с помощью интерфейса API REST][].)

1.  Выполните вход на [портал управления Azure].

2.  В нижней части области навигации щелкните **+СОЗДАТЬ**.

	![+Создать][plus-new]

3.  Щелкните **Учетная запись хранения**, а затем **Быстрое создание**.

	![Диалоговое окно "Быстрое создание"][quick-create-storage]

4.  В поле URL-адреса введите имя дочернего домена для использования URI для
    учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это значение становится именем узла в URI, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.

5.  Выберите регион или территориальную группу, где требуется расположить
    хранилище. При использовании хранилища в приложении Azure
    выберите область, в которой будет разворачиваться
    приложение.

6.  Щелкните **Создать учетную запись хранения**.

## <a name="create-app"> </a>Создание приложения Node.js

Создайте пустое приложение Node.js. Инструкции по созданию приложения Node.js см. в статьях [Создание и развертывание приложения Node.js на веб-сайте Azure], [Облачная служба Node.js] (с помощью Windows PowerShell) или [Веб-сайт с WebMatrix].

## <a name="configure-access"> </a>Настройка приложения для доступа к хранилищу

Для использования хранилища Azure необходимо загрузить и использовать пакет Node.js Azure,
который содержит набор библиотек, взаимодействующих
со службами REST хранилища.

### Использование диспетчера пакета Node (NPM) для получения пакета

1.  Используя интерфейс командной строки, такой как **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix), перейдите в папку, в которой создан пример приложения.

2.  Введите в командной строке **npm install azure**, что должно привести к следующему результату:

        azure@0.7.5 node_modules\azure
		├── dateformat@1.0.2-1.2.3
		├── xmlbuilder@0.4.2
		├── node-uuid@1.2.0
		├── mime@1.2.9
		├── underscore@1.4.4
		├── validator@1.1.1
		├── tunnel@0.0.2
		├── wns@0.5.3
		├── xml2js@0.2.7 (sax@0.5.2)
		└── request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)

3.  Можно вручную выполнить команду **ls**, чтобы убедиться в создании папки
    **node\_modules**. В этой папке находится
    пакет **azure**, содержащий библиотеки, необходимые для
    доступа к хранилищу.

### Импорт пакета

С помощью программы Блокнот или другого текстового редактора добавьте следующее в начало
файла **Server.js** приложения, где планируется использовать хранилище:

    var azure = require('azure');

## <a name="setup-connection-string"> </a>Настройка подключения к хранилищу Azure

Модуль Azure считывает переменные среды AZURE\_STORAGE\_ACCOUNT и AZURE\_STORAGE\_ACCESS\_KEY с целью получения сведений, необходимых для подключения к учетной записи хранения Azure. Если эти переменные среды не заданы, при вызове **TableService** необходимо указать сведения об учетной записи.

Пример настройки переменных среды в файле конфигурации для облачной службы Azure см. в статье [Облачная служба Node.js с хранилищем].

Пример настройки переменных среды на портале управления для веб-сайта Azure см. в статье [Веб-приложение Node.js с хранилищем]

## <a name="create-table"> </a>Практическое руководство. Создание таблицы

Следующий код создает объект **TableService** и использует его для создания новой таблицы. Добавьте в начало **server.js**
следующий код.

    var tableService = azure.createTableService();

Вызов **createTableIfNotExists** возвращает указанную таблицу,
если она уже существует, или создает новую таблицу с указанным именем, если
она еще не создана. В следующем примере создается новая таблица с именем "mytable", если она еще не создана:

    tableService.createTableIfNotExists('mytable', function(error){
		if(!error){
			// Table exists or created
		}
	});

###Фильтры

Дополнительные операции фильтрации можно применить к выполняемым операциям, используя **TableService**. К операциям фильтрации могут относиться ведение журнала, автоматически повтор и т. д. Фильтры являются объектами, реализующими метод со следующей сигнатурой:

		function handle (requestOptions, next)

Выполнив предварительную обработку параметров запроса, метод должен вызвать "next", передавая обратный вызов со следующей сигнатурой:

		function (returnObject, finalCallback, next)

В этой функции обратного вызова и после обработки returnObject (ответ на запрос к серверу) функция обратного вызова должна либо вызвать "next", если он существует, чтобы продолжить обработку других фильтров, либо в противном случае просто вызвать "finalCallback" для завершения обращения к службе.

В Azure SDK для Node.js включены два фильтра, реализующие логику повторных попыток: **ExponentialRetryPolicyFilter** и **LinearRetryPolicyFilter** Следующий код создает объект **TableService**, использующий фильтр **ExponentialRetryPolicyFilter**:

	var retryOperations = new azure.ExponentialRetryPolicyFilter();
	var tableService = azure.createTableService().withFilter(retryOperations);

## <a name="add-entity"> </a>Практическое руководство. Добавление сущности в таблицу

Чтобы добавить сущность, сначала создайте объект, который определяет свойства
сущности и их типы данных. Обратите внимание, что для каждой сущности необходимо задать свойства **PartitionKey** и **RowKey**. Это уникальные идентификаторы сущностей, которые можно запросить гораздо быстрее, чем для других свойств. Система использует **PartitionKey**, чтобы
автоматически распространять сущности таблицы на множество узлов хранилища.
Сущности с одним значением **PartitionKey** хранятся на одном узле. **RowKey** — это уникальный идентификатор сущности в разделе, которому она принадлежит. Чтобы добавить сущность в таблицу, передайте объект сущности в
метод **insertEntity**.

    var task = {
		PartitionKey : 'hometasks'
		, RowKey : '1'
		, Description : 'Take out the trash'
		, DueDate: new Date(2012, 6, 20)
	};
	tableService.insertEntity('mytable', task, function(error){
		if(!error){
			// Entity inserted
		}
	});

## <a name="update-entity"> </a>Практическое руководство. Обновление сущности

Для обновления имеющейся сущности доступно несколько методов:

* **updateEntity** - обновление имеющейся сущности путем ее замены.

* **mergeEntity** - обновление сущности путем объединения новых значений свойств с имеющейся сущностью.

* **insertOrReplaceEntity** - обновление имеющейся сущности путем ее замены. Если сущность не существует, будет вставлена новая сущность.

* **insertOrMergeEntity** - обновление сущности путем объединения новых значений свойств с имеющейся сущностью. Если сущность не существует, будет вставлена новая сущность.

В следующем примере показано обновление сущности с помощью метода **updateEntity**:

	var task = {
		PartitionKey : 'hometasks'
		, RowKey : '1'
		, Description : 'Wash Dishes'
	}
	tableService.updateEntity('mytable', task, function(error){
		if(!error){
			// Entity has been updated
		}
	});
    
Если обновляемая сущность не существует, при использовании **updateEntity** и **mergeEntity** операция обновления завершается ошибкой. Поэтому, если нужно сохранить сущность независимо от того, существует ли она, следует использовать **insertOrReplaceEntity** или **insertOrMergeEntity**.

## <a name="change-entities"> </a>Работа с группами сущностей

Иногда имеет смысл отправлять совместно несколько операций в
пакете для атомарной обработки сервером. Для этого
используйте метод **beginBatch** для **TableService** и затем вызовите
обычную последовательность операций. Различие состоит в том, что функции обратного вызова этих операторов будут указывать, что операция была пакетной и не отправлена на сервер. Если нужно отправить
пакет, вызовите **commitBatch**. Функция обратного вызова для данного метода
будет указывать, выполнена ли успешная отправка всего пакета. В следующем примере показана отправка двух сущностей в пакете:

    var tasks=[
		{
			PartitionKey : 'hometasks'
			, RowKey : '1'
			, Description : 'Take out the trash.'
			, DueDate : new Date(2012, 6, 20)
		}
		, {
			PartitionKey : 'hometasks'
			, RowKey : '2'
			, Description : 'Wash the dishes.'
			, DueDate : new Date(2012, 6, 20)
		}
	]
	tableService.beginBatch();
	var async=require('async');

	async.forEach(tasks
		, function taskIterator(task, callback){
			tableService.insertEntity('mytable', task, function(error){
				if(!error){
					// Entity inserted
					callback(null);
				} else {
					callback(error);
				}
			});
		}
		, function(error){
			if(!error){
				// All inserts completed
				tableService.commitBatch(function(error){
					if(!error){
						// Batch successfully commited
					}
				});
			}
		});

<div class="dev-callout">
<strong>Примечание.</strong>
<p>В приведенном выше примере используется модуль "async", подтверждающий успешную отправку сущностей перед вызовом метода **commitBatch**.</p>
</div>

## <a name="query-for-entity"> </a>Как выполнить запрос сущности

Для запроса сущности в таблице используйте метод **queryEntity**, передавая
значения **PartitionKey** и **RowKey**.

    tableService.queryEntity('mytable'
		, 'hometasks'
		, '1'
		, function(error, entity){
			if(!error){
				// entity contains the returned entity
			}
		});

## <a name="query-set-entities"> </a>Практическое руководство. Запрос набора сущностей

Чтобы отправить запрос для таблицы, используйте объект **TableQuery** для создания выражения
запроса с помощью таких предложений, как **select**, **from**, **where**
(включая вспомогательные предложения, такие как **wherePartitionKey**,
**whereRowKey**, **whereNextPartitionKey** и **whereNextRowKey**),
**and**, **or** и **top**. Затем передайте выражение
запроса в метод **queryEntities**. Результаты можно использовать в цикле
**for** внутри обратного вызова.

Этот пример находит все задачи в Сиэтле на основе **PartitionKey**.

    var query = azure.TableQuery
		.select()
		.from('mytable')
		.where('PartitionKey eq ?', 'hometasks');
	tableService.queryEntities(query, function(error, entities){
		if(!error){
			//entities contains an array of entities
		}
	});

## <a name="query-entity-properties"> </a>Практическое руководство. Запрос подмножества свойств сущности

Запрос к таблице может получить лишь несколько свойств сущности.
Этот метод, который называется *проекцией*, снижает потребление полосы пропускания и может повысить производительность запросов, особенно для крупных сущностей. Используйте предложение **select**
и передайте имена свойств, которые необходимо
передать клиенту.

Запрос в следующем коде возвращает только описания (**Descriptions**)
сущностей в таблице. Обратите внимание, что параметр **DueDate** в результатах программы
имеет значение **undefined** (неопределенный), так как он не был отправлен сервером.

<div class="dev-callout">
<strong>Примечание.</strong>
<p>Обратите внимание, что следующий фрагмент работает только для облачной службы хранилища, ключевое слово <b>select</b> не поддерживается эмулятором хранилищ.</p>
</div>

    var query = azure.TableQuery
		.select('Description')
		.from('mytable')
		.where('PartitionKey eq ?', 'hometasks');
	tableService.queryEntities(query, function(error, entities){
		if(!error){
			//entities contains an array of entities
		}
	});

## <a name="delete-entity"> </a>Практическое руководство. Удаление сущности

Сущность можно удалить с помощью ее ключей раздела и строки. В этом
примере объект **task1** содержит значения **RowKey** и
**PartitionKey** удаляемой сущности. Затем этот объект
передается в метод **deleteEntity**.

    tableService.deleteEntity('mytable'
		, {
			PartitionKey : 'hometasks'
			, RowKey : '1'
		}
		, function(error){
			if(!error){
				// Entity deleted
			}
		});

## <a name="delete-table"> </a>Практическое руководство. Удаление таблицы

Следующий код удаляет таблицу из учетной записи хранения.

    tableService.deleteTable('mytable', function(error){
		if(!error){
			// Table deleted
		}
	});

## <a name="next-steps"> </a>Дальнейшие действия

Вы изучили основные сведения о табличном хранилище. Дополнительные сведения о более сложных задачах по использованию хранилища можно найти по следующим ссылкам.

-   См. справочник MSDN: [Хранение данных и доступ к ним в Azure][].
-   [Посетите блог команды разработчиков хранилища Azure][].
-   Посетите репозиторий [Azure SDK для Node] на веб-сайте GitHub.

  [Azure SDK для Node]: https://github.com/WindowsAzure/azure-sdk-for-node
  [Дальнейшие действия]: #next-steps
  [Что такое служба таблиц?]: #what-is
  [Основные понятия]: #concepts
  [Создание учетной записи хранения Azure]: #create-account
  [Создание приложения Node.js]: #create-app
  [Настройка приложения для доступа к хранилищу]: #configure-access
  [Настройка подключения к хранилищу Azure]: #setup-connection-string
  [Практическое руководство. Создание таблицы]: #create-table
  [Практическое руководство. Добавление сущности в таблицу]: #add-entity
  [Практическое руководство. Обновление сущности]: #update-entity
  [Практическое руководство. Работа с группами сущностей]: #change-entities
  [Практическое руководство. Запрос сущности]: #query-for-entity
  [Практическое руководство. Запрос набора сущностей]: #query-set-entities
  [Практическое руководство. Запрос подмножества свойств сущности]: #query-entity-properties
  [Практическое руководство. Удаление сущности]: #delete-entity
  [Практическое руководство. Удаление таблицы]: #delete-table
  [Table1]: ./media/storage-nodejs-how-to-use-table-storage/table1.png
  [OData.org]: http://www.odata.org/
  [с помощью интерфейса API REST]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh264518.aspx
  [Портал управления Azure]: http://manage.windowsazure.com

  [plus-new]: ./media/storage-nodejs-how-to-use-table-storage/plus-new.png
  [quick-create-storage]: ./media/storage-nodejs-how-to-use-table-storage/quick-storage.png
  
  
  
  [Облачная служба Node.js]: {localLink:2221} "веб-приложение с Express"
  [Хранение данных и доступ к ним в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433040.aspx
  [Посетите блог команды разработчиков хранилища Azure]: http://blogs.msdn.com/b/windowsazurestorage/
  [Веб-сайт с WebMatrix]: /ru-ru/develop/nodejs/tutorials/web-site-with-webmatrix/
[Облачная служба Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-app-with-storage/
  [Веб-приложение Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/
 [Создание и развертывание приложения Node.js на веб-сайте Azure]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/

