---
title: Использование управляемого удостоверения службы с концентраторами событий Azure (предварительная версия) | Документация Майкрософт
description: Использование управляемых удостоверений службы с концентраторами событий Azure
services: event-hubs
documentationcenter: na
author: sethmanheim
manager: timlt
editor: ''
ms.assetid: ''
ms.service: event-hubs
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 12/18/2017
ms.author: sethm
ms.openlocfilehash: dd50e4f6ebc5fdf5496a5127fde20bd052087b59
ms.sourcegitcommit: f46cbcff710f590aebe437c6dd459452ddf0af09
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2017
ms.locfileid: "26783535"
---
# <a name="managed-service-identity-preview"></a>Функция "Управляемые удостоверения службы" (предварительная версия)

Управляемые удостоверения службы (MSI) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению. 

С помощью MSI платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению концентраторов событий, которое выполняется в приложении службы приложений Azure или на виртуальной машине с включенной поддержкой MSI, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен концентраторов событий. При подключении приложения концентраторы событий привязывают контекст MSI к клиенту в операции, показанной в примере далее в этой статье.

Как только он будет связан с управляемым удостоверением службы, клиент концентраторов событий сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания MSI к ролям концентраторов событий. 

## <a name="event-hubs-roles-and-permissions"></a>Роли и разрешения концентраторов событий

В начальном общедоступном выпуске (предварительная версия) можно привязать управляемые удостоверения служб только к ролям "Владелец" и "Участник" из пространства имен концентраторов событий, которые предоставляют удостоверению полный доступ ко всем сущностям в пространстве имен. Однако операции управления, изменяющие топологию пространства имен, изначально поддерживаются только через Azure Resource Manager, а не через собственный интерфейс управления REST концентраторов событий. Эта поддержка также означает, что нельзя использовать объект [NamespaceManager](/dotnet/api/microsoft.servicebus.namespacemanager) клиента .NET Framework в управляемом удостоверении службы. 
 
## <a name="use-event-hubs-with-a-managed-service-identity"></a>Использование концентраторов событий с управляемым удостоверением службы

В следующем разделе описано, как создать и развернуть пример приложения, выполняющегося с использованием управляемого удостоверения службы, предоставить удостоверению доступ к пространству имен концентраторов событий и как приложение взаимодействует с концентраторами событий через этот идентификатор.

В этом обзоре описано веб-приложение, размещенное в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Шаги для приложения, размещенного на виртуальной машине, аналогичны.

### <a name="create-an-app-service-web-application"></a>Создание веб-приложения службы приложений

Первым шагом является создание приложения ASP.NET службы приложения. Если вы не знаете, как это сделать в Azure, ознакомьтесь с [этим руководством](../app-service/app-service-web-get-started-dotnet-framework.md). Однако вместо того, чтобы создавать приложение MVC, как показано в этом руководстве, создайте приложение веб-форм.

### <a name="set-up-the-managed-service-identity"></a>Настройка управляемого удостоверения службы

После создания приложения перейдите к только что созданному веб-приложению на портале Azure (также отображается в практическом руководстве), а затем перейдите на страницу **Управляемое удостоверение службы** и включите возможность: 

![](./media/event-hubs-managed-service-identity/msi1.png)
 
После включения возможности в Azure Active Directory будет создано удостоверение службы и настроено в узле службы приложений.

### <a name="create-a-new-event-hubs-namespace"></a>Создание пространства имен концентраторов событий

Далее [создайте пространство имен концентраторов событий](event-hubs-create.md) в одном из регионов Azure с поддержкой предварительной версии MSI: **восточная часть США**, **восточная часть США 2** или **Западная Европа**. 

Перейдите к пространству имен на странице **Управление доступом (IAM)** на портале и щелкните **Добавить**, чтобы добавить управляемое удостоверение службы к роли **Владелец**. Чтобы сделать это, найдите название веб-приложения на панели **Добавление разрешений** в поле **Select** (Выбор), а затем щелкните запись. Нажмите кнопку **Сохранить**.

![](./media/event-hubs-managed-service-identity/msi2.png)
 
Теперь управляемое удостоверение службы веб-приложения имеет доступ к пространству имен концентраторов событий и к ранее созданному концентратору событий. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить страницу по умолчанию созданного вами приложения ASP.NET. Вы также можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure/azure-event-hubs/tree/master/samples/DotNet/MSI/EventHubsMSIDemoWebApp). 

После запуска приложения перейдите в браузере к файлу EventHubsMSIDemo.aspx. Его также можно установить в качестве начальной страницы. Код можно найти в файле EventHubsMSIDemo.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправить сообщения в концентраторы событий или получить их оттуда. 

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа, код создает поставщик маркеров для управляемого удостоверения службы с помощью вызова `TokenProvider.CreateManagedServiceIdentityTokenProvider(ServiceAudience.EventHubAudience)`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения службы в концентраторы событий и подтверждение авторизации автоматически обрабатываются поставщиком маркеров, что является более простой моделью, чем использование общих маркеров доступа.

После внесения этих изменений опубликуйте и запустите приложение. Простой способ получить правильные данные публикации — скачать, а затем импортировать профиль публикации в Visual Studio:

![](./media/event-hubs-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности, а затем нажмите кнопки **отправки** или **получения**. 
 
Обратите внимание, что управляемое удостоверение службы работает только в среде Azure и только в развертывании службы приложения, в котором оно было настроено. Кроме того, эти удостоверения сейчас не работают со слотами развертывания службы приложений.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о концентраторах событий см. по следующим ссылкам:

* Начните работу с [руководства по концентраторам событий](event-hubs-dotnet-standard-getstarted-send.md)
* [Часто задаваемые вопросы о концентраторах событий](event-hubs-faq.md)
* [Сведения о ценах на концентраторы событий](https://azure.microsoft.com/pricing/details/event-hubs/)
* [Примеры приложений, использующие концентраторы событий](https://github.com/Azure/azure-event-hubs/tree/master/samples)