<properties linkid="develop-net-common-tasks-diagnostics-logging-and-instrumentation" urlDisplayName="Включение ведения журналов диагностики" pageTitle="Включение ведения журналов диагностики - веб-сайты Azure" metaKeywords="веб-сайты Azure - диагностика, портал управления Azure - диагностика, диагностика Azure, диагностика веб-сайтов, отладка веб-сайтов" description="Узнайте о том, как включить ведение журналов диагностики и добавить соответствующие инструменты в приложение, а также как получить доступ к данным журналов Azure." metaCanonical="" services="web-sites" documentationCenter=".NET" title="Включение ведения журналов диагностики для веб-сайтов Azure" authors=""  solutions="" writer="larryfr" manager="" editor=""  />





#Включение ведения журналов диагностики для веб-сайтов Azure

Azure предоставляет встроенные средства диагностики, которые помогают отлаживать приложения, размещенные на веб-сайтах Azure. В этой статье вы узнаете, как включить ведение журналов диагностики и добавить инструментирование в приложение, а также как получить доступ к данным журналов Azure.

> [WACOM.NOTE] В данной статье описывается использование портала управления Azure, Azure PowerShell и межплатформенного интерфейса командной строки Azure для работы с журналами диагностики. Дополнительные сведения о работе с журналами диагностики с использованием Visual Studio см. в разделе [Устранение неполадок, связанных с веб-сайтами Azure, в Visual Studio](/ru-ru/develop/net/tutorials/troubleshoot-web-sites-in-visual-studio/).

##Оглавление##

- [Что такое диагностика веб-сайта?](#whatisdiag)
- [Практическое руководство. Включение диагностики](#enablediag)
- [Практическое руководство. Загрузка журналов](#download)
- [Практическое руководство. Потоковая передача журналов](#streamlogs)
- [Практическое руководство. Интерпретация журналов диагностики](#understandlogs)
- [Дальнейшие действия](#nextsteps)

<a name="whatisdiag"></a><h2>Что такое диагностика веб-сайта?</h2>

Веб-сайты Azure предоставляют диагностические функции для записи в журнал как информации с веб-сервера, так и информации из веб-приложения. Используется следующее логическое разделение: **диагностика сайта** и **диагностика приложений**.

###Диагностика сайта

Диагностика сайта позволяет включать и отключать следующие функции:

- **Подробное ведение журнала ошибок** — регистрация подробных сведений об ошибке для кодов состояния HTTP, которые указывают на сбой (код состояния 400 и выше). Здесь могут содержаться сведения, которые помогут определить причину, по которой сервер вернул код ошибки.
- **Трассировка неудачно завершенных запросов** — внесение в журнал подробных сведений о неудачных запросах, включая трассировку компонентов IIS для обработки запроса, а также время каждого компонента. Это может быть полезно, если вы пытаетесь повысить производительность веб-сайта или определить причину ошибки HTTP.
- **Журналы веб-сервера** — выполняет регистрацию всех транзакций HTTP на веб-сайте с использованием [расширенного формата файлов журналов W3C](http://msdn.microsoft.com/library/windows/desktop/aa814385.aspx). Этот отчет используется при определении общей метрики сайта, например количества обработанных запросов или количества запросов с определенного IP-адреса

###Диагностика приложений

Диагностика приложений позволяет записывать сведения, созданные веб-приложениями. Приложения ASP.NET могут использовать класс [System.Diagnostics.Trace](http://msdn.microsoft.com/ru-ru/library/36hhw2t6.aspx) для записи информации в журнал диагностики приложений. Например:

	System.Diagnostics.Trace.TraceError("If you're seeing this, something bad happened");

Диагностика приложений позволяет выполнять устранение неполадок при выполнении приложения путем предоставления информации об использовании определенных фрагментов кода. Это может пригодиться, когда вы пытаетесь определить, почему код использует тот или иной путь (обычно в том случае, когда путь приводит к возникновению ошибки или к другим нежелательным симптомам).

Дополнительные сведения о работе с диагностикой приложений с использованием Visual Studio см. в разделе [Устранение неполадок, связанных с веб-сайтами Azure, в Visual Studio](http://www.windowsazure.com/ru-ru/develop/net/tutorials/troubleshoot-web-sites-in-visual-studio/).

> [WACOM.NOTE] В отличие от изменения файла web.config, включение диагностики приложений или изменение уровней журнала диагностики не приводит к перезапуску домена приложения, в котором работает данное приложение.

Веб-сайты Azure также записывают сведения о развертывании при публикации приложения на веб-сайте. Это происходит автоматически, а параметры конфигурации для ведения журнала развертывания отсутствуют. Ведение журнала развертывания позволяет определить причину сбоя развертывания. Например, если применяется пользовательский скрипт развертывания, можно использовать ведение журнала развертывания, чтобы определить, почему не удается выполнить скрипт.

<a name="enablediag"></a><h2>Практическое руководство. Включение диагностики</h2>

Для включения диагностики посетите страницу **Настройка** веб-сайта Azure на [портале управления Azure](https://manage.microsoft.com). На странице **Настройка** используйте разделы **диагностика приложений** и **диагностика сайта**, чтобы включить ведение журнала.

При включении **диагностики приложений** также необходимо выбрать **уровень ведения журнала** и включить ведение журнала событий для **файловой системы**, **табличного хранилища** или **хранилища BLOB-объектов**. Хотя во всех трех местах хранения содержится одна и та же базовая информация о событиях, вносимых в журнал, в журнале **табличного хранилища** и **хранилища BLOB-объектов** также содержатся дополнительные сведения, например идентификатор экземпляра, идентификатор потока и более подробная отметка времени (формат отсчетов) в сравнении с журналом **файловой системы**.

При включении **диагностики сайтов** необходимо выбрать **хранилище** или **файловую систему** для **журналов веб-сервера**. Выбор **хранилища** позволяет выбрать учетную запись хранилища, а затем blob-контейнер, в который будут записываться журналы. Все другие журналы **диагностики сайтов** записываются только в файловую систему.

> [WACOM.NOTE] Доступ к сведениям, хранящимся в **табличных хранилищах** или в **хранилищах blob-объектов**, можно получить только с помощью клиента хранения или приложения, которое может напрямую работать с этими системами хранения данных. Например, в Visual Studio 2013 содержится проводник хранилищ, который может использоваться для просмотра таблицы или blob-хранилища, а HDInsight может получать доступ к данным, хранящимся в хранилище blob-объектов. Можно также написать приложение, которое обращается к хранилищу Azure, используя один из [пакетов SDK для Azure](http://www.windowsazure.com/ru-ru/downloads/#).

Ниже перечислены параметры, доступные при включении **диагностики приложений**:

* **Уровень ведения журнала** — служит для фильтрации информации, собираемой в качестве **данных**, **предупреждений** или **сведений об ошибке**. Можно выбрать вариант **подробно**, чтобы записать в журнал все сведения, созданные приложением. **Уровень ведения журнала** можно устанавливать по-разному для журналов **файловой системы**, **табличного хранилища** и **хранилища blob-объектов**.
* **Файловая система** — хранит сведения диагностики приложения в файловой системе веб-сайта. Доступ к этим файлам можно получить с помощью FTP, загрузить их в виде архива с использованием Azure PowerShell или средств командной строки Azure.
* **Хранилище таблиц** — хранит сведения диагностики приложений для указанной учетной записи хранилища Azure, а также имя таблицы.
* **Хранилище Blob-объектов** — хранит сведения диагностики приложений для указанной учетной записи хранилища Azure, а также контейнер BLOB-объектов.
* **Срок хранения** — по умолчанию журналы из **хранилища blob-объектов** не удаляются автоматически. Выберите **задать хранение** и введите число дней хранения журналов, если вы хотите автоматически удалить журналы.

> [WACOM.NOTE] Можно одновременно активировать варианты "Файловая система", "Табличное хранилище" или "Хранилище blob-объектов" в любом сочетании, а также настроить индивидуальные конфигурации уровня ведения журнала. Например, запись в хранилище ошибок и предупреждений в хранилище blob-объектов может потребоваться в качестве решения для длительного подробного ведения журнала.

> [WACOM.NOTE] Также можно включить диагностику из PowerShell Azure с помощью командлета **Set-AzureWebsite**. Если Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Использование Azure PowerShell](http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/powershell-cmdlets/).

<a name="download"></a><h2>Практическое руководство. Загрузка журналов</h2>

Доступ к диагностическим сведениям, хранящимся в файловой системе веб-сайта, может осуществляться непосредственно с использованием FTP. Их также можно загрузить в виде архива Azure PowerShell или средств командной строки Azure.

Структура каталогов, в которых хранятся журналы, выглядит следующим образом:

* **Журналы приложений** — /LogFiles/Application/. Эта папка содержит один или несколько текстовых файлов со сведениями, созданными при ведении журнала приложения.

* **Трассировка неудачно завершенных запросов** — /LogFiles/W3SVC#########/. Эта папка содержит XSL-файл и один или несколько XML-файлов. Убедитесь, что XSL-файл загружен в тот же каталог, что и XML-файлы, так как XSL-файл обеспечивает функциональные возможности форматирования и фильтрации содержимого XML-файлов при просмотре в браузере Internet Explorer.

* **Подробные журналы ошибок** — /LogFiles/DetailedErrors/. Эта папка содержит один или несколько HTM-файлов с подробными сведениями обо всех произошедших ошибках HTTP. 

* **Журналы веб-сервера** — /LogFiles/http/RawLogs. Эта папка содержит один или несколько текстовых файлов, отформатированных с применением [расширенного формата журнала W3C](http://msdn.microsoft.com/ru-ru/library/windows/desktop/aa814385(v=vs.85).aspx). 

* **Журналы развертывания** — /LogFiles/Git. Эта папка содержит журналы, созданные внутренними процессами развертывания, используемыми на веб-сайтах Azure, а также журналы развертываний с применением Git.

###FTP

Чтобы получить доступ к диагностической информации через FTP, перейдите на **Панель мониторинга** своего веб-сайта на портале управления Azure. В разделе **Сводка** используйте ссылку **Журналы диагностики FTP** для доступа к файлам журнала через FTP. Пункт **Развертывание/FTP-пользователь** содержит имя пользователя, указываемое для доступа к сайту FTP.

> [WACOM.NOTE] Если пункт **Развертывание/FTP-пользователь** не задан, или если вы забыли пароль для этого пользователя, можно создать нового пользователя и новый пароль с помощью ссылки **Сбросить учетные данные развертывания** в разделе **Сводка** **Панели мониторинга**.

###Загрузка с использованием Azure PowerShell

Для загрузки файлов журналов запустите новый экземпляр Azure PowerShell и используйте следующую команду:

	Save-AzureWebSiteLog -Name websitename

Она загрузит файлы журналов для веб-сайта, заданного параметром **-Name**, и сохранит их в файл **logs.zip** в текущем каталоге.

> [WACOM.NOTE] Если Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Использование Azure PowerShell](http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/powershell-cmdlets/).

###Загрузка с использованием средств командной строки Azure

Чтобы загрузить файлы журналов с использованием средств командной строки Azure, откройте окно командной строки, PowerShell, Bash или сеанс терминала и введите следующую команду:

	azure site log download websitename

Она загрузит файлы журналов для веб-сайта 'websitename' и сохранит их в файл **diagnostics.zip** в текущем каталоге.

> [WACOM.NOTE] Если инструменты командной строки Azure PowerShell не установлены или не настроены для использования подписки Azure, см. раздел [Использование инструментов командной строки Azure PowerShell](http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/command-line-tools/).

<a name="streamlogs"></a><h2>Практическое руководство. Потоковая передача журналов</h2>

При разработке приложения удобно видеть сведения о ведении журнала практически в режиме реального времени. Это можно сделать путем потоковой передачи сведений о ведении журнала в среду разработки с помощью Azure PowerShell или средств командной строки Azure.

> [WACOM.NOTE] Некоторые типы буфера журнала записывают данные в файл журнала, что может привести к нарушению порядка событий в потоке. Например, запись в журнале приложений, возникающая при посещении пользователем страницы, может отображаться в потоке перед соответствующей записью журнала HTTP о запросе страницы.

> [WACOM.NOTE] При потоковой передаче журнала будут также передаваться данные, записанные в любой текстовый файл, хранящийся в каталоге **D:\\home\\LogFiles\\**.

###Передача с использованием Azure PowerShell

Для передачи информации журналов запустите новый экземпляр Azure PowerShell и используйте следующую команду:

	Get-AzureWebSiteLog -Name websitename -Tail

Будет выполнено подключение к веб-сайту, заданному параметром **-Name**, и будет начата потоковая передача информации в окно PowerShell по мере возникновения на веб-сайте протоколируемых событий. Любые данные, записанные в файлы, оканчивающиеся на .txt, .log или .htm, которые хранятся в каталоге /LogFiles (d:/home/logfiles), будут передаваться на локальную консоль.

Чтобы отфильтровать определенные события, такие как ошибки, используйте параметр **-Message**. Например:

	Get-AzureWebSiteLog -Name websitename -Tail -Message Error

Чтобы отфильтровать определенные типы журналов, такие как HTTP, используйте параметр **-Path**. Например:

	Get-AzureWebSiteLog -Name websitename -Tail -Path http

Чтобы просмотреть список доступных путей, используйте параметр -ListPath.

> [WACOM.NOTE] Если Azure PowerShell не установлена или не настроена для использования подписки Azure, см. раздел [Использование Azure PowerShell](http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/powershell-cmdlets/).

###Передача с использованием средств командной строки Azure

Чтобы передать информацию журналов, откройте новое окно командной строки, PowerShell, Bash или сеанс терминала и введите следующую команду:

	azure site log tail websitename

Будет выполнено подключение к веб-сайту с именем 'websitename' и будет начата потоковая передача информации в окно PowerShell по мере возникновения на веб-сайте протоколируемых событий. Любые данные, записанные в файлы, оканчивающиеся на .txt, .log или .htm, которые хранятся в каталоге /LogFiles (d:/home/logfiles), будут передаваться на локальную консоль.

Чтобы отфильтровать определенные события, такие как ошибки, используйте параметр **--Filter**. Например:

	azure site log tail websitename --filter Error

Чтобы отфильтровать определенные типы журналов, такие как HTTP, используйте параметр **--Path**. Например:

	azure site log tail websitename --path http

> [WACOM.NOTE] Если инструменты командной строки Azure PowerShell не установлены или не настроены для использования подписки Azure, см. раздел [Использование инструментов командной строки Azure PowerShell](http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/command-line-tools/).

<a name="understandlogs"></a><h2>Практическое руководство. Интерпретация журналов диагностики</h2>

###Журналы диагностики приложений

Диагностика приложений хранит данные в определенном формате для приложений .NET в зависимости от того, сохраняются ли журналы в файловую систему, табличные хранилища или хранилища BLOB-данных. Базовый набор данных является одинаковым для всех трех типов хранения — дата и время, когда произошло событие, идентификатор процесса, который создал событие, тип события (информация, предупреждение, ошибка) и сообщение о событии.

__Файловая система__

Каждая строка, протоколируемая в файловой системе или полученная с помощью потоковой передачи, будет иметь следующий формат:

	{Дата}  PID[{идентификатор процесса}] {тип/уровень события} {сообщение}

Например, сообщение об ошибке будет выглядеть следующим образом:

	2014-01-30T16:36:59  PID[3096] Error       Fatal error on the page!

Ведение журнала в файловой системе позволяет получить базовые сведения из трех доступных методов; предоставляется только время, идентификатор процесса, уровень события и сообщение.

__Хранилище таблиц__

Ведение журнала в хранилище таблиц позволяет использовать дополнительные свойства для облегчения поиска данных, хранящихся в таблице, а также более подробные сведения о событии. Для каждого элемента (строки) в таблице используются следующие свойства (столбцы).

<table style="width:100%;border-collapse:collapse">
<thead>
<tr>
<th style="width:45%;border:1px solid black;background-color:#0099dd">Имя свойства</th>
<th style="border:1px solid black;vertical-align:top;background-color:#0099dd">Значение/формат</th>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">PartitionKey</td>
<td style="border:1px solid black;vertical-align:top">Дата и время события в формате yyyyMMddHH</td>
</tr>
</thead>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">RowKey</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Значение GUID, которое уникальным образом идентифицирует этот объект</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">Timestamp</td>
<td style="border:1px solid black;vertical-align:top">Дата и время возникновения события</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">EventTickCount</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Дата и время, когда произошло событие, в формате отсчетов (более высокая точность)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">ApplicationName</td>
<td style="border:1px solid black;vertical-align:top">Имя веб-сайта</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Level</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Уровень события (например, ошибка, предупреждение, информация)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">EventId</td>
<td style="border:1px solid black;vertical-align:top">Идентификатор события<br>По умолчанию равен 0 (если не указан)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">InstanceId</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Экземпляр веб-сайта, на котором произошло событие</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">Pid</td>
<td style="border:1px solid black;vertical-align:top">ИД процесса</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Tid</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Идентификатор потока, который вызвал это событие</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">Message</td>
<td style="border:1px solid black;vertical-align:top">Сообщение с подробными сведениями о событии</td>
</tr>
</table>

__Хранилище BLOB-объектов__

Если журнал ведется в хранилище blob-объектов, данные хранятся в формате с разделителями-запятыми (CSV). По аналогии с хранилищем таблиц, здесь фиксируются дополнительные с более подробными сведениями о событии. Для каждой строки CSV-файла используются следующие свойства:

<table style="width:100%;border-collapse:collapse">
<thead>
<tr>
<th style="width:45%;border:1px solid black;background-color:#0099dd">Имя свойства</th>
<th style="border:1px solid black;vertical-align:top;background-color:#0099dd">Значение/формат</th>
</tr>
</thead>
<tr>
<td style="border:1px solid black;vertical-align:top">Date</td>
<td style="border:1px solid black;vertical-align:top">Дата и время возникновения события</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Level</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Уровень события (например, ошибка, предупреждение, информация)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">ApplicationName</td>
<td style="border:1px solid black;vertical-align:top">Имя веб-сайта</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">InstanceId</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Экземпляр веб-сайта, на котором произошло событие</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">EventTickCount</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Дата и время, когда произошло событие, в формате отсчетов (более высокая точность)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">EventId</td>
<td style="border:1px solid black;vertical-align:top">Идентификатор события<br>По умолчанию равен 0 (если не указан)</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">Pid</td>
<td style="border:1px solid black;vertical-align:top">ИД процесса</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Tid</td>
<td style="border:1px solid black;vertical-align:top;background-color:#8ddaf6">Идентификатор потока, который вызвал это событие</td>
</tr>
<tr>
<td style="border:1px solid black;vertical-align:top">Message</td>
<td style="border:1px solid black;vertical-align:top">Сообщение с подробными сведениями о событии</td>
</tr>
</table>

Данные, хранящиеся в хранилище blob-объектов, будут иметь следующий вид:

	date,level,applicationName,instanceId,eventTickCount,eventId,pid,tid,message
	2014-01-30T16:36:52,Error,mywebsite,6ee38a,635266966128818593,0,3096,9,An error occurred

> [WACOM.NOTE] В первой строке журнала содержатся заголовки столбцов, представленных в данном примере.

###Трассировка неудачно завершенных запросов

Трассировка неудачно завершенных запросов хранится в XML-файле с именем __fr######.xml__. Чтобы облегчить просмотр данных журнала, используется таблица стилей XSL __freb.xsl__, расположенная в том же каталоге, что и XML-файлы. При открытии одного из XML-файлов в Internet Explorer будет использоваться таблица стилей XSL для форматированного отображения информации о трассировке. Экран будет выглядеть следующим образом:

![вид трассировки неудачно завершенных запросов в браузере](./media/web-sites-enable-diagnostic-log/tws-failedrequestinbrowser.png)

###Подробные журналы ошибок

Подробные журналы ошибок представляют собой документы HTML, в которых содержатся более подробные сведения о возникших ошибках HTTP. Поскольку они являются простыми HTML-документами, их можно просматривать с помощью веб-браузера.

###Журналы веб-сервера

Журналы веб-сервера форматируются с помощью [расширенного формата журнала W3C](http://msdn.microsoft.com/ru-ru/library/windows/desktop/aa814385(v=vs.85).aspx). Эти данные могут быть прочитаны с помощью текстового редактора, либо можно провести их синтаксический анализ с помощью служебных программ, таких как [Log Parser](http://go.microsoft.com/fwlink/?LinkId=246619)

> [WACOM.NOTE] Журналы, созданные веб-сайтами Azure, не поддерживают поля __s-computername__, __s-ip__ или __cs-version__.

<a name="nextsteps"></a><h2>Дальнейшие действия</h2>

- [Как отслеживать веб-сайты](/ru-ru/manage/services/web-sites/how-to-monitor-websites/)
- [Учебник — устранение неполадок веб-сайтов](/ru-ru/develop/net/best-practices/troubleshooting-web-sites/)
- [Устранение неполадок, связанных с веб-сайтами Azure, в Visual Studio](/ru-ru/develop/net/tutorials/troubleshoot-web-sites-in-visual-studio/)
- [Анализ журналов веб-сайта в HDInsight](http://gallery.technet.microsoft.com/scriptcenter/Analyses-Windows-Azure-web-0b27d413)


