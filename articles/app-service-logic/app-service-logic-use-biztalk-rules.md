<properties
   pageTitle="Узнайте о приложении API правил BizTalk в приложениях логики и научитесь его создавать | Microsoft Azure"
   description="В этой статье описываются функции соединителя правил BizTalk и приводятся инструкции по его использованию."
   services="app-service\logic"
   documentationCenter=".net,nodejs,java"
   authors="anuragdalmia"
   manager="dwrede"
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration"
   ms.date="01/19/2016"
   ms.author="andalmia"/>

#Правила BizTalk

Бизнес-правила инкапсулируют политики и решения, которые управляют бизнес-процессами. Эти политики могут формально определяться в процедурных руководствах, контрактах или могут существовать в виде знаний и профессионального опыта сотрудников. Эти политики являются динамическими и с течением времени могут изменяться в результате изменений бизнес-планов, нормативов или по другим причинам.

Для реализации этих политик на традиционных языках программирования требуется значительное время и координация. Кроме того, в создании и обслуживании бизнес-политик не принимают участие сотрудники, не являющиеся программистами. Бизнес-правила BizTalk предоставляют способ быстрой реализации этих политик и отделения остальной части бизнес-процессов. Это позволяет вносить необходимые изменения в бизнес-политики без влияния на остальные части бизнес-процесса.

##Причины использования правил

Существует 3 основные причины использования бизнес-правил BizTalk в бизнес-процессах:

* отделение бизнес-логики от кода приложения;
- предоставление бизнес-аналитикам большей степени контроля над управлением бизнес-логикой;
+ более быстрая реализация изменений бизнес-логики в рабочей среде.

##Основные понятия правил

##Словарь

_Словарь_ — это набор определений, состоящий из понятных имен для вычислительных объектов, используемых в условиях и действиях правил. Словарные определения облегчают чтение, понимание и совместное использование правил пользователями в конкретной бизнес-сфере.

Словари предназначены для устранения разрыва между бизнес-семантикой и реализацией. Например, привязка данных для статуса утверждения может указывать на определенный столбец в определенной строке в определенной базе данных, что представляется в виде SQL-запроса. Вместо того чтобы вставлять в правило такого рода сложное представление, можно создать словарное определение, связанное с такой привязкой данных, с понятным именем «Состояние». Далее можно включать «Состояние» в любое количество правил, и обработчик правил будет извлекать соответствующие данные из таблицы.

##правило;

Бизнес-правила представляют собой декларативные операторы, управляющие поведением бизнес-процессов. Правило состоит из условия и действий. Условие проверяется, и, если оно оценивается как истинное (true), обработчик правил инициирует одно или несколько действий. Правила в инфраструктуре бизнес-правил задаются в следующем формате:

_IF_ _условие_ _THEN_ _действие_.

Рассмотрим следующий пример.

*IF сумма меньше или равна доступным средствам*,  
*THEN провести транзакцию и распечатать квитанцию*

Это правило определяет, будет ли проводиться транзакция, путем применения бизнес-логики в виде сравнения двух денежных значений — суммы транзакции и доступных средств. Вы можете использовать бизнес-правило для создания, изменения и развертывания бизнес-правил.
Вы также можете выполнять указанные выше задачи программными средствами.

###Условия

Условие — это логическое выражение, имеющее значение true или false, которое состоит из одного или нескольких предикатов. В нашем примере предикат «меньше или равно» применяется к сумме и доступным средствам. Такое условие всегда будет оцениваться как истинное (true) или ложное (false).
Предикаты можно объединять с помощью логических операторов AND, OR и NOT, чтобы формировать логическое выражение, которое может быть довольно большим, но всегда будет оцениваться как истинное или ложное.

###Действия

Действия — это функциональные последствия оценки условия. Если условие правила удовлетворяется, инициируется соответствующее действие (или действия).
В нашем примере «провести транзакцию» и «распечатать квитанцию» — это действия, которые выполняются тогда и только тогда, когда условие (в данном случае «IF сумма меньше или равна доступным средствам») является истинным (true).
Действия в инфраструктуре бизнес-правил представляются путем выполнения операций SET в XML-документах.

##Политика

Политика — это логическая группа правил. Вы создаете политику, сохраняете ее, выполняете тестирование и, когда результат вас устроит, используете ее в рабочей среде.

###Создание политики

Политики можно создать на портале правил. Политика может содержать сколь угодно большой набор правил, но обычно политика составляется из правил, относящихся к конкретной бизнес-сфере в контексте приложения, которое будет использовать политику.

###Тестирование политики
Вы можете эффективно выполнять тестовые запуски политики, прежде чем использовать ее в рабочей среде. На портале правил можно предоставить входные данные для политики, запустить ее и просмотреть ее выходные данные. Выходные данные включают журналы, выполнение правил, оценку условий и итоговые результаты.

##Простой сценарий — требование о выплате страхового возмещения
Давайте возьмем простой сценарий и пройдем по шагам создания бизнес-логики для этого сценария.

![Alt text][1]

В очень простом сценарии требования о выплате страхового возмещения заявитель подает свое требование о выплате (посредством любого клиента, например через веб-сайт, телефонное приложение и т. п.). Этот запрос требования отправляется в блок обработки требований, и, в зависимости от результата обработки, данное требование может быть утверждено, отклонено или передано для дальнейшей обработки вручную.
Блок обработки требований в нашем сценарии будет включать бизнес-логику для системы. Если мы более пристально рассмотрим этот блок, то можем увидеть следующее.

![Alt text][2]

Теперь давайте реализуем эту бизнес-логику с помощью бизнес-правил.


##Создание приложения API правил


1. Выполните вход на портал Azure.
2. Выберите «Создать -> Marketplace», а затем найдите *Правила BizTalk*.
3. Выберите в списке результатов «Правила BizTalk». Откроется колонка «Правила BizTalk».
4. Нажмите кнопку *Создать*. ![Alt text][3]
1. В новой открывшейся колонке введите следующие сведения.  
	1. Имя — дайте имя вашему приложению API правил.
	1. План службы приложений: выберите или создайте новый план службы приложений.
	1. Ценовая категория — выберите ценовую категорию для этого приложения.
	1. Группа ресурсов — выберите или создайте группу ресурсов, в которой должно находиться это приложение.
	2. Подписка: выберите нужную подписку.
	1. Расположение — укажите географическое расположение, где планируется развернуть это приложение.
4.	Нажмите кнопку *Создать*. В течение нескольких минут ваше приложение API правил BizTalk будет создано.

##Создание словаря
Следующим шагом после создания приложения API правил BizTalk является создание словарей. Предполагается, что это упражнение чаще всего будут выполнять разработчики. Для решения этой задачи выполните следующие действия.


1. Запустите приложение API «Правила BizTalk» с портала, последовательно щелкнув «Обзор -> Приложения API -> <Your Rules API App>». Откроется панель мониторинга приложения API «Правила», аналогичная представленной ниже.

   ![Alt text][4]

2.Выберите «Словарные определения». Отобразится экран создания словаря.<br/>
3.Выберите «Добавить», чтобы приступить к добавлению новых словарных определений.
В настоящее время поддерживается два типа определений словаря — литеральное и XML.

##Литеральное определение
1.	После нажатия кнопки «Добавить» открывается новая колонка добавления определения. Введите следующие значения.
  1.	Имя — только буквы и цифры, без специальных символов. Это имя также должно быть уникальным в рамках существующего списка определений словаря.
  2.	Описание — необязательное поле.
  3.	Тип определения: поддерживаются два типа. В данном примере выберите литеральный тип.
  4.	Тип данных: пользователи могут выбрать тип данных определения. В настоящее время поддерживаются четыре типа данных: 
  i. String — это строковые значения, которые должны вводиться в двойных кавычках («Пример строки») 
  ii. Boolean — логическое значение, true или false 
  iii. Number — любое десятичное число 
  iv. DateTime — означает, что определение имеет тип даты. Даты должны вводиться в формате "мм/дд/гггг чч:мм:сс AM\PM".  
  5. Ввод — в этом поле вводится значение определения. Значения, которые здесь вводятся, должны соответствовать выбранному типу данных. Можно ввести одно значение, набор значений, разделенных запятыми, или диапазон значений с использованием ключевого слова *до*. Например, можно ввести уникальное значение 1, набор значений 1, 2 и 3 или диапазон от 1 до 5. Обратите внимание, что диапазон поддерживается только для чисел.
  6. Нажмите кнопку *ОК*.

![Alt text][5]
##XML-определение
Если в качестве типа словаря выбран XML, необходимо указать следующие входные данные.  
  a.	Схема — если щелкнуть это свойство, откроется новая колонка, в которой пользователь может выбрать одну из списка уже отправленных схем или отправить новую схему.   
  b.	XPATH — это свойство разблокируется только после выбора схемы на предыдущем шаге. Если его щелкнуть, откроется выбранная схема, и пользователь может выбрать в ней узел, для которого требуется создать определение словаря.  
  c.	ФАКТ — это свойство определяет, какие объекты данных должны загружаться в обработчик правил для обработки. Это дополнительное свойство, и по умолчанию в нем устанавливается родительский объект выбранного XPATH. Свойство ФАКТ имеет особенно важное значение в сценариях с использованием цепочки и коллекции.

![Alt text][6]

### Массовое добавление
Приведенные выше действия охватывают взаимодействие по созданию определений словаря. После создания определения словаря отображаются в форме списка. Иногда требуется создать сразу несколько определений из одной схемы вместо того, чтобы повторять указанные выше действия по одному. В этом случае очень удобно использовать возможность массового добавления.
Щелкните «Массовое добавление», чтобы перейти в новую колонку. Сначала нужно выбрать схему, для которой требуется создать несколько определений. При этом откроется новая колонка, после чего можно будет выбрать из списка уже загруженных схем или загрузить новую схему. Теперь разблокируется свойство XPATHS. При этом откроется средство просмотра схем, где можно выбрать несколько узлов. 
В качестве имен нескольких определений, которые создаются одновременно, по умолчанию устанавливаются имена выбранных узлов. Эти имена можно изменить в любое время после создания.

![Alt text][7]

##Создание политики
Предполагается, что после того как разработчик создаст необходимые словари, бизнес-аналитик будет создавать бизнес-политики на портале Azure.  
	1.	В созданном приложении правил имеется компонент «Политика», щелкнув который, пользователь переходит на страницу создания политики.  
	2. На этой странице отображается список политик, имеющихся в данном конкретном приложении правил. Аналитик может добавить новую политику, просто введя имя политики и дважды щелкнув вкладку. В одном приложении API правил может находиться несколько политик. 
	3. Если пользователь выбирает созданную политику, открывается страница сведений о политике, где отображаются правила, существующие в этой политике. 
	![Alt text][8] 
	4. Нажмите кнопку «Добавить», чтобы добавить новое правило. Откроется новая колонка.

##Создание правила
Правило — это набор инструкций условия и действий. Действия выполняются, если условие оценивается как истинное (true). В колонке создания правила задайте уникальное имя правила (для этой политики) и описание (необязательно).
Для создания сложных условных операторов можно использовать поле «Условие». Далее приводится список поддерживаемых ключевых слов. 
1. 	And (И) — условный оператор  
2. 	OR (ИЛИ) — условный оператор  
3. 	does_not_exist  
4. 	exists  
5. 	false  
6. 	is_equal_to  
7. 	is_greater_than  
8. 	is_greater_than_equal_to  
9. 	is_in  
10. is_less_than  
11. is_less_than_equal_to  
12. is_not_in  
13. is_not_equal_to  
14. mod  
15. true 

Поле действий (Then) может содержать несколько инструкций, по одной в строке, для создания действий, которые должны выполняться. Ниже приведены поддерживаемые ключевые слова:   
1.	equals  
2.	false  
3.	true  
4.	halt  
5.	mod  
6.	null  
7.	update  

Поля условия и действий предоставляют технологию Intellisense, чтобы помочь быстро создать правило. Ее можно вызвать, нажав сочетание клавиш CTRL + ПРОБЕЛ или просто начав ввод. Будут автоматически отфильтровываться и показываться ключевые слова, соответствующие введенным символам. Окно Intellisense будет показывать все ключевые слова и определения словаря. 
![Alt text][9]

##Явное прямое построение цепочки
Правила BizTalk поддерживают явное прямое построение цепочки, поэтому, если пользователям требуется повторно оценить правила в ответ на определенные действия, они могут активировать это с помощью определенных ключевых слов. Далее приведены поддерживаемые ключевые слова. 
   1.	update <vocabulary definition> — это ключевое слово выполняет переоценку всех правил, использующих в своих условиях указанное определение словаря.  
   2.	Halt — это ключевое слово останавливает все выполнения правил.

##Включение и отключение правил
Каждое правило в политике можно включать или отключать. По умолчанию все правила включены. Отключенные правила не выполняются во время выполнения политики. Включать и отключать правила можно либо непосредственно в колонке правила, используя команды в панели команд вверху колонки, либо из политики, используя пункт включения или отключения в контекстном меню (открывающемся при щелчке правила правой кнопкой мыши).

##Приоритет правил
Все правила политики выполняются по порядку. Приоритет выполнения определяется порядком, в котором правила расположены в политике. Этот приоритет можно изменить, просто перетащив правило.

##Тестирование политики
Политики можно проверить с помощью команды «Проверить политику» в колонке проверки политики. В этой колонке отображается список используемых в политике определений словаря, для которых требуется ввод данных пользователем. Пользователи могут вручную добавить значения этих входных данных для своих сценариев тестирования. Кроме того, пользователи могут импортировать тестовые XML-данные для входных данных. После ввода всех входных данных можно запустить тестирование, и выходные данные для каждого определения словаря будут отображены в выходном столбце для удобного сравнения. Чтобы просмотреть журналы, понятные бизнес-аналитику, нажмите «Просмотреть журналы», чтобы вывести журналы выполнения. Чтобы сохранить журналы, нажмите «Сохранить выходные данные», и все связанные с тестированием данные будут сохранены для независимого анализа.

## Использование правил в приложениях логики
После создания и тестирования политики она готова к использованию. Можно создать новое приложение логики, выбрав приложения логики из левой части домашней страницы портала. После создания приложения логики запустите его и выберите *Триггеры и действия*. Затем можно выбрать шаблон *Создать с нуля*. Выполните эти действия, чтобы добавить в приложение логики приложение API «Правила BizTalk». После этого появляется возможность выбрать целевое приложение API «Правила» (действие). Действия включают список политик, которые должны выполняться. Выберите конкретную политику, после чего нужно ввести входные данные, необходимые для этой политики. Можно использовать выходные данные приложения API правил для дальнейшего принятия решений.

## Использование правил с помощью API
Приложение API «Правила» можно также вызывать с помощью широкого набора доступных API. Таким образом, пользователи не ограничены использованием исключительно приложений логики и могут использовать правила в любом приложении, выполняя вызовы REST. Точный список доступных REST API можно просмотреть, нажав компонент «Определение API» в панели мониторинга правил.

![Alt text][10]

Ниже приведен пример того, как можно использовать этот API в C#.

   			// Constructing the JSON message to use in API call to Rules API App

			// xmlInstance is the XML message instance to be passed as input to our Policy
            string xmlInstance = "<ns0:Patient xmlns:ns0="http://tempuri.org/XMLSchema.xsd">  <ns0:Name>Name_0</ns0:Name>  <ns0:Email>Email_0</ns0:Email>  <ns0:PatientID>PatientID_0</ns0:PatientID>  <ns0:Age>10.4</ns0:Age>  <ns0:Claim>    <ns0:ClaimDate>2012-05-31T13:20:00.000-05:00</ns0:ClaimDate>    <ns0:ClaimID>10</ns0:ClaimID>    <ns0:TreatmentID>12</ns0:TreatmentID>    <ns0:ClaimAmount>10000.0</ns0:ClaimAmount>    <ns0:ClaimStatus>ClaimStatus_0</ns0:ClaimStatus>    <ns0:ClaimStatusReason>ClaimStatusReason_0</ns0:ClaimStatusReason>  </ns0:Claim></ns0:Patient>";

            JObject input = new JObject();

			// The JSON object is to be of form {"<XMLSchemName>_<RootNodeName>":"<XML Instance String>".
			// In the below case, we are using XML Schema - "insruanceclaimsschema" and the root node is "Patient".
			// This is CASE SENSITIVE.
            input.Add("insuranceclaimschema_Patient", xmlInstance);
            string stringContent = JsonConvert.SerializeObject(input);


            // Making REST call to Rules API App
            HttpClient httpClient = new HttpClient();

			// The url is the Host URL of the Rules API App
            httpClient.BaseAddress = new Uri("https://rulesservice77492755b7b54c3f9e1df8ba0b065dc6.azurewebsites.net/");
            HttpContent httpContent = new StringContent(stringContent);
            httpContent.Headers.ContentType = MediaTypeHeaderValue.Parse("application/json");

            // Invoking API "Execute" on policy "InsruranceClaimPolicy" and getting response JSON object. The url can be gotten from the API Definition Lens
            var postReponse = httpClient.PostAsync("api/Policies/InsuranceClaimPolicy?comp=Execute", httpContent).Result;

Обратите внимание, что параметры безопасности в приведенном выше приложении API установлены в значение «Общедоступный (анонимный)». Это можно установить в приложении API, последовательно выбрав в меню пункты "Все параметры" -> "Параметры приложения" -> "Уровень доступа".

![Alt text][11]

## Изменение словаря и политики
Одно из основных преимуществ использования бизнес-правил заключается в том, что изменения бизнес-логики можно реализовать в рабочей среде гораздо быстрее. Все изменения словаря и политик немедленно применяются в рабочей среде. Пользователю просто нужно перейти в соответствующее определение словаря или в политику и внести нужные изменения, чтобы привести их в действие.

<!--Image references-->
[1]: ./media/app-service-logic-use-biztalk-rules/InsuranceScenario.PNG
[2]: ./media/app-service-logic-use-biztalk-rules/InsuranceBusinessLogic.png
[3]: ./media/app-service-logic-use-biztalk-rules/CreateRuleApiApp.png
[4]: ./media/app-service-logic-use-biztalk-rules/RulesDashboard.png
[5]: ./media/app-service-logic-use-biztalk-rules/LiteralVocab.PNG
[6]: ./media/app-service-logic-use-biztalk-rules/XMLVocab.PNG
[7]: ./media/app-service-logic-use-biztalk-rules/BulkAdd.PNG
[8]: ./media/app-service-logic-use-biztalk-rules/PolicyList.PNG
[9]: ./media/app-service-logic-use-biztalk-rules/RuleCreate.PNG
[10]: ./media/app-service-logic-use-biztalk-rules/APIDef.PNG
[11]: ./media/app-service-logic-use-biztalk-rules/PublicAnon.PNG

<!----HONumber=AcomDC_0121_2016-->