<properties
   pageTitle="Установка локального шлюза данных для приложений логики | Microsoft Azure"
   description="Сведения о том, как установить локальный шлюз данных для использования в приложении логики."
   services="logic-apps"
   documentationCenter=".net,nodejs,java"
   authors="jeffhollan"
   manager="erikre"
   editor=""/>

<tags
   ms.service="logic-apps"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration"
   ms.date="07/05/2016"
   ms.author="jehollan"/>


# <a name="install-the-on-premises-data-gateway-for-logic-apps"></a>Установка локального шлюза данных для приложений логики

## <a name="installation-and-configuration"></a>Установка и настройка

### <a name="prerequisites"></a>Предварительные требования

Минимальные:

* .NET Framework 4.5;
* 64-разрядная версия Windows 7 или Windows Server 2008 R2 (или более поздняя версия).

Рекомендация:

* 8-ядерный ЦП;
* 8 ГБ ОЗУ;
* 64-разрядная версия Windows 2012 R2 (или более поздняя версия).

Сопутствующие рекомендации:

* Нельзя устанавливать шлюз на контроллере домена.
* Не следует устанавливать шлюз на компьютер (например, ноутбук), который может быть выключен, находиться в спящем режиме или быть не подключен к Интернету, так как при любом из этих условий шлюз не сможет функционировать. Кроме того, может наблюдаться снижение производительности шлюза при использовании беспроводной сети.

### <a name="install-a-gateway"></a>Установка шлюза

Установщик локального шлюза данных можно получить [здесь](http://go.microsoft.com/fwlink/?LinkID=820931&clcid=0x409).

Укажите режим **Локальный шлюз данных** , войдите в рабочую или учебную учетную запись, а затем настройте новый шлюз либо перенесите, восстановите или перехватите существующий шлюз.

* Чтобы настроить шлюз, введите его **имя** и **ключ восстановления**, затем щелкните или коснитесь **Настройка**.

    Укажите ключ восстановления, который содержит по крайней мере 8 знаков, и сохраните его в надежном месте. Этот ключ понадобится, если вы захотите перенести, восстановить или перехватить связанный с ним шлюз.

* Чтобы перенести, восстановить или перехватить существующий шлюз, укажите ключ восстановления, который был указан при создании этого шлюза.

### <a name="restart-the-gateway"></a>Перезапуск шлюза

Шлюз работает как служба Windows и, как и любая другая служба Windows, может быть запущен и остановлен различными способами. Например, можно открыть командную строку с дополнительными разрешениями на компьютере, на котором выполняется шлюз, и выполнить одну из следующих команд.

* Чтобы остановить службу, выполните указанную ниже команду.

    `net stop PBIEgwService`

* Чтобы запустить службу, выполните указанную ниже команду.

    `net start PBIEgwService`

### <a name="configure-a-firewall-or-proxy"></a>Настройка брандмауэра или прокси-сервера

Сведения о том, как предоставить данные прокси-сервера для шлюза, см. в разделе [Настройка параметров прокси-сервера для шлюзов Power BI](https://powerbi.microsoft.com/en-us/documentation/powerbi-gateway-proxy/).

Проверить, не блокирует ли брандмауэр или прокси-сервер подключения, можно, выполнив следующую команду в командной строке PowerShell. Она проверит возможность подключения к служебной шине Azure. При этом проверяется только возможность подключения к сети и не проверяется служба облачного сервера или шлюз. Это помогает определить, есть ли у компьютера доступ к Интернету.

`Test-NetConnection -ComputerName watchdog.servicebus.windows.net -Port 9350`

Результаты должны выглядеть примерно как в приведенном примере. Если значение **TcpTestSucceeded** не true, то, возможно, подключения блокируются брандмауэром.

```
ComputerName           : watchdog.servicebus.windows.net
RemoteAddress          : 70.37.104.240
RemotePort             : 5672
InterfaceAlias         : vEthernet (Broadcom NetXtreme Gigabit Ethernet - Virtual Switch)
SourceAddress          : 10.120.60.105
PingSucceeded          : False
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : True
```

Чтобы обеспечить исчерпывающие сведения, замените значения параметров **ComputerName** и **Port** значениями, приведенными ниже в разделе [Настройка портов](#configure-ports).

Брандмауэр может также блокировать подключения, устанавливаемые служебной шиной Azure с центрами обработки данных Azure. Если это так, то можно будет создать список разрешений и добавить в него (т. е. разблокировать) все IP-адреса вашего региона для этих центров обработки данных. Список IP-адресов Azure можно получить [здесь](https://www.microsoft.com/download/details.aspx?id=41653).

### <a name="configure-ports"></a>Настройка портов

Шлюз создает исходящее подключение к служебной шине Azure. Он обменивается данными через исходящие порты: TCP-порт 443 (по умолчанию), а также 5671, 5672 и 9350–9354. Шлюзу не требуются входящие порты.

Вы можете больше узнать о [гибридных решениях](../service-bus-messaging/service-bus-fundamentals-hybrid-solutions.md).

| ДОМЕННЫЕ ИМЕНА | ИСХОДЯЩИЕ ПОРТЫ | ОПИСАНИЕ |
| ----- | ------ | ------ |
| *.analysis.windows.net | 443 | HTTPS |
| *.login.windows.net | 443 | HTTPS |
| *.servicebus.windows.net |5671–5672 | Протокол AMQP |
| *.servicebus.windows.net | 443, 9350–9354 | Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). |
| *.frontend.clouddatahub.net | 443 | HTTPS |
| *.core.windows.net | 443 | HTTPS |
| login.microsoftonline.com | 443 | HTTPS |
| *.msftncsi.com | 443 | Используется для проверки подключения к Интернету, если шлюз недоступен для службы Power BI. |

Если требуется добавить в список разрешений IP-адреса, а не домены, то можно скачать и использовать [список диапазонов IP-адресов центров обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). В некоторых случаях подключения служебной шине Azure будут устанавливаться по IP-адресу, а не полному доменному имени.

### <a name="sign-in-account"></a>Учетная запись для входа

Пользователи будут выполнять вход в рабочую или учебную учетную запись. Это учетная запись вашей организации. Если вы зарегистрировались для использования предложения Office 365 и не предоставили действительный рабочий электронный адрес, то учетная запись может выглядеть следующим образом: jeff@contoso.onmicrosoft.com. В облачной службе ваша учетная запись хранится в клиенте в Azure Active Directory (AAD). В большинстве случаев имя участника-пользователя вашей учетной записи AAD будет совпадать с электронным адресом.

### <a name="windows-service-account"></a>Учетная запись службы Windows

Локальный шлюз данных настроен для использования NT SERVICE\PBIEgwService в качестве учетных данных входа службы Windows. По умолчанию он имеет право на вход в систему в качестве службы. Данное право действует в контексте компьютера, на который выполняется установка шлюза.

Это не учетная запись, используемая для подключения к локальным источникам данных, и не рабочая или учебная учетная запись, используемая для входа в облачные службы.

##<a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="general"></a>Общие сведения

**Вопрос**. Какие источники данных поддерживает шлюз?<br/>
**Ответ**. На момент написания статьи это SQL Server.

**Вопрос**. Нужно ли устанавливать шлюз для источников данных в облаке, например SQL Azure? <br/>
**Ответ**. Нет. Шлюз подключается только к локальным источникам данных.

**Вопрос**. Как на самом деле называется служба Windows?<br/>
**Ответ**. В списке служб шлюз называется "Служба Power BI Enterprise Gateway".

**Вопрос**. Устанавливаются ли какие-либо входящие подключения к шлюзу из облака? <br/>
**Ответ**. Нет. Шлюз использует исходящие подключения к служебной шине Azure.

**Вопрос**. Что делать, если мной заблокированы исходящие подключения? Что нужно открыть? <br/>
**Ответ**. Проверьте порты и узлы, которые использует шлюз.


**Вопрос**. Нужно ли устанавливать шлюз на том же компьютере, на котором находится источник данных? <br/>
**Ответ**. Нет. Шлюз будет подключаться к источнику данных, используя предоставленные сведения о подключении. В этом смысле шлюз можно рассматривать как клиентское приложение. Ему просто нужно будет подключиться к серверу, имя которого было предоставлено.


**Вопрос**. Что такое задержка при выполнении запросов к источнику данных из шлюза? Какая архитектура подойдет лучше всего? <br/>
**Ответ**. Чтобы уменьшить задержки в сети, необходимо установить шлюз как можно ближе к источнику данных. Можно установить шлюз на фактический источник данных, это сведет к минимуму задержки. Кроме того, рассмотрите применение центров обработки данных. Например, если служба использует центр обработки данных в западной части США, а SQL Server размещен в виртуальной машине Azure, то будет разумно также разместить эту виртуальную машину Azure в западной части США. Это позволит свести к минимуму задержки и избежать затрат на исходящий трафик виртуальной машины Azure.


**Вопрос**. Есть ли какие-либо требования к пропускной способности сети? <br/>
**Ответ**. Рекомендуется высокая пропускная способность для подключения к сети. Все среды разные, и объем отправляемых данных повлияет на результаты. Гарантировать определенный уровень пропускной способности между локальной средой и центрами обработки данных Azure может помочь применение ExpressRoute.

Измерить текущую пропускную способность можно с помощью стороннего инструмента — приложения Azure Speed Test.


**Вопрос**. Может ли служба Windows шлюза работать с учетной записью Azure Active Directory? <br/>
**Ответ**. Нет. Службе Windows требуется действительная учетная запись Windows. По умолчанию она будет выполняться с идентификатором безопасности службы NT SERVICE\PBIEgwService.


**Вопрос**. Как результаты отправляются обратно в облако? <br/>
**Ответ**. Это выполняется посредством служебной шины Azure. Чтобы узнать больше, узнайте, как это осуществляется.


**Вопрос**. Где хранятся мои учетные данные? <br/>
**Ответ**. Учетные данные, введенные для источника данных, хранятся в облачной службе шлюза в зашифрованном виде. Учетные данные расшифровываются локально в шлюзе.

### <a name="high-availability/disaster-recovery"></a>Высокий уровень доступности и аварийное восстановление

**Вопрос**. Существуют ли какие-либо планы по реализации сценариев высокого уровня доступности с помощью шлюза? <br/>
**Ответ**. Это входит в наши планы, но мы еще не определили временную шкалу для этого.


**Вопрос**. Какие варианты доступны для аварийного восстановления? <br/>
**Ответ**. Вы можете использовать ключ восстановления для восстановления или переноса шлюза. Ключ восстановления указывается при установке шлюза.


**Вопрос**. В чем заключается преимущество ключа восстановления? <br/>
**Ответ**. Он позволяет перенести или восстановить параметры шлюза после аварии.

### <a name="troubleshooting"></a>Устранение неполадок

**Вопрос**. Где находятся журналы шлюза? <br/>
**Ответ**. См. раздел "Средства" далее в этой статье.


**Вопрос**. Как посмотреть, какие запросы отправляются к локальному источнику данных? <br/>
**Ответ**. Можно включить трассировку запросов, в том числе и отправляемых. Не забудьте вернуть исходное значение после устранения неполадок. Если оставить включенной трассировку запросов, это приведет к увеличению размера журналов.

Кроме того, можно рассмотреть инструменты трассировки запросов, доступные для вашего источника данных. Например, можно использовать расширенные события или SQL Profiler для SQL Server и служб Analysis Services.

## <a name="how-the-gateway-works"></a>Как работает шлюз

Когда пользователь взаимодействует с элементом, подключенным к локальному источнику данных, происходит следующее.

1. Облачная служба создает запрос, а также зашифрованные учетные данные для источника данных, и отправляет запрос в очередь для обработки шлюзом.
1. Служба анализирует запрос и отправляет его в служебную шину Azure.
1. Локальный шлюз данных опрашивает служебную шину Azure, чтобы проверить наличие ожидающих запросов.
1. Шлюз получает запрос, расшифровывает учетные данные и подключается к источникам данных, используя эти учетные данные.
1. Затем шлюз отправляет запрос к источнику данных для выполнения.
1. Результаты отправляются из источника данных обратно в шлюз, а затем — в облачную службу. Затем служба использует эти результаты.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="update-to-the-latest-version"></a>Обновление до последней версии

При использовании устаревшей версии шлюза может возникать масса проблем.  Общепринятая рекомендация — убедиться, что вы используете последнюю версию.  Если шлюз не обновлялся месяц или дольше, то можно установить последнюю версию шлюза и проверить, получится ли воспроизвести проблему.

### <a name="error:-failed-to-add-user-to-group.-(-2147463168-pbiegwservice-performance-log-users-)"></a>Error: Failed to add user to group. (Ошибка: не удалось добавить пользователя в группу.) (-2147463168 PBIEgwService Performance Log Users ) (-2147463168 пользователей журналов производительности PBIEgwService)

Эта ошибка появляется, если вы пытаетесь установить шлюз на контроллер домена, что не поддерживается. Вам потребуется развернуть шлюз на компьютере, который не является контроллером домена.

## <a name="tools"></a>Средства

### <a name="collecting-logs-from-the-gateway-configurator"></a>Сбор журналов из конфигуратора шлюза

Вы можете собирать несколько журналов для шлюза. Всегда начинайте с журналов!

#### <a name="installer-logs"></a>Журналы установщика

`%localappdata%\Temp\Power_BI_Gateway_–Enterprise.log`

#### <a name="configuration-logs"></a>Журналы конфигурации

`%localappdata%\Microsoft\Power BI Enterprise Gateway\GatewayConfigurator.log`

#### <a name="enterprise-gateway-service-logs"></a>Журналы службы корпоративного шлюза

`C:\Users\PBIEgwService\AppData\Local\Microsoft\Power BI Enterprise Gateway\EnterpriseGateway.log`

#### <a name="event-logs"></a>Журналы событий

Журналы шлюза управления данными и PowerBIGateway находятся в разделе **Журналы приложения и служб**.

### <a name="fiddler-trace"></a>Трассировки Fiddler

[Fiddler](http://www.telerik.com/fiddler) — это бесплатный инструмент от компании Telerik, который отслеживает трафик HTTP.  Можно просматривать данные с помощью службы Power BI с клиентского компьютера. Это позволит выявить ошибки и другую сопутствующую информацию.

## <a name="next-steps"></a>Дальнейшие действия
- [Создание локального подключения к приложениям логики](app-service-logic-gateway-connection.md)
- [Возможности интеграции Enterprise](app-service-logic-enterprise-integration-overview.md)
- [Соединители приложений логики](../connectors/apis-list.md)


<!--HONumber=Oct16_HO2-->


