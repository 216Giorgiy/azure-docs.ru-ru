<properties 
	pageTitle="Использование диспетчера гибридных подключений | Служба приложений Microsoft Azure" 
	description="Установка и настройка диспетчера гибридных подключений и подключение к локальным соединителям, размещенным в службе приложений Azure" 
	services="app-service\logic" 
	documentationCenter=".net,nodejs,java"
	authors="MandiOhlinger" 
	manager="dwrede" 
	editor="cgronlun"/>

<tags 
	ms.service="app-service-logic" 
	ms.workload="integration" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="11/30/2015" 
	ms.author="mandia"/>

# Подключение к локальным соединителям, размещенным в службе приложений Azure, с помощью диспетчера гибридных подключений
Для работы с локальной системой служба приложений Azure использует диспетчер гибридных подключений. Некоторые соединители способны подключаться к локальным системам, таким как SQL Server, SAP, SharePoint и т. д.

Диспетчер гибридных подключений (HCM) представляет собой удобный установщик, который устанавливается на сервере IIS в пределах сети за брандмауэром. С помощью ретранслятора служебной шины Azure HCM выполняет проверку подлинности локальной системы с соединителем в среде Azure.

> [AZURE.NOTE]Диспетчер локальных подключений необходим только для подключения к локальному ресурсу за брандмауэром. Если вы не подключаетесь к локальной системе, этот диспетчер вам не потребуется.

Для начала работы необходимы перечисленные ниже компоненты и данные.

- Строка подключения SAS пространства имен ретранслятора служебной шины Azure. Сведения о том, в какую ценовую категорию включены ретрансляторы, см. в статье [Служебная шина: цены](http://azure.microsoft.com/pricing/details/service-bus/).
- Данные для входа в локальную систему, включая имя пользователя и пароль. Например, для подключения к локальному серверу SQL Server необходимы имя учетной записи и пароль SQL Server.
- Данные локального сервера, включая номер порта и имя сервера. Например, для подключения к локальному серверу SQL Server необходимы имя сервера SQL и номер TCP-порта.

## Получение строки подключения к служебной шине

На портале Azure скопируйте строку подключения корневого SAS служебной шины. Она позволяет подключить соединитель Azure к локальной системе.

1. На [портале Azure](http://go.microsoft.com/fwlink/p/?LinkID=213885) выберите пространство имен служебной шины и выберите **данные подключения**:

	![][SB_ConnectInfo]

2. Скопируйте строку подключения SAS.

	![][SB_SAS]

## Установка диспетчера гибридных подключений

1. На [портале предварительной версии Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040) выберите созданный соединитель. Чтобы открыть его, нажмите кнопку **Обзор**, выберите **Приложения API** и укажите соединитель или приложение API. <br/><br/> В разделе **гибридного подключения** настройка еще **не завершена**: <br/> ![][2] 

2. Выберите **гибридное подключение**. Будет указана строка подключения к служебной шине, которую вы ввели ранее.
3. Скопируйте **строку основной конфигурации**: <br/> ![][PrimaryConfigString]

4. В разделе **Локальный диспетчер гибридных подключений** можно скачать диспетчер или установить его непосредственно с портала. <br/><br/> Чтобы установить диспетчер непосредственно с портала, зайдите на свой локальный сервер IIS, перейдите на портал и выберите **Загрузить и настроить**. <br/><br/> Чтобы скачать диспетчер гибридных подключений, зайдите на локальный сервер IIS и перейдите к **приложению ClickOnce** (http://hybridclickonce.azurewebsites.net/install/Microsoft.Azure.BizTalk.Hybrid.ClickOnce.application). Установка начнется автоматически.

5. В окне **Установка прослушивателя** введите **основную строку конфигурации**, которую скопировали ранее (на этапе 3) и выберите **Установить**.

Когда установка будет завершена, на экране появится следующее: <br/> ![][3]

Теперь, если снова перейти к соединителю, для гибридного подключения будет указано состояние **Подключено**. Может потребоваться закрыть и снова открыть соединитель: <br/> ![][4]

> [AZURE.NOTE]Чтобы сменить строку подключения на дополнительную, повторно запустите настройку гибридного подключения и введите **дополнительную строку конфигурации**.


## TCP-порты и безопасность

При создании гибридного подключения на локальном сервере IIS создается веб-сайт. Сервер IIS может быть расположен на участке сети, для которого действуют особые правила межсетевого экрана. Для TCP-портов на сервере IIS действуют перечисленные ниже требования.

TCP-порт | Назначение
--- | ---
 | Входящие TCP-порты не требуются.
9350–9354 | Эти порты используются для передачи данных. Диспетчер ретранслятора служебной шины проверяет порт 9350, чтобы определить, доступно ли подключение TCP. Если оно доступно, диспетчер предполагает, что порт 9352 также доступен. Обмен данными осуществляется через порт 9352. <br/><br/>Разрешите внешние подключения к этим портам.
5671 | Когда порт 9352 используется для обмена данными, порт 5671 используется в качестве канала управления. <br/><br/>Разрешите внешние подключения к этому порту. 
80, 443 | Если порты 9352 и 5671 недоступны, *то* в качестве резервных портов для обмена данными и управления используются порты 80 и 443.<br/><br/>Разрешите внешние подключения к этим портам.
Порт локальной системы | В локальной системе откройте порт, используемый системой. Например, SQL Server обычно использует порт 1433. Откройте этот TCP-порт.

[Размещение за брандмауэром со служебной шиной](http://msdn.microsoft.com/library/azure/ee706729.aspx)

## Устранение неполадок

![][HCMFlow]

### Устранение неполадок в локальной системе

1. Убедитесь в том, что на сервере IIS установлена веб-роль IIS и запущены службы IIS.
2. Убедитесь в том, что на сервере IIS установлен и запущен диспетчер гибридных подключений.
 - В диспетчере IIS (inetmgr) должен быть указан и запущен веб-сайт ***MicrosoftAzureBizTalkHybridListener***. 
 - Этот веб-сайт использует пул ***HybridListenerAppPool***, который работает как локальная встроенная учетная запись пользователя *NetworkService*. Этот пул AppPool также должен быть запущен.
3. Убедитесь в том, что на сервере IIS установлен и запущен соединитель. 
 - Для соединителя службы приложений создается веб-сайт. Например, для соединителя SQL формируется веб-сайт ***MicrosoftSqlConnector\_nnn***. Убедитесь в том, что этот веб-сайт указан и запущен в диспетчере IIS (inetmgr). 
 - Этот веб-сайт использует собственный пул приложений IIS под названием ***HybridAppPoolnnn***. Этот пул AppPool работает как локальная встроенная учетная запись пользователя *NetworkService*. Этот веб-сайт и пул AppPool должны быть запущены. 
 - Перейдите к локальному соединителю. Например, если веб-сайт соединителя использует порт 6569, откройте адрес http://localhost:6569. Документ по умолчанию не задан, поэтому, вероятнее всего, возникнет сообщение об ошибке `HTTP Error 403.14 - Forbidden error`.
4. Убедитесь в том, что на брандмауэре открыты TCP-порты, указанные выше в этом разделе.
5. Обратите внимание на систему источника или назначения.
 - Для некоторых локальных систем необходимы дополнительные файлы зависимостей. Например, при подключении к локальной системе SAP на сервере IIS должны быть установлены некоторые дополнительные файлы SAP.
 - Проверьте доступность подключения к системе с помощью учетной записи для входа. Например, должен быть открыт используемый системой TCP-порт (такой как порт 1433 для сервера SQL Server). У учетной записи для входа, указанной на портале Azure, должен быть доступ к системе.
6. На сервере IIS проверьте журналы событий на предмет ошибок. 
7. Удалите и повторно установите диспетчер гибридных подключений. 
 - На IIS вручную удалите веб-сайт соединителя и связанный с ним пул приложений. 
 - Повторно запустите диспетчер гибридных подключений и введите правильную **основную строку конфигурации** для своего соединителя.



### На портале Azure

1. Убедитесь в том, что пространство имен служебной шины находится в **активном** состоянии.
2. При создании соединителя введите строку подключения SAS служебной шины. Не вводите строку подключения ACS.


## Часто задаваемые вопросы

**Вопрос.** Существует два диспетчера гибридных подключений. В чем разница между ними?<br/> **Ответ.** Существует технология [гибридных подключений](../integration-hybrid-connection-overview.md), которая используется главным образом веб-приложениями (ранее они назывались веб-сайтами) и мобильными приложениями (ранее — мобильные службы) для подключения к локальным системам. Соответствующий диспетчер гибридных подключений [настраивается](../integration-hybrid-connection-create-manage.md) отдельно и работает на базе службы BizTalk Azure. Он поддерживает только протоколы TCP и HTTP.

Для соединителей службы приложений Azure есть отдельный диспетчер гибридных подключений. Он *не* использует службу BizTalk Azure и поддерживает не только протоколы TCP и HTTP. См. [список соединителей и приложений API](app-service-logic-connectors-list.md).

Оба вида диспетчеров используют служебную шину Azure для подключения к локальной системе.

**Вопрос.** Можно ли при создании настраиваемого приложения API подключаться к локальной системе с помощью диспетчера гибридных подключений службы приложений? <br/> **Ответ.** В традиционном понимании — нет. Используя встроенный соединитель, настройте диспетчер гибридных подключений службы приложений для подключения к локальной системе. Затем используйте этот соединитель с собственным настраиваемым приложением API (вероятно, на базе приложения логики). В настоящее время разрабатывать и создавать собственные гибридные приложения API (такие как соединитель SQL или соединитель файлов) нельзя.

Если ваш настраиваемый API работает с портом TCP или HTTP, вы можете использовать [гибридные подключения](../integration-hybrid-connection-overview.md) и соответствующий диспетчер гибридных подключений. В этой ситуации используется служба Azure BizTalk. Вы можете попытаться [подключиться к локальному серверу SQL Server из веб-приложения](../app-service-web/web-sites-hybrid-connection-connect-on-premises-sql-server.md).


## Подробнее

[Мониторинг приложений логики](app-service-logic-monitor-your-logic-apps.md)<br/> [Служебная шина: цены](http://azure.microsoft.com/pricing/details/service-bus/)



[SB_ConnectInfo]: ./media/app-service-logic-hybrid-connection-manager/SB_ConnectInfo.png
[SB_SAS]: ./media/app-service-logic-hybrid-connection-manager/SB_SAS.png
[PrimaryConfigString]: ./media/app-service-logic-hybrid-connection-manager/PrimaryConfigString.png
[HCMFlow]: ./media/app-service-logic-hybrid-connection-manager/HCMFlow.png
[2]: ./media/app-service-logic-hybrid-connection-manager/BrowseSetupIncomplete.jpg
[3]: ./media/app-service-logic-hybrid-connection-manager/HybridSetup.jpg
[4]: ./media/app-service-logic-hybrid-connection-manager/BrowseSetupComplete.jpg

 

<!---HONumber=AcomDC_1203_2015-->