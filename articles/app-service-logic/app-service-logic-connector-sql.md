<properties
   pageTitle="Использование соединителя SQL в службе приложений Microsoft Azure"
   description="Использование соединителя SQL"
   services="app-service\logic"
   documentationCenter=".net,nodejs,java"
   authors="anuragdalmia"
   manager="dwrede"
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration"
   ms.date="08/09/2015"
   ms.author="sameerch"/>


# Соединитель Microsoft SQL

Используйте подключение к локальной базе данных SQL Server или SQL Azure для создания и изменения информации или данных. Соединители можно использовать в приложениях логики для извлечения, обработки или отправки данных в рамках рабочего процесса. Используя соединитель SQL в рабочем процессе, можно реализовать множество сценариев. Например, вы можете выполнить следующие действия.

- Предоставить раздел данных, размещенных в базе данных SQL, через веб-приложение или мобильное приложение.
- Вставить данные в таблицу базы данных SQL для хранения. Например, можно ввести записи о сотрудниках, обновить заказы на продажу и так далее.
- Получить данные из SQL и использовать их в бизнес-процессе. Например, можно получить записи клиентов и поместить их в SalesForce.

## Триггеры и действия
*Триггеры* — это события, которые происходят. Например, когда обновляется заказ или добавляется новый клиент. *Действие* — это результат триггера. Например, при обновлении заказа менеджеру по продажам отправляется оповещение. Либо при добавлении нового клиента ему отправляется приветственное письмо.

Соединитель SQL в приложении логики можно использовать как триггер или действие, он поддерживает данные в формате JSON и XML. Для каждой таблицы, включенной в параметры вашего пакета (подробнее это будет описано далее в этом разделе), существует набор действий JSON и действий XML.

Соединитель SQL предоставляет следующие триггеры и действия.

Триггеры | Действия
--- | ---
Опрос данных | <ul><li>Вставка в таблицу</li><li>Обновление таблицы</li><li>Выбор из таблицы</li><li>Удаление из таблицы</li><li>Вызов хранимой процедуры</li></ul>

## Создание соединителя SQL

Соединитель можно создать в приложении логики или непосредственно в Azure Marketplace. Создание соединителя в Marketplace

1. На начальной панели Azure выберите **Marketplace**.
2. Выполните поиск по запросу «Соединитель SQL», выберите его, а затем нажмите **Создать**.
3. Введите имя, план службы приложений и другие свойства.
4. Введите следующие параметры пакета:

	Имя | Обязательно | Описание
--- | --- | ---
Имя сервера | Да | Укажите имя сервера SQL Server. Например, введите *SQLserver/sqlexpress* или *SQLserver.mydomain.com*.
Порт | Нет | Значение по умолчанию — 1433.
Имя пользователя | Да | Введите имя пользователя, который может входить в SQL Server. Если подключение выполняется на локальном сервере SQL, введите учетные данные для проверки подлинности SQL.
Пароль | Да | Введите пароль для этого имени пользователя.
Имя базы данных | Да | Укажите базу данных, к которой выполняется подключение. Например, можно ввести *Customers* или *dbo/orders*.
Локальный | Да | Значение по умолчанию — False. Введите значение False, если выполняется подключение к базе данных SQL Azure. Если подключение выполняется к локальному SQL Server, введите значение True.
Строка подключения к служебной шине | Нет | При подключении к локальной среде введите строку подключения ретранслятора служебной шины.<br/><br/>[Использование диспетчера гибридных соединений](app-service-logic-hybrid-connection-manager.md)<br/>[Служебная шина — цены](http://azure.microsoft.com/pricing/details/service-bus/)
Имя сервера-партнера | Нет | Если сервер-источник недоступен, можно ввести сервер-партнер как альтернативный или резервный сервер.
Таблицы | Нет | Укажите список таблиц базы данных, которые могут быть обновлены с помощью соединителя. Например, введите *OrdersTable* или *EmployeeTable*. Если таблицы не указаны, могут использоваться все таблицы. Допустимые таблицы и (или) хранимые процедуры необходимы, чтобы использовать этот соединитель как действие.
Хранимые процедуры | Нет | Введите существующую хранимую процедуру, которую можно вызвать с помощью соединителя. Например, введите *sp\_IsEmployeeEligible* или *sp\_CalculateOrderDiscount*. Допустимые таблицы и (или) хранимые процедуры необходимы, чтобы использовать этот соединитель как действие.
Запрос доступных данных | Для поддержки триггера | Инструкция SQL для определения доступности данных для опроса таблицы базы данных SQL Server. Она должна вернуть числовое значение, представляющее число строк данных. Пример: SELECT COUNT(*) from имя\_таблицы. Запрос данных опроса | Для поддержки триггера | Инструкция SQL для опроса таблицы базы данных SQL Server. Можно ввести любое количество инструкций SQL, разделенных точкой с запятой. Эта инструкция выполняется на уровне транзакций и фиксируется только после того, как данные безопасно сохранены в приложении логики. Пример: SELECT * FROM имя\_таблицы; DELETE FROM имя\_таблицы. <br/><br/>***Примечание.**<br/>Необходимо указать инструкцию опроса, чтобы избежать бесконечного цикла при удалении, перемещении или обновлении выбранных данных и чтобы не опрашивать одни и те же данные повторно.

5. После завершения параметры пакета будут выглядеть примерно так: ![][1]

6. Нажмите кнопку **Создать**.


## Использование соединителя в качестве триггера
Рассмотрим простое приложение логики, которое опрашивает данные из таблицы SQL, добавляет данные в другую таблицу и обновляет данные.

Чтобы использовать соединитель SQL как триггер, введите значения **Запрос доступных данных** и **Запрос данных опроса**. **Запрос доступных данных** выполняется по задаваемому вами расписанию и определяет, доступны ли какие-либо данные. Так как этот запрос возвращает только скалярное число, его можно настроить и оптимизировать для частого выполнения.

**Запрос данных опроса** выполняется только в том случае, когда запрос доступных данных указывает, что данные доступны. Эта инструкция выполняется в рамках транзакции и фиксируется только после того, как извлеченные данные надежно сохраняются в рабочем процессе. Важно избежать бесконечно повторяющегося извлечения одних и тех же данных. Транзакционный характер этого выполнения можно использовать для удаления или обновления данных, чтобы убедиться, что они не собираются при следующем запросе данных.

> [AZURE.NOTE]Схема, возвращаемая этой инструкцией, определяет доступные свойства в соединителе. Все столбцы должны быть именованными.

#### Пример запроса доступных данных

	SELECT COUNT(*) FROM [Order] WHERE OrderStatus = 'ProcessedForCollection'

#### Пример запроса данных опроса

	SELECT *, GetData() as 'PollTime' FROM [Order]
		WHERE OrderStatus = 'ProcessedForCollection'
		ORDER BY Id DESC;
	UPDATE [Order] SET OrderStatus = 'ProcessedForFrontDesk'
		WHERE Id =
		(SELECT Id FROM [Order] WHERE OrderStatus = 'ProcessedForCollection' ORDER BY Id DESC)

### Добавление триггера
1. При создании или изменении приложения логики выберите соединитель SQL, созданный в качестве триггера. Будет выведен список доступных триггеров: **Данные опроса (JSON)** и **Данные опроса (XML)**: ![][5]

2. Выберите триггер **Данные опроса (JSON)**, укажите частоту и щелкните ✓: ![][6]

3. Триггер будет показан в приложении логики как настроенный. Будут отображены полученные триггером данные, которые можно использовать в качестве входных данных в последующих действиях: ![][7]

## Использование соединителя в качестве действия
Рассмотрим сценарий с простым приложением логики, которое запрашивает данные из таблицы SQL, добавляет данные в другую таблицу и обновляет данные.

Чтобы использовать соединитель SQL в качестве действия, укажите имена таблиц и (или) хранимых процедур, введенных при создании соединителя SQL.

1. После триггера (или выбора параметра "Запустить эту логику вручную") добавьте соединитель SQL, созданный из коллекции. Выберите одно из действий вставки, например *Вставить в TempEmployeeDetails (JSON)*: ![][8]

2. Введите входные значения записи для вставки и щелкните ✓: ![][9]

3. Выберите из коллекции тот же соединитель SQL, который вы создали. В качестве действия выберите действие обновления для той же таблицы, например *Обновить EmployeeDetails*: ![][11]

4. Введите входные значения для действия обновления и щелкните ✓: ![][12]

Можно проверить логику приложения, добавив новую запись в опрашиваемую таблицу.

## Что можно и нельзя делать

Запросы SQL | Поддерживаются | Не поддерживается
--- | --- | ---
Выражение WHERE | <ul><li>Операторы: AND, OR, =, <>, <, < =, >, > = и LIKE</li><li>Несколько вложенных условий можно объединить с помощью круглых скобок — ( )</li><li>Строковые литералы, дата и время (заключаются в одинарные кавычки), числа (должны содержать только числовые символы)</li><li>Должно иметь вид строго двоичного выражения, например ((операнд оператор операнд) AND/OR (операнд оператор операнд))**</li></ul> | <ul><li>Операторы: Between, IN</li><li>Все встроенные функции, такие как ADD(), MAX(), NOW(), POWER() и т. д.</li><li>Математические операторы, такие как *, -, +, и т. д.</li><li>Объединение строк с помощью +.</li><li>Все соединения</li><li>IS NULL и IS NOT Null</li><li>Любые числа с нечисловыми символами, например шестнадцатеричные числа</li></ul>Поля (в запросе Select) | <ul><li>Допустимые имена столбцов, разделенные запятыми. Префиксы имен таблиц не допускаются (этот соединитель обрабатывает по одной таблице за раз).</li><li>Имена можно экранировать с помощью квадратных скобок — [ ]</li></ul> | <ul><li>Ключевые слова, такие как TOP, DISTINCT и т. д.</li><li>Псевдонимы, такие как Street + City + Zip AS Address</li><li>Все встроенные функции, такие как ADD(), MAX(), NOW(), POWER() и т. д.</li><li>Математические операторы, такие как *, -, + и т. д.</li><li>Объединение строк с помощью +</li></ul>

#### Советы

- Для сложных запросов рекомендуется создать хранимую процедуру и выполнить ее с помощью API выполнения хранимых процедур.
- При использовании внутренних запросов применяйте их внутри хранимых процедур.
- Для объединения нескольких условий можно использовать операторы AND и OR.

## Гибридная конфигурация (необязательно)

> [AZURE.NOTE]Этот шаг необходим только в том случае, если сервер SQL Server используется локально под защитой брандмауэра.

Служба приложений использует диспетчер гибридных соединений для безопасного подключения к вашей локальной системе. Если ваш соединитель использует локальный сервер SQL Server, применение диспетчера гибридных соединений обязательно.

См. раздел [Установка диспетчера гибридных соединений](app-service-logic-hybrid-connection-manager.md).


## Дополнительные возможности соединителя
После создания соединителя его можно добавить в рабочий бизнес-процесс с помощью приложения логики. См. раздел [Что такое приложения логики?](app-service-logic-what-are-logic-apps.md).

Создание приложений API с помощью интерфейсов REST API. См. статью [Справочник по соединителям и приложениям API](http://go.microsoft.com/fwlink/p/?LinkId=529766).

Можно также просматривать статистику производительности и управлять безопасностью соединителя. См. статью [Управление встроенными приложениями API и соединителями, а также их мониторинг](app-service-logic-monitor-your-connectors.md).


<!--Image references-->
[1]: ./media/app-service-logic-connector-sql/Create.png
[5]: ./media/app-service-logic-connector-sql/LogicApp1.png
[6]: ./media/app-service-logic-connector-sql/LogicApp2.png
[7]: ./media/app-service-logic-connector-sql/LogicApp3.png
[8]: ./media/app-service-logic-connector-sql/LogicApp4.png
[9]: ./media/app-service-logic-connector-sql/LogicApp5.png
[10]: ./media/app-service-logic-connector-sql/LogicApp6.png
[11]: ./media/app-service-logic-connector-sql/LogicApp7.png
[12]: ./media/app-service-logic-connector-sql/LogicApp8.png

<!---HONumber=August15_HO7-->