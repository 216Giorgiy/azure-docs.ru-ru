<properties linkid="dev-net-how-to-access-control" urlDisplayName="Access Control" pageTitle="Использование Access Control (.NET) — руководство по компонентам Windows Azure" metaKeywords="Проверка подлинности в службе Azure Access Control с помощью приложения C#" description="Узнайте, как использовать службу Access Control (ACS) в приложении Windows Azure для проверки подлинности пользователей, пытающихся получить доступ к веб-приложению." metaCanonical="" services="active-directory" documentationCenter=".NET" title="Проверка подлинности веб-пользователей с помощью службы Windows Azure Active Directory Access Control" authors=""  solutions="" writer="juneb" manager="" editor=""  />




# Проверка подлинности веб-пользователей с помощью службы Windows Azure Active Directory Access Control


В этом руководстве показано, как использовать службу Windows Azure Active Directory Access Control (называемую также службой Access Control или ACS) для проверки подлинности пользователей, пытающихся получить доступ к веб-приложению, через такие поставщики удостоверений, как Microsoft, Google, Yahoo и Facebook.

<h2><span class="short-header">Оглавление</span>Оглавление</h2>

-   [Что такое ACS?][]
-   [Основные понятия][]
-   [Предварительные требования][]
-   [Создание пространства имен Access Control][]
-   [Создание приложения ASP.NET MVC][]
-   [Интеграция веб-приложения с ACS][]
-   [Тестирование интеграции с ACS][]
-   [Просмотр утверждений, отправленных службой ACS][vcsb]
-   [Просмотр приложения на портале управления ACS][vpp]
-   [Добавление поставщика удостоверений][]
-   [Что дальше?][]

<h2><span class="short-header">Что такое ACS?</span>Что такое ACS?</h2>

Большинство разработчиков не являются экспертами в области идентификации и не хотят тратить время на разработку механизмов проверки подлинности и авторизации для своих приложений и служб. ACS — это служба Windows Azure, которая предоставляет простой способ проверки подлинности пользователей для доступа к веб-приложениям и службам без необходимости добавлять сложную логику проверки подлинности в код.

В ACS доступны следующие возможности:

-   Интеграция с Windows Identity Foundation (WIF).
-   Поддержка популярных поставщиков удостоверений в Интернете, включая учетные записи Майкрософт (ранее известные как идентификаторы Windows Live ID), Google, Yahoo и Facebook.
-   Поддержка служб федерации Active Directory (AD FS) 2.0.
-   Служба управления на основе Open Data Protocol (OData), предоставляющая программный доступ к параметрам ACS.
-   Портал управления, предоставляющий административный доступ к параметрам ACS.

Дополнительные сведения об ACS см. в разделе [Служба Access Control 2.0][].

<h2><span class="short-header">Основные понятия</span>Основные понятия</h2>

Служба ACS построена по принципу идентификации на основе утверждений, обеспечивая согласованный подход к созданию механизмов проверки подлинности для приложений, выполняющихся локально или в облаке. Идентификация на основе утверждений предоставляет приложениям и службам общий способ получения необходимой идентификационной информации о пользователях в своей организации, в других организациях и в Интернете.

Для выполнения задач в этом руководстве необходимо понимать следующие используемые в нем термины и понятия:


**Клиент**. Браузер, который пытается получить доступ к веб-приложению.

**Приложение проверяющей стороны**. Ваше веб-приложение. Приложение проверяющей стороны представляет собой веб-сайт или службу, привлекающую внешний полномочный орган для проверки подлинности. Применительно к идентификации мы говорим, что проверяющая сторона доверяет этому органу. В этом руководстве объясняется, как настроить приложение на доверие ACS.

**Маркер**. Пользователь получает доступ к приложению проверяющей стороны, предоставляя действительный маркер, выданный полномочным органом, которому доверяет приложение. Коллекция данных безопасности, которая выдается при проверке подлинности клиента. Она содержит набор утверждений, которые являются атрибутами проверяемого пользователя, например имя или возраст пользователя либо идентификатор пользовательской роли. Маркер имеет цифровую подпись, позволяющую определить его издателя, и его содержимое нельзя изменить.

**Поставщик удостоверений**. Полномочный орган, который проверяет подлинность учетных данных пользователя и выдает маркеры безопасности. Такими органами могут быть, например, учетная запись Майкрософт (Windows Live ID), Facebook, Google, Twitter и Active Directory. Если служба ACS настроена на доверие поставщику удостоверений, она принимает и проверяет маркеры, выдаваемые этим поставщиком. Поскольку ACS может доверять одновременно нескольким поставщикам удостоверений, ваше приложение, доверяющее ACS, может предложить пользователям возможность проверки подлинности у любого поставщика удостоверений, который доверяет ACS от вашего имени.

**Поставщик федерации**. Поставщики удостоверений располагают непосредственными знаниями о пользователях, осуществляют проверку подлинности пользователей с помощью их учетных данных и выдают утверждения о пользователях. Поставщик федерации — это другой тип полномочного органа. Поставщик федерации не осуществляет непосредственную проверку подлинности пользователей, он выступает посредником. Он действует как промежуточное звено между приложением проверяющей стороны и одним или несколькими поставщиками удостоверений. ACS является поставщиком федерации.

**Обработчик правил ACS**. Правила преобразования утверждений преобразуют утверждения в маркеры от доверенных поставщиков удостоверений, чтобы их могла использовать проверяющая сторона. ACS содержит обработчик правил, который применяет правила преобразования утверждений, указанные для проверяющей стороны.

**Пространство имен Access Control**. Уникальная область для адресации ресурсов ACS в вашем приложении. Пространство имен содержит такие параметры, как доверенные поставщики удостоверений, обслуживаемые приложения проверяющей стороны, применяемые к входящим маркерам правила, а также отображает конечные точки, которые используются разработчиком и приложением для связи с ACS.

На следующем рисунке показано, как работает проверка подлинности ACS с веб-приложением:

![][0]

1.  Клиент (в данном случае браузер) запрашивает страницу у проверяющей стороны.
2.  Поскольку запрос еще не прошел проверку подлинности, проверяющая сторона перенаправляет пользователя в полномочный орган, которому она доверяет, то есть в ACS. ACS предлагает пользователю на выбор поставщики удостоверений, указанные для этой проверяющей стороны. Пользователь выбирает поставщика удостоверений.
3.  Клиент переходит на страницу проверки подлинности поставщика удостоверений и предлагает пользователю войти в систему.
4.  После проверки подлинности клиента (например, введенных учетных данных) поставщик удостоверений выдает маркер безопасности.
5.  После выдачи маркера безопасности поставщик удостоверений рекомендует клиенту отправить маркер безопасности, выданный поставщиком, в ACS.
6.  ACS проверяет маркер безопасности, выданный поставщиком удостоверений, вводит идентификационные утверждения из этого маркера в обработчик правил ACS, вычисляет выходные идентификационные утверждения и выдает новый маркер безопасности, содержащий эти выходные утверждения.
7.  ACS предлагает клиенту отправить маркер безопасности, выданный службой ACS, проверяющей стороне. Проверяющая сторона проверяет подпись маркера безопасности, извлекает утверждения для применения к ним бизнес-логики приложения и возвращает первоначально запрошенную страницу.

<h2><span class="short-header">Предварительные требования</span>Предварительные требования</h2>


Для выполнения задач в этом руководстве вам потребуется следующее:

-	Подписка на Windows Azure
-	Microsoft Visual Studio 2012 
-	Средство идентификации и доступа для Visual Studio 2012 (чтобы загрузить, см. раздел [Средство идентификации и доступа][])


<h2><span class="short-header">Создание пространства имен Access Control</span>Создание пространства имен Access Control</h2>

Чтобы использовать Active Directory Access Control в Windows Azure, создайте пространство имен Access Control. Пространство имен предоставляет уникальную область для адресации ресурсов ACS в вашем приложении.

1.  Войдите на [портал управления Windows Azure][] (https://manage.WindowsAzure.com).
    
2.  Щелкните **Active Directory**.  

	![][1]

3.  Чтобы создать новое пространство имен Access Control, щелкните **Создать**. Будут выбраны элементы **Службы приложений** и **Access Control**. Щелкните **Быстрое создание**. 

	![][2]

4.  Введите имя для пространства имен. Windows Azure проверяет, является ли имя уникальным.

5.  Выберите регион, в котором используется пространство имен. Для максимальной эффективности используйте регион, в котором развертывается приложение, затем щелкните **Создать**.

Windows Azure создает и активирует пространство имен.

<h2><span class="short-header">Создание приложения ASP.NET MVC</span>Создание приложения ASP.NET MVC</h2>

На этом шаге создается приложение ASP.NET MVC. На последующих шагах это простое приложение для веб-форм будет интегрировано с ACS.

1.	Запустите Visual Studio 2012 или Visual Studio Express for Web 2012 (предыдущие версии Visual Studio не будут работать с этим учебником).
1.	Щелкните **Файл** и выберите **Новый проект**.
1.	Выберите приложение Visual C# или веб-шаблон, а затем выберите **Веб-приложение ASP.NET MVC 4**.

	В этом руководстве используется приложение MVC, но для этой задачи можно использовать веб-приложение любого типа.

	![][3]

1. В поле **Имя** введите **MvcACS** и нажмите кнопку **ОК**.
1. В следующем диалоговом окне выберите **Интернет-приложение** и нажмите кнопку **ОК**.
1. Выполните правку файла *Views\Shared\_LoginPartial.cshtml*, заменив его содержимое следующим кодом:

        @if (Request.IsAuthenticated)
        {
            string name = "Null ID";
            if (!String.IsNullOrEmpty(User.Identity.Name))
            {
                name = User.Identity.Name;
            }    
            <text>
            Hello, @Html.ActionLink(name, "Manage", "Account", routeValues: null, htmlAttributes: new { @class = "username", title = "Manage" })!
                    @using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm" }))
                    {
                        @Html.AntiForgeryToken()
                        <a href="javascript:document.getElementById('logoutForm').submit()">Log off</a>
                    }
            </text>
        }
        else
        {
            <ul>
                <li>@Html.ActionLink("Register", "Register", "Account", routeValues: null, htmlAttributes: new { id = "registerLink" })</li>
                <li>@Html.ActionLink("Log in", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })</li>
            </ul>
        }

Сейчас ACS не может задать User.Identity.Name, поэтому необходимо выполнить указанное выше изменение.

1. Нажмите клавишу F5 для запуска приложения. В веб-браузере появится приложение ASP.NET MVC по умолчанию.

<h2><span class="short-header">Интеграция веб-приложения с ACS</span>Интеграция веб-приложения с ACS</h2>

В этой задаче ваше веб-приложение ASP.NET будет интегрировано с ACS.

1.	В обозревателе решений щелкните правой кнопкой мыши проект MvcACS и выберите **Идентификация и доступ**.

	Если параметр **Идентификация и доступ** не появляется в контекстном меню, установите средство идентификации и доступа. Информацию см. в разделе [Средство идентификации и доступа]. 

	![][4]

2.	На вкладке **Поставщики** выберите **Использовать службу Windows Azure Access Control**.

    ![][44]

3.  Щелкните ссылку **Настроить**.

    ![][444]

	Visual Studio запрашивает сведения о пространстве имен Access Control. Введите имя созданного ранее пространства имен (проверьте на изображениях выше, но у вас будет другое пространство имен). Вернитесь на портал управления Windows Azure, чтобы получить симметричный ключ.

	![][17]

4.  На портале управления Windows Azure щелкните пространство имен Access Control, затем щелкните **Управление**.

	![][8]

5.	Щелкните **Служба управления**, а затем **Клиент управления**.

	![][18]

6.	Щелкните **Симметричный ключ**, затем **Показать ключ** и скопируйте значение ключа. Затем нажмите кнопку **Отмена**, чтобы выйти со страницы изменения клиента управления без внесения изменений. 

	![][19]

7.  В Visual Studio вставьте ключ в поле **Введите ключ управления для пространства имен**, щелкните **Сохранить ключ управления** и нажмите кнопку **ОК**.

	![][20]

	С помощью сведений о пространстве имен Visual Studio подключается к порталу управления ACS и получает параметры для пространства имен, в том числе поставщики удостоверений, область определения приложения и URL-адрес возврата.

8.	Выберите **Windows Live ID** (учетная запись Майкрософт) и нажмите кнопку ОК. 

	![][5]

<h2><span class="short-header">Тестирование интеграции с ACS</span>Тестирование интеграции с ACS</h2>

В этой задаче объясняется, как протестировать интеграцию приложения проверяющей стороны и ACS.

-	В Visual Studio нажмите клавишу F5, чтобы запустить приложение.

Если приложение интегрировано с ACS, то при выборе Windows Live ID (учетной записи Майкрософт), вместо того чтобы открыть приложение ASP.NET для веб-форм по умолчанию, браузер переходит на страницу входа для учетных записей Майкрософт. После входа с использованием действительного имени пользователя и пароля происходит перенаправление в приложение MvcACS.

![][6]

Поздравляем! Служба ACS успешно интегрирована с веб-приложением ASP.NET. ACS теперь осуществляет проверку подлинности пользователей, используя учетные данные учетной записи Майкрософт.

<h2><a name="bkmk_viewClaims"></a>Просмотр утверждений, отправленных службой ACS</h2>

В этом разделе мы изменим приложение, чтобы просмотреть утверждения, отправленные службой ACS.  Средством идентификации и доступа создана группа правил, через которую проходят все утверждения из поставщика удостоверений в приложение.  Обратите внимание, что разные поставщики удостоверений отправляют разные утверждения.

1. Откройте файл *Controllers\HomeController.cs*. Добавьте инструкцию **using** для **System.Threading**:

 	using System.Threading;

1. В классе HomeController добавьте метод *Claims*:

    public ActionResult Claims()
    {
        ViewBag.Message = "Your claims page.";

        ViewBag.ClaimsIdentity = Thread.CurrentPrincipal.Identity;

        return View();
    }

1. Щелкните правой кнопкой мыши метод *Claims* и выберите **Добавить представление**.

![][66]

1. Щелкните **Добавить**.

1. Замените содержимое файла *Views\Home\Claims.cshtml* следующим кодом:

        @{
            ViewBag.Title = "Claims";
        }
        <hgroup class="title">
            <h1>@ViewBag.Title.</h1>
            <h2>@ViewBag.Message</h2>
        </hgroup>
        <h3>Values from Identity</h3>
        <table>
            <tr>
                <td>
                    IsAuthenticated: 
                </td>
                <td>
                    @ViewBag.ClaimsIdentity.IsAuthenticated 
                </td>
            </tr>
            <tr>
                <td>
                    Name: 
                </td>        
                <td>
                    @ViewBag.ClaimsIdentity.Name
                </td>        
            </tr>
        </table>
        <h3>Claims from ClaimsIdentity</h3>
        <table>
            <tr>
                <th>
                    Claim Type
                </th>
                <th>
                    Claim Value
                </th>
            </tr>
                @foreach (System.Security.Claims.Claim claim in ViewBag.ClaimsIdentity.Claims ) {
            <tr>
                <td>
                    @claim.Type
                </td>
                <td>
                    @claim.Value
                </td>
            </tr>
        }
        </table>

1. Запустите приложение и перейдите к методу *Claims*:

![][666]

Дополнительные сведения об использовании утверждений в приложении см. в [библиотеке Windows Identity Foundation](http://msdn.microsoft.com/ru-ru/library/hh377151.aspx)

<h2><a name="bkmk_VP"></a>Просмотр приложения на портале управления ACS</h2>

Средство идентификации и доступа в Visual Studio автоматически интегрирует приложение с ACS.

Если вы выбираете параметр "Использовать Windows Azure Access Control", а затем запускаете приложение, средство идентификации и доступа добавляет приложение как проверяющую сторону, настраивает его на использование выбранных поставщиков удостоверений, а затем создает и выбирает правила преобразования утверждений по умолчанию для приложения.

Эти параметры настройки можно просмотреть и изменить на портале управления ACS. Для просмотра изменений на портале выполните следующие действия.

1.	Войдите на [портал управления Windows Azure](http://manage.WindowsAzure.com).

2.	Щелкните **Active Directory**. 

	![][8]

3.	Выберите пространство имен Access Control и щелкните **Управление**. Откроется портал управления ACS.

	![][9]


4.	Щелкните **Приложения проверяющей стороны**.

	В списке приложений проверяющей стороны появляется новое приложение MvcACS. В качестве области определения автоматически задается главная страница приложения.

	![][10]


5.	Щелкните **MvcACS**.

	На странице изменения приложения проверяющей стороны представлены параметры конфигурации для веб-приложения MvcACS. Если изменить параметры на этой странице и сохранить их, изменения сразу же применяются к приложению.

	![][11]

6.	Прокрутите страницу вниз, чтобы увидеть остальные параметры конфигурации для приложения MvcACS, включая поставщики удостоверений и правила преобразования утверждений.

	![][12]

В следующем разделе мы используем функции портала управления ACS для внесения изменений в веб-приложение — просто для того, чтобы показать, насколько легко сделать.

<h2><span class="short-header">Добавление поставщика удостоверений</span>Добавление поставщика удостоверений</h2>

Давайте с помощью портала управления ACS изменим проверку подлинности приложения MvcACS. В этом примере мы добавим Google в качестве поставщика удостоверений для MvcACS.

1.	Щелкните **Поставщики удостоверений** (в навигационном меню), затем щелкните **Добавить**.

	![][13]

2.	Щелкните **Google** и нажмите кнопку **Далее**. Флажок MvcACS установлен по умолчанию. 

	![][14]

3. Щелкните "Сохранить". 

	![][15]


Готово! Если вернуться в Visual Studio, открыть проект для приложения MvcACS и щелкнуть **Идентификация и доступ**, в соответствующем средстве будут указаны поставщики удостоверений Windows Live ID и Google.  

![][16]

При запуске приложения вы увидите результат. Если приложение поддерживает более одного поставщика удостоверений, браузер пользователя сначала направляется на страницу, размещаемую службой ACS, где пользователю предлагается выбрать поставщика удостоверений. 

![][7]

После того как пользователь выберет поставщика удостоверений, браузер переходит страницу входа поставщика удостоверений.

<h2><span class="short-header">Что дальше?</span>Что дальше?</h2>

Вы создали веб-приложение, интегрированное с ACS. Но это только начало! Этот сценарий можно расширить.
 
Например, можно добавить дополнительные поставщики удостоверений для этой проверяющей стороны или позволить входить в веб-приложение пользователям, зарегистрированным в корпоративных каталогах (например, в доменных службах Active Directory).

Можно также добавить к пространству имен правила, определяющие, какие утверждения отправляются в приложение для обработки с помощью бизнес-логики приложения.

Чтобы продолжить изучение функций ACS и поэкспериментировать с другими сценариями, см. раздел [Служба Access Control 2.0].


  [Что такое ACS?]: #what-is
  [Основные понятия]: #concepts
  [Предварительные требования]: #pre
  [Создание приложения ASP.NET MVC]: #create-web-app
  [Создание пространства имен Access Control]: #create-namespace
  [Интеграция веб-приложения с ACS]: #Identity-Access
  [Тестирование интеграции с ACS]: #Test-ACS
  [Просмотр приложения на портале управления ACS]: acs-portal
  [Добавление поставщика удостоверений]: #add-IP
  [Что дальше?]: #whats-next
  [vcsb]: #bkmk_viewClaims
  [vpp]: #bkmk_VP

  [Служба Access Control 2.0]: http://go.microsoft.com/fwlink/?LinkID=212360
  [Средство идентификации и доступа]: http://go.microsoft.com/fwlink/?LinkID=245849
  [Портал управления Windows Azure]: http://manage.WindowsAzure.com

  [0]: ./media/active-directory-dotnet-how-to-use-access-control/acs-01.png
  [1]: ./media/active-directory-dotnet-how-to-use-access-control/acsCreateNamespace.png
  [2]: ./media/active-directory-dotnet-how-to-use-access-control/acsQuickCreate.png
  [3]: ./media/active-directory-dotnet-how-to-use-access-control/rzMvc.png
  [4]: ./media/active-directory-dotnet-how-to-use-access-control/rzIA.png
[44]: ./media/active-directory-dotnet-how-to-use-access-control/rzPT.png
 [444]: ./media/active-directory-dotnet-how-to-use-access-control/rzC.png
  [5]: ./media/active-directory-dotnet-how-to-use-access-control/acsIdAndAccess1.png
  [6]: ./media/active-directory-dotnet-how-to-use-access-control/acsMSFTAcct.png
  [66]: ./media/active-directory-dotnet-how-to-use-access-control/rzAv.png
  [666]: ./media/active-directory-dotnet-how-to-use-access-control/rzCl.png
  [7]: ./media/active-directory-dotnet-how-to-use-access-control/acsSignIn.png
  [8]: ./media/active-directory-dotnet-how-to-use-access-control/acsClickManage.png
  [9]: ./media/active-directory-dotnet-how-to-use-access-control/acsACSPortal.png
  [10]: ./media/active-directory-dotnet-how-to-use-access-control/acsRPPage.png
  [11]: ./media/active-directory-dotnet-how-to-use-access-control/acsEdit-RP.png
  [12]: ./media/active-directory-dotnet-how-to-use-access-control/acsEdit-RP2.png
  [13]: ./media/active-directory-dotnet-how-to-use-access-control/acsAdd-Idp.png
  [14]: ./media/active-directory-dotnet-how-to-use-access-control/acsAdd-Google.png
  [15]: ./media/active-directory-dotnet-how-to-use-access-control/acsSave-Google.png
  [16]: ./media/active-directory-dotnet-how-to-use-access-control/acsIdAndA-after.png
  [17]: ./media/active-directory-dotnet-how-to-use-access-control/acsConfigAcsNamespace.png
  [18]: ./media/active-directory-dotnet-how-to-use-access-control/acsManagementService.png
  [19]: ./media/active-directory-dotnet-how-to-use-access-control/acsShowKey.png
  [20]: ./media/active-directory-dotnet-how-to-use-access-control/acsConfigAcsNamespace2.png


