---
title: Действия политик Azure
description: Определения политик Azure содержат различные действия, влияющие на управление соответствием требованиям и отчеты о нем.
services: azure-policy
author: DCtheGeek
ms.author: dacoulte
ms.date: 05/24/2018
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: mvc
ms.openlocfilehash: 23bbbe9cf86268f93ae1f8fcec9303efa8a673de
ms.sourcegitcommit: 6116082991b98c8ee7a3ab0927cf588c3972eeaa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/05/2018
ms.locfileid: "34796722"
---
# <a name="understanding-policy-effects"></a>Действия политик

Каждое определение политики в службе "Политика Azure" содержит одно действие, определяющее, что происходит во время сканирования при оценке сегмента **if** правила политики для сканируемого ресурса. Действия также могут по-разному влиять на новые, обновленные и имеющиеся ресурсы.

В настоящее время в определении политики поддерживается пять действий:

- Append
- Audit
- AuditIfNotExists
- Deny
- DeployIfNotExists

## <a name="order-of-evaluation"></a>Порядок оценки

При отправке запроса на создание или обновление ресурса через Azure Resource Manager политика обрабатывает несколько действий, прежде чем передавать запрос соответствующему поставщику ресурсов.
Благодаря этому поставщик ресурсов не будет выполнять обработку, если ресурс не соответствует правилам управления, установленным в службе "Политика Azure". Политика создает список всех назначенных (через отдельную политику или инициативы) определений, применяемых по области (кроме исключений) к ресурсу и готовится к оценке ресурса согласно каждому определению.

- Действие **Append** (добавление) оценивается первым. При добавлении запрос может измениться, а внесенное изменение может отменить вызов действия аудита или запрета.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- Затем оценивается действие **Audit** (аудит), после чего запрос отправляется поставщику ресурсов.

Когда запрос предоставляется поставщику ресурсов, а тот возвращает код состояния успешного выполнения, оцениваются действия **AuditIfNotExists** и **DeployIfNotExists**, чтобы определить, требуется ли последующее ведение журнала соответствия или другие дополнительные действия.

## <a name="append"></a>Добавить

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Оно может быть полезно для добавления тегов к таким ресурсам, как costCenter, или указания разрешенных IP-адресов для ресурса хранилища.

### <a name="append-evaluation"></a>Оценка добавления

Как упоминалось выше, добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос.

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [определению политики](policy-definition.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1. Одна пара **поле/значение** для добавления тега.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "tags.myTag",
        "value": "myTagValue"
    }]
}
```

Пример 2. Несколько пар **поле/значение** для добавления набора тегов.

```json
"then": {
    "effect": "append",
    "details": [{
            "field": "tags.myTag",
            "value": "myTagValue"
        },
        {
            "field": "tags.myOtherTag",
            "value": "myOtherTagValue"
        }
    ]
}
```

Пример 3. Одна пара **поле/значение** с использованием [псевдонима](policy-definition.md#aliases) с массивом **value** для установки правил IP-адресов для учетной записи хранения.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

## <a name="deny"></a>Запрет

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие нужным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении ресурса запрет останавливает запрос до его отправки поставщику ресурсов. Запрос возвращает код 403 (запрещено). На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено".

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием запрета, отмечаются как несоответствующие, но с ними не выполняется никаких действий.

### <a name="deny-properties"></a>Свойства запрета

Действие запрета не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="deny-example"></a>Пример запрета

Пример: использование действия запрета.

```json
"then": {
    "effect": "deny"
}
```

## <a name="audit"></a>Аудит

Действие аудита используется для создания предупреждения в журнале аудита при оценке несоответствующего ресурса, но оно не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Действие аудита выполняется последним при создании или обновлении ресурса, прежде чем он отправляется поставщику ресурсов. Аудит одинаково работает для запросов ресурсов и цикла оценки. При этом в журнале действий выполняется операция `Microsoft.Authorization/policies/audit/action`. В обоих случаях ресурс отмечается как несоответствующий.

### <a name="audit-properties"></a>Свойства аудита

Действие аудита не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="audit-example"></a>Пример аудита

Пример: использование действия аудита.

```json
"then": {
    "effect": "audit"
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Действие AuditIfNotExists позволяет выполнять аудит ресурса, соответствующего условию **if**, но не содержит компонентов, указываемых в свойстве **details** условия **then**.

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление ресурса и возвращает код состояния, указывающий на успешное выполнение. Это действие вызывается только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. При вызове этого действия, как и во время аудита, в журнале действий выполняется операция `Microsoft.Authorization/policies/audit/action`. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример: оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deployifnotexists"></a>DeployIfNotExists

Как и AuditIfNotExists, действие DeployIfNotExists выполняет шаблон развертывания при соблюдении условия.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

Действие DeployIfNotExists также выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление ресурса и возвращает код состояния, указывающий на успешное выполнение. Это действие вызывается только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. При активации действия выполняется шаблон развертывания.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий.

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **details** действия DeployIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления и шаблон развертывания.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **Deployment** [обязательный]
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример: оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для его включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="layering-policies"></a>Наложение политик

На ресурс могут влиять несколько назначений. Эти назначения могут относиться к одной и той же области (определенному ресурсу, группе ресурсов, подписке или группе управления) либо к разным областям. Для этих назначений наверняка будут назначены разные действия. В любом случае условие и действие каждой политики (назначенной напрямую или в составе инициативы) оцениваются независимо. Допустим, политика 1 содержит условие, запрещающее создавать подписку А в регионе westus с помощью действия запрета, а политика 2 запрещает создавать ресурсы из группы ресурсов Б (входящей в подписку А) в регионе eastus. Обоим политикам назначено действие аудита. Результаты будут следующими:

- Любой ресурс, уже входящий в группу ресурсов Б и находящийся в регионе eastus, соответствует политике 2, но отмечается как не соответствующий политике 1.
- Любой ресурс, уже входящий в группу Б, но не расположенный в регионе eastus, будет отмечен как не соответствующий политике 2. Кроме того, он не будет соответствовать политике 1, если не находится в регионе westus.
- Любой новый ресурс в подписке А, не расположенный в регионе westus, будет отклонен политикой 1.
- Любой новый ресурс в подписке А или группе ресурсов Б, расположенный в регионе westus, будет обозначен как не соответствующий политике 2, но будет создан (так как он соответствует политике 1, а политика 2 вызывает аудит, а не запрет).

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом:

- Любой ресурс, уже входящий в группу ресурсов Б, но не расположенный в регионе eastus, отмечается как не соответствующий политике 2.
- Любой ресурс, уже входящий в группу ресурсов Б, но не расположенный в регионе westus, отмечается как не соответствующий политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе westus, будет отклонен политикой 1.
- Любой новый ресурс в подписке А или группе ресурсов Б будет отклонен (так как его расположение не может соответствовать обеим политикам).

Каждое назначение оценивается отдельно, поэтому ресурс не может обойти все политики из-за различий в области действия. Следовательно, общий результат наложения или перекрывания политик считается **накопительным по принципу максимальной строгости**. Другими словами, ресурс, который требуется создать, может быть заблокирован в связи с перекрывающимися и конфликтующими политиками, как в приведенном выше примере, если в обеих политиках используется действие запрета. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что политики влияют на правильные области.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы лучше понимаете действия определений политик, ознакомьтесь с примерами политик:

- См. другие [примеры шаблонов для службы "Политика Azure"](json-samples.md).
