---
title: Использование службы "Политика Azure" для создания политик и управления ими, чтобы обеспечить соответствие требованиям организации
description: Использование Политики Azure для обеспечения соблюдения стандартов, соответствия нормам и требованиям аудита, контроля затрат, обеспечения безопасности и согласованности производительности, а также установки корпоративных принципов проектирования.
services: azure-policy
author: DCtheGeek
ms.author: dacoulte
ms.date: 07/13/2018
ms.topic: tutorial
ms.service: azure-policy
ms.custom: mvc
manager: carmonm
ms.openlocfilehash: b8ac93da2f0dd4099ab1aa2df93e5d979ecdd285
ms.sourcegitcommit: 7208bfe8878f83d5ec92e54e2f1222ffd41bf931
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/14/2018
ms.locfileid: "39049750"
---
# <a name="create-and-manage-policies-to-enforce-compliance"></a>Создание политик и управление ими для обеспечения соответствия требованиям

Понимание того, как создавать политики и управлять ими в Azure, важно для обеспечения соответствия корпоративным стандартам и соглашениям об уровне обслуживания. В этом руководстве вы научитесь использовать службу "Политика Azure" для выполнения некоторых общих задач, связанных с созданием, назначением и управлением политиками в вашей организации, таких как:

> [!div class="checklist"]
> - Назначение политики для применения условий для ресурсов, которые вы создадите в будущем.
> - Создание и назначение определения инициативы для отслеживания соответствия нескольких ресурсов.
> - Обход запрета на создание несоответствующих или отклоненных ресурсов.
> - Внедрение новой политики в организации.

В кратких руководствах вы можете узнать, как назначить политику, чтобы определить текущее состояние соответствия имеющихся ресурсов. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="assign-a-policy"></a>Назначение политики

Первым шагом для обеспечения соответствия Политике Azure является назначение определения политики. Определение политики определяет, при каких условиях применяется политика и какой результат это даст. В этом примере назначается встроенное определение политики, называемое *Требовать SQL Server версии 12.0*, чтобы обеспечить соответствие всех баз данных SQL Server версии 12.0.

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

   ![Поиск политики](media/create-manage-policy/search-policy.png)

2. Выберите **Назначения** на странице службы "Политики Azure" слева. Назначение — это политика, которая назначена в рамках определенной области.
3. Выберите **Назначить политику** в верхней части страницы **Policy — Assignments** (Политика — назначения).

   ![Назначение определения политики](media/create-manage-policy/select-assign-policy.png)

4. На странице **Назначить политику** выберите **Область**, нажав кнопку с многоточием и выбрав подписку (обязательно) и группу ресурсов (необязательно). Она определяет, к каким ресурсам или группе ресурсов принудительно применяется назначение политики.  Теперь щелкните **Выбрать** в нижней части страницы **Область**.

   В этом примере используется **подписка Contoso**. Ваша подписка будет отличаться.

5. Если требуется исключить одну или несколько групп ресурсов (в переделах подписки) или конкретные ресурсы в рамках группы ресурсов (или другой вариант ограничения), можно настроить **исключения** в назначении политики. Пока не указывайте ничего.

6. Выберите многоточие рядом с пунктом **Определение политики**, чтобы открыть список доступных определений. Вы можете фильтровать определение политики **Тип** по *встроенному* значению, чтобы просмотреть все политики и их описания.

7. Выберите **Требовать SQL Server версии 12.0**. Если не удается найти его прямо сейчас, введите **Требовать SQL Server** в поле поиска и нажмите клавишу ENTER или щелкните за полем поиска. Щелкните **Выбрать** в нижней части страницы **доступных определений** после того, как найдете и выберете определение политики.

   ![Поиск политики](media/create-manage-policy/select-available-definition.png)

8. **Имя назначения** автоматически заполняется выбранным именем политики, но его можно изменить. В этом примере оставьте *Требовать SQL Server версии 12.0*. При желании вы можете добавить необязательное **описание**. Описание содержит сведения о назначении этой политики.

9. Щелкните **Назначить**.

## <a name="implement-a-new-custom-policy"></a>Реализация новой пользовательской политики

Назначив определение встроенной политики, можно использовать новые возможности работы со службой "Политика Azure". Создайте пользовательскую политику, чтобы снизить расходы. Это гарантирует, что в вашей среде не могут создаваться виртуальные машины серии G. Таким образом, каждый раз, когда пользователь в вашей организации пытается создать виртуальную машину серии G, запрос отклоняется.

1. Выберите **Определения** в разделе **Разработка** в левой части страницы службы "Политика Azure".

   ![Определение на вкладке разработки](media/create-manage-policy/definition-under-authoring.png)

2. Выберите **+ Policy definition** (+ Определение политики) в верхней части страницы. При этом откроется страница **Определения политики**.
3. Заполните следующие поля:

   - Группа управления или подписка, в которой сохраняется определение политики. Выберите, нажав на кнопку с многоточием в области **Расположение определения**.

     > [!NOTE]
     > Если вы планируете применять это определение политики к нескольким подпискам, расположение должно быть группой управления, которая содержит подписки, которым вы назначите политику. То же самое верно и для определения инициативы.

   - Имя определения политики: *Require VM SKUs smaller than the G series* (Требовать номер SKU виртуальной машины меньше, чем серия G).
   - Описание того, для чего предназначено определение политики. *Это определение политики гарантирует, что все виртуальные машины, созданные в этой области, будут иметь номера SKU меньше, чем серия G, что позволяет сэкономить затраты.*
   - Выберите из имеющихся параметров или создайте категорию для этого определения политики.
   - Скопируйте следующий код JSON и обновите его в соответствии со своими потребностями.
      - параметры политики;
      - правила и условия политики — в данном случае номер SKU виртуальной машины, соответствующий серии G;
      - действие политики — в этом случае **Отменить**.

    Код JSON должен выглядеть следующим образом. Вставьте измененный код на портале Azure.

    ```json
    {
        "policyRule": {
            "if": {
                "allOf": [{
                        "field": "type",
                        "equals": "Microsoft.Compute/virtualMachines"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/sku.name",
                        "like": "Standard_G*"
                    }
                ]
            },
            "then": {
                "effect": "deny"
            }
        }
    }
    ```

    Для свойства *field* в правиле политики необходимо задать одно из следующих значений: "Имя", "Тип", "Расположение", "Теги" или "Псевдоним". Вот пример псевдонима: `"Microsoft.Compute/VirtualMachines/Size"`.

    Больше примеров по службе "Политика Azure" см. в статье [Templates for Azure Policy](json-samples.md) (Шаблоны для службы "Политика Azure").

4. Щелкните **Сохранить**.

## <a name="create-a-policy-definition-with-rest-api"></a>Создание определения политики с использованием REST API

Для создания политики вы можете использовать REST API для определений политик. API REST позволяет создавать и удалять определения политик и получать сведения о существующих определениях.
Чтобы создать определение политики, используйте следующий пример.

```http-interactive
PUT https://management.azure.com/subscriptions/{subscription-id}/providers/Microsoft.authorization/policydefinitions/{policyDefinitionName}?api-version={api-version}
```

Добавьте текст запроса. Ниже приведен соответствующий пример.

```json
{
    "properties": {
        "parameters": {
            "allowedLocations": {
                "type": "array",
                "metadata": {
                    "description": "The list of locations that can be specified when deploying resources",
                    "strongType": "location",
                    "displayName": "Allowed locations"
                }
            }
        },
        "displayName": "Allowed locations",
        "description": "This policy enables you to restrict the locations your organization can specify when deploying resources.",
        "policyRule": {
            "if": {
                "not": {
                    "field": "location",
                    "in": "[parameters('allowedLocations')]"
                }
            },
            "then": {
                "effect": "deny"
            }
        }
    }
}
```

## <a name="create-a-policy-definition-with-powershell"></a>Создание определения политики с помощью PowerShell

Прежде чем продолжить работу с примером PowerShell, убедитесь, что у вас установлена последняя версия Azure PowerShell. Параметры политики были добавлены в версии 3.6.0. Если установлена более ранняя версия, примеры возвращают ошибку из-за того, что параметр не найден.

Определение политики можно создать с помощью командлета `New-AzureRmPolicyDefinition`.

Чтобы создать определение политики из файла, передайте путь в файл. Для внешнего файла используйте следующий пример.

```azurepowershell-interactive
$definition = New-AzureRmPolicyDefinition `
    -Name 'denyCoolTiering' `
    -DisplayName 'Deny cool access tiering for storage' `
    -Policy 'https://raw.githubusercontent.com/Azure/azure-policy-samples/master/samples/Storage/storage-account-access-tier/azurepolicy.rules.json'
```

Для применения локального файла используйте следующий пример.

```azurepowershell-interactive
$definition = New-AzureRmPolicyDefinition `
    -Name 'denyCoolTiering' `
    -Description 'Deny cool access tiering for storage' `
    -Policy 'c:\policies\coolAccessTier.json'
```

Для создания определения политики с помощью встроенного правила используйте следующий пример.

```azurepowershell-interactive
$definition = New-AzureRmPolicyDefinition -Name 'denyCoolTiering' -Description 'Deny cool access tiering for storage' -Policy '{
    "if": {
        "allOf": [{
                "field": "type",
                "equals": "Microsoft.Storage/storageAccounts"
            },
            {
                "field": "kind",
                "equals": "BlobStorage"
            },
            {
                "field": "Microsoft.Storage/storageAccounts/accessTier",
                "equals": "cool"
            }
        ]
    },
    "then": {
        "effect": "deny"
    }
}'
```

Выходные данные сохраняются в объекте `$definition`, который используется при назначении политики.
В следующем примере создается определение политики, которое включает параметры:

```azurepowershell-interactive
$policy = '{
    "if": {
        "allOf": [{
                "field": "type",
                "equals": "Microsoft.Storage/storageAccounts"
            },
            {
                "not": {
                    "field": "location",
                    "in": "[parameters(''allowedLocations'')]"
                }
            }
        ]
    },
    "then": {
        "effect": "Deny"
    }
}'

$parameters = '{
    "allowedLocations": {
        "type": "array",
        "metadata": {
            "description": "The list of locations that can be specified when deploying storage accounts.",
            "strongType": "location",
            "displayName": "Allowed locations"
        }
    }
}'

$definition = New-AzureRmPolicyDefinition -Name 'storageLocations' -Description 'Policy to specify locations for storage accounts.' -Policy $policy -Parameter $parameters
```

### <a name="view-policy-definitions-with-powershell"></a>Просмотр определений политики с помощью PowerShell

Чтобы просмотреть все определения политик в подписке, используйте приведенную ниже команду.

```azurepowershell-interactive
Get-AzureRmPolicyDefinition
```

Она возвращает все доступные определения политик, включая встроенные политики. Каждая политика возвращается в приведенном ниже формате.

```
Name               : e56962a6-4747-49cd-b67b-bf8b01975c4c
ResourceId         : /providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c
ResourceName       : e56962a6-4747-49cd-b67b-bf8b01975c4c
ResourceType       : Microsoft.Authorization/policyDefinitions
Properties         : @{displayName=Allowed locations; policyType=BuiltIn; description=This policy enables you to
                     restrict the locations your organization can specify when deploying resources. Use to enforce
                     your geo-compliance requirements.; parameters=; policyRule=}
PolicyDefinitionId : /providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c
```

## <a name="create-a-policy-definition-with-azure-cli"></a>Создание определения политики с использованием Azure CLI

Определение политики можно создать с помощью Azure CLI, выполнив в нем команду определения политики.
Для создания определения политики с помощью встроенного правила используйте следующий пример.

```azurecli-interactive
az policy definition create --name 'denyCoolTiering' --description 'Deny cool access tiering for storage' --rules '{
    "if": {
        "allOf": [{
                "field": "type",
                "equals": "Microsoft.Storage/storageAccounts"
            },
            {
                "field": "kind",
                "equals": "BlobStorage"
            },
            {
                "field": "Microsoft.Storage/storageAccounts/accessTier",
                "equals": "cool"
            }
        ]
    },
    "then": {
        "effect": "deny"
    }
}'
```

### <a name="view-policy-definitions-with-azure-cli"></a>Просмотр определений политики с помощью Azure CLI

Чтобы просмотреть все определения политик в подписке, используйте приведенную ниже команду.

```azurecli-interactive
az policy definition list
```

Она возвращает все доступные определения политик, включая встроенные политики. Каждая политика возвращается в приведенном ниже формате.

```json
{
    "description": "This policy enables you to restrict the locations your organization can specify when deploying resources. Use to enforce your geo-compliance requirements.",
    "displayName": "Allowed locations",
    "id": "/providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c",
    "name": "e56962a6-4747-49cd-b67b-bf8b01975c4c",
    "policyRule": {
        "if": {
            "not": {
                "field": "location",
                "in": "[parameters('listOfAllowedLocations')]"
            }
        },
        "then": {
            "effect": "Deny"
        }
    },
    "policyType": "BuiltIn"
}
```

## <a name="create-and-assign-an-initiative-definition"></a>Создание определения инициативы и его назначение

С помощью определения инициативы вы можете сгруппировать несколько определений политики для достижения одной ключевой цели. Определение инициативы создается, чтобы гарантировать, что ресурсы в рамках определения будут соответствовать определениям политики, которые составляют определение инициативы.  Дополнительные сведения об определениях инициативы см. в статье [What is Azure Policy?](azure-policy-introduction.md) (Что такое служба "Политика Azure"?).

### <a name="create-an-initiative-definition"></a>Создание определения инициативы

1. Выберите **Определения** в разделе **Разработка** в левой части страницы службы "Политика Azure".

   ![Выбор определений](media/create-manage-policy/select-definitions.png)

2. Выберите **+ Initiative Definition** (+ Определение инициативы) в верхней части страницы, чтобы открыть страницу **Initiative definition** (Определение инициативы).

   ![Определение инициативы](media/create-manage-policy/initiative-definition.png)

3. Используйте кнопку с многоточием в области **Расположение определения**, чтобы выбрать подписку для хранения определения.

4. Введите **имя** и **описание** инициативы.

   В этом примере необходимо, чтобы ресурсы соответствовали определениям политики безопасности. Название инициативы — **Защита**, а описание — **Эта инициатива была создана для обработки всех определений политик, связанных с защитой ресурсов**.

5. Для **категории** выберите из имеющихся параметров или создайте категорию.

6. Просмотрите список **доступных определений** (правая половина страницы **Initiative definition** (Определение инициативы)) и выберите определения политики, которые вы хотите добавить к этой инициативе. Для инициативы **Защита** добавьте следующие встроенные определения политик, щелкнув **+** рядом с информацией об определении политики или щелкнув строку определения политики и параметр **+ Add** (+ Добавить) на странице сведений:
   - Require SQL Server version 12.0;
   - [Preview]: Monitor unprotected web applications in Security Center.
   - [Preview]: Monitor permissive network across in Security Center.
   - [Preview]: Monitor possible app Whitelisting in Security Center.
   - [Preview]: Monitor unencrypted VM Disks in Security Center.

   После выбора определения политики из списка оно появится в разделе **Policies and parameters** (Политики и параметры).

   ![Определения инициативы](media/create-manage-policy/initiative-definition-2.png)

7. Выберите команду **Сохранить**.

### <a name="assign-an-initiative-definition"></a>Назначение определения инициативы

1. Выберите **Определения** в разделе **Разработка** в левой части страницы службы "Политика Azure".
2. Найдите ранее созданное определение инициативы **Защита** и выберите его.
3. Выберите **Назначить** в верхней части страницы, чтобы открыть страницу **Get Secure: Assign Initiative** (Защита: назначение инициативы).

   ![Назначение определения](media/create-manage-policy/assign-definition.png)

   Кроме того, можно щелкнуть выбранную строку правой кнопкой мыши или щелкнуть многоточие в конце строки левой кнопкой для отображения контекстного меню.  Затем выберите **Назначить**.

   ![Щелкните правой кнопкой мыши строку](media/create-manage-policy/select-right-click.png)

4. Заполните страницу **Get Secure: Assign Initiative** (Защита: назначение инициативы), указав сведения, приведенные в примере ниже. Вы можете использовать собственные сведения.

   - Область. Подписка с сохраненной инициативой будет использоваться по умолчанию.  Вы можете изменить область для назначения инициативы группе ресурсов в расположении, в котором сохранена подписка.
   - Исключения. Настройте все ресурсы в области, чтобы назначение инициативы не применялось к ним.
   - Определение инициативы и имя назначения. Защита (предварительно указывается в качестве имени назначаемой инициативы).
   - Описание. Это назначение инициативы предназначено для принудительного применения группы определений политики.

5. Щелкните **Назначить**.

## <a name="exempt-a-non-compliant-or-denied-resource-using-exclusion"></a>Исключение несоответствующих или отклоненных ресурсов

Когда вы назначите определение политики для запроса SQL Server версии 12.0, попытка создать SQL Server другой версии будет отклоняться. В этом разделе вы решите проблему с отклоненной попыткой создания SQL Server. Для этого потребуется создать исключение для одной группы ресурсов. Исключение предотвращает принудительное применение политики (или инициативы) к этому ресурсу. В следующем примере в одной группе ресурсов может использоваться SQL Server любой версии. Исключение можно применять к группе ресурсов. Вы также можете сузить область применения исключения отдельными ресурсами.

Развертывание, запрещенное из-за назначенной политики или инициативы, можно просматривать в двух расположениях:

- В группе ресурсов, для которой предназначено развертывание. Выберите **Развертывания** в левой части страницы и щелкните **имя** неудачного развертывания. Исключенный ресурс отобразится с состоянием _Запрещено_. Чтобы определить политику или инициативу и назначение, отклонившее ресурс, щелкните **Сбой. Щелкните здесь, чтобы узнать больше ->** на странице Deployment Overview (Общие сведения о развертывании). В правой части страницы откроется окно со сведениями об ошибке. В разделе **Сведения об ошибке** будут идентификаторы GUID связанных объектов политики.

   ![Развертывание отклонено назначением политики](media/create-manage-policy/rg-deployment-denied.png)

- На странице службы "Политика Azure". Выберите **Соответствие** в левой части страницы и щелкните политику **Требуется SQL Server версии 12.0**. На открывшейся странице вы увидите, что значение счетчика **Запретить** увеличилось. На вкладке **События** вы также увидите, кто предпринял попытку развертывания, отклоненного политикой.

   ![Общие сведения о соответствии назначенной политики](media/create-manage-policy/compliance-overview.png)

В этом примере Трент Бейкер, один из старших специалистов Contoso по виртуализации, проделал требуемую работу. Необходимо предоставить ему исключения, но мы не хотим, чтобы версия SQL Server, отличная от 12.0, использовалась в любой группе ресурсов. Мы создали группу ресурсов, **SQLServers_Excluded** и предоставим ей исключение для этого назначения политики.

### <a name="update-assignment-with-exclusion"></a>Обновление назначения с исключением

1. Выберите **Назначения** в разделе **Разработка** в левой части страницы службы "Политика Azure".
2. Просмотрите все назначения политик и откройте назначение *Require SQL Server version 12.0* (Требовать наличия SQL Server версии 12.0).
3. Задайте **исключение**, щелкнув многоточие и выбрав группу ресурсов для исключения, в этом примере *SQLServers_Excluded*.

   ![Исключение запроса](media/create-manage-policy/request-exclusion.png)

   > [!NOTE]
   > В зависимости от политики и ее результата можно предоставить исключение определенным ресурсам в рамках группы ресурсов внутри области назначения. Нецелесообразно задавать исключение для определенного имеющегося ресурса в виду того, что в этом руководстве использовался эффект **отклонения**.

4. Нажмите кнопку **Выбрать**, а затем щелкните **Сохранить**.

В этом разделе вы решили проблему с отклоненной попыткой создания SQL Server запрещенной версии, создав исключение для одной группы ресурсов.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы завершили работу с ресурсами по этому руководству, следуйте инструкциям ниже, чтобы удалить все созданные назначения или определения:

1. Выберите **Определения** (или **Назначения**, если вы пытаетесь удалить назначение) в разделе **Разработка** в левой части страницы службы "Политика Azure".
2. Найдите новую инициативу либо определение политики (или назначение), которые вы хотите удалить.
3. Щелкните строку правой кнопкой мыши или выберите многоточие в конце определения (или назначения), а затем выберите **Удалить определение** (или **Удаление назначения**).

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы успешно выполнили следующие действия:

> [!div class="checklist"]
> - назначили политику для применения условий для ресурсов, которые будут созданы в будущем;
> - создали и назначили определение инициативы для отслеживания соответствия нескольких ресурсов;
> - обошли запрет на создание несоответствующих или отклоненных ресурсов;
> - внедрили новую политику в организации.

Дополнительные сведения о структурах определения политик см. в статье:

> [!div class="nextstepaction"]
> [Структура определения политики Azure](policy-definition.md)