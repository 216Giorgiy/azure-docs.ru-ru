<properties 
	pageTitle="Использование соединителя SaaS из кода" 
	description="Узнайте, как настраивается соединитель SaaS, устанавливаемый в подписке Azure из Azure Marketplace." 
	services="app-service\api" 
	documentationCenter=".net" 
	authors="tdykstra" 
	manager="wpickett" 
	editor="jimbe"/>

<tags 
	ms.service="app-service-api" 
	ms.workload="web" 
	ms.tgt_pltfrm="dotnet" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/07/2015" 
	ms.author="tdykstra"/>

# Использование соединителя SaaS из кода

## Обзор

В этом учебнике показывается, как установить, настроить и проверить [соединитель «программное обеспечение как услуга» (SaaS)](app-service-logic-what-are-bizTalk-api-apps.md) в [службе приложений Azure](/documentation/services/app-service/) для его вызова программными средствами, например из мобильного приложения. Соединитель SaaS — это [приложение API](app-service-api-apps-why-best-platform.md), которое упрощает взаимодействие с платформой SaaS, такой как Office 365, Salesforce, Facebook и Dropbox.

Например, если требуется кодировать HTTP-запросы на чтение и запись файлов в вашей учетной записи Dropbox, процесс проверки подлинности для работы непосредственно с Dropbox довольно сложен. Соединитель Dropbox берет на себя всю сложность проверки подлинности, так что вы можете заниматься только созданием кода, относящегося к вашим конкретным бизнес-процессам.

> [AZURE.WARNING]Приведенные здесь инструкции ***не* должны применяться, если вы хотите использовать соединитель SaaS из приложения логики**. Подробные сведения об использовании соединителей SaaS в приложениях логики см. в разделе [Создание приложений логики](app-service-logic-create-a-logic-app.md). Эта статья предназначена для тех, кто хочет использовать *код* для вызова соединителя.
 
В этом учебнике в качестве примера используется соединитель DropBox и подробно описываются следующие действия.

* Установка соединителя Dropbox в [группу ресурсов](resource-group-overview.md) в подписке Azure. 
* Настройка соединителя Dropbox, чтобы он мог подключаться к службе Dropbox. (Для выполнения этого шага потребуется учетная запись Dropbox.)
* Настройка группы ресурсов, чтобы только прошедшие проверку подлинности пользователи могли обращаться к приложениям API, включенным в эту группу ресурсов.
* Тестирование для проверки функционирования проверки подлинности пользователей и проверки подлинности Dropbox.

## Установка соединителя Dropbox

1. Перейдите на домашнюю страницу [портала предварительной версии Azure] и щелкните **Marketplace**.

	![Marketplace на портале предварительной версии Azure](./media/app-service-api-connect-your-app-to-saas-connector/marketplace.png)

2. Найдите Dropbox и щелкните значок **соединителя Dropbox**.

	![Щелкните соединитель Dropbox](./media/app-service-api-connect-your-app-to-saas-connector/searchdb.png)
 
3. Щелкните **Создать**.

	![Нажмите кнопку "Создать"](./media/app-service-api-connect-your-app-to-saas-connector/clickcreate.png)
 
5. В колонке **Соединитель Dropbox** в разделе **План службы приложений** щелкните **Создать новый**, а затем в поле **Создать новый план службы приложений** введите DropBoxPlan.

	Дополнительные сведения о планах службы приложений см. в разделе [Подробный обзор планов службы приложений Azure](azure-web-sites-web-hosting-plans-in-depth-overview.md).

4. В разделе **Группа ресурсов** нажмите **Создать**, а затем в поле **Создать новую группу ресурсов** введите DropboxRG.

	Дополнительные сведения о группах ресурсов см. в разделе [Использование групп ресурсов для управления ресурсами Azure](resource-group-overview.md).

7. Выберите бесплатную **ценовую категорию**. (Если вы не видите ее в списке, нажмите кнопку **Просмотреть все**. Щелкните вариант **F1 бесплатно** и нажмите кнопку **Выбрать**.)

	Вы можете использовать платную ценовую категорию, но для данного учебника это не требуется.
 
11. Выберите **расположение** рядом с вами.

9. <a id="gateway"></a>Оставьте значение по умолчанию DropboxConnector в качестве **имени** соединителя и нажмите кнопку **Создать**.

	![Нажмите «Создать».](./media/app-service-api-connect-your-app-to-saas-connector/createdropbox.png)

	Служба приложений Azure создает группу ресурсов, а затем создает в этой группе ресурсов приложение API соединителя Dropbox и веб-приложение *шлюза*. Функции шлюза — управление доступом ко всем приложениям API в этой группе ресурсов.

	Чтобы проверить ход выполнения создания ресурсов, щелкните элемент **Уведомления** на домашней странице портала предварительной версии Azure.

3. Когда Azure завершит создание соединителя, последовательно выберите пункты **Обзор > Группы ресурсов > DropboxRG**.
 
	В колонке **Группа ресурсов** для DropboxRG появится соединитель и шлюз в этой группе ресурсов.

	![Схема группы ресурсов](./media/app-service-api-connect-your-app-to-saas-connector/rgdiagram.png)

## Настройка учетной записи Dropbox и соединителя Dropbox

Чтобы включить доступ API к вашей учетной записи Dropbox, необходимо создать приложение Dropbox на веб-сайте разработчика Dropbox. Затем скопируйте значения идентификатора клиента и секрета клиента из этого приложения Dropbox в ваш соединитель Dropbox и задайте в соединителе прием только запросов, прошедших проверку подлинности.

### Создание приложения Dropbox

Следующие шаги показывают процесс создания приложения Dropbox с помощью веб-сайта Dropbox.com. Поскольку веб-сайт Dropbox.com может изменяться без уведомления, вы можете заметить, что показанный здесь пользовательский интерфейс отличается от существующего на этом веб-сайте.

1. Перейдите на [портал разработчика Dropbox](https://www.dropbox.com/developers/apps), щелкните элемент **Консоль приложений** и выберите **Создать приложение**.

	![Создание приложения Dropbox](./media/app-service-api-connect-your-app-to-saas-connector/dbappcreate.png)

2. Выберите пункт **Приложение API Dropbox** и настройте другие параметры.
 
	С помощью параметров доступа к файлам, показанным на снимке экрана ниже, можно протестировать доступ к учетной записи Dropbox с помощью простого запроса HTTP Get, если в вашей учетной записи имеются какие-либо файлы.

	Имя приложения API Dropbox может быть любым, которое будет принимать сайт Dropbox.

3. Нажмите **Создать приложение**.

	![Создание приложения Dropbox](./media/app-service-api-connect-your-app-to-saas-connector/dbapiapp.png)

	На следующей странице отображаются параметры ключа и секрета приложения (с именами «Идентификатор клиента» и «Секрет клиента» в Azure), которые используются для настройки соединителя Dropbox Azure.

	На этой странице также имеется поле, где можно ввести URI перенаправления, значение которого вы получите в следующем разделе.

	![Создание приложения Dropbox](./media/app-service-api-connect-your-app-to-saas-connector/dbappsettings.png)

### Копирование параметров приложения Dropbox в соединитель Dropbox Azure и наоборот 

4. В другом окне или вкладке браузера перейдите на [портал предварительной версии Azure].

3. Перейдите в колонку **приложения API** для вашего соединителя Dropbox. (Если вы все еще находитесь в колонке **Группа ресурсов**, просто щелкните соединитель Dropbox на диаграмме.)

4. Щелкните пункт **Параметры**, и в колонке **Параметры** выберите пункт **Проверка подлинности**.

	![Щелкните «Параметры».](./media/app-service-api-connect-your-app-to-saas-connector/clicksettings.png)

	![Щелкните «Проверка подлинности».](./media/app-service-api-connect-your-app-to-saas-connector/clickauth.png)

5. В колонке «Проверка подлинности» введите идентификатор клиента и секрет клиента с сайта Dropbox и нажмите кнопку **Сохранить**.

	![Введите параметры и нажмите «Сохранить».](./media/app-service-api-connect-your-app-to-saas-connector/authblade.png)

3. Скопируйте значение **URI перенаправления** (серое поле над идентификатором клиента и секретом клиента) и добавьте это значение на страницу, которую оставили открытой на предыдущем шаге.

	URI перенаправления соответствует следующему шаблону:

		[gatewayurl]/api/consent/redirect/[connectorname]

	Например:

		https://dropboxrgaeb4ae60b7.azurewebsites.net/api/consent/redirect/DropboxConnector

	![Получение URI перенаправления](./media/app-service-api-connect-your-app-to-saas-connector/redirecturi.png)

	![Создание приложения Dropbox](./media/app-service-api-connect-your-app-to-saas-connector/dbappsettings2.png)

### Установка в соединителе Dropbox требования доступа с проверкой подлинности

По умолчанию **уровень доступа** соединителя установлен как **внутренний**, что означает, что он может вызываться только другими приложениями API и веб-приложениями, находящимися в той же группе ресурсов. Однако Dropbox разрешает доступ к учетной записи Dropbox только пользователям, прошедшим проверку подлинности, поэтому нужно изменить уровень доступа, чтобы требовалась проверка подлинности пользователя.

1. Вернитесь в колонку **Параметры** и щелкните раздел **Параметры приложения**.

2. В колонке **Параметры приложения** установите для параметра **Уровень доступа** значение **Общедоступный (с проверкой подлинности)**, а затем нажмите кнопку **Сохранить**.
	
	![Установка значения «Общедоступный (с проверкой подлинности)»](./media/app-service-api-connect-your-app-to-saas-connector/pubauth.png)

Теперь вы настроили соединитель Dropbox так, что исходящие вызовы имеют доступ к вашей учетной записи Dropbox, а входящие вызовы должны быть от пользователей, прошедших проверку подлинности. В следующем разделе вы укажете, какой поставщик проверки подлинности следует использовать для проверки подлинности пользователей.

## Настройка шлюза

Как объяснялось [ранее](#gateway), шлюз — это специальное веб-приложение, управляющее доступом ко всем приложениям API в группе ресурсов. Чтобы настроить шлюз для проверки подлинности пользователей, выберите поставщик проверки подлинности, например Azure Active Directory, Google или Twitter. После этого пользователи должны будут пройти проверку подлинности в выбранном поставщике, прежде чем смогут успешно вызывать соединитель Dropbox.

- Для выполнения этого шага перейдите в раздел [Настройка шлюза](app-service-api-dotnet-add-authentication.md#configure-the-gateway) в учебнике [Защита приложения API](app-service-api-dotnet-add-authentication.md) и выполните его указания по настройке шлюза в группе ресурсов DropboxRG.

## Тестирование проверки подлинности пользователя и Dropbox

После настройки шлюза в группе ресурсов DropboxRG для использования поставщика проверки подлинности вы можете проверить свой соединитель Dropbox.

В большинстве случаев вы будете использовать соединитель путем вызова из кода и корпорация Майкрософт также предоставит учебники, в которых будет показано, как это делается. Однако иногда бывает необходимо проверить, что соединитель работает, прежде чем подключать другие части приложения. В этом учебнике показывается, как использовать веб-браузер и простое клиентское средство REST для проверки возможности взаимодействия со службой Dropbox через соединитель Dropbox, который вы только что установили и настроили.

Следующие инструкции демонстрируют, как выполнить эти действия с помощью средств разработчика браузера Chrome и клиентского средства Postman (почтальон) REST. Это только лишь пример, и вы можете выполнять те же процедуры, используя другие браузеры и средства.

### Вход в систему от имени конечного пользователя

Выполните следующие действия в новом окне браузера. В зависимости от применяемого поставщика проверки подлинности может потребоваться использовать окно в закрытом или анонимном режиме.

2. Перейдите на URL-адрес входа для шлюза и настроенного поставщика проверки подлинности. URL-адрес соответствует следующему шаблону: 

    	http://[gatewayurl]/login/[providername]

	URL-адрес шлюза можно взять из колонки **Шлюз** на [портале предварительной версии Azure]. (Чтобы перейти в колонку **Шлюз**, щелкните шлюз на схеме, которая отображается в колонке **Группа ресурсов**.)

	![URL-адрес шлюза](./media/app-service-api-connect-your-app-to-saas-connector/gatewayurl.png)

	Параметр [Providername] имеет значение facebook для Facebook, twitter для Twitter, aad для Azure Active Directory и т. д.

	Ниже приведен пример URL-адреса входа для Azure Active Directory.

		https://dropboxrgaeb4ae60b7cb4f3d966dfa43.azurewebsites.net/login/aad/

3. Когда в браузере откроется страница для входа, введите свои учетные данные.
 
	Если вы настроили вход в Azure Active Directory, войдите как один из пользователей, перечисленных на вкладке **Пользователи** для приложения, созданного на вкладке Azure Active Directory [портала Azure], например admin@contoso.onmicrosoft.com.

	Если вход выполнен успешно, появится страница Login complete (вход выполнен).

	![](./media/app-service-api-connect-your-app-to-saas-connector/logindone.png)

### Предоставление в Dropbox удостоверения пользователя

Чтобы получить авторизацию Dropbox на использование API Dropbox, необходимо предоставить учетные данные пользователя в Dropbox. Azure будет делать это за вас, но для запуска этого процесса необходимо перейти на специальный URL-адрес в браузере. Чтобы получить этот URL-адрес, выполните запрос HTTP Post к шлюзу.

Запрос HTTP Post к шлюзу должен иметь токен проверки подлинности, предоставленный Azure при входе в систему. Для браузерных запросов этот токен включается автоматически, поскольку он хранится в файле cookie, но для запроса HTTP Post с помощью клиентского средства REST необходимо получить токен из файла cookie и поместить его в заголовке запроса HTTP Post.

1. В окне браузера с сообщением Login complete (вход выполнен) перейдите в средства разработчика браузера и найдите файл cookie `x-zumo-auth`. Не закрывайте это окно, чтобы можно было скопировать это значение из файла cookie на следующем шаге.
 
	Чтобы получить значение файла cookie в Chrome, выполните следующие действия.

	- Нажмите клавишу F12, чтобы открыть средства разработчика.
	- Перейдите на вкладку **Ресурсы**.
	- Найдите файлы cookie для сайта шлюза и трижды щелкните поле **Значение** файла cookie `x-zumo-auth` файла cookie, чтобы выбрать его полностью. (Убедитесь, что вы получили все значение файла cookie. Если щелкнуть дважды, то можно получить только первую часть значения.)  

	![Копирование токена](./media/app-service-api-connect-your-app-to-saas-connector/copytoken.png)

4. В новой вкладке или окне браузера создайте и отправьте запрос HTTP Post в шлюз для получения соответствующего URL-адреса. Включите токен `x-zumo-auth` как HTTP-заголовок.

	URL-адрес соответствует следующему шаблону:

		[gatewayurl]/api/consent/list?api-version=2015-01-14&redirecturl=[a URL you want the browser to go to after you authenticate]

	Например:

		https://dropboxrgaeb4ae60b7cb4f3d966dfa43.azurewebsites.net/api/consent/list?api-version=2015-01-14&redirecturl=https://portal.azure.com

	Чтобы отправить запрос в средство Postman в Chrome, выполните следующие действия.

	- Введите **URL-адрес запроса**, описанный выше.
	- Задайте метод **Post**.
	- Добавьте заголовок с именем `x-zumo-auth`.
	- В поле **Значение** заголовка вставьте значение, скопированное из файла cookie `x-zumo-auth`.
	- Нажмите кнопку **Отправить**.
	 
	На следующем рисунке показано средство Postman в Chrome:

	![Отправка для получения URL-адреса согласия](./media/app-service-api-connect-your-app-to-saas-connector/sendforconsent.png)

	Ответ включает URL-адрес, который должен использоваться для проверки подлинности пользователя в Dropbox. (Если вы получили ответ с сообщением об ошибке, это указывает, что метод Get не поддерживается; несмотря на то что в раскрывающемся списке установлен метод **Post**, может потребоваться использовать другое клиентское средство REST. Вы можете использовать «Расширенный клиент REST», другую надстройку Chrome.)

	![URL-адрес согласия](./media/app-service-api-connect-your-app-to-saas-connector/getconsenturl.png)

2. Перейдите на URL-адрес, полученный в ответе на запрос HTTP Post.

	Dropbox связывает ваше удостоверение пользователя с приложением API Dropbox , а затем направляет браузер на указанный URL-адрес перенаправления (например, на портал предварительной версии Azure, если вы выполняли этот пример и использовали https://portal.azure.com)).

	Поскольку ваше приложение Dropbox находится в режиме разработчика, может появиться страница входа в Dropbox, прежде чем браузер перейдет на URL-адрес перенаправления. После входа с учетными данными Dropbox удостоверение пользователя, которое использовалось для входа, связывается с приложением Dropbox, и в будущем для этого удостоверения пользователя вход в Dropbox не будет требоваться.

3. Не закрывайте это окно браузера, так как оно будет использоваться в следующем разделе.

### Вызов API соединителя Dropbox 

Теперь Azure управляет тремя вашими токенами проверки подлинности:

- одним от поставщика проверки подлинности, настроенного для шлюза, например от Azure Active Directory;
- одним от Dropbox;
- одним, созданным Azure (токеном zumo).

При выполнении HTTP-запросов для работы с Dropbox вам нужно использовать только один из них —токен zumo. За кулисами Azure связывает этот токен с двумя другими, и при выполнении вызовов в Dropbox соединитель предоставляет остальные два токена от вашего имени.

В следующих шагах вы будете выполнять запрос Get в соединитель Dropbox для просмотра файлов в вашей учетной записи Dropbox. Поскольку вы можете использовать окно браузера для запроса Get и это окно уже имеет токен zumo в файле cookie, все, что нужно сделать, — это перейти на URL-адрес, и вы получите данные Dropbox.

1. В окне браузера с открытым порталом предварительной версии Azure вернитесь в колонку **Приложение API** для соединителя Dropbox. 

2. Скопируйте URL-адрес этого приложения API.
 
4. Щелкните значок **определения API**, чтобы просмотреть методы API, доступные в этом соединителе.

	![Колонка приложения API](./media/app-service-api-connect-your-app-to-saas-connector/apiappblade.png)

	![Определение API](./media/app-service-api-connect-your-app-to-saas-connector/apidef.png)

2. В окне браузера, которое использовалось для проверки подлинности в шлюзе, вызовите метод GET, который получает имена файлов из папки. Ниже приведен шаблон URL-адреса.

		[connectorurl]/folder/[foldername]
   
3. Например, если URL-адрес соединителя https://dropboxrg784237ad3e7.azurewebsites.net и вам нужно просмотреть файлы в папке блога, URL-адрес будет следующий:

		https://dropboxrg784237ad3e7.azurewebsites.net/folder/blog

	Разные браузеры по-разному отвечают на вызовы API; если вы используете Chrome, то получите ответ, аналогичный приведенному ниже.

	![Получение ответа на запрос папки](./media/app-service-api-connect-your-app-to-saas-connector/dbresponse.png)

## Дальнейшие действия

Вы узнали, как устанавливать, настраивать и тестировать соединитель SaaS. Дополнительные сведения см. в разделе [Использование соединителей](app-service-logic-use-biztalk-connectors.md).

[портал предварительной версии Azure]: https://portal.azure.com/
[портала предварительной версии Azure]: https://portal.azure.com/
[портале предварительной версии Azure]: https://portal.azure.com/
[портала Azure]: https://manage.windowsazure.com/
<!--HONumber=54-->