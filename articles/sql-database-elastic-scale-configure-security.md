<properties title="Elastic Scale Security Configurations" pageTitle="Конфигурации безопасности гибкого масштабирования" description="Security for Split-Merge services using Elastic Scale for Azure SQL Database" metaKeywords="Elastic Scale Security Configurations, Azure SQL Database sharding, elastic scale " services="sql-database" documentationCenter="" manager="jhubbard" authors="sidneyh@microsoft.com"/>

<tags ms.service="sql-database" ms.workload="sql-database" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="10/02/2014" ms.author="sidneyh" />

# Конфигурации безопасности гибкого масштабирования  

Гибкое масштабирование базы данных SQL Microsoft Azure включает в себя резидентную службу. Дистрибутив включает в себя файл конфигурации службы, который содержит требующие настройки параметры безопасности.

1. [Настройка сертификатов][] 
2. [Разрешенные IP-адреса][]
3. [Предотвращение отказа в обслуживании][]
4. [Прочие вопросы безопасности][]

## <a name="configuring-certificates"></a>Configuring Certificates

Сертификаты настраиваются двумя способами. 

1. [Настройка SSL-сертификата][]
2. [Настройка сертификатов клиентов][] 

## <a name="obtain-certificates"></a>Получение сертификатов

Сертификаты можно получать от общих центров сертификации (ЦС) или в [Службе сертификации Windows](http://msdn.microsoft.com/ru-ru/library/windows/desktop/aa376539.aspx). Это наиболее предпочтительные способы получения сертификатов.

Если эти варианты недоступны, можно создавать **самозаверяющие сертификаты**.
 
## <a name="tools"></a>Средства создания сертификатов

* [makecert.exe](http://msdn.microsoft.com/ru-ru/library/bfsktky3.aspx)
* [pvk2pfx.exe](http://msdn.microsoft.com/ru-ru/library/windows/hardware/ff550672.aspx)

###Запуск средств

* Из командной строки разработчика для Visual Studio, см. [Командная строка Visual Studio](http://msdn.microsoft.com/ru-ru/library/ms229859.aspx) 

    Если ПО установлено, перейдите к:

        %ProgramFiles(x86)%\Windows Kits\x.y\bin\x86 

* Получение WDK из [Windows 8.1: Загрузка наборов и инструментов](http://msdn.microsoft.com/en-US/windows/hardware/gg454513#drivers)

##    <a name="to-configure-ssl-cert"></a>Настройка SSL-сертификата
SSL-сертификат требуется для шифрования при обмене данными и для проверки подлинности сервера. Выберите наиболее подходящий из этих трех сценариев и выполните все шаги.

###Создайте новый самозаверяющий сертификат

1.    [Создание самозаверяющего сертификата][]
2.    [Создание PFX-файла для самозаверяющего SSL-сертификата][]
3.    [Передать SSL-сертификат в облачную службу][]
4.    [Обновление SSL-сертификата в файле конфигурации службы][]
5.    [Импорт центра сертификации SSL][]

#### Как использовать существующий сертификат из хранилища сертификатов
1. [Экспорт SSL-сертификата из хранилища сертификатов][]
2. [Передать SSL-сертификат в облачную службу][]
3. [Обновление SSL-сертификата в файле конфигурации службы][]

#### Как использовать существующий сертификат в PFX-файле

1. [Передать SSL-сертификат в облачную службу][]
2. [Обновление SSL-сертификата в файле конфигурации службы][]

## <a name="configuring-client-certs"></a>Настройка сертификатов клиентов
Для проверки подлинности запросов к службе требуются сертификаты клиентов. Выберите наиболее подходящий из этих трех сценариев и выполните все шаги.

###Отключение сертификатов клиентов
1.    [Отключите проверку подлинности на основе сертификата клиента][]

###Выдайте самозаверяющий сертификат клиента
1.    [Создайте центр самозаверяющей сертификации][]
2.    [Передать сертификат ЦС в облачную службу][]
3.    [Обновите сертификат ЦС в файле конфигурации службы][]
4.    [Выдайте сертификаты клиентов][]
5.    [Создайте PFX-файлы для сертификатов клиентов][]
6.    [Импортируйте сертификат клиента][]
7.    [Скопируйте отпечатки сертификатов клиента][]
8.    [Настройте разрешенных клиентов в файле конфигурации службы][]

###Использование существующих сертификатов клиентов
1.    [Поиск открытого ключа ЦС][]
2.    [Передать сертификат ЦС в облачную службу][]
3.    [Обновите сертификат ЦС в файле конфигурации службы][]
4.    [Скопируйте отпечатки сертификатов клиента][]
5.    [Настройте разрешенных клиентов в файле конфигурации службы][]
6.    [Настроить проверку отзыва сертификата клиента][]

## <a name="allowed-ip-addresses"></a>Allowed IP Addresses

Access to the service endpoints can be restricted to specific ranges of IP addresses.
 
## The Default Configuration

The default configuration denies all access to the HTTP endpoint. This is the recommended setting, since the requests to these endpoints may carry sensitive information like database credentials.
The default configuration allows all access to the HTTPS endpoint. This setting may be restricted further.

### Changing the Configuration

The group of access control rules that apply to and endpoint are configured in the **<EndpointAcls>** section in the **service configuration file**.

    <EndpointAcls>
      <EndpointAcl role="SplitMergeWeb" endPoint="HttpIn" accessControl="DenyAll" />
      <EndpointAcl role="SplitMergeWeb" endPoint="HttpsIn" accessControl="AllowAll" />
    </EndpointAcls>

The rules in an access control group are configured in a <AccessControl name=""> section of the service configuration file. 

The format is explained in Network Access Control Lists documentation.
For example, to allow only IPs in the range 100.100.0.0 to 100.100.255.255 to access the HTTPS endpoint, the rules would look like this:

    <AccessControl name="Retricted">
      <Rule action="permit" description="Some" order="1" remoteSubnet="100.100.0.0/16"/>
      <Rule action="deny" description="None" order="2" remoteSubnet="0.0.0.0/0" />
    </AccessControl>
    <EndpointAcls>
    <EndpointAcl role="SplitMergeWeb" endPoint="HttpsIn" accessControl="Restricted" />

## <a name = "denial-of-service-prevention"></a>Предотвращение отказа в обслуживании

Существует два различных механизма, поддерживаемых для выявления и предотвращения атак в виде отказа в обслуживании.

*    Ограничение количества одновременных запросов на удаленный узел (по умолчанию отключено)
*    Ограничение частоты доступа в расчете на удаленный узел (включено по умолчанию)

Они основаны на функциях, более подробно документированных в Dynamic IP Security в IIS. При изменении этой конфигурации имейте в виду следующие факторы.

* Поведение прокси-серверов и устройств преобразования сетевых адресов в отношении информации удаленного хоста (узла)
* Учитывается каждый запрос к любому ресурсу в веб-роли (например, загрузки скриптов, изображений и т. д.)

## Ограничение числа одновременных обращений

Ниже перечислены параметры, с помощью которых настраивается их действие.

    <Setting name="DynamicIpRestrictionDenyByConcurrentRequests" value="false" />
    <Setting name="DynamicIpRestrictionMaxConcurrentRequests" value="20" />

Change DynamicIpRestrictionDenyByConcurrentRequests to true to enable this protection.

## Ограничение частоты доступа

Ниже перечислены параметры, с помощью которых настраивается их действие.

    <Setting name="DynamicIpRestrictionDenyByRequestRate" value="true" />
    <Setting name="DynamicIpRestrictionMaxRequests" value="100" />
    <Setting name="DynamicIpRestrictionRequestIntervalInMilliseconds" value="2000" />

## Настройка ответа на отклоненный запрос

Следующий параметр позволяет настроить ответ на отклоненный запрос.

    <Setting name="DynamicIpRestrictionDenyAction" value="AbortRequest" />
По вопросу иных поддерживаемых значений обратитесь к документации по динамической IP-безопасности в IIS.

## Операции настройки службы сертификатов
Этот раздел предназначен только для справки. Выполните этапы настройки, описанные в:

* Настройка SSL-сертификата
* Настройка сертификатов клиентов

## <a name = "create-self-signed-cert"></a>Создание самозаверяющего сертификата
Выполните:

    makecert ^
      -n "CN=myservice.cloudapp.net" ^
      -e MM/DD/YYYY ^
      -r -cy end -sky exchange -eku "1.3.6.1.5.5.7.3.1" ^
      -a sha1 -len 2048 ^
      -sv MySSL.pvk MySSL.cer

Чтобы настроить:

*    -n с URL-адресом службы. Поддерживаются подстановочные знаки ("CN=*.cloudapp.net") и альтернативные имена ("CN=myservice1.cloudapp.net, CN=myservice2.cloudapp.net").
*    -e с датой окончания срока действия сертификата
Создайте надежный пароль и введите его при появлении приглашения.

## <a name="create-pfx-for-self-signed-cert"></a>Создание PFX-файла для самозаверяющего SSL-сертификата

Выполните:

        pvk2pfx -pvk MySSL.pvk -spc MySSL.cer

Введите пароль, а затем экспортируйте сертификат с этими параметрами.
* Да, экспортировать закрытый ключ
* Экспорт всех расширенных свойств

## <a name="export-ssl-from-store"></a>Экспорт SSL-сертификата из хранилища сертификатов

* Поиск сертификата
* Выберите Действия -> Все задачи -> Экспортировать...
* Экспортируйте сертификат в .PFX-файл со следующими параметрами.
    * Да, экспортировать закрытый ключ
    * Включить, по возможности, все сертификаты в путь сертификации
    *Экспортировать все расширенные свойства

## <a name="upload-ssl"></a>Передать SSL-сертификат в облачную службу

Отправьте сертификат с существующим или созданным .PFX-файлом с помощью пары ключей SSL.

* Введите пароль, защищающий данные закрытого ключа

## <a name="update-ssl-in-csfg"></a>Обновление SSL-сертификата в файле конфигурации службы

Обновите значения отпечатка следующего параметра в файле конфигурации службы значением отпечатка сертификата, отправленного в облачную службу.

    <Certificate name="SSL" thumbprint="" thumbprintAlgorithm="sha1" />

## <a name="import-ssl-ca"></a>Импорт центра сертификации SSL

Выполните эти шаги на всех учетных записях или компьютерах, которые будут взаимодействовать со службой.

* Дважды нажмите файл .CER в проводнике Windows
* В диалоговом окне сертификата нажмите "Установить сертификат..."
* Импортируйте сертификат в хранилище доверенных корневых центров сертификации

## <a name="turn-off-client-cert"></a>Отключите проверку подлинности на основе сертификата клиента

Проверка подлинности клиента поддерживается только на основе сертификата, и ее отключение откроет общий доступ к конечным точкам службы, если только не используются другие механизмы (например, виртуальная сеть Microsoft Azure).

Присвойте этим параметрам значение false в файле конфигурации службы, если нужно отключить эту функцию.

    <Setting name="SetupWebAppForClientCertificates" value="false" />
    <Setting name="SetupWebserverForClientCertificates" value="false" />

Затем скопируйте тот же отпечаток, что и SSL-сертификат, в параметр сертификата ЦС.

    <Certificate name="CA" thumbprint="" thumbprintAlgorithm="sha1" />

## <a name="create-self-signed-ca"></a>Создайте центр самозаверяющей сертификации
Выполните следующие шаги для создания самозаверяющего сертификата, выступающего в качестве центра сертификации.

    makecert ^
    -n "CN=MyCA" ^
    -e MM/DD/YYYY ^
     -r -cy authority -h 1 ^
     -a sha1 -len 2048 ^
      -sr localmachine -ss my ^
      MyCA.cer

Как настроить

*    -e с датой окончания срока действия сертификации


## <a name="find-ca-public-key"></a>Поиск открытого ключа ЦС

Все сертификаты клиента должны быть выданы центром сертификации, уполномоченным данной службой. Найдите открытый ключ в том центре сертификации, который выдал сертификаты клиента, использование которых предусмотрено для проверки подлинности, чтобы передать его в облачную службу.

Если файл с открытым ключом недоступен, экспортируйте его из хранилища сертификатов:

* Поиск сертификата
    * Поиск сертификата клиента, выданного этим же центром сертификации
* Дважды щелкните сертификат
* Перейдите на вкладку пути сертификации в диалоговом окне сертификата
* Дважды щелкните запись ЦС в пути сертификации 
* Запишите свойства сертификата
* Закройте диалоговое окно сертификата
* Поиск сертификата
    * Найдите ЦС, записанный ранее
* Выберите Действия -> Все задачи -> Экспортировать...
* Экспортируйте сертификат в .CER с этими параметрами:
    * Нет, не экспортировать закрытый ключ
    * Включить, по возможности, все сертификаты в путь сертификации
    * Экспорт всех расширенных свойств

## <a name="upload-ca-cert"></a>Передать сертификат ЦС в облачную службу

Передайте сертификат с существующим или созданным файлом .CER при помощи открытого ключа центра сертификации.

## <a name="update-ca-in-csft"></a>Обновите сертификат ЦС в файле конфигурации службы

Обновите значения отпечатка следующего параметра в файле конфигурации службы значением отпечатка сертификата, отправленного в облачную службу.

    <Certificate name="CA" thumbprint="" thumbprintAlgorithm="sha1" />

Обновите значение следующего параметра значением того же отпечатка.

    <Setting name="AdditionalTrustedRootCertificationAuthorities" value="" />

## <a name="issue-client-certs"></a>Выдайте сертификаты клиентов

Каждое лицо, получившее разрешение на доступ к службе, должно иметь сертификат клиента, выданный для исключительного использования данным лицом. При этом такому лицу требуется выбрать надежный пароль для защиты своего закрытого ключа. 

На том же компьютере, где был создан и хранился самозаверяющий сертификат ЦС, необходимо выполнить следующие шаги.

    makecert ^
      -n "CN=My ID" ^
      -e MM/DD/YYYY ^
      -cy end -sky exchange -eku "1.3.6.1.5.5.7.3.2" ^
      -a sha1 -len 2048 ^
      -in "MyCA" -ir localmachine -is my ^
      -sv MyID.pvk MyID.cer

Настройка.

* -n с идентификатором клиента, который будет проходить проверку подлинности с этим сертификатом
* -e с датой окончания срока действия сертификата
* MyID.pvk и MyID.cer с уникальными именами файлов для этого сертификата клиента

Эта команда запросит создать пароль и однократно его использовать. Используйте надежный пароль.

## <a name="create-pfx-files"></a>Создайте PFX-файлы для сертификатов клиентов

Для каждого созданного сертификата клиента выполните следующее.

    pvk2pfx -pvk MyID.pvk -spc MyID.cer

Настройка.

    • MyID.pvk и MyID.cer с именем файла сертификата клиента

Введите пароль, а затем экспортируйте сертификат с этими параметрами.

* Да, экспортировать закрытый ключ
* Экспорт всех расширенных свойств
* Лицо, которому выдается данный сертификат, должно выбрать пароль экспорта

## <a name="import-client-cert"></a>Импортируйте сертификат клиента

Каждое лицо, которому был выдан сертификат клиента, должно импортировать пару ключей в те компьютеры, которые данное лицо будет использовать для взаимодействия со службой:

* Дважды щелкните .PFX-файл в проводнике Windows
* Импортируйте сертификат в личное хранилище по крайней мере с этим параметром:
    * Включить все расширенные свойства проверки

## <a name=copy-client-cert"> </a> Скопируйте отпечатки сертификатов клиента
Каждое лицо, которому был выдан сертификат клиента, должно выполнить следующие шаги для получения отпечатка своего сертификата, который будет добавлен в файл конфигурации службы:
* Запустите certmgr.exe
* Выберите вкладку Личные
* Дважды щелкните сертификат клиента, который будет использоваться для проверки подлинности
* В открывшемся диалоговом окне сертификата перейдите на вкладку "Подробности"
* Убедитесь, что в разделе "Показать" выбран вариант "Все"
* Выберите в списке поле с именем "Отпечаток"
* Скопируйте значение отпечатка
** Удалите неотображаемые символы Юникод перед первой цифрой
** Удалите все пробелы

## <a name="configure-allowed-client"></a>Настройте разрешенных клиентов в файле конфигурации службы

Обновите значение следующего параметра в файле конфигурации службы списком отпечатков сертификатов клиента, разделенных запятыми, которым разрешен доступ к службе.

    <Setting name="AllowedClientCertificateThumbprints" value="" />

## <a name="configure-client-revocation"></a>Настроить проверку отзыва сертификата клиента

При значении по умолчанию проверка статуса отзыва сертификата клиента в центре сертификации не выполняется. Чтобы включить проверку при ее поддержке центром сертификации, выдавшим сертификат клиента, измените следующий параметр одним из значений, определенных в перечислении X509RevocationMode:

    <Setting name="ClientCertificateRevocationCheck" value="NoCheck" />

## Стандартные операции сертификата

•    Настройка SSL-сертификата
•    Настройка сертификатов клиентов

## Поиск сертификата

Выполните следующие действия.

1. Запустите mmc.exe.
2. Файл -> Добавить/удалить оснастку...
3. Выберите Сертификаты
4. Нажмите "Добавить"
5. Выберите расположение хранилища сертификатов
6. Нажмите кнопку "Готово"
7. Нажмите кнопку "ОК"
8. Разверните "Сертификаты"
9. Разверните хранилище сертификатов
10. Разверните дочерний узел сертификата
11. Выберите сертификат из списка в правой части

## Экспорт сертификата
В мастере экспорта сертификатов:

1. Нажмите кнопку "Далее"
2. Выберите "Да, экспортировать закрытый ключ"
3. Нажмите кнопку "Далее"
4. Выберите нужный формат выходного файла
5. Проверьте необходимые параметры
6. Проверьте пароль
7. Введите надежный пароль и подтвердите его
8. Нажмите кнопку "Далее"
9. Введите или выберите имя файла, в котором будет храниться сертификат (используйте расширение .PFX)
10. Нажмите кнопку "Далее"
11. Нажмите кнопку "Готово"
12. Нажмите кнопку "ОК" 

## Импорт сертификата

В мастере импорта сертификатов:

1. Выберите расположение хранилища.
    1.     Текущий пользователь, если доступ к службе обеспечивают только те процессы, которые запущены под учетной записью текущего пользователя
    2.     Локальный компьютер, если доступ к службе обеспечивают другие процессы на этом компьютере
2. Нажмите кнопку "Далее"
3. При импорте из файла подтвердите путь к файлу
4. При импорте .PFX-файла:
    1.     Введите пароль, защищающий закрытый ключ
    2.     Выберите параметры импорта
5.     Выберите место сертификатов в следующем хранилище
6.     Нажмите кнопку обзора
7.     Выберите нужное хранилище
8.     Нажмите кнопку "Готово"
    1.     Если хранилище доверенного корневого центра сертификации выбрано, нажмите "Да"
9.     Нажмите кнопку "ОК" во всех диалоговых окнах

## <a name="upload-certificate"></a>Передача сертификата

На [Портале управления Azure](http://manage.windowsazure.com/)

1. Выберите "Облачные службы"
2. Выберите облачную службу
3. Нажмите "Сертификаты" в верхнем меню
4. Нажмите "Передать" на нижней панели
5. Выберите файл сертификата
6. Если это .PFX файл, введите пароль для закрытого ключа
7. После завершения скопируйте отпечаток сертификата из нового пункта в списке

# <a name="other-security"></a> Прочие вопросы безопасности
 
Описанные в этом документе параметры SSL выполняют шифрование обмена данными между службой и ее клиентами при использовании в конечной точке HTTPS. Это важно, поскольку учетные данные для доступа к базе данных и другие конфиденциальные сведения передаются по каналу связи. Обратите внимание, что служба сохраняет внутренний статус, включая учетные данные, в своих внутренних таблицах базы данных SQL Microsoft Azure, предоставленной вам для хранения метаданных при получении подписки на Microsoft Azure. База данных была определена как часть следующего параметра в вашем файле конфигурации службы (файл .CSCFG): 

    <Setting name="ElasticScaleMetadata" value="Server=..." />

Данные, хранящиеся в этой базе данных, не шифруются. Во избежание раскрытия и утечки учетных данных или другой конфиденциальной информации из запросов к службе защитите эту базу данных и всегда обеспечивайте защищенный доступ к ней. Также убедитесь, что и веб, и рабочие роли ваших развертываний службы поддерживаются актуальными и безопасными, поскольку и те, и другие имеют доступ к базе метаданных. 

[AZURE.INCLUDE [elastic-scale-include](../includes/elastic-scale-include.md)]

[Настройка сертификатов]:#configuring-certificates
[Разрешенные IP-адреса]:#allowed-ip-addresses
[Настройка сертификатов клиентов]:#configuring-client-certs
[Создание самозаверяющего сертификата]:#create-self-signed-cert
[Создание PFX-файла для самозаверяющего SSL-сертификата]:#create-pfx-for-self-signed-cert
[Передать SSL-сертификат в облачную службу]: #upload-ssl
[Обновление SSL-сертификата в файле конфигурации службы]: #update-ssl-in-csfg
[Импорт центра сертификации SSL]: "import-ssl-ca"
[Экспорт SSL-сертификата из хранилища сертификатов]: #export-ssl-from-store
[Отключите проверку подлинности на основе сертификата клиента]: #turn-off-client-cert
[Создайте центр самозаверяющей сертификации]:#create-self-signed-ca
[Скопируйте отпечатки сертификатов клиента]:#copy-client-cert
[Передать сертификат ЦС в облачную службу]:#upload-ca-cert
[Обновите сертификат ЦС в файле конфигурации службы]:#update-ca-in-csft
[Выдайте сертификаты клиентов]:#issue-client-certs
[Создайте PFX-файлы для сертификатов клиентов]:#create-pfx-files
[Импортируйте сертификат клиента]:#import-client-cert
[Настройте разрешенных клиентов в файле конфигурации службы]:#configure-allowed-client
[Поиск открытого ключа ЦС]:#find-ca-public-key
[Настроить проверку отзыва сертификата клиента]:#configure-client-revocation
[Предотвращение отказа в обслуживании]:#denial-of-service-prevention
[Получение сертификатов]:#obtain-certificates
[Инструменты для создания сертификатов]:#tools
[Настройка SSL-сертификата]:#to-configure-ssl-cert
[Прочие вопросы безопасности]:#other-security 
[Передача сертификата]:#upload-certificate
