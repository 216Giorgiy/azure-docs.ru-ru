---
title: Как использовать канал изменений Azure Cosmos DB с Функциями Azure
description: Использование канала изменений Azure Cosmos DB с Функциями Azure
author: rimman
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 11/06/2018
ms.author: rimman
ms.reviewer: sngun
ms.openlocfilehash: 41cbb657a4fc83b498c5cc9a6a16397a619aa075
ms.sourcegitcommit: 8330a262abaddaafd4acb04016b68486fba5835b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2019
ms.locfileid: "54034052"
---
# <a name="how-to-use-azure-cosmos-db-change-feed-with-azure-functions"></a>Как использовать канал изменений Azure Cosmos DB с Функциями Azure

Если вы используете службу "Функции Azure", самый простой способ подключиться к каналу изменений — это добавить триггер [Azure Cosmos DB](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger) в приложении Функций Azure. Когда вы создаете триггер Cosmos DB в приложении Функций Azure, нужно выбрать контейнер Cosmos для подключения, и функция будет запускаться при каждом внесении изменений в контейнере.

Триггеры можно создать на портале Функций Azure, на портале Azure Cosmos DB или программным способом. Дополнительные сведения см. в статье [Обработка данных бессерверных баз данных с помощью Azure Cosmos DB и Функций Azure](serverless-computing-database.md).

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="how-can-i-configure-azure-functions-to-read-from-a-particular-region"></a>Как настроить Функции Azure для чтения из определенного региона?

Вы можете определить [PreferredLocations](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations?view=azure-dotnet#Microsoft_Azure_Documents_Client_ConnectionPolicy_PreferredLocations) при использовании триггера Azure Cosmos DB, чтобы указать список регионов. Это так же, как при настройке ConnectionPolicy, чтобы триггер считывал данные из предпочтительных регионов. В идеальном случае данные требуется считывать из ближайшего региона, где развертываются Функции Azure.

### <a name="what-is-the-default-size-of-batches-in-azure-functions"></a>Каков стандартный размер пакетов в решении "Функции Azure"?

Размер по умолчанию — 100 элементов для каждого вызова Функций Azure. Но это число можно настроить в файле function.json. См. полный [список параметров конфигурации](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration). При локальной разработке обновите параметры приложения в файле local.settings.json.

### <a name="i-am-monitoring-a-container-and-reading-its-change-feed-however-i-dont-get-all-the-inserted-documents-some-items-are-missing"></a>Я отслеживаю контейнер и считываю связанный канал изменений, но не вижу все добавленные документы. Некоторые из них отсутствуют?

Убедитесь, что другие Функции Azure не считывают тот же контейнер с тем же контейнером аренд. Недостающие документы обрабатываются другими Функциями Azure, которые также используют один и тот же договор аренды.

Если вы создаете несколько Функций Azure для считывания данных одного канала изменений, Функции должны использовать разные контейнеры аренд или применять конфигурацию leasePrefix для совместного использования одного контейнера. При использовании библиотеки обработчика для канала изменений можно запустить несколько экземпляров Функций Azure. Пакет SDK автоматически распределит между ними документы.

### <a name="azure-cosmos-item-is-updated-every-second-and-i-dont-get-all-the-changes-in-azure-functions-listening-to-change-feed"></a>Элемент Azure Cosmos обновляется ежесекундно, но в решении "Функции Azure", которое ожидает передачи данных из канала изменений, отображаются не все изменения

Служба "Функции Azure" постоянно опрашивает веб-канал изменений на наличие изменений с максимальным значением задержки по умолчанию в 5 секунд. Если нет ожидающих изменений для чтения или если имеются ожидающие изменения после применения триггера, функция будет считывать их мгновенно. Тем не менее если нет ожидающих изменений, функция будет ждать 5 секунд и опрашивать дополнительные изменения.

Если ваш документ получает несколько изменений за тот же интервал, за который триггер опросил новые изменения, вы получите последнюю версию документа, а не промежуточную.

Если вы хотите опросить канал изменений быстрее чем за 5 секунд, например, на каждую секунду вы можете настроить время опроса feedPollDelay, см. [полную конфигурацию](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations?view=azure-dotnet#Microsoft_Azure_Documents_Client_ConnectionPolicy_PreferredLocations). Значение интервала по умолчанию задано в миллисекундах и составляет 5000. Опрос менее 1 секунды возможен, но не рекомендуется, так как вы начнете использовать больший объем памяти ЦП.

### <a name="can-multiple-azure-functions-read-one-containers-change-feed"></a>Могут ли несколько экземпляров Функций Azure считывать данные канала изменений одного контейнера?

Да. Несколько экземпляров Функций Azure могут считывать данные канала изменений одного контейнера. При этом для каждого экземпляра Функций Azure следует отдельно определить leaseCollectionPrefix.

### <a name="if-i-am-processing-change-feed-by-using-azure-functions-in-a-batch-of-10-documents-and-i-get-an-error-at-seventh-document-in-that-case-the-last-three-documents-are-not-processed-how-can-i-start-processing-from-the-failed-document-ie-seventh-document-in-my-next-feed"></a>Я обрабатываю канал изменений, который включает пакет из 10 документов, с помощью решения "Функции Azure". При обработке седьмого документа поступает сообщение об ошибке. После этого три последних документа не обрабатываются. Как запустить обработку документа с ошибкой (например, седьмого документа)?

Чтобы устранить ошибку, рекомендуется инкапсулировать ваш код блоком try-catch и, если вы выполняете итерацию по списку документов, инкапсулируйте каждую итерацию в собственный блок try-catch. Перехватите ошибку и поместите документ в очередь недоставленных сообщений, а затем определите логику обработки документов с ошибками. Так, если у вас есть пакет из 200 документов и в одном документе возникает ошибка, вам не придется использовать урезанный пакет.

В случае ошибки вам не нужно выполнять откат до контрольной точки, так как вы будете и дальше получать эти документы из канала изменений. Обратите внимание, что в канале изменений сохраняется последний моментальный снимок документов. Поэтому предыдущий моментальный снимок документа может не сохраниться. В канале изменений сохраняется только последняя версия документа. При этом между операциями документ может быть изменен другими процессами.

По мере исправления кода документы будут удаляться из очереди недоставленных сообщений. Решение "Функции Azure" автоматически вызывается системой канала изменений. При этом контрольная точка внутренне поддерживается решением "Функции Azure". Чтобы выполнить контролируемый откат до контрольной точки, используйте пакет SDK обработчика канала изменений.

### <a name="are-there-any-extra-costs-for-using-the-azure-cosmos-db-trigger"></a>Нужно ли платить дополнительно за использование триггера Azure Cosmos DB?

Триггер Azure Cosmos DB внутренним образом использует библиотеку обработчика канала изменений. Таким образом, требуется дополнительная коллекция аренд для хранения состояния и частичных контрольных точек. Это управление состоянием требуется для динамического масштабирования и продолжения, если вы хотите остановить свои Функции Azure и продолжить обработку позже. Дополнительные сведения см. в статье [Using the Azure Cosmos DB change feed processor library](change-feed-processor.md) (Использование библиотеки обработчика канала изменений Azure Cosmos DB).

## <a name="next-steps"></a>Дополнительная информация

Вы можете продолжить знакомство с каналом изменений, перейдя к следующим статьям:

* [Работа с поддержкой веб-канала изменений в Azure Cosmos DB](change-feed.md)
* [Reading Azure Cosmos DB change feed](read-change-feed.md) (Чтение веб-канала изменений Azure Cosmos DB)
* [Using the Azure Cosmos DB change feed processor library](change-feed-processor.md) (Использование библиотеки обработчика канала изменений Azure Cosmos DB)
* [Using the Azure Cosmos DB change feed processor library](change-feed-processor.md) (Использование библиотеки обработчика канала изменений Azure Cosmos DB)
* [Обработка данных бессерверных баз данных с помощью Azure Cosmos DB и Функций Azure](serverless-computing-database.md)
