---
title: Инструкции по настройке брандмауэра IP-адресов для учетной записи Azure Cosmos
description: Узнайте, как настроить политики управления доступом на основе IP-адресов для включения поддержки брандмауэра в учетных записях базы данных Azure Cosmos DB.
author: kanshiG
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 11/06/2018
ms.author: govindk
ms.openlocfilehash: d9a00bccb83fc60c96594ffacc5abde98c0f8470
ms.sourcegitcommit: 0b7fc82f23f0aa105afb1c5fadb74aecf9a7015b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2018
ms.locfileid: "51632589"
---
# <a name="how-to-configure-ip-firewall-for-your-azure-cosmos-account"></a>Инструкции по настройке брандмауэра IP-адресов для учетной записи Azure Cosmos

Вы можете защитить данные, хранимые в учетной записи Azure Cosmos, с помощью брандмауэра IP-адресов. Для фильтрации входящего трафика Azure Cosmos DB поддерживает политики управления доступом на основе IP-адресов. Брандмауэр IP-адресов можно настроить в учетной записи Azure Cosmos любым из следующих способов:

1. на портале Azure;
2. декларативно с помощью шаблона Azure Resource Manager;
3. программным способом, изменив значение свойства **ipRangeFilter** с помощью Azure CLI или Azure Powershell.

## <a id="configure-ip-policy"></a> Настройка брандмауэра IP-адресов с помощью портала Azure

Чтобы настроить политику управления доступом на основе IP-адресов на портале Azure, откройте страницу учетной записи Azure Cosmos DB, в меню навигации щелкните **Firewall and virtual networks** (Брандмауэр и виртуальные сети), а затем измените значение параметра **Allow access from** (Разрешить доступ из) на **Выбранные сети** и нажмите кнопку **Сохранить**. 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/how-to-configure-firewall/azure-portal-firewall.png)

Включив политику управления доступом на основе IP-адресов, вы сможете на портале Azure определять IP-адреса и их диапазоны, а также параметры для управления доступом к другим службам Azure и самому порталу Azure. Сведения об этих параметрах приведены в следующих разделах.

> [!NOTE]
> После включения политики управления доступом на основе IP-адресов для учетной записи Azure Cosmos блокируются все запросы к этой учетной записи Azure Cosmos с компьютеров, IP-адреса которых не входят в список диапазонов разрешенных IP-адресов. В соответствии с этой политикой также блокируется возможность просмотра ресурсов Azure Cosmos DB на портале.

### <a name="allow-requests-from-the-azure-portal"></a>Разрешение запросов на портале Azure 

Чтобы программным способом обеспечить доступ к порталу Azure при включении политики управления доступом на основе IP-адресов, необходимо добавить его IP-адрес к свойству **ipRangeFilter**. IP-адрес портала:

|Регион|IP-адрес|
|------|----------|
|Германия|51.4.229.218|
|Китай|139.217.8.252|
|Штат в США (для обслуживания государственных организаций США)|52.244.48.71|
|Все регионы, кроме трех указанных выше|104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26|

Вы можете включить доступ к порталу Azure, установив флажок **Allow access from Azure portal** (Разрешить доступ с портала Azure), как показано на следующем снимке экрана: 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/how-to-configure-firewall/enable-azure-portal.png)

### <a name="allow-requests-from-global-azure-datacenters-or-other-sources-within-azure"></a>Разрешение запросов от глобальных центров обработки данных Azure или других источников в пределах Azure

Если вы осуществляете доступ к учетной записи Azure Cosmos из служб, которые не предоставляют статический IP-адрес, таких как Azure Stream Analytics, Функции Azure и т. д., вы все равно можете использовать брандмауэр IP-адресов для ограничения доступа. Чтобы разрешить доступ к учетной записи Azure Cosmos из таких служб, включите параметр брандмауэра. Чтобы включить этот параметр брандмауэра, добавьте IP-адрес 0.0.0.0 в список разрешенных IP-адресов. Адрес 0.0.0.0 разрешает запросы к учетной записи Azure Cosmos только из диапазона IP-адресов центров обработки данных Azure. Этот вариант неприменим для получения доступа к учетной записи Azure Cosmos DB из других диапазонов IP-адресов.

> [!NOTE]
> Этот вариант разрешает на брандмауэре все подключения из Azure, в том числе из подписок других клиентов, развернутых в Azure. Этот вариант разрешает большой список IP-адресов, что существенно снижает эффективность политики брандмауэра. Его следует использовать, только если запросы будут поступать из расположений без статических IP-адресов или подсетей в виртуальных сетях. При выборе этого варианта автоматически разрешается доступ с портала Azure, так как сам портал Azure развернут в Azure.

Вы можете включить доступ к порталу Azure, установив флажок **Accept connections from public Azure datacenters** (Разрешить подключения из общедоступных центров обработки данных Azure), как показано на следующем снимке экрана: 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/how-to-configure-firewall/enable-azure-services.png)

### <a name="requests-from-your-current-ip"></a>Запросы с текущего IP-адреса

Чтобы упростить процесс разработки, портал Azure помогает определить и добавить IP-адрес клиентского компьютера в список разрешенных адресов. Это позволяет приложениям на вашем локальном компьютере получить доступ к учетной записи Azure Cosmos. Портал автоматически определяет IP-адрес клиента. Это может быть IP-адрес вашего локального компьютера или используемого сетевого шлюза. Не забудьте удалить этот IP-адрес, когда будете переносить рабочие нагрузки в рабочую среду. 

Чтобы включить текущий IP-адрес, выберите **Add my current IP** (Добавить текущий IP-адрес), чтобы добавить его в список IP-адресов, а затем нажмите кнопку **Сохранить**.

![Снимок экрана, показывающий, как настроить параметры брандмауэра текущего IP-адреса](./media/how-to-configure-firewall/enable-current-ip.png)

### <a name="requests-from-cloud-services"></a>Запросы из облачных служб

В Azure облачные службы — это стандартный способ размещения логики службы среднего уровня с помощью Azure Cosmos DB. Чтобы разрешить доступ к учетной записи Azure Cosmos из облачной службы, добавьте общедоступный IP-адрес этой службы в список разрешенных IP-адресов, связанных с используемой учетной записью Azure Cosmos. Для этого [настройте политику управления доступом на основе IP-адресов](#configure-ip-policy). Так вы предоставите всем экземплярам ролей облачных служб доступ к учетной записи Azure Cosmos. IP-адреса для ваших облачных служб можно получить на портале Azure, как показано на следующем снимке экрана:

![Снимок экрана с общедоступным IP-адресом для облачной службы на портале Azure](./media/how-to-configure-firewall/public-ip-addresses.png)

При развертывании облачной службы за счет добавления дополнительных экземпляров ролей каждый новый экземпляр автоматически получит доступ к учетной записи Azure Cosmos, так он как входит в ту же облачную службу.

### <a name="requests-from-virtual-machines"></a>Запросы из виртуальных машин

[Виртуальные машины](https://azure.microsoft.com/services/virtual-machines/) или [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) также можно использовать для размещения служб среднего уровня с помощью Azure Cosmos DB. Чтобы настроить доступ к учетной записи Cosmos из виртуальных машин, включите общедоступные IP-адреса этих виртуальных машин и (или) масштабируемого набора виртуальных машин в список разрешенных IP-адресов для этой учетной записи. Для этого [настройте политику управления доступом на основе IP-адресов](#configure-ip-policy). IP-адреса для виртуальных машин можно узнать на портале Azure, как показано на следующем снимке экрана:

![Снимок экрана с общедоступным IP-адресом для виртуальной машины на портале Azure](./media/how-to-configure-firewall/public-ip-addresses-dns.png)

Добавленные в группу дополнительные экземпляры виртуальных машин автоматически получают доступ к учетной записи Azure Cosmos.

### <a name="requests-from-the-internet"></a>Запросы из Интернета

Если вы подключаетесь к учетной записи Azure Cosmos с компьютера через Интернет, необходимо добавить IP-адрес или диапазон IP-адресов клиента в список разрешенных IP-адресов для этой учетной записи.

## <a id="configure-ip-firewall-arm"></a>Настройка брандмауэра IP-адресов с помощью шаблона Resource Manager

Чтобы настроить управление доступом к учетной записи Azure Cosmos, укажите в шаблоне Resource Manager атрибут **ipRangeFilter** со списком диапазонов IP-адресов, которые нужно добавить в список разрешений. Например, добавьте в шаблон следующий код JSON:

```json
   {
     "apiVersion": "2015-04-08",
     "type": "Microsoft.DocumentDB/databaseAccounts",
     "kind": "GlobalDocumentDB",
     "name": "[parameters('databaseAccountName')]",
     "location": "[resourceGroup().location]",
     "properties": {
     "databaseAccountOfferType": "Standard",
     "name": "[parameters('databaseAccountName')]",
     "ipRangeFilter":"183.240.196.255, 104.42.195.92,40.76.54.131, 52.176.6.30,52.169.50.45,52.187.184.26"
   }
```

## <a id="configure-ip-firewall-cli"></a> Настройка политики контроля доступа с помощью Azure CLI

Следующая команда демонстрирует, как создать учетную запись Azure Cosmos с помощью управления доступом на основе IP-адресов: 

```azurecli-interactive

name="<Azure Cosmos account name>"
resourceGroupName="<Resource group name>"

az cosmosdb create \
  --name $name \
  --kind GlobalDocumentDB \
  --resource-group $resourceGroupName \
  --max-interval 10 \
  --max-staleness-prefix 200 \
  --ip-range-filter "183.240.196.255, 104.42.195.92,40.76.54.131, 52.176.6.30,52.169.50.45,52.187.184.26"
```

Чтобы изменить параметры брандмауэра для существующей учетной записи, выполните следующую команду:

```azurecli-interactive
az cosmosdb update \
      --name $name \
      --resource-group $resourceGroupName \
      --ip-range-filter "183.240.196.255, 104.42.195.92,40.76.54.131, 52.176.6.30,52.169.50.45,52.187.184.26"
```

## <a id="troubleshoot-ip-firewall"></a>Устранение неполадок с политикой управления доступом на основе IP-адресов

Для устранения неполадок с политикой управления доступом на основе IP-адресов у вас есть следующие возможности и средства: 

### <a name="azure-portal"></a>Портал Azure 
Включив политику управления доступом на основе IP-адресов для учетной записи Azure Cosmos, вы заблокируете все запросы к этой учетной записи с любых компьютеров, IP-адреса которых не входят в список разрешенных диапазонов. Поэтому, чтобы разрешить на портале операции плоскости данных, например просмотр контейнеров и запросы к документам, следует явным образом разрешить доступ к порталу Azure на панели **Брандмауэр**.

### <a name="sdks"></a>Пакеты SDK 
Если доступ к ресурсам Azure Cosmos осуществляется с помощью пакетов SDK с компьютеров, не включенных в список разрешенных, **возвращается стандартный ответ "404 — не найдено" без дополнительных сведений**. Проверьте список разрешенных IP-адресов для учетной записи и убедитесь, что к учетной записи Cosmos применяется правильная конфигурация политики безопасности. 

### <a name="check-source-ips-in-blocked-requests"></a>Проверка IP-адресов источника в заблокированных запросах
Если вы включите ведение журналов диагностики для учетной записи Azure Cosmos, в этих журналах будут отображаться все запросы и ответы. **Сообщения, имеющие отношение к брандмауэру, помещаются в журнал с кодом возврата 403**. Отфильтровав эти сообщения, вы получите список исходных IP-адресов для заблокированных запросов. См. дополнительные сведения о [журнале ведения диагностики Azure Cosmos DB](logging.md).

### <a name="requests-from-subnet-with-service-endpoint-for-azure-cosmos-database-enabled"></a>Запросы из подсети, в которой включена конечная точка службы для базы данных Azure Cosmos
Запросы из подсети виртуальной сети, в которой включена конечная точка службы для Azure Cosmos DB, передают в учетную запись Azure Cosmos идентификаторы виртуальной сети и подсети. Такие запросы не имеют общедоступного IP-адреса источника, поэтому они отклоняются IP-фильтрами. Чтобы разрешить доступ из определенных подсетей в виртуальных сетях, добавьте список управления доступом на основе виртуальных сетей, как описано в руководстве по [настройке виртуальной сети и политики доступа на основе подсети для учетной записи Azure Cosmos](how-to-configure-vnet-service-endpoint.md). Применение правил брандмауэра может занять до 15 минут после изменения.


## <a name="next-steps"></a>Дополнительная информация

Сведения о том, как настроить конечную точку службы для виртуальной сети в учетной записи Azure Cosmos DB, см. в следующих статьях:

* [Безопасный доступ к учетной записи Azure Cosmos DB с использованием конечной точки службы виртуальной сети Azure](vnet-service-endpoint.md)
* [How to access Azure Cosmos DB resources from virtual networks](how-to-configure-vnet-service-endpoint.md) (Доступ к ресурсам Azure Cosmos DB из виртуальных сетей)


