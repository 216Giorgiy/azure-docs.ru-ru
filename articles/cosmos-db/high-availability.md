---
title: Высокий уровень доступности в Azure Cosmos DB
description: В этой статье описывается, как Azure Cosmos DB обеспечивает высокий уровень доступности
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/15/2018
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: eca20b775b97296510545c4d2f2f005fd91d6758
ms.sourcegitcommit: 698a3d3c7e0cc48f784a7e8f081928888712f34b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2019
ms.locfileid: "55471323"
---
# <a name="high-availability-with-azure-cosmos-db"></a>Высокий уровень доступности при использовании Azure Cosmos DB

Azure Cosmos DB прозрачно реплицирует данные во всех регионах Azure, связанных с вашей учетной записью Cosmos. Cosmos DB реализует несколько уровней избыточности для данных, как показано на рисунке ниже.

![Физическое секционирование](./media/high-availability/cosmosdb-data-redundancy.png)

- Данные внутри контейнеров Cosmos горизонтально секционируются.

- Каждая секция в каждом регионе защищена с помощью набора реплик. При этом все записи реплицируются и надежно фиксируются большей частью реплик. Реплики распределены между 10–20 доменами сбоя.

- Все секции реплицируются во всех регионах. Каждый регион содержит все секции данных контейнера Cosmos и может принимать записи и обслуживать операции чтения.  

Если ваша учетная запись Cosmos распределяется между N регионами Azure, будет существовать по крайней мере N x 4 копий всех ваших данных. Помимо обеспечения низкой задержки доступа к вашим данным и масштабирования пропускной способности операций записи и чтения в регионах, связанных с вашей учетной записью Cosmos, также повышает доступность наличие большего количества регионов (более чем N).  

## <a name="slas-for-availability"></a>Соглашения об уровне обслуживания для доступности

Как глобально распределенная база данных Cosmos DB предоставляет исчерпывающие Соглашения об уровне обслуживания, включающие пропускную способность, задержки на уровне 99-го процентиля, согласованность и высокую доступность. В приведенной ниже таблице указаны гарантии высокой доступности, предоставляемые Cosmos DB для учетных записей в одном и нескольких регионах. Для обеспечения высокой доступности настройте наличие нескольких регионов для записи для учетной записи Cosmos.

|Operation type (Тип операции)  | Один регион |Несколько регионов (один регион записи)|Несколько регионов (несколько регионов записи) |
|---------|---------|---------|-------|
|Запись    | 99,99    |99,99   |99,999|
|Операции чтения     | 99,99    |99,999  |99,999|

> [!NOTE]
> На практике фактическая доступность записи для моделей ограниченного устаревания, сеансов, постоянного префикса и итоговой согласованности значительно выше, чем в опубликованных Соглашениях об уровне обслуживания. Фактическая доступность чтения для всех уровней согласованности значительно выше, чем в опубликованных Соглашениях об уровне обслуживания.

## <a name="high-availability-with-cosmos-db-in-the-face-of-regional-outages"></a>Высокий уровень доступности при использовании Cosmos DB в случае региональных сбоев

Региональные сбои случаются нечасто, и Azure Cosmos DB гарантирует, что ваша база данных доступна всегда. Ниже описывается реакция Cosmos DB во время сбоя, в зависимости от конфигурации учетной записи Cosmos.

- Когда используется Cosmos DB, до того как операция записи подтверждается для клиента, данные продолжительно фиксируются кворумом реплик в том регионе, в котором происходит запись.

- Учетные записи, связанные с несколькими регионами, настроенные на использование нескольких регионов записи, будут сохранять высокую доступность как для операций записи, так и для операций чтения. Региональные отработки отказа происходят мгновенно и не требуют изменений приложения.

- Учетные записи для нескольких регионов с одним регионом записи будут сохранять высокий уровень доступности для операций чтения при сбое региона записи. Тем не менее для операций записи нужно включить автоматическую отработку отказа в учетной записи Cosmos, чтобы выполнять отработку отказа затронутого региона в другом регионе. Отработка отказа будет выполняться в указанном порядке приоритетов регионов. В конечном счете, когда работа затронутого региона восстанавливается, нереплицированные данные, присутствующие в регионе записи во время сбоя, становятся доступными через веб-канал конфликтов. Приложения могут считать веб-канал конфликтов, устранить конфликты на основе логики приложения и записать обновленные данные обратно в контейнер Cosmos соответствующим образом. После восстановления ранее затронутый регион записи становится автоматически доступным как регион чтения. Вы можете вызвать отработку отказа вручную и настроить затронутый регион в качестве региона записи. Отработку отказа можно выполнить вручную с помощью [Azure CLI или портала Azure](how-to-manage-database-account.md#manual-failover). **Потеря данных или доступности исключена** до, во время или после отработки отказа вручную. Приложение сохраняет высокий уровень доступности. 

- Учетные записи для нескольких регионов с одним регионом записи будут сохранять высокую доступность для операций чтения и записи при сбое региона чтения. Затронутый регион автоматически отсоединяется от региона записи и помечается как отключенный. Пакеты SDK для Cosmos DB будут перенаправлять вызовы чтения к следующему доступному региону в списке предпочтительных регионов. Если ни один из регионов в списке предпочтительных регионов недоступен, вызовы автоматически будут перенаправлены к текущему региону записи. Для обработки сбоя региона чтения изменения в коде приложения не требуются. В конечном счете, когда работа затронутого региона восстанавливается, ранее затронутый регион чтения автоматически синхронизируется с текущим регионом записи и снова становится доступным для обслуживания операций чтения. Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения. Во время отработки отказа и повторного присоединения региона, в котором ранее был сбой, Cosmos DB продолжает соблюдать гарантии согласованности чтения.

- Учетные записи с одним регионом могут потерять доступность после регионального сбоя. Рекомендуется настроить по крайней мере два региона (желательно два региона записи) с помощью учетной записи Cosmos для обеспечения постоянной высокой доступности.

- Если ваша учетная запись Cosmos с несколькими регионами по умолчанию настроена с высоким уровнем согласованности, то даже в чрезвычайно редких случаях, когда регион Azure навсегда утерян, возможность потенциальной потери данных отсутствует. В случае полной потери региона записи для учетных записей Cosmos с несколькими регионами, настроенных с ограниченной согласованностью, окно потенциальной потери данных ограничено "окном устаревания". Для уровней согласованности на уровне сеанса, с постоянным префиксом и итоговой согласованности потенциальное окно потери данных ограничено максимум пятью секундами.

## <a name="building-highly-available-applications"></a>Создание высокодоступных приложений

- Чтобы обеспечить высокий уровень доступности операций записи и чтения, настройте учетную запись Cosmos на поддержку по крайней мере двух регионов с несколькими регионами записи. Эта конфигурация обеспечит лучшую доступность, минимальные задержки и масштабируемость для операций чтения и записи, поддерживаемых Соглашениями об уровне обслуживания. Дополнительные сведения см. в статье [Настройка глобального распределения Azure Cosmos DB с помощью API SQL](tutorial-global-distribution-sql-api.md).

- Для учетных записей Cosmos с несколькими регионами, для которых настроен один регион записи, см. раздел [Включение автоматического перехода на другой ресурс вручную для учетной записи Cosmos](how-to-manage-database-account.md#automatic-failover). При включенной автоматической отработке отказа в случае регионального сбоя Cosmos DB будет автоматически выполнять отработку отказа вашей учетной записи.  

- Даже если учетная запись Cosmos обеспечивает высокую доступность, из-за структуры приложение может не обеспечивать высокий уровень доступности. Чтобы проверить, что ваше приложение полностью высокодоступно, периодически вызывайте [отработку отказа вручную с помощью Azure CLI или портала Azure](how-to-manage-database-account.md#manual-failover) как часть тестирования приложений и аварийного восстановления.

## <a name="next-steps"></a>Дополнительная информация

По следующим ссылкам вы узнаете о масштабировании пропускной способности.

* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [Масштабирование пропускной способности в Azure Cosmos DB](scaling-throughput.md)
* [Глобальное распределение (взгляд изнутри)](global-dist-under-the-hood.md)
* [Настраиваемые уровни согласованности данных в Azure Cosmos DB](consistency-levels.md)
