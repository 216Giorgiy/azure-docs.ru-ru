---
title: Уровни согласованности в Azure Cosmos DB | Документация Майкрософт
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
keywords: согласованность в конечном счете, azure cosmos db, azure, Microsoft Azure
services: cosmos-db
author: SnehaGunda
manager: kfile
documentationcenter: ''
ms.assetid: 3fe51cfa-a889-4a4a-b320-16bf871fe74c
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/27/2018
ms.author: sngun
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 0f38d05dc720dd596c81a51abf7040ac062e8158
ms.sourcegitcommit: 909469bf17211be40ea24a981c3e0331ea182996
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
---
# <a name="tunable-data-consistency-levels-in-azure-cosmos-db"></a>Настраиваемые уровни согласованности данных в Azure Cosmos DB
Служба Azure Cosmos DB была разработана "с нуля", при этом в ее основу заложены возможности глобального распространения данных для всех моделей данных. Служба гарантирует прогнозируемую низкую задержку и несколько четко определенных моделей нестрогой согласованности. Сейчас Azure Cosmos DB поддерживает пять уровней согласованности: строгий, с ограниченным устареванием, уровня сеанса, согласованность префиксов и согласованный в конечном счете. Все уровни кроме строгого называются моделями с нестрогой согласованностью. Строгий уровень представляет наиболее согласованную из доступных моделей. 

Кроме **строгой** модели и модели **итоговой согласованности** (обычно предусмотрены в распределенных базах данных), Azure Cosmos DB предлагает три тщательно кодифицированные и операционализированные модели согласованности: **ограниченное устаревание**, **сеанс** и **постоянный префикс**. Полезность каждого из этих уровней согласованности проверена на реальных примерах использования. Все вместе эти пять уровней согласованности позволяют принимать обоснованные компромиссы между показателями согласованности, доступности и задержки. 

В следующем видео руководитель программы Azure Cosmos DB Эндрю Лю (Andrew Liu) продемонстрирует комплексные функции глобального распределения.

>[!VIDEO https://www.youtube.com/embed/-4FsGysVD14]

## <a name="distributed-databases-and-consistency"></a>Распределенные базы данных и согласованность
Есть две категории коммерческих распределенных баз данных: базы данных, которые вообще не предлагают точно определенные, проверяемые варианты согласованности, и базы данных, которые предлагают два радикальных программируемых варианта (строгая и итоговая согласованность). 

Первый вариант обременяет разработчиков приложений деталями протоколов репликации и предполагает компромисс между согласованностью, доступностью, низкой задержкой и пропускной способностью. Второй заставляет выбирать одну из двух крайностей. Несмотря на множество исследований и более 50 предложенных моделей согласованности сообществу распределенных баз данных не удается вывести на рынок уровни согласованности, отличные от строгого и итогового. Cosmos DB позволяет разработчикам выбрать одну из пяти точно определенных моделей согласованности разного уровня. Вы можете выбрать строгую согласованность, согласованность с ограниченным устареванием, [согласованность уровня сеанса](http://dl.acm.org/citation.cfm?id=383631), согласованность префиксов и согласованность в конечном счете. 

![Несколько четко определенных моделей согласованности (нестрогой) Azure Cosmos DB на ваш выбор](./media/consistency-levels/five-consistency-levels.png)

В следующей таблице представлены конкретные гарантии, предоставляемые на каждом уровне согласованности.
 
**Уровни согласованности и гарантии**

| Уровень согласованности | Гарантии |
| --- | --- |
| Уровень согласованности Strong (сильная) | Линеаризация. Операции чтения гарантированно возвращают самую последнюю версию элемента.|
| Ограниченное устаревание | Согласованность префиксов. Операции чтения могут отставать от операций записи не более чем на k префиксов или на интервал времени t. |
| Сеанс   | Согласованность префиксов. Монотонные операции чтения и записи, чтение собственных операций записи, запись после чтения. |
| Согласованность префиксов | Обновления, которые возвращаются, содержат часть префиксов всех обновлений, без разрывов. |
| Уровень согласованности Eventual (в конечном счете)  | Неупорядоченное чтение |

Для учетной записи Cosmos DB можно настроить уровень согласованности по умолчанию (и позже переопределить согласованность для определенного запроса на чтение). По сути, уровни согласованности по умолчанию применяются к данным в наборах секций, которые могут распространятся между регионами. Около 73 % клиентов Azure Cosmos DB используют модель согласованности сеанса, а 20 % предпочитают согласованность с ограниченным устареванием. Примерно 3 % клиентов Azure Cosmos DB экспериментируют с различными уровнями согласованности, прежде чем выберут определенный уровень для своего приложения. Всего 2 % клиентов Azure Cosmos DB переопределяют уровни согласованности для каждого запроса. 

В Cosmos DB операции чтения, выполняемые с согласованностью уровня сеанса, согласованностью префиксов и согласованностью в конечном счете в два раза дешевле, чем операции чтения, выполняемые со строгой согласованностью или согласованностью с ограниченным устареванием. Cosmos DB предлагает лучшие в отрасли соглашения об уровне обслуживания (SLA), которые гарантируют требуемые показатели согласованности, доступности, пропускной способности и задержки. В Azure Cosmos DB используется [средство проверки линеаризации](http://dl.acm.org/citation.cfm?id=1806634), которое постоянно анализирует данные телеметрии службы и открыто сообщает о любых нарушениях согласованности. При использовании согласованности с ограниченным устареванием Azure Cosmos DB отслеживает все нарушения ограничений k и t и сообщает о них. Для всех пяти уровней нестрогой согласованности Azure Cosmos DB также непосредственно предоставляет [метрику вероятностного ограниченного устаревания](http://dl.acm.org/citation.cfm?id=2212359).  

## <a name="service-level-agreements"></a>Соглашения об уровне обслуживания

Для Azure Cosmos DB предусмотрены комплексные [соглашения об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/cosmos-db/), которые гарантируют доступность на уровне 99,99 %, а также обеспечивают требуемые показатели пропускной способности, согласованности, доступности и задержки для учетных записей баз данных Azure Cosmos DB, используемых в пределах одного региона Azure, для которых настроен любой из пяти уровней согласованности, или для учетных записей баз данных, используемых в пределах нескольких регионов Azure, для которых настроен любой из четырех уровней нестрогой согласованности. Более того, независимо от выбранного уровня согласованности, для Azure Cosmos DB предусмотрено соглашение об уровне обслуживания, гарантирующее доступность для операций чтения на уровне 99,999 % для учетных записей баз данных, используемых в пределах двух и более регионов Azure.

## <a name="scope-of-consistency"></a>Область действия согласованности
Степень детализации согласованности ограничивается запросом одного пользователя. Запрос записи может соответствовать транзакции Insert, Replace, Upsert или Delete. Как и запись, транзакция чтения или запроса также ограничена одним запросом пользователя. Пользователю может потребоваться разбить на страницы большой результирующий набор, охватывающий нескольких секций, но каждая транзакция чтения ограничена одной страницей и обслуживается в одной секции.

## <a name="consistency-levels"></a>Уровни согласованности
Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (и базы данных) под вашей учетной записью Cosmos DB. По умолчанию все операции чтения и запросов к определенным пользователем ресурсам используют уровень согласованности по умолчанию, заданный в учетной записи базы данных. Можно снизить уровень согласованности конкретного запроса (на чтение или операцию) в каждом из поддерживаемых интерфейсов API. Существует пять типов уровней согласованности, поддерживаемых протоколом репликации Azure Cosmos DB, которые обеспечивают четкий компромисс между определенными гарантиями целостности и производительности, как описано в этом разделе.

<a id="strong"></a>
**Строгая согласованность**: 

* Строгая согласованность предлагает гарантию [линеаризации](https://aphyr.com/posts/313-strong-consistency-models), обеспечивающую возвращение самой последней версии элемента операциями чтения. 
* Сильный уровень согласованности гарантирует, что операция записи отображается только после ее завершения большинством необходимого набора реплик. Операция записи либо синхронно фиксируется первичной репликой и кворумом вторичных реплик, либо прерывается. Операция чтения всегда признается большинством кворума чтения, клиент никогда не сможет увидеть незафиксированную или частичную запись и всегда гарантированно считает последние подтвержденные записанные данные. 
* Учетную запись Azure Cosmos DB, настроенную для использования строгой согласованности, нельзя связать более чем с одним регионом Azure.  
* Затраты на операцию чтения (в используемых [единицах запроса](request-units.md) ) при строгой согласованности выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при согласованности с ограниченным устареванием.

<a id="bounded-staleness"></a>
**Ограниченное устаревание**: 

* Согласованность с ограниченным устареванием гарантирует, что операции чтения могут отставать от записи не более чем на *K* версий или префиксов элемента или на интервал времени *t*. 
* Следовательно, при выборе ограниченного устаревания это самое "устаревание" можно настроить двумя способами: указать количество *K* версий элемента, на которое операции чтения могут отставать от операций записи, и интервал времени *t*. 
* Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии для монотонных операций чтения в регионе существуют как в пределах "окна устаревания", так и вне его. 
* Модель ограниченного устаревания обеспечивает более строгую согласованность, в сравнении с моделями согласованности сеанса, постоянного префикса и итоговой согласованности. Для глобально распределенных приложений мы рекомендуем использовать ограниченное устаревание в ситуациях, где требуется строгая согласованность, но при этом необходима доступность порядка 99,99 % и низкая задержка.   
* С учетными записями Azure Cosmos DB, для которых настроена согласованность с ограниченным устареванием, можно связать любое количество регионов Azure. 
* Затраты на операцию чтения (в используемых единицах запроса) с ограниченным устареванием выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при строгой согласованности.

<a id="session"></a>
**Согласованность сеанса**: 

* В отличие от глобальных моделей согласованности, предлагаемых уровнями строгой согласованности и согласованности с ограниченным устареванием, согласованность уровня сеанса ограничена сеансом клиента. 
* Согласованность уровня сеанса идеально подходит для всех сценариев, включающих в себя сеанс устройства или пользователя, так как она гарантирует монотонное чтение и монотонную запись, а также гарантирует чтение собственных записей (RYW). 
* Согласованность уровня сеанса обеспечивает предсказуемую согласованность для сеанса и максимальную пропускную способность, предлагая самые низкие задержки при записи и чтении. 
* С учетными записями Azure Cosmos DB, для которых настроена согласованность уровня сеанса, можно связать любое количество регионов Azure. 
* Затраты на операции чтения (выраженные в используемых единицах запроса) для модели согласованности на уровне сеанса ниже, чем для модели строгой согласованности или согласованности с ограниченным устареванием, но выше, чем для модели итоговой согласованности.

<a id="consistent-prefix"></a>
**Согласованность префиксов**: 

* Согласованность префиксов гарантирует, что в отсутствие каких-либо последующих операций записи реплики в группе в конечном счете сходятся. 
* Согласованность префиксов гарантирует, что операции чтения никогда не столкнутся с неупорядоченными операциями записи. Если операции записи выполнялись в порядке `A, B, C`, то клиент видит `A`, `A,B` или `A,B,C`, но никогда не видит неупорядоченные операции `A,C` или `B,A,C`.
* С учетными записями Azure Cosmos DB, для которых настроена согласованность префиксов, можно связать любое количество регионов Azure. 

<a id="eventual"></a>
**Итоговая согласованность**: 

* Согласованность в конечном счете гарантирует, что в отсутствие каких-либо последующих операций записи реплики в группе в конечном счете сходятся. 
* Согласованность в конечном счете является самой нестрогой формой согласованности, при которой клиент может получить значения, которые являются более старыми по отношению к полученным ранее.
* Согласованность «в конечном счете» оказывается самой слабо связанной согласованностью чтения, но предлагает наименьшую задержку как для чтения, так и для записи.
* С учетными записями Azure Cosmos DB, для которых настроена согласованность в конечном счете, можно связать любое количество регионов Azure. 
* Затраты на операцию чтения (в используемых единицах запроса) для уровня согласованности в конечном счете являются самыми низкими среди уровней согласованности Azure Cosmos DB.

## <a name="configuring-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию
1. На навигационной панели [портала Azure](https://portal.azure.com/) щелкните **Azure Cosmos DB**.
2. На странице **Azure Cosmos DB** выберите учетную запись базы данных, которую нужно изменить.
3. На странице учетной записи щелкните **Согласованность по умолчанию**.
4. На странице **Согласованность по умолчанию** выберите новый уровень согласованности и щелкните **Сохранить**.
   
    ![Снимок экрана, на котором показан значок "Параметры" и запись "Согласованность по умолчанию"](./media/consistency-levels/database-consistency-level-1.png)

## <a name="consistency-levels-for-queries"></a>Уровни согласованности для запросов
По умолчанию для определенных пользователем ресурсов уровень согласованности запросов совпадает с уровнем согласованности операций чтения. По умолчанию, индекс обновляется синхронно при каждой операции вставки, замены или удаления элемента в контейнере Cosmos DB. Это позволяет выполнять запросы с уровнем согласованности, как и в операциях чтения. В то время как служба Azure Cosmos DB оптимизирована для операций записи и поддерживает устойчивые объемы операций записи, синхронное обслуживание индекса и обслуживание согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления их ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших объемов данных.  

| Режим индексирования | Операции чтения | Запросы |
| --- | --- | --- |
| Режим согласованности (по умолчанию) |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса и согласованность в конечном счете. |
| Отложенная |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Уровень согласованности Eventual (в конечном счете) |
| None |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Не применяется |

Как и для запросов на чтение, можно снизить уровень согласованности конкретного запроса в каждом API.

## <a name="consistency-levels-for-the-mongodb-api"></a>Уровни согласованности для API MongoDB

В Azure Cosmos DB сейчас реализована версия MongoDB 3.4 с двумя параметрами согласованности: строгий и итоговый. Так как Azure Cosmos DB поддерживает несколько API, параметры согласованности применяются на уровне учетной записи. Этот процесс контролируется каждым API.  В версиях ниже MongoDB 3.6 отсутствовало понятие согласованности сеансов. Поэтому, если вы настроили учетную запись API MongoDB для использования согласованности сеансов, уровень согласованности при использовании API MongoDB понижается до итогового. Если для учетной записи API MongoDB требуется гарантия чтения собственных записей, для согласованности по умолчанию следует установить строгий уровень или уровень ограниченного устаревания.

## <a name="next-steps"></a>Дополнительная информация
Если вы хотите получить дополнительные сведения об уровнях согласованности и компромиссах, рекомендуем ознакомиться со следующими ресурсами:

* ["Replicated Data Consistency Explained Through Baseball" (Объяснение согласованности при репликации данных на примере бейсбола), Даг Терри (Doug Terry) — видео](https://www.youtube.com/watch?v=gluIh8zd26I)
* ["Replicated Data Consistency Explained Through Baseball" (Объяснение согласованности при репликации данных на примере бейсбола), Даг Терри (Doug Terry) — документ](http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf)
* [Гарантии на уровне сеанса для репликации слабо согласованных данных](http://dl.acm.org/citation.cfm?id=383631) (Session guarantees for weakly consistent replicated data)
* [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
* [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
* [Eventual Consistent - Revisited](http://allthingsdistributed.com/2008/12/eventually_consistent.html) (Возвращаясь к вопросу об итоговой согласованности)
* ["The Load, Capacity, and Availability of Quorum Systems" (Нагрузка, емкость и доступность в кворумных системах), журнал SIAM Journal on Computing](http://epubs.siam.org/doi/abs/10.1137/S0097539795281232)
* ["Line-up: a complete and automatic linearizability checker" (Преобразование в линейный вид. Полнофункциональное автоматическое средство для проверки возможности линеаризации), материалы конференции ACM SIGPLAN 2010, посвященной разработке и реализации языков программирования](http://dl.acm.org/citation.cfm?id=1806634)
* [Probabilistically bounded staleness for practical partial quorums](http://dl.acm.org/citation.cfm?id=2212359) (Вероятностное ограниченное устаревание для практических неполных кворумов)
