---
title: Уровни согласованности в Azure Cosmos DB | Документация Майкрософт
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
keywords: согласованность в конечном счете, azure cosmos db, azure, Microsoft Azure
services: cosmos-db
author: aliuy
manager: kfile
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 03/27/2018
ms.author: andrl
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6ace11cf3704ddbd503c0202d45874670476198e
ms.sourcegitcommit: 1f9e1c563245f2a6dcc40ff398d20510dd88fd92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2018
ms.locfileid: "51624833"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Уровни согласованности в Azure Cosmos DB

Репликация распределенных баз данных для обеспечения высокого уровня их доступности и небольшой задержки предполагает компромисс между согласованностью чтения и такими параметрами, как доступность, время задержки и пропускная способность. Большинство коммерчески доступных распределенных баз данных предлагают разработчикам выбор между двумя моделями согласованности: строгая и итоговая согласованность. Хотя  [линеаризация](http://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf) или модель строгой согласованности являются золотым стандартом программирования данных, за них приходится дорого расплачиваться повышенной задержкой (в устойчивом состоянии) и снижением доступности (в случае сбоев). С другой стороны, итоговая согласованность предлагает более высокий уровень доступности и лучшую производительность, но ее очень сложно программировать.

В Cosmos DB согласованность данных рассматривается как спектр возможных вариантов, а не как две крайности. В то время как строгая и итоговая согласованности — это два конца спектра, в его пределах существует множество других вариантов согласованности. Эти параметры согласованности позволяют разработчикам совершать точный выбор и идти на компромиссы с большей степенью детализации, при этом учитывая высокую доступность или производительность. Cosmos DB позволяет выбрать одну из пяти готовых моделей таких уровней согласованности: **Строгая**, **Ограниченное устаревание**, **Сеансовая**, **Постоянный префикс** и **Итоговая**. Каждая из этих моделей согласованности четко определена, интуитивно понятна и может использоваться для конкретных реальных сценариев. Каждая из пяти моделей обеспечивает [компромисс между доступностью и производительностью](consistency-levels-tradeoffs.md) и регулируется комплексными соглашениями об уровне обслуживания. На следующем изображении показан спектр различных уровней согласованности:

![Согласованность как спектр](./media/consistency-levels/five-consistency-levels.png)

Уровни согласованности не зависят от региона. Уровень согласованности учетной записи Cosmos DB гарантируется для всех операций чтения, независимо от региона, из которого обслуживаются операции чтения и записи, количества регионов, связанных с вашей учетной записью Cosmos, и количества настроенных регионов записи для вашей учетной записи.

## <a name="scope-of-the-read-consistency"></a>Область согласованности чтения

Согласованность чтения применяется к одной области операции чтения в пределах диапазона ключа секции (логического раздела). Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configuring-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

**Уровень согласованности по умолчанию** в учетной записи Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный в учетной записи, применяется ко всем базам данных (и контейнерам) Cosmos в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут использовать указанный уровень согласованности по умолчанию. Дополнительные сведения см.в разделе [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level).

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Комплексные соглашения об уровне обслуживания, предоставленные Azure Cosmos DB, гарантируют, что 100 % запросов на чтение будут соответствовать гарантии согласованности для любого выбранного уровня согласованности. Запрос на чтение считается соответствующим соглашению об уровне обслуживания, если удовлетворяются гарантии согласованности, связанные с уровнем согласованности. Четкие определения пяти уровней согласованности в Cosmos DB, использующие [язык спецификации TLA+](http://lamport.azurewebsites.net/tla/tla.html), приведены в репозитории GitHub [azure-cosmos-tla](https://github.com/Azure/azure-cosmos-tla). Семантика пяти уровней согласованности описана ниже.

- **Уровень согласованности = "строгая"**. Строгая согласованность предоставляет гарантию [линеаризации](https://aphyr.com/posts/313-strong-consistency-models), обеспечивающую возвращение самой последней зафиксированной версии элемента операциями чтения. Клиент не увидит не зафиксированную или частичную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

- **Уровень согласованности = "ограниченное устаревание"**. Операции чтения всегда учитывают гарантию постоянного префикса. Операции чтения могут отставать от записи не более чем на версии K (обновлений) элемента или на интервал времени "t". При выборе ограниченного устаревания это самое "устаревание" можно настроить двумя способами: 

  * количеством версий (K) элемента или
  * интервалом времени (t), на которое операция чтения может отставать от записи. 

  Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии для монотонных операций чтения в регионе существуют как в пределах "окна устаревания", так и вне его. Строгая согласованность имеет ту же семантику, что и согласованность с ограниченным устареванием, но "окно устаревания" равно нулю. Ограниченное устаревание также называется **отложенной во времени линеаризацией**. Когда клиент выполняет операции чтения в регионе, принимающем записи, гарантии, предоставленные согласованностью с ограниченным устареванием, идентичны тем, которые предоставляются строгой согласованностью.

- **Уровень согласованности = "сеансовая"**. Операции чтения всегда учитывают гарантии постоянного префикса, монотонного чтения, монотонной записи, чтения собственных записей, записей после чтения. Согласованность сеанса ограничена сеансом клиента.

- **Уровень согласованности = "постоянный префикс"**. Обновления, которые возвращаются, содержат часть префиксов всех обновлений без разрывов. Согласованность префиксов гарантирует, что операции чтения никогда не столкнутся с неупорядоченными операциями записи.

- **Уровень согласованности = "итоговая"**. Нет никакого гарантированного метода упорядочения операций чтения. При отсутствии каких-либо последующих операций записи реплики в конечном счете сходятся.

## <a name="consistency-levels-explained-through-baseball"></a>Объяснение уровней согласованности на примере игры в бейсбол

Представьте, что последовательность операций записи представляет собой счет бейсбольного матча со счетом за каждый иннинг, как описано в статье [Replicated data consistency through baseball](https://www.microsoft.com/en-us/research/wp-content/uploads/2011/10/ConsistencyAndBaseballReport.pdf) (Объяснение согласованности данных на примере бейсбола). В этом гипотетическом бейсбольном матче в данный момент наступила середина седьмого иннинга (пресловутая финишная прямая седьмого иннинга), и местная команда выигрывает со счетом 2:5.

| | **1** | **2** | **3** | **4** | **5** | **6** | **7** | **8** | **9** | **Число ранов** |
| - | - | - | - | - | - | - | - | - | - | - |
| **Команда гостей** | 0 | 0 | 1 | 0 | 1 | 0 | 0 |  |  | 2 |
| **Местная команда** | 1 | 0 | 1 | 1 | 0 | 2 |  |  |  | 5 |

В контейнере Cosmos DB хранится общее число ранов гостей и местной команды. Пока игра не закончена, разные гарантии чтения могут привести к прочтению клиентами разных счетов. Представленная ниже таблица содержит полный набор счетов, которые могут быть возвращены при чтении счетов гостей и местной команды с каждой из пяти гарантий согласованности. Счет команды гостей приведен первым, а различные возможные варианты возвращаемых значений разделены запятыми.

| **Уровень согласованности** | **Счета** |
| - | - |
| **Строгая** | 2:5 |
| **Ограниченное устаревание** | счета, устаревшие на максимум один иннинг: 2:3, 2:4, 2:5 |
| **Согласованность сеанса** | <ul><li>для модуля записи: 2:5</li><li> для всех, кроме модуля записи: 0:0, 0:1, 0:2, 0:3, 0:4, 0:5, 1:0, 1:1, 1:2, 1:3, 1:4, 1:5, 2:0, 2:1, 2:2, 2:3, 2:4, 2:5</li><li>после чтения 1–3: 1:3, 1:4, 1:5, 2:3, 2:4, 2:5</li> |
| **Постоянный префикс** | 0:0, 0:1, 1:1, 1:2, 1:3, 2:3, 2:4, 2:5 |
| **Итоговая** | 0:0, 0:1, 0:2, 0:3, 0:4, 0:5, 1:0, 1:1, 1:2, 1:3, 1:4, 1:5, 2:0, 2:1, 2:2, 2:3, 2:4, 2:5 |

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Replicated Data Consistency Explained through Baseball (video) by Doug Terry](https://www.youtube.com/watch?v=gluIh8zd26I) (Видео. Объяснение согласованности реплицированных данных на примере бейсбола, Даг Терри)
- [Replicated Data Consistency Explained through Baseball (whitepaper) by Doug Terry](https://www.microsoft.com/en-us/research/publication/replicated-data-consistency-explained-through-baseball/?from=http%3A%2F%2Fresearch.microsoft.com%2Fpubs%2F157411%2Fconsistencyandbaseballreport.pdf) (Документ. Объяснение согласованности реплицированных данных на примере бейсбола, Даг Терри)
- [Гарантии на уровне сеанса для репликации слабо согласованных данных](https://dl.acm.org/citation.cfm?id=383631) (Session guarantees for weakly consistent replicated data)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](https://www.computer.org/web/csdl/index/-/csdl/mags/co/2012/02/mco2012020037-abs.html) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об уровнях согласованности в Cosmos DB можно найти в следующих статьях.

* [Choosing the right consistency level for your application](consistency-levels-choosing.md) (Выбор правильного уровня согласованности для приложения)
* [Consistency levels and Azure Cosmos DB APIs](consistency-levels-across-apis.md) (Уровни согласованности и интерфейсы API Azure Cosmos DB)
* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [How to configure the default consistency level](how-to-manage-consistency.md#configure-the-default-consistency-level) (Настройка уровня согласованности по умолчанию)
* [How to override the default consistency level](how-to-manage-consistency.md#override-the-default-consistency-level) (Переопределение уровня согласованности по умолчанию)

