---
title: Уровни согласованности в Azure Cosmos DB
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
keywords: согласованность в конечном счете, azure cosmos db, azure, Microsoft Azure
services: cosmos-db
author: aliuy
ms.author: andrl
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 03/27/2018
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: b509c7eceb3c2e2fb2e53f20791976b0322ad744
ms.sourcegitcommit: 9fb6f44dbdaf9002ac4f411781bf1bd25c191e26
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2018
ms.locfileid: "53089740"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Уровни согласованности в Azure Cosmos DB

Репликация распределенных баз данных для обеспечения высокого уровня их доступности и низкой задержки предполагает компромисс между согласованностью чтения и такими параметрами, как доступность, время задержки и пропускная способность. Большинство коммерчески доступных распределенных баз данных предлагают разработчикам выбор между двумя моделями согласованности: строгая и итоговая согласованность. Модель  [линеаризации](https://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf) или строгой согласованности является эталонной для поддержки программируемости данных. Но она добавляет высокую стоимость в виде повышения задержки (в устойчивом состоянии) и снижения доступности (во время сбоев). С другой стороны, итоговая согласованность предлагает более высокий уровень доступности и лучшую производительность, но ее очень сложно программировать. 

В Azure Cosmos DB согласованность данных рассматривается как плавный спектр возможных вариантов, а не две крайности. Строгая согласованность и согласованность в конечном счете — это два предельных варианта, а между ними существует множество промежуточных вариантов. Они позволяют разработчикам намного точнее выбирать параметры и компромиссы в отношении высокого уровня доступности или производительности. 

В Azure Cosmos DB разработчики могут выбрать любую из пяти четко определенных моделей согласованности, распределенных по спектру согласованности. От более строгой к менее строгой они распределяются следующим образом: строгая согласованность, согласованность с ограниченным устареванием, согласованность на уровне сеанса, согласованность префиксов и согласованность в конечном счете. Все эти модели четко определены и интуитивно понятны. Все они подходят для конкретных сценариев из реальной жизни. Каждая модель определяет [компромиссы по доступности и производительности](consistency-levels-tradeoffs.md) и регулируется комплексными соглашениями об уровне обслуживания. Спектр различных уровней согласованности представлен на следующем изображении:

![Согласованность как спектр](./media/consistency-levels/five-consistency-levels.png)

Уровни согласованности не зависят от региона. Уровень согласованности учетной записи Azure Cosmos DB гарантируется для всех операций чтения, независимо от региона, из которого обслуживаются операции чтения и записи, количества регионов, связанных с вашей учетной записью Azure Cosmos, и количества настроенных регионов записи для вашей учетной записи.

## <a name="scope-of-the-read-consistency"></a>Область согласованности данных при чтении

Согласованность данных при чтении применяется к одной операции чтения в пределах диапазона ключа секции или логического раздела. Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configure-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

Уровень согласованности по умолчанию в учетной записи Azure Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный для учетной записи, применяется ко всем базам данных и контейнерам Azure Cosmos DB в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут по умолчанию использовать указанный уровень согласованности. Дополнительные сведения см.в статье [о настройке уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level).

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Комплексные соглашения об уровне обслуживания, предоставляемые Azure Cosmos DB, гарантируют соблюдение гарантий согласованности выбранного уровня для 100 % запросов на чтение. Запрос на чтение соответствует соглашению об уровне обслуживания, если удовлетворяются гарантии согласованности, связанные с выбранным уровнем согласованности. Четкие определения пяти уровней согласованности в Azure Cosmos DB, выраженные на [языке спецификаций TLA+](https://lamport.azurewebsites.net/tla/tla.html), размещены в репозитории GitHub [azure-cosmos-tla](https://github.com/Azure/azure-cosmos-tla). 

Ниже описана семантика этих пяти уровней согласованности.

- **Уровень согласованности Strong (сильная)**: На уровне строгой согласованность предлагается гарантия [линеаризации](https://aphyr.com/posts/313-strong-consistency-models). Все операции чтения гарантированно возвращают последнюю версию элемента. Клиент никогда не увидит не зафиксированную или частично измененную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

- **Ограниченное устаревание** Операции чтения всегда соблюдают гарантию согласованности префиксов. Операции чтения могут отставать от записи не более чем на "K" версий (обновлений) любого элемента или не более чем на интервал времени "t". Выбрав режим ограниченного устаревания, это вы можете настроить один из двух параметров, ограничивающих это "устаревание": 

  * количество версий (K) элемента;
  * интервал времени (t), на который операция чтения может отставать от записи. 

  Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии для монотонных операций чтения в регионе соблюдаются как в пределах "окна устаревания", так и вне его. Строгая согласованность имеет ту же семантику, что и согласованность с ограниченным устареванием, но с нулевым "окном устаревания". Ограниченное устаревание также называется отложенной во времени линеаризацией. Когда клиент выполняет операции чтения в регионе, который принимает операции записи, предоставленные согласованностью с ограниченным устареванием гарантии полностью идентичны тем, которые существуют для строгой согласованности.

- **Уровень согласованности Session (сеанс)**: Операции чтения всегда соблюдают гарантии постоянного префикса (при условии единого сеанса записи), монотонного чтения, монотонной записи, чтения собственных записей, записей после чтения. Согласованность сеанса ограничена сеансом клиента.

- **Постоянный префикс**. Все возвращаемые обновления содержат один префикс для всех обновлений, без разрывов. Согласованность префиксов гарантирует, что операции чтения никогда не возвращают неупорядоченные операции записи.

- **Уровень согласованности Eventual (в конечном счете)**: Для операций чтения упорядоченность не гарантируется. При отсутствии последующих операций записи все реплики в конечном счете сходятся.

## <a name="consistency-levels-explained-through-baseball"></a>Объяснение уровней согласованности на примере игры в бейсбол

В качестве примера рассмотрим сценарий бейсбольного матча. Некоторая последовательность операций записи обновляет текущий счет бейсбольного матча. Линейная запись счета по каждому иннингу описана в документе [о согласованности реплицированных данных в бейсболе](https://www.microsoft.com/en-us/research/wp-content/uploads/2011/10/ConsistencyAndBaseballReport.pdf). Сейчас в нашем гипотетическом матче середина седьмого иннинга. Это перерыв в середине игры. Команда гостей пока проигрывает со счетом 2:5.

| | **1** | **2** | **3** | **4** | **5** | **6** | **7** | **8** | **9** | **Число ранов** |
| - | - | - | - | - | - | - | - | - | - | - |
| **Команда гостей** | 0 | 0 | 1 | 0 | 1 | 0 | 0 |  |  | 2 |
| **Местная команда** | 1 | 0 | 1 | 1 | 0 | 2 |  |  |  | 5 |

В контейнере Azure Cosmos DB хранится общее число хоум-ранов для команд гостей и хозяев. Пока игра не закончена, разные гарантии чтения могут означать, что клиенты будут получать разные версии счета. В следующей таблице собран полный набор версий счетов, которые могут возвращаться для команд гостей и хозяев при каждой из пяти моделей согласованности. Первое число всегда означает счет гостей. Возможные варианты значений разделяются запятыми.

| **Уровень согласованности** | **Счета** |
| - | - |
| **Строгая** | 2:5 |
| **Ограниченное устаревание** | Счета, устаревшие не более чем на один иннинг: 2:3, 2:4, 2:5 |
| **Согласованность сеанса** | <ul><li>Для того экземпляра, который выполняет запись: 2:5.</li><li> Для всех остальных: 0:0, 0:1, 0:2, 0:3, 0:4, 0:5, 1:0, 1:1, 1:2, 1:3, 1:4, 1:5, 2:0, 2:1, 2:2, 2:3, 2:4, 2:5.</li><li>После того, как будет считано значение 1:3: 1:3, 1:4, 1:5, 2:3, 2:4, 2:5.</li> |
| **Постоянный префикс** | 0:0, 0:1, 1:1, 1:2, 1:3, 2:3, 2:4, 2:5 |
| **Итоговая** | 0:0, 0:1, 0:2, 0:3, 0:4, 0:5, 1:0, 1:1, 1:2, 1:3, 1:4, 1:5, 2:0, 2:1, 2:2, 2:3, 2:4, 2:5 |

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Replicated Data Consistency Explained through Baseball (video) by Doug Terry](https://www.youtube.com/watch?v=gluIh8zd26I) (Видео. Объяснение согласованности реплицированных данных на примере бейсбола, автор Даг Терри)
- [Replicated Data Consistency Explained through Baseball (whitepaper) by Doug Terry](https://www.microsoft.com/en-us/research/publication/replicated-data-consistency-explained-through-baseball/?from=http%3A%2F%2Fresearch.microsoft.com%2Fpubs%2F157411%2Fconsistencyandbaseballreport.pdf) (Документ. Объяснение согласованности реплицированных данных на примере бейсбола, автор Даг Терри)
- [Session guarantees for weakly consistent replicated data](https://dl.acm.org/citation.cfm?id=383631) (Гарантии на уровне сеанса для слабо согласованных реплицированных данных)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is Only Part of the Story](https://www.computer.org/web/csdl/index/-/csdl/mags/co/2012/02/mco2012020037-abs.html) (Компромиссы согласованности в современных распределенных базах данных. О модели CAP и не только.)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об уровнях согласованности в Azure Cosmos DB можно найти в следующих статьях.

* [Выбор правильного уровня согласованности для приложения](consistency-levels-choosing.md)
* [Уровни согласованности и API для Azure Cosmos DB](consistency-levels-across-apis.md)
* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level)
* [Переопределение уровня согласованности по умолчанию](how-to-manage-consistency.md#override-the-default-consistency-level)

