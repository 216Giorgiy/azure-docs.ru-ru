---
title: "Azure Cosmos DB советы по оптимизации производительности Java | Документы Microsoft"
description: "Узнайте, как улучшить производительность базы данных Azure Cosmos DB с помощью параметров конфигурации клиента"
keywords: "как улучшить производительность базы данных"
services: cosmos-db
author: mimig1
manager: jhubbard
editor: 
documentationcenter: 
ms.assetid: dfe8f426-3c98-4edc-8094-092d41f2795e
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/02/2018
ms.author: mimig
ms.openlocfilehash: ca16a7fe424e9c50ce87b150442dd18ff0d6ce91
ms.sourcegitcommit: 9ea2edae5dbb4a104322135bef957ba6e9aeecde
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2018
---
> [!div class="op_single_selector"]
> * [Java](performance-tips-java.md)
> * [.NET](performance-tips.md)
> 
> 

# <a name="performance-tips-for-azure-cosmos-db-and-java"></a>Советы по повышению производительности для Azure Cosmos DB и Java
Azure Cosmos DB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью. Не нужно вносить изменения основных архитектуры или писать сложный код для масштабирования базы данных с помощью Azure Cosmos DB. Для увеличения или уменьшения масштаба достаточно вызвать один метод интерфейса API или [пакета SDK](set-throughput.md#set-throughput-java). Тем не менее, поскольку Azure Cosmos DB осуществляется через вызовы сети существуют оптимизации клиентские, можно сделать для достижения максимальной производительности при использовании [SQL Java SDK](documentdb-sdk-java.md).

Чтобы оптимизировать производительность базы данных, рассмотрите следующие варианты.

## <a name="networking"></a>Сеть
<a id="direct-connection"></a>

1. **Режим подключения: используйте DirectHttps**

    Как клиент подключается к базе данных Azure Cosmos имеет важные последствия на производительность, особенно в части наблюдаемых клиентские задержки. Имеется один параметр для настройки клиента ключа конфигурации [ConnectionPolicy](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._connection_policy) – [ConnectionMode](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._connection_mode).  Два доступных ConnectionModes являются:

   1. [Шлюз (по умолчанию)](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._connection_mode.gateway)
   2. [DirectHttps](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._connection_mode.directhttps)

    Режим шлюз поддерживается на всех платформах SDK, настроенные по умолчанию.  Если приложение работает в корпоративной сети с ограничениями strict брандмауэра, шлюза отлично подходит, так как он использует стандартный порт HTTPS и одну конечную точку. Баланс производительности, то, что шлюз режим включает в себя дополнительный сетевой прыжок каждый раз при чтении или записи в базу данных Azure Cosmos данных. По этой причине DirectHttps режим обеспечивает лучшую производительность из-за меньшее количество сетевых переходов. 

    Пакет SDK для Java использует в качестве транспортного протокола HTTPS. Протокол HTTPS использует SSL для начальной проверки подлинности и шифрования трафика. При использовании пакета SDK для Java, только HTTPS-порт 443 должен быть открыт. 

    ConnectionMode настраивается во время создания экземпляра DocumentClient с параметром ConnectionPolicy. 

    ```Java
    public ConnectionPolicy getConnectionPolicy() {
        ConnectionPolicy policy = new ConnectionPolicy();
        policy.setConnectionMode(ConnectionMode.DirectHttps);
        policy.setMaxPoolSize(1000);
        return policy;
    }
        
    ConnectionPolicy connectionPolicy = new ConnectionPolicy();
    DocumentClient client = new DocumentClient(HOST, MASTER_KEY, connectionPolicy, null);
    ```

    ![Изображение: политика подключения Azure Cosmos DB](./media/performance-tips-java/connection-policy.png)

   <a id="same-region"></a>
2. **Оптимизация производительности за счет размещения клиентов в одном регионе Azure**

    По возможности поместите все приложения, вызывающие Azure Cosmos DB в одном регионе Azure Cosmos DB базы данных. Для сравнения, приблизительно, вызовы к базе данных Azure Cosmos в том же регионе завершается в течение 1-2 мс, но задержка между влево и восточном побережье США — > 50 мс. Значение задержки может отличаться в зависимости от выбранного маршрута при передаче запроса от клиента к границе центра обработки данных Azure. Самая низкая задержка достигается за счет того, что вызывающее приложение находится в том же регионе Azure, как подготовленные конечная точка Azure Cosmos DB. Список доступных регионов см. на странице [Регионы Azure](https://azure.microsoft.com/regions/#services).

    ![Изображение: политика подключения Azure Cosmos DB](./media/performance-tips/same-region.png)
   
## <a name="sdk-usage"></a>Использование пакета SDK
1. **Установка последней версии пакета SDK**

    Постоянно улучшение DB Cosmos пакеты SDK Azure для обеспечения оптимальной производительности. В разделе [Azure Cosmos DB SDK](documentdb-sdk-java.md) страницы для определения последнего пакета SDK и просмотрите усовершенствования.
2. **Использование клиента Azure Cosmos DB одноэлементное в течение времени существования приложения**

    Каждый [DocumentClient](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._document_client) экземпляр поточно ориентированного и осуществляет управление эффективности соединения и адрес кэширования при работе в режиме прямого. Чтобы реализовать возможность управления подключениями и оптимизировать производительность, рекомендуется использовать один экземпляр DocumentClient для каждого домена в течение жизненного цикла приложения.

   <a id="max-connection"></a>
3. **Увеличьте MaxPoolSize для каждого узла, при использовании режима шлюза**

    Azure Cosmos DB запросы выполняются через HTTPS REST при использовании режима шлюза и являются подвергались предел для числа подключений по умолчанию для имени узла или IP-адрес. Может потребоваться присвойте MaxPoolSize более высокое значение (200-1000), чтобы клиентская библиотека может использовать несколько одновременных подключений к базе данных Azure Cosmos. В пакете SDK для Java, а значение по умолчанию для [ConnectionPolicy.getMaxPoolSize](https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._connection_policy.gsetmaxpoolsize) — 100. Используйте [setMaxPoolSize]( https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._connection_policy.setmaxpoolsize) для изменения значения.

4. **Настройка параллельных запросов для секционированных коллекций**

    Azure Cosmos DB SQL пакета Java SDK версии 1.9.0 и более поздних версиях поддержка параллельных запросов, которые позволяют запрашивать секционированную коллекцию параллельно (см. [работа с пакетами SDK](sql-api-partition-data.md#working-with-the-azure-cosmos-db-sdks) и связанный с ним [примеры кода](https://github.com/Azure/azure-documentdb-java/tree/master/documentdb-examples/src/test/java/com/microsoft/azure/documentdb/examples) для Дополнительные сведения о). Параллельные запросы предназначены для сокращения задержки при обработке запросов и улучшения пропускной способности посредством их последовательных аналогов.

    (a) ***СУБД setMaxDegreeOfParallelism\:***  параллельный запрос рабочих запросив несколько секций одновременно. Тем не менее данные из отдельных секционированные коллекции доставляются последовательно по отношению к запросу. Таким образом, используйте [setMaxDegreeOfParallelism](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._feed_options.setmaxdegreeofparallelism) Установка числа секций с максимальной вероятность достижения наиболее производительным запросов, предоставляемых все системные условия остаются неизменными. Если вы не знаете число секций, setMaxDegreeOfParallelism позволяет установить большое и система выбирает минимальное (число секций, предоставленные пользователем данные) в качестве максимальную степень параллелизма. 

    Следует отметить, что параллельные запросы обеспечивают больше преимуществ, если данные равномерно распределены во всех секциях по отношению к запросу. Если коллекция секционируется таким образом, что все или большинство данных, возвращаемых запросом, содержатся в нескольких секциях (в худшем случае в одной), это негативно скажется на производительности запроса.

    (б) ***СУБД setMaxBufferedItemCount\:***  параллельный запрос предназначен для предварительно выбирать результаты во время обработки текущего пакета результаты клиенту. Предварительная выборка способствует общему уменьшению задержки при обработке запроса. setMaxBufferedItemCount ограничивает число предварительно выбранных результатов. Установив [setMaxBufferedItemCount](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._feed_options.setmaxbuffereditemcount) ожидаемое число возвращаемых результатов (или больше), это позволяет получить максимальные преимущества из предварительное запроса.

    Предварительное работает так же, независимо от MaxDegreeOfParallelism и одного буфера для данных из всех секций.  

5. **Реализуйте растущим интервалом getRetryAfterInMilliseconds**

    Во время проверки производительности следует увеличивать нагрузку до тех пор, пока регулирование не будет выполняться при небольшой частоте запросов. При регулировании клиентское приложение должно реализовать интервал частоты повтора для частоты повтора сервера. Это гарантирует, что время ожидания между повторными попытками будет минимальным. Поддержка политики повтора включено в версии 1.8.0 и более поздних версий из [Java SDK](documentdb-sdk-java.md). Дополнительные сведения см. в разделе [Exceeding зарезервировано ограничения пропускной способности](request-units.md#RequestRateTooLarge) и [getRetryAfterInMilliseconds](https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._document_client_exception.getretryafterinmilliseconds).
6. **Развертывание рабочей нагрузки клиента**

    При тестировании на уровнях высокой пропускной способности (> 50 000 единиц Запросов в секунду), клиентское приложение может стать узким местом системы из-за машины ограниченного исходящий от загрузки ЦП или сети. При достижении этой точки можно продолжать push дополнительной учетной записи Azure Cosmos DB по масштабированию клиентские приложения по нескольким серверам.

7. **Используйте имя зависимости адресации**

    Использовать на основании имени адресации, где ссылки имеют формат `dbs/MyDatabaseId/colls/MyCollectionId/docs/MyDocumentId`, вместо SelfLinks (_self), которые имеют формат `dbs/<database_rid>/colls/<collection_rid>/docs/<document_rid>` во избежание получение ИД ресурсов: все ресурсы, используемые для создания ссылки. Кроме того поскольку эти ресурсы получить заново (с именем), кэширование этих может не позволить.

   <a id="tune-page-size"></a>
8. **Оптимизация производительности посредством настройки размера страницы для запросов и каналов чтения**

    При выполнении массового чтение документов с помощью чтения канала функциональные возможности (например, [readDocuments]( https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._document_client.readdocuments#com_microsoft_azure_documentdb__document_client_readDocuments_String_FeedOptions_c) или при выдаче запроса SQL, результаты возвращаются в сегментированном режиме, если слишком большой результирующий набор. По умолчанию результаты возвращаются в пакетах (не более 100 элементов и не более 1 МБ в каждом пакете).

    Чтобы уменьшить количество полных обходов сети, необходимый для получения всех результатов, можно увеличить размер страницы с помощью [x-ms-max-item-count](https://docs.microsoft.com/rest/api/documentdb/common-documentdb-rest-request-headers) заголовок запроса до 1000. Чтобы отобразить только некоторые результаты, например, когда пользовательский интерфейс или приложение API возвращает только десять результатов за раз, размер страницы можно уменьшить до 10. Это позволит снизить пропускную способность, используемую на операции чтения и на выполнение запросов.

    Можно также задать размер страницы с помощью [setPageSize метод](https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._feed_options_base.setpagesize#com_microsoft_azure_documentdb__feed_options_base_setPageSize_Integer).

## <a name="indexing-policy"></a>Политика индексации
 
1. **Увеличение скорости выполнения операций записи посредством исключения неиспользуемых путей из индексирования**

    Политика индексирования Azure Cosmos DB позволяет указать, какие пути к документу, чтобы включить или исключить из индексирования за счет использования путей индексирования ([setIncludedPaths](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._indexing_policy.setincludedpaths) и [setExcludedPaths](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._indexing_policy.setexcludedpaths)). Возможность управления путями индексирования позволяет оптимизировать производительность записи и снизить затраты на хранение индекса для сценариев с заранее определенными шаблонами запросов. Это связано с тем, что затраты на индексирование непосредственно зависят от количества уникальных путей индексирования.  Например, в приведенном ниже коде показано, как исключить из индексации целый раздел документов (так называемое поддерево) с помощью подстановочного знака "*".

    ```Java
    Index numberIndex = Index.Range(DataType.Number);
    numberIndex.set("precision", -1);
    indexes.add(numberIndex);
    includedPath.setIndexes(indexes);
    includedPaths.add(includedPath);
    indexingPolicy.setIncludedPaths(includedPaths);
    collectionDefinition.setIndexingPolicy(indexingPolicy);
    ```

    Дополнительные сведения см. в статье [Политики индексации DocumentDB](indexing-policies.md).

## <a name="throughput"></a>Throughput
<a id="measure-rus"></a>

1. **Измерение и настройка расхода единиц запроса/повторного использования**

    Azure Cosmos DB предлагает широкий набор операций базы данных, включая реляционные и иерархические запросы с определяемые пользователем функции, хранимые процедуры и триггеры — все работы с документами в базе данных коллекции. Затраты, связанные с каждой из этих операций, зависят от типа процессора, операций ввода-вывода и памяти, необходимой для завершения операции. Вместо того чтобы думать о закупке и управлении аппаратными ресурсами, вы можете думать о единице запроса (RU) как единой меры для ресурсов, необходимых для выполнения различных операций с базами данных и обслуживания запросов приложений.

    Пропускная способность предоставляется в зависимости от числа [единиц запросов](request-units.md) значение для каждого контейнера. Удельный расход единиц запросов оценивается в расчете на одну секунду. Частота запросов для приложений, у которых она превышает подготовленные единицы запросов для контейнера, будет ограничена, пока она не упадет ниже зарезервированного для контейнера уровня. Если приложению требуется более высокий уровень пропускной способности, можно увеличить ее путем выделения дополнительных единиц запросов. 

    Сложность запроса влияет на количество единиц запроса используются для операции. Количество предикатов и их характер, количество определяемых пользователем функций и размер набора исходных данных — все это влияет на плату за операции запроса.

    Для измерения издержки, связанные с любой операции (Создание, обновление или удаление), проверки [x-ms запрос платы](https://docs.microsoft.com/rest/api/documentdb/common-documentdb-rest-response-headers) заголовок (или эквивалентное свойство RequestCharge в [ResourceResponse<T> ](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._resource_response) или [FeedResponse<T> ](https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._feed_response) измеряет количество единиц запроса, используемые в этих операций.

    ```Java
    ResourceResponse<Document> response = client.createDocument(collectionLink, documentDefinition, null, false);

    response.getRequestCharge();
    ```             

    Запрос вернул в этом заголовке взимается часть вашей пропускная способность. Например при наличии 2000 единиц Запросов в секунду инициализирован, и если предыдущий запрос возвращает 1 КБ 1000-документы, стоимость операции равно 1000. Таким образом, перед регулированием последующих запросов сервер за одну секунду выполняет только два таких запроса. Чтобы узнать больше, ознакомьтесь с [единицами запроса](request-units.md) и [калькулятором единиц запроса](https://www.documentdb.com/capacityplanner).
<a id="429"></a>
2. **Обработка ограничения скорости/ слишком высокая частота запросов**

    Выполнение запроса, который превышает лимит зарезервированной пропускной способности для учетной записи, не приводит к снижению производительности сервера, так как пользователь не сможет превысить это зарезервированное значение. Сервер предварительно завершения запроса с RequestRateTooLarge (код состояния HTTP 429) и будет возвращать [x-ms повтора после ms](https://docs.microsoft.com/rest/api/documentdb/common-documentdb-rest-response-headers) заголовок, указывающий количество времени в миллисекундах, которое пользователь должен ждать перед повторной попыткой запрос.

        HTTP Status 429,
        Status Line: RequestRateTooLarge
        x-ms-retry-after-ms :100

    Пакеты SDK перехватят этот ответ, обработают заголовок retry-after, указанный сервером, и отправят запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

    Если у вас есть несколько клиентов Суммарно постоянно превысила частота запросов, число повторных попыток по умолчанию, в настоящий момент значение 9 внутренним образом клиент может оказаться недостаточно; в этом случае клиент вызывает [DocumentClientException](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._document_client_exception) с кодом состояния 429 в приложение. Число повторных попыток по умолчанию можно изменить с помощью [setRetryOptions](https://docs.microsoft.com/en-us/java/api/com.microsoft.azure.documentdb._connection_policy.setretryoptions) на [ConnectionPolicy](https://docs.microsoft.com/java/api/com.microsoft.azure.documentdb._connection_policy) экземпляра. По умолчанию в случае превышения заданного счетчика повторов исключение DocumentClientException с кодом состояния 429 возвращается через 30 секунд (совокупное время ожидания). Это происходит, даже если текущее значение количества повторных попыток (по умолчанию (9) или определенное пользователем) меньше максимального значения.

    Хотя автоматическая процедура отправки повторного запроса позволяет улучшить устойчивость приложений и повысить удобство работы с ними, она может снизить производительность, что, в свою очередь, станет причиной появления более длительных задержек.  Если настройка производительности повлияла на регулирование сервера и стала причиной автоматической отправки запросов пакетом SDK, это может стать причиной появления пиков задержек на стороне клиента. Чтобы избежать пиков задержек во время настройки производительности, проверьте расход ресурсов на каждую операцию и убедитесь, что значение частоты запросов не превышено. Дополнительные сведения см. в статье [Единицы запросов в DocumentDB](request-units.md).
3. **Использование меньших документов для более высокой пропускной способности**

    Размер документа непосредственно связанный запрос расходов (стоимость обработки запросов) для данной операции. За операции с большими документами взимается больше единиц запроса, чем за операции с мелкими документами.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о разработке приложений для обеспечения масштабирования и высокой производительности см. в разделе [секционирование и масштабирование в базе данных Azure Cosmos](partition-data.md).
