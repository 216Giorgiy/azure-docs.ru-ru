---
title: Единицы запроса и оценка пропускной способности (Azure Cosmos DB) | Документация Майкрософт
description: Сведения о том, как понять факторы, задать и оценить количество необходимых единиц запросов в Azure Cosmos DB.
services: cosmos-db
author: rimman
manager: kfile
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 06/26/2018
ms.author: rimman
ms.openlocfilehash: 66beeb2cc724f75d17a4c155f1cdb888153e8fbf
ms.sourcegitcommit: f94f84b870035140722e70cab29562e7990d35a3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/30/2018
ms.locfileid: "43286771"
---
# <a name="request-units-in-azure-cosmos-db"></a>Единицы запроса в базе данных Azure Cosmos DB

[Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db/) — это глобально распределенная многомодельная база данных корпорации Майкрософт. Благодаря Azure Cosmos DB вам не нужно арендовать виртуальные машины, развертывать программное обеспечение или отслеживать работу баз данных. Систему Azure Cosmos DB обслуживают и непрерывно контролируют ведущие инженеры корпорации Майкрософт, что позволяет добиться доступности, производительности и защиты данных мирового уровня. Вы можете обращаться к данным через любые удобные API-интерфейсы, в том числе [SQL](documentdb-introduction.md), [MongoDB](mongodb-introduction.md) и [Table](table-introduction.md), а также через графы [Gremlin API](graph-introduction.md). Для всех API-интерфейсов реализована встроенная поддержка. 

Плата за использование Azure Cosmos DB *выражается в единицах запроса (ЕЗ)*. При использовании единиц запроса вам не нужно резервировать пропускную способность для чтения и записи или подготавливать ресурсы ЦП, памяти и ввода-вывода. Azure Cosmos DB поддерживает разные интерфейсы API с разным набором операций — от простых операций чтения и записи до сложных запросов графа. Так как не все запросы одинаковы, им назначается нормализованное количество единиц запроса на основе объема вычислений, необходимых для обслуживания каждого запроса. Количество единиц запроса для конкретной операции является детерминированным. Количество единиц запроса, потребленных любой операцией в базе данных Azure Cosmos, можно определить по заголовку ответа. 

Чтобы обеспечить прогнозируемую производительность, пропускная способность резервируется блоками по 100 единиц запроса в секунду. Вы можете [оценить требуемую вам пропускную способность](request-units.md#estimating-throughput-needs) с помощью [калькулятора единиц запроса](https://www.documentdb.com/capacityplanner) Azure Cosmos DB.

![Калькулятор пропускной способности][5]

Ознакомившись с данной статьей, вы сможете ответить на следующие вопросы.

* Что такое единицы запросов и затраты на запросы в Azure Cosmos DB?
* Как задать количество единиц запроса для контейнера или набора контейнеров в Azure Cosmos DB?
* Как оценить приемлемое количество единиц запросов для моего приложения?
* Что произойдет, если превысить максимальное количество единиц запроса для контейнера или набора контейнеров в Azure Cosmos DB?

Поскольку Azure Cosmos DB является многомодельной базой данных, следует отметить, что данная статья применима ко всем моделям данных и API-интерфейсам в Azure Cosmos DB. В этой статье используются некоторые обобщенные термины: *контейнера* обозначает коллекцию или граф, а *элемент* обозначает таблицу, документ, узел или сущность.

## <a name="request-units-and-request-charges"></a>Единицы запросов и затраты на запросы

Azure Cosmos DB обеспечивает высокую и прогнозируемую производительность за счет резервирования ресурсов в соответствии с требованиями к пропускной способности приложения. Нагрузки и режимы доступа для приложения изменяются со временем. Azure Cosmos DB поможет вам легко увеличить или уменьшить объем зарезервированной для приложения производительности.

В Azure Cosmos DB пропускная способность резервируется в виде количества единиц запроса, обрабатываемых в секунду. Единицы запроса можно считать аналогом валюты для пропускной способности. Вы можете зарезервировать определенное количество единиц запроса, и все они будут доступны для приложения каждую секунду. Каждая операция в Azure Cosmos DB (в том числе создание документа, выполнение запроса, обновление документа) сопровождается потреблением ресурсов ЦП, объема памяти и выполнением операций ввода-вывода. Поэтому за выполнении каждой операции запроса взимается плата, которая выражается в единицах запроса. Зная факторы, которые влияют на стоимость в единицах запроса, и требования приложения к пропускной способности, вы сможете обеспечит идеальный баланс и экономичность приложения. 

## <a name="throughput-isolation-in-globally-distributed-databases"></a>Изоляция пропускной способности в распределенной базе данных

Если вы настроили репликацию базы данных в несколько регионов, служба Azure Cosmos DB обеспечивает изоляцию пропускной способности, то есть использование единиц запроса в одном регионе не влияет на использование единиц запроса в другом. Например, когда данные записываются в один регион и считываются из другого, единицы запроса для операции записи в первом регионе не учитываются при расчете единиц запроса для операции чтения во втором регионе. Единицы запроса не распределяются между регионами, в которых развернута база данных. Каждый регион, в котором есть копия базы данных, получает полное количество подготовленных единиц запроса. Дополнительные сведения о глобальной репликации см. в статье [Как работает глобальное распределение данных в Azure с помощью Cosmos DB](distribute-data-globally.md).

## <a name="request-unit-considerations"></a>Рекомендации по оценке необходимого количества единиц запросов
При оценке количества единиц запроса, которое нужно подготовить, учитывайте следующие переменные:

* **Размер элемента.** По мере увеличения размера также увеличивается и число единиц запроса, расходуемых на чтение или запись данных.
* **Число свойств элемента.** Если все свойства индексируются, число единиц запроса, расходуемых на запись документа, узла или сущности, увеличивается вместе с увеличением количества свойств.
* **Согласованность данных**. Если вы используете модели со строгим уровнем согласованности данных или с ограниченным устареванием, на чтение элементов расходуются дополнительные единицы запроса.
* **Индексируемые свойства**. Свойства, которые индексируются по умолчанию, определяются политикой индексирования для каждого контейнера. Вы можете сократить потребление единиц запросов для операций записи, ограничив количество индексируемых свойств или включив отложенное индексирование.
* **Индексирование документов**. По умолчанию каждый элемент индексируется автоматически. Если не индексировать некоторые элементы, будет использовано меньше единиц запросов.
* **Шаблоны запросов**. Сложность запроса влияет на количество единиц запроса, потребляемых операцией. Количество результатов запросов, количество предикатов и их характер, количество определяемых пользователем функций и размер исходных данных, а также проекции — все это влияет на стоимость операций запросов.
* **Использование скриптов**. Так же как и запросы, хранимые процедуры и триггеры расходуют единицы запросов с учетом сложности выполняемых операций. При разработке приложения проверяйте заголовки со стоимостью запросов, чтобы лучше понять, как ресурсы производительности используются каждой из операций.

## <a name="estimating-throughput-needs"></a>Оценка требований к пропускной способности
Единица запроса — это нормализованная мера стоимости обработки запросов. Одна единица запроса соответствует вычислительной мощности, необходимой для чтения (по ссылке на себя или идентификатору) одного элемента размером 1 КБ, содержащего 10 уникальных значений свойств (кроме системных свойств). Запрос на создание (вставку), замену или удаление того же элемента будет использовать дополнительные вычислительные ресурсы службы и поэтому потребует больше единиц запроса. 

> [!NOTE]
> Базовая стоимость в 1 единицы запросов для одного элемента размером 1 КБ соответствует простой операции GET по ссылке на себя или идентификатору элемента.
> 
> 

Например, ниже приведена таблица, показывающая количество единиц запросов для подготовки с тремя разными размерами элемента (1, 4 и 64 КБ) и двумя разными уровнями производительности (500 операций чтения в секунду + 100 операций записи в секунду и 500 операций чтения в секунду + 500 операций записи в секунду). В этом примере настроена согласованность данных на уровне **сеанса**, а политике индексации присвоено значение **Нет**.

| Размер элемента | Операций чтения в секунду | Операций записи в секунду | Единиц запросов
| --- | --- | --- | --- |
| 1 КБ | 500 | 100 | (500 * 1) + (100 * 5) = 1000 единиц запросов в секунду
| 1 КБ | 500 | 500 | (500 * 1) + (500 * 5) = 3000 единиц запросов в секунду
| 4 КБ | 500 | 100 | (500 * 1,3) + (100 * 7) = 1350 единиц запросов в секунду
| 4 КБ | 500 | 500 | (500 * 1,3) + (500 * 7) = 4150 единиц запросов в секунду
| 64 КБ | 500 | 100 | (500 * 10) + (100 * 48) = 9800 единиц запросов в секунду
| 64 КБ | 500 | 500 | (500 * 10) + (500 * 48) = 29 000 единиц запросов в секунду


### <a name="use-the-request-unit-calculator"></a>Использование калькулятора единиц запросов
Чтобы лучше оценить требуемую производительность, попробуйте применить [калькулятор единиц запроса](https://www.documentdb.com/capacityplanner). Этот калькулятор поможет рассчитать требования в единицах запроса для обычных операций, включая:

* операции создания элемента (запись);
* операции чтения элемента;
* операции удаления элемента;
* операции обновления элемента.

Средство также позволяет оценивать требования к хранилищу данных по предоставленным образцам элементов.

Чтобы применить этот инструмент, выполните следующее.

1. Загрузите один или несколько элементов образцов (например, документ JSON).
   
    ![Загрузка элементов в калькулятор единиц запросов][2]
2. Чтобы оценить требования к хранилищу данных, укажите общее количество элементов, которые вы планируете хранить (например, документы, строки или вершины).
3. Укажите нужное количество операций создания, чтения, обновления и удаления (в секунду). Чтобы оценить затраты в единицах запроса на операцию обновления элемента, отправьте копию образца элемента (см. шаг 1 выше), который содержит типичные обновления полей. Например, если операции обновления элемента обычно изменяют свойства *lastLogin* и *userVisits*, то скопируйте образец элемента, измените значения этих двух свойств и отправьте копию элемента.
   
    ![Ввод требований к пропускной способности в калькуляторе единиц запросов][3]
4. Нажмите кнопку **Вычислить** и ознакомьтесь с результатами.
   
    ![Результаты калькулятора единиц запросов][4]

> [!NOTE]
> Если размер и количество индексированных свойств для элементов разных типов существенно различаются, отправьте в средство образцы стандартных элементов каждого *типа* и проведите вычисления.
> 
> 

### <a name="use-the-azure-cosmos-db-request-charge-response-header"></a>Использование заголовка ответа на запрос Azure Cosmos DB о затратах
Каждый ответ от службы Azure Cosmos DB включает в себя пользовательский заголовок (`x-ms-request-charge`), который содержит количество используемых на данный запрос единиц запросов. Вы также можете получить этот заголовок через пакеты SDK для Azure Cosmos DB. В пакете SDK для .NET **RequestCharge** является свойством объекта **ResourceResponse**. В обозревателе данных Azure Cosmos DB на портале Azure содержится информация о затратах на выполненные запросы. Сведения о том, как получить и настроить пропускную способность с помощью многомодельных API, см. в статье [Настройка и получение пропускной способности контейнеров и базы данных Azure Cosmos DB](set-throughput.md).

Один из методов оценки необходимого для приложения объема зарезервированной пропускной способности — записать затраты в единицах запроса на выполнение стандартных операций для определенного элемента, который используется приложением. Затем оцените количество операций, которое планируется выполнять каждую секунду. Не забудьте оценить и учесть стандартные запросы и использование скриптов Azure Cosmos DB.

> [!NOTE]
> Если размер и количество индексированных свойств для элементов разных типов существенно различаются, запишите затраты в единицах запроса для типичных операций по каждому *типу* элементов.
> 
> 

Например, вы можете выполнить такие действия.

1. Запишите затраты единиц запросов на создание (вставку) стандартного элемента. 
2. Запишите затраты единиц запросов на чтение стандартного элемента.
3. Запишите затраты единиц запросов на обновление стандартного элемента.
4. Запишите затраты единиц запросов на выполнение стандартных, общих запросов элемента.
5. Запишите затраты единиц запроса на все настраиваемые скрипты (хранимые процедуры, триггеры, определяемые пользователем функции), которые используются приложением.
6. Рассчитайте необходимое количество единиц запросов для операций, которые вы планируете выполнять каждую секунду.

## <a name="a-request-unit-estimate-example"></a>Пример оценки единицы запроса
Вот пример документа размером примерно 1 КБ.

```json
{
 "id": "08259",
  "description": "Cereals ready-to-eat, KELLOGG, KELLOGG'S CRISPIX",
  "tags": [
    {
      "name": "cereals ready-to-eat"
    },
    {
      "name": "kellogg"
    },
    {
      "name": "kellogg's crispix"
    }
  ],
  "version": 1,
  "commonName": "Includes USDA Commodity B855",
  "manufacturerName": "Kellogg, Co.",
  "isFromSurvey": false,
  "foodGroup": "Breakfast Cereals",
  "nutrients": [
    {
      "id": "262",
      "description": "Caffeine",
      "nutritionValue": 0,
      "units": "mg"
    },
    {
      "id": "307",
      "description": "Sodium, Na",
      "nutritionValue": 611,
      "units": "mg"
    },
    {
      "id": "309",
      "description": "Zinc, Zn",
      "nutritionValue": 5.2,
      "units": "mg"
    }
  ],
  "servings": [
    {
      "amount": 1,
      "description": "cup (1 NLEA serving)",
      "weightInGrams": 29
    }
  ]
}
```

> [!NOTE]
> В Azure Cosmos DB документы минифицированы, поэтому их размер в системе немного меньше 1 КБ.
> 
> 

В следующей таблице представлены ориентировочные затраты единиц запроса для типичных операций с этим элементом. (Ориентировочные затраты единиц запроса вычисляются для уровня согласованности учетной записи на уровне **сеанса** с автоматической индексацией всех элементов.)

| Операция | Затраты единиц запроса |
| --- | --- |
| Create item (Создание элемента) |~ 15 ЕЗ |
| Чтение элемента |~ 1 ЕЗ |
| Запрос элемента по идентификатору |~ 2,5 ЕЗ |

Следующая таблица содержит приблизительные затраты единиц запросов для стандартных запросов, используемых в приложении:

| Запрос | Затраты единиц запроса | Число возвращенных элементов |
| --- | --- | --- |
| Выбор продуктов питания по идентификатору |~ 2,5 ЕЗ |1 |
| Выбор продуктов питания по производителю |~ 7 ЕЗ |7 |
| Выбор группы продуктов питания и сортировка по весу |~ 70 ЕЗ |100 |
| Выбор десяти первых продуктов питания в группе |~ 10 ЕЗ |10 |

> [!NOTE]
> Затраты единиц запроса зависят от количества возвращенных элементов.
> 
> 

На основе этой информации вы можете оценить необходимое количество единиц запроса для приложения, исходя из предполагаемого количества операций и запросов в секунду.

| Операции и запросы | Предполагаемое количество в секунду | Требуемое количество единиц запроса |
| --- | --- | --- |
| Create item (Создание элемента) |10 |150 |
| Чтение элемента |100 |100 |
| Выбор продуктов питания по производителю |25 |175 |
| Выбор продуктов питания по группе |10 |700 |
| Выбор первых десяти продуктов питания |15 |Всего 150 |

В этом примере вы можете ожидать среднюю потребность в производительности на уровне 1275 единиц запроса в секунду. Округляя это значение до сотен, для контейнера (или набора контейнеров) этого приложения нужно подготовить 1300 единиц запроса в секунду.

## <a id="RequestRateTooLarge"></a> Превышение лимита зарезервированной пропускной способности в Azure Cosmos DB
Использование единиц запроса вычисляется для каждой секунды отдельно. Количество обрабатываемых запросов для приложений будет ограничиваться, если стоимость запросов превышает подготовленное количество единиц запроса, пока загрузка не снизится до подготовленного уровня производительности. Если к запросам применяется ограничение, сервера принудительно завершает запрос с кодом состояния 429 (`RequestRateTooLargeException`) и возвращает заголовок `x-ms-retry-after-ms`. Этот заголовок содержит период ожидания в миллисекундах, которое пользователю следует ожидать до повторной отправки запроса.

    HTTP Status 429
    Status Line: RequestRateTooLarge
    x-ms-retry-after-ms :100

Если вы используете пакет SDK для клиента .NET и запросы LINQ, такое исключение вам вряд ли придется обрабатывать. Текущая версия пакета SDK для клиента .NET неявно перехватывает этот ответ, применяет указанный сервером период ожидания и автоматически повторяет попытку запроса. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

Если несколько клиентов работают одновременно в условиях превышения объема запросов, стандартная стратегия повторов может оказаться неэффективной, и тогда клиент создаст для приложения исключение `DocumentClientException` с кодом состояния 429. В таких случаях вы можете попробовать перенести логику и механизм повторов в приложение или увеличить подготовленную пропускную способность для контейнера (или набора контейнеров).

## <a name="next-steps"></a>Дополнительная информация
 
- Дополнительные сведения [о настройке и получении пропускной способности](set-throughput.md) с помощью портала Azure и пакета SDK.
- Инструкции по [проверке производительности и масштабирования для Azure Cosmos DB](performance-testing.md).
- Дополнительные сведения о зарезервированной производительности для баз данных Azure Cosmos DB см. в разделах [ценообразования для Azure Cosmos DB](https://azure.microsoft.com/pricing/details/cosmos-db/) и [секционирования данных в базе данных Azure Cosmos](partition-data.md).
- Дополнительные сведения см. в [документации по Azure Cosmos DB](https://azure.microsoft.com/documentation/services/cosmos-db/). 

[2]: ./media/request-units/RUEstimatorUpload.png
[3]: ./media/request-units/RUEstimatorDocuments.png
[4]: ./media/request-units/RUEstimatorResults.png
[5]: ./media/request-units/RUCalculator2.png

