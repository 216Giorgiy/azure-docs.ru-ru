---
title: JIT-доступ к виртуальным машинам в центре безопасности Azure | Документы Майкрософт
description: В этом документе описано, как управлять доступом к виртуальным машинам Azure в центре безопасности Azure с помощью JIT-доступа (доступ только в течение заданного времени).
services: security-center
documentationcenter: na
author: rkarlin
manager: MBaldwin
editor: ''
ms.assetid: ''
ms.service: security-center
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 10/10/2018
ms.author: rkarlin
ms.openlocfilehash: 98533e3c1454867ff09c53902f0f575d198452a3
ms.sourcegitcommit: 74941e0d60dbfd5ab44395e1867b2171c4944dbe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2018
ms.locfileid: "49320345"
---
# <a name="manage-virtual-machine-access-using-just-in-time"></a>Управление доступом к виртуальным машинам с помощью JIT

JIT-доступ к виртуальной машине позволяет заблокировать входящий трафик к виртуальным машинам Azure, снизить уязвимость к атакам и обеспечить удобный доступ к виртуальным машинам, когда это необходимо.

> [!NOTE]
> Функция JIT доступна в центре безопасности Azure уровня "Стандартный".  Дополнительные сведения о ценовых категориях центра безопасности см. на странице [Цены](security-center-pricing.md).
>
>

## <a name="attack-scenario"></a>Сценарий атаки

Целью атак методом подбора часто становятся порты управления как средство получения доступа к виртуальной машине. В случае успешной атаки злоумышленник может установить контроль над виртуальной машиной и закрепиться в вашей среде.

Один из способов снижения вероятности атаки методом подбора — ограничить количество времени, в течение которого порт открыт. Порты управления не должны быть открыты всегда. Они должны быть открыты только при подключении к виртуальной машине, например для выполнения задач управления или обслуживания. Если JIT-доступ включен, центр безопасности использует правила [группы безопасности сети](../virtual-network/security-overview.md#security-rules), которые ограничивают доступ к портам управления, чтобы они не стали целью злоумышленников.

![Сценарий JIT][1]

## <a name="how-does-just-in-time-access-work"></a>Как работает доступ JIT?

Если JIT включен, центр безопасности блокирует входящий трафик для виртуальной машины Azure путем создания правила группы безопасности сети. Вы выбираете порты на виртуальной машине, для которых будет заблокирован входящий трафик. Этими портами управляет решение JIT.

Когда пользователь запрашивает доступ к виртуальной машине, центр безопасности проверяет, что у пользователя есть разрешения [управления доступом на основе ролей (RBAC)](../role-based-access-control/role-assignments-portal.md), которые предоставляют доступ на запись для виртуальной машины. Если у пользователя есть разрешение на запись, доступ разрешается, и центр безопасности автоматически настраивает группу безопасности сети, которая разрешает передачу входящего трафика через выбранные порты на указанный период времени. После истечения этого времени центр безопасности восстанавливает прежнее состояние групп безопасности сети. Однако это не прерывает установленные подключения.

> [!NOTE]
> JIT-доступ с использованием центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. Дополнительные сведения о классической модели развертывания и модели развертывания Resource Manager см. в разделе [Модель развертывания Azure Resource Manager и классическая модель развертывания](../azure-resource-manager/resource-manager-deployment-model.md).
>
>

## <a name="using-just-in-time-access"></a>Использование JIT-доступа

1. Откройте панель мониторинга **центра безопасности**.

2. В левой области выберите **JIT-доступ к виртуальной машине**.

![Элемент "JIT-доступ к виртуальной машине"][2]

Откроется окно **JIT-доступ к виртуальной машине**.

![Элемент "JIT-доступ к виртуальной машине"][10]

В колонке **JIT-доступ к виртуальной машине** содержатся сведения о состоянии виртуальных машин.

- **Настроенные** — виртуальные машины, для которых был настроен JIT-доступ. Указываются сведения за последнюю неделю, которые включают число одобренных запросов, дату и время последнего доступа и последнего пользователя для каждой виртуальной машины.
- **Рекомендуемые** — виртуальные машины, которые поддерживают JIT-доступ, но для которых он не настроен. Рекомендуется включить JIT-доступ для этих виртуальных машин. Ознакомьтесь с разделом [Настройка политики JIT-доступа](#configuring-a-just-in-time-access-policy).
- **Нерекомендуемые** — причины, по которым виртуальная машина может попасть в эту группу, включают следующие:
  - Отсутствует группа безопасности сети — для решения JIT необходима группа безопасности сети.
  - Классическая виртуальная машина — JIT-доступ с использованием центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. JIT-доступ для классической модели развертывания не поддерживается.
  - Другое — виртуальная машина находится в этой категории, если решение JIT отключено в политике безопасности подписки или группы ресурсов или если виртуальная машина не имеет общедоступного IP-адреса и для нее не создана группа безопасности сети.

## <a name="configuring-a-just-in-time-access-policy"></a>Настройка политики JIT-доступа

Чтобы выбрать виртуальные машины, для которых вы хотите включить JIT-доступ, выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Рекомендуемые**.

  ![Включение JIT-доступа][3]

2. В разделе **Виртуальная машина** выберите виртуальные машины, доступ к которым нужно включить. При этом устанавливается флажок рядом с виртуальной машиной.
3. Выберите **Включить JIT-доступ для виртуальных машин**.
4. Щелкните **Сохранить**.

### <a name="default-ports"></a>Номера портов по умолчанию

Вы увидите номера портов, которые центр безопасности рекомендует открыть для JIT-доступа.

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Рекомендуемые**.

  ![Отображение номеров портов по умолчанию][6]

2. В разделе **Виртуальные машины** выберите виртуальную машину. При этом устанавливается флажок рядом с виртуальной машиной и открывается колонка **Настройка JIT-доступа к виртуальной машине**. В этой колонке отображаются порты по умолчанию.

### <a name="add-ports"></a>Добавление портов

В колонке **Настройка JIT-доступа к виртуальной машине** также можно добавить и настроить новый порт, который будет использоваться для JIT-доступа.

1. В колонке **Настройка JIT-доступа к виртуальной машине** выберите **Добавить**. Откроется колонка **Добавление конфигурации порта**.

  ![Конфигурация порта][7]

2. В колонке **Добавление конфигурации порта** укажите порт, тип протокола, допустимые IP-адреса источника и максимальное время запроса.

  Допустимые IP-адреса источника — это диапазоны IP-адресов, с которых можно получить доступ по утвержденному запросу.

  Максимальное время запроса — это максимальный интервал времени, в течение которого может быть открыт конкретный порт.

3. Нажмите кнопку **ОК**.

> [!NOTE]
>Если для виртуальной машины включен JIT-доступ, центр безопасности Azure создает правила запрета всего входящего трафика для выбранных портов в связанных группах безопасности сети. Правила будут иметь наивысший приоритет в группах безопасности сети или более низкий приоритет, чем уже имеющиеся правила. Это зависит от выполняемого центром безопасности анализа, в ходе которого определяется, является ли правило безопасным.
>


## <a name="set-just-in-time-within-a-vm"></a>Установка JIT в виртуальной машине

Чтобы упростить развертывание доступа JIT на виртуальных машинах, вы можете установить виртуальную машину и разрешить JIT-доступ только непосредственно из виртуальной машины.

1. На портале Azure выберите **Виртуальные машины**.
2. Щелкните виртуальную машину, которой вы хотите ограничить JIT-доступ.
3. В меню выберите **Конфигурация**.
4. В разделе **Just-in-time-access** (JIT-доступ) щелкните **Включить JIT-политику**. 

Это обеспечивает JIT-доступ для виртуальной машины с помощью следующих параметров:

- Серверы Windows:
    - RDP-порт 3389;
    - 3 часа доступа;
    - для разрешенных исходных IP-адресов установлен параметр "На один запрос".
- Серверы Linux:
    - SSH-порт 22;
    - 3 часа доступа;
    - для разрешенных исходных IP-адресов установлен параметр "На один запрос".
     
Если в виртуальной машине уже включена функция JIT, вы увидите это при переходе на страницу конфигурации. Кроме того, вы можете перейти по этой ссылке, чтобы открыть политику в центре безопасности Azure для просмотра и изменения параметров.

![Настройка JIT в виртуальной машине](./media/security-center-just-in-time/jit-vm-config.png)


## <a name="requesting-access-to-a-vm"></a>Запрос доступа к виртуальной машине

Чтобы запросить доступ к виртуальной машине, выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Настроенные**.
2. В разделе **Виртуальные машины** выберите виртуальные машины, для которых вы хотите включить JIT-доступ. При этом устанавливается флажок рядом с виртуальной машиной.
3. Выберите **Запросить доступ**. При этом откроется колонка **Запрос на доступ**.

  ![Запрос доступа к виртуальной машине][4]

4. В колонке **Запрос на доступ** для каждой виртуальной машины необходимо указать открытые порты, IP-адрес источника, на котором открыт порт, и временной интервал, в течение которого открыт порт. Можно запросить доступ только к портам, которые настроены в политике JIT. Максимально допустимое время для каждого порта определяется из политики JIT.
5. Выберите **Открыть порты**.

> [!NOTE]
> Когда пользователь запрашивает доступ к виртуальной машине, центр безопасности проверяет, что у пользователя есть разрешения [управления доступом на основе ролей (RBAC)](../role-based-access-control/role-assignments-portal.md), которые предоставляют доступ на запись для виртуальной машины. Если у него есть разрешения на запись, то запрос утверждается.
>
>

> [!NOTE]
> Если пользователь запрашивает доступ через прокси-сервер, то параметр "Мой IP-адрес" может не работать. Возможно, необходимо определить полный диапазон адресов организации.
>
>

## <a name="editing-a-just-in-time-access-policy"></a>Изменение политики JIT-доступа

Вы можете изменить существующую политику JIT-доступа для виртуальной машины, добавив и настроив новый открытый порт для этой виртуальной машины или изменив любой другой параметр уже настроенного защищенного порта.

Для изменения существующей политики JIT-доступа виртуальной машины используется вкладка **Настроенные**:

1. В разделе **Виртуальные машины** выберите виртуальную машину, для которой необходимо добавить порт, щелкнув многоточие в строке для этой виртуальной машины. Откроется меню.
2. Выберите **Изменить** в меню. Откроется колонка **Настройка JIT-доступа к виртуальной машине**.

  ![Изменение политики][8]

3. В колонке **Настройка JIT-доступа к виртуальной машине** можно изменить существующие параметры уже защищенного порта, щелкнув его, или добавить новый порт, щелкнув **Добавить**. Откроется колонка **Добавление конфигурации порта**.

  ![Добавление порта][7]

4. В колонке **Добавление конфигурации порта** укажите порт, тип протокола, допустимые IP-адреса источника и максимальное время запроса.
5. Нажмите кнопку **ОК**.
6. Щелкните **Сохранить**.

## <a name="auditing-just-in-time-access-activity"></a>Аудит действий JIT-доступа

Для просмотра действий виртуальной машины можно воспользоваться поиском по журналам. Для просмотра журналов выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Настроенные**.
2. В разделе **Виртуальные машины** выберите виртуальную машину, сведения о которой нужно просмотреть, щелкнув многоточие в строке для этой виртуальной машины. Откроется меню.
3. Выберите **Журнал действий** в меню. Откроется колонка **Журнал действий**.

  ![Выбор журнала действий][9]

  В колонке **Журнал действий** отображается отфильтрованный список предыдущих операций для этой виртуальной машины, а также дата, время и подписка.

Чтобы скачать сведения журналов, воспользуйтесь ссылкой **Щелкните здесь, чтобы загрузить все элементы в формате CSV**.

Чтобы изменить отображаемые сведения журнала, измените фильтры и нажмите **Применить**.

## <a name="using-just-in-time-vm-access-via-rest-apis"></a>Использование JIT-доступа к виртуальной машине через REST API

Функцию JIT-доступа к виртуальной машине можно использовать через API центра безопасности Azure. Этот API позволяет получать сведения о настроенных виртуальных машинах, добавлять новые виртуальные машины, запрашивать доступ к ним и выполнять другие действия. Дополнительные сведения о REST API JIT-доступа см. в статье [Jit Network Access Policies](https://docs.microsoft.com/rest/api/securitycenter/jitnetworkaccesspolicies) (Политики JIT-доступа к сети).

## <a name="using-just-in-time-vm-access-via-powershell"></a>Использование JIT-доступа через PowerShell 

Чтобы применять решение JIT-доступа к виртуальной машине через PowerShell, можно использовать официальные командлеты PowerShell центра безопасности Azure, в частности `Set-AzureRmJitNetworkAccessPolicy`.

В следующем примере задается политика JIT-доступа на конкретной виртуальной машине и выполняются следующие действия.
1.  Закрытие портов 22 и 3389.
2.  Задание максимального временного окна в 3 часа для каждого порта, чтобы они были открыты для каждого утвержденного запроса.
3.  Предоставление пользователю, который запрашивает доступ, разрешения на управление исходными IP-адресами, и предоставление пользователю возможности установить сеанс после утвержденного запроса на JIT-доступ.

В PowerShell выполните следующее.

1.  Назначение переменной, которая содержит только политику JIT-доступа для виртуальной машины.

        $JitPolicy = (@{
         id="/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
             number=22;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"},
             @{
             number=3389;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"})})

2.  Вставка политики JIT-доступа для виртуальной машины в массив.
    
        $JitPolicyArr=@($JitPolicy)

3.  Настройка политики JIT-доступа на выбранной виртуальной машине.
    
        Set-AzureRmJitNetworkAccessPolicy -Kind "Basic" -Location "LOCATION" -Name "default" -ResourceGroupName "RESOURCEGROUP" -VirtualMachine $JitPolicyArr 

### <a name="requesting-access-to-a-vm"></a>Запрос доступа к виртуальной машине

В следующем примере приведен запрос на JIT-доступ к выбранной виртуальной машине, где запрашивается открытие порта 22 для определенного IP-адреса и на определенное время.

В PowerShell выполните следующее.
1.  Настройка свойств запроса доступа к виртуальной машине.

        $JitPolicyVm1 = (@{
          id="/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
           number=22;
           endTimeUtc="2018-09-17T17:00:00.3658798Z";
           allowedSourceAddressPrefix=@("IPV4ADDRESS")})})
2.  Вставка параметров запроса доступа к виртуальной машине в массив.

        $JitPolicyArr=@($JitPolicyVm1)
3.  Отправка запроса на доступ (с использованием идентификатора ресурса, полученного на шаге 1).

        Start-AzureRmJitNetworkAccessPolicy -ResourceId "/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Security/locations/LOCATION/jitNetworkAccessPolicies/default" -VirtualMachine $JitPolicyArr

Дополнительные сведения см. в документации по командлетам PowerShell.


## <a name="next-steps"></a>Дополнительная информация
Из этой статьи вы узнали, как управлять доступом к виртуальным машинам Azure с помощью JIT-доступа в центре безопасности.

Дополнительные сведения о Центре безопасности см. в следующих статьях:

- [Настройка политик безопасности](security-center-policies.md) — сведения о настройке политик безопасности для подписок и групп ресурсов Azure.
- [Управление рекомендациями по безопасности](security-center-recommendations.md) — сведения об использовании рекомендаций для защиты ресурсов Azure.
- [Наблюдение за работоспособностью системы безопасности](security-center-monitoring.md) — сведения об отслеживании работоспособности ресурсов Azure.
- [Управление оповещениями безопасности](security-center-managing-and-responding-alerts.md) — сведения об управлении оповещениями системы безопасности и реагировании на них.
- [Мониторинг решений партнеров](security-center-partner-solutions.md) — сведения об отслеживании работоспособности решений партнеров.
- [Центр безопасности: часто задаваемые вопросы](security-center-faq.md). Часто задаваемые вопросы об использовании этой службы.
- [Блог по безопасности Azure](https://blogs.msdn.microsoft.com/azuresecurity/) — публикации блога, посвященные безопасности и соответствию требованиям в Azure.


<!--Image references-->
[1]: ./media/security-center-just-in-time/just-in-time-scenario.png
[2]: ./media/security-center-just-in-time/just-in-time.png
[10]: ./media/security-center-just-in-time/just-in-time-access.png
[3]: ./media/security-center-just-in-time/enable-just-in-time-access.png
[4]: ./media/security-center-just-in-time/request-access-to-a-vm.png
[5]: ./media/security-center-just-in-time/activity-log.png
[6]: ./media/security-center-just-in-time/default-ports.png
[7]: ./media/security-center-just-in-time/add-a-port.png
[8]: ./media/security-center-just-in-time/edit-policy.png
[9]: ./media/security-center-just-in-time/select-activity-log.png
