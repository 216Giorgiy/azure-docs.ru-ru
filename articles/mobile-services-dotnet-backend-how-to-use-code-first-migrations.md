<properties pageTitle="Использование Code First Migrations серверной части .NET (мобильные службы)" metaKeywords="" description="" metaCanonical="" services="" documentationCenter="" title="Рекомендации для поддержки нескольких клиентов из одной мобильной службы" authors="glenga" solutions="" writer="glenga" manager="dwrede" editor="" />

# Изменение модели данных в мобильной службе серверной части .NET

В проекте мобильной службы .NET инициализатор базы данных Code First Entity Framework является производным от класса [DropCreateDatabaseIfModelChanges]. Этот инициализатор сообщает Entity Framework о необходимости удалить и повторного создать базу данных при обнаружении изменения модели данных, предоставляемого [DbContext]. Следует продолжать использовать этот инициализатор во время локальной разработки проекта мобильной службы. В учебники для .NET предполагается, что используется этот инициализатор. Однако в ситуациях, когда необходимо изменить модель данных и сохранить существующие данные в базе данных, необходимо использовать Code First Migrations. Code First Migrations — это также хорошее решение для публикации изменений модели данных в Azure, так как базу данных SQL удалить нельзя.

В этом разделе показано, как использовать Code First Migrations для изменения модели данных существующей базы данных SQL без потери существующих данных. В этой процедуре предполагается, что вы уже опубликовали проект мобильной службы в Azure, в базе данных уже есть данные и удаленная и локальная модели данных по-прежнему синхронизированы.

>[WACOM.NOTE]Мы рекомендуем завершить разработку модели данных на локальном компьютере, насколько это возможно, перед публикацией в Azure. Если вы уже опубликовали проект мобильной службы для .NET в Azure и схема таблицы базы данных SQL не соответствует текущей модели данных проекта, необходимо удалить таблицы или вручную синхронизировать их перед публикацией с помощью Code First Migrations. 

При разработке проекта мобильной службы для .NET на локальном компьютере самый простой способ работать с изменениями модели данных — продолжать использовать инициализатор по умолчанию, который удаляет и повторно создает базу данных при обнаружении изменения модели данных. Этот подход не работает при повторной публикации проекта в Azure. Инициализатор вызывает ошибку, так как у среды выполнения нет разрешений для удаления базы данных SQL в Azure, что очень хорошо. 

>[WACOM.NOTE]Во время разработки и тестирования проекта мобильной службы с действующими службами Azure следует всегда использовать экземпляр мобильной службы, предназначенный для тестирования. Никогда не используйте для разработки и тестирования мобильную службу, которая работает в производственной среде или используется клиентскими приложениями.

## Удаление таблиц в базе данных SQL

До использования Migrations в Azure для базы данных SQL следует вручную удалить все существующие таблицы в схеме базы данных, используемой мобильной службой. Выполните следующие действия для удаления существующих таблиц из базы данных SQL. Если схема базы данных уже синхронизирована с текущей моделью данных, этот этап можно пропустить и перейти к [миграции].

1. Войдите на [портал управления Azure], выберите мобильную службу, откройте вкладку **Настройка** и щелкните ссылку **База данных SQL**. 

	![][0]

	Откроется страница портала для базы данных, используемой мобильной службой.

2. Нажмите кнопку **Управление** и войдите на сервер базы данных SQL. 

	![][1]

3. В диспетчере базы данных SQL щелкните **Конструирование**, щелкните **Таблицы**, выберите таблицу в схеме мобильной службы, нажмите кнопку **Удалить таблицу**, а затем нажмите **ОК** для подтверждения.

	![][2]
   
4. Повторите предыдущий шаг для каждой таблицы в схеме мобильной службы.

	После удаления существующих таблиц Code First Migrations можно инициализировать в базе данных SQL. Таблицы, которые не принадлежат схеме мобильной службы, не влияют на ее работу и их не следует удалять.

## <a name="migrations"></a>Включение Code First Migrations

Компонент Code First Migrations использует метод создания моментальных снимков для формирования кода, во время выполнения которого изменения схемы записываются в базу данных. С помощью Code First Migrations вы можете вносить добавочные изменения в модель данных и сохранить при этом существующие данные в базе данных. Следующие действия включают Code First Migrations и применяют изменения модели данных в проекте, локальной базе данных и в Azure. 

1. В обозревателе решений в Visual Studio щелкните правой кнопкой мыши проект мобильной службы и выберите **Назначить запускаемым проектом**.
 
2. В меню **Сервис** разверните узел **Диспетчер пакетов NuGet** и щелкните **Консоль диспетчера пакетов**.

	Откроется консоль диспетчера пакетов, с помощью которой вы будете управлять Code First Migrations.

3. В консоли диспетчера пакетов введите следующую команду:

		PM> Enable-Migrations

	При этом компонент Code First Migrations будет включен для вашего проекта.

4. В консоли введите следующую команду:

		PM> Add-Migration Initial

	Будет создана новая миграция с именем *Initial*. Код миграции хранится в папке Migrations проекта.

5. Разверните папку App_Start, откройте файл проекта WebApiConfig.cs и добавьте следующие инструкции **using**:

		using System.Data.Entity.Migrations;
		using todolistService.Migrations;

	В приведенном выше коде необходимо заменить строку _todolistService_ на пространство имен вашего проекта. Для загруженного примера проекта это <em>mobile&#95;service&#95;name</em>Service.  
 
6. В этом же файле кода закомментируйте вызов метода **Database.SetInitializer** и добавьте следующий код после него:

        var migrator = new DbMigrator(new Configuration());
        migrator.Update();

	При этом инициализатор базы данных Code First по умолчанию, который удаляет и повторно создает базу данных, будет отключен и заменен на явный запрос на применение последней миграции. На этом этапе все изменения модели данных приведут к появлению исключения InvalidOperationException при обращении к данным, если для них не была создана миграция. Забегая вперед скажем, что служба должна использовать Code First Migrations для миграции изменений модели данных в базу данных.

7.  Нажмите клавишу F5 для запуска проекта мобильной службы на локальном компьютере.
 
	В этот момент база данных синхронизирована с моделью данных. Если вы указали начальные значения данных, их можно проверить, щелкнув **Try it out**, **GET tables/todoitem**, затем **Try this out** и **Send**. Дополнительные сведения см. в разделе [Заполнение данных при миграции].

8.   Теперь внесите изменение в модель данных, например добавьте новое свойство UserId в тип TodoItem, перестройте проект и в диспетчере пакетов выполните следующую команду:

		PM> Add-Migration NewUserId
                                                               
	Будет создана новая миграция с именем *NewUserId*. В папку Migrations добавляется новый файл кода, который реализует данное изменение.  

9.  Нажмите клавишу F5 еще раз для перезапуска проекта мобильной службы на локальном компьютере.

	Миграция применяется к базе данных, после чего она снова синхронизируется с моделью данных. Если вы указали начальные значения данных, их можно проверить, щелкнув **Try it out**, **GET tables/todoitem**, затем **Try this out** и **Send**. Дополнительные сведения см. в разделе [Заполнение данных при миграции].

10. Повторно опубликуйте мобильную службу в Azure, а затем запустите клиентское приложение, чтобы получить доступ к данным и убедиться, что данные загружаются без ошибок. 

13. (Необязательно) На [портале управления Azure] выберите мобильную службу, откройте вкладку **Настройка** и щелкните ссылку **База данных SQL**. 

	![][0]

	При этом откроется страница базы данных SQL для базы данных вашей мобильной службы.

14. (Необязательно) Нажмите кнопку **Управление**, войдите на сервер базы данных SQL, а затем нажмите кнопку **Конструирование** и убедитесь, что изменения схемы внесены в Azure. 

    ![][1] 


##<a name="seeding"></a>Заполнение данных при миграции

Компонент Migrations может добавить начальные данные в базу данных при выполнении миграции. Класс Configuration содержит метод Seed, который можно переопределить для вставки или обновления данных. При включении компонента Migrations файл кода Configuration.cs добавляется в папку Migrations. В этих примерах показано, как переопределить метод [Seed] для инициализации данных для таблицы **TodoItems**. Метод [Seed] вызывается после перехода на последнюю версию. 

###Заполнение новой таблицы

Следующий код заполняет таблицу **TodoItems** новыми строками данных:

        List<TodoItem> todoItems = new List<TodoItem>
        {
            new TodoItem { Id = "1", Text = "First item", Complete = false },
            new TodoItem { Id = "2", Text = "Second item", Complete = false },
        };

        foreach (TodoItem todoItem in todoItems)
        {
            context.Set<TodoItem>().Add(todoItem);
        }
        base.Seed(context);

###Заполнение нового столбца в таблице

Следующий код заполняет только столбец UserId:
 		    
        context.TodoItems.AddOrUpdate(
            t => t.UserId,
                new TodoItem { UserId = 1 },
                new TodoItem { UserId = 1 },
                new TodoItem { UserId = 2 }
            );
        base.Seed(context);

Этот код вызывает вспомогательный метод расширения [AddOrUpdate] для добавления данных инициализации в новый столбец UserId. При использовании [AddOrUpdate] повторяющиеся строки не создаются.

<!-- Anchors -->
[Миграции]: #migrations
[Заполнение данных при миграции]: #seeding

<!-- Images -->
[0]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/navagate-to-sql-database.png
[1]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/manage-sql-database.png
[2]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/sql-database-drop-tables.png

<!-- URLs -->
[DropCreateDatabaseIfModelChanges]: http://msdn.microsoft.com/query/dev12.query?appId=Dev12IDEF1&l=ru-ru&k=k("System.Data.Entity.DropCreateDatabaseIfModelChanges`1");k(TargetFrameworkMoniker-.NETFramework,Version%3Dv4.5);k(DevLang-csharp)&rd=true
[Seed]: http://msdn.microsoft.com/ru-ru/library/hh829453(v=vs.113).aspx
[портале управления Azure]: https://manage.windowsazure.com/
[DbContext]: http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbcontext(v=vs.113).aspx
[AddOrUpdate]: http://msdn.microsoft.com/ru-ru/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx

