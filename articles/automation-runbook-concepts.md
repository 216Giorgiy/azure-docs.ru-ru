<properties 
   pageTitle="Основные понятия службы автоматизации Azure для модулей Runbook"
   description="Описание основных понятий, которые необходимо усвоить при создании модулей Runbook в службе автоматизации Azure."
   services="automation"
   documentationCenter=""
   authors="bwren"
   manager="stevenka"
   editor="tysonn" />
<tags 
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/13/2015"
   ms.author="bwren" />

# Основные принципы службы автоматизации Azure для модулей Runbook

Модули Runbook в службе автоматизации Azure реализованы в виде рабочих процессов Windows PowerShell. В этом разделе представлен краткий обзор критически важных функций рабочих процессов, которые происходят в модулях Runbook службы автоматизации. Подробные сведения о рабочих процессах доступны в разделе [Приступая к работе с рабочим процессом Windows PowerShell](http://technet.microsoft.com/library/jj134242.aspx).


## Рабочие процессы Windows PowerShell

Рабочий процесс представляет собой последовательность запрограммированных взаимосвязанных шагов для выполнения долгосрочных задач или требует координации шагов на множестве устройств или управляемых узлах. Преимущества рабочего процесса в сравнении с использованием обычного скрипта заключаются в возможности одновременного выполнения действия по отношению ко многим устройствам и в возможности автоматического восстановления при сбоях. Рабочий процесс Windows PowerShell представляет собой скрипт Windows PowerShell, который использует Windows Workflow Foundation. В то время как рабочий процесс прописан в синтаксисе Windows PowerShell и запускается Windows PowerShell, его обработка выполняется в Windows Workflow Foundation.

### Базовая структура

Рабочий процесс Windows PowerShell начинается с ключевого слова **Workflow**, за которым следует текст скрипта, заключенный в фигурные скобки. Имя рабочего процесса следует за ключевым словом **Workflow**, как это показано в следующем синтаксисе. Имя рабочего процесса соответствует имени модуля Runbook в службе автоматизации.

    Workflow Test-Runbook
    {
       <Commands>
    }

Чтобы добавить параметры в рабочий процесс, используйте ключевое слово **Param**, как показано в следующем синтаксисе. Портал управления выведет пользователю запрос на предоставление значений для этих параметров при запуске модуля Runbook. В этом примере используется дополнительный атрибут Parameter, который указывает, является ли параметр обязательным.

    Workflow Test-Runbook
    {
      Param
      (
       [Parameter(Mandatory=<$True | $False>]
       [Type]$<ParameterName>,

       [Parameter(Mandatory=<$True | $False>]
       [Type]$<ParameterName>
      )
      <Commands>
    }

### Именование

Имя рабочего процесса должно соответствовать формату "глагол-существительное", который является стандартным для Windows PowerShell. Вы можете обратиться к разделу [Утвержденные глаголы, используемые в командах Windows PowerShell](http://msdn.microsoft.com/library/windows/desktop/ms714428(v=vs.85).aspx), чтобы ознакомиться со списком глаголов, утвержденных для использования. Имя рабочего процесса должно соответствовать имени модуля Runbook в службе автоматизации. При импорте модуля Runbook имя файла должно соответствовать имени рабочего процесса и должно заканчиваться на .ps1.

### Ограничения

Полный список ограничений и синтаксических отличий между рабочими процессами Windows PowerShell и Windows PowerShell см. в разделе [Синтаксические различия между рабочими процессами в виде скриптов и скриптами](http://technet.microsoft.com/library/jj574140.aspx).

## Действия

Действие — это конкретная задача в рабочем процессе. Так же как скрипт состоит из одной или нескольких команд, рабочий процесс состоит из одного или нескольких действий, которые выполняются в последовательности. Рабочий процесс Windows PowerShell автоматически преобразует множество командлетов Windows PowerShell в действия при выполнении рабочего процесса. Если указать один из этих командлетов в модуле Runbook, соответствующее действие фактически запускается в Windows Workflow Foundation. Для командлетов, для которых не существует соответствующего действия, рабочий процесс Windows PowerShell автоматически запустит командлет в действии [InlineScript](#inlinescript). Существует набор командлетов, которые исключаются и не могут использоваться в рабочем процессе, если они явно не включены в блок InlineScript. Дополнительные сведения об этих понятиях см. в разделе [Использование действий в рабочих процессах скриптов](http://technet.microsoft.com/library/jj574194.aspx).

Действия рабочих процессов совместно используют набор общих параметров для настройки их работы. Сведения об общих параметрах рабочего процесса см. в разделе [about_WorkflowCommonParameters](http://technet.microsoft.com/library/jj129719.aspx).

## Модули интеграции

*Модуль интеграции* — это пакет, который содержит модуль Windows PowerShell и который может быть импортирован в службу автоматизации Azure. Командлеты в модулях интеграции, импортируемые в службу автоматизации Azure, автоматически доступны для всех модулей Runbook в одной и той же учетной записи службы автоматизации. Поскольку служба автоматизации Azure основана на Windows PowerShell 4.0, она поддерживает автоматическую загрузку модулей, что означает, что командлеты из установленных модулей можно использовать без их импорта в скрипт при помощи команды [Import-Module](http://technet.microsoft.com/library/hh849725.aspx).

## Параллельное выполнение

Одним из преимуществ рабочих процессов Windows PowerShell является возможность выполнять набор команд параллельно, а не последовательно, как это делается в стандартном скрипте. Это особенно полезно в модулях Runbook, поскольку они могут выполнять несколько действий, требующих значительного времени для завершения. Например, модуль Runbook может выделять набор виртуальных машин. Вместо последовательного выполнения каждой операции подготовки действия могут выполняться одновременно, что повышает общую эффективность. Модуль Runbook продолжит работу только после выполнения всех задач.

Можно использовать ключевое слово **Parallel**, чтобы создать блок скрипта с несколькими командами, которые будут выполняться параллельно. Для этого используется приведенный ниже синтаксис. В этом случае действия Activity1 и Activity2 будут запущены одновременно. Действие Activity3 запустится только после завершения действий Activity1 и Activity2.

    Parallel
    {
      <Activity1>
      <Activity2>
    }
    <Activity3>

Можно использовать конструкцию **ForEach -Parallel** для обработки команд для каждого элемента в коллекции одновременно. Элементы в коллекции обрабатываются параллельно, а команды в блоке скрипта выполняются последовательно. Для этого используется приведенный ниже синтаксис. В этом случае действие Activity1 будет запущено одновременно для всех элементов в коллекции. Для каждого элемента действие Activity2 будет запускаться после завершения действия Activity1. Действие Activity3 запустится только после завершения действий Activity1 и Activity2 для всех элементов.

    ForEach -Parallel ($<item> in $<collection>)
    {
      <Activity1>
      <Activity2>
    }
    <Activity3>

Ключевое слово **Sequence** используется для запуска команд в последовательности внутри блока скрипта **Parallel**. Блок скрипта **Sequence** работает параллельно с другими командами, однако команды внутри блока будут работать последовательно. Для этого используется приведенный ниже синтаксис. В этом случае действия Activity1, Activity2 и Activity3 будут запущены одновременно. Действие Activity4 будет запущено только после завершения действия Activity3. Действие Activity5 будет запущено только после завершения всех остальных действий.

    Parallel
    {
      <Activity1>
      <Activity2>

      Sequence 
      { 
        <Activity3>  
        <Activity4>
      }

    }
    <Activity5>

## Контрольные точки

*Контрольная точка* представляет собой моментальный снимок текущего состояния рабочего процесса, который включает текущие значения переменных и любые выходные данные, созданные для этой точки. Последняя завершенная контрольная точка в модуле Runbook сохраняется в базе данных службы автоматизации, чтобы рабочий процесс мог восстановиться при возникновении таких неполадок, как отключение питания компьютера во время выполнения. Без контрольной точки рабочий процесс начал бы выполняться с самого начала. Данные контрольных точек удаляются после завершения задания модуля Runbook.

Можно установить контрольную точку для рабочего процесса при помощи действия **Checkpoint-Workflow**. При включении этого действия в модуль Runbook немедленно создается контрольная точка. При приостановке работы модуля Runbook из-за исключения, когда задание будет возобновлено, оно будет возобновлено с момента, соответствующего последней установленной контрольной точке.

В следующем примере кода исключение возникает после действия Activity2, которое вызвало приостановку модуля Runbook. При возобновлении задания оно запускается с действия Activity2, поскольку оно следует сразу за последней установленной контрольной точкой.

    <Activity1>
    Checkpoint-Workflow
    <Activity2>
    <Exception>
    <Activity3>

Контрольные точки в модуле Runbook необходимо задать после действий, которые могут подвергаться исключениям и которые не должны повторяться при возобновлении выполнения модуля Runbook. Например, модуль Runbook может создать виртуальную машину. Контрольную точку следует создавать как до, так и после команды создания виртуальной машины. В случае сбоя при создании команды повторяются при возобновлении выполнения модуля Runbook. При успешном создании виртуальной машины с последующим сбоем работы модуля Runbook виртуальная машина не будет создана повторно при возобновлении выполнения модуля Runbook.

Дополнительные сведения о контрольных точках см. в разделе [Добавление контрольных точек в рабочем процессе скрипта](http://technet.microsoft.com/library/jj574114.aspx).

## Приостановка рабочего процесса

Можно выполнить принудительную приостановку модуля Runbook при помощи действия **Suspend-Workflow**. При выполнении этого действия будет установлена контрольная точка, после чего рабочий процесс будет немедленно приостановлен. Приостановка рабочего процесса полезна для модулей Runbook, которые могут потребовать выполнения действия вручную перед запуском другого набора действий.

Дополнительные сведения о приостановке рабочего процесса см. в разделе [Как задать приостановку выполнения рабочего процесса](http://technet.microsoft.com/library/jj574175.aspx).

## InlineScript

Действие **InlineScript** выполняет блок команд в традиционном скрипте PowerShell вместо рабочего процесса PowerShell и возвращает выходные данные в рабочий процесс. Пока команды в рабочем процессе отправляются в Windows Workflow Foundation для обработки, команды в блоке InlineScript обрабатываются при помощи Windows PowerShell. Это действие использует общие параметры стандартного рабочего процесса, в том числе **PSCredential**, который позволяет указать, что определенный блок кода должен быть выполнен с использованием других учетных данных.

InlineScript использует описанный ниже синтаксис.

    InlineScript
    {
      <Script Block>
    } <Common Parameters>

В то время как выполнение действий InlineScript может быть критически важно в некоторых модулях Runbook, они не поддерживают конструкции рабочих процессов и должны использоваться тогда, когда это необходимо по следующим причинам.

- Вы не можете использовать контрольные точки внутри блока InlineScript. Если в блоке происходит сбой, его выполнение должно быть возобновлено с начала блока.
- InlineScript влияет на масштабируемость модуля Runbook, поскольку содержит сеанс Windows PowerShell для всей продолжительности блока InlineScript.
- Такие действия, как Get-AutomationVariable и Get-AutomationPSCredential, недоступны в блоке InlineScript.  

Если все же необходимо использовать InlineScript, следует ограничить его область действия. Например, если ваш модуль Runbook выполняет проход коллекции, одновременно применяя одну и ту же операцию к каждому элементу, цикл должен происходить за пределами сценария InlineScript. Это обеспечивает следующие преимущества.

- Вы можете создавать [контрольные точки](#checkpoints) рабочего процесса после каждой итерации. Если задание приостанавливается или прерывается, после чего возобновляется, цикл можно будет возобновить.
- Можно использовать **ForEach –Parallel** для параллельной обработки элементов коллекции.

Если вы используете InlineScript в модуле Runbook, следует учитывать следующие рекомендации.

- Поддерживается передача значения в скрипт, хотя для этого требуется модификатор масштаба **$Using**. Например, переменная с именем $abc, установленная за пределами InlineScript, внутри сценария InlineScript преобразуется в переменную $using:abc.

- Чтобы возвратить выходные данные из сценария InlineScript, назначьте выход для переменной и выводите любые данные, которые необходимо вывести в выходной поток. В следующем примере строка "Привет" присваивается переменной с именем $output.

	<pre><code>$output = InlineScript { Write-Output "Привет" }</code></pre>

- Избегайте определения рабочих процессов в области InlineScript. Хотя некоторые рабочие процессы могут по внешним признакам работать правильно, этот сценарий не проверен. В результате могут возникнуть неожиданные сообщения об ошибках или непредвиденное поведение.

Дополнительные сведения об использовании InlineScript см. в разделе [Запуск команд Windows PowerShell в рабочем процессе](http://technet.microsoft.com/library/jj574197.aspx) и [about_InlineScript](http://technet.microsoft.com/library/jj649082.aspx).


## Связанные статьи

- [Создание или импорт модуля Runbook](http://technet.microsoft.com/library/dn919921.aspx)

<!---HONumber=58-->