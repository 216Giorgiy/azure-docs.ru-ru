<properties urlDisplayName="Troubleshoot the Mobile Services .NET Backend" pageTitle="Устранение неполадок серверной части .NET мобильных служб - мобильные службы Azure" metaKeywords="" description="Узнайте, как определить и устранить проблемы в работе мобильных служб, использующих серверную часть .NET" metaCanonical="" services="" documentationCenter="Mobile" title="Troubleshoot the Mobile Services .NET Backend" authors="mahender" solutions="" manager="dwrede" editor="mollybos" />

<tags ms.service="mobile-services" ms.workload="mobile" ms.tgt_pltfrm="mobile-multiple" ms.devlang="multiple" ms.topic="article" ms.date="11/11/2014" ms.author="mahender" />
# Устранение неполадок серверной части .NET мобильных служб

Разработка с использованием мобильных служб обычно не представляет трудностей, но иногда что-то может пойти не так. В этом учебнике рассматриваются некоторые методы, позволяющие устранять распространенные проблемы, которые могут возникать в серверной части .NET мобильных служб. 

1. [Отладка HTTP](#HttpDebugging)
2. [Отладка во время выполнения](#RuntimeDebugging)
3. [Анализ журналов диагностики](#Logs)
4. [Отладка разрешения облачной сборки](#AssemblyResolution)
5. [Устранение неполадок миграций Entity Framework](#EFMigrations)

<a name="HttpDebugging"></a>
## Отладка HTTP

При разработке приложений с использованием мобильных служб обычно используется преимущество пакета SDK клиента мобильных служб для соответствующей платформы (Магазин Windows, iOS, Android и т. п.). Однако иногда полезно перейти вниз на уровень HTTP и понаблюдать за необработанными вызовами, как они выполняются в сети. В частности, такой подход используется при отладке проблем с подключением и сериализацией. В серверной части .NET мобильных служб можно объединять этот подход с локальной и удаленной отладкой в среде Visual Studio (подробности в следующем разделе), чтобы получить полное представление о том, какой путь проделывает HTTP-вызов, прежде чем вызвать код вашей службы.  

Для отправки и проверки HTTP-трафика можно использовать любой отладчик HTTP. В этих целях разработчики часто используют популярный инструмент [Fiddler](http://www.telerik.com/fiddler). Чтобы облегчить работу разработчиков, мобильные службы предоставляют веб-отладчик HTTP (также называемый "тестовым клиентом") вместе с мобильной службой, что снижает потребность во внешних инструментах. Когда мобильная служба размещается локально, она будет доступна по URI, подобному [http://localhost:59233](http://localhost:59233), а при размещении в облаке URI будет иметь вид [http://todo-list.azure-mobile.net](http://todo-list.azure-mobile.net). Следующие шаги выполняются одинаково независимо от места размещения службы:

1. Начните с серверного проекта мобильных служб, открыв его в **Visual Studio 2013 с обновлением 2** или последующих версий. Если у вас нет подходящего проекта, его можно создать, последовательно выбрав в меню пункты **Файл**, **Создать**, **Проект**, затем выбрав режим **Облако** и указав шаблон **Мобильные службы Windows Azure**.
2. Нажмите клавишу **F5**, чтобы построить и запустить проект. На начальной странице нажмите ссылку **try it out** (испытать). 

    >[WACOM.NOTE] 
    > Если служба размещена локально, нажатие этой ссылки направит вас на следующую страницу. Однако при размещении в облаке будет предложено указать учетные данные. Это гарантирует, что пользователи, не прошедшие проверку подлинности, не получат доступ к сведениям об API и к полезным данным. Чтобы увидеть эту страницу, необходимо выполнить вход с **пустым именем пользователя** и **ключом приложения** в качестве пароля. Ключ приложения можно найти на **портале управления Azure**, перейдя на вкладку **Панель мониторинга** для соответствующей мобильной службы и выбрав пункт **Управление ключами**.
    >
    > ![Authentication prompt to access help page][HelpPageAuth]

3. На открывшейся странице (которая также называется "страница справки") отображается список всех API HTTP, которые делает доступными ваша мобильная служба. Выберите один из API (если вы начали с использования шаблона проекта мобильных служб в среде Visual Studio, то должны видеть **GET tables/TodoItem**).

    ![Help page][HelpPage]

4. Полученная  страница показывает всю документацию и примеры JSON запроса и ответа, которые ожидает API. Нажмите кнопку **try this out** (испытать).

    ![Test page for an API][HelpPageApi]

5. Это тестовый клиент, с помощью которого можно отправить HTTP-запрос, чтобы испытать API. Нажмите **отправить**.

    ![Test client][TestClient]

6. Появится HTTP-ответ, вернувшийся от мобильной службы непосредственно в окно браузера. 

    ![Test client with HTTP response][TestClientResponse]

Теперь вы готовы для исследования других API HTTP, предоставляемых мобильной службой для удобства использования веб-браузера.

<a name="RuntimeDebugging"></a>
## Отладка во время выполнения

Одной из важнейших особенностей серверной части .NET является не только возможность локальной отладки кода службы, но также отладки кода, работающего в текущий момент в облачной среде. Выполните следующие действия.

1. Откройте проект мобильной службы, который требуется отладить, в **Visual Studio 2013 с обновлением 2** или последующих версий.
2. Настройте загрузку символов. Перейдите в меню **Отладка** и выберите пункт **Параметры и настройки**. Убедитесь, что флажок **Включить только мой код** снят, а флажок **Включить поддержку исходного сервера** установлен.

    ![Configure symbol loading][SymbolLoading]

3. Выберите узел **Символы** слева и добавьте ссылку на сервер (SymbolSource)[http://symbolsource.org] с помощью URI [http://srv.symbolsource.org/pdb/Public](http://srv.symbolsource.org/pdb/Public). Символы для серверной части .NET мобильных служб становятся доступными здесь с каждым новым выпуском.
 
    ![Configure symbol server][SymbolServer]

4. Установите точку останова в части кода, которую планируется отлаживать. Например, установите точку останова в методе **GetAllTodoItems()** контроллера **TodoItemController**, который предусмотрен в шаблоне проекта мобильных служб в среде Visual Studio.
5. Выполните локальную отладку службы, нажав клавишу **F5**. Первая загрузка может выполняться медленно, поскольку Visual Studio загружает символы для серверной части .NET мобильных служб.
6. Как описывалось в предыдущем разделе, посвященном отладке HTTP, с помощью тестового клиента отправьте HTTP-запрос в метод, в котором была установлена точка останова. Например, можно отправить запрос в метод **GetAllTodoItems()**, нажав **GET tables/TodoItem** на странице справки, нажав ссылку **try this out** (испытать), а затем нажав кнопку **отправить**.
7. Visual Studio должна остановиться в заданной точке останова, и в окне **Стек вызовов** Visual Studio должна быть доступна полная трассировка стека с исходным кодом.

    ![Hitting a breakpoint][Breakpoint]

8. Теперь можно опубликовать службу в Azure, и можно будет использовать отладку в точности так, как это делалось выше. Опубликуйте проект, щелкнув его правой кнопкой мыши в **обозревателе решений** и выбрав пункт **Опубликовать**.
9. На вкладке **Параметры** мастера публикации выберите конфигурацию для **отладки**. Это обеспечит публикацию соответствующих символов отладки наряду с кодом.

    ![Publish debug][PublishDebug]

10. После успешной публикации службы откройте **обозреватель серверов** и разверните узлы **Windows Azure** и **Мобильные службы**. При необходимости выполните вход.
11. Щелкните правой кнопкой мыши только что опубликованную мобильную службу и выберите пункт **Подключить отладчик**.

    ![Attach debugger][AttachDebugger]

12. Отправьте HTTP-запрос для вызова метода, в котором установлена точка останова, как это делалось на шаге 6. На этот раз используйте страницу справки и тестовый клиент для мобильной службы, размещенной в Azure.
13. Visual Studio остановится в точке останова.

Теперь вы можете использовать все возможности отладчика Visual Studio при локальной разработке и для действующей мобильной службы в Azure.

<a name="Logs"></a>
## Анализ журналов диагностики

При обработке запросов от клиентов мобильная служба создает много полезных сведений для диагностики, а также записывает все возникшие исключения. Помимо этого можно реализовать код контроллера с дополнительными журналами, используя преимущества свойства [**Log**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.apiservices.log.aspx), доступного в свойстве [**Services**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.services.aspx) каждого [**TableController**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.aspx).

При локальной отладке журналы будут отображаться в окне **вывода** Visual Studio.

![Logs in Visual Studio Output window][LogsOutputWindow]

После публикации службы в Azure доступ к журналам для экземпляра службы, работающего в облаке, можно получить, щелкнув эту мобильную службу правой кнопкой мыши в **обозревателе серверов** Visual Studio и выбрав пункт **Просмотр журналов**.

![Logs in Visual Studio Server Explorer][LogsServerExplorer]

Эти же журналы доступны на **портале управления Azure** на вкладке **Журналы** для соответствувющей мобильной службы.

![Logs in Azure Management Portal][LogsPortal]

<a name="AssemblyResolution"></a>
## Отладка разрешения облачной сборки

При публикации мобильной службы в Azure она загружается средой размещения мобильных служб, что гарантирует беспрепятственные обновления и исправления в конвейере HTTP, размещающем код контроллера. Это включает все сборки, на которые ссылаются [пакеты NuGet серверной части .NET](http://www.nuget.org/packages?q=%22mobile+services+.net+backend%22): группа постоянно обновляет службу, чтобы задействовать последние версии этих сборок. 

Иногда можно спровоцировать конфликты версий, ссылаясь на *другие основные номера версий* необходимых сборок (другие *дополнительные номера* версий разрешены). Часто это происходит, когда NuGet предлагает выполнить обновление до последней версии одного из пакетов, используемых серверной частью .NET мобильных служб. 

>[WACOM.NOTE] Мобильные службы в настоящее время совместимы только с ASP.NET 5.1; ASP.NET 5.2 в настоящее время не поддерживается. Обновление пакетов ASP.NET NuGet до 5.2.* может привести к ошибке после развертывания.

Если выполнить обновление такого пакета, то при публикации обновленной службы в Azure появится страница с предупреждением, указывающим на конфликт.

![Help page indicating assembly loading conflict][HelpConflict]

Это сопровождается записью в журналы службы сообщения об исключении, подобного следующему:

    Обнаружены конфликты между различными версиями одной зависимой сборки Microsoft.ServiceBus: 2.2.0.0, 2.3.0.0. Переключите проект на использование версии 2.2.0.0, единственной, поддерживаемой средой размещения в настоящее время.

Эту проблему легко исправить: просто вернитесь к поддерживаемой версии необходимой сборки и заново опубликуйте службу.

<a name="EFMigrations"></a>
## Устранение неполадок миграций Entity Framework

При использовании серверной части .NET мобильных служб с базой данных SQL в качестве технологии доступа к данным, позволяющей запрашивать базу данных и сохранять в ней объекты, применяется Entity Framework (EF). Одним важным аспектом, который обрабатывается EF от имени разработчика, является то, как изменяются столбцы базы данных (также называемые *схемой*) при изменении классов модели, заданных в коде. Этот процесс называется [Code First Migrations](http://msdn.microsoft.com/ru-ru/data/jj591621).

Миграции могут быть сложными, и для их успешного выполнения может требоваться сохранение состояния базы данных в синхронизации с моделью EF. Сведения об обработке миграций с помощью мобильной службы и о возможных ошибках см. в статье [Внесение изменений в модель данных в мобильной службе серверной части .NET](/ru-ru/documentation/articles/mobile-services-dotnet-backend-how-to-use-code-first-migrations/).

<!-- IMAGES -->

[HelpPageAuth]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/6.png
[HelpPage]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/7.png
[HelpPageApi]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/8.png
[TestClient]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/9.png
[TestClientResponse]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/10.png
[SymbolLoading]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/1.png
[SymbolServer]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/2.png
[Breakpoint]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/3.png
[PublishDebug]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/4.png
[AttachDebugger]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/5.png
[LogsOutputWindow]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/11.png
[LogsServerExplorer]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/12.png
[LogsPortal]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/13.png
[HelpConflict]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/14.png
