<properties linkid="mobile-services-dotnet-backend-how-to-troubleshoot" urlDisplayName="Troubleshoot the Mobile Services .NET Backend" pageTitle="Troubleshoot the Mobile Services .NET Backend - Azure Mobile Services" metaKeywords="" description="Learn how to diagnose and fix issues with your mobile services using the .NET backend" metaCanonical="" services="" documentationCenter="Mobile" title="Troubleshoot the Mobile Services .NET Backend" authors="yavorg" solutions="" manager="" editor="mollybos" />

<tags ms.service="mobile-services" ms.workload="mobile" ms.tgt_pltfrm="mobile-multiple" ms.devlang="multiple" ms.topic="article" ms.date="01/01/1900" ms.author="yavorg"></tags>

# Устранение неполадок серверной части .NET мобильных служб

Разработка с использованием мобильных служб обычно выполняется легко и беспроблемно, но иногда что-нибудь может пойти не так. В этом учебнике рассматриваются некоторые методы, позволяющие устранять распространенные проблемы, которые могут возникать в серверной части .NET мобильных служб.

1.  [Отладка HTTP][Отладка HTTP]
2.  [Отладка во время выполнения][Отладка во время выполнения]
3.  [Анализ журналов диагностики][Анализ журналов диагностики]
4.  [Отладка разрешения облачной сборки][Отладка разрешения облачной сборки]
5.  [Устранение неполадок миграций Entity Framework][Устранение неполадок миграций Entity Framework]

<a name="HttpDebugging"></a>

## Отладка HTTP

При разработке приложений с использованием мобильных служб обычно используется преимущество пакета SDK клиента мобильных служб для соответствующей платформы (Магазин Windows, iOS, Android и т. п.). Однако иногда полезно перейти вниз на уровень HTTP и понаблюдать за необработанными вызовами, как они выполняются в сети. В частности, такой подход используется при отладке проблем с подключением и сериализацией. В серверной части .NET мобильных служб можно объединять этот подход с локальной и удаленной отладкой Visual Studio (подробности в следующем разделе), чтобы получить полное представление о том, какой путь проделывает HTTP-вызов, прежде чем вызвать код вашей службы.

Для отправки и проверки HTTP-трафика можно использовать любой отладчик HTTP. В этих целях разработчики часто используют популярный инструмент [Fiddler][Fiddler]. Чтобы облегчить работу разработчиков, мобильные службы предоставляют веб-отладчик HTTP (также называемый "тестовым клиентом") вместе с мобильной службой, что снижает потребность во внешних инструментах. Когда мобильная служба размещается локально, она будет доступна по URI, подобному [][]<http://localhost:59233></a>, а при размещении в облаке URI будет иметь вид [][1]<http://todo-list.azure-mobile.net></a>. Следующие шаги работают одинаково независимо от того, где размещена служба.

1.  Начните с серверного проекта мобильных служб, открыв его в **Visual Studio 2013 с обновлением 2** или последующих версий. Если у вас нет подходящего проекта, его можно создать, последовательно выбрав в меню пункты **Файл**, **Создать**, **Проект**, затем выбрав режим **Облако** и указав шаблон **Мобильные службы Microsoft Azure**.
2.  Нажмите клавишу **F5**, чтобы построить и запустить проект. На начальной странице нажмите ссылку **try it out** (испытать).

    > [WACOM.NOTE]
    > Если служба размещена локально, нажатие этой ссылки направит вас на следующую страницу. Однако при размещении в облаке будет предложено указать учетные данные. Это гарантирует, что пользователи, не прошедшие проверку подлинности, не получат доступ к сведениям об API и к полезным данным. Чтобы увидеть эту страницу, необходимо выполнить вход с **пустым именем пользователя** и **ключом приложения** в качестве пароля. Ключ приложения можно найти на **портале управления Azure**, перейдя на вкладку **Панель мониторинга** для соответствующей мобильной службы и выбрав пункт **Управление ключами**.
    >
    > ![Запрос проверки подлинности для доступа к странице справки][Запрос проверки подлинности для доступа к странице справки]

3.  На открывшейся странице (которая также называется "страница справки") отображается список всех API HTTP, которые делает доступными ваша мобильная служба. Выберите один из API (если вы начали с использования шаблона проекта мобильных служб в Visual Studio, то должны видеть **GET tables/TodoItem** (Получить таблицы/TodoItem).)

    ![Страница справки][Страница справки]

4.  Полученная страница показывает всю документацию и примеры JSON запроса и ответа, которые ожидает API. Нажмите кнопку **try this out** (испытать это).

    ![Тестовая страница для API][Тестовая страница для API]

5.  Это тестовый клиент, позволяющий отправлять HTTP-запрос, чтобы испытать API. Нажмите **отправить**.

    ![Тестовый клиент][Тестовый клиент]

6.  Появится HTTP-ответ, вернувшийся от мобильной службы непосредственно в окно браузера.

    ![Тестовый клиент с HTTP-ответом][Тестовый клиент с HTTP-ответом]

Теперь вы готовы для исследования других API HTTP, предоставляемых мобильной службой для удобства использования веб-браузера.

<a name="RuntimeDebugging"></a>

## Отладка во время выполнения

Одной из важнейших особенностей серверной части .NET является не только возможность локальной отладки кода службы, но также отладки кода, работающего в текущий момент в облачной среде. Выполните следующие действия.

1.  Откройте проект мобильной службы, который требуется отладить, в **Visual Studio 2013 с обновлением 2** или последующих версий.
2.  Настройте загрузку символов. Перейдите в меню **Отладка** и выберите пункт **Параметры и настройки**. Убедитесь, что флажок **Включить только мой код** снят, а флажок **Включить поддержку исходного сервера** установлен.

    ![Настройка загрузки символов][Настройка загрузки символов]

3.  Выберите узел **Символы** слева и добавьте ссылку на сервер (SymbolSource)[<http://symbolsource.org>] с помощью URI [][2]<http://srv.symbolsource.org/pdb/Public></a>. Символы для серверной части .NET мобильных служб становятся доступными здесь с каждым новым выпуском.

    ![Настройка сервера символов][Настройка сервера символов]

4.  Установите точку останова в части кода, которую планируется отлаживать. Например, установите точку останова в методе **GetAllTodoItems()** контроллера **TodoItemController**, который предусмотрен в шаблоне проекта мобильных служб в Visual Studio.
5.  Выполните локальную отладку службы, нажав клавишу **F5**. Первая загрузка может выполняться медленно, поскольку Visual Studio загружает символы для серверной части .NET мобильных служб.
6.  Как описывалось в предыдущем разделе, посвященном отладке HTTP, с помощью тестового клиента отправьте HTTP-запрос в метод, в котором была установлена точка останова. Например, можно отправить запрос в метод **GetAllTodoItems()**, нажав **GET tables/TodoItem** (Получить таблицы/TodoItem) на странице справки, нажав ссылку **try this out** (испытать), а затем нажав кнопку **отправить**.
7.  Visual Studio должен остановиться в заданной точке останова, и в окне **Стек вызовов** Visual Studio должна быть доступна полная трассировка стека с исходным кодом.

    ![Попадание в точку останова][Попадание в точку останова]

8.  Теперь можно опубликовать службу в Azure, и можно будет использовать отладку в точности так, как это делалось выше. Опубликуйте проект, щелкнув его правой кнопкой мыши в **обозревателе решений** и выбрав пункт **Опубликовать**.
9.  На вкладке **Параметры** мастера публикации выберите конфигурацию для **отладки**. Это обеспечит публикацию соответствующих символов отладки наряду с кодом.

    ![Публикация отладки][Публикация отладки]

10. После успешной публикации службы откройте **обозреватель серверов** и разверните узлы **Microsoft Azure** и **Мобильные службы**. При необходимости выполните вход.
11. Щелкните правой кнопкой мыши только что опубликованную мобильную службу и выберите пункт **Подключить отладчик**.

    ![Подключение отладчика][Подключение отладчика]

12. Отправьте HTTP-запрос для вызова метода, в котором установлена точка останова, как это делалось в шаге 6. На этот раз используйте страницу справки и протестируйте клиент в отношении мобильной службы, размещенной в Azure.
13. Visual Studio остановится в точке останова.

Теперь вы можете использовать все возможности отладчика Visual Studio при локальной разработке и для действующей мобильной службы в Azure.

<a name="Logs"></a>

## Анализ журналов диагностики

При обработке запросов от клиентов мобильная служба создает много полезных сведений для диагностики, а также записывает все возникшие исключения. Помимо этого можно реализовать код контроллера с дополнительными журналами, используя преимущества свойства [**Log**][**Log**], доступного в свойстве [**Services**][**Services**] каждого [**TableController**][**TableController**].

При локальной отладке журналы будут отображаться в окне **вывода** Visual Studio.

![Журналы в окне вывода Visual Studio][Журналы в окне вывода Visual Studio]

После публикации службы в Azure доступ к журналам для экземпляра службы, работающего в облаке, можно получить, щелкнув эту мобильную службу правой кнопкой мыши в **обозревателе серверов** Visual Studio и выбрав пункт **Просмотр журналов**.

![Журналы в обозревателе серверов Visual Studio][Журналы в обозревателе серверов Visual Studio]

Эти же журналы доступны на **портале управления Azure** на вкладке **Журналы** для соответствующей мобильной службы.

![Журналы на портале управления Azure ][Журналы на портале управления Azure ]

<a name="AssemblyResolution"></a>

## Отладка разрешения облачной сборки

При публикации мобильной службы в Azure она загружается средой внешнего размещения мобильных служб, что гарантирует беспрепятственные обновления и исправления в конвейере HTTP, размещающем код контроллера. Это включает все сборки, на которые ссылаются [пакеты NuGet серверной части .NET][пакеты NuGet серверной части .NET]: группа постоянно обновляет службу, чтобы она использовала последние версии этих сборок.

Иногда можно спровоцировать конфликты версий, ссылаясь на *другие основные номера версий* необходимых сборок (другие *дополнительные номера* версий разрешены). Часто это происходит, когда NuGet предлагает выполнить обновление до последней версии одного из пакетов, используемых серверной частью .NET мобильных служб.

    > [WACOM.NOTE] Mobile Services is currently compatible only with ASP.NET 5.1; ASP.NET 5.2 is not presently supported. Upgrading your ASP.NET NuGet packages to 5.2.* may result in an error after deployment.

Если выполнить обновление такого пакета, то при публикации обновленной службы в Azure появится страница с предупреждением, указывающим на конфликт.

![Страница справки, указывающая на конфликт загрузки сборки][Страница справки, указывающая на конфликт загрузки сборки]

Это сопровождается записью в журналы службы сообщения об исключении, подобного следующему:

    Found conflicts between different versions of the same dependent assembly 'Microsoft.ServiceBus': 2.2.0.0, 2.3.0.0. Please change your project to use version '2.2.0.0' which is the one currently supported by the hosting environment.

Эту проблему легко исправить: просто вернитесь к поддерживаемой версии необходимой сборки и заново опубликуйте службу.

<a name="EFMigrations"></a>

## Устранение неполадок миграций Entity Framework

При использовании серверной части .NET мобильных служб с базой данных SQL в качестве технологии доступа к данным, позволяющей запрашивать базу данных и сохранять в ней объекты, применяется Entity Framework (EF). Одним важным аспектом, который обрабатывается EF от имени разработчика, является то, как изменяются столбцы базы данных (также называемые *схемой*) при изменении классов модели, заданных в коде. Этот процесс называется [Code First Migrations][Code First Migrations].

Миграции могут быть сложными, и для их успешного выполнения может требоваться сохранение состояния базы данных в синхронизации с моделью EF. Сведения об обработке миграций с помощью мобильной службы и о возможных ошибках см. в статье [Внесение изменений в модель данных в мобильной службе серверной части .NET][Внесение изменений в модель данных в мобильной службе серверной части .NET].

<!-- IMAGES -->

  [Отладка HTTP]: #HttpDebugging
  [Отладка во время выполнения]: #RuntimeDebugging
  [Анализ журналов диагностики]: #Logs
  [Отладка разрешения облачной сборки]: #AssemblyResolution
  [Устранение неполадок миграций Entity Framework]: #EFMigrations
  [Fiddler]: http://www.telerik.com/fiddler
  []: http://localhost:59233
  [1]: http://todo-list.azure-mobile.net
  [Запрос проверки подлинности для доступа к странице справки]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/6.png
  [Страница справки]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/7.png
  [Тестовая страница для API]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/8.png
  [Тестовый клиент]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/9.png
  [Тестовый клиент с HTTP-ответом]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/10.png
  [Настройка загрузки символов]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/1.png
  [2]: http://srv.symbolsource.org/pdb/Public
  [Настройка сервера символов]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/2.png
  [Попадание в точку останова]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/3.png
  [Публикация отладки]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/4.png
  [Подключение отладчика]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/5.png
  [**Log**]: http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.apiservices.log.aspx
  [**Services**]: http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.services.aspx
  [**TableController**]: http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.aspx
  [Журналы в окне вывода Visual Studio]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/11.png
  [Журналы в обозревателе серверов Visual Studio]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/12.png
  [Журналы на портале управления Azure ]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/13.png
  [пакеты NuGet серверной части .NET]: http://www.nuget.org/packages?q=%22mobile+services+.net+backend%22
  [Страница справки, указывающая на конфликт загрузки сборки]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/14.png
  [Code First Migrations]: http://msdn.microsoft.com/ru-ru/data/jj591621
  [Внесение изменений в модель данных в мобильной службе серверной части .NET]: /ru-ru/documentation/articles/mobile-services-dotnet-backend-how-to-use-code-first-migrations/
