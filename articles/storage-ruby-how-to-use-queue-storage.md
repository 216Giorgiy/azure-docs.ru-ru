<properties linkid="dev-ruby-how-to-service-bus-queues" urlDisplayName="Queue Service" pageTitle="How to use the queue service (Ruby) | Microsoft Azure" metaKeywords="Azure Queue Service get messages Ruby" description="Learn how to use the Azure Queue service to create and delete queues, and insert, get, and delete messages. Samples written in Ruby." metaCanonical="" services="storage" documentationCenter="Ruby" title="How to Use the Queue Storage Service from Ruby" authors="guayan" solutions="" manager="" editor="" />

<tags ms.service="storage" ms.workload="storage" ms.tgt_pltfrm="na" ms.devlang="ruby" ms.topic="article" ms.date="01/01/1900" ms.author="guayan" />

# Использование службы хранения очередей в Ruby

В этом руководстве показано, как реализовать типичные сценарии с использованием службы хранения очередей Windows Azure. Примеры написаны с помощью Ruby Azure API. Здесь описаны такие сценарии, как **вставка**, **просмотр**, **получение** и **удаление** сообщений очереди а также **создание и удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия][Дальнейшие действия].

## Оглавление

-   [Что такое хранилище очередей?][Что такое хранилище очередей?]
-   [Основные понятия][Основные понятия]
-   [Создание учетной записи хранения Azure][Создание учетной записи хранения Azure]
-   [Создание приложения Ruby][Создание приложения Ruby]
-   [Настройка приложения для доступа к хранилищу][Настройка приложения для доступа к хранилищу]
-   [Настройка подключения к хранилищу Azure][Настройка подключения к хранилищу Azure]
-   [Практическое руководство. Создать очередь][Практическое руководство. Создать очередь]
-   [Практическое руководство. Вставка сообщения в очередь][Практическое руководство. Вставка сообщения в очередь]
-   [Практическое руководство. Просмотр следующего сообщения][Практическое руководство. Просмотр следующего сообщения]
-   [Практическое руководство. Удаление следующего сообщения из очереди][Практическое руководство. Удаление следующего сообщения из очереди]
-   [Практическое руководство. Изменение содержимого сообщения в очереди][Практическое руководство. Изменение содержимого сообщения в очереди]
-   [Практическое руководство. Дополнительные параметры для удаления сообщений из очереди][Практическое руководство. Дополнительные параметры для удаления сообщений из очереди]
-   [Практическое руководство. Получение длины очереди][Практическое руководство. Получение длины очереди]
-   [Практическое руководство. Удаление очереди][Практическое руководство. Удаление очереди]
-   [Дальнейшие действия][Дальнейшие действия]

[WACOM.INCLUDE [руководство-очередь-хранилище](../includes/howto-queue-storage.md)]

## <span id="CreateAccount"></span></a>Создание учетной записи хранения Azure

[WACOM.INCLUDE [создание-хранилище-учетная запись](../includes/create-storage-account.md)]

## <span id="create-a-ruby-application"></span></a>Создание приложения Ruby

Создайте приложение Ruby. Инструкции см. в разделе
[Создание приложений Ruby в Azure][Создание приложений Ruby в Azure].

## <span id="configure-your-application-to-access-storage"></span></a>Настройка приложения для доступа к хранилищу

Для использования хранилища Azure необходимо загрузить и использовать пакет Ruby Azure, который содержит набор библиотек, взаимодействующих со службами REST хранилища.

### Использование RubyGems для получения пакета

1.  Используйте интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix).

2.  Введите "gem install azure" в окне командной строки, чтобы установить пакеты и зависимости.

### Импорт пакета

Используйте свой любимый текстовый редактор, чтобы добавить следующий код в начало файла Ruby, где планируется использовать хранилище.

    require "azure"

## <span id="setup-a-windows-azure-storage-connection"></span></a>Настройка подключения к хранилищу Azure

Модуль Azure считывает переменные среды **AZURE\_STORAGE\_ACCOUNT** и **AZURE\_STORAGE\_ACCESS\_KEY**
для получения сведений, необходимых для подключения к учетной записи хранения Azure. Если эти переменные среды не заданы, необходимо указать сведения об учетной записи перед использованием **Azure::QueueService** с помощью следующего кода:

    Azure.config.storage_account_name = "<your azure storage account>"
    Azure.config.storage_access_key = "<your Azure storage access key>"

Для получения этих значений:

1.  Выполните вход в [Портал управления Azure][Портал управления Azure].
2.  Перейдите к учетной записи хранения, которая будет использоваться.
3.  Щелкните **УПРАВЛЕНИЕ КЛЮЧАМИ** в нижней части области навигации.
4.  В открывшемся диалоговом окне вы увидите имя учетной записи хранения, первичный ключ доступа и вторичный ключ доступа. В качестве ключа доступа можно использовать либо первичный, либо вторичный ключ.

## <span id="how-to-create-a-queue"></span></a>Практическое руководство. Создание очереди

Следующий пример кода создает объект **Azure::QueueService**, который позволяет работать с очередями.

    azure_queue_service = Azure::QueueService.new

Используйте метод **create\_queue()**, чтобы создать очередь с указанным именем.

    begin
      azure_queue_service.create_queue("test-queue")
    rescue
      puts $!
    end

## <span id="how-to-insert-a-message-into-a-queue"></span></a>Практическое руководство. Вставка сообщения в очередь

Чтобы вставить сообщение в очередь, используйте метод **create\_message()** для создания нового сообщения и добавления его в очередь.

    azure_queue_service.create_message("test-queue", "test message")

## <span id="how-to-peek-at-the-next-message"></span></a>Практическое руководство. Просмотр следующего сообщения

Вы можете просмотреть сообщение в начале очереди, не удаляя его из очереди, вызвав метод **peek\_messages()**. По умолчанию **peek\_messages ()** просматривает одно сообщение. Вы также можете указать количество сообщений для просмотра.

    result = azure_queue_service.peek_messages("test-queue",
      {:number_of_messages => 10})

## <span id="how-to-dequeue-the-next-message"></span></a>Практическое руководство. Удаление следующего сообщения из очереди

Вы можете удалить сообщение из очереди в два этапа.

1.  При вызове метода **list\_messages()** по умолчанию вы получаете следующее сообщение в очереди. Вы также можете указать количество сообщений для получения. Сообщения, возвращаемые методом **list\_messages ()**, становятся невидимыми для другого кода, читающего сообщения из этой очереди. Время ожидания видимости (в секундах) передается в качестве параметра.

2.  Чтобы завершить удаление сообщения из очереди, необходимо также вызвать метод **delete\_message()**.

Этот двухэтапный процесс удаления сообщения позволяет удостовериться, что если коду не удастся обработать сообщение из-за сбоя оборудования или программного обеспечения, другой экземпляр кода сможет получить то же сообщение и повторить попытку. Код вызывает метод **delete\_message()** сразу после обработки сообщения.

    messages = azure_queue_service.list_messages("test-queue", 30)
    azure_queue_service.delete_message("test-queue", 
      messages[0].id, messages[0].pop_receipt)

## <span id="how-to-change-the-contents-of-a-queued-message"></span></a>Практическое руководство. Изменение содержимого сообщения в очереди

Вы можете изменить содержимое сообщения непосредственно в очереди. Приведенный ниже код использует метод **update\_message()**, чтобы обновить сообщение. Этот метод возвращает последовательность, содержащую подтверждение получения сообщения очереди, дату и время в формате UTC, представляющие время, когда сообщение будет видимо в очереди.

    message = azure_queue_service.list_messages("test-queue", 30)
    pop_receipt, time_next_visible = azure_queue_service.update_message(
      "test-queue", message.id, message.pop_receipt, "updated test message", 
      30)

## <span id="how-to-additional-options-for-dequeuing-messages"></span></a>Практическое руководство. Дополнительные параметры для удаления сообщений из очереди

Способ извлечения сообщения из очереди можно настроить двумя способами.

1.  Можно получить пакет сообщения.

2.  Можно задать более длительное или короткое время ожидания невидимости, чтобы предоставить коду больше или меньше времени на полную обработку каждого сообщения.

В следующем примере кода метод **list\_messages()** используется для получения 15 сообщений в одном вызове. Затем код выводит и удаляет все сообщения. Он также задает время ожидания невидимости 5 минут для каждого сообщения.

    azure_queue_service.list_messages("test-queue", 300
      {:number_of_messages => 15}).each do |m|
      puts m.message_text
      azure_queue_service.delete_message("test-queue", m.id, m.pop_receipt)
    end

## <span id="how-to-get-the-queue-length"></span></a>Практическое руководство. Получение длины очереди

Вы можете получить приблизительное количество сообщений в очереди. Метод **get\_queue\_metadata()** запрашивает у службы очереди приблизительное количество сообщений и метаданные очереди.

    message_count, metadata = azure_queue_service.get_queue_metadata(
      "test-queue")

## <span id="how-to-delete-a-queue"></span></a>Практическое руководство. Удаление очереди

Для удаления очереди и всех сообщений в ней вызовите метод **delete\_queue()** в объекте очереди.

    azure_queue_service.delete_queue("test-queue")

## <span id="next-steps"></span></a> Дальнейшие действия

Вы изучили основные сведения о хранилище очередей. Дополнительные сведения о более сложных задачах по использованию хранилища можно найти по следующим ссылкам.

-   См. справочник MSDN: [Хранение данных и доступ к ним в Azure][Хранение данных и доступ к ним в Azure]
-   Посетите [блог команды разработчиков хранилища Azure][блог команды разработчиков хранилища Azure].
-   Посетите репозиторий [Azure SDK для Ruby][Azure SDK для Ruby] на веб-сайте GitHub

Сравнение службы очередей Azure, описанной в этой статье, и очередей Service Bus Azure, описанных в статье [Использование очередей Service Bus][Использование очередей Service Bus], см. в статье [Очереди Azure и очереди Service Bus Azure — сходство и отличия][Очереди Azure и очереди Service Bus Azure — сходство и отличия]

  [Дальнейшие действия]: #next-steps
  [Основные понятия]: #concepts
  [Создание учетной записи хранения Azure]: #CreateAccount
  [Создание приложения Ruby]: #create-a-ruby-application
  [Настройка приложения для доступа к хранилищу]: #configure-your-application-to-access-storage
  [Настройка подключения к хранилищу Azure]: #setup-a-windows-azure-storage-connection
  [Практическое руководство. Создать очередь]: #how-to-create-a-queue
  [Практическое руководство. Вставка сообщения в очередь]: #how-to-insert-a-message-into-a-queue
  [Практическое руководство. Просмотр следующего сообщения]: #how-to-peek-at-the-next-message
  [Практическое руководство. Удаление следующего сообщения из очереди]: #how-to-dequeue-the-next-message
  [Практическое руководство. Изменение содержимого сообщения в очереди]: #how-to-change-the-contents-of-a-queued-message
  [Практическое руководство. Дополнительные параметры для удаления сообщений из очереди]: #how-to-additional-options-for-dequeuing-messages
  [Практическое руководство. Получение длины очереди]: #how-to-get-the-queue-length
  [Практическое руководство. Удаление очереди]: #how-to-delete-a-queue
  [руководство-очередь-хранилище]: ../includes/howto-queue-storage.md
  [создание-хранилище-учетная запись]: ../includes/create-storage-account.md
  [Создание приложений Ruby в Azure]: /ru-ru/develop/ruby/tutorials/web-app-with-linux-vm/
  [Портал управления Azure]: https://manage.windowsazure.com/
  [Хранение данных и доступ к ним в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433040.aspx
  [блог команды разработчиков хранилища Azure]: http://blogs.msdn.com/b/windowsazurestorage/
  [Azure SDK для Ruby]: https://github.com/WindowsAzure/azure-sdk-for-ruby
  [Использование очередей Service Bus]: /ru-ru/develop/ruby/how-to-guides/service-bus-queues/
  [Очереди Azure и очереди Service Bus Azure — сходство и отличия]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh767287.aspx
