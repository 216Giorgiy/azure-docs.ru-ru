---
title: Создание динамических схем с использованием параметров в Azure Blueprint
description: Ознакомьтесь со сведениями о статических и динамических параметрах и о том, как создавать динамические схемы с их использованием.
services: blueprints
author: DCtheGeek
ms.author: dacoulte
ms.date: 09/18/2018
ms.topic: conceptual
ms.service: blueprints
manager: carmonm
ms.openlocfilehash: e1a1d736eb9b22cd444a75b94d112abfe3fbe5af
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46993584"
---
# <a name="creating-dynamic-blueprints-through-parameters"></a>Создание динамических схем с использованием параметров

Полностью определенная схема с различными артефактами (такими как группы ресурсов, шаблоны Resource Manager, политики или назначения ролей) предлагает быстрое создание и последовательную подготовку объектов в Azure. Azure Blueprint поддерживает параметры для обеспечения гибкого использования этих конструктивных шаблонов и контейнеров многократного использования. Параметры обеспечивают гибкий способ изменения свойств артефактов, развернутых с помощью схемы, как при определении, так и при назначении.

Простым примером является артефакт группы ресурсов. При создании группы ресурсов для нее нужно указать два обязательных значения: имя и расположение. При добавлении группы ресурсов в схему в случае отсутствия параметров нужно определять это имя и расположение для каждого использования схемы. В результате при каждом использовании схемы будут создаваться артефакты в одной группе ресурсов. Несмотря на отсутствие проблемы с самой группой ресурсов, ресурсы внутри этой группы ресурсов будут дублироваться и вызывать конфликт.

> [!NOTE]
> Если в разных схемах содержится группа ресурсов с одним именем, это не является сложностью.
> Если группа ресурсов, включенная в схему, уже существует, схема продолжит создавать связанные артефакты в этой группе ресурсов. Это может привести к конфликту, так как в подписке не могут быть два ресурса с одинаковым именем и типом.

Вот когда полезно использовать параметры. В Blueprints значения для свойств (в случае с группой ресурсов — свойств имени и расположения) можно не определять во время определения схемы. Вместо этого их можно определить во время назначения подписке. Это позволяет повторно использовать схему, которая создает группу ресурсов и другие ресурсы в рамках одной подписки без конфликта.

## <a name="blueprint-parameters"></a>Параметры схемы

С помощью REST API в самой схеме в дополнение к каждому из поддерживаемых артефактов можно создать также параметры. Когда параметр создается в схеме, он может использоваться ее артефактами. Примером может быть префикс для именования группы ресурсов. Затем артефакт может использовать параметр схемы для создания главным образом динамического параметра, так как этот параметр все еще можно определить во время назначения, но он будет согласованным в отношении правил именования организации. Сведения о рекомендуемых шагах см. в разделе о [задании статических параметров (параметров уровня схемы)](#blueprint-level-parameter).

### <a name="using-securestring-and-secureobject-parameters"></a>Использование параметров secureString и secureObject

Хотя _артефакт_ шаблона Resource Manager поддерживает параметры типов **secureString** и **secureObject**, Azure Blueprint требует, чтобы каждый из них был связан с Azure Key Vault.
Это предотвращает небезопасную практику хранения секретов вместе со схемами и способствует использованию безопасных шаблонов. Azure Blueprint облегчает этот процесс, обнаруживая включение защищенного параметра в _артефакте_ шаблона Resource Manager и отправляя запросы во время назначения в схеме для следующих свойств Key Vault для каждого обнаруженного защищенного параметра:

- идентификатора ресурса Key Vault;
- имени секрета Key Vault;
- версии секрета Key Vault.

Указанное хранилище Key Vault должно быть в той же подписке, к которой назначается схема, и для него должен быть настроен параметр **Включить доступ к Azure Resource Manager для развертывания шаблонов** на странице **Политики доступа** Key Vault. Инструкции о том, как включить эту функцию, см. в разделе [Включение развертывания шаблона](../../../managed-applications/key-vault-access.md#enable-template-deployment).
Дополнительные сведения об Azure Key Vault см. в [этой статье](../../../key-vault/key-vault-overview.md).

## <a name="parameter-types"></a>Типы параметров

### <a name="static-parameters"></a>Статические параметры

Значение параметра, заданное в определении схемы, называется **статическим параметром**. Это связано с тем, что при каждом использовании схемы будет развертываться артефакт с использованием этого статического значения. В примере группы ресурсов, хотя это не имеет смысла для имени группы ресурсов, это может иметь смысл для расположения. Затем при каждом назначении схемы в том же расположении создавалась бы группа ресурсов (с определенным именем во время назначения). Это позволяет выбирать, какие свойства являются обязательными и что можно изменить во время назначения.

#### <a name="setting-static-parameters-in-the-portal"></a>Установка статических параметров на портале

1. Запустите службу Azure Blueprint на портале Azure. Для этого щелкните **Все службы**, а затем найдите и выберите пункт **Политика** на левой панели. На странице **Политика** нажмите кнопку **Схемы**.

1. Выберите **Определения схем** на странице слева.

1. Щелкните имеющуюся схему, а затем выберите **Изменить схему** или **+ Создать схему** и введите данные на вкладке **Основные сведения**.

1. Щелкните **Далее: артефакты** или выберите вкладку **Артефакты**.

1. Для добавленных в схему артефактов с заданными параметрами отображается строка наподобие **Заполнено X из Y параметров** в столбце **Параметры**. Щелкните строку артефакта, чтобы изменить параметры артефакта.

   ![Параметры схемы](../media/parameters/parameter-column.png)

1. На странице **Изменение артефакта** появятся значения параметров, соответствующие выбранному артефакту. Каждый параметр артефакта включает заголовок, поле значения и поле для установки флажка. Снимите флажок для преобразования в **статический параметр**. В приведенном ниже примере только _расположение_ является **статическим параметром**, так как для него не установлен флажок, а флажок для _имени группы ресурсов_ установлен.

   ![Статические параметры схемы](../media/parameters/static-parameter.png)

#### <a name="setting-static-parameters-from-rest-api"></a>Установка статических параметров из REST API

В каждом универсальном коде ресурса (URI) REST API есть переменные, которые необходимо заменить собственными значениями:

- `{YourMG}` — замените это значение именем своей группы управления.
- `{subscriptionId}` — замените это значение идентификатором своей подписки.

##### <a name="blueprint-level-parameter"></a>Параметр уровня схемы

При создании схемы через REST API можно создать [ее параметры](#blueprint-parameters). Для этого используйте следующий универсальный код ресурса (URI) REST API и формат текста:

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint?api-version=2017-11-11-preview
  ```

- Текст запроса

  ```json
  {
      "properties": {
          "description": "This blueprint has blueprint level parameters.",
          "targetScope": "subscription",
          "parameters": {
              "owners": {
                  "type": "array",
                  "metadata": {
                      "description": "List of AAD object IDs that is assigned Owner role at the resource group"
                  }
              }
          },
          "resourceGroups": {
              "storageRG": {
                  "description": "Contains the resource template deployment and a role assignment."
              }
          }
      }
  }
  ```

После создания параметра уровня схемы его можно использовать в артефактах, добавленных в эту схему.
В следующем примере REST API создается артефакт назначения ролей в схеме и используется параметр уровня схемы.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint/artifacts/roleOwner?api-version=2017-11-11-preview
  ```

- Текст запроса

  ```json
  {
      "kind": "roleAssignment",
      "properties": {
          "resourceGroup": "storageRG",
          "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
          "principalIds": "[parameters('owners')]"
      }
  }
  ```

В этом примере в свойстве **principalIds** использовался параметр уровня схемы **владельцев**: было указано значение `[parameters('owners')]`. Установка параметра артефакта с использованием параметра уровня схемы по-прежнему является примером **статического параметра**, так как его нельзя установить во время назначения схемы, и его значение будет одинаковым в каждом назначении.

##### <a name="artifact-level-parameter"></a>Параметр уровня артефакта

Создание **статических параметров** в артефакте аналогично, но вместо функции `parameters()` используется прямое значение. В следующем примере создаются два статических параметра: **tagName** и **tagValue**. Значение каждого из них предоставляется напрямую, и вызов функции не используется.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint/artifacts/policyStorageTags?api-version=2017-11-11-preview
  ```

- Текст запроса

  ```json
  {
      "kind": "policyAssignment",
      "properties": {
          "description": "Apply storage tag and the parameter also used by the template to resource groups",
          "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/49c88fc8-6fd1-46fd-a676-f12d1d3a4c71",
          "parameters": {
              "tagName": {
                  "value": "StorageType"
              },
              "tagValue": {
                  "value": "Premium_LRS"
              }
          }
      }
  }
  ```

### <a name="dynamic-parameters"></a>Динамические параметры

Противоположностью статического параметра является **динамический параметр**. Это параметр, который не определен в схеме, но определяется при каждом назначении схемы. В примере группы ресурсов это имеет смысл для имени группы ресурсов, если для каждого назначения схемы используется разное имя.

#### <a name="setting-dynamic-parameters-in-the-portal"></a>Установка динамических параметров на портале

1. Запустите службу Azure Blueprint на портале Azure. Для этого щелкните **Все службы**, а затем найдите и выберите пункт **Политика** на левой панели. На странице **Политика** нажмите кнопку **Схемы**.

1. Выберите **Определения схем** на странице слева.

1. Щелкните правой кнопкой мыши схему, которую нужно назначить, и выберите **Назначить схему** или щелкните нужную схему, а затем нажмите кнопку **Назначить схему**.

1. На странице **назначения схемы** найдите раздел **параметров артефакта**. Каждый артефакт с хотя бы одним **динамическим параметром** отображается вместе с параметрами конфигурации. Перед назначением схемы укажите требуемые значения параметров. В приведенном ниже примере _имя_ является **динамическим параметром**, который нужно определить для завершения назначения схемы.

   ![Динамический параметр схемы](../media/parameters/dynamic-parameter.png)

#### <a name="setting-dynamic-parameters-from-rest-api"></a>Установка динамических параметров из REST API

Установка **динамических параметров** во время назначения выполняется путем предоставления желаемого значения напрямую. Вместо использования функции, такой как `parameters()`, предоставленным значением является соответствующая строка. Артефакты для группы ресурсов определяются с именем шаблона и свойствами **имени** и **расположения**. Все остальные параметры для каждого включенного артефакта определены в разделе **parameters** с помощью пары **\<имени\>** и **значения**. Если схема сконфигурирована для динамического параметра, который не указан во время назначения, это назначение завершится сбоем.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.Blueprint/blueprintAssignments/assignMyBlueprint?api-version=2017-11-11-preview
  ```

- Текст запроса

  ```json
  {
      "properties": {
          "blueprintId": "/providers/Microsoft.Management/managementGroups/{YourMG}  /providers/Microsoft.Blueprint/blueprints/MyBlueprint",
          "resourceGroups": {
              "storageRG": {
                  "name": "StorageAccount",
                  "location": "eastus2"
              }
          },
          "parameters": {
              "storageAccountType": {
                  "value": "Standard_GRS"
              },
              "tagName": {
                  "value": "CostCenter"
              },
              "tagValue": {
                  "value": "ContosoIT"
              },
              "contributors": {
                  "value": [
                      "7be2f100-3af5-4c15-bcb7-27ee43784a1f",
                      "38833b56-194d-420b-90ce-cff578296714"
                  ]
                },
              "owners": {
                  "value": [
                      "44254d2b-a0c7-405f-959c-f829ee31c2e7",
                      "316deb5f-7187-4512-9dd4-21e7798b0ef9"
                  ]
              }
          }
      },
      "identity": {
          "type": "systemAssigned"
      },
      "location": "westus"
  }
  ```

## <a name="next-steps"></a>Дополнительная информация

- Ознакомьтесь с [жизненным циклом схемы](lifecycle.md).
- Научитесь настраивать [последовательность схемы](sequencing-order.md).
- Узнайте, как применять [блокировку ресурсов схемы](resource-locking.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).