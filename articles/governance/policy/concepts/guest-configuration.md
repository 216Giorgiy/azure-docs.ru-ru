---
title: Общие сведения о выполнении аудита на виртуальной машине
description: Узнайте, как служба "Политика Azure" использует гостевую конфигурацию для аудита параметров на виртуальной машине Azure.
services: azure-policy
author: DCtheGeek
ms.author: dacoulte
ms.date: 01/29/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: 77d99c90e65647a1f4a4efb07ff5520596fa54cf
ms.sourcegitcommit: a7331d0cc53805a7d3170c4368862cad0d4f3144
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2019
ms.locfileid: "55295174"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

В дополнение к аудиту и [исправлению](../how-to/remediate-resources.md) ресурсов Azure служба "Политика Azure" поддерживает аудит параметров на виртуальной машине. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как конфигурация операционной системы, конфигурация или наличие приложения, настройки среды и т. д.

> [!IMPORTANT]
> В настоящее время с гостевой конфигурацией поддерживаются только **встроенные** политики.

## <a name="extension-and-client"></a>Расширение и клиент

Для аудита параметров на виртуальной машине включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md). Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

### <a name="register-guest-configuration-resource-provider"></a>Регистрация поставщика ресурсов гостевой конфигурации

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Регистрацию можно выполнить с помощью портала или PowerShell.

#### <a name="registration---portal"></a>Регистрация на портале

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через портал Azure, выполните следующие действия:

1. Запустите портал Azure и выберите **Все службы**. Выполните поиск по запросу **Подписки** и выберите этот пункт.

1. Найдите ту подписку, для которой нужно включить гостевую конфигурацию, и выберите ее.

1. В меню слева страницы **Подписка** щелкните **Поставщики ресурсов**.

1. Выполните фильтрацию или прокрутите, пока не найдете **Microsoft.GuestConfiguration**, а затем выберите **Регистрация** в той же строке.

#### <a name="registration---powershell"></a>Регистрация с помощью PowerShell

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через PowerShell, выполните следующую команду:

```azurepowershell-interactive
# Login first with Connect-AzAccount if not using Cloud Shell
Register-AzResourceProvider -ProviderNamespace 'Microsoft.GuestConfiguration'
```

### <a name="validation-tools"></a>Инструменты проверки

Для выполнения аудита на виртуальной машине клиент гостевой конфигурации использует локальные средства.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
| Windows|[Конфигурация требуемого состояния Майкрософт](/powershell/dsc) версии 2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Ruby и Python устанавливаются с помощью расширения гостевой конфигурации. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут.
После получения назначения гостя параметры проверяются с 15-минутным интервалом.
Результаты отправляются поставщику ресурсов гостевой конфигурации после завершения аудита.
Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации.
В этом случае Политика Azure должна оценивать свойства Azure Resource Manager.
Оценка Политики по запросу получает последнее значение от поставщика ресурсов гостевой конфигурации.
Однако она не запускает новый аудит конфигурации в виртуальной машине.

### <a name="supported-client-types"></a>Поддерживаемые типы клиентов

В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|ИЗДАТЕЛЬ|ИМЯ|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14.04, 16.04, 18.04|
|Credativ|Debian|8, 9|
|Microsoft|Windows Server|2012 Datacenter, 2012 R2 Datacenter, 2016 Datacenter|
|OpenLogic|CentOS|7.3, 7.4, 7.5|
|Red Hat|Red Hat Enterprise Linux.|7.4, 7.5|
|SUSE|SLES|12 с пакетом обновления 3|

> [!IMPORTANT]
> Гостевая конфигурация в настоящее время не поддерживается в пользовательских образах виртуальных машин.

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

В следующей таблице перечислены неподдерживаемые операционные системы:

|Операционная система|Примечания|
|-|-|
|Клиент Windows | Клиентские операционные системы (например, Windows 7 и Windows 10) не поддерживаются.
|Nano Server Windows Server 2016 | Не поддерживается.|

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Каждому аудиту, выполняемому гостевой конфигурацией, требуется два определения политик: **DeployIfNotExists** и **Audit**. **DeployIfNotExists** — используется для подготовки виртуальной машины с агентом гостевой конфигурации и другими компонентами для поддержки [средств проверки](#validation-tools).

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Проверяет, что виртуальной машине назначена конфигурация для проверки. Если в настоящее время назначения не существует, получите назначение и подготовьте виртуальную машину путем:
  - выполнения аутентификации на виртуальной машине с помощью [управляемого удостоверения](../../../active-directory/managed-identities-azure-resources/overview.md);
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Когда определение **DeployIfNotExists** получит значение Compliant, определение политики **Audit** использует локальные средства проверки для определения того, является ли назначение конфигурации совместимым. Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/getting-compliance-data.md).

> [!NOTE]
> Для каждого определения гостевой конфигурации должны существовать оба определения политик: и **DeployIfNotExists**, и **Audit**.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива *[Предварительная версия]. Проверка параметров безопасности паролей в виртуальных машинах Linux и Windows* содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **Audit** для Windows и три пары для Linux. В каждом случае логика в определении проверяет, чтобы только целевая операционная система оценивалась на основе определения [правила политики](definition-structure.md#policy-rule).

## <a name="next-steps"></a>Дополнительная информация

- См. другие [примеры шаблонов для службы "Политика Azure"](../samples/index.md).
- См. дополнительные сведения о [структуре определения политики](definition-structure.md).
- См. дополнительные сведения о [действиях политик](effects.md).
- См. сведения о [программном создании политик](../how-to/programmatically-create.md).
- Узнайте о том, как получить [подробные сведения о соответствии](../how-to/getting-compliance-data.md).
- См. сведения о том, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- См. дополнительные сведения о группе управления в разделе [Упорядочение ресурсов с помощью групп управления Azure](../../management-groups/index.md)
