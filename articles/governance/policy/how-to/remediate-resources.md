---
title: Исправление несоответствующих ресурсов
description: В этом руководстве описывается исправление ресурсов, которые не соответствуют политикам в службе "Политика Azure".
services: azure-policy
author: DCtheGeek
ms.author: dacoulte
ms.date: 12/06/2018
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: 093b49bea167efb12b941f8f0baff6fbdae5be25
ms.sourcegitcommit: eb9dd01614b8e95ebc06139c72fa563b25dc6d13
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2018
ms.locfileid: "53312652"
---
# <a name="remediate-non-compliant-resources-with-azure-policy"></a>Исправление несоответствующих ресурсов с помощью службы "Политика Azure"

Ресурсы, которые не соответствуют политике **deployIfNotExists**, могут быть переведены в состояние соответствия с помощью **исправления**. Исправление выполняется путем указания в политике запуска эффекта **deployIfNotExists** для назначенной политики на существующих ресурсах. В этой статье приведены шаги, необходимые для распознавания несоответствующих политике ресурсов и выполнения исправления с помощью политики.

## <a name="how-remediation-security-works"></a>Как работает безопасность исправлений

Если политика применяет шаблон в определении политики **deployIfNotExists**, она использует [управляемое удостоверение](../../../active-directory/managed-identities-azure-resources/overview.md).
Политика создает управляемое удостоверение для каждого назначения, однако вам необходимо указать сведения о роли, которой нужно предоставить управляемое удостоверение. Если в управляемом удостоверении отсутствуют роли, эта ошибка отображается во время назначения политики или в инициативе. При использовании портала после инициирования назначения политика автоматически предоставляет управляемое удостоверение перечисленным ролям.

![Управляемое удостоверение. Отсутствующая роль](../media/remediate-resources/missing-role.png)

> [!IMPORTANT]
> Если ресурс, изменяемый предложением **deployIfNotExists**, находится вне области назначения политики или шаблон обращается к свойствам ресурсов вне области назначения политики, управляемым удостоверениям назначения нужно [предоставить доступ вручную](#manually-configure-the-managed-identity), иначе развертывание исправлений завершится сбоем.

## <a name="configure-policy-definition"></a>Настройка определения политики

Первым шагом является определение ролей, которые требуются **deployIfNotExists** в определении политики для успешного развертывания содержимого включенного шаблона. В свойстве **details** добавьте свойство **roleDefinitionIds**. Это свойство является массивом строк, соответствующих ролям в среде. Полный пример см. в [примере deployIfNotExists](../concepts/effects.md#deployifnotexists-example).

```json
"details": {
    ...
    "roleDefinitionIds": [
        "/subscription/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
        "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
    ]
}
```

Свойство **roleDefinitionIds** использует полный идентификатор ресурса и не принимает короткое **имя** роли. Чтобы получить идентификатор для роли "Участник" в среде, используйте следующий код:

```azurecli-interactive
az role definition list --name 'Contributor'
```

```azurepowershell-interactive
Get-AzureRmRoleDefinition -Name 'Contributor'
```

## <a name="manually-configure-the-managed-identity"></a>Настройка управляемого удостоверения вручную

Когда вы создаете назначение с помощью портала, политика и создает управляемое удостоверение, и предоставляет ему роли, определенные в **roleDefinitionIds**. В следующих ситуациях шаги по созданию управляемого удостоверения и присвоению ему разрешений должны выполняться вручную:

- при использовании пакета SDK (например, Azure PowerShell);
- при изменении ресурсов, находящихся за пределами области назначения, с помощью шаблона;
- при чтении ресурсов, находящихся за пределами области назначения, с помощью шаблона.

> [!NOTE]
> В настоящее время только пакеты SDK Azure PowerShell и .NET поддерживают эту возможность.

### <a name="create-managed-identity-with-powershell"></a>Создание управляемого удостоверения с помощью PowerShell

Для создания управляемого удостоверения во время назначения политики необходимо определить свойство **Location** и использовать свойство **AssignIdentity**. Следующий пример получает определение встроенной политики **Развернуть прозрачное шифрование базы данных SQL**, задает целевую группу ресурсов, а затем создает назначение.

```azurepowershell-interactive
# Login first with Connect-AzureRmAccount if not using Cloud Shell

# Get the built-in "Deploy SQL DB transparent data encryption" policy definition
$policyDef = Get-AzureRmPolicyDefinition -Id '/providers/Microsoft.Authorization/policyDefinitions/86a912f6-9a06-4e26-b447-11b16ba8659f'

# Get the reference to the resource group
$resourceGroup = Get-AzureRmResourceGroup -Name 'MyResourceGroup'

# Create the assignment using the -Location and -AssignIdentity properties
$assignment = New-AzureRmPolicyAssignment -Name 'sqlDbTDE' -DisplayName 'Deploy SQL DB transparent data encryption' -Scope $resourceGroup.ResourceId -PolicyDefinition $policyDef -Location 'westus' -AssignIdentity
```

Переменная `$assignment` теперь содержит идентификатор субъекта для управляемого удостоверения, а также стандартные значения, возвращаемые при создании назначения политики. Доступ может осуществляться через `$assignment.Identity.PrincipalId`.

### <a name="grant-defined-roles-with-powershell"></a>Предоставление определенных ролей с помощью PowerShell

Новое управляемое удостоверение должно выполнить репликацию через Azure Active Directory, прежде чем ему можно будет предоставить необходимые роли. После завершения репликации приведенный ниже пример выполняет итерацию определения политики в `$policyDef` для **roleDefinitionIds** и использует командлет [New-AzureRmRoleAssignment](/powershell/module/azurerm.resources/new-azurermroleassignment), чтобы предоставить роли новому управляемому удостоверению.

```azurepowershell-interactive
# Use the $policyDef to get to the roleDefinitionIds array
$roleDefinitionIds = $policyDef.Properties.policyRule.then.details.roleDefinitionIds

if ($roleDefinitionIds.Count -gt 0)
{
    $roleDefinitionIds | ForEach-Object {
        $roleDefId = $_.Split("/") | Select-Object -Last 1
        New-AzureRmRoleAssignment -Scope $resourceGroup.ResourceId -ObjectId $assignment.Identity.PrincipalId -RoleDefinitionId $roleDefId
    }
}
```

### <a name="grant-defined-roles-through-portal"></a>Предоставление определенных ролей через портал

На портале управляемому удостоверению назначения можно присвоить определенные роли двумя способами: используя раздел **управление доступом (IAM)** либо изменив назначение политики или инициативы и выбрав **Сохранить**.

Чтобы добавить роль для управляемого удостоверения назначения, выполните следующие действия:

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. Выберите **Назначения** на странице службы "Политики Azure" слева.

1. Найдите назначение, которое имеет управляемое удостоверение, и щелкните его имя.

1. Найдите свойство **Идентификатор назначения** на странице изменения. Идентификатор назначения будет выглядеть примерно так:

   ```
   /subscriptions/{subscriptionId}/resourceGroups/PolicyTarget/providers/Microsoft.Authorization/policyAssignments/2802056bfc094dfb95d4d7a5
   ```

   Имя управляемого удостоверения — это последняя часть идентификатора ресурса назначения (в этом примере `2802056bfc094dfb95d4d7a5`). Скопируйте эту часть идентификатора ресурса назначения.

1. Перейдите к ресурсу или родительскому контейнеру ресурсов (группа ресурсов, подписка, группа управления), для которого нужно вручную добавить определение роли.

1. Щелкните ссылку **Управление доступом (IAM)** на странице ресурсов и выберите **+ Добавить назначение ролей** в верхней части страницы управления доступом.

1. Выберите нужную роль, соответствующую **roleDefinitionIds** определения политики. В поле **Назначение доступа к** оставьте значение по умолчанию "Пользователь, группа или приложение Azure AD". В поле **Выберите** вставьте или введите часть идентификатора ресурса назначения, обнаруженного ранее. После завершения поиска щелкните объект с тем же именем, чтобы выбрать идентификатор, и нажмите кнопку **Сохранить**.

## <a name="create-a-remediation-task"></a>Создание задачи исправления

При оценке назначение политики с эффектом **deployIfNotExists** определяет, имеются ли несоответствующие ресурсы. При обнаружении несоответствующих ресурсов на странице **Исправление** предоставляются дополнительные сведения. Вместе со списком политик, имеющих несоответствующие ресурсы, отображается параметр активации **задачи исправления**. Это параметр, который создает развертывание из шаблона **deployIfNotExists**.

Чтобы создать **задачу исправления**, выполните следующие действия:

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

   ![Поиск политики](../media/remediate-resources/search-policy.png)

1. Выберите **Исправление** на странице службы "Политика Azure" слева.

   ![Выбор исправления](../media/remediate-resources/select-remediation.png)

1. Все назначения политики **deployIfNotExists** с несоответствующими ресурсами содержатся на вкладке **Политики, подлежащие исправлению** и в таблице данных. Выберите политику с несоответствующими ресурсами. Откроется страница **Новая задача исправления**.

   > [!NOTE]
   > Альтернативным способом открытия страницы **задачи исправления** — найти и щелкнуть политику на странице **соответствия**, а затем нажать кнопку **Создать задачу исправления**.

1. На странице **Новая задача исправления** отфильтруйте ресурсы, которые нужно исправить, используя многоточие возле поля **Область**, чтобы выбрать дочерние ресурсы, которым была присвоена политика (в том числе отдельные объекты ресурса). Кроме того, используйте раскрывающийся список **Расположения**, чтобы дополнительно отфильтровать ресурсы. Будут исправлены только те ресурсы, которые перечислены в таблице.

   ![Исправление. Выбор ресурсов](../media/remediate-resources/select-resources.png)

1. Запустите задачу по исправлению после того, как ресурсы были отфильтрованы, щелкнув **Исправить**. На странице соответствия политики откроется вкладка **Задачи исправления**, где отображается состояние хода выполнения задач.

   ![Исправление. Ход выполнения задач](../media/remediate-resources/task-progress.png)

1. Щелкните **задачу исправления** на странице политики соответствия, чтобы получить сведения о ходе выполнения. Фильтрация, используемая для задачи, отображается вместе со списком ресурсов, которые будут исправлены.

1. На странице **задачи исправления** щелкните ресурс правой кнопкой мыши, чтобы просмотреть развертывание задачи обновления или ресурс. В конце строки щелкните **Связанные события**, чтобы просмотреть сведения, такие как сообщение об ошибке.

   ![Исправление. Контекстное меню задачи ресурса](../media/remediate-resources/resource-task-context-menu.png)

Ресурсы, развернутые посредством **задачи исправления**, добавляются на вкладку **Развернутые ресурсы** на странице соответствия политике.

## <a name="next-steps"></a>Дополнительная информация

- См. другие [примеры шаблонов для службы "Политика Azure"](../samples/index.md).
- См. дополнительные сведения о [структуре определения политики](../concepts/definition-structure.md).
- См. дополнительные сведения о [действиях политик](../concepts/effects.md).
- См. сведения о [программном создании политик](programmatically-create.md).
- Узнайте о том, как получить [подробные сведения о соответствии](getting-compliance-data.md).
- См. дополнительные сведения о группе управления в разделе [Упорядочение ресурсов с помощью групп управления Azure](../../management-groups/overview.md)