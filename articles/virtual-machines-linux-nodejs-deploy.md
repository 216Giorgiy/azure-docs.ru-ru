---
title: "Развертывание приложения Node.js на виртуальных машинах Linux в Azure"
description: "Узнайте, как развертывать приложения Node.js на виртуальных машинах Linux в Azure."
services: 
documentationcenter: nodejs
author: stepro
manager: dmitryr
editor: 
ms.assetid: 857a812d-c73e-4af7-a985-2d0baf8b6f71
ms.service: multiple
ms.devlang: nodejs
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/02/2016
ms.author: stephpr
translationtype: Human Translation
ms.sourcegitcommit: 4fc33ba185122496661f7bc49d14f7522d6ee522
ms.openlocfilehash: 0de0314902805a2bdb37ce3c6f79ec221f3aed31


---
# <a name="deploy-a-nodejs-application-to-linux-virtual-machines-in-azure"></a>Развертывание приложения Node.js на виртуальных машинах Linux в Azure
В этом руководстве мы рассмотрим, как можно развернуть приложение Node.js на виртуальных машинах Linux, работающих в Azure. Инструкции, приведенные в этом учебнике, применимы к любой операционной системе, на которой может работать Node.js.

Вы узнаете, как:

* разветвлять и клонировать репозиторий GitHub с простым приложением TODO;
* создавать и настраивать в Azure две виртуальные машины Linux, на которых будет работать приложение;
* изменять приложение в течение итераций посредством отправки обновлений на виртуальную машину с внешним веб-интерфейсом.

> [!NOTE]
> Для работы с этим руководством требуются учетные записи GitHub и Microsoft Azure, а также возможность использовать Git на компьютере разработки.
> 
> Если у вас нет учетной записи GitHub, вы можете зарегистрироваться [здесь](https://github.com/join).
> 
> Если у вас нет учетной записи [Microsoft Azure](https://azure.microsoft.com/), вы можете зарегистрироваться [здесь](https://azure.microsoft.com/pricing/free-trial/) и получить бесплатную ознакомительную версию. В процессе будет выполнена регистрация [учетной записи Майкрософт](http://account.microsoft.com) , если у вас ее еще нет. Кроме того, если вы являетесь подписчиком Visual Studio, вы можете [активировать свои преимущества MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F).
> 
> Если на компьютере разработки не установлен Git и если вы используете компьютер Macintosh или Windows, установите Git с [этого ресурса](http://www.git-scm.com). Если вы используете Linux, установите Git с помощью наиболее подходящей для вас процедуры, например `sudo apt-get install git`.
> 
> 

## <a name="forking-and-cloning-the-todo-application"></a>Разветвление и клонирование приложения TODO
В используемом в этом руководстве приложении TODO реализован простой внешний веб-интерфейс на основе экземпляра MongoDB, который хранит список TODO. После входа в GitHub перейдите по [этой](https://github.com/stepro/node-todo) ссылке, найдите приложение и создайте его ветвь с помощью ссылки в правом верхнем углу. Так вы создадите в своей учетной записи репозиторий с именем *имя_учетной_записи*/node-todo.

Теперь клонируйте этот репозиторий на компьютере разработки.

    git clone https://github.com/accountname/node-todo.git

Этот локальный клон репозитория нам понадобится немного позже. Мы будем изменять в нем исходный код.

## <a name="creating-and-configuring-the-linux-virtual-machines"></a>Создание и настройка виртуальных машин Linux
Azure имеет хорошую поддержку вычислений с использованием виртуальных машин Linux. В этой части руководства мы рассмотрим, как можно легко создать две виртуальные машины Linux и развернуть на них приложение TODO, запустив на одной из них внешний веб-интерфейс, а на другой — экземпляр MongoDB.

### <a name="creating-virtual-machines"></a>Создание виртуальных машин
Для создания виртуальной машины в Azure проще всего использовать портал Azure. Щелкните [здесь](https://portal.azure.com) , чтобы войти на портал Azure в своем веб-браузере. Когда портал Azure загрузится, выполните следующие действия:

* Щелкните ссылку "+ Создать".
* Выберите категорию "Вычисление", а затем — "Ubuntu Server 14.04 LTS".
* Выберите модель развертывания "Диспетчер ресурсов" и нажмите кнопку "Создать".
* Заполните основные параметры, используя следующие рекомендации:
  * Укажите имя, которое позже сможете легко узнать.
  * В целях этого руководства выберите проверку подлинности с использованием пароля.
  * Создайте новую группу ресурсов с узнаваемым именем.
* Что касается размера виртуальной машины, для целей этого руководства вполне подойдет "Standard A1".
* Проверьте дополнительные настройки и убедитесь, что для типа диска выбрана стандартная категория, а затем примите остальные значения по умолчанию.
* На странице сводки подтвердите создание виртуальной машины.

Выполните описанную выше процедуру дважды, чтобы создать две виртуальные машины Linux — для внешнего веб-интерфейса и для экземпляра MongoDB. Создание виртуальных машин займет примерно 5–10 минут.

### <a name="assigning-a-dns-entry-for-virtual-machines"></a>Назначение DNS-записи для виртуальных машин
Виртуальные машины, созданные в Azure, по умолчанию доступны только по общедоступному IP-адресу, например 1.2.3.4. Сделаем машины легко идентифицируемыми, назначив им DNS-записи.

Когда на портале будет указано, что виртуальные машины созданы, на панели навигации слева щелкните ссылку "Виртуальные машины" и найдите свои машины. Для каждой виртуальной машины:

* откройте вкладку "Основное" и щелкните общедоступный IP-адрес;
* в настройках общедоступного IP-адреса укажите DNS-имя и сохраните его.

Портал проверит, доступно ли выбранное вами имя. Когда конфигурация виртуальных машин будет сохранена, у виртуальных машин появятся имена узлов в виде `machinename.region.cloudapp.azure.com`.

### <a name="connecting-to-the-virtual-machines"></a>Подключение к виртуальным машинам
Подготовка виртуальных машин предусматривает возможность удаленного подключения к ним по протоколу SSH. Этим механизмом мы воспользуемся для настройки виртуальных машин. Если для разработки вы используете Windows, вам потребуется загрузить клиент SSH (если у вас его еще нет). Типичным вариантом является PuTTY, который можно загрузить с [этого ресурса](http://www.chiark.greenend.org.uk/~sgtatham/putty/). В операционных системах Linux и Macintosh уже есть встроенный клиент SSH.

### <a name="configuring-the-web-frontend-virtual-machine"></a>Настройка виртуальной машины с внешним веб-интерфейсом
Подключитесь по протоколу SSH к созданной виртуальной машине с внешним веб-интерфейсом с помощью PuTTY, программы командной строки с поддержкой SSH или другого подходящего средства. Отобразится приветствие и командная строка.

Сначала убедитесь, что Git и узел установлены.

    sudo apt-get install -y git
    curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
    sudo apt-get install -y nodejs

Так как внешний веб-интерфейс приложения использует некоторые собственные модули Node.js, необходимо также установить основной набор средств сборки.

    sudo apt-get install -y build-essential

В конце установите приложение Node.js с именем *forever*, которое помогает выполнять серверные приложения Node.js.

    sudo npm install -g forever

Это все компоненты, которые необходимы на этой виртуальной машине для работы внешнего веб-интерфейса программы. Давайте его запустим. Для этого мы сначала создадим простой клон ранее разветвленного репозитория GitHub. Это даст вам возможность легко публиковать обновления на виртуальной машине (описано ниже). Затем мы клонируем простой клон, чтобы получить версию репозитория, которая и будет запускаться.

В основном каталоге (~) выполните следующие команды, заменив *accountname* именем своей учетной записи GitHub.

    git clone --bare https://github.com/accountname/node-todo.git
    git clone node-todo.git

Теперь зайдите в каталог node-todo и выполните следующие команды.

    npm install
    forever start server.js

Внешний веб-интерфейс приложения теперь работает, но для доступа к приложению из веб-браузера нужно проделать еще одну процедуру. Созданную виртуальную машину защищает специальный ресурс Azure, именуемый *группой безопасности сети*. Он создается автоматически при подготовке виртуальной машины. Сейчас этот ресурс позволяет перенаправлять на виртуальную машину только внешние запросы на порте 22. Это дает возможность обмениваться данными с машиной по протоколу SSH и ничего более. Приложение TODO работает через порт 8080. Чтобы получить возможность видеть приложение, этот порт нужно тоже открыть.

Вернитесь на портал Azure и выполните следующие действия:

* На панели навигации слева щелкните "Группы ресурсов".
* Выберите группу ресурсов, которая содержит нужную виртуальную машину.
* В полученном списке ресурсов выберите группу безопасности сети (со значком щита).
* В окне свойств щелкните "Правила безопасности для входящего трафика".
* На панели инструментов нажмите кнопку "Добавить".
* Укажите имя, например default-allow-todo.
* Выберите протокол TCP.
* Укажите для диапазона портов назначения значение 8080.
* Нажмите кнопку "ОК" и дождитесь создания правила безопасности.

Когда правило безопасности будет создано, приложение TODO станет общедоступным в Интернете и к нему можно будет перейти с помощью URL-адреса. Например:

    http://machinename.region.cloudapp.azure.com:8080

Обратите внимание: виртуальная машина с MongoDB еще не настроена, а приложение TODO уже работает. Это связано с тем, что в репозитории исходного кода жестко запрограммирован предварительно развернутый экземпляр MongoDB. Когда мы настроим виртуальную машину с MongoDB, мы изменим исходный код так, чтобы в нем использовался наш экземпляр MongoDB.

### <a name="configuring-the-mongodb-virtual-machine"></a>Настройка виртуальной машины с MongoDB
Подключитесь по протоколу SSH ко второй созданной виртуальной машине с помощью PuTTY, программы командной строки с поддержкой SSH или другого подходящего средства. Увидев приветственное сообщение и командную строку, установите MongoDB (инструкции взяты [отсюда](https://docs.mongodb.org/master/tutorial/install-mongodb-on-ubuntu/)).

    sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927
    echo "deb http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.2 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.2.list
    sudo apt-get update
    sudo apt-get install -y mongodb-org

Стандартные настройки MongoDB предусматривают только локальный доступ. В целях этого руководства мы настроим доступ к MongoDB с виртуальной машины приложения. В контексте sudo откройте файл /etc/mongod.conf и найдите раздел `# network interfaces` . Установите для параметра `net.bindIp` значение `0.0.0.0`.

> [!NOTE]
> Эта конфигурация используется только в целях данного руководства. Из соображений безопасности мы **НЕ** рекомендуем использовать этот прием в производственной среде.
> 
> 

Теперь убедитесь, что служба MongoDB запущена.

    sudo service mongod restart

По умолчанию MongoDB работает через порт 27017. Так же, как нам нужно было открыть порт 8080 на виртуальной машине с внешним веб-интерфейсом, нам нужно открыть порт 27017 на виртуальной машине с MongoDB.

Вернитесь на портал Azure и выполните следующие действия:

* На панели навигации слева щелкните "Группы ресурсов".
* Выберите группу ресурсов, которая содержит виртуальную машину с MongoDB.
* В полученном списке ресурсов выберите группу безопасности сети (со значком щита) с тем же именем, которое вы присвоили виртуальной машине с MongoDB.
* В окне свойств щелкните "Правила безопасности для входящего трафика".
* На панели инструментов нажмите кнопку "Добавить".
* Укажите имя, например default-allow-mongo.
* Выберите протокол TCP.
* Укажите для диапазона портов назначения значение 27017.
* Нажмите кнопку "ОК" и дождитесь создания правила безопасности.

## <a name="iterating-on-the-todo-application"></a>Итерации приложения TODO
На данный момент мы подготовили две виртуальные машины Linux: на одной выполняется внешний веб-интерфейс приложения, а на другой — экземпляр MongoDB. Но есть проблема: веб-интерфейс пока не использует подготовленный экземпляр MongoDB. Чтобы исправить это, в коде внешнего веб-интерфейса вместо жестко запрограммированного экземпляра нужно указать переменную среды.

### <a name="changing-the-todo-application"></a>Изменение приложения TODO
На компьютере разработки, на котором вы создали первый клон репозитория node-todo, откройте в редакторе файл `node-todo/config/database.js` и вместо точного URL-адреса (например, `mongodb://...`) укажите переменную среды, например `process.env.MONGODB`.

Зафиксируйте изменения и отправьте их в GitHub в ветвь master.

    git commit -am "Get MongoDB instance from env"
    git push origin master

К сожалению, этого недостаточно для публикации изменений на виртуальной машине с внешним веб-интерфейсом. Внесем несколько дополнительных изменений на этой виртуальной машине, чтобы включить простой, но эффективный механизм публикации обновлений, который позволит быстро просматривать результаты изменений в реальной среде.

### <a name="configuring-the-web-frontend-virtual-machine"></a>Настройка виртуальной машины с внешним веб-интерфейсом
Как вы помните, ранее мы создали простой клон репозитория node-todo на виртуальной машине с внешним веб-интерфейсом. В результате был создан новый удаленный репозиторий Git, в который можно отправлять изменения. Тем не менее, простая передача изменений в удаленный репозиторий не предоставляет те возможности, которые нужны разработчикам при написании кода.

Нам нужно, чтобы при передаче изменений в удаленный репозиторий на виртуальной машине выполняемое приложение TODO обновлялось автоматически. К счастью, этого несложно добиться с помощью Git.

В Git есть несколько обработчиков, которые вызываются в определенное время для реагирования на действия, выполненные в репозитории. Они указываются с помощью сценариев оболочки в папке `hooks` репозитория. Обработчик, который лучше всего подходит для автоматического обновления, — это событие `post-update` .

Подключившись к виртуальной машине с внешним веб-интерфейсом по протоколу SSH, перейдите в каталог `~/node-todo.git/hooks` и добавьте в файл `post-update` следующее содержимое. Не забудьте заменить `machinename` и `region` данными виртуальной машины с MongoDB.

    #!/bin/bash

    forever stopall
    unset 'GIT_DIR'
    export MONGODB="mongodb://machinename.region.cloudapp.azure.com:27017/tododb"
    cd ~/node-todo && git fetch origin && git pull origin master && npm install && forever start ~/node-todo/server.js
    exec git update-server-info

Чтобы убедиться, что данные из файла считываются корректно, выполните следующую команду.

    chmod 755 post-update

Этот сценарий останавливает текущее серверное приложение, обновляет код в клонированном репозитории до последней версии, проверяет, выполняются ли все условия для обновленных зависимостей, и повторно запускает сервер. Сценарий также подготавливает среду к первому обновлению приложения и получению экземпляра MongoDB из переменной среды.

### <a name="configuring-your-development-machine"></a>Настройка компьютера разработки
Теперь давайте привяжем компьютер разработки к виртуальной машине c внешним веб-интерфейсом. Для этого на виртуальную машину нужно добавить простой репозиторий в качестве удаленного. Чтобы сделать это, выполните приведенную ниже команду. Вместо *user* укажите имя для входа на виртуальную машину с внешним веб-интерфейсом, а вместо *machinename* и *region* укажите соответствующие значения.

    git remote add azure user@machinename.region.cloudapp.azure.com:node-todo.git

Это все, что требуется для включения передачи, а по сути — публикации, изменений на виртуальную машину с внешним веб-интерфейсом.

### <a name="publishing-updates"></a>Публикация обновлений
Давайте опубликуем единственное на данный момент изменение, чтобы приложение использовало собственный экземпляр MongoDB.

    git push azure master

Должен отобразиться примерной такой результат:

    Counting objects: 4, done.
    Delta compression using up to 4 threads.
    Compressing objects: 100% (3/3), done.
    Writing objects: 100% (4/4), 406 bytes | 0 bytes/s, done.
    Total 4 (delta 1), reused 0 (delta 0)
    remote: info:    Forever stopped processes:
    remote: data:        uid  command         script    forever pid  id logfile                         uptime
    remote: data:    [0] 0Lyh /usr/bin/nodejs server.js 9064    9301    /home/username/.forever/0Lyh.log 0:0:3:17.487
    remote: From /home/username/node-todo
    remote:    5f31fd7..5bc7be5  master     -> origin/master
    remote: From /home/username/node-todo
    remote:  * branch            master     -> FETCH_HEAD
    remote: Updating 5f31fd7..5bc7be5
    remote: Fast-forward
    remote:  config/database.js | 2 +-
    remote:  1 file changed, 1 insertion(+), 1 deletion(-)
    remote: npm WARN package.json node-todo@0.0.0 No repository field.
    remote: npm WARN package.json node-todo@0.0.0 No license field.
    remote: warn:    --minUptime not set. Defaulting to: 1000ms
    remote: warn:    --spinSleepTime not set. Your script will exit if it does not stay up for at least 1000ms
    remote: info:    Forever processing file: /home/username/node-todo/server.js
    To username@machinename.region.cloudapp.azure.com:node-todo.git
    5f31fd7..5bc7be5  master -> master

После выполнения этой команды обновите приложение в веб-браузере. Вы увидите, что представленный здесь список TODO пустой и больше не привязан к общему развернутому экземпляру MongoDB.

Для завершения работы с этим руководством давайте внесем более заметное изменение. На компьютере разработки откройте в текстовом редакторе файл node-todo/public/index.html. Найдите заголовок jumbotron и замените название I'm a Todo-aholic названием I'm a Todo-aholic on Azure!

Зафиксируем это изменение.

    git commit -am "Azurify the title"

Прежде чем отправлять изменения обратно в репозиторий GitHub, давайте опубликуем изменения в Azure.

    git push azure master

После выполнения этой команды обновите веб-страницу — на ней отобразятся внесенные изменения. Поскольку все отображается правильно, отправьте изменения обратно в исходный удаленный репозиторий. 

    git push origin master

## <a name="next-steps"></a>Дальнейшие действия
В данной статье мы рассмотрели, как развернуть приложение Node.js на работающих в Azure виртуальных машинах Linux. Дополнительные сведения о виртуальных машинах Linux в Azure см. в статье [Введение в Linux в Azure](/documentation/articles/virtual-machines-linux-introduction/).

Дополнительные сведения о разработке приложений Node.js в Azure см. в [центре разработчиков Node.js](/develop/nodejs/).




<!--HONumber=Feb17_HO2-->


