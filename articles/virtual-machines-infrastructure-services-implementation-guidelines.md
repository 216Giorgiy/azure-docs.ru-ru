<properties 
	pageTitle="Руководство по реализации служб инфраструктуры Azure" 
	description="Основные рекомендации по проектированию и реализации, касающиеся развертывания рабочей нагрузки ИТ-среды в службах инфраструктуры Azure." 
	documentationCenter=""
	services="virtual-machines" 
	authors="JoeDavies-MSFT" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/05/2015" 
	ms.author="josephd"/>

# Руководство по реализации служб инфраструктуры Azure
 
В этом руководстве основное внимание уделяется ключевым проектным решениям и задачам для определения различных ресурсов, использующихся в большинстве случаев реализации служб инфраструктуры Azure.

Azure — отличная платформа для реализации экспериментальной конфигурации, так как для тестирования того или иного варианта реализации решений требуется совсем немного инвестиций. Тем не менее вам следует отличать простые методики в отношении экспериментальных сред от более сложных методик, в которых учтены конкретные характеристики, в отношении полнофункционального, готового к работе варианта реализации для выполнения рабочей нагрузки ИТ-среды.

В этом руководстве указаны многие области, требующие обязательного планирования для успешной реализации ИТ-инфраструктуры или выполнения рабочей нагрузки в Azure. Кроме того, в нем приведен порядок создания необходимых ресурсов, удобный при реализации решения на платформе Azure. Несмотря на некоторую универсальность, корпорация Майкрософт рекомендует применять указанный ниже порядок при планировании и принятии решений.

1.	Соглашения об именовании.
2.	Подписки и учетные записи.
3.	Хранилище
4.	виртуальные сети;
5.	Облачных служб
6.	Группы доступности.
7.	Виртуальные машины

Формирование надлежащего соглашения об именовании, а также следование определенному систематическому порядку создания ресурсов в Azure значительно снижает административную нагрузку и повышает вероятность успешного выполнения любого проекта реализации.

> [AZURE.NOTE]Территориальные группы не описаны, так как их применение — устаревшая практика. Дополнительные сведения см. в статье [О региональных виртуальных сетях и территориальных группах](https://msdn.microsoft.com/library/azure/jj156085.aspx).

## 1. Соглашения об именовании

Прежде чем создавать что-либо в Azure, следует установить надлежащее соглашение об именовании. Такое соглашение гарантирует предсказуемость имен всех ресурсов, позволяющую снизить административную нагрузку, связанную с управлением этими ресурсами.

Вы можете следовать некоторому набору соглашений об именовании, определенному для всей организации, подписки Azure или учетной записи Azure. Хотя сотрудники организации могут с легкостью устанавливать неявные правила при работе с ресурсами Azure, такая модель плохо масштабируется, если команде нужно работать над проектом в Azure.

Соглашения об именовании следует установить заранее. Некоторые рекомендации в отношении соглашений об именовании касаются набора правил, составляющих эти соглашения.

### Аффиксы

При создании определенных ресурсов Azure использует некоторые значения по умолчанию, чтобы упростить управление ресурсами, сопоставленными с создаваемыми. Например, при создании первой виртуальной машины для новой облачной службы портал управления Azure попытается использовать имя виртуальной машины в качестве имени новой облачной службы для нее.

Следовательно, полезно определять типы ресурсов, для определения которых требуются аффиксы. Кроме того, необходимо явно указывать, где будет находиться аффикс:

- в начале имени (префикс);
- в конце имени (суффикс).

Например, облачная служба, в которой размещено вычислительное ядро, может иметь такие два имени:

- Svc-CalculationEngine (префикс);
- CalculationEngine-Svc (суффикс).

Аффиксы относятся к различным аспектам, описывающим конкретные ресурсы. В следующей таблице приведены примеры типичных случаев.

Аспект | Примеры | Примечания
--- | --- | ---
Среда | dev, stg, prod | Зависит от назначения и имени каждой среды.
Расположение | usw (западная часть США), use (восточная часть США 2) | Зависит от региона, в котором располагается центр обработки данных или организация.
Служба, продукт или компонент Azure | SVC для облачной службы, VNet для виртуальной сети | Зависит от продукта, для которого ресурс обеспечивает поддержку.
Роль | sql, ora, sp, iis | Зависит от роли виртуальной машины.
Экземпляр | 01, 02, 03 и т. д. | Для ресурсов, которые могут иметь более одного экземпляра. Например, веб-серверы с балансировкой нагрузки, размещенные в облачной службе.
		
При установке соглашений об именовании убедитесь, что они явно указывают, какие аффиксы используются для каждого типа ресурсов, и их расположение (префикс или суффикс).

### Даты

Во многих случаях важно определять дату создания по имени ресурса. Корпорация Майкрософт рекомендует использовать формат даты ГГГГММДД. Этот формат обеспечивает не только запись полной даты, но и то, что два ресурса, имена которых отличаются только датой, будут отсортированы в алфавитном и хронологическом порядке одновременно.

### Именование ресурсов
В соглашении об именовании необходимо определить каждый тип ресурсов и правила назначения имен каждому созданному ресурсу. Эти правила применяются ко всем типам ресурсов, например:

- Подписки
- учетные записи;
- учетные записи хранения;
- виртуальные сети;
- подсети;
- группы доступности;
- Облачные службы
- Виртуальные машины
- Конечные точки
- группы сетевой безопасности;
- Роли

Имена должны быть как можно более содержательными, чтобы можно было безошибочно определить ресурсы, к которым они относятся.

### Имена компьютеров 

Когда администратор создает виртуальную машину, Microsoft Azure требует указать ее имя. Microsoft Azure будет использовать имя виртуальной машины в качестве имени ресурса виртуальной машины Azure. То же имя виртуальной машины Azure будет использовать в качестве имени компьютера, заданного в операционной системе виртуальной машины. Однако целевые имена могут и не совпадать.

Если виртуальная машина создается с помощью VHD-файла, в котором уже определена операционная система, имя виртуальной машины в Microsoft Azure может отличаться от имени компьютера, заданного в операционной системе виртуальной машины. В этом случае управление виртуальной машиной может усложниться, поэтому такой сценарий рекомендуется избегать. Имя ресурса виртуальной машины Azure всегда должно совпадать с именем компьютера, заданным в операционной системе этой виртуальной машины.

Рекомендуется, чтобы имя виртуальной машины Azure совпадало с именем компьютера, на котором установлена основная операционная система. По этой причине необходимо следовать правилам именования NetBIOS, как описано в статье [Соглашения об именовании компьютеров Microsoft NetBIOS](https://support.microsoft.com/kb/188997/).

### Имена учетных записей хранения

Имена учетных записей хранения создаются по особым правилам. Можно использовать только строчные буквы и цифры, а назначенное имя, сцепленное с именем службы (blob, table, queue — большой двоичный объект, таблица или очередь) и домена по умолчанию (core.windows.net), должно быть глобально допустимым уникальным именем DNS. Например, если учетная запись хранения называется mystorageaccount, то следующие URL-адреса должны быть допустимыми уникальными именами DNS:

- mystorageaccount.blob.core.windows.net;
- mystorageaccount.table.core.windows.net;
- mystorageaccount.queue.core.windows.net.

Кроме того, учетные записи хранения могут использовать контейнеры. Они должны соответствовать соглашениям об именовании, описанным в статье [Именование контейнеров, больших двоичных объектов и метаданных и ссылка на них](https://msdn.microsoft.com/library/azure/dd135715.aspx).

### Имена стандартных блоков Azure

Стандартные блоки Azure — это службы на уровне приложений, доступные в Azure, как правило, для приложений, использующих функции PaaS. Однако ресурсы IaaS могут использовать некоторые из них, например Azure SQL или диспетчер трафика.

Эти службы зависят от массива артефактов, созданных и зарегистрированных в Azure. Кроме того, они должны учитываться в ваших соглашениях об именовании.

### Обобщение рекомендаций по реализации, касающихся соглашений об именовании

Решение

- Каковы соглашения об именовании для ресурсов Azure? 

Задача

- Определить соглашения об именовании с учетом применения аффиксов, иерархии, строковых значений и других политик для ресурсов Azure.

## 2. Подписки и учетные записи

Для работы с Azure требуется одна или несколько подписок на Azure. Такие ресурсы, как облачные службы или виртуальные машины, доступны только при использовании этих подписок.

- Как правило, у корпоративных клиентов есть Соглашение о регистрации Enterprise, которое считается ресурсом самого верхнего уровня в иерархии и сопоставлено с одной или несколькими учетными записями. 
- Для клиентов без Соглашения о регистрации Enterprise ресурсом верхнего уровня считается учетная запись.
- Подписки сопоставлены с учетными записями. С одной учетной записью может быть связано несколько подписок. Azure хранит данные для выставления счетов на уровне подписки.

Так как количество уровней иерархии для связи между учетной записью и подпиской ограничено двумя, важно, чтобы соглашение об именовании для учетных записей и подписок соответствовало требованиям к выставлению счетов. Например, если в транснациональной компании используется Azure, можно создать по одной учетной записи на регион и управлять подписками на уровне региона.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/sub01.png)
  
Например, можно использовать указанную ниже структуру.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/sub02.png)
  
Возьмем тот же пример. Если нужно сопоставить несколько подписок для региона с определенной группой, то соглашение об именовании должно предусматривать способ указания дополнительных сведений в имени учетной записи или подписки. Такая организация позволяет уплотнять данные для выставления счетов, чтобы можно было создавать уровни иерархии во время отправки отчетов о выставлении счетов.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/sub03.png)

Организация может выглядеть следующим образом.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/sub04.png)
 
Корпорация Майкрософт выставляет детализированные счета в виде загружаемого файла для одной или всех учетных записей, предусмотренных в Соглашении Enterprise. Вы можете обработать этот файл с помощью Excel или других приложений. При этом будут приняты данные и разделены ресурсы, которые кодируют несколько уровней иерархии, на отдельные столбцы, а также будет использована сводная таблица или PowerPivot для предоставления возможностей динамических отчетов.

### Обзор рекомендаций по реализации, касающихся учетных записей и подписок

Решение

- Какие подписки и учетные записи необходимы для размещения рабочей нагрузки ИТ-среды или ИТ-инфраструктуры?

Задача

- Создать набор подписок и учетных записей с использованием соглашения об именовании.

## 3. Хранилище

Хранилище является неотъемлемой частью любого решения Azure, так как оно не только предоставляет службы на уровне приложений, но и является частью инфраструктуры, поддерживающей виртуальные машины.
 
В Azure доступно два типа хранилищ. Стандартное хранилище предоставляет вам доступ к хранилищу больших двоичных объектов, таблиц, очередей и файлов. Хранилище Premium предназначено для высокопроизводительных приложений, например серверов SQL Server в кластере AlwaysOn, и в настоящее время поддерживает только диски виртуальных машин Azure.

Учетные записи хранения привязаны к целевым показателям масштабируемости. Сведения о текущих ограничениях для хранилищ Azure см. в статье [Ограничения и квоты, касающиеся подписок и служб Microsoft Azure](azure-subscription-service-limits.md#storage-limits). См. также статью [Целевые показатели масштабируемости и производительности хранилища Azure](storage/storage-scalability-targets.md).

Azure создает виртуальные машины с диском операционной системы, временным диском и любым количеством дополнительных дисков данных. Диск операционной системы и диски данных — большие двоичные объекты Azure, тогда как временный диск относится к локальному хранилищу узла, на котором запущена виртуальная машина. По этой причине временный диск не подходит для данных, которые должны сохраняться во время перезапуска системы, ведь виртуальная машина может быть перенесена в другой узел без предупреждения с потерей всех данных на этом диске. Не храните ничего на временном диске.

Максимальный размер дисков операционной системы и дисков данных составляет 1023 ГБ, так как максимальный размер большого двоичного объекта составляет 1024 ГБ и он должен содержать метаданные (нижний колонтитул) файла виртуального жесткого диска (ГБ — это 10 243 байт). Чтобы преодолеть это ограничение, в Windows можно реализовать чередование дисков.

### Диски с чередованием
Возможность создавать диски размером более 1023 ГБ в нескольких экземплярах с использованием чередования данных на дисках увеличивает производительность, позволяя нескольким большим двоичным объектам представляться единым томом хранилища. Это обеспечивает параллельный ввод-вывод, необходимый для записи и считывания данных на одном диске.

Azure налагает ограничения на количество дисков данных и пропускную способность в зависимости от размера виртуальной машины. Дополнительные сведения см. в статье [Размеры виртуальных машин и облачных служб для Azure](https://msdn.microsoft.com/library/azure/dn197896.aspx).

При использовании чередования дисков данных Azure придерживайтесь следующих рекомендаций:

- Диски данных всегда должны иметь максимальный размер (1023 ГБ).
- Присоединяйте столько дисков данных, сколько позволяет размер виртуальной машины.
- Используйте конфигурацию дискового пространства.
- Используйте конфигурацию чередования дисков.
- Избегайте кэширования дисков данных Azure (для политики кэширования нужно выбрать параметр "Нет").

Дополнительные сведения см. в статье [Storage Spaces: повышение производительности](http://social.technet.microsoft.com/wiki/contents/articles/15200.storage-spaces-designing-for-performance.aspx).

### Несколько учетных записей хранения

Использование нескольких учетных записей хранения для поддержки дисков, сопоставленных с несколькими виртуальными машинами, гарантирует, что общий объем вводимых и выводимых данных на этих дисках будет намного ниже целевых показателей масштабируемости для каждой из этих учетных записей.

Корпорация Майкрософт рекомендует для начала развернуть по одной виртуальной машине на учетную запись хранения.

### Проектирование структуры хранилища

Чтобы можно было реализовать эти стратегии внедрения дисковой подсистемы виртуальных машин высокой производительности, для рабочей нагрузки ИТ-среды или ИТ-инфраструктуры обычно используется несколько учетных записей хранения. В них будут размещены много больших двоичных объектов виртуальных жестких дисков. В некоторых случаях с одним томом на виртуальной машине сопоставляются несколько больших двоичных объектов.

Это может усложнить задачи управления. Крайне важно разработать удачную стратегию хранения, включая соответствующие имена дисков и сопоставленных больших двоичных объектов для виртуальных жестких дисков.

### Обзор рекомендаций по реализации, касающихся хранилищ

Решения

- Требуется ли чередование для создания дисков размером более 500 ТБ?
- Требуется ли чередование дисков для достижения оптимальной производительности рабочей нагрузки?
- Какие учетные записи хранения необходимы для размещения рабочей нагрузки в ИТ-среде или ИТ-инфраструктуры?

Задача

- Создать набор учетных записей хранения с использованием соглашения об именовании. Вы можете использовать портал предварительной версии Azure, портал управления Azure или командлет PowerShell (**New-AzureStorageAccount**).

## 4. Облачные службы

Облачные службы — стандартный блок Azure для служб PaaS и IaaS. В случае PaaS облачные службы представляют группу ролей, экземпляры которых могут взаимодействовать между собой. Облачные службы сопоставлены с общедоступным виртуальным IP-адресом и подсистемой балансировки нагрузки, которая принимает входящий трафик из Интернета и балансирует его нагрузку для ролей, настроенных на прием этого трафика.

В случае IaaS облачные службы предоставляют аналогичные функции, хотя в большинстве случаев возможности подсистемы балансировки нагрузки используются для перенаправления трафика из Интернета в определенные TCP- или UDP-порты на нескольких виртуальных машинах в облачных службах.

Имена облачных служб особо важны для IaaS, так как Azure использует их как составляющую соглашения об именовании по умолчанию для дисков. Имя облачной службы может содержать только буквы, цифры и дефисы. Первый и последний символ в поле должны быть буквами или цифрами.

Microsoft Azure показывает имена облачных служб, так как они сопоставлены с виртуальным IP-адресом, в домене cloudapp.net. Для удобства пользователя приложения при необходимости следует указать запоминающееся имя, которое заменит полное имя облачной службы. Обычно это делается с помощью записи CNAME в общедоступном DNS-сервере, который сопоставляет общедоступное DNS-имя ресурса (например, www.contoso.com) с DNS-именем облачной службы, в которой размещается ресурс (например, облачной службы с веб-серверами для www.contoso.com).

Кроме того, может потребоваться, чтобы соглашение об именовании для облачных служб допускало исключения, так как имена облачных служб должны быть уникальными и отличаться от всех остальных облачных служб Microsoft Azure независимо от клиента Microsoft Azure.

Подписки на Azure могут поддерживать до 200 облачных служб.

### Обзор рекомендаций по реализации, касающихся облачных служб

Решение

- Какие облачные службы необходимы для размещения рабочей нагрузки в ИТ-среде или ИТ-инфраструктуры? 

Задача

- Создать набор облачных служб с использованием соглашения об именовании. Вы можете использовать портал управления Azure или командлет PowerShell (**New-AzureService**).

## 5. Виртуальные сети

Следующий логический шаг — создание виртуальных сетей, необходимых для поддержки взаимодействия между виртуальными машинами в решении. Несмотря на то что можно разместить несколько виртуальных машин для рабочей нагрузки ИТ-среды просто в облачной службе, рекомендуется использовать виртуальные сети.

Виртуальные сети — это контейнер для виртуальных машин, для которого также можно указать подсети, пользовательские адреса и параметры конфигурации DNS. Виртуальные машины в одной виртуальной сети могут взаимодействовать непосредственно с другими компьютерами в той же виртуальной сети независимо от того, в какие облачные службы они входят. В виртуальной сети это взаимодействие остается закрытым, и общедоступные конечные точки при этом не используются. Это взаимодействие может происходить с использованием IP-адреса или имени, с помощью DNS-сервера, установленного в виртуальной сети или локально, если виртуальная машина подключена к корпоративной сети.

### Подключение сайтов
Если локальным пользователям и компьютерам не требуется постоянное подключение к виртуальным машинам в виртуальной сети Azure, создайте виртуальную сеть только в облаке.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/vnet01.png)
 
Как правило, это практикуется при таких рабочих нагрузках, когда необходимо подключение к Интернету, например, в случае веб-серверов. Вы можете управлять этими виртуальными машинами с помощью подключений к удаленному рабочему столу, удаленных сеансов PowerShell, подключений Secure Shell (SSH) и VPN-подключений типа "точка-сеть".

Облачные виртуальные сети могут использовать любую часть пространства внутренних IP-адресов, так как они не подключаются к локальной сети.

Если локальным пользователям и компьютерам необходимо постоянное подключение к виртуальным машинам в виртуальной сети Azure, создайте распределенную виртуальную сеть и подключите ее к локальной сети с помощью ExpressRoute или VPN-подключения типа "сеть-сеть".

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/vnet02.png)
 
В этой конфигурации виртуальная сеть Azure по сути является облачным расширением локальной сети.

Так как распределенные виртуальные сети подключаются к локальной сети, они должны использовать уникальную часть используемого организацией адресного пространства, а инфраструктура маршрутизации должна поддерживать отправку трафика в эту часть путем его перенаправления на локальное VPN-устройство.

Чтобы разрешить передачу пакетов из распределенной виртуальной сети в локальную сеть, необходимо настроить набор соответствующих префиксов локальных адресов в рамках определения локальной сети для виртуальной сети. В зависимости от адресного пространства виртуальной сети и набора соответствующих локальных расположений, в локальной сети может быть много префиксов адресов.

Облачную виртуальную сеть можно преобразовать в распределенную, но для этого, скорее всего, потребуется повторная нумерация адресного пространства виртуальной сети, подсетей и виртуальных машин, использующих назначенные для Azure статические IP-адреса, также называемые динамическими IP-адресами (DIP). Следовательно, необходимо точно определить, какой тип виртуальных сетей нужен (облачные или распределенные), прежде чем создавать их.

### Подсети
Подсети позволяют упорядочивать связанные ресурсы либо логически (например, одна подсеть для виртуальных машин, сопоставленных с одним приложением), либо физически (например, одна подсеть для каждой облачной службы), а также использовать методы изоляции подсетей для повышения безопасности.

В случае распределенных виртуальных сетей необходимо проектировать подсети по тем же правилам, которые используются для локальных ресурсов, учитывая, что **Azure всегда использует первые три IP-адреса в адресном пространстве для каждой подсети**. Чтобы определить количество адресов, необходимых для подсети, посчитайте виртуальные машины, которые необходимы сейчас, рассчитайте дальнейший рост, а затем используйте следующую таблицу для определения размера подсети.
 
Необходимое количество виртуальных машин | Необходимое количество битов узла | Размер подсети 
--- | --- | --- 
1–3 | 3 | /29
4–11 | 4. | /28
12–27 | 5 | /27
28–59 | 6 | /26
60–123 | 7 | /25

> [AZURE.NOTE]В случае обычной локальной подсети с n битов узла максимальное количество адресов узла составляет 2<sup>n</sup> – 2. В случае подсети Azure с n битов узла максимальное количество адресов узла составляет 2<sup>n</sup> – 5 (2 плюс 3 в случае адресов, используемых Azure в каждой подсети).

Если выбранный размер подсети слишком мал, потребуются повторные нумерация и развертывание виртуальных машин в подсети.

### Обзор рекомендаций по реализации, касающихся виртуальных сетей

Решения

- Какой тип виртуальной сети необходим, чтобы разместить рабочую нагрузку ИТ-среды или ИТ-инфраструктуру (облачная или распределенная)?
- Какое адресное пространство необходимо для размещения подсетей и виртуальных машин сейчас и при будущем целесообразном расширении, если используются распределенные виртуальные сети?

Задачи

- Определить адресное пространство виртуальной сети.
- Определить набор подсетей и адресного пространства для каждой из них.
- Если используются распределенные виртуальные сети, определите набор адресных пространств локальной сети для локальных расположений, доступ к которым необходим виртуальным машинам в виртуальной сети.
- Создайте виртуальную сеть, следуя соглашению об именовании. Вы можете использовать портал предварительной версии Azure или портал управления Azure.

## 6. Группы доступности

При использовании модели PaaS в Azure облачные службы содержат одну или несколько ролей, выполняющих код приложений. Для ролей могут быть предусмотрены один или несколько экземпляров виртуальных машин, которые автоматически подготавливаются структурой. Azure может обновлять экземпляры, предусмотренные для этих ролей, в любой момент, но так как они относятся к одной и той же роли, Azure не обновляет все экземпляры одновременно во избежание перерыва в обслуживании.

При использовании модели IaaS в Azure понятие роли не имеет значения, так как каждая виртуальная машина IaaS представляет роль с одним экземпляром. Чтобы в Azure не останавливалась работа сразу нескольких сопоставленных виртуальных машин (например, для обновления операционной системы узла, на котором они развернуты), было введено понятие групп доступности. Группа доступности не позволяет Azure останавливать работу всех виртуальных машин, входящих в такую группу, одновременно, чтобы не было перерыва в обслуживании. На виртуальные машины в группе доступности действует соглашение об уровне обслуживания, предусматривающее непрерывную работу в течение 99,95 % времени.

Группы доступности необходимо учитывать при планировании решения с высоким уровнем доступности. Группа доступности определяется как набор виртуальных машин в одной облачной службе, для которых указаны одинаковые имена группы доступности. Группы доступности можно создать после создания облачных служб.

### Обзор рекомендаций по реализации, касающиеся групп доступности

Решение

- Сколько нужно групп доступности для различных ролей и уровней, предусмотренных для рабочей нагрузки ИТ-среды или ИТ-инфраструктуры?

Задача

- Определить набор групп доступности, следуя соглашению об именовании. Вы можете сопоставить виртуальную машину с группой доступности при создании виртуальных машин или после этого.

## 7. Виртуальные машины

При использовании модели PaaS Azure управляет виртуальными машинами и сопоставленными с ними дисками. Необходимо создать облачные службы и роли, а также присвоить им имена, после чего Azure создаст экземпляры, сопоставленные с этими ролями. В случае использования модели IaaS в Azure необходимо указать имена облачных служб, виртуальных машин и сопоставленных с ними дисков.

Чтобы снизить административную нагрузку, портал управления Azure будет использовать имя компьютера в качестве имени по умолчанию для сопоставленной облачной службы (если пользователь решит создать облачную службу с помощью мастера создания виртуальных машин).

Кроме того, Azure присваивает имена дискам и их вспомогательным большим двоичным объектам виртуальных жестких дисков, используя сочетание имени облачной службы, имени компьютера и даты создания.

В общем дисков будет значительно больше, чем виртуальных машин. При управлении виртуальными машинами необходимо соблюдать осторожность, чтобы избежать их потери для дисков. Кроме того, вы можете удалять диски, не удаляя вспомогательный большой двоичный объект. В таком случае большой двоичный объект останется в учетной записи хранения, пока он не будет удален вручную.

### Обзор рекомендаций по реализации, касающихся виртуальных машин

Решение

- Сколько виртуальных машин необходимо предоставить для рабочей нагрузки ИТ-среды или ИТ-инфраструктуры?

Задачи

- Определить имя каждой виртуальной машины, следуя соглашению об именовании.
- Вы можете создать виртуальные машины с помощью портала предварительной версии Azure, портала управления Azure или командлета PowerShell **New-AzureVM**.

## Пример рабочей нагрузки ИТ-среды: система финансового анализа Contoso

Корпорация Contoso разработала систему финансового анализа нового поколения на основе собственных передовых алгоритмов, упрощающих торговлю на фьючерсной бирже. Эта система должна быть доступна клиентам корпорации благодаря набору серверов в Azure, содержащему следующее:

- Два (в дальнейшем — больше) веб-сервера на основе IIS с настраиваемыми веб-службами на уровне сети.
- Два (в дальнейшем — больше) сервера приложений на основе IIS, выполняющих вычисления на уровне приложений.
- Кластер SQL Server 2014 с группами доступности AlwaysOn (два сервера SQL Server и следящий сервер основных узлов), в котором хранятся данные журнала и данные о текущих вычислениях на уровне базы данных.
- Два контроллера домена Active Directory для автономных леса и домена на уровне проверки подлинности, что необходимо для кластеризации SQL Server.
- Все серверы располагаются в двух подсетях: подсети переднего плана для веб-серверов и внутренней подсети для серверов приложений, кластера SQL Server 2014 и контроллеров домена.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/example-tiers.png)
 
В случае защищенного входящего веб-трафика от клиентов Contoso через Интернет необходима балансировка нагрузки для веб-серверов. Трафик запросов на вычисления в виде HTTP-запросов с веб-серверов должен быть распределен между серверами приложений. Кроме того, система должна быть рассчитана на высокий уровень доступности.

В результате проект должен включать:

- подписку на Azure и учетную запись Azure для Contoso;
- учетные записи хранения;
- виртуальную сеть с двумя подсетями;
- набор облачных служб;
- группы доступности для групп серверов с аналогичной ролью;
- Виртуальные машины

Все вышеуказанное должно соответствовать соглашению об именовании Contoso.

- В Contoso используется префикс [рабочая нагрузка ИТ-среды]-[расположение]-[ресурсы Azure]. В этом примере azfae (система финансового анализа Azure) — это имя рабочей нагрузки ИТ-среды, а use (восточная часть США 2) — это расположение, так как большинство первых клиентов компании Contoso проживают на восточном побережье США.
- Для учетных записей хранения используется формат contosoazfaeusesa[описание]. Обратите внимание, что для уникальности к префиксу добавлено слово contoso, а имена учетных записей хранения не могут содержать дефисы.
- Для облачных служб используется формат contoso-azfae-use-cs-[описание]. Обратите внимание, что для уникальности к префиксу добавлено слово contoso.
- Для виртуальных сетей используется формат AZFAE-USE-VN[номер].
- Для групп доступности используется формат azfae-use-as-[роль].
- Для имен виртуальных машин используется формат azfae-use-vm-[имя_виртуальной_машины].

### Подписки на Azure и учетные записи Azure

Компания Contoso использует подписку Enterprise Subscription под названием "Enterprise Subscription Contoso" для выставления счетов по этой рабочей нагрузке ИТ-среды.

### учетные записи хранения;

Компании Contoso нужны две учетных записи хранения:

- **contosoazfaeusesawebapp** в случае обычного хранилища для веб-серверов, серверов приложений, контроллеров доменов и дополнительных дисков с данными.
- **contosoazfaeusesasqlclust** в случае хранилище Premium для кластера SQL Server и дополнительных дисков с данными.

Компания Contoso создала две учетные записи хранения с помощью следующих команд PowerShell:

	New-AzureStorageAccount -StorageAccountName "contosoazfaeusesawebapp" -Location "East US 2"
	New-AzureStorageAccount -StorageAccountName "contosoazfaeusesasqlclust" -Location "East US 2" -Type Premium_LRS

### Виртуальная сеть с подсетями

Так как виртуальная сеть не требует постоянного подключения к локальной сети Contoso, компания Contoso выбрала облачную виртуальную сеть.

Облачная виртуальная сеть создана с указанием следующих параметров на портале предварительной версии Azure:

- Имя: AZFAE-USE-VN01.
- Расположение: восточная часть США 2.
- Адресное пространство виртуальной сети: 10.0.0.0/8.
- Первая подсеть:
	- Имя: FrontEnd.
	- Адресное пространство: 10.0.1.0/24.
- Вторая подсеть:
	- Имя: BackEnd.
	- Адресное пространство: 10.0.2.0/24.

### Облачных служб

В компании Contoso используются две облачные службы:

- **contoso-azfae-use-cs-frontend** для веб-серверов переднего плана.
- **contoso-azfae-use-cs-backend** для внутренних серверов приложений, серверов кластера SQL Server и контроллеров домена.

Компания Contoso создала облачные службы с помощью следующих команд PowerShell:

	New-AzureService -Service "contoso-azfae-use-cs-frontend" -Location "East US 2"
	New-AzureService -Service "contoso-azfae-use-cs-backend" -Location "East US 2"

### Группы доступности

Чтобы обеспечить высокий уровень доступности всех четырех уровней системы финансового анализа, компания Contoso использует четыре группы доступности:

- **azfae-use-as-dc** для контроллеров домена;
- **azfae-use-as-web** для веб-серверов;
- **azfae-use-as-app** для серверов приложений;
- **azfae-use-as-sql** для серверов в кластере SQL Server.

Эти группы доступности будут созданы вместе с виртуальными машинами.

### Виртуальные машины

Компания Contoso использует следующие имена для своих виртуальных машин Azure:

- **azfae-use-vm-dc01** для первого контроллера домена;
- **azfae-use-vm-dc02** для второго контроллера домена;
- **azfae-use-vm-web01** для первого веб-сервера;
- **azfae-use-vm-web02** для второго веб-сервера;
- **azfae-use-vm-app01** для первого сервера приложений;
- **azfae-use-vm-app02** для второго сервера приложений;
- **azfae-use-vm-sql01** для первого сервера SQL в кластере SQL Server;
- **azfae-use-vm-sql02** для второго сервера SQL в кластере SQL Server;
- **azfae-use-vm-sqlmn01** для следящего сервера основных узлов в кластере SQL Server.

Это конфигурация, которая получается в результате.

![](./media/virtual-machines-infrastructure-services-implementation-guidelines/example-config.png)
 
Эта конфигурация включает:

- облачную виртуальную сеть с двумя подсетями (FrontEnd и BackEnd);
- две облачные службы;
- две учетные записи хранения;
- четыре группы доступности, по одной для каждого уровня системы финансового анализа;
- виртуальные машины для четырех уровней;
- внешний набор с балансировкой нагрузки для веб-трафика HTTPS из Интернета на веб-серверы;
- внешний набор с балансировкой нагрузки для незашифрованного веб-трафика с веб-серверов на серверы приложений.

Эти команды PowerShell для Azure создают виртуальные машины в этой конфигурации для ранее созданных учетных записей хранения, облачных служб и виртуальной сети.

	#Specify the storage account for the web and application servers
	Set-AzureSubscription –SubscriptionName "Contoso Enterprise Subscription" -CurrentStorageAccountName "contosoazfaeusesawebapp"
	
	#Specify the cloud service name for the web servers
	$ServiceName="contoso-azfae-use-cs-frontend"
	
	#Get the image string for the latest version of the Windows Server 2012 R2 Datacenter image in the gallery
	$image= Get-AzureVMImage | where { $_.ImageFamily -eq "Windows Server 2012 R2 Datacenter" } | sort PublishedDate -Descending | select -ExpandProperty ImageName -First 1
	
	#Create the first web server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the first web server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-web01 -InstanceSize large -ImageName $image -AvailabilitySetName azfae-use-as-web
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames FrontEnd
	$vm1 | Add-AzureEndpoint -Name Web1 -Protocol tcp -LocalPort 443 -PublicPort 443 -LBSetName "WebSet" -DefaultProbe
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Create the second web server 
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the second web server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-web02 -InstanceSize Large -ImageName $image -AvailabilitySetName azfae-use-as-web
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames FrontEnd
	$vm1 | Add-AzureEndpoint -Name Web2 -Protocol tcp -LocalPort 443 -PublicPort 443 -LBSetName "WebSet" -DefaultProbe
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Specify the cloud service name for the application, SQL server, and authentication tiers
	$ServiceName="contoso-azfae-use-cs-backend"
	
	#Create the first domain controller server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the first domain controller server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-dc01 -InstanceSize Small -ImageName $image -AvailabilitySetName azfae-use-as-dc
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 100 -DiskLabel AppFiles –LUN 0 -HostCaching None
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Create the second domain controller server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the second domain controller server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-dc02 -InstanceSize Small -ImageName $image -AvailabilitySetName azfae-use-as-dc
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 100 -DiskLabel AppFiles –LUN 0 -HostCaching None
	New-	AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Create an internal load balancer instance for the application server tier 
	Add-AzureInternalLoadBalancer -ServiceName $ServiceName -InternalLoadBalancerName "AppTierILB" –SubnetName BackEnd –StaticVNetIPAddress 10.0.2.100
	
	#Create the first application server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the first application server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-app01 -InstanceSize Large -ImageName $image -AvailabilitySetName azfae-use-as-app
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureEndpoint -Name App1 -Protocol tcp -LocalPort 80 -PublicPort 80 -LBSetName "AppSet" -InternalLoadBalancerName "AppTierILB" -DefaultProbe
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 500 -DiskLabel AppFiles –LUN 0 -HostCaching None
	New-	AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Create the second application server 
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the second application server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-app02 -InstanceSize Large -ImageName $image -AvailabilitySetName azfae-use-as-app
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Add-AzureEndpoint -Name App2 -Protocol tcp -LocalPort 80 -PublicPort 80 -LBSetName "AppSet" -InternalLoadBalancerName "AppTierILB" -DefaultProbe
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 500 -DiskLabel AppFiles –LUN 0 -HostCaching None
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Specify the premium storage account for the SQL Server cluster
	Set-AzureSubscription –SubscriptionName "Contoso Enterprise Subscription" -CurrentStorageAccountName "contosoazfaeusesasqlclust"
	
	#Create the majority node witness server for the SQL Server cluster
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the majority node witness server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-sqlmn01 -InstanceSize Medium -ImageName $image -AvailabilitySetName azfae-use-as-sql
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password 
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Change the image string for the latest version of the SQL Server 2014 image in the gallery
	$image= Get-AzureVMImage | where { $_.ImageFamily -eq "SQL Server 2014 RTM Standard on Windows Server 2012 R2" } | sort PublishedDate -Descending | select -ExpandProperty ImageName -First 1
	
	#Create the first SQL Server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the first SQL Server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-sql01 -InstanceSize A5 -ImageName $image  -AvailabilitySetName azfae-use-as-sql
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 1000 -DiskLabel SQLFiles –LUN 0 -HostCaching None
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01
	
	#Create the second SQL Server
	$cred1=Get-Credential –Message "Type the name and password of the local administrator account for the second SQL Server."
	$vm1=New-AzureVMConfig -Name azfae-use-vm-sql02 -InstanceSize A5 -ImageName $image  -AvailabilitySetName azfae-use-as-sql
	$vm1 | Add-AzureProvisioningConfig -AdminUsername $cred1.GetNetworkCredential().Username -Password $cred1.GetNetworkCredential().Password
	$vm1 | Set-AzureSubnet -SubnetNames BackEnd
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 1000 -DiskLabel SQLFiles –LUN 0 -HostCaching None
	New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName AZFAE-USE-VN01

## Дополнительные ресурсы

[Ограничения и квоты, касающиеся подписок и служб Microsoft Azure](azure-subscription-service-limits.md#storage-limits)

[Размеры виртуальных машин и облачных служб для Azure](https://msdn.microsoft.com/library/azure/dn197896.aspx)

[Целевые показатели масштабируемости и производительности хранилища Azure](storage/storage-scalability-targets.md)

<!--HONumber=54-->