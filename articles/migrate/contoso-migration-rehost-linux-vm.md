---
title: Миграция путем повторного размещения локального приложения Linux на виртуальных машинах Azure | Документация Майкрософт
description: Из этой статьи вы узнаете, как компания Contoso повторно размещает локальное приложение Linux путем миграции на виртуальные машины Azure.
services: site-recovery
author: rayne-wiselman
manager: ''
ms.service: site-recovery
ms.topic: conceptual
ms.date: 06/11/2018
ms.author: raynew
ms.openlocfilehash: 85c377c0fbca32a33cc68c9a1bedfa00ce0a366a
ms.sourcegitcommit: 6f6d073930203ec977f5c283358a19a2f39872af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "35300380"
---
# <a name="contoso-migration-rehost-an-on-premises-linux-app-to-azure-vms"></a>Перенос приложения компании Contoso: повторное размещение локального приложения Linux на виртуальных машинах Azure

В этой статье показано, каким образом Contoso повторно размещает локальное приложение службы поддержки на основе Linux (**osTicket**) на виртуальных машинах IaaS Azure.

Это седьмой документ в цикле статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. Этот цикл содержит общие сведения и ряд сценариев, которые иллюстрируют настройку инфраструктуры миграции и выполнение миграций различных типов. Сценарии излагаются в порядке усложнения. Со временем мы добавим в этот цикл и другие статьи.

**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | В этой статье содержатся общие сведения о стратегии миграции компании Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Здесь демонстрируется, как компания Contoso подготавливает свою локальную инфраструктуру и инфраструктуру Azure к миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
[Статья 3. Оценка локальных ресурсов](contoso-migration-assessment.md)  | Здесь демонстрируется, как в компании Contoso выполняется оценка локального двухуровневого приложения SmartHotel в VMware. Для оценки виртуальных машин приложения в компании Contoso используют службу [Миграция Azure](migrate-overview.md), а Базу данных SQL Server приложения оценивают с помощью [Помощника по миграции баз данных Azure](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
[Статья 4. Повторное размещение на виртуальных машинах Azure и в управляемом экземпляре SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Здесь демонстрируется, как компания Contoso переносит приложения SmartHotel в Azure. Специалисты компании переносят интерфейсную виртуальную машину приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Базу данных приложения они переносят в Управляемый экземпляр SQL с помощью службы [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Повторное размещение на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | Здесь демонстрируется, как Contoso переносит свои виртуальные машины приложения SmartHotel, используя только Site Recovery.
[Статья 6. Повторное размещение на виртуальных машинах Azure и в группах доступности SQL Server](contoso-migration-rehost-vm-sql-ag.md) | Здесь демонстрируется, как компания Contoso переносит приложение SmartHotel. Для переноса виртуальных машин приложения они используют Site Recovery, а для переноса базы данных приложения в группу доступности SQL Server — службу Database Migration Service. | Доступна
Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure (эта статья) | Здесь демонстрируется, как Contoso переносит свое приложение osService для Linux, используя Azure Site Recovery.
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и сервере MySQL в Azure](contoso-migration-rehost-linux-vm-mysql.md) | Здесь демонстрируется, как Contoso переносит приложение osService для Linux, используя Site Recovery для миграции на виртуальные машины и MySQL Workbench для миграции в экземпляр Azure MySQL Server. | Доступна

Из этой статьи вы узнаете, как Contoso переносит двухуровневое приложение **osTicket**, работающее на платформе Linux Apache MySQL PHP (LAMP), в Azure. Виртуальные машины приложения будут перенесены с помощью службы Azure Site Recovery. Если вы хотите использовать это приложение с открытым кодом, вы можете загрузить его с [GitHub](https://github.com/osTicket/osTicket).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** По мере развития Contoso растет и нагрузка на локальные системы и инфраструктуры.
- **Минимизация рисков.** Приложение службы поддержки критически важно для деятельности Contoso. Компания хочет переместить его в Azure без каких-либо рисков.
- **Расширение.** В компании не намерены изменять приложение прямо сейчас. Нужно, чтобы приложение просто стабильно работало.


## <a name="migration-goals"></a>Цели миграции

Для определения наилучшего способа миграции команда Contoso по работе в облаке определила цели миграции.

- После миграции приложение Azure должно иметь те же возможности с точки зрения производительности, что и в текущей локальной среде VMWare.  В облаке приложение будет играть такую же критически важную роль, как и в локальной среде. 
- В компании Contoso не хотят дополнительно инвестировать в это приложение.  Оно важно для бизнеса, но компании просто нужно безопасно переместить его в облако в его текущей форме.
- В компании Contoso не намерены изменять модель взаимодействия с этим приложением. Взаимодействие с ним в облаке должно осуществляться так же, как и сейчас.
- В компании Contoso не намерены изменять функции приложения. Нужно изменить только его расположение.
- После выполнения ряда переносов приложения Windows специалисты Contoso хотят освоить использование инфраструктуры на базе Linux в Azure.

## <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- У приложения есть два уровня, которые размещаются на двух виртуальных машинах (OSTICKETWEB и OSTICKETMYSQL).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет ПО vCenter Server 6.5 (**vcenter.contoso.com**), которое работает на виртуальной машине.
- Contoso использует локальный центр обработки данных (**contoso-datacenter**) с локальным контроллером домена (**contosodc1**).
- Так как приложение является рабочей нагрузкой в рабочей среде, виртуальные машины в Azure будут располагаться в рабочей группе ресурсов **ContosoRG**.
- Виртуальные машины будут перенесены в основной регион (восточная часть США 2) и помещены в рабочую сеть (VNET-PROD-EUS2).
    - Виртуальная машина веб-уровня будет находиться во внешней подсети (PROD-FE-EUS2).
    - Виртуальная машина базы данных будет находиться в подсети баз данных (PROD-DB-EUS2).
- По завершении миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](./media/contoso-migration-rehost-linux-vm/architecture.png) 

## <a name="migration-process"></a>Процесс миграции

Contoso будет осуществлять миграцию следующим образом:

1. Для начала Contoso настроит Azure и локальную инфраструктуру, необходимые для развертывания Site Recovery.
2. После подготовки Azure и локальных компонентов сотрудники компании настроят и включат репликацию для виртуальных машин.
3. Когда начнется репликация, они перенесут виртуальные машины путем отработки отказа в Azure.

![Процесс миграции](./media/contoso-migration-rehost-linux-vm/migration-process.png)

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | Служба организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов.  | Во время репликации в Azure взимается плата за службу хранилища Azure.  При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery/).

 
## <a name="prerequisites"></a>предварительным требованиям

Ниже показано, что вам (и компании Contoso) необходимо для выполнения этого сценария.

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | У вас должна быть подписка (процедура создания описана в предыдущих статьях этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](../site-recovery/site-recovery-role-based-linked-access-control.md). 
**Инфраструктура Azure** | Contoso настраивает свою инфраструктуру Azure, как описано в статье [Contoso - Deploy a migration infrastructure](contoso-migration-infrastructure.md) (Развертывание инфраструктуры Azure для миграции в Contoso).<br/><br/> Просмотрите дополнительные сведения о конкретных требованиях к [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилищу](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) для Site Recovery.
**Локальные серверы** | Потребуется локальный сервер vCenter версии 5.5, 6.0 или 6.5.<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.
**Локальные виртуальные машины** | [Ознакомьтесь со сведениями о машинах Linux](https://docs.microsoft.com//azure/site-recovery/vmware-physical-azure-support-matrix#replicated-machines), которые поддерживаются для миграции с помощью Site Recovery.<br/><br/> Сверьтесь со списком поддерживаемых [систем хранения и файловых систем Linux](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#linux-file-systemsguest-storage).<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).


## <a name="scenario-steps"></a>Шаги выполнения сценария

Миграция в Azure будет осуществляться следующим образом:

> [!div class="checklist"]
> * **Шаг 1. Подготовка Azure для Site Recovery.** Создается учетная запись хранения Azure для хранения реплицируемых данных и хранилище служб восстановления.
> * **Шаг 2. Подготовка локальных ресурсов VMware для Site Recovery.** Специалисты компании Contoso подготавливают учетные записи для обнаружения виртуальных машин и установки агента, а также ведут подготовку к подключению к виртуальным машинам Azure после отработки отказа.
> * **Шаг 3. Репликация виртуальных машин.** Выполняется настройка исходной и целевой среды миграции, создается политика репликации и запускается репликация виртуальных машин в хранилище Azure.
> * **Шаг 4. Миграция виртуальных машин с использованием Site Recovery.** Специалисты компании Contoso выполняют тестовую отработку отказа для проверки работы всех компонентов, а затем выполняют полную отработку отказа для миграции виртуальных машин в Azure.


## <a name="step-1-prepare-azure-for-the-site-recovery-service"></a>Шаг 1. Подготовка Azure для службы Site Recovery

Contoso требуется несколько компонентов Azure для Site Recovery:

- виртуальная сеть, в которой расположены ресурсы для отработки отказа (Contoso будет использовать уже развернутую виртуальную сеть для рабочей среды);
- новая учетная запись хранения Azure для размещения реплицируемых данных; 
- хранилище служб восстановления в Azure.

Компания Contoso уже создала виртуальную сеть во время [развертывания инфраструктуры Azure](contoso-migration-infrastructure.md), поэтому ей достаточно создать учетную запись хранения и хранилище.

1. Contoso создает учетную запись хранения Azure (contosovmsacc20180528) в регионе "Восточная часть США 2".

    - Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.
    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.

    ![Хранилище Site Recovery](./media/contoso-migration-rehost-linux-vm/asr-storage.png)

2. Теперь у компании Contoso есть сеть и учетная запись хранения, поэтому ее специалисты могут приступать к созданию хранилища (ContosoMigrationVault) и поместить его в группу ресурсов **ContosoFailoverRG** в основном регионе "Восточная часть США 2".

    ![Хранилище служб восстановления](./media/contoso-migration-rehost-linux-vm/asr-vault.png)


**Требуется дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) о настройке Azure для Site Recovery.


## <a name="step-2-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 2. Подготовка локальных ресурсов VMware для Site Recovery

Contoso подготавливает локальную инфраструктуру VMware следующим образом:

- Создается учетная запись на сервере vCenter или узле vSphere ESXi, чтобы автоматизировать виртуальную машину.
- Создается учетная запись для автоматической установки службы Mobility Service на каждой виртуальной машине VMware, которую требуется реплицировать.
- Подготавливаются виртуальные машины в локальной среде, чтобы подключать их к виртуальным машинам Azure, когда они будут созданы после миграции.


### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

В компании Contoso настраивают учетную запись следующим образом.

1. Создается роль на уровне vCenter.
2. Затем этой роли присваиваются необходимые разрешения.



### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

На виртуальных машинах Linux, которые переносит Contoso, должна быть установлена служба Mobility Service:

- Site Recovery может автоматически принудительно устанавливать этот компонент при включении репликации для виртуальных машин.
- Для автоматической принудительной установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальным машинам.
- Учетные данные вводятся при настройке репликации. 
- Учетная запись может относиться к домену или быть локальной; она должна предоставлять разрешения на установку программного обеспечения на виртуальных машинах.


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Contoso необходимо, чтобы после отработки отказа в Azure была возможность подключения к реплицированным виртуальным машинам в Azure. Для этого необходимо предпринять ряд действий.

- Чтобы получить доступ к Интернету, следует включить SSH на локальных виртуальных машинах Linux перед миграцией.  Для Ubuntu эту процедуру можно выполнить с помощью следующей команды: **Sudo apt-get ssh install -y**.
- После выполнения миграции (отработки отказа) следует проверить данные **диагностики загрузки**, чтобы увидеть снимок виртуальной машины.
- Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).


**Требуется дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) создать и назначить роль для автоматического обнаружения.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) создать учетную запись для принудительной установки службы Mobility Service.


## <a name="step-3-replicate-the-on-premises-vms"></a>Шаг 3. Репликация локальных виртуальных машин

Прежде чем переносить виртуальную машину веб-уровня в Azure, специалисты Contoso должны настроить и включить репликацию.

### <a name="set-a-protection-goal"></a>Определение целевого объекта защиты

1. Целевой объект защиты задается в хранилище в разделе с его именем (ContosoVMVault) (**Приступая к работе** > **Site Recovery** > **Подготовка инфраструктуры**).
2. Специалисты Contoso указывают, что компьютеры размещены локально и являются виртуальными машинами VMware, а их следует реплицировать в Azure.
    ![Цель репликации](./media/contoso-migration-rehost-linux-vm/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Для продолжения они должны подтвердить, что планирование развертывания завершено, выбрав **Yes, I have done it** (Да, выполнено). В этом сценарии Contoso переносит только одну виртуальную машину, поэтому планирование развертывания не требуется.

### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Компании Contoso необходимо настроить свою исходную среду. Для этого специалисты скачивают шаблон OVF и с его помощью развертывают сервер конфигурации Site Recovery в качестве локальной виртуальной машины VMware с высокой доступностью. После того как сервер конфигурации будет настроен и запущен, они зарегистрируют его в хранилище.

На сервере конфигурации работает ряд указанных ниже компонентов.

- Компонент сервера конфигурации, который координирует обмен данными между локальным источником и Azure, а также управляет репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.

Специалисты Contoso выполняют этот шаг следующим образом:

1. Загружают шаблон OVF из раздела **Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**.
    
    ![Скачивание OVF](./media/contoso-migration-rehost-linux-vm/add-cs.png)

2. Импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Шаблон OVF](./media/contoso-migration-rehost-linux-vm/vcenter-wizard.png)

3. При первом включении виртуальной машины она загружается в среду установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. По завершении установки они входят в систему на виртуальной машине в качестве администратора. При первом входе в систему по умолчанию запускается средство настройки Azure Site Recovery.
5. В этом средстве они указывают имя, используемое для регистрации сервера конфигурации в хранилище.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После создания подключения они входят систему в подписке Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.

    ![Регистрация сервера конфигурации](./media/contoso-migration-rehost-linux-vm/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. После этого специалисты выполняют повторный вход на компьютер, и мастер управления сервером конфигурации запускается автоматически.
9. В мастере необходимо выбрать сетевой адаптер для приема трафика репликации. Этот параметр нельзя изменить после настройки.
10. Далее специалисты выбирают подписку, группу ресурсов и хранилище для регистрации сервера конфигурации.

    ![Хранилище](./media/contoso-migration-rehost-linux-vm/cswiz1.png) 

11. Затем специалисты компании загружают и устанавливают MySQL Server и VMWare PowerCLI. 
12. После проверки они указывают полное доменное имя или IP-адрес сервера vCenter или узла vSphere. Они оставляют порт по умолчанию и указывают понятное имя для сервера vCenter.
13. Специалисты указывают учетную запись, которую они создали для автоматического обнаружения, и учетные данные, которые должны использоваться для автоматической установки Mobility Service.

    ![vCenter](./media/contoso-migration-rehost-linux-vm/cswiz2.png)

14. По окончании регистрации на портале Azure Contoso проверяет, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. На обнаружение может потребоваться 15 и более минут. 
15. Затем Site Recovery подключается к серверам VMware и обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь специалисты компании Contoso настраивают параметры репликации для целевой среды.

1. Они выбирают **Подготовка инфраструктуры** > **Цель** и задают параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения Azure и сети в указанной целевой среде.

### <a name="create-a-replication-policy"></a>Создание политики репликации

После настройки исходной и целевой сред в Contoso все готово для создания политики репликации.

1. В разделе **Подготовка инфраструктуры** > **Параметры репликации** > **Политика репликации** >  **Create and Associate** (Создать и связать) специалисты компании создают политику **ContosoMigrationPolicy**.
2. При этом они используют параметр по умолчанию.
    - **Пороговое значение RPO.** По умолчанию используется значение 60 минут. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Хранение точки восстановления.** По умолчанию используется значение 24 часа. Это значение определяет продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность создания моментальных снимков с согласованием приложений.** По умолчанию используется значение 1 час. Это значение указывает периодичность, с которой система создает моментальные снимки приложений.
 
        ![Создание политики репликации](./media/contoso-migration-rehost-linux-vm/replication-policy.png)

5. Политика автоматически сопоставляется с сервером конфигурации. 

    ![Связывание политики репликации](./media/contoso-migration-rehost-linux-vm/replication-policy2.png)

**Требуется дополнительная помощь?**

- Подробные пошаговые инструкции по этим трем этапам см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).
- Дополнительные сведения о гостевом агенте Azure для Linux см. [на этой странице](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).

**Требуется дополнительная помощь?**

- Подробные пошаговые инструкции по этим трем этапам см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).
- Дополнительные сведения о гостевом агенте Azure для Linux см. [на этой странице](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).



### <a name="enable-replication-for-osticketweb"></a>Включение репликации для OSTICKETWEB

Теперь сотрудники Contoso могут запустить репликацию виртуальной машины **OSTICKETWEB**.

1. В разделе **Репликация приложений** > **Источник** > **+Репликация** они настраивают параметры источника.
2. Они указывают, что хотят включить виртуальные машины, и выбирают параметры исходной среды, в том числе сервер vCenter и сервер конфигурации.

    ![Включение репликации](./media/contoso-migration-rehost-linux-vm/enable-replication-source.png)

3. Специалисты задают параметры цели, включая группу ресурсов и виртуальную сеть, в которой будет размещена виртуальная машина Azure, созданная после отработки отказа, а также учетную запись хранения, где будут храниться реплицированные данные.

     ![Включение репликации](./media/contoso-migration-rehost-linux-vm/enable-replication2.png)

3. Компания Contoso выбирает для репликации **OSTICKETWEB**. 

    - На этом этапе специалисты Contoso выбирают только **OSTICKETWEB**, так как необходимо выбрать виртуальную сеть и подсеть, а виртуальные машины не находятся в одной и той же подсети.
    - Если репликация для виртуальной машины включена, Site Recovery автоматически устанавливает службу Mobility Service.

    ![Включение репликации](./media/contoso-migration-rehost-linux-vm/enable-replication3.png)

4. В свойствах виртуальной машины специалисты Contoso выбирают учетную запись, которая используется сервером обработки для автоматической установки службы Mobility Service на компьютере.

     ![Служба Mobility Service](./media/contoso-migration-rehost-linux-vm/linux-mobility.png)

5. Они выбирают **Параметры репликации** > **Настройка параметров репликации**, проверяют правильность выбранной политики репликации и выбирают **Включить репликацию**.
6.  Ход репликации отслеживают в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.



### <a name="enable-replication-for-osticketmysql"></a>Включение репликации для OSTICKETMYSQL

Теперь сотрудники Contoso могут запустить репликацию **OSTICKETMYSQL**.

1. В разделе **Репликация приложений** > **Источник** > **+Репликация** они настраивают параметры источника и цели.
2. Специалисты Contoso выбирают для репликации **OSTICKETMYSQL** и указывают учетную запись, используемую для установки службы Mobility Service.

    ![Включение репликации](./media/contoso-migration-rehost-linux-vm/mysql-enable.png)

3. Они применяют ту же политику репликации, которая использовалась для OSTICKETWEB, и включают репликацию.  

**Требуется дополнительная помощь?**

Подробные пошаговые инструкции по этим трем этапам см. в статье о [включении репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).


## <a name="step-4-migrate-the-vms"></a>Шаг 4. Перенос виртуальных машин 

Специалисты компании Contoso выполняют быструю тестовую отработку отказа, а затем — перенос виртуальных машин.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Тестовая отработка отказа позволяет убедиться перед миграцией в том, что все работает правильно. 

1. Специалисты компании Contoso запускают тестовую отработку отказа для последней доступной точки во времени (**Последняя обработанная**).
2. Они выбирают пункт **Shut down machine before beginning failover** (Завершить работу машины перед началом отработки отказа), чтобы перед запуском отработки отказа в Site Recovery выполнялась попытка завершить работу исходной виртуальной машины. Отработка отказа продолжится, даже если их не удастся отключить. 
3. При тестировании отработки отказа происходит следующее: 
    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе этих данных создается точка восстановления;
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.
3. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает. 
4. После проверки они выполняют очистку отработки отказа, а также записывают и сохраняют все наблюдения.

### <a name="create-and-customize-a-recovery-plan"></a>Создание и настройка плана восстановления

 Убедившись, что тестовая отработка отказа выполнена правильно, специалисты компании Contoso создают план восстановления для миграции. 

- План восстановления определяет порядок отработки отказа и указывает, каким образом виртуальные машины будут перемещены в Azure.
- Так как перенести планируется двухуровневое приложение, специалисты компании настраивают план восстановления таким образом, чтобы виртуальная машина с данными (SQLVM) запускалась, прежде чем запустится интерфейсная виртуальная машина (WEBVM).


1. В разделе **Recovery Plans (Site Recovery) (Планы восстановления (Site Recovery))** > **+План восстановления** они создают план и добавляют в него виртуальные машины.

    ![План восстановления](./media/contoso-migration-rehost-linux-vm/recovery-plan.png)

2. После создания плана специалисты выбирают его для настройки **Планы восстановления** > **OsTicketMigrationPlan** > **Настроить**.
3.  Они удаляют **OSTICKETWEB** из раздела **Group 1: Start** (Группа 1: запуск).  Благодаря этому при первом действии запуска затрагивается только **OSTICKETMYSQL**.

    ![Группа восстановления](./media/contoso-migration-rehost-linux-vm/recovery-group1.png)

4.  В разделе **+Группа** > **Добавить защищенные элементы** специалисты добавляют **OSTICKETWEB** в раздел **Group 2: Start** (Группа 2: запуск).  Эти виртуальные машины требуются компании Contoso в двух разных группах.

    ![Группа восстановления](./media/contoso-migration-rehost-linux-vm/recovery-group2.png)


### <a name="migrate-the-vms"></a>Миграция виртуальных машин


Специалисты Contoso готовы к отработке отказа для плана восстановления, чтобы перенести виртуальные машины.

1. Они выбирают план, затем пункт **Отработка отказа**.
2.  Специалисты выполняют отработку отказа до последней точки восстановления и указывают, что, прежде чем запустить отработку отказа, Site Recovery должна попытаться завершить работу виртуальных машин. Они могут отслеживать ход отработки отказа на странице **Задания**.

    ![Отработка отказа](./media/contoso-migration-rehost-vm/failover1.png)

3. Во время отработки отказа vCenter Server выдает команды для остановки на двух виртуальных машинах, запущенных на узле ESXi.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm/vcenter-failover.png)

3. После отработки отказа специалисты Contoso проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm/failover2.png)  

3. После проверки виртуальной машины в Azure они завершают миграцию, чтобы закончить процесс переноса каждой виртуальной машины. В результате репликация виртуальных машин останавливается и плата за них в Site Recovery не начисляется.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm/failover3.png)


### <a name="connect-the-vm-to-the-database"></a>Подключение виртуальной машины к базе данных

На последнем этапе процесса миграции специалисты Contoso обновляют строку подключения приложения, чтобы она указывала на базу данных приложения, запущенную на виртуальной машине **OSTICKETMYSQL**. 

1. Специалисты компании устанавливают SSH-подключение к виртуальной машине **OSTICKETWEB** с помощью Putty или другого клиента SSH. Виртуальная машина частная, поэтому для подключения к ней используется частный IP-адрес.

    ![Подключение к базе данных](./media/contoso-migration-rehost-linux-vm/db-connect.png)  

    ![Подключение к базе данных](./media/contoso-migration-rehost-linux-vm/db-connect2.png)  

2. Специалистам необходимо убедиться, что виртуальная машина **OSTICKETWEB** может взаимодействовать с виртуальной машиной **OSTICKETMYSQL**. Сейчас в конфигурации жестко закодирован локальный IP-адрес 172.16.0.43.

    **Перед обновлением**
    
    ![Обновление IP-адреса](./media/contoso-migration-rehost-linux-vm/update-ip1.png)  

    **После обновления**
    
    ![Обновление IP-адреса](./media/contoso-migration-rehost-linux-vm/update-ip2.png) 
    
3. Специалисты компании перезапускают службу с помощью команды **systemctl restart apache2**.

    ![Перезагрузить](./media/contoso-migration-rehost-linux-vm/restart.png) 

4. Наконец, они обновляют записи DNS для **OSTICKETWEB** и **OSTICKETMYSQL** на одном из контроллеров домена Contoso.

    ![Обновление DNS](./media/contoso-migration-rehost-linux-vm-mysql/update-dns.png) 

    ![Обновление DNS](./media/contoso-migration-rehost-linux-vm-mysql/update-dns.png) 

**Требуется дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа. 
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

По завершении миграции уровни приложения osTicket работают на виртуальных машинах Azure.

Теперь специалистам Contoso потребуется выполнить несколько действий для очистки:  

- Удаление локальных виртуальных машин из перечня в vCenter.
- Удаление локальных виртуальных машин из локальных заданий резервного копирования.
- Обновление внутренней документации с указанием новых расположений и IP-адресов для OSTICKETWEB и OSTICKETMYSQL.
- Проверка всех ресурсов, взаимодействующих с виртуальными машинами, и обновление всех соответствующих параметров или документов согласно новой конфигурации.
- Специалисты Contoso использовали службу "Миграция Azure" с сопоставлением зависимостей для оценки пригодности виртуальных машин для миграции. Им следует удалить с виртуальной машины агенты Microsoft Monitoring Agent и Dependency Agent, установленные для этой цели.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда приложение работает, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности компании Contoso проверяют виртуальные машины OSTICKETWEB и OSTICKETMYSQL на наличие любых проблем с безопасностью.

- Чтобы можно было управлять доступом, они проверяют группы безопасности сети (NSG) для виртуальных машин. NSG позволяют пропускать только разрешенный для приложения трафик.
- Специалисты компании также анализируют возможность защиты данных на диске виртуальной машины с помощью шифрования дисков и Azure KeyVault.

[Узнайте больше](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control) о рекомендациях по обеспечению безопасности виртуальных машин.

### <a name="backups"></a>Резервные копии

Компания Contoso выполняет резервное копирование данных, содержащихся в виртуальных машинах, с помощью службы Azure Backup. [Узнайте больше](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания ресурсов Contoso назначает теги Azure в соответствии с определениями, заданными в ходе [развертывания инфраструктуры Azure](contoso-migration-infrastructure.md#set-up-tagging).
- У компании Contoso нет проблем с лицензированием серверов Ubuntu.
- Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков позволяет использовать Azure и другие облачные ресурсы, а также управлять ими.  Дополнительные сведения об управлении затратами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview). 


## <a name="next-steps"></a>Дополнительная информация

В этой статье мы продемонстрировали, как компания Contoso перенесла локальное приложение службы поддержки, распределенное по уровням на две виртуальные машины Linux, на виртуальные машины IaaS Azure с помощью Azure Site Recovery.

В следующей статье из серии мы покажем, как компания Contoso переносит то же приложение службы поддержки в Azure. На этот раз Contoso будет использовать Site Recovery для переноса внешней виртуальной машины приложения, а базу данных приложения перенесет с помощью средства резервного копирования и восстановления в службу "База данных Azure для MySQL" с помощью средства MySQL Workbench. [Перейти к статье](contoso-migration-rehost-linux-vm-mysql.md).
