---
title: Повторное создание локального приложения Contoso для использования в Azure | Документация Майкрософт
description: Узнайте, как Contoso перестраивает приложение для использования в Azure с помощью Службы приложений Azure, службы Kubernetes, CosmosDB, службы "Функции Azure" и Cognitive Services.
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 08/13/2018
ms.author: raynew
ms.openlocfilehash: 3d835a7bd93426e57c5ab204d277faca22ae0638
ms.sourcegitcommit: a2ae233e20e670e2f9e6b75e83253bd301f5067c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2018
ms.locfileid: "42144537"
---
# <a name="contoso-migration-rebuild-an-on-premises-app-to-azure"></a>Миграция в компании Contoso: повторное создание локального приложения для использования в Azure

В этой статье показано, как компания Contoso перемещает и перестраивает свое приложение SmartHotel для использования в Azure. Специалисты компании переносят виртуальную машину внешнего интерфейса приложения в веб-приложение Службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Веб-сайт взаимодействует со службой "Функции Azure", предоставляя функцию фотографирования животных. 

Это документ из цикла статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. В статьях этого цикла содержатся общие сведения и сценарии развертывания, в которых проиллюстрирована настройка инфраструктуры миграции, оценка пригодности локальных ресурсов для миграции и выполнение различных типов миграции. Сценарии описаны в порядке возрастания сложности. Со временем мы добавим в этот цикл и другие статьи.

**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Предоставляет общие сведения о стратегии миграции Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Здесь рассказывается о том, как Contoso готовит свою локальную инфраструктуру Azure для миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
[Статья 3. Доступ к локальным ресурсам](contoso-migration-assessment.md)  | В этой статье рассказывается, как компания Contoso выполняет оценку своего локального двухуровневого приложения SmartHotel в VMware. Для оценки виртуальных машин приложения компания Contoso использует службу [Миграция Azure](migrate-overview.md). Для оценки базы данных SQL Server приложения используется [помощник по миграции баз данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
[Статья 4. Повторное размещение приложения на виртуальных машинах Azure и в Управляемом экземпляре Базы данных SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Здесь демонстрируется, как Contoso выполняет процесс миграции приложения SmartHotel в Azure по методу lift-and-shift. Contoso переносит интерфейсную ВМ приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Базу данных приложения она переносит в управляемый экземпляр SQL с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Повторное размещение приложения на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | В этой статье рассказывается, как компания Contoso переносит виртуальные машины приложения SmartHotel, используя только Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группах доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Здесь показан выполняемый в Contoso процесс миграции приложения SmartHotel. Contoso использует Site Recovery для переноса ВМ приложений и службы миграции баз данных для миграции базы данных приложения в кластер SQL Server, защищенный группой доступности AlwaysOn. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Здесь показано, как компания Contoso осуществляет миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и MySQL Server в Azure](contoso-migration-rehost-linux-vm-mysql.md) | В этой статье рассказывается, как компания Contoso выполняет миграцию приложения Linux osTicket на виртуальные машины Azure с помощью Site Recovery и миграцию базы данных приложения в экземпляр Azure MySQL Server с помощью MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения в веб-приложениях Azure и базе данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | В статье демонстрируется, как Contoso переносит приложение SmartHotel в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Доступна
[Статья 10. Рефакторинг приложения Linux для веб-приложений Azure и MySQL для Azure](contoso-migration-refactor-linux-app-service-mysql.md) | В статье описывается, как Contoso переносит приложение osTicket для Linux в веб-приложения Azure на нескольких сайтах, интегрированных с GitHub для непрерывной поставки. База данных приложения переносится в экземпляр Azure MySQL. | Доступна
[Статья 11. Рефакторинг TFS в VSTS](contoso-migration-tfs-vsts.md) | В этой статье показано, как Contoso выполняет миграцию локального развертывания Team Foundation Server (TFS) путем его переноса в Visual Studio Team Services (VSTS) в Azure. | Доступна
[Статья 12. Повторное проектирование приложения для использования контейнеров Azure и Базы данных SQL](contoso-migration-rearchitect-container-sql.md) | В статье описывается, как Contoso переносит и повторно проектирует приложение SmartHotel в Azure. Специалисты компании перепроектируют веб-уровень приложения в контейнер Windows и переносят базу данных приложения в Базу данных SQL Azure. | Доступна
Статья 13. Повторное создание приложения в Azure | В статье описывается, как Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, "Функции Azure", Cognitive Services и Cosmos DB. | Эта статья.

В этой статье рассказывается, как Contoso выполняет миграцию двухуровневого приложения Windows. NET SmartHotel, работающего на виртуальных машинах VMware в Azure. Это приложение с открытым исходным кодом, и если вы хотите использовать его, загрузите его с [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** Компания Contoso растет. Специалисты компании хотят предоставлять своим клиентам разносторонние возможности на веб-сайтах.
- **Гибкость**. Компания Contoso должна реагировать быстрее изменений в marketplace, чтобы достичь успеха в глобальной экономике. 
- **Масштабирование**. По мере того как бизнес успешно растет, ИТ-отдел компании Contoso должен предоставлять системы, способные расти с тем же темпом.
- **Расходы**. Contoso хочет минимизировать стоимость лицензии.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила требования к приложению для этой миграции. Эти требования использовались для определения оптимального метода миграции:
 - Потребность использовать приложение в Azure всегда будет критически важной. Оно должно хорошо работать и легко масштабироваться.
 - Приложение должно использовать компоненты IaaS. Все должно быть создано для использования с PaaS или бессерверных служб.
 - Приложения должны запускаться в облачных службах, а контейнеры — находиться в частном реестре контейнеров всего предприятия в облаке.
 - Служба API, используемая для фотографирования домашних животных, должна быть точной и надежной в реальной среде, так как решения, принимаемые приложением, должны соблюдать работники отелей. Любой одобренный питомец может остаться в гостинице.

## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, Contoso начинает разработку и анализ решения развертывания и идентифицирует процесс миграции, включая службы Azure, которые будут использоваться при этой миграции.

### <a name="current-app"></a>Текущее приложение

- Локальное приложение SmartHotel разбито на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.


### <a name="proposed-architecture"></a>Предлагаемая архитектура

- Внешний интерфейс приложения будет развернут в качестве веб-приложения Службы приложений Azure в основном регионе.
- Служба "Функции Azure" обеспечит передачу фотографий домашних животных, и веб-сайт будет взаимодействовать с этой функцией.
- Функция фотографирования домашних животных использует API компьютерного зрения Cognitive Services и CosmosDB.
- Серверная часть сайта создается с использованием микрослужб. Они будут развернуты в контейнерах, управляемых Службой Azure Kubernetes (AKS).
- Контейнеры будут созданы с помощью VSTS и помещены в Реестр контейнеров Azure (ACR).
- Сейчас Contoso вручную развернет веб-приложение и код функции с помощью Visual Studio.
- Микрослужбы развертываются с помощью сценария PowerShell, который вызывает программы командной строки Kubernetes.

    ![Архитектура сценария](./media/contoso-migration-rebuild/architecture.png) 

  
### <a name="solution-review"></a>Проверка решения
Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

**Рассмотрение** | **Дополнительные сведения**
--- | ---
**Преимущества** | Использование PaaS и бессерверных решений для полного развертывания значительно сокращает время управления со стороны Contoso.<br/><br/> Переход на архитектуру микрослужб позволяет Contoso легко расширять свое решение со временем.<br/><br/> Новая функциональность может быть подключена к Интернету, не нарушая ни одной из имеющихся баз кода решений.<br/><br/> Веб-приложение будет настроено с несколькими экземплярами, гарантируя отсутствие единой точки отказа.<br/><br/> Чтобы приложение могло обработать разные объемы трафика, включается автоматическое масштабирование.<br/><br/> В связи с переходом к службам PaaS компания Contoso может снять с учета устаревшие решения под управлением операционной системы Windows Server 2008 R2.<br/><br/> CosmosDB имеет встроенную отказоустойчивость, которой не требуется конфигурация Contoso. Это означает, что уровень данных больше не является единой точкой отказа.
**Недостатки** | По сравнению с другими вариантами миграции контейнеры более сложные. Для Contoso длительное изучение может стать проблемой.  Новый уровень сложности контейнеров представляет большую ценность, несмотря на длительное время, которое требуется на их изучение.<br/><br/> Рабочей группе в Contoso необходимо будет заполнить пробелы в знаниях, чтобы разобраться с Azure, контейнерами и микрослужбами приложения и обеспечить их обслуживание.<br/><br/> Компания Contoso не полностью реализовала DevOps для всего решения. Специалистам компании нужно подумать об этом при развертывании служб в AKS, Функциях и Службе приложений.



### <a name="migration-process"></a>Процесс миграции

1. Contoso подготавливает к работе ACR, AKS и CosmosDB.
2. Специалисты компании подготавливают инфраструктуру для развертывания, включая веб-приложение Azure, учетную запись хранения, функцию и API. 
3. Когда инфраструктура будет готова, специалисты компании создадут образы контейнеров микрослужб, используя службу VSTS, которая отправляет их к ACR.
4. Contoso развернет большинство этих микрослужб в ASK с помощью сценария PowerShell.
5. Наконец, специалисты компании развернут функцию Azure и веб-приложение.

    ![Процесс миграции](./media/contoso-migration-rebuild/migration-process.png) 

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[AKS](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | Упрощает развертывание, администрирование и использование Kubernetes. Предоставляет полностью управляемую службу оркестрации контейнеров Kubernetes.  | AKS — это бесплатная служба.  Вы платите только за виртуальные машины, связанное хранилище и потребляемые сетевые ресурсы. [Узнайте больше](https://azure.microsoft.com/pricing/details/kubernetes-service/).
[Функции Azure](https://azure.microsoft.com/services/functions/) | Ускорьте процесс разработки с помощью управляемых событиями и независимыми от сервера вычислительных средств. Выполняйте масштабирование по необходимости.  | Платите только за использованные ресурсы. Плата по плану начисляется в зависимости от потребления ресурсов и числа выполнений в секунду. [Узнайте больше](https://azure.microsoft.com/pricing/details/functions/).
[Реестр контейнеров Azure](https://azure.microsoft.com/services/container-registry/) | Хранит образы для всех типов развертываний контейнеров. | Стоимость зависит от функций, типа хранилища и длительности использования. [Узнайте больше](https://azure.microsoft.com/pricing/details/container-registry/).
[службе приложений Azure](https://azure.microsoft.com/services/app-service/containers/) | Оперативно создавайте, развертывайте и масштабируйте веб-приложения, мобильные приложения и приложения API на любой платформе. | Плата за план службы приложений начисляется посекундно. [Узнайте больше](https://azure.microsoft.com/pricing/details/app-service/windows/).

## <a name="prerequisites"></a>Предварительные требования

Ниже показано, что вам (и компании Contoso) необходимо сделать, чтобы выполнить этот сценарий:

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | Вы должны были создать подписку, когда выполняли внутреннюю оценку в первой статье этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.
**Инфраструктура Azure** | [Узнайте, как](contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.
**Предварительные требования для разработчика** | Contoso необходимы следующие средства на рабочей станции разработчика:<br/><br/> - [выпуск Visual Studio Community 2017 15.5](https://www.visualstudio.com/);<br/><br/> включенная рабочая нагрузка .NET;<br/><br/> [Git](https://git-scm.com/)<br/><br/> [Azure PowerShell](https://azure.microsoft.com/downloads/)<br/><br/> [интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest)<br/><br/> [Docker CE (Windows 10) или Docker EE (Windows Server)](https://docs.docker.com/docker-for-windows/install/), настроенные на использование контейнеров Windows.



## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
> * **Шаг 1. Подготовка AKS и ACR**. Contoso подготавливает управляемый кластер AKS и Реестр контейнеров Azure с помощью PowerShell.
> * **Шаг 2. Создание контейнеров Docker**. Специалисты компании настраивают CI для контейнеров Docker с помощью VSTS и отправляют их в ACR.
> * **Шаг 3. Развертывание внутренних микрослужб**. Специалисты компании развертывают остальную часть инфраструктуры, которая будет использоваться серверными микрослужбами.
> * **Шаг 4. Развертывание интерфейсной инфраструктуры**. Специалисты компании развертывают интерфейсную инфраструктуру, включая хранилище BLOB-объектов для телефонов хозяев животных, базу данных Cosmos и API компьютерного зрения.
> * **Шаг 5. Перенос серверной части**. Специалисты компании развертывают микрослужбы и запускают их в AKS для переноса серверной части.
> * **Шаг 6. Публикация внешнего интерфейса**. Специалисты компании публикуют приложение SmartHotel в Службе приложений Azure и приложении-функции, которое будет вызываться службой домашних животных.



## <a name="step-1-provision-an-aks-cluster-and-acr"></a>Шаг 1. Подготовка кластера AKS и ACR

Contoso запускает сценарий развертывания для создания управляемого кластера Kubernetes с использованием AKS и Реестра контейнеров Azure.

- В инструкциях в этом разделе используется репозиторий **SmartHotel360-Azure-Backend**.
- Репозиторий GitHub **SmartHotel360-Azure-backend** содержит все программное обеспечение для этой части развертывания.

Специалисты компании выполняют подготовку к работе следующим образом:

1. Перед запуском компания Contoso проверяет, что все необходимое программное обеспечение установлено на компьютере, используемом для разработки. 
2. С помощью Git специалисты компании клонируют репозиторий локально на компьютер разработки.

    **git clone https://github.com/Microsoft/SmartHotel360-Azure-backend.git**

3.  Contoso открывает папку с помощью Visual Studio Code и перемещается в каталог **/deploy/k8s**, который содержит сценарий **gen-aks-env.ps1**.
4. Специалисты компании выполняют сценарий развертывания для создания управляемого кластера Kubernetes с помощью AKS и Реестра контейнеров.

    ![AKS](./media/contoso-migration-rebuild/aks1.png)
 
5.  В открытом файле специалисты компании устанавливают для параметра $location значение **eastus2** и сохраняют изменения.

    ![AKS](./media/contoso-migration-rebuild/aks2.png)

6. Чтобы открыть интегрированный терминал в Code, щелкните **Вид** > **Интегрированный терминал**.

    ![AKS](./media/contoso-migration-rebuild/aks3.png)

7. В интегрированном терминале PowerShell необходимо войти в Azure с помощью команды Connect-AzureRmAccount. Дополнительные сведения о начале работы с PowerShell см. в [этой статье](https://docs.microsoft.com/powershell/azure/get-started-azureps).

    ![AKS](./media/contoso-migration-rebuild/aks4.png)

8. Проверка подлинности Azure CLI выполняется с помощью команды **az login**. После ее запуска нужно следовать инструкциям для проверки подлинности с помощью веб-браузера. Дополнительные сведения о входе с помощью Azure CLI см. в [этой статье](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

    ![AKS](./media/contoso-migration-rebuild/aks5.png)

9. Специалисты компании запускают следующую команду, передавая имя группы ресурсов ContosoRG, имя кластера AKS smarthotel-aks-eus2 и новое имя реестра.

    ```
    .\gen-aks-env.ps1  -resourceGroupName ContosoRg -orchestratorName smarthotelakseus2 -registryName smarthotelacreus2
    ```

    ![AKS](./media/contoso-migration-rebuild/aks6.png)

10. Azure создает другую группу ресурсов, содержащую ресурсы для кластера AKS.

    ![AKS](./media/contoso-migration-rebuild/aks7.png)

11. После завершения развертывания Contoso установит программу командной строки **kubectl**. Средство уже установлено на Azure CloudShell.

    **az aks install-cli**

12. Специалисты компании проверяют соединение с кластером, выполнив команду **kubectl get nodes**. Узел имеет то же имя, что и виртуальная машина в автоматически созданной группе ресурсов.

    ![AKS](./media/contoso-migration-rebuild/aks8.png)

13. Специалисты компании выполняют следующую команду для запуска панели мониторинга Kubernetes: 

    **az aks browse --resource-group ContosoRG --name smarthotelakseus2**

14. На вкладке браузера откроется панель мониторинга. Это туннельное подключение, использующее Azure CLI. 

    ![AKS](./media/contoso-migration-rebuild/aks9.png)




## <a name="step-2-build-a-docker-container"></a>Шаг 2. Создание контейнера Docker

### <a name="create-a-vsts-and-build"></a>Создание VSTS и сборки

Contoso создает проект VSTS, настраивает сборку непрерывной интеграции, чтобы создать контейнер, а затем отправляет его в ACR. В инструкциях в этом разделе используется репозиторий [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).

1. На visualstudio.com специалисты компании создают новую учетную запись (**contosodevops360.visualstudio.com**) и настраивают ее для использования Git.

2. Специалисты компании создают новый проект (**smarthotelrefactor**), используя Git для системы управления версиями и Agile для рабочего процесса.

    ![VSTS](./media/contoso-migration-rebuild/vsts1.png) 


3. Специалисты компании импортируют репозиторий GitHub.

    ![VSTS](./media/contoso-migration-rebuild/vsts2.png)
    
4. В разделе **сборки и выпуска** специалисты компании создают новое определение с использованием VSTS Git в качестве источника из импортированного репозитория **smarthotel**. 

    ![VSTS](./media/contoso-migration-rebuild/vsts3.png)

6. Специалисты компании решили начать с пустого конвейера.

    ![VSTS](./media/contoso-migration-rebuild/vsts4.png)  

7. Они выбирают **Hosted Linux Preview** (Размещенная предварительная версия Linux) для определения сборки.

    ![VSTS](./media/contoso-migration-rebuild/vsts5.png) 
 
8. На **этапе 1** добавляется задача **Docker Compose**. Эта задача создает Docker Compose.

    ![VSTS](./media/contoso-migration-rebuild/vsts6.png) 

9. Специалисты компании повторяют и добавляют еще одну задачу **Docker Compose**. Она отправляет контейнеры в ACR.

     ![VSTS](./media/contoso-migration-rebuild/vsts7.png) 

8. Специалисты компании выбирают первую задачу (для создания) и настраивают для нее подписку Azure, авторизацию и ACR. 

    ![VSTS](./media/contoso-migration-rebuild/vsts8.png)

9. Они указывают путь к файлу **docket-compose.yaml** в папке **src** репозитория. Специалисты компании выбирают создание образов служб и включают последний тег. Когда действие меняется на **Build service images** (Создание образов служб), имя задачи VSTS меняется на **Build services automatically** (Создание служб автоматически).

    ![VSTS](./media/contoso-migration-rebuild/vsts9.png)

10. Теперь Contoso настраивает вторую задачу Docker (для отправки). Специалисты компании выбирают подписку и ACR **smarthotelacreus2**. 

    ![VSTS](./media/contoso-migration-rebuild/vsts10.png)

11. Опять же, специалисты компании вводят файл в файл docker-compose.yaml, выбирают **Push service images** (Отправка образов службы) и включают последний тег. Когда действие меняется на **Push service images** (Отправка образов служб), имя задачи VSTS меняется на **Push services automatically** (Отправка служб автоматически).

    ![VSTS](./media/contoso-migration-rebuild/vsts11.png)

12. Настроив задачи VSTS, Contoso сохраняет определение сборки и запускает процесс сборки.

    ![VSTS](./media/contoso-migration-rebuild/vsts12.png)

13. Они отслеживают ход выполнения, перейдя к заданию создания.

    ![VSTS](./media/contoso-migration-rebuild/vsts13.png)

14. После завершения создания в ACR отображаются новые репозитории, которые должны быть заполнены данными контейнеров, используемых микрослужбами.

    ![VSTS](./media/contoso-migration-rebuild/vsts14.png)


## <a name="step-3-deploy-back-end-microservices"></a>Шаг 3. Развертывание серверных микрослужб

Создав кластер AKS и сборку образов Docker, теперь компания Contoso развертывает остальную инфраструктуру, которая будет использоваться серверными микрослужбами.

- В этом разделе используются инструкции из репозитория [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).
- В папке **/deploy/k8s/arm** есть один сценарий для создания всех элементов. 

Специалисты компании выполняют развертывание следующим образом:

1. Contoso использует файл deploy.cmd для развертывания ресурсов Azure в группе ресурсов ContosoRG и регионе EUS2, введя следующую команду:

    **.\deploy azuredeploy ContosoRG -c eastus2**

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend1.png)

2. Специалисты компании записывают строки подключения для каждой базы данных. Они понадобятся позже.

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend2.png)

## <a name="step-4-deploy-front-end-infrastructure"></a>Шаг 4. Развертывание инфраструктуры внешнего интерфейса

Contoso необходимо развернуть инфраструктуру, которая будет использоваться в интерфейсных приложениях. Специалисты компании создают контейнер хранилища BLOB-объектов для хранения изображений домашних животных, базу данных Cosmos для хранения документов с информацией о домашних животных и API компьютерного зрения для веб-сайтов. 

В этом разделе используются инструкции из репозитория [SmartHotel-public-web](https://github.com/Microsoft/SmartHotel360-public-web).

### <a name="create-storage-containers"></a>Создание контейнеров хранилища

1.  На портале Azure специалист Contoso открывает созданную учетную запись хранения и выбирает **Большие двоичные объекты**.
2.  Он создает новый контейнер (**Pets**) и задает для него уровень общего доступа. Пользователи отправляют фотографии своих домашних животных в этот контейнер.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob1.png)

3. Специалисты компании создают второй контейнер с именем **settings**. Здесь будет размещаться файл со всеми параметрами интерфейсного приложения.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

4. Специалисты компании получают сведения о доступе для учетной записи хранения в текстовом файле для дальнейшего использования.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

## <a name="provision-a-cosmos-database"></a>Подготовка базы данных Cosmos

Contoso подготавливает базу данных Cosmos, которая будет использоваться для хранения информации о домашних животных.

1. Специалисты компании создают **Azure Cosmos DB** в Azure Marketplace.

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos1.png)

2. Они указывают имя (**contosomarthotel**), выберите API SQL и помещают базу данных в рабочей группе ресурсов ContosoRG в основном регионе "Восточная часть США 2".

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos2.png)

3. Специалисты компании добавляют новую коллекцию в базу данных с емкостью и пропускной способностью по умолчанию.

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos3.png)


4. Они сохраняют информацию о подключении к базе данных для дальнейшего использования. 

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos4.png)


## <a name="provision-computer-vision"></a>Подготовка API компьютерного зрения

Contoso подготавливает API компьютерного зрения. API будет вызываться с помощью функции для оценки изображений, отправленных пользователями.

1. Специалисты компании Contoso создают экземпляр **API компьютерного зрения** в Azure Marketplace.

     ![API компьютерного зрения](./media/contoso-migration-rebuild/vision1.png)

2. Они подготавливают API (**smarthotelpets**) в рабочей группе ресурсов ContosoRG, которая находится в основном регионе "Восточная часть США 2".

    ![API компьютерного зрения](./media/contoso-migration-rebuild/vision2.png)

3. Специалисты компании сохраняют параметры подключения API в текстовый файл для последующего использования.

     ![API компьютерного зрения](./media/contoso-migration-rebuild/vision3.png)

## <a name="step-5-deploy-the-back-end-services-in-azure"></a>Шаг 5. Развертывание серверных служб в Azure

Теперь Contoso необходимо развернуть контроллер входящего трафика NGINX, чтобы разрешить входящий трафик к службам, а затем развернуть микрослужбы в кластере AKS.

В инструкциях в этом разделе используется репозиторий [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).



1. Специалисты компании используют Visual Studio Code для обновления файла **/deploy/k8s/config_loal.yml**. Они обновляют различные подключения к базам данных, используя записанную ранее информацию.

     ![Развертывание микрослужб](./media/contoso-migration-rebuild/deploy-micro.png)

    > [!NOTE]
    > Некоторые параметры конфигурации (например, Active Directory B2C) не рассматриваются в этой статье. Дополнительные сведения об этих параметрах содержатся в репозитории.

2. Файл deploy.ps1 удаляет все содержимое кластера (за исключением входящего трафика и контроллера входящего трафика) и развертывает микрослужбы. Специалисты компании выполняют такую команду:

  ```
  .\deploy.ps1 -configFile .\conf_local.yml -dockerUser smarthotelacreus2  -dockerPassword [passwordhere] -registry smarthotelacreus2.azurecr.io -imageTag latest -deployInfrastructure $false -buildImages $false -pushImages $false
  ```

3. Специалисты компании выполняют следующую команду для проверки состояния служб:

    ```
    kubectl get services
    ```
4. Они открывают панель мониторинга Kubernetes для проверки развертывания:

    ```
    az aks browse --resource-group ContosoRG --name smarthotelakseus2
    ```


## <a name="step-6-publish-the-frontend"></a>Шаг 6. Публикация внешнего интерфейса

На заключительном этапе специалисты компании Contoso публикуют приложение SmartHotel в Службе приложений Azure и в приложении-функции, которое будет вызываться службой домашних животных.

В инструкциях в этом разделе используется репозиторий [SmartHotel-public-web](https://github.com/Microsoft/SmartHotel360-public-web). .

### <a name="set-up-web-app-to-use-contoso-resources"></a>Настройка веб-приложения для использования ресурсов компании Contoso

1. Специалисты компании с помощью Git клонируют репозиторий локально на компьютер разработки:

    **git clone https://github.com/Microsoft/SmartHotel360-public-web.git**

2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.

    ![Публикация внешнего интерфейса](./media/contoso-migration-rebuild/front-publish1.png)

3. Специалисты компании вносят необходимые изменения в конфигурацию по умолчанию.

    - При запуске веб-приложение ищет параметр приложения **SettingsUrl**.
    - Данная переменная должна содержать URL-адрес файла конфигурации.
    - По умолчанию используется общедоступная конечная точка.

4. Специалисты компании обновляют файл **/config-sample.json/sample.json**. Это файл конфигурации веб-приложения при использовании общедоступной конечной точки.

    - Специалисты компании изменяют разделы **urls** и **pets_config**, указывая значения для конечных точек API AKS, учетных записей хранения и базы данных Cosmos. 
    - URL-адреса должны соответствовать DNS-имени нового веб-приложения, которое создает Contoso.
    - Для Contoso это **smarthotelcontoso.eastus2.cloudapp.azure.com**.

    ![Публикация внешнего интерфейса](./media/contoso-migration-rebuild/front-publish2.png)

5. После обновления файла специалисты компании переименуют его в **smarthotelsettingsurl** и отправят в хранилище BLOB-объектов, которые было создано ранее.

     ![Публикация внешнего интерфейса](./media/contoso-migration-rebuild/front-publish3.png)

6. Специалист компании щелкает файл, чтобы получить URL-адрес. Этот URL-адрес используется приложением, когда оно начинает извлекать файл конфигурации.

    ![Публикация внешнего интерфейса](./media/contoso-migration-rebuild/front-publish4.png)

7. Специалисты компании указывают URL-адреса нового файла для параметра **SettingsUrl** в файле **appsettings. Production.JSON**.

    ![Публикация внешнего интерфейса](./media/contoso-migration-rebuild/front-publish5.png)


### <a name="deploy-the-website-to-the-azure-app-service"></a>Развертывание веб-сайта в Службе приложений Azure

Теперь Contoso может опубликовать свой веб-сайт.


1. Специалисты компании включают мониторинг Application Insights в Visual Studio 2017. Чтобы сделать это, они выбирают в обозревателе решений проект **PublicWeb** и находят пункт **Добавление Application Insights**. Специалисты компании регистрируют приложения в экземпляре Application Insight, который был создан при развертывании инфраструктуры.

    ![Публикация веб-сайта](./media/contoso-migration-rebuild/deploy-website1.png)

2. В Visual Studio специалисты компании подключают проект PublicWeb к App Insights и обновляют его, чтобы показать, что он настроен.
 
    ![Публикация веб-сайта](./media/contoso-migration-rebuild/deploy-website2.png)

3. В Visual Studio они создают и публикуют свое веб-приложение.

    ![Публикация веб-сайта](./media/contoso-migration-rebuild/deploy-website3.png)

5. Специалисты компании указывают имя приложения и помещают его в рабочей группе ресурсов **ContosoRG** в основном регионе "Восточная часть США 2".

    ![Публикация веб-сайта](./media/contoso-migration-rebuild/deploy-website4.png)

### <a name="deploy-the-function-to-azure"></a>Развертывание функции для Azure

1. Специалисты компании используют Visual Studio для создания и публикации функции. Чтобы сделать это, специалист компании щелкает правой кнопкой мыши **PetCheckerFunction** > **Опубликовать**. Специалисты компании создают новую службу приложений.

     ![Развертывание функции](./media/contoso-migration-rebuild/function1.png)

2. Специалисты компании указывают имя **smarthotelpetchecker**, помещают его в группе ресурсов ContosoRG и указывают новый план службы приложений.

     ![Развертывание функции](./media/contoso-migration-rebuild/function2.png)

3. Специалисты компании выбирают учетную запись хранения и создают функцию.

    ![Развертывание функции](./media/contoso-migration-rebuild/function3.png)

4. Развертывание начинается с подготовки приложения-функции в Azure. В разделе **публикации** Contoso добавляет параметры приложения для хранилища, базы данных Cosmos и API компьютерного зрения.

    ![Развертывание функции](./media/contoso-migration-rebuild/function4.png)

5. Чтобы сначала запустить локальное выполнение функции, специалисты компании обновляют параметры в файле **PetCheckerFunction/local.settings.json**.

    ![Развертывание функции](./media/contoso-migration-rebuild/function5.png)

6. После развертывания функции она отображается на портале Azure с состоянием **Выполняется**.

    ![Развертывание функции](./media/contoso-migration-rebuild/function6.png)


7. Специалисты компании переходят к приложению по адресу [http://smarthotel360public.azurewebsites.net/Pets](http://smarthotel360public.azurewebsites.net/Pets), чтобы проверить, работает ли функция проверки домашних животных надлежащим образом.
8. Специалисты компании щелкают аватар, чтобы отправить изображение.

    ![Развертывание функции](./media/contoso-migration-rebuild/function7.png)

9. Сначала проверяется фотография небольшой собаки.

    ![Развертывание функции](./media/contoso-migration-rebuild/function8.png)

10. Приложение возвращает сообщение о принятии.

    ![Развертывание функции](./media/contoso-migration-rebuild/function9.png)




## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso должна гарантировать, что их новые базы данных безопасны. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- Приложение необходимо обновить для использования SSL с сертификатами. Экземпляр контейнера должен быть повторно развернут для ответа через порт 443.
- Необходимо рассмотреть возможность использования KeyVault для защиты секретов для приложений Service Fabric. [Узнайте больше](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-secret-management).

### <a name="backups-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

- Contoso следует рассмотреть требования резервного копирования для Базы данных SQL Azure. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Нужно рассмотреть реализацию групп отработки отказа SQL для обеспечения отказоустойчивости в регионе для базы данных. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview).
- Специалисты компании могут использовать георепликацию для номера SKU уровня "Премиум" ACR. [Подробнее](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication)

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков позволяет использовать Azure и другие облачные ресурсы, а также управлять ими.  Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview).

## <a name="conclusion"></a>Заключение

В этой статье специалисты компании Contoso повторно создали приложение SmartHotel в Azure. Они перенастроили интерфейсную виртуальную машину локального приложения для использования веб-приложений Службы приложений Azure. Специалисты компании создают серверную часть приложения с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Специалисты компании улучшили возможности приложения с помощью приложения для фотографирования домашних животных.




