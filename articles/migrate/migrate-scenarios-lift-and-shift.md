---
title: Перемещение локальных рабочих нагрузок в Azure с помощью Azure DMS и Site Recovery | Документация Майкрософт
description: Узнайте, как подготовить Azure для миграции локальных компьютеров с помощью Azure Database Migration Service и службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/21/2018
ms.author: raynew
ms.openlocfilehash: d6fc1af3c5a587ab62b86dcd4189165d96e6e3bc
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32182244"
---
# <a name="scenario-2-lift-and-shift-migration-to-azure"></a>Сценарий 2. Миграция в Azure по методике lift-аnd-shift

Компания Contoso рассматривает возможность миграции в Azure. Чтобы попробовать это, они хотят оценить готовность небольшого локального приложения для путешествий к миграции в Azure и перенести его. Это двухуровневое приложение для путешествий с веб-приложением на одной виртуальной машине и базой данных SQL Server на второй. Приложение развертывается в VMware, а управление средой осуществляется с помощью сервера vCenter Server. 

В [сценарии 1 оценки готовности к миграции в Azure](migrate-scenarios-assessment.md) они использовали Помощник по миграции данных (DMA) для оценки базы данных SQL Server приложения. Кроме того, они использовали службу "Миграция Azure" для оценки виртуальных машин, на которых выполняется приложение. Теперь в этом сценарии, после успешного завершения оценки, они хотят перенести базу данных в управляемый экземпляр SQL Azure, используя Azure Database Migration Service (DMS), и перенести локальные компьютеры на виртуальные машины Azure с помощью службы Azure Site Recovery.

Если вы хотите попробовать [сценарий 1](migrate-scenarios-assessment.md), скачайте это демонстрационное туристическое приложение из [GitHub](https://github.com/Microsoft/SmartHotel360).



**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Служба управления базами данных](https://docs.microsoft.com/azure/dms/dms-overview) | DMS обеспечивает прозрачную миграцию из нескольких источников баз данных на платформы данных Azure с минимальным временем простоя. | Служба в данный момент находится в общедоступной предварительной версии (апрель 2018 года) и может использоваться бесплатно на этом этапе.<br/><br/> Обратите внимание, что в общедоступной предварительной версии для DMS ограничено [число регионов](https://docs.microsoft.com/azure/dms/dms-overview).
[Управляемый экземпляр SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | Управляемый экземпляр — это служба управляемой базы данных, которая представляет полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | За использование управляемых экземпляров базы данных SQL Azure, выполняемых в Azure, взимается плата на основе емкости. [Узнайте больше](https://azure.microsoft.com/pricing/details/sql-database/managed/). 
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | Служба организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов.  | Во время репликации в Azure взимается плата за службу хранилища Azure.  При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery/).

В этом случае мы настроим VPN-подключение типа "сеть — сеть", чтобы DMS могла подключиться к локальной базе данных, создать управляемый экземпляр SQL Azure в Azure и перенести базу данных. Для Site Recovery мы подготовим локальную среду VMware и настроим репликацию, а затем выполним миграцию виртуальных машин в Azure.  


> [!IMPORTANT]
> Вы должны зарегистрироваться в ограниченной общедоступной предварительной версии управляемого экземпляра SQL. Чтобы [зарегистрироваться](https://portal.azure.com#create/Microsoft.SQLManagedInstance), необходима подписка Azure. Регистрация может занять несколько дней, поэтому ее необходимо выполнить перед началом работы с этим сценарием развертывания.

## <a name="architecture"></a>Архитектура

### <a name="site-recovery"></a>Site Recovery

![Site Recovery](media/migrate-scenarios-lift-and-shift/asr-architecture.png)  

### <a name="dms"></a>DMS
![DMS](media/migrate-scenarios-lift-and-shift/dms-architecture.png)  

В этом сценарии:

- Contoso — это фиктивное имя, представляющее типичную крупную компанию. Contoso хочет оценить и перенести свое локальное двухуровневое приложение.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- Внутреннее туристическое приложение расположено на нескольких виртуальных машинах (WEBVM и SQLVM) и находится на узле VMware ESXi (**contosohost1.contoso.com**).
- Средой VMware управляет сервер vCenter Server (**vcenter.contoso.com**), который запущен на виртуальной машине.

## <a name="prerequisites"></a>предварительным требованиям

Если вы хотите выполнить этот сценарий, у вас должно быть следующие компоненты.

Требования | Сведения
--- | ---
**Подписка Azure.** | Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](../site-recovery/site-recovery-role-based-linked-access-control.md). 
**Site Recovery (локальный экземпляр)** | Локальный сервер vCenter Server версии 5.5, 6.0 или 6.5.<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).<br/><br/> Поддерживаемая конфигурация [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилища](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage).
**DMS** | Для DMS необходимо [совместимое локальное VPN-устройство](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).<br/><br/> Необходимо настроить локальное VPN-устройство. Оно должно иметь внешний IPv4-адрес с внешним доступом. Адрес не может находиться за NAT-устройством.<br/><br/> Убедитесь, что у вас есть доступ к локальной базе данных SQL Server.<br/><br/> Брандмауэр Windows должен иметь доступ к ядру исходной СУБД. [Узнайте больше](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).<br/><br/> Если перед вашим компьютером базы данных есть брандмауэр, добавьте правила, разрешающие доступ к базе данных и файлам через SMB-порт 445.<br/><br/> Учетные данные, используемые для подключения к исходному серверу SQL Server и целевому Управляемому экземпляру, должны принадлежать к серверной роли sysadmin.<br/><br/> Вам нужна сетевая папка в вашей локальной базе данных, которую DMS может использовать для резервного копирования базы данных-источника.<br/><br/> Убедитесь, что учетная запись службы, от имени которой выполняется исходный экземпляр SQL Server, имеет права на запись для этой сетевой папки.<br/><br/> Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Служба Azure Database Migration Service олицетворяет пользователя с этими учетными данными, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure.<br/><br/> В процессе установки SQL Server Express для протокола TCP/IP устанавливается **отключенное состояние** по умолчанию. Убедитесь, что он включен.


# <a name="scenario-overview"></a>Обзор сценария

Вот что мы собираемся делать:

> [!div class="checklist"]
> * **Шаг 1. Настройка VPN-подключения типа "сеть — сеть"**. DMS подключается к локальной базе данных по VPN-подключению типа "сеть — сеть". Мы создадим виртуальную сеть для VPN-подключения, а затем повторно используем ее для Site Recovery. Созданная сеть должна быть размещена в регионе, где будет создано хранилище служб восстановления.
> * **Шаг 2. Настройка управляемого экземпляра SQL Azure**. Необходимо предварительно создать управляемый экземпляр, в который будет переноситься локальная база данных SQL Server.
> * **Шаг 3. Настройка универсального кода ресурса (URI) SAS для DMS**. URI подписанного URL-адреса (SAS) предоставляет делегированный доступ к ресурсам в учетной записи хранения, что позволяет предоставлять ограниченные разрешения на объекты хранения. Мы настроим URI SAS, чтобы DMS могла получить доступ к контейнеру учетной записи хранения, в который служба отправляет файлы архивации SQL Server.
> * **Шаг 4. Подготовка DMS**. Мы зарегистрируем поставщик службы миграции базы данных, создадим экземпляр, а затем создадим проект DMS.
> * **Шаг 5. Подготовка Azure для Site Recovery**. Мы создадим учетную запись хранения Azure для хранения реплицируемых данных.
> * **Шаг 6. Подготовка локальных ресурсов VMware для Site Recovery**. Мы подготовим учетные записи для обнаружения виртуальных машин и установки агента, а также подготовимся к подключению к виртуальным машинам Azure после отработки отказа. 
> * **Шаг 7. Репликация виртуальных машин.** Мы настроим исходную и целевую среды Site Recovery, установим политику репликации и запустим репликацию виртуальных машин в хранилище Azure.
> * **Шаг 8. Миграция базы данных с помощью DMS**. Мы выполним миграцию базы данных.
> * **Шаг 9. Миграция виртуальных машин с использованием Site Recovery**. Мы выполним отработку отказа для миграции виртуальных машин в Azure.


## <a name="step-1-set-up-site-to-site-vpn-connection"></a>Шаг 1. Настройка VPN-подключения типа "сеть — сеть"

Чтобы подготовить VPN-подключение типа "сеть — сеть", необходимо настроить виртуальную сеть и подсети, создать VPN-шлюз виртуальной сети и настроить шлюз локальной сети, чтобы среде Azure было известно, как подключиться к локальному VPN-устройству. Затем создайте и проверьте подключения типа "сеть — сеть".

### <a name="set-up-a-virtual-network"></a>Настройка виртуальной сети

Создайте виртуальную сеть Azure, чтобы предоставить DMS подключение типа "сеть — сеть" к локальному экземпляру SQL Server.


1. На [портале Azure](https://portal.azure.com) щелкните **Создать ресурс**. Выберите **Сети** > **Виртуальная сеть**.
2. В разделе **Виртуальная сеть** > **Выберите модель развертывания** выберите **Resource Manager** > **Создать**.
3. В колонке **Создание виртуальной сети** в поле **Имя** введите уникальное имя сети. В нашем сценарии это **ContosoVNET**.
4. В поле **Адресное пространство** добавьте диапазон IP-адресов. Диапазон не должен пересекаться с адресным пространством локальной среды.
5. Для параметра **Группа ресурсов** выберите создание новой группы или выберите существующую. В этом сценарии мы используем имя **ContosoRG**.
6. В поле **Расположение** выберите регион, в котором требуется создать виртуальную сеть. Мы используем регион **Восточная часть США 2**.
7. В разделе **Подсеть** добавьте имя первой подсети и диапазон ее адресов. Мы создали подсеть **Apps**.
8. Отключите конечные точки службы.

    ![Создать виртуальную сеть](media/migrate-scenarios-lift-and-shift/vnet-create-network.png)

9. Выберите **Закрепить на панели мониторинга**, чтобы в будущем можно было легко найти свою сеть, а затем щелкните **Создать**.
10. Создание виртуальной сети занимает несколько секунд. После завершения этого процесса ваша сеть отобразится на панели мониторинга портала Azure.
11. В вашей виртуальной сети необходимо разрешить такие коммуникационные порты: 443, 53, 9354, 445, 12000.


### <a name="set-up-subnets"></a>Настройка подсетей

У вас будет четыре подсети в одной сети Azure:

![Список подсетей](media/migrate-scenarios-lift-and-shift/vnet-subnet-list.png)

Вы настроили первую подсеть (Apps) при создании сети. Теперь создайте остальные подсети. Подсеть шлюза используется подключением VPN-шлюза, так как Azure отправляет трафик через VPN-подключение в вашу локальную среду.

1. В виртуальной сети в разделе **Параметры** выберите **Подсеть** > **+Подсеть**.
2. Настройте подсеть **Datamigration**, указав показанный диапазон адресов, а затем нажмите кнопку **ОК**.

    ![Подсеть данных](media/migrate-scenarios-lift-and-shift/vnet-subnet-data.png)  


3. В разделе **добавления подсети** настройте подсеть **Identity**, указав показанный диапазон адресов, а затем нажмите кнопку **ОК**.
    ![Подсеть Identity](media/migrate-scenarios-lift-and-shift/vnet-subnet-identity.png)

4. В разделе **Подсеть** щелкните **Подсеть шлюза**, а затем нажмите кнопку **ОК**.
    - Эта подсеть содержит IP-адреса, которые VPN-шлюз будет использовать при VPN-подключениях.
    - Имя этой подсети задается автоматически, чтобы Azure могла распознать его.
    - Измените автоматически заданный диапазон адресов с учетом своей локальной подсети. 

    ![Подсеть шлюза](media/migrate-scenarios-lift-and-shift/vnet-subnet-gateway.png)
    
### <a name="set-up-a-virtual-network-gateway"></a>Настройка шлюза виртуальной сети

1. На странице портала слева щелкните **+** и выполните поиск по запросу "Шлюз виртуальной сети". В списке **результатов** щелкните **Шлюз виртуальной сети**.
2. Щелкните **Создать** в нижней части страницы "Шлюз виртуальной сети".
3. В колонке **Создание шлюза виртуальной сети** в поле **Имя** укажите имя объекта шлюза.
4. В поле **Тип шлюза** выберите **VPN**.
5. В поле **Тип VPN** выберите **На основе маршрута**.
6. В поле **SKU** выберите номер SKU шлюза из раскрывающегося списка. Номера SKU, перечисленные в раскрывающемся списке, зависят от выбранного типа VPN. Не включайте режим "активный — активный". Дополнительные сведения о [номерах SKU](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku).
7. Выбрав **Виртуальная сеть** > **Выбор виртуальной сети**, добавьте созданную виртуальную сеть. В эту сеть будет добавлен шлюз.
8. В поле **Первая IP-конфигурация** укажите общедоступный IP-адрес.  VPN-шлюз должен иметь общедоступный IP-адрес. Этот адрес динамически назначается ресурсу при создании VPN-шлюза. В настоящее время поддерживаются только динамические адреса, однако IP-адреса не изменяются после присвоения.
    - Щелкните **Создать IP-конфигурацию шлюза**. В колонке **Выбрать общедоступный IP-адрес** щелкните **+Создать**.
    - В колонке **Создать общедоступный IP-адрес** укажите имя общедоступного IP-адреса (Contoso-Gateway). Оставьте номер SKU **Базовый** и нажмите кнопку **ОК**, чтобы сохранить изменения.
        
    ![Шлюз виртуальной сети](media/migrate-scenarios-lift-and-shift/vnet-create-vpn-gateway2.png) 

9. Щелкните **Создать**, чтобы начать создание VPN-шлюза. Параметры будут проверены, и на панели мониторинга появится плитка "Развертывание шлюза виртуальной сети".

    ![Проверка шлюза виртуальной сети](media/migrate-scenarios-lift-and-shift/vnet-vpn-gateway-validate.png)
    
Создание шлюза может занять до 45 минут. Вам понадобится обновить страницу портала, чтобы увидеть готовое состояние.

### <a name="set-up-a-local-network-gateway"></a>Настройка шлюза локальной сети

Настройте шлюз локальной сети в Azure, чтобы представить локальный сайт.

1. На портале щелкните **+Создать ресурс**.
2. В поле поиска введите **шлюз локальной сети** и нажмите клавишу **ВВОД** для выполнения поиска. В результатах щелкните **Шлюз локальной сети** > **Создать**.
3. В колонке **Создание шлюза локальной сети** в поле **Имя** укажите имя, которое Azure будет использовать для вашего объекта шлюза локальной сети.
4. **IP-адрес**. Укажите общедоступный IP-адрес локального VPN-устройства, к которому будет подключаться Azure. IP-адрес не должен быть типа NAT, а Azure должен иметь возможность получить к нему доступ.
5. В поле **Адресное пространство** введите диапазоны адресов локальной сети, которые будут маршрутизированы через VPN-шлюз в локальное устройство. Убедитесь, что они не перекрываются с диапазонами в виртуальной сети Azure.
6. **Настройка параметров BGP** не относится к этому сценарию.
7. Убедитесь, что в поле **Подписка** указана правильная подписка.
8. В разделе **Группа ресурсов** выберите группу ресурсов, используемую для создания сети (ContosoRG).
9. В поле **Расположение** выберите регион, в котором была создана виртуальная сеть.

    ![Локальный шлюз](media/migrate-scenarios-lift-and-shift/vnet-create-local-gateway.png)

4. Щелкните **Создать**, чтобы создать локальный шлюз.

### <a name="configure-your-on-premises-vpn-device"></a>Настройка локального VPN-устройства

Что необходимо настроить в локальном VPN-устройстве:

- общедоступный IPv4-адрес шлюза виртуальной сети Azure, который вы только что создали;
- предварительный ключ (ключ, используемый при создании VPN-подключения типа "сеть — сеть").  

Чтобы настроить локальное VPN-устройство:

- в зависимости от локального VPN-устройства можно загрузить для него скрипт конфигурации. [Узнайте больше](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-download-vpndevicescript).
- Перейдите к [вспомогательным ресурсам](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal#VPNDevice).

### <a name="create-the-vpn-connection"></a>Создание VPN-подключения

Теперь создайте VPN-подключение типа "сеть — сеть" между шлюзом виртуальной сети и локальным VPN-устройством.

1. Откройте страницу виртуальной сети, выбрав **Виртуальные сети** > **Обзор** > **Подключенные устройства**. 
2. Щелкните **Подключения** > **+Добавить**.
3. В колонке **Добавление подключения** в поле **Имя** укажите имя подключения.
4. В поле **Тип подключения** выберите **Сеть — сеть (IPSec)**.
5. **Шлюз виртуальной сети**. Значение является фиксированным, так как вы подключаетесь из этого шлюза.
6. В поле **Шлюз локальной сети** выберите созданный шлюз локальной сети.
7. В поле **Общий ключ** укажите ключ, который соответствует значению, используемому в локальном VPN-устройстве. В этом примере используется abc123, но вы можете (это рекомендуется) создать и использовать что-нибудь посложнее. Важно, чтобы заданное здесь значение совпадало со значением, указанным при настройке вашего VPN-устройства.
8. Значения для **подписки**, **группы ресурсов** и **расположения** являются фиксированными.

    ![VPN-подключение](media/migrate-scenarios-lift-and-shift/vpn-connection.png) 

4. Нажмите кнопку **ОК**, чтобы создать подключение. На экране появится надпись "Идет создание подключения".
5. После создания подключения просмотрите его на странице **Подключения** шлюза виртуальной сети. Состояние изменится с "Неизвестно" на "Подключение", а затем — "Успешно".

### <a name="verify-the-vpn-connection"></a>Проверка VPN-подключения

Чтобы на портале Azure просмотреть состояние подключения для VPN-шлюза в модели Resource Manager, перейдите к нужному подключению. 

1. Щелкните **Все ресурсы** и перейдите к шлюзу виртуальной сети.
2. На странице шлюза виртуальной сети щелкните **Подключения**. Вы увидите состояние каждого подключения.
3. Щелкните имя подключения и просмотрите дополнительные сведения о нем в разделе **Основные компоненты**. В случае успешного подключения будет отображаться состояние "Успешно" и "Подключено".

Теперь проверьте, работает ли подключение к виртуальной машине SQL Server через VPN. Используйте подключение к удаленному рабочему столу и подключитесь к IP-адресу виртуальной машины.



## <a name="step-2-prepare-an-azure-sql-managed-instance"></a>Шаг 2. Подготовка управляемого экземпляра SQL Azure

### <a name="set-up-a-virtual-network"></a>Настройка виртуальной сети

Для этого сценария необходимо создать другую виртуальную сеть, предназначенную для управляемого экземпляра SQL Azure.  Обратите внимание на следующие требования:

- Для создания управляемого экземпляра требуется выделенная подсеть.
- Подсеть должна быть пустой, не должна содержать другие облачные службы и не должна быть подсетью шлюза. После создания управляемого экземпляра не добавляйте ресурсы в подсеть.
- С подсетью не должны быть связаны группы безопасности сети.
- Подсеть должна иметь пользовательскую таблицу маршрутов (UDR) с интернет-маршрутом следующего прыжка 0.0.0.0/0, который должен быть единственным назначенным ей маршрутом. 
- Наличие необязательной пользовательской DNS. Если в виртуальной сети определена пользовательская DNS, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (хранилище или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. [Дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances) об изменениях размера подсети управляемого экземпляра.

Настройте виртуальную сеть следующим образом:

1.  На портале Azure щелкните **Создать ресурс**. 
2. Выберите **Сети** > **Виртуальная сеть**.
3. В разделе **Виртуальная сеть** > **Выберите модель развертывания** выберите **Resource Manager** > **Создать**.
4. В колонке **Создание виртуальной сети** в поле **Имя** введите уникальное имя сети. В нашем сценарии это **ContosoVNETSQLMI**.
5. В поле **Адресное пространство** добавьте диапазон IP-адресов, показанный ниже. Диапазон не должен пересекаться с пространством адресов локальной сети и сети ContosoVNET.
6. Для параметра **Группа ресурсов** выберите создание новой группы или выберите существующую. В этом сценарии мы используем имя **ContosoRG**.
7. В поле **Расположение** выберите регион, в котором требуется создать виртуальную сеть. Мы используем регион **Восточная часть США 2**.
8. В разделе **Подсеть** добавьте имя первой подсети и диапазон ее адресов. Мы создали подсеть **ManagedInstances**.
9. Отключите конечные точки службы.

    ![Сеть управляемого экземпляра](media/migrate-scenarios-lift-and-shift/network-mi.png)

10. После развертывания сети необходимо изменить параметры DNS. В этом сценарии DNS сначала указывает на контроллер домена в подсети Identity, используя статичный частный IP-адрес (172.16.3.4), а затем на распознаватель Azure DNS 168.63.129.16.

    ![Сеть управляемого экземпляра](media/migrate-scenarios-lift-and-shift/network-mi2.png)


### <a name="set-up-routing"></a>Настройка маршрутизации

1. Щелкните **Создать ресурс** в верхнем левом углу окна портала Azure. Щелкните **Таблица маршрутов** > **Создать таблицу маршрутов**.
2. В колонке **Создание таблицы маршрутов** в поле **Имя** укажите имя для таблицы.
3. Выберите подписку, группу ресурсов и расположение. Оставьте BGP отключенным и щелкните **Создать**.
    ![Таблица маршрутов](media/migrate-scenarios-lift-and-shift/route-table.png)

4. После создания таблицы маршрутов откройте ее и щелкните **Маршруты** > **+Добавить**.
5. В колонке **Добавление маршрута** в поле **Имя** укажите имя маршрута.
6. В поле **Префикс адреса** укажите 0.0.0.0/0.
7. В поле **Тип следующего прыжка** выберите **Интернет**. Нажмите кнопку **ОК**.

     ![Таблица маршрутов](media/migrate-scenarios-lift-and-shift/route-table2.png)


### <a name="apply-the-route-to-the-managed-instance-subnet"></a>Применение маршрута к подсети управляемого экземпляра

1. Откройте созданную виртуальную сеть. Щелкните **Подсети** > имя своей подсети.
2. Щелкните **Таблица маршрутов** > имя своей таблицы. Нажмите кнопку **Сохранить**.

     ![Таблица маршрутов](media/migrate-scenarios-lift-and-shift/route-table3.png)

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

1. Щелкните **Создать ресурс**, найдите **Управляемый экземпляр**, а затем выберите **Azure SQL Database Managed Instance (preview)** (Управляемый экземпляр базы данных SQL Azure (предварительная версия)).
2. Нажмите кнопку **Создать**.
3. В колонке **Управляемый экземпляр SQL** выберите свою подписку и проверьте, чтобы для **условий предварительной версии** было выбрано значение **Принято**.
4. В поле **Имя управляемого экземпляра** укажите имя. 
5. Укажите имя пользователя и пароль администратора экземпляра.
6. Выберите группу ресурсов, расположение и виртуальную сеть для экземпляра.
7. Щелкните **Ценовая категория**, чтобы установить размер емкости вычисления и хранилища. По умолчанию экземпляр получает 32 ГБ объема хранилища бесплатно (апрель 2018 г.).
8. Укажите хранилище и число виртуальных ядер.
9. Щелкните **Применить**, чтобы сохранить параметры, и **Создать**, чтобы развернуть управляемый экземпляр. Чтобы просмотреть состояние развертывания, щелкните **Уведомления** и **Deployment in progress** (Выполняется развертывание).

    ![Управляемый экземпляр](media/migrate-scenarios-lift-and-shift/mi-1.png)

Когда управляемый экземпляр будет развернут, в группе ресурсов ContosoRG появится два новых ресурса: виртуальный кластер для управляемых экземпляров и управляемый экземпляр SQL. Оба они находятся в расположении "Восточная часть США 2".

![Управляемый экземпляр](media/migrate-scenarios-lift-and-shift/managed-instance2.png)


## <a name="step-3-get-a-sas-uri-for-dms"></a>Шаг 3. Получение URI SAS для DMS

Получите URI SAS, чтобы служба DMS могла получить доступ к контейнеру учетной записи хранения для отправки архивных файлов, используемых при миграции баз данных в управляемый экземпляр базы данных SQL Azure. 

1. Откройте обозреватель хранилищ (предварительная версия).
2. В левой области разверните учетную запись хранения, содержащую контейнер больших двоичных объектов, для которого необходимо получить SAS. Разверните папку **Контейнеры больших двоичных объектов**в учетной записи хранения.
3. Щелкните правой кнопкой мыши контейнер и выберите **Get Shared Access Signature** (Получить подписанный URL-адрес).

     ![SAS](media/migrate-scenarios-lift-and-shift/sas-1.png)

4. В окне **Подписанный URL-адрес** укажите политику, даты начала и окончания, часовой пояс и уровни доступа для ресурса. Затем щелкните **Создать**.

    ![SAS](media/migrate-scenarios-lift-and-shift/sas-2.png)

5. Во втором диалоговом окне отобразится контейнер больших двоичных объектов вместе с URL-адресом и строками запросов, которые вы можете использовать для доступа к ресурсу хранилища. Нажмите кнопку **Копировать**, чтобы скопировать значения. Храните их в безопасном месте. Они необходимы при настройке DMS.

      ![SAS](media/migrate-scenarios-lift-and-shift/sas-3.png)  

## <a name="step-4-prepare-dms"></a>Шаг 4. Подготовка DMS

Зарегистрируйте поставщик службы миграции базы данных и создайте экземпляр.

### <a name="register-the-microsoftdatamigration-resource-provider"></a>Регистрация поставщика ресурсов Microsoft.DataMigration

1. В своей подписке выберите **Поставщики ресурсов**. 
2. В поле поиска введите migration, а затем справа от Microsoft.DataMigration щелкните **Зарегистрировать**. 


### <a name="create-an-instance"></a>Создание экземпляра

1. Выберите **+Создать ресурс**, введите в поле поиска Azure Database Migration Service, а затем в раскрывающемся списке выберите **Azure Database Migration Service**.
2. На экране Azure Database Migration Service (preview) (Azure Database Migration Service (предварительная версия)) выберите **Создать**.
3. Укажите имя службы, подписку, группу ресурсов, виртуальную сеть и ценовую категорию.
4. Выберите **Создать**, чтобы создать службу.

    ![DMS](media/migrate-scenarios-lift-and-shift/dms-instance.png)  




## <a name="step-5-prepare-azure-for-the-site-recovery-service"></a>Шаг 5. Подготовка Azure для службы Site Recovery

### <a name="set-up-a-virtual-network"></a>Настройка виртуальной сети

Требуется сеть Azure, в которой будут размещаться виртуальные машины Azure, созданные после обработки отказа, и учетная запись хранения, в которой будут храниться все реплицированные данные.

- Для целей этого сценария используется сеть Azure, созданная ранее для DMS.
- Обратите внимание, что используемая сеть должна располагаться в том же регионе, что и хранилище Site Recovery.


### <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

Служба Site Recovery реплицирует данные виртуальной машины в службу хранилища Azure. Виртуальные машины Azure создаются из хранилища при отработке отказа с переходом из локальной среды в Azure.

1. В меню на [портале Azure](https://portal.azure.com) выберите **New** (Создать)  > **Storage** (Хранилище)  > **Учетная запись хранения**.
2. В окне **Создание учетной записи хранения** введите имя учетной записи. В этих руководствах используется имя **contosovmsacct1910171607**. Имя должно быть уникальным в пределах Azure и содержать от 3 до 24 символов (только цифры и строчные буквы).
3. Выберите **Resource Manager** в разделе **Модель развертывания**.
4. В разделе **Тип учетной записи** выберите **Общее назначение**. В разделе **Performance** (Производительность) выберите **Standard**. Не выбирайте хранилище BLOB-объектов.
5. В разделе **Replication** (Репликация) выберите значение по умолчанию **Read-access geo-redundant storage** (Геоизбыточное хранилище с доступом на чтение) для обеспечения избыточности хранилища.
6. В разделе **Subscription** (Подписка) выберите подписку, в которой вы создаете учетную запись хранения.
7. В поле **Resource group** (Группа ресурсов) введите имя новой группы ресурсов. Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. В этих руководствах используется имя **ContosoRG**.
8. В разделе **Расположение** выберите географическое расположение для учетной записи хранения. Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления. В этом сценарии мы используем регион **Восточная часть США 2**.

   ![Создайте учетную запись хранения.](media/migrate-scenarios-lift-and-shift/create-storageacct.png)

9. Щелкните **Create** (Создать), чтобы создать учетную запись хранения.

### <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления

1. На портале Azure выберите **Создать ресурс** > **Мониторинг и управление** > **Backup and Site Recovery** (Backup и Site Recovery).
2. В поле **Имя**введите понятное имя для идентификации хранилища. В этом руководстве используется **ContosoVMVault**.
3. В разделе **Resource group** (Группа ресурсов) выберите имеющуюся группу ресурсов с названием **contosoRG**.
4. В поле **Расположение** введите регион Azure **Восточная часть США 2**.
5. Для быстрого доступа к новому хранилищу с панели мониторинга выберите **Закрепить на панели мониторинга** > **Create** (Создать).
Новое хранилище появится в колонке **Dashboard** (Панель мониторинга)  > **All resources** (Все ресурсы) и на основной странице **Хранилища служб восстановления**.

## <a name="step-6-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 6. Подготовка локальных ресурсов VMware для Site Recovery

Чтобы подготовить VMware для Site Recovery, необходимо сделать следующее:

- Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
- Подготовить учетную запись для автоматической установки службы Mobility Service на виртуальные машины VMware.
- Подготовить локальные виртуальные машины, если вам нужно, чтобы после отработки отказа к виртуальным машинам Azure можно было подключиться.


### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Site_Recovery**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

**Задача.** | **Роль/Разрешения** | **Дополнительные сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Полная репликация, отработка отказа, восстановление размещения** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать.

- Site Recovery может автоматически принудительно устанавливать этот компонент при включении репликации для виртуальной машины.
- Для автоматической принудительной установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальной машине.
- Укажите эту учетную запись при настройке репликации в консоли Azure.
- Подготовьте домен или локальную учетную запись с разрешениями для установки на виртуальной машине.


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После отработки отказа в Azure может потребоваться подключение к реплицируемым виртуальным машинам в Azure из локальной сети.

Чтобы подключиться к виртуальным машинам Windows с помощью RDP после отработки отказа, сделайте следующее:

1. Чтобы получить доступ к Интернету, включите RDP на локальных виртуальных машинах перед отработкой отказа. Убедитесь в том, что правила TCP и UDP добавлены для **общедоступного** профиля, а RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.
2. Для доступа через VPN типа "сеть — сеть" включите RDP на локальном компьютере. Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**.
3. Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Узнайте больше](https://support.microsoft.com/kb/3031135).
4. Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления.
5. После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).



## <a name="step-7-replicate-vms-with-site-recovery"></a>Шаг 7. Репликация виртуальных машин с помощью Site Recovery

### <a name="select-a-replication-goal"></a>Выбор цели репликации

1. В разделе **Хранилища служб восстановления** выберите имя хранилища **ContosoVMVault**.
2. В разделе **Приступая к работе** выберите Site Recovery. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Are your machines virtualized** (Ваши компьютеры виртуализированы?) выберите **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere). Нажмите кнопку **ОК**.

    ![Шаблон OVF](./media/migrate-scenarios-lift-and-shift/replication-goal.png)


### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

В разделе **Deployment Planning** (Планирование развертывания) в раскрывающемся списке выберите **Yes, I have done it** (Да, выполнено).

### <a name="set-up-the-source-environment"></a>Настройка исходной среды


Чтобы настроить исходную среду, вам понадобится один высокодоступный локальный компьютер для размещения локальных компонентов Site Recovery. К этим компонентам относится сервер конфигурации и сервер обработки.

- Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.


Чтобы настроить сервер конфигурации в виде высокодоступной виртуальной машины VMware:

- Скачайте подготовленный шаблон Open Virtualization Format (OVF).
- Импортируйте шаблон в VMware, чтобы создать виртуальную машину.
- Настройте сервер конфигурации и зарегистрируйте его в хранилище. 

После регистрации Site Recovery обнаружит локальные виртуальные машины VMware.



#### <a name="download-the-vm-template"></a>Скачивание шаблона виртуальной машины

1. В хранилище выберите **Prepare Infrastructure** (Подготовка инфраструктуры)  > **Source** (Источник).
2. В колонке **Подготовка источника** выберите **+ Сервер конфигурации**.

    ![Скачивание шаблона](./media/migrate-scenarios-lift-and-shift/new-cs.png)

4. В колонке **Add Server** (Добавление сервера) в поле **Server type** (Тип сервера) должно быть указано **Configuration server for VMware** (Сервер конфигурации для VMware).
2. Скачайте шаблон OVF для сервера конфигурации.

    ![Скачивание OVF](./media/migrate-scenarios-lift-and-shift/add-cs.png)

  > [!TIP]
  Вы можете скачать последнюю версию шаблона сервера конфигурации непосредственно из [Центра загрузки Майкрософт](https://aka.ms/asrconfigurationserver).

#### <a name="import-the-template-in-vmware"></a>Импорт шаблона в VMware

1. Подключитесь к серверу VMware vCenter с помощью клиента VMware vSphere.
2. В меню **Файл** (File) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить мастер развертывания шаблона OVF. 

     ![Шаблон OVF](./media/migrate-scenarios-lift-and-shift/vcenter-wizard.png)

3. Укажите расположение скачанного шаблона OVF в разделе **Выбрать источник**.
4. В разделе **Просмотр сведений** выберите **Далее**.
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** (Выбор хранилища), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки) в области **Select virtual disk format** (Выбор формата виртуального диска).
7. На остальных страницах мастера примите значение параметров по умолчанию.
8. На странице **Ready to complete** (Все готово к выполнению) сделайте следующее:

    * Чтобы настроить виртуальную машину с параметрами по умолчанию, выберите **Power on after deployment** (Включение после развертывания)  > **Finish** (Готово).

    * Если вы хотите добавить дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** (Включение после развертывания). Затем нажмите кнопку **Готово**. По умолчанию шаблон сервера конфигурации развертывается с одним сетевым адаптером. Вы можете добавить дополнительные сетевые адаптеры после развертывания.



#### <a name="register-the-configuration-server"></a>Регистрация сервера конфигурации 

1. Из консоли клиента VMWare vSphere включите виртуальную машину.
2. Виртуальная машина загружается в среду установки Windows Server 2016. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите в виртуальную машину от имени администратора.
4. При первом входе в систему будет запущено средство конфигурации Azure Site Recovery.
5. Введите имя, которое использовалось для регистрации сервера конфигурации в службе Site Recovery. Затем нажмите кнопку **Далее**.

    ![Шаблон OVF](./media/migrate-scenarios-lift-and-shift/config-server-register1.png)

6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.

    ![Шаблон OVF](./media/migrate-scenarios-lift-and-shift/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. Снова войдите в систему. Мастер управления сервером конфигурации запустится автоматически.

#### <a name="configure-settings-and-add-the-vmware-server"></a>Настройка параметров и добавление сервера VMware

1. В мастере управления сервером конфигурации выберите **Setup connectivity** (Настройка подключения) и выберите сетевой адаптер, который будет принимать трафик репликации. Затем нажмите кнопку **Save** (Сохранить). Этот параметр уже нельзя изменить после настройки.
2. В разделе **Select Recovery Services vault** (Выбор хранилища служб восстановления) выберите подписку Azure и соответствующие группу и хранилище ресурсов.

    ![Хранилище](./media/migrate-scenarios-lift-and-shift/cswiz1.png) 

3. В разделе **Install third-party software** (Установка стороннего программного обеспечения) примите лицензионное соглашение. Выберите **Download and Install** (Скачать и установить), чтобы установить сервер MySQL.
4. Выберите **Install VMware PowerLCI** (Установить VMware PowerCLI). Прежде чем это сделать, закройте все окна браузера. Затем выберите **Continue** (Продолжить).
5. Прежде чем вы продолжите, будут проверены предварительные требования в разделе **Validate appliance configuration** (Проверка конфигурации модуля).
6. В разделе **Configure vCenter Server/vSphere ESXi server** (Настройка сервера vCenter Server или vSphere ESXi) введите полное доменное имя или IP-адрес сервера vCenter или узел vSphere, на которых расположены виртуальные машины для репликации. Введите порт, от которого ожидается передача данных на сервер. Введите понятное имя для сервера VMware в хранилище.
7. Введите учетные данные, которые будут использоваться сервером конфигурации для подключения к серверу VMware. Site Recovery использует эти учетные данные для автоматического обнаружения виртуальных машин VMware, доступных для репликации. Выберите **Add** (Добавить), а затем нажмите кнопку **Continue** (Продолжить).

    ![vCenter](./media/migrate-scenarios-lift-and-shift/cswiz2.png)

8. В разделе **Configure virtual machine credentials** (Настройка учетных данных виртуальной машины) введите имя пользователя и пароль, которые будут использоваться для автоматической установки службы Mobility Service на компьютерах с включенной репликацией. Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать. 

    ![vCenter](./media/migrate-scenarios-lift-and-shift/cswiz2.png)

7. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации. 
8. По окончании регистрации на портале Azure убедитесь, что сервер конфигурации и VMware указаны на странице **Источник** в хранилище. Затем нажмите кнопку **OK** (ОК), чтобы настроить параметры целевого объекта.
9. Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

> [!NOTE]
> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > ***имя сервера*** > **Обновить сервер**.

### <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. В разделе **Подготовка инфраструктуры** > **Цель** выберите требуемую подписку Azure.
2. Для целевой модели развертывания выберите **Azure Resource Manager**.

3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.


### <a name="create-a-replication-policy"></a>Создание политики репликации

1. В разделе **Подготовка инфраструктуры** > **Параметры репликации** > **Политика репликации** щелкните **Create and Associate** (Создать и связать).
1. На странице **Создать политику репликации** введите имя политики **VMwareRepPolicy**.
2. На странице **Пороговое значение RPO** используйте значение по умолчанию (60 минут). Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
3. В поле **Хранение точки восстановления** используйте значение по умолчанию (24 часа) для продолжительности периода хранения каждой точки восстановления. В рамках этого руководства используется значение 72 часа. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
4. В разделе **App-consistent snapshot frequency** (Периодичность создания моментальных снимков) используйте значение по умолчанию (60 минут) для частоты создания согласованных с приложением моментальных снимков. Нажмите кнопку **OK**, чтобы создать политику.

    ![Создание политики репликации](./media/migrate-scenarios-lift-and-shift/replication-policy.png)

5. Политика автоматически сопоставляется с сервером конфигурации. 

    ![Связывание политики репликации](./media/migrate-scenarios-lift-and-shift/replication-policy2.png)



### <a name="enable-replication"></a>Включение репликации

Теперь запустите репликацию виртуальных машин. Site Recovery устанавливает службу Mobility Service на каждой виртуальной машине, когда вы включаете репликацию для нее. 


1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. Выберите сервер обработки (сервер конфигурации). Нажмите кнопку **ОК**.

    ![Включение репликации](./media/migrate-scenarios-lift-and-shift/enable-replication1.png)

1. В разделе **Целевой объект** выберите подписку и группу ресурсов, в которых нужно создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.
2. Выберите учетную запись службы хранения Azure, которую вы хотите использовать для репликации данных.
3. Выберите сеть и подсеть Azure для подключения виртуальных машин Azure, созданных после отработки отказа.
4. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым компьютерам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
5. Выберите подсеть в виртуальной сети. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/migrate-scenarios-lift-and-shift/enable-replication2.png)

6. В разделе **Виртуальные машины** > **Выбор виртуальных машин** выберите нужную виртуальную машину (WEBVM). Можно выбрать только те компьютеры, для которых можно включить репликацию. 

    ![Включение репликации](./media/migrate-scenarios-lift-and-shift/enable-replication3.png)

7. Для мониторинга добавляемых виртуальных машин укажите последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не выбирая его) и нажмите кнопку **Обновить**. Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.
8. В разделе **Свойства** > **Configure properties** (Настройка свойств) выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютере. 

    ![Включение репликации](./media/migrate-scenarios-lift-and-shift/enable-replication4.png)

9. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации.
10. Выберите **Включить репликацию**.

    ![Включение репликации](./media/migrate-scenarios-lift-and-shift/enable-replication5.png)

11. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Site Recovery Jobs** (Задания Site Recovery). 
12. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа и появится в разделе **Обзор** > **Основные компоненты**.

    ![Основные компоненты](./media/migrate-scenarios-lift-and-shift/essentials.png)


## <a name="step-8-migrate-the-database-with-dms"></a>Шаг 8. Миграция базы данных с помощью DMS

Создайте проект DMS и выполните миграцию.


### <a name="create-a-database-migration-project"></a>Создание проекта миграции базы данных

1. Найдите ресурс DMS на портале Azure и откройте его.
2. Выберите **+ New Migration Project** (+ Новый проект миграции).
3. В окне **New migration project** (Новый проект миграции) укажите имя проекта.
4. В поле **Source server type** (Тип исходного сервера) выберите **SQL Server**. В поле **Target server type** (Тип целевого сервера) выберите **Управляемый экземпляр базы данных SQL Azure**.
5. Щелкните **Создать**, чтобы создать проект.
6. На экране **Source details** (Сведения об источнике) задайте сведения о подключении для локального исходного SQL Server. Выберите команду **Сохранить**.
7. На экране **Target details** (Сведения о целевом объекте) задайте сведения о подключении для целевого объекта — предварительно подготовленного управляемого экземпляра базы данных SQL Azure, в который будет перенесена локальная база данных. Нажмите кнопку **Сохранить**.
8. На экране **Project summary** (Сводка по проекту) просмотрите и проверьте сведения, связанные с проектом миграции.

    ![Проект DMS](./media/migrate-scenarios-lift-and-shift/dms-project.png)

### <a name="migrate-the-database"></a>Миграция базы данных

1. После создания проекта откроется мастер миграции.
2. Укажите учетные данные для исходного и целевого серверов, а затем нажмите кнопку **Сохранить**. Мастер попытается выполнить вход на локальный сервер SQL.

    ![Мастер DMS](./media/migrate-scenarios-lift-and-shift/dms-wiz1.png)

3. На экране **Map to target databases** (Сопоставление с целевыми базами данных) выберите для миграции базу данных-источник. Нажмите кнопку **Сохранить**.

    ![Мастер DMS](./media/migrate-scenarios-lift-and-shift/dms-wiz2.png)

4. На экране **Target details** (Сведения о целевом объекте) выберите **I know my target details** (У меня есть сведения о целевом объекте). Предоставьте имя DNS управляемых экземпляров SQL, а также учетные данные. Нажмите кнопку **Сохранить**.

    ![Мастер DMS](./media/migrate-scenarios-lift-and-shift/dms-wiz3.png)

5. В сохраненном проекте выберите **+New Activity** (+ Новое действие). Затем выберите **Run Migration** (Запустить миграцию).
6. При появлении запроса введите учетные данные исходного и целевого серверов. Нажмите кнопку **Сохранить**.
7. На экране **Map to target databases** (Сопоставление с целевыми базами данных) выберите для миграции базу данных-источник. Затем щелкните **Сохранить**
8. На странице **Configure migration settings** (Настройка параметров миграции)  > **Server backup location** (Расположение резервной копии сервера) укажите сетевую папку, созданную на локальном компьютере. DMS сохраняет резервные копии источника в этой общей папке.  Помните, что учетная запись службы, в которой выполняется исходный экземпляр SQL Server, должна иметь права записи для этой общей папки.
9. Укажите имя пользователя и пароль, который DMS может использовать для передачи файлов резервных копий в контейнер хранилища Azure на восстановление.
10. Укажите URI SAS, который позволяет DMS обращаться к контейнеру учетной записи хранения для отправки файлов резервных копий, которые используются для миграции в управляемый экземпляр базы данных SQL Azure.  Нажмите кнопку **Сохранить**.
11. На экране **Migration summary** (Сводка по миграции) укажите имя действия миграции и выберите **Run the migration** (Запустить миграцию).
12. В проекте выберите **Обзор**, чтобы отслеживать состояние миграции. После завершения миграции убедитесь, что целевые базы данных существуют в управляемом экземпляре.


## <a name="step-9-migrate-vms-with-site-recovery"></a>Шаг 9. Миграция виртуальных машин с помощью Site Recovery

Мы рекомендуем выполнить тестовую отработку отказа, чтобы убедиться в том, что все работает должным образом, прежде чем выполнять полную миграцию. При запуске тестовой отработки отказа происходит следующее:

1. выполняется проверка на соблюдение всех необходимых условий для миграции;
2. операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
3. создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.
2. В свойствах виртуальной машины щелкните **+Тестовая отработка отказа**.

    ![Тестовая отработка отказа](./media/migrate-scenarios-lift-and-shift/test-failover.png)

3. Выберите **Latest processed** (Последняя отработанная), чтобы выполнить отработку отказа виртуальной машины до последней доступной точки во времени. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
2. На странице **Тестовая отработка отказа** выберите целевую сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
3. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. Вы можете отслеживать ход выполнения в хранилище, выбрав **Параметры** > **Задания** > **Тестовая отработка отказа**.
4. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает. Теперь вы можете подключиться к реплицированной виртуальной машине в Azure.
5. Чтобы удалить виртуальные машины Azure, созданные во время тестовой отработки отказа, щелкните **Очистить тестовую отработку отказа** на виртуальной машине. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа.

### <a name="migrate-the-machines"></a>Миграция компьютеров

Убедившись, что тестовая обработка отказа выполняется должным образом, создайте план восстановления для миграции в Azure.

### <a name="create-a-recovery-plan"></a>Создайте план восстановления

1. В хранилище выберите **Recovery Plans (Site Recovery)** (Планы восстановления (Site Recovery))  > **+ План восстановления**.
2. В разделе **Создать план восстановления** укажите имя для нового плана.
3. Выберите исходный сервер конфигурации, а в качестве целевого сервера — Azure. Выберите **Resource Manager** в качестве модели развертывания. На компьютерах в исходном расположении должны быть настроены отработка отказа и восстановление. 
4. В колонке **Выбор элементов** добавьте виртуальные машины (WEBVM) в план. Нажмите кнопку **ОК**.
5. Щелкните **ОК**, чтобы создать план.

    ![План восстановления](./media/migrate-scenarios-lift-and-shift/recovery-plan1.png)

### <a name="run-a-failover"></a>Запуск отработки отказа

1. В разделе **Планы восстановления** щелкните нужный и выберите **Отработка отказа**.
2. В разделе **Отработка отказа** > **Точка восстановления** выберите последнюю точку восстановления.
3. Параметр ключа шифрования не учитывается в этом сценарии.
4. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Служба Site Recovery попытается завершить работу исходных виртуальных машин, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.

    ![Отработка отказа](./media/migrate-scenarios-lift-and-shift/failover1.png)

5. Убедитесь, что виртуальная машина Azure отображается в Azure должным образом.

    ![Отработка отказа](./media/migrate-scenarios-lift-and-shift/failover2.png)

6. В разделе **Реплицированные элементы** щелкните виртуальную машину правой кнопкой мыши и выберите **Завершение миграции**. Таким образом вы завершите миграцию, прекратите репликацию для виртуальной машины и остановите выставление счетов Site Recovery для виртуальной машины.

    ![Отработка отказа](./media/migrate-scenarios-lift-and-shift/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

На последнем этапе процесса миграции необходимо обновить строку подключения приложения, чтобы указать на перенесенную базу данных, запущенную в SQL MI.

1. Найдите новую строку подключения на портале Azure, щелкнув **Параметры** > **Строки подключения**.

    ![Отработка отказа](./media/migrate-scenarios-lift-and-shift/failover4.png)  

2. Вам нужно обновить эту строку с помощью имени пользователя и пароля SQL MI.
3. После настройки строки необходимо заменить текущую строку подключения в файле web.config приложения.
4. После обновления файла и его сохранения перезапустите IIS на WEBVM. Это можно сделать из командной строки с помощью команды IISRESET /RESTART.
5. После перезапуска IIS приложение будет использовать базу данных, выполняющуюся на SQL MI.
6. На этом этапе можно завершить работу локальной виртуальной машины SQLVM и завершить миграцию.



## <a name="conclusion"></a>Заключение

В этом сценарии вы выполнили следующее:

> [!div class="checklist"]
> * миграцию локальной базы данных в управляемый экземпляр SQL Azure с помощью DMS;
> * миграцию локальных виртуальных машин в виртуальные машины Azure с помощью службы Azure Site Recovery.
