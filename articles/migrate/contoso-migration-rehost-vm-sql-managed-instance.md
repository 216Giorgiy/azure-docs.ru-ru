---
title: Повторное размещение локального приложения компании Contoso путем перехода на виртуальные машины Azure и Управляемый экземпляр Базы данных SQL Azure | Документация Майкрософт
description: В этой статье рассказывается о том, как компания Contoso перемещает локальное приложение в виртуальные машины Azure используя Управляемый экземпляр Базы данных SQL Azure.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 07/12/2018
ms.author: raynew
ms.openlocfilehash: 3e3f8dffbaa7109423aacdbfbaa658bada8bb84a
ms.sourcegitcommit: 248c2a76b0ab8c3b883326422e33c61bd2735c6c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2018
ms.locfileid: "39215345"
---
# <a name="contoso-migration-rehost-an-on-premises-app-on-an-azure-vm-and-sql-database-managed-instance"></a>Миграция Contoso. Повторное размещение локального приложения на виртуальную машину Azure и в Управляемом экземпляре Базы данных SQL

В этой статье компания Contoso переносит виртуальной машину внешнего интерфейса приложения SmartHotel на виртуальную машину Azure с помощью службы Azure Site Recovery. Компания Contoso также переносит базу данных приложения на Управляемый экземпляр Базы данных SQL Azure.

> [!NOTE]
> Управляемый экземпляр Базы данных SQL Azure в настоящее время находится в предварительной версии.

Это одна из статей серии о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. Эта серия содержит общие сведения и набор сценариев, которые иллюстрируют настройку инфраструктуры миграции и выполнение миграций различных типов. Сценарии становятся все более сложными. Статьи будут добавляться в серию со временем.


Статья | Сведения | Status
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Общие сведения о стратегии миграции компании Contoso, серии статей и используемые в сериях примеры приложений. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Компания Contoso готовит локальную инфраструктуру и инфраструктуру Azure для миграции. Для всех статей миграции в серии используется одна и та же инфраструктура. | Доступна
[Статья 3. Оценка готовности локальных ресурсов к переносу в Azure](contoso-migration-assessment.md) | Компания Contoso выполняет оценку локального двухуровневого приложения SmartHotel в VMware. Специалисты компании Contoso оценивают виртуальные машины приложения с помощью службы [Миграция Azure](migrate-overview.md). Компания Contoso оценивает приложение базы данных SQL Server с помощью [Помощника по миграции данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
Статья 4. Повторное размещение приложения на виртуальной машине Azure и в Управляемом экземпляре Базы данных SQL | Компания Contoso переносит локальное приложение SmartHotel в Azure по методу lift-and-shift. Специалисты компании Contoso переносят виртуальную машину внешнего интерфейса приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Компания Contoso выполняет миграцию базы данных приложения в Управляемый экземпляр Базы данных SQL Azure с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Эта статья
[Статья 5. Повторное размещение приложения на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | Компания Contoso переносит виртуальные машины приложения SmartHotel на виртуальные машины Azure с помощью службы Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группе доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Компания Contoso переносит приложение SmartHotel. Для переноса виртуальных машин приложения компания Contoso использует Site Recovery. Она использует службу Azure Database Migration Service для миграции базы данных приложения в кластер SQL Server, который защищен группой доступности AlwaysOn. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Компания Contoso завершает миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery. | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и в Базе данных Azure для MySQL](contoso-migration-rehost-linux-vm-mysql.md) | Специалисты компании Contoso выполняют миграцию приложения osTicket для Linux на виртуальные машины Azure с помощью Site Recovery. Они перемещают базу данных приложения в Базу данных Azure для MySQL с помощью MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения в веб-приложении Azure и Базе данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | Компания Contoso переносит приложение SmartHotel в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Доступна
[Статья 10. Рефакторинг приложения Linux в веб-приложении Azure и Базе данных SQL Azure](contoso-migration-refactor-linux-app-service-mysql.md) | Специалисты компании Contoso переносят свое приложение Linux osTicket в веб-приложение Azure на нескольких сайтах. Веб-приложение интегрируется с GitHub для непрерывной поставки. Компания Contoso переносит базу данных приложения в экземпляр Базы данных Azure для MySQL. | Доступна
[Статья 11. Рефакторинг Team Foundation Server на Visual Studio Team Services](contoso-migration-tfs-vsts.md) | Специалисты компании Contoso выполняют миграцию локального развертывания Team Foundation Server путем его переноса в Visual Studio Team Services в Azure. | Доступна
[Статья 12. Перепроектирование приложения в контейнерах Azure и Базе данных SQL Azure](contoso-migration-rearchitect-container-sql.md) | Компания Contoso переносит приложение SmartHotel в Azure, а затем перепроектирует его. Специалисты компании Contoso перепроектируют веб-уровень приложения в контейнер Windows и перепроектируют базу данных приложения с помощью Базы данных SQL Azure. | Доступна
[Статья 13. Повторное создание приложения в Azure](contoso-migration-rebuild.md) | Компания Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, Функции Azure, Cognitive Services и Azure Cosmos DB. | Доступна

Пример приложения SmartHotel, который используется в этой статье, можно скачать с [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="on-premises-architecture"></a>Локальная архитектура


Эта схема показывает текущую локальную инфраструктуру компании Contoso.

![Текущая архитектура Contoso](./media/contoso-migration-rehost-vm-sql-managed-instance/contoso-architecture.png)  

- Компания Contoso имеет единственный главный центр обработки данных. Он находится в Нью-Йорке (на востоке Соединенных Штатов Америки).
- У компании есть еще три местных филиала в других уголках США.
- Основной центр обработки данных подключается к Интернету с помощью оптоволоконного соединения Metro Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединений бизнес-класса и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Эта настройка позволяет компании Contoso обеспечивать постоянство подключения всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. Компания использует два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Компания Contoso использует управление удостоверениями в Active Directory. Компания Contoso использует DNS-серверы внутренней сети.
- Контроллеры домена в центре обработки данных размещены в виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство компании Contoso и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** Компания Contoso растет. В результате увеличилось давление на внутренние системы и инфраструктуру компании.
- **Повышение эффективности**. Компании Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и не тратили время или деньги, поэтому компания может быстрее выполнять требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso нуждается в большей гибкости в отношении потребностей бизнеса. Он должен реагировать быстрее чем изменения, которые происходят на рынке, для достижение компанией успеха в глобальной экономике. ИТ-отдел в компании Contoso не должен мешать или становиться помехой для бизнеса.
- **Масштабирование**. По мере роста бизнеса компании ИТ-отдел компании Contoso должен предоставлять системы, которые могут расти с той же скоростью.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Компания использует цели миграции, чтобы определить наилучший способ миграции.

- После миграции приложение Azure должно иметь те же возможности с точки зрения производительности, что и приложение в текущей локальной среде VMware компании Contoso. Переход в облако не означает, что производительность приложения сильно уменьшится.
- Contoso не считает нужным вкладывать средства в это приложение. Это приложение критически важно для бизнеса, но компании Contoso просто нужно переместить его в облако в его текущей форме.
- Задачи администрирования базы данных должны быть минимальными после переноса приложения.
- Компания Contoso не хочет использовать базу данных SQL Azure для этого приложения. Она ищет альтернативные варианты.

## <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Компания Contoso намерена перенести свое локальное двухуровневое приложение для туризма.
- Приложение расположено на нескольких виртуальных машинах (**WEBVM** и **SQLVM**) и находится на узле VMware ESXi версия 6.5 (**contosohost1.contoso.com**). 
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Специалисты компании Contoso переносят базу данных приложения (**SmartHotelDB**) в управляемый экземпляр Базы данных SQL Azure.
- Они переносят локальные виртуальные машины VMware в виртуальную машину Azure.
- Компания Contoso использует локальный центр обработки данных (**contoso-datacenter**) и локальный контроллер домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](media/contoso-migration-rehost-vm-sql-managed-instance/architecture.png) 

### <a name="azure-services"></a>Службы Azure

Service | ОПИСАНИЕ | Стоимость
--- | --- | ---
[Служба управления базами данных](https://docs.microsoft.com/azure/dms/dms-overview) | Служба управления базами данных обеспечивает прозрачную миграцию из нескольких источников баз данных на платформы данных Azure с минимальным временем простоя. | Дополнительные сведения о [поддерживаемых регионах ](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) см. в статье [Цены на Службу миграции баз данных Azure ](https://azure.microsoft.com/pricing/details/database-migration/).
[Управляемый экземпляр базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | Управляемый экземпляр — это служба управляемой базы данных, которая представляет полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | За использование Управляемых экземпляров Базы данных SQL, выполняемых в Azure, взимается плата на основе емкости. Дополнительные сведения см. в статье [Цены на Базу данных SQL Azure ](https://azure.microsoft.com/pricing/details/sql-database/managed/). 
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | Служба Site Recovery организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов.  | Во время репликации в Azure взимается плата за службу хранилища Azure.  При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительными сведениями см. в статье [Цены на Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

 ## <a name="migration-process"></a>Процесс миграции

Компания Contoso перенесет уровни данных и веб-приложения SmartHotel в Azure, выполняя эти действия.

1. У компании уже есть инфраструктура Azure, поэтому ей необходимо добавить всего пару специальных компонентов Azure в свой сценарий.
2. Уровень данных будет перенесен с помощью службы Database Migration Service. Database Migration Service подключается к локальной виртуальной машине сервера SQL через VPN-подключение типа "сайт — сайт" между центром обработки данных Contoso и Azure. Затем Data Migration Service выполнит миграцию базы данных.
3. Миграция веб-уровня будет выполнена с помощью миграции lift-and-shift используя Site Recovery. Этот процесс подготовит локальную среду VMware, настроит и включит репликацию, а также осуществит миграцию виртуальных машин в Azure.

     ![Архитектура миграции](media/contoso-migration-rehost-vm-sql-managed-instance/migration-architecture.png) 

## <a name="prerequisites"></a>Предварительные требования

Компания Contoso и другие пользователи должны отвечать следующим предварительным условиям этого сценария.

Требования | Сведения
--- | ---
**Регистрация в предварительной версии Управляемого экземпляра** | Необходимо зарегистрироваться в ограниченной общедоступной предварительной версии Управляемого экземпляра Базы данных SQL. Чтобы [зарегистрироваться](https://portal.azure.com#create/Microsoft.SQLManagedInstance), необходима подписка Azure. Регистрация может занять несколько дней, поэтому ее необходимо выполнить перед началом работы с этим сценарием развертывания.
**Подписка Azure.** | Вы должны были создать подписку, когда выполняли оценку в первой статье этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуется более детализированные разрешения, см. в разделе [Use Role-Based Access Control to manage Site Recovery access](../site-recovery/site-recovery-role-based-linked-access-control.md) (Использование управления доступом на основе ролей для управления доступом к Site Recovery). 
**Site Recovery (локальный экземпляр)** | Потребуется локальный экземпляр сервера vCenter Server версии 5.5, 6.0 или 6.5<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).<br/><br/> Поддерживаемая конфигурация [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилища](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage).
**Служба управления базами данных** | Для службы управления базами данных необходимо иметь [совместимое локальное VPN-устройство](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).<br/><br/> Необходимо настроить локальное VPN-устройство. Оно должно иметь внешний общедоступный IPv4-адрес. Этот адрес не может быть за устройством преобразования сетевых адресов (NAT).<br/><br/> Убедитесь, что у вас есть доступ к локальной базе данных SQL Server.<br/><br/> Брандмауэр Windows должен иметь доступ к ядру исходной СУБД. Дополнительные сведения о [настройке брандмауэра Windows для доступа к ядру СУБД](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).<br/><br/> Если перед вашим компьютером базы данных есть брандмауэр, добавьте правила, разрешающие доступ к базе данных и файлам через SMB-порт 445.<br/><br/> Учетные данные, используемые для подключения к исходному экземпляру сервера SQL Server и целевому Управляемому экземпляру, должны принадлежать к серверной роли sysadmin.<br/><br/> Необходимо иметь сетевую папку в локальной базе данных, которую Служба управления базами данных может использовать для резервного копирования базы данных источника.<br/><br/> Убедитесь, что учетная запись службы, от имени которой выполняется исходный экземпляр SQL Server, имеет разрешения на запись для этой сетевой папки.<br/><br/> Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Служба управления базами данных олицетворяет пользователя с этими учетными данными, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure.<br/><br/> В процессе установки SQL Server Express для протокола TCP/IP устанавливается **отключенное состояние** по умолчанию. Убедитесь, что он включен.

## <a name="scenario-steps"></a>Шаги выполнения сценария

Настройку развертывания компания Contoso планирует осуществлять следующим образом.

> [!div class="checklist"]
> * **Шаг 1. Настройка Управляемого экземпляра Базы данных SQL Azure**. Компании Contoso необходимо предварительно создать Управляемый экземпляр, в который будет переноситься локальная база данных SQL Server.
> * **Шаг 2: Подготовка службы управления базами данных**. Компании Contoso необходимо зарегистрировать поставщик миграции базы данных, создать экземпляр, а затем создать проект Службы управления базами данных. Специалистам компании Contoso также необходимо настроить универсальный код ресурса (URI) подписанного URL-адреса (SAS) для Службы управления базами данных. URI SAS предоставляет делегированный доступ к ресурсам в учетной записи хранения компании Contoso, поэтому компания может предоставлять ограниченные разрешения к объектам в хранилище. Они настроят URI SAS, чтобы служба управления базами данных могла получить доступ к контейнеру учетной записи хранения, в который служба отправляет файлы архивации SQL Server.
> * **Шаг 3. Подготовка Azure для Site Recovery**. Компания Contoso создаст учетную запись хранения Azure для хранения реплицируемых данных для Site Recovery. Также необходимо создать хранилище служб восстановления Azure.
> * **Шаг 4. Подготовка локальных ресурсов VMware для Site Recovery**. Компания Contoso подготовит учетные записи для обнаружения виртуальных машин и установки агента для подключения к виртуальным машинам Azure после отработки отказа.
> * **Шаг 5. Репликация виртуальных машин**. Чтобы настроить репликацию, специалисты компании Contoso настроят исходную и целевую среды Site Recovery, установят политику репликации и запустят репликацию виртуальных машин в хранилище Azure.
> * **Шаг 6. Миграция базы данных с помощью Службы управления базой данных**. Компания Contoso выполняет миграцию базы данных.
> * **Шаг 7. Миграция виртуальных машин с помощью Site Recovery**. Компания Contoso запускает тестовую отработку отказа, чтобы убедиться, что все работает. Затем компания запускает полную отработку отказа для выполнения миграции виртуальных машин в Azure.

## <a name="step-1-prepare-a-sql-database-managed-instance"></a>Шаг 1. Подготовка Управляемого экземпляра базы данных SQL Azure

Чтобы настроить Управляемый экземпляр базы данных SQL Azure, специалистам компании Contoso требуется подсеть, которая соответствует следующим требованиям.

- Подсеть должна быть выделенной. Она должна быть пустой и не содержать другие облачные службы. Подсеть не должна быть подсетью шлюза.
- После создания Управляемого экземпляра компания не должна добавлять ресурсы в подсеть.
- С подсетью не должна быть связана группа безопасности сети.
- Подсеть должна иметь таблицу маршрутов "Определяемые пользователем маршруты (UDR)". Должен быть назначен единственный интернет-маршрут следующего прыжка 0.0.0.0/0. 
- Наличие необязательной пользовательской DNS. Если в виртуальной сети Azure определена пользовательская DNS, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). Дополнительные сведения см. в разделе [Настройка пользовательской службы DNS для Управляемого экземпляра Базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (хранилище или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances).
- В гибридной среде Contoso требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure компании. Дополнительные сведения см. в разделе [Настройка DNS](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

Специалисты компании Contoso настроят виртуальную сеть следующим образом. 

1. Contoso создаст новую виртуальную сеть (**VNET-SQLMI-EU2**) в основном регионе "Восточная часть США 2". Она добавит виртуальную сеть для группы ресурсов **ContosoNetworkingRG**.
2. Contoso присвоит адресное пространство 10.235.0.0/24. Компания Contoso гарантирует, что диапазон не пересекается с другими сетями в его организации.
2. Она добавит к сети две подсети:
    - **SQLMI-DS-EUS2** (10.235.0.0.25);
    - **SQLMI-SAW-EUS2** (10.235.0.128/29). Эта подсеть используется для присоединения каталога в Управляемом экземпляре.

    ![Управляемый экземпляр – Создание виртуальной сети](media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

6. После развертывания виртуальной сети и подсетей, компания Contoso создаст распределение сетей следующим образом.

    - Согласовывается ранг **VNET-SQLMI-EUS2** и **VNET-HUB-EUS2** (центр виртуальной сети для восточной части США 2).
    - Согласовывается ранг **VNET-SQLMI-EUS2** и **VNET-PROD-EUS2** (рабочей сети).

    ![Пиринг сетей](media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

7. Компания Contoso задает пользовательские параметры DNS. Служба доменных имен (DNS) сначала указывает на контроллеры домена Azure компании Contoso. Azure DNS является вторичной. Контроллеры домена Contoso Azure находятся в следующих расположениях.

    - Расположение подсети **PROD-DC-EUS2** в регионе "Восточная часть США 2" рабочей сети (**VNET-PROD-EUS2**)
    - Адрес **CONTOSODC3**: 10.245.42.4
    - Адрес **CONTOSODC4**: 10.245.42.5
    - Арбитр конфликтов DNS Azure: 168.63.129.16

     ![DNS-серверы сети](media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

*Нужна дополнительная помощь?*

- См. раздел [Настройка пользовательской службы DNS для Управляемого экземпляра Базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).
- См. раздел [Создание виртуальной сети для управляемых экземпляров](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#create-a-new-virtual-network-for-managed-instances).
- См. раздел [Создание, изменение и удаление пиринга в виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).
- См. раздел [Включение доменных служб Azure Active Directory](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-dns).

### <a name="set-up-routing"></a>Настройка маршрутизации

Управляемый экземпляр размещается в частной виртуальной сети. Компании Contoso необходима таблица маршрутов для виртуальной сети, чтобы взаимодействовать со службой управления Azure. Если виртуальная сеть не может связаться со службой, которая ею управляет, виртуальная сеть становится недоступной.

Компания Contoso принимает во внимание следующие факторы.

- Таблица маршрутизации с набором правил (маршрутов), указывающих, как отправляемые пакеты с Управляемого экземпляра должны маршрутизироваться в виртуальной сети.
- Таблица маршрутизации связывается с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, который оставляет подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

 Настройка маршрутизации

1. Компания Contoso создает таблицу UDR. Компания Contoso создает таблицу маршрутизации в группе ресурсов **ContosoNetworkingRG**.

    ![Таблица маршрутов](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. Чтобы соответствовать требованиям Управляемого экземпляра, после завершения развертывания таблицы маршрутизации (**MIRouteTable**) компания Contoso добавляет маршрут с префиксом адреса 0.0.0.0/0. Параметр **Тип следующего прыжка** установлен как **Интернет**.

    ![Префикс таблицы маршрутизации](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)
    
3. Компания Contoso связывает таблицы маршрутизации с подсетью **SQLMI-DB-EUS2** (в сети **VNET-SQLMI-EUS2**). 

    ![Подсеть таблицы маршрутизации](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)
    
*Нужна дополнительная помощь?*

См. в разделе [Создание таблицы маршрутов и маршрута](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal#create-new-route-table-and-a-route).

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь компания Contoso может подготовить Управляемый экземпляр базы данных SQL.

1. Так как Управляемый экземпляр выступает как бизнес-приложение, компания Contoso развертывает его в основном регионе "Восточная часть США 2". Компания добавляет Управляемый экземпляр в группу ресурсов **ContosoRG**.
2. Сотрудники компании Contoso выбирают ценовую категорию, размер вычислений и хранилище для экземпляра. Дополнительные сведения см. в статье [Цены на Базу данных SQL Azure ](https://azure.microsoft.com/pricing/details/sql-database/managed/).

    ![Управляемый экземпляр](media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. После развертывания Управляемого экземпляра отображается два новых ресурса в группе ресурсов **ContosoRG**.

    - Виртуальный кластер, если у Contoso есть несколько Управляемых экземпляров.
    - Управляемый экземпляр Базы данных SQL Azure. 

    ![Управляемый экземпляр](media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

*Нужна дополнительная помощь?*

См. в разделе [Создание управляемого экземпляра базы данных SQL Azure на портале Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal).

## <a name="step-2-prepare-the-database-management-service"></a>Шаг 2. Подготовка Службы управления базами данных

Чтобы подготовить Службу управления базами данных, компании Contoso необходимо выполнить ряд действий.

- Зарегистрировать поставщик Службы управления базами данных в Azure.
- Предоставить Службе управления базами данных доступ к службе хранилища Azure для передачи файлов резервных копий, применяемый для миграции базы данных. Чтобы предоставить доступ к службе хранилища Azure, компания Contoso создает контейнер хранилища BLOB-объектов Azure. Компания Contoso создает URI SAS для контейнера хранилища BLOB-объектов. 
- Создается проект Службы управления базами данных.

После этого компания выполняет следующие действия.

1. Компания Contoso регистрирует поставщик службы миграции баз данных в своей подписке.
    ![Служба управления базами данных — регистрация](media/contoso-migration-rehost-vm-sql-managed-instance/dms-subscription.png)

2. Компания Contoso создает контейнер хранилища BLOB-объектов. Компания Contoso создает URI SAS, таким образом, чтобы Служба управления базами данных имела к нему доступ.

    ![Служба управления базами данных — создание URI SAS](media/contoso-migration-rehost-vm-sql-managed-instance/dms-sas.png)

3. Компания Contoso создает экземпляр Службы управления базами данных. 

    ![Служба управления базами данных — создание экземпляра](media/contoso-migration-rehost-vm-sql-managed-instance/dms-instance.png)

4. Компания Contoso размещает экземпляр Службы управления базами данных в подсеть **PROD-DC-EUS2** виртуальной сети **VNET-PROD-DC-EUS2**.
    - Компания размещает Службу управления базами данных там, так как служба должна быть в виртуальной сети с доступом к локальной виртуальной машине SQL Server через VPN-шлюз.
    - Виртуальная сеть **PROD-EUS2** участвует в пиринге с виртуальной сетью **HUB-EUS2** и ей разрешено использовать удаленные шлюзы. Параметр **Use remote gateways** (Использование удаленных шлюзов) гарантирует, что Служба управления базами данных может при необходимости обмениваться данными.

        ![Служба управления базами данных – настройка сети](media/contoso-migration-rehost-vm-sql-managed-instance/dms-network.png)

*Нужна дополнительная помощь?*

- Узнайте, как [настроить службу управления базами данных](https://docs.microsoft.com/azure/dms/quickstart-create-data-migration-service-portal).
- Узнайте, как [создать и использовать подписанный URL-адрес](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).


## <a name="step-3-prepare-azure-for-the-site-recovery-service"></a>Шаг 3: Подготовка Azure для службы Site Recovery

Для компании Contoso несколько элементов Azure являются обязательными при настройке Site Recovery для миграции из веб-уровня виртуальной машины (**WEBMV**):

- виртуальная сеть, в которой при выполнении отработки отказа находятся ресурсы;
- учетная запись хранения для размещения реплицируемых данных; 
- хранилище служб восстановления в Azure.

Сотрудники компании Contoso настраивают Site Recovery следующим образом.

1. Так как эта виртуальная машина реализует веб-интерфейс приложения SmartHotel, они выполнят отработку отказа виртуальной машины существующей рабочей сети (**VNET-PROD-EUS2**) и подсети (**PROD-FE-EUS2**). Сеть и подсеть находятся в основном регионе "Восточная часть США 2". Компания Contoso настраивает сеть при [развертывании инфраструктуры Azure](contoso-migration-infrastructure.md).
2. Компания создает учетную запись хранилища (**contosovmsacc20180528**). Компания Contoso использует учетную запись общего назначения. Специалисты компании Contoso выбирают стандартное хранилище и локально избыточное хранилище репликации.

    ![Site Recovery — создание учетной записи хранения](media/contoso-migration-rehost-vm-sql-managed-instance/asr-storage.png)

3. С помощью сети и учетной записи хранения в одном месте, компания Contoso создает хранилище (**ContosoMigrationVault**). Специалисты компании Contoso помещают хранилище в группу ресурсов **ContosoFailoverRG**, в основном регионе "Восточная часть США 2".

    ![Службы восстановления – создание хранилища](media/contoso-migration-rehost-vm-sql-managed-instance/asr-vault.png)

*Нужна дополнительная помощь?*

См. в разделе [Подготовка ресурсов Azure для репликации локальных компьютеров](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure).


## <a name="step-4-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 4: Подготовка локальных ресурсов VMware для Site Recovery

Чтобы подготовить VMware для Site Recovery, компании Contoso необходимо выполнить эти задачи.

- Подготовить учетную запись на экземпляре сервера vCenter или узле vSphere ESXi. Учетная запись автоматизирует обнаружение виртуальной машины.
- Подготовить учетную запись для автоматической установки службы Mobility Service на каждой виртуальной машине VMware, которую компании Contoso необходимо реплицировать.
- Подготовить виртуальные машины в локальной среде, чтобы подключать их к виртуальным машинам Azure, когда они будут созданы после отработки отказа.


### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется как минимум учетная запись "Только для чтения".
- Управлять репликацией, отработкой отказа и восстановлением размещения. Компании Contoso необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Компания Contoso задает учетную запись, выполнив следующие задачи.

1. Создает роль на уровне vCenter.
2. Назначает необходимые разрешения для этой роли.

*Нужна дополнительная помощь?*

См. в разделе [Подготовка учетной записи для автоматического обнаружения](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery).

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на виртуальной машине, которую Contoso хочет реплицировать. Компания Contoso рассматривает следующие факторы службы Mobility Service.

- Site Recovery может автоматически принудительно устанавливать этот компонент, когда Contoso включает репликацию для виртуальной машины.
- Для автоматической принудительной установки компании необходимо подготовить учетную запись, которую Site Recovery использует для доступа к виртуальной машине.
- Компания Contoso указывает эту учетную запись при настройке репликации в консоли Azure.
- Компания должна иметь домен или локальную учетную запись с разрешениями для установки на виртуальной машине.

*Нужна дополнительная помощь*

См. в разделе [Подготовка учетной записи к установке службы Mobility Service](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation).

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Компании Contoso необходимо, чтобы после отработки отказа в Azure была возможность подключения к реплицированным виртуальным машинам в Azure. Чтобы подключиться к реплицируемым виртуальным машинам в Azure, специалистам компании Contoso необходимо выполнить несколько задач на локальной виртуальной машине перед миграцией. 

1. Чтобы получить доступ к Интернету, Contoso включает RDP на локальных виртуальных машинах перед отработкой отказа. Компания Contoso убеждается в том, что правила для протоколов TCP и UDP для **общедоступного** профиля добавлены, а протокол RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.
2. Для доступа через VPN типа "сеть — сеть" Contoso включает RDP на локальном компьютере. Компания Contoso разрешает RDP в разделе **Брандмауэр Windows** > **Разрешенные приложения и компоненты** для **доменных и частных** сетей.
3. Компания на локальной виртуальной машине задает политике SAN операционной системы значение **OnlineAll**.

Специалистам компании Contoso необходимо проверить эти элементы при запуске отработки отказа.

- Когда отработка отказа запущена, на виртуальной машине не должно быть обновлений Windows, ожидающих установки. Если обновления Windows ожидают установки, компании Contoso не удастся войти в виртуальную машину до завершения обновления.
- После отработки отказа компании следует проверить данные **диагностики загрузки**, чтобы увидеть снимок виртуальной машины. Если специалисты компании Contoso не могут просмотреть диагностические сведения о загрузке, они должны проверить работает ли виртуальная машина и просмотреть [советы по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

## <a name="step-5-replicate-the-on-premises-vms-to-azure-by-using-site-recovery"></a>Шаг 5. Репликация локальных виртуальных машин в Azure с использованием Site Recovery

Перед выполнением миграции в Azure компании Contoso необходимо настроить и применить репликацию для локальных виртуальных машин.

### <a name="set-a-replication-goal"></a>Выбор цели репликации

1. В хранилище в разделе с именем хранилища (**ContosoVMVault**) специалисты компании настраивают цель репликации (**Начало работы** > **Site Recovery** > **Подготовка инфраструктуры**).
2. Они указывают, что компьютеры размещены локально и являются виртуальными машинами VMware и хотят реплицировать их в Azure.

    ![Подготовка инфраструктуры – цель защиты](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Чтобы продолжить, компании Contoso необходимо подтверждение о завершении планирования развертывания. Чтобы подтвердить, компания Contoso выбирает **Да, я сделал это**. В этом развертывании компания Contoso переносит только одну виртуальную машину, поэтому планирование развертывания не требуется.

### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Теперь специалистам компании Contoso необходимо настроить свою исходную среду. Чтобы настроить среду источника, они загружают шаблон OVF. Компания Contoso использует шаблон для развертывания сервера конфигурации и его связанные компоненты в качестве локальной виртуальной машины VMware с высокой доступностью. К компонентам на сервере относятся:

- Сервер конфигурации, используемый для управления обменом данными между локальной инфраструктурой и Azure. Сервер конфигурации управляет репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Функции сервера обработки.
    - Получает данные репликации.
    - Оптимизирует данные репликации с помощью кэширования, сжатия и шифрования.
    - Отправляет данные репликации в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые компании Contoso необходимо реплицировать. Сервер обработки автоматически обнаруживает локальные виртуальные машины VMware.
- После создания и запуска конфигурации сервера виртуальной машины компания Contoso регистрирует сервер в хранилище.

Для настройки исходной среды необходимо следующее.

1. Специалисты компании Contoso скачивают шаблон OVF на портале Azure (**Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**).
    
    ![Добавление сервера конфигурации](./media/contoso-migration-rehost-vm-sql-managed-instance/add-cs.png)

2. Они импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Развертывание шаблона OVF](./media/contoso-migration-rehost-vm-sql-managed-instance/vcenter-wizard.png)

3.  Когда компания Contoso включает виртуальную машину впервые, она запускается в среде установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. После установки они входят в виртуальную машину от имени администратора. Когда компания Contoso выполняет вход на виртуальную машину, автоматически запускается средство конфигурации Azure Site Recovery.
5. В средстве конфигурации Site Recovery компания Contoso вводит имя, используемое для регистрации сервера конфигурации в хранилище.
6. Средство проверяет подключение виртуальной машины к Azure. После установки подключения компания Contoso выбирает **Вход**, чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором регистрируется сервер конфигурации. 

    ![Регистрация сервера конфигурации](./media/contoso-migration-rehost-vm-sql-managed-instance/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается. Компания Contoso снова выполняет вход на компьютер. Мастер управления сервером конфигурации запустится автоматически.
8. В мастере компании Contoso необходимо выбрать сетевой адаптер для приема трафика репликации. Этот параметр нельзя изменить после настройки.
9. Далее специалисты компании Contoso выбирают подписку, группу ресурсов и хранилище Служб восстановления для регистрации сервера конфигурации.

    ![Выбор хранилища Служб восстановления](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz1.png)

10. Специалисты компании загружают и устанавливают MySQL Server и VMWare PowerCLI. Затем они проверяют настройки сервера.
11. После проверки они указывают полное доменное имя или IP-адрес сервера экземпляра vCenter Server. Компания Contoso оставляет порт по умолчанию и вводит отображаемое имя для экземпляра сервера vCenter в Azure.
12. Компании необходимо задать учетную запись, которая была создана ранее, таким образом Site Recovery может автоматически обнаруживать виртуальные машины VMware, доступные для репликации. 
13. Специалисты компании Contoso вводят учетные данные для автоматической установки службы Mobility Service, если включена репликация. Чтобы можно было работать с компьютерами ОС Windows, учетная запись должна иметь права локального администратора виртуальных машин. 

    ![Настройка vCenter Server](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz2.png)

7. По окончании регистрации на портале Azure сотрудники компании Contoso повторно проверяют, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. Обнаружение может занять 15 минут или более. 
8. Site Recovery подключается к серверам VMware, используя указанные параметры. Site Recovery обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь компании Contoso необходимо настроить целевую среду репликации.

1. Она выбирает **Подготовка инфраструктуры** > **Целевая платформа** и задает параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения и сети в указанной целевой среде.

### <a name="create-a-replication-policy"></a>Создание политики репликации

После настройки исходной и целевой сред компания Contoso создает политику репликации и связывает ее с сервером конфигурации.

1. В разделе **Подготовка инфраструктуры** > **Параметры репликации** > **Политика репликации** >  **Создание и сопоставление** специалисты компании создают политику **ContosoMigrationPolicy**.
2. При этом они используют параметры по умолчанию.
    - **Пороговое значение RPO**. По умолчанию используется значение 60 минут. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Период удержания точек восстановления**. По умолчанию составляет 24 часа. Этим значением определяется продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность создания моментальных снимков с согласованием приложений**. По умолчанию составляет 1 час. Это значение указывает частоту, с которой система создает моментальные снимки приложений.
 
    ![Политика репликации – создание](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy.png)

3. Политика автоматически сопоставляется с сервером конфигурации. 

    ![Политика репликации – сопоставление](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy2.png)

*Нужна дополнительная помощь?*

- Полное пошаговое руководство для этих трех шагов см. в статье [Подготовка локальных серверов VMware для аварийного восстановления в Azure](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).

### <a name="enable-replication"></a>Включение репликации

Теперь сотрудники Contoso могут запустить репликацию WebVM.

1. В разделе **Репликация приложений** > **Источник** > **Выполнить репликацию** они настраивают параметры источника.
2. Компания Contoso показывает намерение включить виртуальные машины, выбирает экземпляр сервера vCenter Server и настраивает его.

    ![Включение репликации – источник](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication1.png)
 
3. Компания Contoso указывает параметры целевых объектов, включая группу ресурсов и сеть, в которой будет размещаться виртуальная машина Azure после отработки отказа. Компания Contoso указывает учетную запись хранения, в которой будут храниться реплицированные данные.

    ![Включение репликации – целевой объект](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication2.png)

4. Компания Contoso выбирает **WebVM** для репликации. Site Recovery установит службу Mobility Service на каждую виртуальную машину, если репликация включена. 

    ![Включение репликации – выбор виртуальной машины](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication3.png)

5. Компания Contoso проверяет правильность выбора репликации. Затем она включает репликацию для **WEBVM**. Специалисты компании Contoso отслеживают ход репликации в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.
6. В разделе **Основное** на портале Azure специалисты компании Contoso могут просматривать структуру виртуальных машин, реплицируемых в Azure.

    ![Представление инфраструктуры](./media/contoso-migration-rehost-vm-sql-managed-instance/essentials.png)

*Нужна дополнительная помощь?*

Полное пошаговое руководство для этих шагов см. в статье [Включение репликации в Azure для виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).

## <a name="step-6-migrate-the-database-by-using-the-database-management-service"></a>Шаг 6. Миграция базы данных с помощью Службы управления базой данных

Компании Contoso необходимо создать проект Службы управления базами данных,а затем перенести базу данных.

### <a name="create-a-database-management-service-project"></a>Создание проекта Службы управления базами данных

1. Компания Contoso создает проект Службы управления базами данных. Компания Contoso выбирает тип исходного сервера **SQL Server**. Компания Contoso выбирает целевым объектом **Управляемый экземпляр Базы данных SQL Azure**.

     ![Служба управления базами данных — новый проект миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-project.png)

2. Откроется мастер миграции.

### <a name="migrate-the-database"></a>Миграция базы данных 

1. В мастере миграции компания Contoso указывает исходную виртуальную машину, на которой находится локальная база данных. Компания Contoso вводит учетные данные для доступа к базе данных.

    ![Служба управления базами данных — сведения об источнике](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-source.png)

2. Сотрудники компании Contoso выбирают базу данных для выполнения миграции (**SmartHotel.Registration**).

    ![Служба управления базами данных — выбор источника базы данных](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-sourcedb.png)

3. Для целевого объекта компания Contoso вводит имя Управляемого экземпляра в Azure. Компания вводит учетные данные для доступа к Управляемому экземпляру.

    ![Служба управления базами данных — сведения о целевом объекте](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-target-details.png)

4. В разделе **Новое действие** > **Запустить миграцию** компания указывает параметры для выполнения миграции.
    - Источник и цель учетных данных.
    - База данных для переноса.
    - Общий сетевой ресурс, созданный компанией Contoso на локальной виртуальной машине. Служба управления базами данных создает резервные копии источника для этого ресурса. 
        - Учетная запись службы, которая выполняет исходный экземпляр SQL Server, должна иметь права записи для этой общей папки.
        - Должен использоваться полный путь FQDN к общей папке.
    - URI SAS, который позволяет Службе управления базами данных обращаться к контейнеру учетной записи хранения для отправки файлов резервных копий для миграции.

        ![Служба управления базами данных — настройка параметров миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-migration-settings.png)

5. Компания Contoso сохраняет миграцию и затем запускает ее.
6. В разделе **Обзор** она отслеживает состояние миграции.

    ![Служба управления базами данных — монитор](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor1.png)

7. После завершения миграции специалисты компании Contoso убеждаются, что целевые базы данных существуют в Управляемом экземпляре.

    ![Служба управления базами данных — проверка миграции базы данных](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor2.png)

## <a name="step-7-migrate-the-vm-by-using-site-recovery"></a>Шаг 7. Миграция виртуальной машины с помощью Site Recovery

Специалисты компании Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Перед выполнением миграции WEBVM тестовая отработка отказа позволяет убедиться в том, что все работает как надо. Компания выполняет следующие действия.

1. Специалисты компании Contoso запускают тестовую отработку отказа для последнего доступного момента времени (**Последняя отработанная**).
2. Они выбирают **Завершение работы виртуальной машины перед началом отработки отказа**. С помощью выбранной опции Site Recovery попытается выключить исходную виртуальную машину перед запуском отработки отказа. Отработка отказа продолжится даже если их не удастся отключить. 
3. При тестировании отработки отказа происходит следующее: 
    1. выполняется проверка на соблюдение всех необходимых условий для миграции;
    2. обрабатываются данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе этих данных создается точка восстановления;
    3.  создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.
3. Когда отработка отказа завершается, на портале Azure появится реплика виртуальной машины. Компания Contoso проверяет, что все работает правильно: виртуальная машина имеет соответствующий размер, она подключена к правильной сети и работает. 
4. После проверки тестовой отработки отказа Contoso удаляет результаты отработки отказа. Затем компания записывает и сохраняет любые наблюдения. 

### <a name="migrate-the-vm"></a>Миграция виртуальной машины

1. Убедившись, что тестовая отработка отказа выполнена правильно, специалисты компании Contoso создают план восстановления для миграции. Они добавляют в план WEBVM.

     ![Создание плана восстановления — выбор элементов](./media/contoso-migration-rehost-vm-sql-managed-instance/recovery-plan.png)

2. Специалисты компании выполняют для этого плана отработку отказа. Они обозначают последнюю точку восстановления. Они указывают, что Site Recovery должен попытаться завершить работу локальной виртуальной машины прежде, чем запустится отработка отказа.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-managed-instance/failover1.png)

3. После отработки отказа специалисты Contoso проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

   ![Сведения о плане восстановления](./media/contoso-migration-rehost-vm-sql-managed-instance/failover2.png)

4. После проверки виртуальной машины в Azure они завершают процесс миграции, останавливают репликацию для виртуальной машины и останавливают начисление оплаты Site Recovery за виртуальную машину.

    ![Отработка отказа — завершение миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

На последнем этапе процесса миграции компания Contoso обновляет строку подключения приложения, чтобы указать на перенесенную базу данных, запущенную в Управляемом экземпляре Contoso.

1. На портале Azure компания найдет строку подключения, выбрав **Параметры** > **Строки подключения**.

    ![Строки подключения](./media/contoso-migration-rehost-vm-sql-managed-instance/failover4.png)  

2. Компания Contoso обновляет строку с именем пользователя и паролем Управляемого экземпляра Базы данных SQL.
3. После настройки строки Contoso заменяет текущую строку подключения в файле web.config приложения.
4. После обновления файла и его сохранения Contoso перезапускает IIS на WEBVM. Чтобы перезапустить службы IIS, специалисты компании Contoso запускают `IISRESET /RESTART` в окне командной строки.
5. После перезапуска служб IIS приложение использует базу данных, запущенную в Управляемом экземпляре Базы данных SQL.
6. На этом этапе компания Contoso может завершить работу локальной машины SQLVM. Миграция завершена.

*Нужна дополнительная помощь?*

- См. в разделе [Выполнение отработки аварийного восстановления в Azure](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure). 
- См. в разделе [Создание и настройка планов восстановления](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans).
- См. в разделе [Отработка отказа в Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover).

## <a name="clean-up-after-migration"></a>Очистка после миграции

После завершения миграции приложение SmartHotel, которое выполнялось на виртуальной машине Azure и базе данных SmartHotel, доступно в Управляемом экземпляре Базы данных SQL Azure.  

Теперь компании Contoso потребуется предпринять следующее задачи очистки.  

- Удалить машину WEBVM из реестра сервера vCenter Server.
- Удалить машину SQLVM из реестра сервера vCenter Server.
- Удалить машины WEBVM и SQLVM из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса WEBVM.
- Удалить SQLVM из внутренней документации. Кроме того компания Contoso может пересмотреть документацию, чтобы показать, что SQLVM удалена и больше не находится в реестре виртуальной машины.
- Просмотреть все ресурсы, которые взаимодействуют с выведенными из эксплуатации виртуальными машинами. Обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности Contoso рассматривают виртуальные машины Azure и Управляемый экземпляр Базы данных SQL, чтобы проверить проблемы безопасности и их реализацию.

- Команда безопасности проверяет группы безопасности сети, которые используются для управления доступом к виртуальной машине. Группы безопасности сети помогают убедиться, что только разрешенный трафик можно передавать в приложение.
- Команда безопасности Contoso также анализирует возможность защиты данных на диске с помощью шифрования дисков Azure и Key Vault Azure.
- Команда безопасности включает обнаружение угроз в управляемом экземпляре. Обнаружение угроз передает оповещения в службу безопасности или службу поддержки Contoso для открытия билета, если обнаружена угроза. Дополнительные сведения см. в разделе [Обнаружение угроз в управляемом экземпляре Базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-threat-detection).

     ![Безопасность Управляемого экземпляра — обнаружение угроз](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-security.png)  

Дополнительные сведения см. в разделе [Рекомендации по безопасности для рабочих нагрузок IaaS в Azure](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control).

### <a name="backups"></a>Резервные копии

Компания Contoso выполняет резервное копирование данных, содержащихся в WEBVM, с помощью службы Azure Backup. Дополнительные сведения см. в разделе [Общие сведения о возможностях в службе архивации Azure](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- Компания Contoso имеет существующие лицензирование для WEBVM. Чтобы воспользоваться преимуществами цен предложения "Преимущества гибридного использования Azure", компания Contoso преобразует существующую виртуальную машину Azure.
- Компания использует Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Управление затратами — это решение по управлению затратами в многих облачных службах, которое помогает компании Contoso использовать и управлять Azure и другими облачными ресурсами. Дополнительные сведения см. в разделе [Что такое Azure Cost Management?](https://docs.microsoft.com/azure/cost-management/overview). 


## <a name="conclusion"></a>Заключение

В этой статье рассказано, как компания Contoso повторно размещает приложение SmartHotel в Azure путем миграции виртуальных машин внешнего интерфейса приложения в Azure с помощью службы Site Recovery. Как компания Contoso выполняет миграцию локальной базы данных в Управляемый экземпляр Базы данных SQL Azure с помощью службы Azure Database Management Service.

## <a name="next-steps"></a>Дополнительная информация

В следующей статье из этой серии компания Contoso [повторно размещает приложение SmartHotel на виртуальных машинах Azure](contoso-migration-rehost-vm.md) с использованием службы Azure Site Recovery.

