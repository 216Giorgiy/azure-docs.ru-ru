---
title: Повторное размещение локального приложения компании Contoso путем перехода на виртуальную машину Azure и Управляемый экземпляр Базы данных SQL Azure | Документация Microsoft
description: В этой статье рассказывается о том, как компания Contoso перемещает локальное приложение в виртуальные машины Azure и в управляемый экземпляр SQL Azure
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 07/12/2018
ms.author: raynew
ms.openlocfilehash: 49a5fb13a881b206c36dcd08a4c2945880e9a4bd
ms.sourcegitcommit: e0a678acb0dc928e5c5edde3ca04e6854eb05ea6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/13/2018
ms.locfileid: "39002302"
---
# <a name="contoso-migration-rehost-an-on-premises-app-on-azure-vms-and-azure-sql-managed-instance"></a>Миграция Contoso: повторное размещение локального приложения на виртуальных машинах Azure и в Управляемом экземпляре Базы данных SQL Azure

В этой статье показано, как Contoso осуществляет миграцию ВМ интерфейсной части приложения SmartHotel в виртуальные машины Azure с помощью службы Azure Site Recovery и базы данных приложения в управляемый экземпляр базы данных SQL Azure.

> [!NOTE]
> Управляемый экземпляр SQL Azure в настоящее время находится в состоянии предварительной версии.

Это документ из цикла статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. Этот цикл содержит общие сведения и набор сценариев, которые иллюстрируют настройку инфраструктуры миграции и выполнение миграций различных типов. Сценарии излагаются в порядке роста сложности. Со временем мы добавим в этот цикл и другие статьи.


**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Предоставляет общие сведения о стратегии миграции Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Здесь рассказывается о том, как Contoso готовит свою локальную инфраструктуру Azure для миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
[Статья 3. Оценка готовности локальных ресурсов к переносу в Azure](contoso-migration-assessment.md)  | В этой статье рассказывается, как компания Contoso выполняет оценку своего локального двухуровневого приложения SmartHotel в VMware. Для оценки виртуальных машин приложения компания Contoso использует службу [Миграция Azure](migrate-overview.md). Для оценки базы данных SQL Server приложения используется [помощник по миграции баз данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
Статья 4. Повторное размещение приложения на виртуальных машинах Azure и в Управляемом экземпляре Базы данных SQL | В этой статье демонстрируется, как Contoso выполняет процесс миграции локального приложения SmartHotel в Azure по методу lift-and-shift. Contoso переносит интерфейсную ВМ приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Базу данных приложения она переносит в управляемый экземпляр SQL с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Эта статья.
[Статья 5. Повторное размещение приложения на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | В статье описывается, как компания Contoso переносит виртуальные машины приложения SmartHotel на виртуальные машины Azure с помощью службы Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группе доступности SQL Server Always On](contoso-migration-rehost-vm-sql-ag.md) | Здесь показан выполняемый в Contoso процесс миграции приложения SmartHotel. Contoso использует Site Recovery для переноса ВМ приложений и службы миграции баз данных для миграции базы данных приложения в кластер SQL Server, защищенный группой доступности AlwaysOn. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Здесь показано, как компания Contoso осуществляет миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и в Azure MySQL](contoso-migration-rehost-linux-vm-mysql.md) | В этой статье рассказывается, как компания Contoso выполняет миграцию приложения Linux osTicket на виртуальные машины Azure с помощью Site Recovery и миграцию базы данных приложения в экземпляр Azure MySQL Server с помощью MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения в веб-приложениях Azure и Базе данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | В статье описывается, как Contoso переносит приложение SmartHotel в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Доступна
[Статья 10. Рефакторинг приложения Linux в веб-приложениях Azure и Azure MySQL](contoso-migration-refactor-linux-app-service-mysql.md) | В статье описывается, как Contoso переносит приложение osTicket для Linux в веб-приложения Azure на нескольких сайтах, интегрированных с GitHub для непрерывной поставки. База данных приложения переносится в экземпляр Azure MySQL. | Доступна
[Статья 11. Рефакторинг TFS в VSTS](contoso-migration-tfs-vsts.md) | В этой статье показано, как Contoso переносит локальное развертывание Team Foundation Server (TFS) в Visual Studio Team Services (VSTS) в Azure. | Доступна
[Статья 12. Перепроектирование приложения для использования контейнеров Azure и Базы данных SQL Azure](contoso-migration-rearchitect-container-sql.md) | В статье описывается, как Contoso переносит и перепроектирует приложение SmartHotel в Azure. Специалисты компании перепроектируют веб-уровень приложения в контейнер Windows и переносят базу данных приложения в Базу данных SQL Azure. | Доступна
[Статья 13. Повторное создание приложения в Azure](contoso-migration-rebuild.md) | В статье описывается, как Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, Функции Azure, Cognitive Services и Cosmos DB. | Доступна


Если вы хотите использовать пример приложения SmartHotel, используемого в этой статье, его можно загрузить с [github](https://github.com/Microsoft/SmartHotel360).

## <a name="on-premises-architecture"></a>Локальная архитектура

На схеме ниже показана текущая локальная инфраструктура компании Contoso.

![Архитектура Contoso](./media/contoso-migration-rehost-vm-sql-managed-instance/contoso-architecture.png)  

- У Contoso есть один основной центр обработки данных в Нью-Йорке (на востоке Соединенных Штатов Америки).
- У компании есть еще три местных филиала в других уголках США.
- Основной центр обработки данных подключается к Интернету с помощью оптоволоконного соединения Metro Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединения бизнес-класс и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Это обеспечивает постоянство подключения всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. В нем используется два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Для управления удостоверениями в Contoso используется Active Directory, а во внутренней сети применяются DNS-серверы.
- Контроллеры домена в центре обработки данных размещены в виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.



## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Вызов роста бизнеса**. По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.
- **Повышение эффективности**. Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для своих разработчиков и пользователей.  Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso нуждается в большей гибкости в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования.  Он не должен мешать или становиться помехой для бизнеса.
- **Масштабирование**. По мере того как бизнес успешно растет, ИТ-отдел компании Contoso должен предоставлять системы, способные расти с тем же темпом.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели используются для определения оптимального метода миграции.

- После миграции в Azure приложение должно иметь те же возможности с точки зрения производительности, что и в текущей локальной среде VMWare.  Переход в облако не означает, что производительность приложения сильно уменьшится.
- Contoso не считает нужным вкладывать средства в это приложение.  Это критически важно для бизнеса, но компании просто нужно переместить его в облако в его текущей форме.
- Задачи администрирования базы данных должны быть минимальными после переноса приложения.
- Компания Contoso не хочет использовать базу данных SQL Azure для этого приложения и ищет альтернативы.

## <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Компания Contoso намерена перенести свое локальное двухуровневое приложение.
- Приложение расположено на нескольких виртуальных машинах (WEBVM и SQLVM) и находится на узле VMware ESXi **contosohost1.contoso.com** (версия 6.5)
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Они переносят базу данных приложения (SmartHotelDB) в управляемый экземпляр SQL Azure.
- Они переносят локальные виртуальные машины VMware в виртуальную машину Azure.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](media/contoso-migration-rehost-vm-sql-managed-instance/architecture.png) 

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Служба управления базами данных](https://docs.microsoft.com/azure/dms/dms-overview) | DMS обеспечивает прозрачную миграцию из нескольких источников баз данных на платформы данных Azure с минимальным временем простоя. | Дополнительные сведения о [поддерживаемых областях](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) DMS и [сведения о ценах](https://azure.microsoft.com/pricing/details/database-migration/).
[Управляемый экземпляр SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | Управляемый экземпляр — это служба управляемой базы данных, которая представляет полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | За использование управляемых экземпляров базы данных SQL Azure, выполняемых в Azure, взимается плата на основе емкости. [Узнайте больше](https://azure.microsoft.com/pricing/details/sql-database/managed/). 
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | Служба организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов.  | Во время репликации в Azure взимается плата за службу хранилища Azure.  При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery/).

 

## <a name="migration-process"></a>Процесс миграции

Компания Contoso перенесет уровни данных и веб-приложения SmartHotel в Azure.

1. У компании уже есть инфраструктура Azure, поэтому ей необходимо добавить всего пару специальных компонентов Azure в свой сценарий.
2. Уровни данных будут перенесены с помощью службы Database Migration Service (DMS).  DMS подключается к локальной виртуальной машине сервера SQL через VPN-подключение типа "сайт — сайт" между центром обработки данных Contoso и Azure, а затем выполняет миграцию базы данных.
3. Миграция веб-уровеня будет выполнена с помощью миграции lift-and-shift совместно с Azure Site Recovery. Это подготовит локальную среду VMware, настроит и включит репликацию, а также осуществит миграцию виртуальных машин в Azure.

     ![Архитектура миграции](media/contoso-migration-rehost-vm-sql-managed-instance/migration-architecture.png) 


## <a name="prerequisites"></a>Предварительные требования

Ниже приведены действия Contoso (и Ваши), необходимые для этого сценария.

**Требования** | **Дополнительные сведения**
--- | ---
**Регистрация в предварительной версии** | Вы должны зарегистрироваться в ограниченной общедоступной предварительной версии управляемого экземпляра SQL. Чтобы [зарегистрироваться](https://portal.azure.com#create/Microsoft.SQLManagedInstance), необходима подписка Azure. Регистрация может занять несколько дней, поэтому ее необходимо выполнить перед началом работы с этим сценарием развертывания.
**Подписка Azure.** | Вы должны были создать подписку, когда выполняли внутреннюю оценку в первой статье этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](../site-recovery/site-recovery-role-based-linked-access-control.md). 
**Site Recovery (локальный экземпляр)** | Потребуется локальный сервер vCenter Server версии 5.5, 6.0 или 6.5.<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).<br/><br/> Поддерживаемая конфигурация [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилища](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage).
**DMS** | Для DMS необходимо [совместимое локальное VPN-устройство](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).<br/><br/> Необходимо настроить локальное VPN-устройство. Оно должно иметь внешний IPv4-адрес с внешним доступом. Адрес не может находиться за NAT-устройством.<br/><br/> Убедитесь, что у вас есть доступ к локальной базе данных SQL Server.<br/><br/> Брандмауэр Windows должен иметь доступ к ядру исходной СУБД. [Узнайте больше](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).<br/><br/> Если перед вашим компьютером базы данных есть брандмауэр, добавьте правила, разрешающие доступ к базе данных и файлам через SMB-порт 445.<br/><br/> Учетные данные, используемые для подключения к исходному серверу SQL Server и целевому Управляемому экземпляру, должны принадлежать к серверной роли sysadmin.<br/><br/> Вам нужна сетевая папка в вашей локальной базе данных, которую DMS может использовать для резервного копирования базы данных-источника.<br/><br/> Убедитесь, что учетная запись службы, от имени которой выполняется исходный экземпляр SQL Server, имеет права на запись для этой сетевой папки.<br/><br/> Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Служба Azure Database Migration Service олицетворяет пользователя с этими учетными данными, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure.<br/><br/> В процессе установки SQL Server Express для протокола TCP/IP устанавливается **отключенное состояние** по умолчанию. Убедитесь, что он включен.


## <a name="scenario-steps"></a>Шаги выполнения сценария

Настройка развертывания Contoso будет осуществляться следующим образом:

> [!div class="checklist"]
> * **Шаг 1. Настройка управляемого экземпляра SQL Azure**. Необходимо предварительно создать управляемый экземпляр, в который будет переноситься локальная база данных SQL Server.
> * **Шаг 2. Подготовка DMS**. Нужно зарегистрировать поставщика службы миграции базы данных, создать экземпляр, а затем создать проект DMS. Также нужно настроить SA URI для DMS. URI подписанного URL-адреса (SAS) предоставляет делегированный доступ к ресурсам в учетной записи хранения, что позволяет предоставлять ограниченные разрешения на объекты хранения. Они настроят URI SAS, чтобы DMS могла получить доступ к контейнеру учетной записи хранения, в который служба отправляет файлы архивации SQL Server.
> * **Шаг 3. Подготовка Azure для Site Recovery**. Они должны создать учетную запись хранения Azure для хранения реплицируемых данных и хранилище служб восстановления.
> * **Шаг 4. Подготовка локальных ресурсов VMware для Site Recovery**. Компания Contoso подготовит учетные записи для обнаружения виртуальных машин и установки агента, а также подготовится к подключению к виртуальным машинам Azure после отработки отказа.
> * **Шаг 5. Репликация виртуальных машин**. Чтобы настроить репликацию, специалисты компании Contoso настроят исходную и целевую среды Site Recovery, установят политику репликации и запустят репликацию виртуальных машин в хранилище Azure.
> * **Шаг 6. Миграция базы данных с помощью DMS**. Теперь они могут выполнить миграцию базы данных.
> * **Шаг 7. Миграция виртуальных машин с использованием Site Recovery**. Специалисты компании Contoso выполняют тестовую отработку отказа для проверки надлежащей работы всех компонентов, а затем выполняют полную отработку отказа для миграции виртуальных машин в Azure.


## <a name="step-1-prepare-an-azure-sql-managed-instance"></a>Шаг 1. Подготовка управляемого экземпляра SQL Azure

Чтобы настроить управляемый экземпляр SQL Azure, компании Contoso требуется подсеть:

- Подсеть должна быть выделенной. Она должна быть пустой, не должна содержать другие облачные службы и не должна быть подсетью шлюза.
- После создания управляемого экземпляра не добавляйте ресурсы в нее.
- С подсетью не должны быть связаны группы безопасности сети.
- Подсеть должна иметь пользовательскую таблицу маршрутов (UDR) с интернет-маршрутом следующего прыжка 0.0.0.0/0, который должен быть единственным назначенным ей маршрутом. 
- Наличие необязательной пользовательской DNS. Если в виртуальной сети определена пользовательская DNS, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (хранилище или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. [Дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances) об изменениях размера подсети управляемого экземпляра.
- В этой гибридной среде требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns) о настройке DNS.

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

В компании Contoso настраивают виртуальную сеть указанным ниже образом. 

1. Компания Contoso создает новую виртуальную сеть (VNET SQLMI EU2) в основном регионе "Восточная часть США 2", в группе ресурсов ContosoNetworkingRG.
2. Специалисты компании Contoso назначают адресное пространство 10.235.0.0/24, гарантируя, что диапазон не пересекается с другими сетями корпорации Contoso.
2. Они добавят к сети две подсети:
    - SQLMI-DS-EUS2 (10.235.0.0.25)
    - SQLMI-SAW-EUS2 (10.235.0.128/29). Эта подсеть будет использоваться для присоединения каталога в управляемом экземпляре (SQLMI).

    ![Сеть управляемого экземпляра](media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

6. После развертывания виртуальной сети и подсетей, компания Contoso создает распределение сетей следующим образом:

    - Согласовывает ранг виртуальных сетей SQLMI-EUS2 и HUB-EUS2 (центр виртуальной сети для восточной части США 2).
    - Согласовывает ранг виртуальных сетей SQLMI-EUS2 и PROD-EUS2 (рабочей сети).

    ![Пиринг сетей](media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

7. Компания Contoso задает пользовательские параметры DNS. DNS сначала будет указывать на контроллеры домена Azure. DNS Azure будет вторичной. Контроллеры домена Contoso Azure находятся в:

    - подсети PROD-DC-EUS2 восточной части США 2 рабочей сети (виртуальной сети PROD EUS2).
    - Адрес CONTOSODC3: 10.245.42.4
    - Адрес CONTOSODC4: 10.245.42.5
    - Арбитр конфликтов DNS Azure: 168.63.129.16

     ![DNS в сети](media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

**Нужна дополнительная помощь?**

- [Обзор](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) управляемых экземпляров SQL Azure.
- [Дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#create-a-new-virtual-network-for-managed-instances) о создании виртуальной сети для управляемого экземпляра SQL.
- [Дополнительные сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering) о настройке пиринга.
- [Дополнительные сведения об](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-dns) обновлении параметров AD DNS Azure.



### <a name="set-up-routing"></a>Настройка маршрутизации

Поскольку управляемый экземпляр размещается в частной виртуальной сети, компании Contoso нужны таблицы маршрутизации для взаимодействия со службой управления Azure. Если он не может взаимодействовать со службой, которой он управляется – он становится недоступным.

- Таблица маршрутизации с набором правил (маршрутов), указывающих, как отправляемые пакеты с управляемого экземпляра должны маршрутизироваться в виртуальной сети.
- Таблица маршрутизации связывается с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, оставляя подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

1. Компания Contoso создает пользовательскую таблицу маршрутизации. В группе ресурсов ContosoNetworkingRG создается таблица маршрутизации.

    ![Таблица маршрутов](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. Чтобы соответствовать требованиям управляемого экземпляра, после завершения развертывания таблицы маршрутизации (MIRouteTable) компания Contoso добавляет маршрут с префиксом адреса 0.0.0.0/0 и **тип следующего прыжка**, устанавливаемого в **Интернет**.

    ![Префикс таблицы маршрутизации](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)
    
3. Компания Contoso связывает таблицы маршрутизации с подсетью SQLMI-DB-EUS2 (в сети VNET-SQLMI-EUS2). 

    ![Подсеть таблицы маршрутизации](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)
    
**Нужна дополнительная помощь?**

[Дополнительные сведения о](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal#create-new-route-table-and-a-route) настройке маршрутов для управляемого экземпляра.

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь компания Contoso может подготовить управляемый экземпляр базы данных SQL.

1. Так как управляемый экземпляр выступает как бизнес-приложения, компания Contoso развертывает его в основном регионе "Восточная часть США 2", в группе ресурсов ContosoRG 
2. Сотрудники компании Contoso выбирают ценовую категорию и размер вычислений и хранилища для экземпляра. [Дополнительные сведения](https://azure.microsoft.com/pricing/details/sql-database/managed/) о ценах.

    ![Управляемый экземпляр](media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. После развертывания управляемого экземпляра отображается два новых ресурса в группе ресурсов ContosoRG:

    - Виртуальный кластер, если у вас есть несколько управляемых экземпляров,
    - Экземпляр управляемого SQL Server. 

    ![Управляемый экземпляр](media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

**Нужна дополнительная помощь?**

[Дополнительные сведения о](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal) подготовке управляемого экземпляра.

## <a name="step-2-prepare-dms"></a>Шаг 2: Подготовка DMS

Чтобы подготовить DMS, компания Contoso должна выполнить несколько шагов:

- Зарегистрировать поставщика DMS в Azure
- Предоставить доступ к хранилищу Azure для передачи файлов резервных копий, применяемый для миграции базы данных DMS. Сотрудники компании Contoso делают это, создав контейнер хранилища больших двоичных объектов и формируют общий доступ подписи URI для него. 
- Создать проект DMS.


Завершение следующим образом:

1. Компания Contoso регистрирует поставщик службы миграции баз данных в своей подписке.
    ![Регистр DMS](media/contoso-migration-rehost-vm-sql-managed-instance/dms-subscription.png)

2. Сотрудники компании Contoso создают контейнер хранилища больших двоичных объектов и формирует универсальный код ресурса SAS, чтобы DMS был доступен.

    ![Универсальный код ресурса SAS](media/contoso-migration-rehost-vm-sql-managed-instance/dms-sas.png)

3. Наконец, они создают экземпляр DMS. 

    ![Экземпляр DMS](media/contoso-migration-rehost-vm-sql-managed-instance/dms-instance.png)

4. Компания Contoso размещает экземпляр DMS в подсеть PROD-DC-EUS2 виртуальной сети VNET-PROD-DC-EUS2.
    - Они размещают его там, так как он должен быть в виртуальной сети, для возможности получения доступа к локальной виртуальной машине SQL Server через VPN-шлюз.
    - Виртуальная сеть-PROD-EUS2 участвует в пиринге с виртуальной сетью HUB-EUS2 и ей разрешено использовать удаленные шлюзы.  Это обеспечивает подключение DMS при необходимости.

        ![Сеть DMS](media/contoso-migration-rehost-vm-sql-managed-instance/dms-network.png)

**Нужна дополнительная помощь?**
- [Дополнительные сведения](https://docs.microsoft.com/azure/dms/quickstart-create-data-migration-service-portal) о настройке DMS.
- [Дополнительные сведения](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2) о создании и использовании SAS.


## <a name="step-3-prepare-azure-for-the-site-recovery-service"></a>Шаг 3: Подготовка Azure для службы Site Recovery

Существует несколько элементов Azure, необходимые компании Contoso, чтобы настроить Site Recovery для миграции их веб-уровня виртуальных машин

- Виртуальная сеть, в которой при выполнении отработки отказа находятся ресурсы.
- Учетная запись хранения Azure для размещения реплицируемых данных. 
- хранилище служб восстановления в Azure.

Сотрудники компании Contoso настраивают Site Recovery следующим образом:

1. Так как эта виртуальная машина реализует веб-интерфейс приложения SmartHotel, они выполнят отработку отказа виртуальной машины существующей рабочей сети (VNET-PROD-EUS2) и подсети (PROD-FE-EUS2) в основном регионе "Восточная часть США 2". Они настраивают эту сеть при [развертывании инфраструктуры Azure](contoso-migration-infrastructure.md)
2. Они создают учетную запись хранилища Azure (contosovmsacc20180528). Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.

    ![Хранилище Site Recovery](media/contoso-migration-rehost-vm-sql-managed-instance/asr-storage.png)

3. Теперь у компании Contoso есть сеть и учетная запись хранения, поэтому ее специалисты могут приступать к созданию хранилища (ContosoMigrationVault) и поместить его в группу ресурсов ContosoFailoverRG в основном регионе "Восточная часть США 2".

    ![Хранилище служб восстановления](media/contoso-migration-rehost-vm-sql-managed-instance/asr-vault.png)

**Нужна дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) о настройке Azure для Site Recovery.


## <a name="step-4-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 4: Подготовка локальных ресурсов VMware для Site Recovery

Чтобы подготовить VMware для Site Recovery, компании Contoso необходимо сделать следующее:

- Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
- Подготовить учетную запись для автоматической установки службы Mobility Service на каждой виртуальной машине VMware, которую требуется реплицировать.
- Подготовить виртуальные машины в локальной среде, чтобы подключать их к виртуальным машинам Azure, когда они будут созданы после отработки отказа.


### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Contoso настраивает учетную запись следующим образом:

1. Создает роль на уровне vCenter.
2. Назначает необходимые разрешения для этой роли.

**Нужна дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) о создании и назначении роли для автоматического обнаружения.

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать.

- Site Recovery может автоматически принудительно устанавливать этот компонент при включении репликации для виртуальной машины.
- Для автоматической принудительной установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальной машине.
- Укажите эту учетную запись при настройке репликации в консоли Azure.
- Подготовьте домен или локальную учетную запись с разрешениями для установки на виртуальной машине.

**Нужна дополнительная помощь**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) о создании учетной записи для принудительной установки службы Mobility Service.


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Компании Contoso необходимо, чтобы после отработки отказа в Azure была возможность подключения к реплицированным виртуальным машинам в Azure. Для того чтобы это сделать, существуют несколько шагов, которые необходимо выполнить на локальной виртуальной машине, перед запуском миграции: 

1. Чтобы получить доступ через Интернет, специалисты компании включат протокол RDP на локальной виртуальной машине перед отработкой отказа, и проверят добавлены ли правила TCP и UDP в профиле **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.
2. Чтобы получить доступ через VPN-подключение типа "сеть — сеть", включите протокол RDP на локальном компьютере и разрешение протокола RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для **доменных и частных** сетей.
3. Они задают для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

Кроме того, при запуске отработки отказа им необходимо проверить указанные ниже аспекты.

- При запуске отработки отказа на виртуальной машине не должно быть обновлений Windows, ожидающих установки. Если они есть, они не смогут войти в виртуальную машину до завершения обновления.
- После отработки отказа следует проверить данные **диагностики загрузки**, чтобы увидеть снимок виртуальной машины. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).


## <a name="step-5-replicate-the-on-premises-vms-to-azure-with-site-recovery"></a>Шаг 5. Репликация локальных виртуальных машин в Azure с помощью Site Recovery

Перед выполнением миграции в Azure, компании Contoso необходимо настроить и применить репликацию для локальных виртуальных машин.

### <a name="set-a-replication-goal"></a>Выбор цели репликации

1. Целевой объект защиты задается в хранилище в разделе с его именем (ContosoVMVault) (**Приступая к работе** > **Site Recovery** > **Подготовка инфраструктуры**).
2. Специалисты Contoso указывают, что компьютеры размещены локально и являются виртуальными машинами VMware, а они хотят реплицировать их в Azure.

    ![Цель репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Для продолжения они должны подтвердить, что они завершили планирование развертывания. Для этого им необходимо щелкнуть пункт **Да, выполнено**. В этом развертывании компания Contoso переносит только одну виртуальную машину, поэтому планирование развертывания не требуется.

### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Теперь сотрудникам компании Contoso необходимо настроить свою исходную среду. Для этого они скачивают шаблон OVF и с его помощью развертывают сервер конфигурации и его связанные компоненты в качестве локальной виртуальной машины VMware с высокой доступностью. К компонентам на сервере относятся:

- Сервер конфигурации, используемый для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.
- После создания и запуска конфигурации сервера виртуальной машины компания Contoso может регистрировать его в хранилище.


Специалисты Contoso выполняют этот шаг следующим образом:

1. Они скачивают шаблон OVF на портале Azure (**Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**).
    
    ![Скачивание OVF](./media/contoso-migration-rehost-vm-sql-managed-instance/add-cs.png)

2. Они импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Шаблон OVF](./media/contoso-migration-rehost-vm-sql-managed-instance/vcenter-wizard.png)

3.  При первом включении виртуальная машина загружается в среду установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. После установки они входят в виртуальную машину от имени администратора. При первом входе в систему по умолчанию будет запущено средство настройки Azure Site Recovery.
5. В этом средстве они указывают имя, используемое при регистрации сервера конфигурации в хранилище.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения они выбирают **Вход**, чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором будет регистрироваться сервер конфигурации. 

    [Регистрация сервера конфигурации](./media/contoso-migration-rehost-vm-sql-managed-instance/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается. После этого специалисты выполняют повторный вход на компьютер, и мастер управления сервером конфигурации запускается автоматически.
8. В мастере необходимо выбрать сетевой адаптер для приема трафика репликации. Этот параметр нельзя изменить после настройки.
9. Далее они выбирают подписку, группу ресурсов и хранилище для регистрации сервера конфигурации.
        ![Хранилище](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz1.png) 

10. Затем специалисты компании загружают и устанавливают MySQL Server и VMWare PowerCLI. Затем они проверяют параметры сервера.
11. После проверки они указывают полное доменное имя или IP-адрес сервера vCenter Server. Они оставляют порт по умолчанию и указывают понятное имя для сервера vCenter Server в Azure.
12. Им необходимо задать учетную запись, которая была создана ранее, таким образом Site Recovery может автоматически обнаруживать виртуальные машины VMware, доступные для репликации. 
13. Они указывают учетные данные для автоматической установки службы Mobility Service, если включена репликация. Чтобы можно было работать с компьютерами с ОС Windows, у учетной записи должны быть права локального администратора на виртуальных машинах. 

    ![vCenter](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz2.png)

7. По окончании регистрации на портале Azure сотрудники компании Contoso тщательно проверяют, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. Обнаружение может занять 15 минут или более. 
8. Затем Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь компании Contoso необходимо настроить целевую среду репликации.

1. Они выбирают **Подготовка инфраструктуры** > **Цель** и задают параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения Azure и сети в указанной целевой среде.

### <a name="create-a-replication-policy"></a>Создание политики репликации

После настройки исходной и целевой сред в Contoso все будет готово для создания политики репликации и связывания с конфигурацией сервера.

1. В разделе **Подготовка инфраструктуры** > **Параметры репликации** > **Политика репликации** >  **Create and Associate** (Создать и связать) специалисты компании создают политику **ContosoMigrationPolicy**.
2. При этом они используют параметр по умолчанию.
    - **Пороговое значение RPO**. По умолчанию используется значение 60 минут. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Хранение точки восстановления**. По умолчанию используется значение 24 часа. Этим значением определяется продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность создания моментальных снимков с согласованием приложений**. Значение по умолчанию — час. Это значение указывает частоту, с которой система создает моментальные снимки приложений.
 
        ![Создание политики репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy.png)

5. Политика автоматически сопоставляется с сервером конфигурации. 

    ![Связывание политики репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy2.png)


**Нужна дополнительная помощь?**

- Полное пошаговое руководство для этих трех шагов см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).

### <a name="enable-replication"></a>Включение репликации

Теперь сотрудники Contoso могут запустить репликацию WebVM.

1. В разделе **Репликация приложений** > **Источник** > **+Выполнить репликацию** они настраивают параметры источника.
2. Они указывают, что они хотят включить виртуальные машины, выбрать сервер vCenter и сервер конфигурации.

 ![Включение репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication1.png)
 
3. Теперь специалисты задают параметры цели, включая группу ресурсов и виртуальную сеть, в которой будет размещена виртуальная машина Azure, созданная после отработки отказа, а также учетную запись хранения, где будут храниться реплицированные данные.

     ![Включение репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication2.png)

4. Компания Contoso выбирает WebVM для репликации. Site Recovery устанавливает службу Mobility Service на каждой виртуальной машине, когда вы включаете репликацию для нее. 

    ![Включение репликации](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication3.png)

5. Компания Contoso проверяет правильность выбора репликации и ее включение для WEBVM. Они отслеживают ход репликации в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.
6. В разделе **Основные компоненты** на портале Azure специалисты компании Contoso могут просматривать структуру виртуальных машин, реплицируемых в Azure.

    ![Представление инфраструктуры](./media/contoso-migration-rehost-vm-sql-managed-instance/essentials.png)


**Нужна дополнительная помощь?**

Полное пошаговое руководство для всех этих шагов см. в статье [Включение репликации в Azure для виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).

## <a name="step-6-migrate-the-database-with-dms"></a>Шаг 6. Миграция базы данных с помощью DMS

Компании Contoso необходимо создать проект DMS и выполнить миграцию базы данных.

### <a name="create-a-dms-project"></a>Создание проекта DMS
1. Сотрудники компании Contoso создают проект DMS. Они определяют тип исходного сервера как SQL Server, а целевой объект как управляемый экземпляр базы данных SQL Azure.

     ![Проект DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-project.png)

2. После создания проекта откроется мастер миграции.

### <a name="migrate-the-database"></a>Миграция базы данных 

1. В мастере миграции компания Contoso указывает исходную виртуальную машину, на которой находится локальная база данных и учетные данные для доступа к ней.

    ![Источник DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-source.png)

2. Сотрудники компании Contoso выбирают базу данных для выполнения миграции (SmartHotel.Registration).

    ![База данных источника DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-sourcedb.png)

3. Они указывают имя управляемого экземпляра в Azure как целевого объекта и учетные данные для доступа.

    ![Целевой объект DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-target-details.png)

4. Затем в разделе **+ Новое действие** > **Запустить миграцию** они указывают параметры для выполнения миграции:
    - Источник и цель учетных данных.
    - База данных для миграции.
    - Общий сетевой ресурс, созданный ними на локальной виртуальной машине. DMS сохраняет резервные копии источника в этой общей папке.
        - Учетная запись службы, в которой выполняется исходный экземпляр SQL Server, должна иметь права записи для этой общей папки.
        - Укажите полный путь FQDN к общей папке.
    - SAS URI, который позволяет DMS обращаться к контейнеру учетной записи хранения для отправки файлов резервных копий для миграции.

        ![Параметры DNS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-migration-settings.png)

5. Они запускают и сохраняют миграцию.
6. В разделе **Обзор** они отслеживают состояние миграции.

    ![Монитор DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor1.png)

7. После завершения миграции они убеждаются, что целевые базы данных существуют в управляемом экземпляре.

    ![Монитор DMS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor2.png)

## <a name="step-7-migrate-the-vm-with-site-recovery"></a>Шаг 7. Миграция виртуальной машины с помощью Site Recovery

Специалисты компании Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Перед выполнением миграции WEBVM тестовая отработка отказа позволяет убедиться в том, что все работает как надо. 

1. Специалисты компании Contoso запускают тестовую отработку отказа для последнего доступного момента времени (**Последняя отработанная**).
2. Они выбирают **Shut down machine before beginning failover** (Завершить работу машины перед началом отработки отказа), поэтому перед запуском отработки отказа Site Recovery пытается завершить работу исходной виртуальной машины. Отработка отказа продолжится, даже если их не удастся отключить. 
3. При тестировании отработки отказа происходит следующее: 

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.
3. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Они проверяют, все ли работает правильно. Виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает. 
4. После проверки тестовой отработки отказа они удаляют результаты отработки отказа, записывают и сохраняют все наблюдения. 

### <a name="migrate-the-vm"></a>Миграция виртуальной машины

1. Убедившись, что тестовая отработка отказа выполнена правильно, специалисты компании Contoso создают план восстановления для миграции. Специалисты компании Contoso добавляют WEBVM в план.

     ![План восстановления](./media/contoso-migration-rehost-vm-sql-managed-instance/recovery-plan.png)

2. Они выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления и указывают, что Site Recovery следует попытаться завершить работу виртуальных машин, прежде чем запустить отработку отказа.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-managed-instance/failover1.png)

3. После отработки отказа специалисты Contoso проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

   ![План восстановления](./media/contoso-migration-rehost-vm-sql-managed-instance/failover2.png)

4. После проверки виртуальной машины в Azure, они завершают процесс миграции, останавливают репликацию и выставление счетов Site Recovery для виртуальной машины и останавливают.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-managed-instance/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

На последнем этапе процесса миграции компания Contoso обновляет строку подключения приложения, чтобы указать на перенесенную базу данных, запущенную в SQL MI.

1. На портале Azure они найдут строку подключения, щелкнув **Параметры** > **Строки подключения**.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-managed-instance/failover4.png)  

2. Они обновляют строку с именем пользователя и пароль управляемого экземпляра SQL.
3. После настройки строки они заменяют текущую строку подключения в файле web.config приложения.
4. После обновления файла и его сохранения они перезапускают IIS на WEBVM. Они делают это с помощью команды **IISRESET/RESTART** из командной строки.
5. После перезапуска IIS приложение будет использовать базу данных, выполняющуюся на управляемом экземпляре SQL.
6. На этом этапе компания Contoso может завершить работу локальной виртуальной машины SQLVM и миграцию.

**Нужна дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа. 
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

С помощью завершения миграции приложения SmartHotel, которое выполнялось на виртуальной машине Azure, и база данных SmartHotel находятся на управляемом экземпляре SQL Azure.  

Для этого специалистам компании Contoso потребуется выполнить некоторую очистку:  

- Удалить машину WEBVM из перечня в vCenter.
- Удалить машину SQLVM из перечня в vCenter.
- Удалить машины WEBVM и SQLVM из локальных заданий резервного копирования.
- Обновить внутренний документ и указать в них новое расположение и IP-адреса.
- Удалите SQLVM из документации. Кроме того, им удалось пометить его как "Удаленное и недействительное" в реестре ВМ.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности Contoso рассматривают виртуальные машины Azure и управляемый экземпляр SQL, чтобы определить проблемы безопасности и их реализацию.

- Чтобы оценить возможность управления доступом, они проверяют группы безопасности сети (NSG) для виртуальной машины. NSG используются, чтобы в приложение поступал только разрешенный для него трафик.
- Специалисты компании также анализируют возможность защиты данных на диске с помощью шифрования дисков Azure и KeyVault Azure.
- Они включают обнаружение угроз на управляемом экземпляре SQL. Если обнаружена угроза, они передают оповещения системы безопасности команды/службы поддержки, для открытия билет. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-threat-detection).

     ![Обеспечение защиты управляемого экземпляра](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-security.png)  

[Узнайте больше](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control) о рекомендациях по обеспечению безопасности виртуальных машин.

### <a name="backups"></a>Резервные копии
Компания Contoso планирует выполнять резервное копирование данных, содержащихся в WEBVM, с помощью службы Azure Backup. [Узнайте больше](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

1. У компании Contoso имеются лицензии на WEBVM, и она воспользуется Преимуществом гибридного использования Azure.  Специалисты компании выполнят преобразование имеющихся виртуальных машин Azure, чтобы использовать льготные расценки.
2. Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков, с помощью использования Azure и другие облачные ресурсы, а также управлять ими.  Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview). 


## <a name="conclusion"></a>Заключение

В этой статье рассказано, как компания Contoso повторно разместила приложение SmartHotel в Azure путем миграции виртуальных машин внешнего интерфейса приложения в Azure с помощью службы Site Recovery. Они выполняют миграцию локальной базы данных в управляемый экземпляр SQL Azure с помощью DMS.

## <a name="next-steps"></a>Дополнительная информация

В [следующей статье](contoso-migration-rehost-vm.md) из этой серии мы покажем, как компания Contoso повторно размещает приложение SmartHotel на виртуальных машинах Azure с использованием службы Azure Site Recovery.

