---
title: Оценка локальных рабочих нагрузок компании Contoso при миграции в Azure | Документация Майкрософт
description: Узнайте, как компания Contoso проводит оценку локальных компьютеров перед миграцией в Azure, используя такие средства, как Миграция Azure и Помощник по миграции данных.
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 08/02/2018
ms.author: raynew
ms.openlocfilehash: 50d1b8fca8e5377c35810e08258a0ecc3770ae75
ms.sourcegitcommit: 1d850f6cae47261eacdb7604a9f17edc6626ae4b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/02/2018
ms.locfileid: "39422330"
---
# <a name="contoso-migration-assess-on-premises-workloads-for-migration-to-azure"></a>Миграция компании Contoso. Оценка локальных рабочих нагрузок для миграции в Azure

В этой статье описано, как компания Contoso оценивает локальное приложение SmartHotel при подготовке его переноса в Azure.

Это третья статья в цикле статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. Этот цикл содержит общие сведения и набор сценариев развертывания, иллюстрирующие настройку инфраструктуры миграции, оценку пригодности локальных ресурсов для миграции и выполнение миграций различных типов. Сценарии становятся все более сложными. Статьи будут добавляться в серию со временем.

Статья | Сведения | Status
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Общие сведения о стратегии миграции компании Contoso, серии статей и используемые в сериях примеры приложений. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Компания Contoso готовит локальную инфраструктуру и инфраструктуру Azure для миграции. Для всех статей миграции в серии используется одна и та же инфраструктура. | Доступна
Статья 3. Оценка готовности локальных ресурсов к переносу в Azure | Компания Contoso выполняет оценку локального двухуровневого приложения SmartHotel в VMware. Специалисты компании Contoso оценивают виртуальные машины приложения с помощью службы [Миграция Azure](migrate-overview.md). Компания Contoso оценивает приложение базы данных SQL Server с помощью [Помощника по миграции данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Эта статья
[Статья 4. Повторное размещение приложения на виртуальной машине Azure и в Управляемом экземпляре Базы данных SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Компания Contoso переносит локальное приложение SmartHotel в Azure по методу lift-and-shift. Специалисты компании Contoso переносят виртуальную машину внешнего интерфейса приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Компания Contoso выполняет миграцию базы данных приложения в Управляемый экземпляр Базы данных SQL Azure с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Повторное размещение приложения на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | Компания Contoso переносит виртуальные машины приложения SmartHotel на виртуальные машины Azure с помощью службы Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группе доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Компания Contoso переносит приложение SmartHotel. Для переноса виртуальных машин приложения компания Contoso использует Site Recovery. Она использует службу Azure Database Migration Service для миграции базы данных приложения в кластер SQL Server, который защищен группой доступности AlwaysOn. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Компания Contoso завершает миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery. | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и в Базе данных Azure для MySQL](contoso-migration-rehost-linux-vm-mysql.md) | Специалисты компании Contoso выполняют миграцию приложения osTicket для Linux на виртуальные машины Azure с помощью Site Recovery. Они перемещают базу данных приложения в Базу данных Azure для MySQL с помощью MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения в веб-приложении Azure и Базе данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | Компания Contoso переносит приложение SmartHotel в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Доступна
[Статья 10. Рефакторинг приложения Linux в веб-приложении Azure и Базе данных SQL Azure](contoso-migration-refactor-linux-app-service-mysql.md) | Специалисты компании Contoso переносят свое приложение Linux osTicket в веб-приложение Azure на нескольких сайтах. Веб-приложение интегрируется с GitHub для непрерывной поставки. Компания Contoso переносит базу данных приложения в экземпляр Базы данных Azure для MySQL. | Доступна
[Статья 11. Рефакторинг Team Foundation Server на Visual Studio Team Services](contoso-migration-tfs-vsts.md) | Специалисты компании Contoso выполняют миграцию локального развертывания Team Foundation Server путем его переноса в Visual Studio Team Services в Azure. | Доступна
[Статья 12. Перепроектирование приложения в контейнерах Azure и Базе данных SQL Azure](contoso-migration-rearchitect-container-sql.md) | Компания Contoso переносит приложение SmartHotel в Azure, а затем перепроектирует его. Специалисты компании Contoso перепроектируют веб-уровень приложения в контейнер Windows и перепроектируют базу данных приложения с помощью Базы данных SQL Azure. | Доступна
[Статья 13. Повторное создание приложения в Azure](contoso-migration-rebuild.md) | Компания Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, Функции Azure, Cognitive Services и Azure Cosmos DB. | Доступна


## <a name="overview"></a>Обзор

Компании Contoso требуется провести техническую и финансовую оценку, чтобы определить, можно ли выполнить миграцию локальных рабочих нагрузок в облако Azure. В частности, команда компании Contoso хочет оценить совместимость компьютеров и баз данных для миграции. Компания хочет оценить производительность и затраты на запуск ресурсов компании Contoso в Azure.

Чтобы начать работу и лучше понять суть используемых технологий, компания Contoso оценивает два локальных приложения, приведенные в следующей таблице. Она оценивает сценарии миграции при перемещении и рефакторинге приложений для миграции. Дополнительные сведения о перемещении и рефакторинге см. в статье [Общие сведения о миграции Contoso](contoso-migration-overview.md).

Имя приложения. | платформа | Уровни приложения | Сведения
--- | --- | --- | ---
SmartHotel<br/><br/> (управляет требованиями к путешествиям в компании Contoso) | Работает на системе Windows с помощью базы данных SQL Server | Двухуровневое приложение. Внешний интерфейс веб-сайта ASP.NET запускается на одной виртуальной машине (**WEBVM**), а SQL Server — на другой (**SQLVM**). | Виртуальные машины — это VMware, работающие на узле ESXi, управляемом vCenter Server.<br/><br/> Пример приложения можно загрузить в репозитории [GitHub](https://github.com/Microsoft/SmartHotel360).
osTicket<br/><br/> (Приложение службы поддержки компании Contoso) | Запускается в Apache или на Linux с помощью MySQL PHP (LAMP) | Двухуровневое приложение. Внешний интерфейс веб-сайта PHP запускается на одной виртуальной машине (**OSTICKETWEB**), а база данных MySQL — на другой (**OSTICKETMYSQL**). | Приложение используется приложениями служб клиента для отслеживания проблем у внутренних сотрудников и внешних клиентов.<br/><br/> Пример можно загрузить в репозитории [GitHub](https://github.com/osTicket/osTicket).

## <a name="current-architecture"></a>Текущая архитектура

Эта схема показывает текущую локальную инфраструктуру компании Contoso.

![Текущая архитектура Contoso](./media/contoso-migration-assessment/contoso-architecture.png)  

- Компания Contoso имеет единственный главный центр обработки данных. Он находится в Нью-Йорке (на востоке Соединенных Штатов Америки).
- У компании есть еще три местных филиала в других уголках США.
- Основной центр обработки данных подключается к Интернету с помощью оптоволоконного соединения Metro Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединений бизнес-класса и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Эта настройка позволяет компании Contoso обеспечивать постоянство подключения всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. Компания использует два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Компания Contoso использует управление удостоверениями в Active Directory. Компания Contoso использует DNS-серверы внутренней сети.
- Контроллеры домена в центре обработки данных размещены в виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство компании Contoso и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** Компания Contoso растет. В результате увеличилось давление на внутренние системы и инфраструктуру компании.
- **Повышение эффективности**. Компании Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и не тратили время или деньги, поэтому компания может быстрее выполнять требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso нуждается в большей гибкости в отношении потребностей бизнеса. Он должен реагировать быстрее чем изменения, которые происходят на рынке, для достижение компанией успеха в глобальной экономике. ИТ-отдел в компании Contoso не должен мешать или становиться помехой для бизнеса.
- **Масштабирование**. По мере роста бизнеса компании ИТ-отдел компании Contoso должен предоставлять системы, которые могут расти с той же скоростью.

## <a name="assessment-goals"></a>Цели оценки

Команда, работающая над облачной инфраструктурой компании Contoso, определила цели оценки миграции:

- После миграции приложения Azure должны иметь те же возможности с точки зрения производительности, что и приложения в текущей локальной среде VMware компании Contoso. Переход в облако не означает, что производительность приложения сильно уменьшится.
- Компания Contoso должна понять, соответствуют ли приложения и базы данных требованиям Azure. Компания Contoso также должна понять варианты размещения в Azure.
- После перехода приложений в облако администрирование баз данных компании Contoso должно быть минимальным.  
- Компании необходимо получить сведения не только о параметрах миграции, но и о стоимости инфраструктуры после перехода в облако.

## <a name="assessment-tools"></a>Средства оценки

Компания Contoso использует инструменты Майкрософт для оценки миграции. Эти средства соответствуют целям компании и должны предоставить Contoso необходимые сведения.

Технология | ОПИСАНИЕ | Стоимость
--- | --- | ---
[Помощник по миграции данных](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | Компания Contoso использует Помощник по миграции данных для оценки и выявления проблем совместимости, которые могут повлиять на функциональность базы данных в Azure. Помощник по миграции данных оценивает равенство функций между источниками и целевыми объектами SQL. Он рекомендует улучшения производительности и надежности. | Помощник по миграции данных — это бесплатный загружаемый инструмент.
[Миграция Azure](https://docs.microsoft.com/azure/migrate/migrate-overview) | Компания Contoso использует службу "Миграция Azure" для оценки виртуальных машин VMware. Служба "Миграция Azure" оценивает миграционную пригодность компьютеров. Она обеспечивает оценку размера и стоимости для работы в Azure.  | Начиная с мая 2018 года "Миграция Azure" — это бесплатная служба.
[Схема услуги](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-service-map) | Служба "Миграция Azure" использует решение "Схема услуги" для отображения зависимостей между компьютерами, которые компания хочет перенести. | Это решение является частью службы Azure Log Analytics. В настоящее время компания Contoso может использовать решение "Схема услуги" в течение 180 дней без каких-либо затрат.

В рамках этого сценария компания Contoso загружает и запускает Помощник по миграции данных, чтобы оценить локальную базу данных SQL Server приложения путешествий компании. Компания Contoso использует службу "Миграция Azure" с сопоставлением зависимостей для оценки виртуальных машин приложения, прежде чем переносить их в Azure.

## <a name="assessment-architecture"></a>Архитектура оценки

![Архитектура оценки миграции](./media/contoso-migration-assessment/migration-assessment-architecture.png)

- Contoso — это вымышленное имя, представляющее типичную крупную организацию.
- Компания Contoso использует локальный центр обработки данных (**contoso-datacenter**) и локальные контроллеры домена (**CONTOSODC1**, **CONTOSODC2**).
- Виртуальные машины VMware находятся на узле VMware ESXI 6.5 (**contosohost1**, **contosohost2**).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Приложение для путешествий SmartHotel имеет следующие характеристики:
    - Приложение разбито на уровни и находится на двух виртуальных машинах VMware (**WEBVM** и **SQLVM**).
    - Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com**.
    - Виртуальные машины используют центр обработки данных, для которого используется ОС Windows Server 2008 R2 с пакетом обновления 1 (SP1).
- Средой VMware управляет сервер vCenter Server (**vcenter.contoso.com**), который запущен на виртуальной машине.
- osTicket — приложение службы поддержки:
    - У приложения есть два уровня, которые размещаются на двух виртуальных машинах (**OSTICKETWEB** и **OSTICKETMYSQL**).
    - Виртуальные машины работают на ОС Ubuntu Linux Server 16.04-LTS.
    - Виртуальная машина **OSTICKETWEB** работает на Apache 2 и PHP 7.0.
    - Виртуальная машина **OSTICKETMYSQL** работает на MySQL 5.7.22.

## <a name="prerequisites"></a>Предварительные требования

Компания Contoso и другие пользователи должны отвечать следующим предварительным условиям оценки:

- Разрешение на подписку Azure на уровне участника или владельца или разрешение на группу ресурсов в подписке Azure.
- Локальный сервер vCenter Server версии 6.5, 6.0 или 5.5.
- Учетная запись только для чтения на сервере vCenter Server или разрешения на ее создание.
- Разрешения на создание виртуальной машины на экземпляре сервера vCenter Server с использованием шаблона в формате OVA.
- По крайней мере один узел ESXi версии 5.0 или более поздней.
- По крайней мере две виртуальные машины VMware, на одной из который выполняется база данных SQL Server.
- Разрешения на установку агентов службы "Миграция Azure" на каждой виртуальной машине.
- Виртуальные машины должны иметь прямое подключение к Интернету.  
        - Вы можете ограничить доступ к [требуемым URL-адресам](https://docs.microsoft.com/azure/migrate/concepts-collector#collector-pre-requisites) в Интернете.  
        - Если виртуальные машины не подключены к Интернету, на них должен быть установлен [шлюз OMS](../log-analytics/log-analytics-oms-gateway.md) Azure Log Analytics, через который будет направляться трафик агента.
- Полное доменное имя виртуальной машины, на которой запущен экземпляр SQL Server, для оценки базы данных.
- Брандмауэр Windows, работающий на виртуальной машине SQL Server, должен разрешать внешние подключения по TCP-порту 1433 (по умолчанию). Эта настройка позволяет подключиться к Помощнику по миграции данных.

## <a name="assessment-overview"></a>Общие сведения об оценке

Вот как компания Contoso производит оценку:

> [!div class="checklist"]
> * **Шаг 1. Загрузка и установка Помощника по миграции данных**. Компания Contoso подготавливает Помощник по миграции данных для оценки локальной базы данных SQL Server.
> * **Шаг 2. Оценка базы данных с помощью Помощника по миграции данных**. Компания Contoso запускает и анализирует оценку базы данных.
> * **Шаг 3. Подготовка к оценке виртуальной машины с помощью службы "Миграция Azure"**. Компания Contoso настраивает локальные учетные записи и параметры VMware.
> * **Шаг 4. Обнаружение локальных виртуальных машин с помощью службы "Миграция Azure"**. Компания Contoso создает виртуальные машины сборщика Миграции Azure. Затем компания запускает сборщик, чтобы обнаружить виртуальные машины для оценки.
> * **Шаг 5. Подготовка к анализу зависимостей с помощью службы "Миграция Azure"**. Компания Contoso устанавливает агенты службы "Миграция Azure" на виртуальных машинах, чтобы получить сопоставление зависимостей между виртуальными машинами.
> * **Шаг 6. Оценка виртуальных машин с помощью службы "Миграция Azure"**. Компания Contoso проверяет зависимости, группирует виртуальные машины и запускает оценку. Когда оценка будет выполнена, компания Contoso проанализирует ее в процессе подготовки к миграции.

## <a name="step-1-download-and-install-data-migration-assistant"></a>Шаг 1. Загрузка и установка Помощника по миграции данных

1. Компания Contoso загружает Помощник по миграции данных из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53595).
    - Помощник по миграции данных может быть установлен на любом компьютере, который может подключиться к экземпляру SQL Server. Компании Contoso не нужно запускать его на компьютере SQL Server.
    - Помощник по миграции данных не следует запускать на хост-компьютере SQL Server.
2. Чтобы начать установку, компания Contoso запускает загруженный файл (DownloadMigrationAssistant.msi).
3. Перед закрытием мастера на странице **Готово** компания Contoso выбирает **Запустить помощник по миграции данных Майкрософт**.

## <a name="step-2-run-and-analyze-the-database-assessment-for-smarthotel"></a>Шаг 2. Запуск и анализ оценки базы данных для SmartHotel

Теперь компания Contoso может запустить оценку анализа локального сервера базы данных SQL Server для приложения SmartHotel.

1. В Помощнике по миграции данных компания Contoso выбирает **Создать** > **Оценка**, а затем задает оценке имя проекта (**SmartHotel**).
2. Для **типа исходного сервера** компания Contoso выбирает параметр **SQL Server на виртуальных машинах Azure**.

    ![Помощник по миграции данных. Выбор источника](./media/contoso-migration-assessment/dma-assessment-1.png)

    > [!NOTE]
      В настоящее время Помощник по миграции данных не поддерживает оценку для миграции на Управляемый экземпляр Базы данных SQL Azure. Чтобы обойти это ограничение, компания Contoso использует SQL Server на виртуальной машине Azure в качестве предполагаемого целевого объекта оценки.

3. В поле **Выберите целевую версию** компания Contoso выбирает SQL Server 2017. Компания Contoso должна выбрать эту версию, так как она используется Управляемым экземпляром Базы данных SQL.
4. Для получения сведений о совместимости и новых функциях компания Contoso выбирает отчеты:
    - Параметр **Проблемы совместимости** позволяет зафиксировать изменения, которые могут прервать миграцию или для которых потребуется незначительная корректировка перед миграцией. Этот отчет позволяет компании Contoso получать сведения о функциях, которые являются устаревшими, но на данный момент работают. Проблемы упорядочены по уровню совместимости.
    - Параметр **Рекомендации по новым функциям** фиксирует новые возможности целевой платформы SQL Server, которые можно использовать в базе данных после миграции. Рекомендации по новым функциям организованы в рубриках **Производительность**, **Безопасность** и **Хранение**.

    ![Помощник по миграции данных. Проблемы совместимости и новые функции](./media/contoso-migration-assessment/dma-assessment-2.png)

2. На вкладке **Подключение к серверу** компания Contoso вводит имя виртуальной машины, на которой работает база данных, а также учетные данные для доступа к ней. Компания Contoso выбирает **Сертификат сервера доверия**, чтобы убедиться, что виртуальная машина может получить доступ к SQL Server. Затем компания выбирает **Подключить**.

    ![Помощник по миграции данных. Подключение к серверу](./media/contoso-migration-assessment/dma-assessment-3.png)

3. В поле **Добавить источник** компания Contoso добавляет базу данных, которую хочет оценить, а затем выбирает **Далее**, чтобы начать оценку.
4. Оценка создана.

    ![Помощник по миграции данных. Создание оценки](./media/contoso-migration-assessment/dma-assessment-4.png)

5. Результаты оценки компания Contoso может увидеть в поле **Просмотр результатов**.

### <a name="analyze-the-database-assessment"></a>Анализ оценки базы данных

Как только результаты станут доступными, оны будут отображены. Если компания Contoso исправляет проблемы, для повторной оценки необходимо выбрать **Перезапустить оценку**.

1. Ошибки, находящиеся на каждом уровне совместимости, компания может проверить в поле **Проблемы совместимости**. Уровни совместимости сопоставляются с версиями SQL Server следующим образом:

    - 100: SQL Server 2008/база данных SQL Azure
    - 110: SQL Server 2012/база данных SQL Azure
    - 120: SQL Server 2014/база данных SQL Azure
    - 130: SQL Server 2016/база данных SQL Azure
    - 140: SQL Server 2017/база данных SQL Azure

    ![Помощник по миграции данных. Отчет о проблемах совместимости](./media/contoso-migration-assessment/dma-assessment-5.png)

2. В отчете **Рекомендуемые возможности** компанией Contoso просматриваются функции для обеспечения производительности и безопасности, а также возможности хранения после миграции. Рекомендуется использовать различные функции, в том числе выполняющуюся в памяти OLTP, индексы columnstore, Stretch Database, Always Encrypted, динамическое маскирование данных и прозрачное шифрование данных.

    ![Помощник по миграции данных. Отчет о рекомендуемых возможностях](./media/contoso-migration-assessment/dma-assessment-6.png)

    > [!NOTE]
    > Компании Contoso следует [включить прозрачное шифрование данных](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017) для всех баз данных SQL Server. Это еще более важно, когда база данных находится в облаке, чем когда она размещается локально. Прозрачное шифрование данных следует включать только после миграции. Если прозрачное шифрование данных уже включено, компания Contoso должна переместить сертификат или асимметричный ключ в главную базу данных или на целевой сервер. Узнайте, как [переместить прозрачное шифрование защищенной базы данных на другой экземпляр SQL Server](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017).

2. Затем компания Contoso может экспортировать оценку в формате JSON или CSV.

> [!NOTE]
> Для крупномасштабных оценок:
> - Одновременно выполняйте несколько оценок и просматривайте их состояние на странице **Все оценки**.
> - Консолидируйте оценки в [базе данных SQL Server](https://docs.microsoft.com/sql/dma/dma-consolidatereports?view=ssdt-18vs2017#import-assessment-results-into-a-sql-server-database).
> - Консолидируйте оценки в [отчете Power BI](https://docs.microsoft.com/sql/dma/dma-powerbiassesreport?view=ssdt-18vs2017).

## <a name="step-3-prepare-for-vm-assessment-by-using-azure-migrate"></a>Шаг 3. Подготовка к оценке виртуальных машин с помощью службы "Миграция Azure"

Компании Contoso необходимо создать учетную запись VMware, которую служба "Миграция Azure" сможет использовать для автоматического обнаружения виртуальных машин для оценки. Также необходимо убедиться в наличии прав на создание виртуальной машины, обратить внимание на порты, которые должны быть открыты, и установить уровень параметров статистики.

### <a name="set-up-a-vmware-account"></a>Настройка учетной записи VMware

Обнаружению виртуальных машин требуется учетная запись только для чтения в vCenter Server, которая бы обладала следующими свойствами:

- **Тип пользователя**. Потребуется по крайней мере пользователь только для чтения.
- **Разрешения**. Для объекта центра обработки данных установите флажок **Распространить на дочерние объекты**. Для **роли** выберите **только для чтения**.
- **Подробности**. Пользователь назначается на уровне центра обработки данных с доступом ко всем объектам в этом центре.
- Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Распространить на дочерний** объект.

### <a name="verify-permissions-to-create-a-vm"></a>Проверка разрешений для создания виртуальной машины

Компания Contoso проверяет наличие разрешения на создание виртуальной машины путем импорта файла в формате OVA. Узнайте, как [создать и назначить роль с разрешениями](https://kb.vmware.com/s/article/1023189?other.KM_Utility.getArticleLanguage=1&r=2&other.KM_Utility.getArticleData=1&other.KM_Utility.getArticle=1&ui-comm-runtime-components-aura-components-siteforce-qb.Quarterback.validateRoute=1&other.KM_Utility.getGUser=1).

### <a name="verify-ports"></a>Проверка портов

При оценке компании Contoso используется сопоставление зависимостей. Для сопоставления зависимостей требуется, чтобы агент был установлен на виртуальных машинах, которые будут оцениваться. Агент должен иметь возможность подключиться к Azure по TCP-порту 443 на каждой виртуальной машине. Узнайте больше о [требованиях к подключению](https://docs.microsoft.com/azure/log-analytics/log-analytics-concept-hybrid).

### <a name="set-statistics-settings"></a>Настройка параметров статистики

Прежде чем компания Contoso начнет развертывания, нужно установить параметры статистики для 3 уровня сервера vCenter Server. 

> [!NOTE]
> - После установки уровня компания Contoso должна подождать по крайней мере один день, прежде чем приступить к оценке. В противном случае оценка может работать не так, как ожидалось.
> - Если уровень выше 3, оценка будет работать, но при этом:
>    - Данные о производительности дисков и сетей не будут собраны.
>    - Для хранилища служба "Миграция Azure" рекомендует стандартный диск в Azure того же размера, что и локальный.
>    - С точки зрения сети для каждого локального сетевого адаптера рекомендуется наличие сетевого адаптера в Azure.
>    - С точки зрения среды выполнения приложений служба "Миграция Azure" анализирует количество ядер и объем памяти и рекомендует виртуальную машину Azure с такой же конфигурацией. Если доступно несколько соответствующих размеров виртуальных машин, служба выбирает рекомендуемый, который обеспечивает наименьшие затраты.
> - Для получения дополнительных сведений об определении размера с использованием уровня 3 см. [Определение размера](https://docs.microsoft.com/azure/migrate/concepts-assessment-calculation#sizing).

Чтобы установить уровень:

1. В веб-клиенте vSphere компания Contoso открывает экземпляр сервера vCenter Server.
2. Компания Contoso выбирает **Управление** > **Настройки** > **Общие** > **Изменить**.
3. А на вкладке **Статистика** компания Contoso устанавливает для уровня статистики параметр **Уровень 3**.

    ![Уровень статистики vCenter Server](./media/contoso-migration-assessment/vcenter-statistics-level.png)

## <a name="step-4-discover-vms"></a>Шаг 4. Обнаружение виртуальных машин

Компания Contoso создает проект службы "Миграция Azure" для обнаружения виртуальных машин. Компания Contoso загружает и устанавливает сборщик виртуальной машины. Затем компания запускает сборщик, чтобы обнаружить локальные виртуальные машины.

### <a name="create-a-project"></a>Создание проекта

1. На [портале Azure](https://portal.azure.com) компания Contoso ищет **Миграция Azure**. Затем компания Contoso создает проект.
2. Компания Contoso указывает имя проекта (**ContosoMigration**) и подписку Azure. Она создает новую группу ресурсов Azure (**ContosoFailoverRG**). 
    > [!NOTE]
    > - Проект службы "Миграция Azure" можно создать только в регионах "Центрально-западная часть США" и "Восточная часть США".
    > - Можно запланировать перенос в любое целевое расположение.
    > - В расположении проекта только хранятся метаданные, собранные с локальных виртуальных машин.

    ![Миграция Azure. Создание проекта миграции](./media/contoso-migration-assessment/project-1.png)

### <a name="download-the-collector-appliance"></a>Скачивание модуля сборщика

Служба "Миграция Azure" создает локальную виртуальную машину, известную как *устройство сборщика*. Эта виртуальная машина обнаруживает локальные виртуальные машины VMware и отправляет метаданные о них в службу "Миграция Azure". Чтобы настроить модуль сборщика, компания Contoso загружает шаблон в формате OVA, который будет импортирован на локальный экземпляр сервера vCenter Server для создания виртуальной машины.

1. В проекте службы "Миграция Azure" компания Contoso выбирает **Начало работы** > **Обнаружение и оценка** > **Обнаружение компьютеров**. Компания Contoso загружает шаблон файла в формате OVA.
2. Компания Contoso копирует идентификатор и ключ проекта. Проект и идентификатор необходимы для настройки сборщика.

    ![Миграция Azure. Загрузка OVA-файла](./media/contoso-migration-assessment/download-ova.png)

### <a name="verify-the-collector-appliance"></a>Проверка модуля сборщика

Прежде чем развертывать OVA-файл, компания Contoso проверяет, что он не поврежден:

1. На компьютере, на который был загружен файл, компания Contoso открывает окно командной строки с правами администратора.
2. Чтобы создать хэш файла в формате OVA, компания Contoso выполняет следующую команду:

    ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```
    
    **Пример** 
    
    ```C:\>CertUtil -HashFile C:\AzureMigrate\AzureMigrate.ova SHA256```
3. Созданный хэш должен соответствовать этим параметрам (версия 1.0.9.12):

    Алгоритм | Значение хэша
    --- | ---
    MD5 | d0363e5d1b377a8eb08843cf034ac28a
    SHA1 | df4a0ada64bfa59c37acf521d15dcabe7f3f716b
    SHA256 | f677b6c255e3d4d529315a31b5947edfe46f45e4eb4dbc8019d68d1d1b337c2e

### <a name="create-the-collector-appliance"></a>Создание модуля сборщика

Теперь у компании Contoso появилась возможность импортировать скачанный файл в экземпляр vCenter Server и подготовить виртуальную машину для модуля сборщика.

1. В консоли клиента vSphere компания Contoso выбирает **Файл** > **Развернуть шаблон OVF**.

    ![Веб-клиент vSphere. Развертывание шаблона OVF](./media/contoso-migration-assessment/vcenter-wizard.png)

2. В мастере шаблонов развертывания OVF компания Contoso выбирает **Источник**, а затем указывает местоположение файла OVA.
3. В **Название и местоположение** компания Contoso указывает отображаемое имя для сборщика виртуальной машины. Затем она выбирает местоположение инвентаря для размещения виртуальной машины. Также компания Contoso указывает узел или кластер, в котором будет выполняться модуль сборщика.
4. В **Хранилище** компания Contoso задает место хранения. В **Формат диска** компания Contoso выбирает, как нужно подготовить к работе хранилище.
5. В **Сетевое сопоставление** компания Contoso задает сеть, в которой будет подключаться сборщик виртуальной машины. Этой сети требуется подключение к Интернету для отправки метаданных в Azure.
6. Компания Contoso проверяет настройки и устанавливает флажок **Включить питание после развертывания** > **Готово**. Когда устройство будет создано, появится сообщение, подтверждающее успешное завершение работы.

### <a name="run-the-collector-to-discover-vms"></a>Запуск сборщика для обнаружения виртуальных машин

Теперь компания Contoso запускает сборщик для обнаружения виртуальных машин. В настоящее время сборщик поддерживает только **английский (США)** в качестве языка операционной системы и языка интерфейса сборщика.

1. В консоли клиента vSphere компания Contoso выбирает **Открыть консоль**. Компания Contoso указывает язык, часовой пояс и параметры пароля сборщика виртуальной машины.
2. На рабочем столе компания Contoso щелкает ярлык **Запустить сборщик**.

    ![Консоль клиента vSphere. Ярлык сборщика](./media/contoso-migration-assessment/collector-shortcut.png)

3. В сборщике службы "Миграция Azure" компания Contoso открывает раздел **Настройка предварительных требований**. Компания Contoso принимает условия лицензии и считывает информацию от сторонних производителей.
4. Сборщик проверяет, что виртуальная машина имеет доступ к Интернету, время синхронизировано и служба сборщика запущена. (Служба сборщика устанавливается по умолчанию на виртуальной машине.) Также компания Contoso устанавливает VMware PowerCLI.

    > [!NOTE]
    > Предполагается, что виртуальная машина имеет прямой доступ к Интернету без использования прокси-сервера.

    ![Сборщик Миграции Azure. Проверка предварительных требований](./media/contoso-migration-assessment/collector-verify-prereqs.png)

5. На вкладке **Укажите сведения о vCenter Server** компания Contoso указывает имя (FQDN) или IP-адрес экземпляра vCenter Server, а также учетные данные только для чтения, используемые для обнаружения.
6. Компания Contoso выбирает область для обнаружения виртуальных машин. Сборщик может обнаруживать только виртуальные машины, находящиеся в указанной области. Областью может быть определенная папка, центр обработки данных или кластер. Область не должна содержать более 1,500 виртуальных машин.

    ![Укажите сведения о vCenter Server](./media/contoso-migration-assessment/collector-connect-vcenter.png)

7. В разделе **Укажите проект миграции** компания Contoso указывает идентификатор и ключ проекта службы "Миграция Azure", скопированные на портале. Чтобы получить идентификатор и ключ проекта, компания Contoso может перейти на страницу проекта **Обзор** > **Обнаружение компьютеров**.  

    ![Определение проекта миграции](./media/contoso-migration-assessment/collector-connect-azure.png)

8. В окне **Просмотр хода выполнения сбора** компания Contoso может проводить наблюдения за обнаружением и убедиться, что в области обнаружения собираются метаданные с виртуальных машин. Сборщик предоставляет приблизительное время завершения обнаружения.

    ![Просмотр хода выполнения сбора](./media/contoso-migration-assessment/collector-collection-process.png)

### <a name="verify-vms-in-the-portal"></a>Проверка виртуальных машин на портале

После завершения сбора компания Contoso проверяет, что виртуальные машины отображаются на портале.

1. В проекте службы "Миграция Azure" компания Contoso щелкает **Управление** > **Компьютеры**. Компания Contoso проверяет, что нужные виртуальные машины обнаружены.

    ![Миграция Azure. Обнаруженные компьютеры](./media/contoso-migration-assessment/discovery-complete.png)

2. В настоящее время на компьютерах нет установленных агентов службы "Миграция Azure". Компания Contoso должна установить агенты для просмотра зависимостей.

    ![Миграция Azure. Необходима установка агента](./media/contoso-migration-assessment/machines-no-agent.png)

## <a name="step-5-prepare-for-dependency-analysis"></a>Шаг 5. Подготовка к анализу зависимостей

Чтобы просмотреть зависимости между виртуальными машинами, которые компания Contoso хочет оценить, необходимо скачать и установить агенты на виртуальные машины приложений. Компания Contoso устанавливает агенты на всех виртуальных машинах для своих приложений, как для Windows, так и для Linux.

### <a name="take-a-snapshot"></a>Создание моментального снимка

Компания Contoso выполняет моментальный снимок виртуальной машины перед установкой агента, что позволяет сохранить ее копию перед изменением.

![Моментальный снимок компьютера](./media/contoso-migration-assessment/snapshot-vm.png)

### <a name="download-and-install-the-vm-agents"></a>Скачивание и установка агентов виртуальной машины

1. В разделе **Компьютеры** компания Contoso выбирает компьютер. В столбце **Зависимости** она выбирает **Требует установки**.
2. В области **Обнаружение компьютеров** компания Contoso:
    - загружает Microsoft Monitoring Agent (MMA) и агент зависимостей для каждой виртуальной машины Windows;
    - загружает MMA и агент зависимостей для каждой виртуальной машины Linux.
3. Компания Contoso копирует идентификатор рабочей области и ключ. При установке MMA специалистам компании Contoso необходим идентификатор рабочей области и ключ.

    ![Скачивание агента](./media/contoso-migration-assessment/download-agents.png)

### <a name="install-the-agents-on-windows-vms"></a>Установите агент для виртуальных машин Windows

Компания Contoso запускает установку на каждой виртуальной машине.

#### <a name="install-the-mma-on-windows-vms"></a>Установите MMA для виртуальных машин Windows

1. Компания Contoso дважды щелкает загруженный файл агента.
2. На странице **Конечная папка** компания Contoso изменяет или оставляет папку установки по умолчанию и нажимает кнопку **Далее**.
3. В окне **Параметры установки агента** она выбирает **Подключить агент к Azure Log Analytics** > **Далее**.

    ![Установка Microsoft Monitoring Agent. Параметры установки агента](./media/contoso-migration-assessment/mma-install.png)

4. В окне **Azure Log Analytics** компания Contoso вставляет идентификатор и ключ рабочей области, скопированные на портале.

    ![Установка Microsoft Monitoring Agent. Azure Log Analytics](./media/contoso-migration-assessment/mma-install2.png)

5. В окне **Готово к установке** компания Contoso устанавливает MMA.

#### <a name="install-the-dependency-agent-on-windows-vms"></a>Установка агента зависимостей на виртуальные машины Windows

1. Компания Contoso дважды щелкает загруженный файл агента зависимостей.
2. Компания принимает условия лицензионного соглашения и ждет окончания установки.

    ![Установка агента зависимостей. Процесс установки](./media/contoso-migration-assessment/dependency-agent.png)

### <a name="install-the-agents-on-linux-vms"></a>Установка агентов на виртуальные машины Linux

Компания Contoso запускает установку на каждой виртуальной машине.

#### <a name="install-the-mma-on-linux-vms"></a>Установите MMA для виртуальных машин Linux

1. Специалисты компании Contoso устанавливают библиотеку ctypes Python для каждой виртуальной машины, используя следующую команду:

    `sudo apt-get install python-ctypeslib`
2. Чтобы установить агент MMA, компания Contoso должна запустить команды от имени привилегированного пользователя. Чтобы стать привилегированным пользователем, компания Contoso выполняет команду и вводит пароль:

    `sudo -i`
3. Компания Contoso устанавливает MMA:
    - Она вводит идентификатор и ключ рабочей области в команде.
    - Команды предназначены для 64-разрядных систем.
    - Идентификатор и первичный ключ рабочей области размещаются на портале Microsoft Operations Management Suite (OMS). Выберите **Параметры**, а затем вкладку **Подключенные источники**.
    - Выполните следующие команды для загрузки агента OMS, проверки контрольной суммы, установки и подключения агента:

    ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -w 6b7fcaff-7efb-4356-ae06-516cacf5e25d -s k7gAMAw5Bk8pFVUTZKmk2lG4eUciswzWfYLDTxGcD8pcyc4oT8c6ZRgsMy3MmsQSHuSOcmBUsCjoRiG2x9A8Mg==
    ```

#### <a name="install-the-dependency-agent-on-linux-vms"></a>Установка агента зависимостей на виртуальные машины Linux

После установки MMA компания Contoso может установить агент зависимостей на виртуальные машины Linux:

1. Агент зависимостей устанавливается на компьютерах Linux с помощью InstallDependencyAgent-Linux64.bin. Это сценарий оболочки с самоизвлекающимся двоичным файлом. Компания Contoso запускает файл с помощью команды "sh" или добавляет разрешения на выполнение в сам файл.

2. В качестве привилегированного пользователя компания Contoso устанавливает агент зависимостей на Linux:

    ```
    wget --content-disposition https://aka.ms/dependencyagentlinux -O InstallDependencyAgent-Linux64.bin && sudo sh InstallDependencyAgent-Linux64.bin -s
    ```

## <a name="step-6-run-and-analyze-the-vm-assessment"></a>Шаг 6. Запуск и анализ оценки виртуальных машин

Теперь компания Contoso может проверить зависимости компьютера и создать группу. Затем она запускает оценку для группы.

### <a name="verify-dependencies-and-create-a-group"></a>Проверка зависимостей и создание группы

1. Чтобы определить, какие компьютеры анализировать, Contoso выбирает **Показать зависимости**.

    ![Миграция Azure. Просмотр зависимости компьютера](./media/contoso-migration-assessment/view-machine-dependencies.png)

2. На карте зависимостей SQLVM появятся следующие сведения:

    - Группы процессов или процессы, которые имеют активные сетевые подключения, запущенные на SQLVM в течение указанного периода времени (час, по умолчанию).
    - Входящие (клиент) и исходящие (сервер) TCP-подключения всех зависимых компьютеров.
    - Зависимые компьютеры, которые имеют установленные агенты службы "Миграция Azure", показаны в виде отдельных полей.
    - Компьютеры, на которых не установлены агенты, отображают информацию о портах и ​​IP-адресах.

3. Для компьютеров, на которых установлен агент (WEBVM), компания Contoso выбирает компьютерный блок для просмотра дополнительной информации. Информация включает FQDN, операционную систему и MAC-адрес.

    ![Миграция Azure. Просмотр зависимостей группы](./media/contoso-migration-assessment/sqlvm-dependencies.png)

4. Компания Contoso выбирает виртуальные машины, которые будут добавлены в группы (SQLVM и WEBVM). Чтобы выбрать несколько виртуальных машин, компания Contoso щелкает их, удерживая клавишу CTRL.
5. Она выбирает **Создать группу**, а затем вводит имя (**smarthotelapp**).

    > [!NOTE]
    > Чтобы просмотреть более подробные зависимости, можно расширить диапазон времени. Можно выбрать конкретную продолжительность или даты начала и окончания.

### <a name="run-an-assessment"></a>Запуск оценки

1. В **группах** компания Contoso открывает группу (**smarthotelapp**), а затем выбирает **Создать оценку**.

    ![Миграция Azure. Создание оценки](./media/contoso-migration-assessment/run-vm-assessment.png)

2. Чтобы просмотреть оценку, компания Contoso выбирает **Управление** > **Оценки**.

Специалисты компании Contoso используют параметры оценки по умолчанию, но вы можете [настроить параметры](how-to-modify-assessment.md).

### <a name="analyze-the-vm-assessment"></a>Анализ оценки виртуальных машин

Оценка службы "Миграция Azure" включает информацию о локальной совместимости с Azure, правильном размере для виртуальной машины Azure, а также предполагаемые ежемесячные затраты в Azure.

![Миграция Azure. Отчет об оценке](./media/contoso-migration-assessment/assessment-overview.png)

#### <a name="review-confidence-rating"></a>Просмотр рейтинга достоверности

![Миграция Azure. Отображение оценки](./media/contoso-migration-assessment/assessment-display.png)

Оценка имеет рейтинг достоверности от 1 до 5 звезд (1 звезда — самый низкий, а 5 звезд — самый высокий).
- Оценка достоверности назначается на основе доступности точек данных, которые необходимы для вычисления оценки.
- Это помогает оценить надежность рекомендаций по выбору размера, который предоставлен службой "Миграция Azure".
- Оценка достоверности полезна при *определении размера на основе производительности*. Служба "Миграция Azure" может иметь недостаточное количество точек данных для определения размера на основе использования. При определении размера *как для локальной виртуальной машины* значение оценки достоверности всегда равно 5 звездам, так как в службе "Миграция Azure" есть все данные для определения размера виртуальной машины.
- В зависимости от процента доступных точек данных оценка достоверности может быть такой:

   Уровень доступности точек данных | Оценка достоверности
   --- | ---
   0–20 % | 1 звезда
   21–40 % | 2 звезды
   41–60 % | 3 звезды
   61–80 % | 4 звезды
   81–100 % | 5 звезд

#### <a name="verify-azure-readiness"></a>Проверка готовности к работе в Azure

![Миграция Azure. Оценка готовности](./media/contoso-migration-assessment/azure-readiness.png)  

В отчете об оценке представлены сведения в виде таблицы. Для отображения размера на основе производительности службе "Миграция Azure" требуются следующие сведения. Если сведения невозможно собрать, оценка размера может быть неточной.

- Данные об использовании ЦП и памяти.
- Сведения об операциях записи и чтения в секунду и пропускной способности для каждого диска, присоединенного к виртуальной машине.
- Сведения о входящем и исходящем сетевом трафике для каждого сетевого адаптера, подключенного к виртуальной машине.

Параметр | Указание | Сведения
--- | --- | ---
**Готовность виртуальной машины Azure** | Указывает, готова ли виртуальная машина к миграции. | Возможны следующие состояния:</br><br/>— Ready for Azure (Готова к работе в Azure);<br/><br/>— Ready with conditions (Готова при выполнении условий); <br/><br/>— Not ready for Azure (Не готова к работе в Azure);<br/><br/>— "Уровень готовности неизвестен".<br/><br/> Если виртуальная машина не готова, служба "Миграция Azure" продемонстрирует шаги по устранению проблем.
**Размер виртуальной машины Azure** | Для готовых виртуальных машин служба "Миграция Azure" дает рекомендацию по размеру виртуальной машины Azure. | Рекомендация по размеру зависит от свойств оценки:<br/><br/>Если вы использовали размер на основе производительности, при определении размера учитывается история производительности виртуальных машин.<br/><br/>При определении размера как для *локальной виртуальной машины* учитывается размер локальной виртуальной машины, а данные об использовании — нет.
**Рекомендуемое средство** | Поскольку компьютеры Azure работают с агентами, служба "Миграция Azure" просматривает процессы, запущенные внутри компьютера. Она определяет, является ли он компьютером базы данных.
**Сведения о виртуальной машине** | В отчете показаны параметры локальной виртуальной машины, включая операционную систему, тип загрузки и данные о диске и хранилище.

#### <a name="review-monthly-cost-estimates"></a>Просмотр примерной стоимости в месяц

В этом представлении отображается общая стоимость вычислений и хранения для запуска виртуальных машин в Azure. Также отображаются сведения для каждого компьютера.

![Миграция Azure — затраты Azure](./media/contoso-migration-assessment/azure-costs.png)

- Ожидаемая стоимость рассчитывается с использованием рекомендаций по размеру для компьютера.
- Примерная ежемесячная стоимость вычислений и хранилища суммируется для всех виртуальных машин в группе.

## <a name="clean-up-after-assessment"></a>Очистка после оценки

- После завершения оценки Contoso сохраняет устройство службы "Миграция Azure" для будущих вычислений.
- Компания Contoso отключает виртуальную машину VMware. Компания Contoso будет использовать ее снова, когда она оценит дополнительные виртуальные машины.
- Компания Contoso сохраняет проект **Миграция компании Contoso** в Azure. В настоящее время проект развернут в **группе ресурсов ContosoFailoverRG** в регионе Azure "Восточная часть США".
-  Оценочная лицензия сборщика виртуальных машин действует 180 дней. Если этот период истечет, компании Contoso придется снова загружать и настраивать сборщик.

## <a name="conclusion"></a>Заключение

В этом случае компания Contoso оценивает базу данных приложений SmartHotel с помощью инструмента оценки миграции данных. Она оценивает локальные виртуальные машины приложения с помощью службы "Миграция Azure". Специалисты компании Contoso просматривают оценки, чтобы убедиться, что локальные ресурсы готовы к миграции в Azure.

## <a name="next-steps"></a>Дополнительная информация

В следующей статье из этой серии компания Contoso использует миграцию типа lift-and-shift, чтобы заново разместить приложения SmartHotel в Azure. Компания Contoso переносит приложение внешнего интерфейса WEBVM с помощью Azure Site Recovery. Она выполняет миграцию приложения базы данных в Управляемый экземпляр Базы данных SQL Azure с помощью Azure Database Migration Service. [Начните](contoso-migration-rehost-vm-sql-managed-instance.md) с этого развертывания:
