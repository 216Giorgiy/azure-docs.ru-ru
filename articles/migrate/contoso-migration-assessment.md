---
title: Оценка локальных рабочих нагрузок компании Contoso при миграции в Azure | Документация Майкрософт
description: Дополнительные сведения том, как компания Contoso проводит оценку своих локальных компьютеров перед миграцией в Azure. Для этого будут использованы такие средства, как служба "Миграция Azure" и миграция базы данных.
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 06/19/2018
ms.author: raynew
ms.openlocfilehash: fb987c95afc0f77386f4f78c44f3c6825f86ee43
ms.sourcegitcommit: 16ddc345abd6e10a7a3714f12780958f60d339b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2018
ms.locfileid: "36232221"
---
# <a name="contoso-migration-assess-on-premises-workloads-for-migration-to-azure"></a>Миграция компании Contoso. Оценка локальных рабочих нагрузок для миграции в Azure

В этой статье показано, как компания Contoso оценивает свое локальное приложение SmartHotel, перед тем как перенести его в Azure.

Это третий документ в цикле статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. Этот цикл содержит общие сведения и набор сценариев развертывания, которые иллюстрируют настройку инфраструктуры миграции, оценку пригодности локальных ресурсов для миграции и выполнение миграций различных типов. Сценарии излагаются в порядке роста сложности. Со временем мы добавим в этот цикл и другие статьи.

**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Предоставляет общие сведения о стратегии миграции Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Здесь демонстрируется, как компания Contoso подготавливает свою локальную инфраструктуру и инфраструктуру Azure к миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
Статья 3. Оценка локальных ресурсов (из этой статьи)  | Здесь показано, как Contoso выполняет оценку своего локального двухуровневого приложения SmartHotel в VMware. Для оценки виртуальных машин приложения в компании Contoso используют службу [Миграция Azure](migrate-overview.md), а базу данных SQL Server приложения оценивают с помощью [Помощника по миграции баз данных Azure](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
[Статья 4. Повторное размещение на виртуальных машинах Azure и в Управляемом экземпляре Базы данных SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Здесь демонстрируется выполняемый в Contoso процесс миграции приложения SmartHotel в Azure. При переносе данных в Управляемый экземпляр Базы данных SQL миграция внешней виртуальной машины приложения выполняется с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview), а базы данных приложения — с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Повторное размещение на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | Здесь показано, как Contoso переносит свои виртуальные машины приложения SmartHotel, используя только Site Recovery.
[Статья 6. Повторное размещение на виртуальных машинах Azure и в группах доступности SQL Server](contoso-migration-rehost-vm-sql-ag.md) | Здесь показан выполняемый в Contoso процесс миграции приложения SmartHotel. Миграция виртуальных машин приложения выполняется с помощью Site Recovery, а миграция базы данных приложения в группу доступности SQL Server — с помощью Database Migration Service. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Здесь демонстрируется, как Contoso переносит свое приложение osService для Linux, используя Azure Site Recovery.
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и сервере MySQL в Azure](contoso-migration-rehost-linux-vm-mysql.md) | Здесь демонстрируется, как Contoso переносит приложение osService для Linux, используя Site Recovery для миграции на виртуальные машины и MySQL Workbench для миграции в экземпляр Azure MySQL Server. | Доступна


## <a name="overview"></a>Обзор

Компании Contoso требуется провести техническую и финансовую оценку, чтобы выяснить, можно ли выполнить миграцию локальных рабочих нагрузок в облако Azure. В частности, компания хочет оценить совместимость компьютеров и баз данных для миграции и оценить емкость и затраты на управление своими ресурсами в Azure.

Чтобы лучше понять суть используемых технологий, для оценки они используют два локальных приложения, представленных в следующей таблице. Обратите внимание на то, что выполняется оценка для сценариев миграции при перемещении и рефакторинге приложений для миграции. Дополнительные сведения о перемещении и рефакторинге см. в статье [Общие сведения о миграции Contoso](contoso-migration-overview.md).

**Имя приложения** | **Платформа** | **Уровни приложения** | **Дополнительные сведения**
--- | --- | --- | ---
SmartHotel<br/><br/> Управляет требованиями для путешествия в компании Contoso | Выполняется в Windows с помощью базы данных SQL Server. | Двухуровневое приложение с веб-интерфейсом на ASP.NET на одной ВМ (WEBVM) и SQL Server на другой ВМ (SQLVM) | Виртуальные машины — это VMware, работающие на узле ESXi, управляемом сервером vCenter Server.<br/><br/> Образец приложения можно скачать из [GitHub](https://github.com/Microsoft/SmartHotel360).
OSTicket<br/><br/> Приложение службы поддержки компании Contoso | Выполняется в Apache на Linux с помощью MySQL PHP (LAMP). | Двухуровневое приложение с веб-интерфейсом на PHP на одной ВМ (OSTICKETWEB) и база данных MySQL на другой ВМ (OSTICKETMYSQL) | Приложение используется приложениями служб клиента для отслеживания проблем у внутренних сотрудников и внешних клиентов.<br/><br/> Образец приложения можно скачать из [GitHub](https://github.com/osTicket/osTicket).

## <a name="current-architecture"></a>Текущая архитектура


На схеме ниже показана текущая локальная инфраструктура компании Contoso.

![Архитектура Contoso](./media/contoso-migration-assessment/contoso-architecture.png)  

- У Contoso есть один основной центр обработки данных в Нью-Йорке (на востоке Соединенных Штатов Америки).
- У компании есть еще три местных филиала в других уголках США.
- Основной центр обработки данных подключается к Интернету с помощью оптоволоконного соединения Metro Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединения бизнес-класс и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Это обеспечивает постоянство подключения всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. В нем используется два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Для управления удостоверениями в Contoso используется Active Directory, а во внутренней сети применяются DNS-серверы.
- Контроллеры домена в центре обработки данных размещены в виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.





## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Вызов роста бизнеса**. По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.
- **Повышение эффективности**. Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для своих разработчиков и пользователей.  Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso нуждается в большей гибкости в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования.  Он не должен мешать или становиться помехой для бизнеса.
- **Масштабирование**. По мере того как бизнес успешно растет, ИТ-отдел компании Contoso должен предоставлять системы, способные расти с тем же темпом.

## <a name="assessment-goals"></a>Цели оценки

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой оценки миграции.

- После миграции приложения Azure должны иметь те же возможности с точки зрения производительности, что и в текущей локальной среде VMWare.  Переход в облако не означает, что производительность приложения сильно уменьшится.
- Компания Contoso должна понять, соответствуют ли ее приложения и базы данных требованиям Azure, а также их возможные варианты размещения в Azure.
- После перехода приложений в облако администрирование баз данных компании Contoso должно быть минимальным.  
- Компании необходимо получить сведения не только о параметрах миграции, но и о стоимости инфраструктуры после перехода в облако.

## <a name="assessment-tools"></a>Средства оценки
Компания Contoso использует для оценки средства корпорации Майкрософт. Эти средства соответствуют целям компании и должны предоставить ей все необходимые сведения.

**Технология** | **Описание** | **Стоимость**
--- | --- | ---
[Помощник по миграции баз данных (DMA)](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | DMA используется для оценки и выявления проблем совместимости, которые могут повлиять на функциональность их базы данных в Azure. Помощник оценивает соотношение характеристик между источниками и целями SQL и предоставляет рекомендации по улучшению производительности и надежности. | Это средство можно загрузить бесплатно.
[Миграция Azure](https://docs.microsoft.com/azure/migrate/migrate-overview) | Эта служба будет использоваться в компании Contoso для оценки собственных виртуальных машин VMware. Она оценивает пригодность компьютеров для миграции и предоставляет оценку размеров и стоимости для работы в Azure.  | В настоящее время (май 2018 года) за использование этой службы не взимается плата.
[Схема услуги](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-service-map) | Служба "Миграция Azure" использует решение "Сопоставление служб" для отображения зависимостей между компьютерами, которые вы хотите перенести. |  Это решение является частью службы Azure Log Analytics. Его можно использовать в течение 180 дней без каких-либо затрат.

В рамках этого сценария в компании Contoso будет загружен DMA, который затем будет запущен. Он получит доступ к локальной базе данных SQL Server и оценит приложение путешествий компании. В компании Contoso будет использоваться служба "Миграция Azure" с сопоставлением зависимостей для оценки виртуальных машин приложения, прежде чем переносить их в Azure.



## <a name="assessment-architecture"></a>Архитектура оценки


![Архитектура оценки миграции](./media/contoso-migration-assessment/migration-assessment-architecture.png)

- Contoso — это вымышленное имя, представляющее типичную крупную компанию. 
- Contoso использует локальный центр обработки данных (**contoso-datacenter**) с локальными контроллерами домена (CONTOSODC1, CONTOSODC2).
- Виртуальные машины VMware находятся на узле VMware ESXI 6.5. Узлы: **contosohost1**, **contosohost2**.
- Среда VMware находится под управлением сервера vCenter Server 6.5 (**venter**), запущенного на виртуальной машине.
- Приложение для путешествий SmartHotel
    - Приложение разбито на уровни и находится на двух виртуальных машинах, **WEBVM** и **SQLVM**.
    - Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com**.
    - Виртуальные машины используют центр обработки данных, для которого используется ОС Windows Server 2008 R2 с пакетом обновления 1 (SP1).
- Средой VMware управляет сервер vCenter Server (**vcenter.contoso.com**), который запущен на виртуальной машине.
- OSTicket — приложение службы поддержки.
    - У приложения есть два уровня, которые размещаются на двух виртуальных машинах, **OSTICKETWEB** и **OSTICKETMYSQL**.
    - Виртуальные машины работают на ОС Ubuntu Linux Server 16.04-LTS.
    - Виртуальная машина OSTICKETWEB работает на Apache 2 и PHP 7.0.
    - Виртуальная машина OSTICKETMYSQL работает на MySQL 5.7.22.

![Архитектура](./media/contoso-migration-assessment/architecture.png)


## <a name="prerequisites"></a>предварительным требованиям

Ниже приведены требования Contoso, необходимые для оценки.

- Доступ к подписке Azure на уровне участника или владельца или доступ к группе ресурсов в подписке Azure.
- Локальный сервер vCenter Server версии 5.5, 6.0 или 6.5.
- Учетная запись только для чтения на сервере vCenter Server или разрешения на ее создание.
- Разрешения на создание виртуальной машины на сервере vCenter Server с использованием шаблона в формате OVA.
- По крайней мере один узел ESXi версии 5.0 или выше.
- По крайней мере две виртуальные машины VMware, на одной из который выполняется база данных SQL Server.
- Разрешения на установку агентов службы "Миграция Azure" на каждой виртуальной машине.
- Виртуальные машины должны иметь прямое подключение к Интернету.
        Вы можете ограничить доступ к [требуемым URL-адресам](https://docs.microsoft.com/azure/migrate/concepts-collector#collector-pre-requisites) в Интернете.
        Если компьютер не подключен к Интернету, необходимо установить [Шлюз OMS](../log-analytics/log-analytics-oms-gateway.md).
- Полное доменное имя виртуальной машины, на которой запущен экземпляр SQL Server, для оценки базы данных.
- Чтобы DMA мог подключиться, брандмауэр Windows, работающий на виртуальной машине SQL Server, должен разрешать внешние подключения по TCP-порту 1433 (по умолчанию).


## <a name="assessment-overview"></a>Общие сведения об оценке

Процедура выполнения оценки компанией Contoso.


> [!div class="checklist"]
> * **Шаг 1. Скачивание и установка DMA**. Подготовка DMA для оценки локальной базы данных SQL Server.
> * **Шаг 2. Оценка базы данных**. Запуск и анализ оценки базы данных.
> * **Шаг 3. Подготовка к оценке виртуальной машины с помощью службы "Миграция Azure"**. Настройка локальных учетных записей и параметров VMware.
> * **Шаг 4. Обнаружение локальных виртуальных машин с помощью службы "Миграция Azure"**. Создание виртуальной машины сборщика миграции Azure. Затем запустим сборщик, чтобы обнаружить виртуальные машины для оценки.
> * **Шаг 5. Подготовка к анализу зависимостей с помощью службы "Миграция Azure"**. Установка агентов службы "Миграция Azure" на виртуальных машинах, чтобы получить сопоставление зависимостей между виртуальными машинами.
> * **Шаг 6. Оценка виртуальных машин с помощью службы "Миграция Azure"**. Проверка зависимостей, группировка виртуальных машин и выполнение оценки. После того как оценка будет выполнена, проанализируйте ее в процессе подготовки к миграции.


## <a name="step-1-download-and-install-the-dma"></a>Шаг 1. Скачивание и установка DMA

1. Компания Contoso загружает DMA из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53595).
    - Помощник может быть установлен на любом компьютере, который может подключиться к экземпляру SQL. Вам не нужно запускать его на компьютере SQL Server.
    - Он не должен быть установлен на на хост-компьютере SQL Server.
2. Чтобы начать установку, необходимо запустить загруженный файл (DownloadMigrationAssistant.msi).
3. Перед закрытием мастера на странице **Готово** необходимо выбрать **Launch Microsoft Data Migration Assistant** (Запустить помощник по миграции данных Майкрософт).

## <a name="step-2-run-and-analyze-the-database-assessment-for-smarthotel"></a>Шаг 2. Запуск и анализ оценки базы данных для SmartHotel

Теперь в компании Contoso можно запускать оценку анализа локального сервера SQL Server для приложения SmartHotel.

1. В Помощнике по миграции баз данных щелкните **Создать**, выберите **Оценка**, а затем назовите оценку именем проекта **SmartHotel**.
2. Выберите **Source server type** (Тип исходного сервера) в качестве параметра **SQL Server на виртуальных машинах Azure**. 

    ![Выбор источника](./media/contoso-migration-assessment/dma-assessment-1.png)

    > [!NOTE]
      В настоящее время DMA не поддерживает оценку для перехода на управляемый экземпляр SQL. В качестве возможного решения в компании Contoso используется SQL Server на виртуальной машине Azure в качестве предполагаемого целевого объекта оценки.

3. В поле **Выберите целевую версию** будет выбран SQL Server 2017. Выбирается именно эта версия, так как она используется для управляемого экземпляра SQL.
4. Для получения сведений о совместимости и новых функциях будут выбраны:
    - Параметр **Проблемы совместимости** позволяет зафиксировать изменения, которые могут прервать миграцию или для которых потребуется незначительная корректировка перед миграцией. Позволяет получать сведения о функциях, которые являются устаревшими, но на данный момент работают. Проблемы упорядочены по уровню совместимости.
    - Параметр **Рекомендации по новым функциям** фиксирует новые возможности целевой платформы SQL Server, которые можно использовать в базе данных после миграции. Они упорядочены по производительности, безопасности и типам хранилища.

    ![Выбор цели](./media/contoso-migration-assessment/dma-assessment-2.png)

2. На вкладке **Подключение к серверу** необходимо ввести имя виртуальной машины, на которой работает база данных, а также учетные данные для доступа к ней. Чтобы убедиться, что SQL Server доступен, необходимо установить флажок в поле **Доверять сертификату сервера**. Затем нужно щелкнуть **Подключение**.

    ![Выбор цели](./media/contoso-migration-assessment/dma-assessment-3.png)

3. Чтобы начать оценку, в поле **Добавить источник** необходимо добавить базу данных, к который требуется получить доступ, и щелкнуть **Далее**.
4. Оценка создана.
    
    ![Создание оценки](./media/contoso-migration-assessment/dma-assessment-4.png)

5. Результаты оценки можно увидеть в поле **Просмотр результатов**.


### <a name="analyze-the-database-assessment"></a>Анализ оценки базы данных

Как только результаты станут доступными, оны будут отображены. Чтобы вернуться к оценке (после исправления ошибок), щелкните **Перезапустить оценку**.

1. Ошибки, которые находятся на каждом уровне совместимости, можно проверить в поле **Проблемы совместимости**. Уровни совместимости сопоставляются с версиями SQL Server следующим образом:

    - 100: SQL Server 2008/база данных SQL Azure
    - 110: SQL Server 2012/база данных SQL Azure
    - 120: SQL Server 2014/база данных SQL Azure
    - 130: SQL Server 2016/база данных SQL Azure
    - 140: SQL Server 2017/база данных SQL Azure

    ![Проблемы совместимости](./media/contoso-migration-assessment/dma-assessment-5.png)

2. Функции для обеспечения производительности и безопасности, а также возможности хранения после миграции из отчета **Рекомендуемые возможности** могут быть просмотрены компанией Contoso. Рекомендуется использовать различные функции, в том числе выполняющуюся в памяти OLTP и columnstore, Stretch Database, Always Encrypted, динамическое маскирование данных и прозрачное шифрование данных (TDE).

    ![Рекомендуемые возможности](./media/contoso-migration-assessment/dma-assessment-6.png)

    > [!NOTE]
    > Компании Contoso рекомендуется [включить TDE](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017) для всех баз данных SQL Server, так как это является особенно важным, особенно когда базы данных находятся в облаке. Прозрачное шифрование данных можно включить только после миграции. Если прозрачное шифрование данных было включено, необходимо переместить сертификат или асимметричный ключ в базу данных master или на целевой сервер. [Узнайте больше](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017).

2. Затем оценку можно экспортировать в формате JSON или CSV.

Обратите внимание, что при проведении более масштабной оценки можно делать следующее:

- Можно одновременно выполнить несколько оценок и просмотреть их состояние, открыв страницу **​All Assessments** (Все оценки).
- Можно [консолидировать оценки в базе данных SQL Server](https://docs.microsoft.com/sql/dma/dma-consolidatereports?view=ssdt-18vs2017#import-assessment-results-into-a-sql-server-database).
- Можно [консолидировать оценки в отчете PowerBI](https://docs.microsoft.com/sql/dma/dma-powerbiassesreport?view=ssdt-18vs2017).


## <a name="step-3-prepare-for-vm-assessment-with-azure-migrate"></a>Шаг 3. Подготовка к оценке виртуальных машин с помощью службы "Миграция Azure"

Компании Contoso необходимо создать учетную запись VMware, которую служба "Миграция Azure" будет использовать для автоматического обнаружения виртуальных машин для оценки. Также необходимо убедиться в наличии разрешения на создание виртуальной машины, обратить внимание на порты, которые должны быть открыты, и установить уровень параметров статистики.

### <a name="set-up-a-vmware-account"></a>Настройка учетной записи VMware

 Обнаружению виртуальных машин требуется учетная запись только для чтения в vCenter, которая бы обладала следующими свойствами: 

- Потребуется по крайней мере пользователь только для чтения.
- Разрешения: объект центра обработки данных –> распространение на дочерний объект, роль только для чтения.
- Сведения: пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.
- Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

### <a name="verify-permissions-to-create-a-vm"></a>Проверка разрешений для создания виртуальной машины

Компания Contoso проверяет наличие разрешения на создание виртуальной машины путем импорта файла в формате OVA. [Узнайте больше](https://kb.vmware.com/s/article/1023189?other.KM_Utility.getArticleLanguage=1&r=2&other.KM_Utility.getArticleData=1&other.KM_Utility.getArticle=1&ui-comm-runtime-components-aura-components-siteforce-qb.Quarterback.validateRoute=1&other.KM_Utility.getGUser=1).

### <a name="verify-ports"></a>Проверка портов

При оценке компании Contoso используется сопоставление зависимостей. Для использования этой функции необходимо наличие установленного агента на виртуальных машинах, к которым необходимо получить доступ. Агент должен иметь возможность подключиться к Azure по TCP-порту 443 на каждой виртуальной машине. [Узнайте больше](https://docs.microsoft.com/azure/log-analytics/log-analytics-concept-hybrid) о требованиях к подключению.


### <a name="set-statistics-settings"></a>Настройка параметров статистики

Перед началом развертывания компания Contoso должна установить параметры статистики для 3 уровня сервера vCenter Server. Обратите внимание на следующее.

- После установки уровня нужно подождать по крайней мере один день, прежде чем приступить к оценке. В противном случае она может работать не так, как ожидалось.
- Если уровень выше 3, оценка будет работать, но при этом:
    - Данные о производительности дисков и сетей не будут собраны.
    - Для хранилища служба "Миграция Azure" рекомендует стандартный диск в Azure того же размера, что и локальный.
    - С точки зрения сети для каждого локального сетевого адаптера рекомендуется наличие сетевого адаптера в Azure.
    - С точки зрения среды выполнения приложений служба"Миграция Azure" анализирует количество ядер и объем памяти и рекомендует виртуальную машину Azure с такой же конфигурацией. Если доступно несколько соответствующих размеров виртуальных машин, служба выбирает рекомендуемый, который обеспечивает наименьшие затраты.
- [Дополнительные сведения](https://docs.microsoft.com/azure/migrate/concepts-assessment-calculation#sizing) о размерах при использовании уровня 3.

Уровень устанавливается следующим образом:

1. В веб-клиенте vSphere необходимо открыть экземпляр сервера vCenter Server.
2. Необходимо последовательно выбрать **Управление** > **Параметры** > **Общие сведения**, а затем щелкнуть **Редактирование**.
3. А на вкладке **Статистика** необходимо установить для уровня статистики значение **Уровень 3**.

    ![Установка уровня статистики vCenter](./media/contoso-migration-assessment/vcenter-statistics-level.png)



## <a name="step-4-discover-vms"></a>Шаг 4. Обнаружение виртуальных машин

Компания Contoso создает проект службы "Миграция Azure" для обнаружения виртуальных машин. Для обнаружения локальных виртуальных машин будет загружен сборщик, который в последствии будет настроен, а затем запущен.

### <a name="create-a-project"></a>Создание проекта

1. На [портале Azure](https://portal.azure.com) необходимо найти службу **Миграция Azure** и создать проект (ContosoMigration).
2. Укажите имя проекта, подписку Azure и создайте новую группу ресурсов Azure **ContosoFailoverRG**. Обратите внимание на следующее.

    - Проект службы "Миграция Azure" можно создать только в регионах "Западно-центральная часть США" и "Восточная часть США".
    - Можно запланировать перенос в любое целевое расположение.
    - В расположении проекта хранятся только метаданные, собранные с локальных виртуальных машин.

    ![Служба "Миграция Azure"](./media/contoso-migration-assessment/project-1.png)


### <a name="download-the-collector-appliance"></a>Скачивание модуля сборщика

Служба "Миграция Azure" создает локальную виртуальную машину, известную как модуль сборщика. Эта виртуальная машина обнаруживает локальные виртуальные машины VMware и отправляет метаданные о них в службу "Миграция Azure". Чтобы настроить модуль сборщика, компанией Contoso будет загружен шаблон в формате OVA, который будет импортирован на локальный сервер vCenter Server для создания виртуальной машины.

1. Щелкните проект службы "Миграция Azure" > **Начало работы** > **Обнаружение и оценка** > **Обнаружение компьютеров** и загрузите шаблон файла в формате OVA.
2. Скопируйте идентификатор и ключ проекта. Они требуются для настройки сборщика.

    ![Скачивание OVA-файла](./media/contoso-migration-assessment/download-ova.png)

### <a name="verify-the-collector-appliance"></a>Проверка модуля сборщика

Прежде чем развертывать OVA-файл, компания Contoso проверяет, что он не поврежден.

1. Далее на компьютере, на который был загружен файл, необходимо открыть командное окно с правами администратора.
2. Чтобы создать хэш OVA-файла, необходимо выполнить следующую команду.
    - ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```
    - Пример использования: ```C:\>CertUtil -HashFile C:\AzureMigrate\AzureMigrate.ova SHA256```
3. Созданный хэш должен соответствовать этим параметрам (версия 1.0.9.7).

    **Алгоритм** | **Значение хэша**
    --- | ---
    MD5 | d5b6a03701203ff556fa78694d6d7c35
    SHA1 | f039feaa10dccd811c3d22d9a59fb83d0b01151e
    SHA256 | e5e997c003e29036f62bf3fdce96acd4a271799211a84b34b35dfd290e9bea9c


### <a name="create-the-collector-appliance"></a>Создание модуля сборщика

Теперь у компании Contoso появилась возможность импортировать загруженный файл на сервер vCenter Server и подготовить сервер конфигурации виртуальной машины.

1. В консоли клиента vSphere щелкните **Файл** > **Deploy OVF Template** (Развернуть шаблон OVF).

    ![Развертывание шаблона OVF](./media/contoso-migration-assessment/vcenter-wizard.png)

2. В мастере развертывания шаблона OVF необходимо выбрать **Source** (Источник) и указать расположение OVA-файла.
3. В полях **имени и расположения** укажите понятное имя виртуальной машины сборщика и расположение объекта инвентаризации, в котором будет размещена эта виртуальная машина. Также необходимо указать узел или кластер, в котором будет выполняться модуль сборщика.
5. В поле **Хранилище** необходимо указать место хранения, а в поле **Формат диска** способ подготовки хранилища.
7. В поле **Сетевое сопоставление** указывается сеть, к которой будет подключена виртуальная машина сборщика. Этой сети требуется подключение к Интернету для отправки метаданных в Azure.
8. Проверьте настройки и установите флажок **Power on after deployment**(Включить питание после развертывания)> **Готово**. После создания модуля отобразится сообщение об успешном завершении.

### <a name="run-the-collector-to-discover-vms"></a>Запуск сборщика для обнаружения виртуальных машин

Теперь, чтобы обнаружить виртуальные машины, необходимо запустить сборщик. Обратите внимание, что в данный момент сборщик поддерживает только "Английский (США)" в качестве языка операционной системы и языка интерфейса сборщика.

1. Щелкните "консоль клиента vSphere" > **Открыть консоль**, затем для сборщика виртуальной машины необходимо указать язык, часовой пояс и предпочтительный пароль.
2. На рабочем столе необходимо щелкнуть ярлык **Run collector** (Запустить сборщик).

    ![Ярлык сборщика](./media/contoso-migration-assessment/collector-shortcut.png)

4. Щелкните "Сборщик Миграции Azure" > **Настройка необходимых компонентов**, затем примите условия лицензионного соглашения и ознакомьтесь с информацией от сторонних производителей.
5. Сборщик проверяет, что виртуальная машина имеет доступ к Интернету, время синхронизировано и служба сборщика запущена (она установлена ​​по умолчанию на виртуальной машине). Также он устанавливает VMware PowerCLI 6.5.

    > [!NOTE]
    > Предполагается, что виртуальная машина имеет прямой доступ к Интернету без прокси-сервера.

    ![проверка предварительных требований;](./media/contoso-migration-assessment/collector-verify-prereqs.png)


5. На вкладке **Укажите сведения о vCenter Server** необходимо указать имя (FQDN) или IP-адрес сервера vCenter Server, а также учетные данные только для чтения, используемые для обнаружения.
7. И выбрать область для обнаружения виртуальных машин. Сборщик может обнаруживать только виртуальные машины в указанной области. Областью может быть определенная папка, центр обработки данных или кластер. Область не должна содержать более 1500 виртуальных машин.

    ![Подключение к vCenter](./media/contoso-migration-assessment/collector-connect-vcenter.png)

6. В разделе **Укажите проект миграции** необходимо указать идентификатор и ключ проекта службы "Миграция Azure", которые были скопированы на портале. На странице проекта **Общие сведения** > **Обнаружение компьютеров** их можно получить повторно.  

    ![Подключение к Azure](./media/contoso-migration-assessment/collector-connect-azure.png)

7. В окне **Просмотр хода выполнения сбора** компания Contoso может проводить наблюдения за обнаружением и убедиться, что в области обнаружения собираются метаданные с виртуальных машин. Сборщик предоставляет приблизительное время завершения обнаружения.

    ![Выполняется сборка](./media/contoso-migration-assessment/collector-collection-process.png) 



### <a name="verify-vms-in-the-portal"></a>Проверка виртуальных машин на портале

После завершения сборки компанией Contoso будет выполнена проверка виртуальных машин, которые отображаются на портале.

1. Щелкните проект службы "Миграция Azure" > **Управление** > **Компьютеры** и проверьте, появились ли компьютеры, которые необходимо проверить.

    ![Обнаруженные компьютеры](./media/contoso-migration-assessment/discovery-complete.png)

3. Обратите внимание, что в настоящее время на компьютерах не установлены агенты службы "Миграция Azure". Для просмотра зависимостей компании Contoso их обязательно необходимо установить.

    ![Обнаруженные компьютеры](./media/contoso-migration-assessment/machines-no-agent.png)



## <a name="step-5-prepare-for-dependency-analysis"></a>Шаг 5. Подготовка к анализу зависимостей

Чтобы просмотреть зависимости между виртуальными машинами, к которым компания Contoso хочет получить доступ, для них необходимо загрузить агенты и провести установку. Эти действия предпринимаются для всех приложений виртуальных машинах, которые работают как на ОС Windows, так и на ОС Linux.

### <a name="take-a-snapshot"></a>Создание моментального снимка

Выполнение моментального снимка виртуальной машины перед установкой агента позволяет сохранить ее копию перед изменением.

![Моментальный снимок компьютера](./media/contoso-migration-assessment/snapshot-vm.png)


### <a name="download-and-install-the-vm-agents"></a>Скачивание и установка агентов виртуальной машины

1. На странице **Компьютеры** необходимо выбрать компьютер, а затем **Требует установки** в столбце **Зависимости**.
2. На странице **Обнаружение компьютеров** они должны выполнить следующие действия.
    - Загрузить MMA и агент зависимостей для каждой виртуальной машины Windows
    - Загрузить MMA и агент зависимостей для каждой виртуальной машины Linux
3. Скопировать идентификатор и ключ рабочей области. Они окажутся необходимыми при установке MMA.

    ![Скачивание агента](./media/contoso-migration-assessment/download-agents.png)

### <a name="install-the-agents-on-windows-vms"></a>Установите агент для виртуальных машин Windows

Запустите установку на каждой виртуальной машине.

#### <a name="install-the-mma-on-windows-vms"></a>Установите MMA для виртуальных машин Windows

1. Дважды щелкните скачанный файл агента.
2. В поле **Конечная папка** необходимо оставить папку установки по умолчанию. > Нажмите кнопку **Далее**.
2. В окне **Параметры установки агента** необходимо установить флажок **Connect the agent to Azure Log Analytics** (Подключить агент к Azure Log Analytics) и нажать кнопку  > **Далее**.

    ![Установка MMA](./media/contoso-migration-assessment/mma-install.png)
    
5. В окне **Azure Log Analytics** необходимо вставить идентификатор и ключ рабочей области, скопированные на портале. 

    ![Установка MMA](./media/contoso-migration-assessment/mma-install2.png)

6. Теперь можно установить MMA на странице **Ready to Install** (Все готово для установки).

#### <a name="install-the-dependency-agent-on-windows-vms"></a>Установка агента зависимостей на виртуальные машины Windows

1. Дважды щелкните загруженный файл агента зависимостей.
2. Примите условия лицензионного соглашения и подождите окончания установки.

    ![Агент зависимостей](./media/contoso-migration-assessment/dependency-agent.png)


### <a name="install-the-agents-on-linux-vms"></a>Установка агентов на виртуальные машины Linux

Запустите установку на каждой виртуальной машине.

#### <a name="install-the-mma-on-linux-vms"></a>Установите MMA для виртуальных машин Linux

1. С помощью команды **sudo apt-get install python-ctypeslib** установите библиотеки ctypes Python на каждую виртуальную машину.
2. Чтобы установить агент MMA, команды должны быть запущены от имени привилегированного пользователя.  Чтобы стать привелигированным пользователем выполните команду **sudo -i** и введите пароль.
3. Теперь установите агент MMA.
    - В команду необходимо ввести верный ключ и идентификатор рабочей области.
    - Команды предназначены для 64-разрядных систем.
    - **Идентификатор рабочей области** и **Первичный ключ** можно найти на портале OMS > **Параметры**, на вкладке **Подключенные источники**.
    - Чтобы скачать агент OMS, выполните следующие команды, проверьте контрольную сумму, а также установите и внедрите агент.

    ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -w 6b7fcaff-7efb-4356-ae06-516cacf5e25d -s k7gAMAw5Bk8pFVUTZKmk2lG4eUciswzWfYLDTxGcD8pcyc4oT8c6ZRgsMy3MmsQSHuSOcmBUsCjoRiG2x9A8Mg==
    ```
 


#### <a name="install-the-dependency-agent-on-linux-vms"></a>Установка агента зависимостей на виртуальные машины Linux

После установки MMA, компания Contoso может установить агент зависимостей на виртуальные машины Linux.

1. Агент зависимостей устанавливается на компьютерах Linux с использованием файла InstallDependencyAgent-Linux64.bin. Это сценарий оболочки с самоизвлекающимся двоичным файлом. Файл можно запустить с помощью команды "sh" или добавить разрешения на выполнение в сам файл.

2. В качестве привилегированного пользователя установите агент зависимостей на Linux.

    ```
    wget --content-disposition https://aka.ms/dependencyagentlinux -O InstallDependencyAgent-Linux64.bin && sudo sh InstallDependencyAgent-Linux64.bin -s
    ```


## <a name="step-6-run-and-analyze-the-vm-assessment"></a>Шаг 6. Запуск и анализ оценки виртуальных машин

Теперь компания Contoso может проверить зависимости компьютера и создать группу. Затем необходимо запустить оценку для группы.

### <a name="verify-dependencies-and-create-a-group"></a>Проверка зависимостей и создание группы


1. Для анализа компьютеров щелкните **Показать зависимости**.

    ![Просмотр зависимостей компьютера](./media/contoso-migration-assessment/view-machine-dependencies.png)

2. На карте зависимостей SQLVM появятся следующие сведения:

    - Группы процессов или процессы с активными сетевыми соединениями, запущенными на SQLVM, в течение указанного периода времени (час по умолчанию).
    - Входящие (клиент) и исходящие (сервер) TCP-подключения всех зависимых компьютеров.
    - Зависимые компьютеры с установленными агентами службы "Миграция Azure" показаны в виде отдельных полей.
    - Для компьютеров без установленных агентов отображаются сведения о портах и ​​IP-адресах.

3. Для компьютеров с установленным агентом (WEBVM) необходимо щелкнуть поле компьютера, чтобы просмотреть дополнительные сведения, включая полное доменное имя, операционную систему и MAC-адрес.

    ![Просмотр зависимостей группы](./media/contoso-migration-assessment/sqlvm-dependencies.png)

4. Теперь необходимо выбрать виртуальные машины, которые будут добавлены в группы (SQLVM и WEBVM).  Для выбора нескольких виртуальных машин удерживайте клавишу CTRL и щелкните их.
5. Щелкните **Создать группу** и укажите имя (smarthotelapp).

> [!NOTE]
    > Чтобы просмотреть более подробные зависимости, можно расширить диапазон времени. Можно выбрать конкретную продолжительность или даты начала и окончания.


### <a name="run-an-assessment"></a>Запуск оценки


1. На странице **Группы**  откройте группу (smarthotelapp) и щелкните **Создание оценки**.

    ![Создание оценки](./media/contoso-migration-assessment/run-vm-assessment.png)

2. Оценка отображается на странице **Управление** > **Оценки**.

Компания Contoso использует параметры оценки по умолчанию, но это не является обязательным. [Узнайте больше](how-to-modify-assessment.md).



### <a name="analyze-the-vm-assessment"></a>Анализ оценки виртуальных машин

Оценка службы "Миграция Azure" включает в себя информацию о совместимости локальных виртуальных машин с Azure, правильном размере для виртуальной машины Azure, а также предполагаемые ежемесячные затраты в Azure.

![Отчет об оценке](./media/contoso-migration-assessment/assessment-overview.png)

#### <a name="review-confidence-rating"></a>Просмотр рейтинга достоверности

![Отображение оценки](./media/contoso-migration-assessment/assessment-display.png)

Оценка получает рейтинг достоверности от 1 до 5 звезд (1 звезда — самый низкий, а 5 звезд — самый высокий).
- Оценка достоверности назначается на основе доступности точек данных, необходимых для вычисления оценки.
- Это помогает оценить надежность рекомендаций по выбору размера, предоставленных службой "Миграция Azure".
- Оценка достоверности необходима, если вы *определяете размер на основе производительности*, так как служба "Миграция Azure" может не иметь достаточного количества точек данных для определения размера на основе использования. При *определении размера как для локальной виртуальной машины* значение оценки достоверности всегда равно 5 звездам, так как в службе "Миграция Azure" есть все данные для определения размера виртуальной машины.
- В зависимости от процента доступных точек данных оценка достоверности может быть такой:

   **Уровень доступности точек данных** | **Оценка достоверности**
   --- | ---
   0–20 % | 1 звезда
   21–40 % | 2 звезды
   41–60 % | 3 звезды
   61–80 % | 4 звезды
   81–100 % | 5 звезд

#### <a name="verify-readiness"></a>Проверка готовности

![Оценка готовности](./media/contoso-migration-assessment/azure-readiness.png)  

В отчете об оценке представлены сведения в виде таблицы. Обратите внимание, что для отображения размера на основе производительности службе "Миграция Azure" требуются следующие сведения. Если эти сведения невозможно собрать, оценка размера может быть неточной.

- Данные об использовании ЦП и памяти.
- Сведения об операциях записи и чтения в секунду и пропускной способности для каждого диска, присоединенного к виртуальной машине.
- Сведения о входящем и исходящем сетевом трафике для каждого сетевого адаптера, подключенного к виртуальной машине.


**Параметр** | **Указание** | **Дополнительные сведения**
--- | --- | ---
**Готовность виртуальной машины Azure** | Указывает, готова ли виртуальная машина к миграции. | Возможны следующие состояния:</br><br/>— Ready for Azure (Готова к работе в Azure);<br/><br/>— Ready with conditions (Готова при выполнении условий); <br/><br/>— Not ready for Azure (Не готова к работе в Azure);<br/><br/>— "Уровень готовности неизвестен".<br/><br/> Если виртуальная машина не готова, вы увидите шаги по устранению проблем.
**Размер виртуальной машины Azure** | Для готовых виртуальных машин мы рекомендуем размер виртуальной машины Azure. | Рекомендация по размеру зависит от свойств оценки:<br/><br/>Если вы использовали размер на основе производительности, при определении размера учитывается история производительности виртуальных машин.<br/><br/>При определении размера как для локальной виртуальной машины учитывается размер локальной виртуальной машины, а данные об использовании — нет.
**Рекомендуемое средство** | Так как агенты установлены на компьютерах, служба "Миграция Azure" просматривает процессы, выполняемые внутри компьютера, и определяет, является ли он компьютером базы данных.
**Сведения о виртуальной машине** | В отчете показаны параметры локальной виртуальной машины, включая операционную систему, тип загрузки, данные о диске и хранилище.


#### <a name="review-monthly-cost-estimates"></a>Просмотр примерной стоимости в месяц

В этом представлении отображается общая стоимость вычислений и хранения для запуска виртуальных машин в Azure, а также сведения для каждой машины.

![Оценка готовности](./media/contoso-migration-assessment/azure-costs.png)

- Ожидаемая стоимость рассчитывается с использованием рекомендаций по размеру для виртуальной машины.
- Примерная ежемесячная стоимость вычислений и хранилища суммируется для всех виртуальных машин в группе.


## <a name="clean-up-after-assessment"></a>Очистка после оценки

- После завершения оценки Contoso сохраняет устройство миграции Azure для будущих оценок.
- Они отключают ВМ VMware. Они запустят их снова после оценки дополнительных ВМ.
- Они сохранят проект миграции Contoso в Azure.  В настоящее время развертывается в группе ресурсов ContosoFailoverRG в Azure, восточная часть США.
-  Ознакомительная версия сборщика виртуальных машин действует 180 дней. Если этот период истечет, придется снова скачивать и настраивать сборщик.


## <a name="conclusion"></a>Заключение

В рамках этого сценария компания Contoso выполнила оценку базы данных своего приложения SmartHotel с помощью средства DMA и локальных виртуальных машин службы "Миграция Azure". Затем специалисты компании Contoso просмотрели оценки, чтобы убедиться, что локальные ресурсы готовы к миграции в Azure.

## <a name="next-steps"></a>Дополнительная информация

В следующей статье из этой серии компания Contoso использует миграцию типа lift-and-shift, чтобы заново разместить приложения SmartHotel в Azure. Contoso переносит интерфейсную WEBVM приложения с помощью Azure Site Recovery. Базу данных приложения она переносит в управляемый экземпляр SQL Azure с помощью Database Migration Service. [Начните](contoso-migration-rehost-vm-sql-managed-instance.md) с этого развертывания:
