<properties 
	pageTitle="Использование локальных кодировщиков для передачи динамического потока с несколькими скоростями в канал" 
	description="В этом разделе описывается настройка канала, который получает динамический поток с поддержкой нескольких скоростей от локального кодировщика. Затем поток можно передать в клиентские приложения для воспроизведения через одну или несколько конечных точек с помощью одного из следующих протоколов адаптивной потоковой передачи: HLS, Smooth Stream, MPEG DASH, HDS." 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="ne" 
	ms.topic="article" 
	ms.date="04/06/2015" 
	ms.author="juliako"/>

#Использование локальных кодировщиков для передачи динамического потока с несколькими скоростями в канал

##Обзор

В службах мультимедиа Azure (AMS) **канал** представляет конвейер для обработки динамического потокового контента. **Программа** позволяет управлять публикацией и хранением сегментов в динамическом потоке. Каналы управляют программами. Отношение между каналом и программой очень похоже на традиционные мультимедиа, где канал передает постоянный поток контента, а программа ограничена временным событием на этом канале. 

При работе с потоковой передачей один из компонентов, участвующих в рабочем процессе, - это динамический видеокодировщик, который преобразует сигналы от камеры в потоки, передаваемые службе динамической потоковой передачи. **Канал** может получать динамические входные потоки от локального динамического кодировщика, который выводит поток с разными скоростями RTMP или поток Fragmented MP4 (Smooth Streaming). Можно использовать следующие динамические кодировщики для вывода контента Smooth Streaming: Elemental, Envivio и Cisco.  Следующие динамические кодировщики выводят контент RTMP: Adobe Flash Live, Telestream Wirecast и Tricaster. Переданные потоки проходят через **канал**ы без дополнительной обработки. Динамический кодировщик также принимает поток с одной скоростью передачи, но, поскольку поток не обрабатывается, клиентские приложения также будут получать поток с одной скоростью (этот вариант не рекомендуется). После публикации полученный контент может передаваться клиентским приложениям для воспроизведения через одну или несколько **конечных точек потоковой передачи**. Для воспроизведения потока можно использовать следующие протоколы адаптивной потоковой передачи: HLS, MPEG DASH, Smooth Stream, HDS. 

**Конечная точка потоковой передачи** - это служба потоковой передачи, которая может доставить содержимое непосредственно в клиентское приложение проигрывателя или в сеть доставки содержимого (CDN) для дальнейшего распространения. Исходящим потоком службы конечной точки потоковой передачи может быть ресурс динамического потока или видео по запросу в учетной записи служб мультимедиа. Кроме того, чтобы справиться с растущими потребностями в пропускной способности, можно контролировать мощности службы конечной точки потоковой передачи, регулируя число зарезервированных единиц потоковой передачи. Необходимо выделить хотя бы одну зарезервированную единицу для приложений в рабочей среде. Дополнительную информацию см. в разделе [Масштабирование службы мультимедиа](media-services-manage-origins.md#scale_streaming_endpoints).

На следующей диаграмме показан рабочий процесс динамической потоковой передачи, использующий локальный динамический кодировщик для вывода потоков с разными скоростями RTMP или Fragmented MP4 (Smooth Streaming). 

![Обзор динамического][live-overview]

В этом разделе описывается канал, который получает динамический поток с поддержкой нескольких скоростей от локального кодировщика. Здесь также описаны компоненты, связанные с каналами.

##<a id="scenarios"></a>Распространенный сценарий динамической потоковой передачи

Далее описываются задачи, связанные с созданием распространенных приложений динамической потоковой передачи.

1. Подключите видеокамеру к компьютеру. Запустите и настройте локальный динамический кодировщик, который выводит поток с разными скоростями RTMP или поток Fragmented MP4 (Smooth Streaming). Дополнительные сведения см. в разделе [Поддержка RTMP в службах мультимедиа Azure и динамические кодировщики](http://go.microsoft.com/fwlink/?LinkId=532824).
	
	Этот шаг также может быть выполнен после создания канала.

1. Создайте и запустите канал.
1. Получите URL-адрес приема канала. 

	URL-адрес приема используется динамическим кодировщиком для отправки потока в канал.
1. Получите URL-адрес предварительного просмотра канала. 

	Используйте этот URL-адрес, чтобы убедиться, что канал правильно получает поток.

2. Создайте ресурс.
3. Чтобы ресурс динамически шифровался во время воспроизведения, выполните следующие действия. 	
	
	1. 	Создайте ключ контента. 
	1. 	Настройте политику авторизации ключа контента.
1. Настройте политику доставки ресурсов (используется при динамической упаковке и динамическом шифровании).
3. Создайте программу и выберите созданный ресурс.
1. Опубликуйте ресурс, связанный с программой, создав указатель OnDemand.  

	Убедитесь, что имеется хотя бы одна зарезервированная единица потоковой передачи для конечной точки потоковой передачи, из которой будет передаваться поток.
1. Запустите программу, когда будете готовы к запуску потоковой передачи и архивированию.
1. Останавливайте программу, когда нужно остановить потоковую передачу и архивировать событие.
1. Удаление программы (и дополнительное удаление ресурса).   

В разделе [Задачи динамической потоковой передачи](media-services-manage-channels-overview.md#tasks) представлены ссылки на разделы, где описывается, как выполнить задачи, описанные выше.


##<a id="channel_input"></a>Конфигурации канала ввода (приема)

###<a id="ingest_protocols"></a>Протокол потоковой передачи приема

Службы мультимедиа поддерживают прием динамических каналов с использованием следующих протоколов потоковой передачи: 

- **Fragmented MP4 с поддержкой разных скоростей;**
 
- **RTMP с поддержкой разных скоростей.** 

	Если выбран протокол потоковой передачи **RTMP**, для канала создаются две конечные точки приема (ввода): 
	
	**Основной URL-адрес**: задает полный URL-адрес основной конечной точки приема RTMP канала.

	**Дополнительный URL-адрес**(необязательно): задает полный URL-адрес дополнительной конечной точки приема RTMP канала. 

	Используйте дополнительный URL-адрес, чтобы улучшить надежность и отказоустойчивость потока приема, а также отказоустойчивость кодировщика. 
	
	- Улучшение надежности и отказоустойчивости приема:
		
		используйте один кодировщик для отправки одних и тех же данных на основной и дополнительный URL-адрес приема. Большинство кодировщиков RTMP (например, Flash Media Encoder и Wirecast) могут использовать основной и дополнительный URL-адрес.

	- Отработка отказа и отказоустойчивость кодировщика:
		
		используйте несколько кодировщиков для формирования одних и тех же данных и их отправки на основной и дополнительный URL-адрес приема. Такой подход повышает надежность приема и уровень доступности кодировщика. Примечание. Кодировщик должен поддерживать сценарий высокого уровня доступности и синхронизировать время изнутри (дополнительные сведения см. в документации кодировщика).
	
 	Для использования дополнительного URL-адреса приема требуется дополнительная пропускная способность. 

Вы можете принимать поток с одной скоростью передачи для канала, но, поскольку поток не обрабатывается каналом, клиентские приложения также будут получать поток с одной скоростью (этот вариант не рекомендуется).

Сведения о динамических кодировщиках RTMP см. в разделе [Поддержка RTMP в службах мультимедиа Azure и динамические кодировщики](http://go.microsoft.com/fwlink/?LinkId=532824).

Действительны следующие условия.

- Убедитесь, что имеется достаточно свободных возможностей подключения к Интернету для отправки данных точкам приема. 
- Входящий поток с разными скоростями может предоставлять не более 10 уровней качества видео (слоев) и не более 5 звуковых дорожек.
- Наибольшая средняя скорость передачи для любого из уровней качества видео не должна превышать 10 Мбит/с.
- Общее значение средних скоростей для всех видео- и аудиопотоков всегда должно быть меньше 25 Мбит/с.
- Входной протокол не может быть изменен, если канал или связанные с ним программы запущены. Если требуются различные протоколы, необходимо создать отдельные каналы для каждого входного протокола. 


###URL-адреса приема (конечные точки) 

Канал предоставляет входную конечную точку (URL-адрес приема), которая определяется в динамическом кодировщике, чтобы кодировщик мог передать потоки в каналы.   

URL-адреса приема можно получить при создании канала. Получить эти URL-адреса можно только тогда, когда канал не запущен. Когда все готово для начала передачи данных в канал, канал должен быть запущен. После того как канал начинает принимать данные, можно просмотреть поток через URL-адрес предварительного просмотра потока.

Предусмотрена возможность приема динамического потока Fragmented MP4 (Smooth Streaming) по SSL-подключению. Для приема по протоколу SSL измените URL-адрес приема на HTTPS. В настоящее время прием RTMP по протоколу SSL не поддерживается. 

###<a id="keyframe_interval"></a>Интервал опорного кадра

При использовании локального динамического кодировщика для формирования потока с поддержкой нескольких скоростей интервал опорного кадра определяет длительность GOP (которая используется внешним кодировщиком). После получения входящего потока каналом вы можете предоставить динамический поток клиентским приложениям для воспроизведение в любом из следующих форматов: Smooth Streaming, DASH и HLS. При динамической потоковой передаче HLS всегда упаковывается динамически. По умолчанию службы мультимедиа автоматически вычисляют соотношение упаковки сегмента HLS (число фрагментов на сегмент) на основе интервала опорного кадра, который также называется "группа кадров", полученного из динамического кодировщика. 

В следующей таблице показано вычисление длительности сегментов.

<table border="1">
<tr><th>Интервал опорного кадра</th><th>Соотношение упаковки сегмента HLS (FragmentsPerSegment)</th><th>Пример</th></tr>
<tr><td>меньше или равно 3 секундам</td><td>3:1</td><td>Если значение KeyFrameInterval (или GOP) равно 2 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 3 к 1, что приведет к созданию сегмента HLS длительностью 6 секунд.</td></tr>
<tr><td>3-5 секунд</td><td>2:1</td><td>Если значение KeyFrameInterval (или GOP) равно 4 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 2 к 1, что приведет к созданию сегмента HLS длительностью 8 секунд.</td></tr>
<tr><td>более 5 секунд</td><td>1:1</td><td>Если значение KeyFrameInterval (или GOP) равно 6 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 1 к 1, что приведет к созданию сегмента HLS длительностью 6 секунд.</td></tr>
</table>

Можно изменить соотношение фрагментов на сегмент, настроив вывод канала и установив параметр FragmentsPerSegment в ChannelOutputHls. 

Также можно изменить значение интервала опорного кадра, установив свойство KeyFrameInterval в ChanneInput. 

Если явно задать значение KeyFrameInterval, соотношение упаковки сегмента HLS, FragmentsPerSegment, вычисляется с помощью правил, описанных выше.  

Если явно задать свойства KeyFrameInterval и FragmentsPerSegment, службы мультимедиа будут использовать значения, указанные пользователем. 


###Разрешенные IP-адреса

Вы можете определить IP-адреса, на которых разрешена публикация видео для этого канала. Разрешенные IP-адреса можно указать как IP-адрес (например, 10.0.0.1) или диапазон IP-адресов, используя IP-адрес и маску подсети CIDR (например, 10.0.0.1/22) или IP-адрес и маску подсети с точками (например, 10.0.0.1(255.255.252.0)). 

Если IP-адреса не указаны и правила не заданы, ни один IP-адрес не разрешен. Чтобы разрешить все IP-адреса, создайте правило и задайте диапазон 0.0.0.0/0.

##Предварительный просмотр канала 

###URL-адреса предварительного просмотра

Каналы предоставляют конечную точку предварительного просмотра (URL-адрес предварительного просмотра), используемого для предварительного просмотра и проверки вашего потока перед дальнейшей обработкой и доставкой.

URL-адрес предварительного просмотра можно получить при создании канала. Это можно сделать, только когда канал не запущен. 

После запуска канала можно выполнить предварительный просмотр потока.

Обратите внимание, что в настоящее время поток предварительного просмотра может предоставляться только в формате Fragmented MP4 (Smooth Streaming), независимо от указанного типа входных данных. Для тестирования Smooth Stream можно использовать проигрыватель [http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor). Также для просмотра потока можно воспользоваться проигрывателем, размещенным на портале управления.


###Разрешенные IP-адреса

Вы можете определить IP-адреса, которым разрешено подключение к конечной точке предварительного просмотра. Если IP-адреса не указаны, разрешены любые IP-адреса. Разрешенные IP-адреса можно указать как IP-адрес (например, 10.0.0.1) или диапазон IP-адресов, используя IP-адрес и маску подсети CIDR (например, 10.0.0.1/22) или IP-адрес и маску подсети с точками (например, 10.0.0.1(255.255.252.0)).

##Вывод канала

Дополнительные сведения см. в разделе [Настройка интервала опорного кадра](#keyframe_interval) .


##Программы канала

Канал связан с программами, которые позволяют управлять публикацией и хранением сегментов в динамическом потоке. Каналы управляют программами. Отношение между каналом и программой очень похоже на традиционные мультимедиа, где канал передает постоянный поток контента, а программа ограничена временным событием на этом канале.

Вы можете указать количество часов, в течение которого записанный контент должен сохраняться для программы, установив длину **архивного окна**. Это значение может быть задано в диапазоне от 5 минут до 25 часов. Оно также указывает максимальное время, на которое клиенты могут вернуться назад от текущей позиции. Программы могут выходить за указанный промежуток времени, но содержимое за пределами этого промежутка постоянно удаляется. Значение этого свойства также определяет, насколько могут увеличиваться в объеме клиентские манифесты.

Каждая программа связана с ресурсом. Чтобы опубликовать программу, необходимо создать указатель OnDemand для связанного ресурса. Наличие этого указателя позволит создать URL-адрес потоковой передачи, который можно предоставить клиентам.

Канал поддерживает до трех одновременных программ, за счет чего можно создавать несколько архивов с использованием одного и того же входящего потока. Это позволяет публиковать и архивировать разные части события по необходимости. Например ваш бизнес-требование - архивировать 6 часов программы, но для передачи только оставить последние 10 минут. Для этого необходимо создать две параллельно выполняющиеся программы. Одна программа имеет значение для архивирования 6 часов с момента события, но эта программа не публикуются. Другая программа устанавливается для архивирования на 10 минут и публикации этой программы.

Не следует использовать существующие программы для новых событий. Вместо этого создайте и запустите новую программу для каждого события, как описано в разделе "Программирование приложений динамической потоковой передачи".

Запустите программу, когда будете готовы к запуску потоковой передачи и архивированию. Останавливайте программу, когда нужно остановить потоковую передачу и архивировать событие. 

Чтобы удалить архивированный контент, остановите и удалите программу, а затем удалите связанный ресурс. Ресурс не может быть удален, если он используется программой - сначала следует удалить программу. 

Даже после остановки и удаления программы пользователи смогут выполнять потоковую передачу архивированного контента как видео по запросу, пока вы не удалите ресурс.

Если вы хотите сохранить архивированный контент, но он недоступен для потоковой передачи, удалите указатель потоковой передачи.

##Состояние канала

Текущее состояние канала. Возможные значения:

- Остановлено. Это начальное состояние канала после его создания. В этом состоянии свойства канала могут обновляться, но потоковая передача не разрешена.
- Запуск. Канал запускается. Обновления и потоковая передача в этом состоянии не разрешены. Если возникает ошибка, канал возвращается в состоянии "Остановлено".
- Запущено. Канал может обрабатывать динамические потоки.
- Остановка. Канал останавливается. Обновления и потоковая передача в этом состоянии не разрешены.
- Удаление. Канал удаляется. Обновления и потоковая передача в этом состоянии не разрешены. 

##Вставка субтитров и рекламы 

В следующей таблице показаны поддерживаемые стандарты субтитров и рекламы.

<table border="1">
<tr><th>Стандарт</th><th>Примечания</th></tr>
<tr><td>CEA-708 и EIA-608 (708/608)</td><td>CEA-708 и EIA-608 - это стандарты субтитров для США и Канады.<br/>В настоящее время субтитры поддерживаются, только если они передаются в закодированном входном потоке. Необходимо использовать динамический кодировщик мультимедиа, который может вставлять субтитры стандарта 608 или 708 в закодированный поток, передаваемый службам мультимедиа. Службы мультимедиа доставляют зрителям контент с субтитрами.</td></tr>
<tr><td>TTML в ismt (текстовые дорожки Smooth Streaming)</td><td>Динамическая упаковка служб мультимедиа позволяет клиентам выполнять потоковую передачу контента в любом из следующих форматов: MPEG DASH, HLS и Smooth Streaming. Однако, если вы принимаете фрагментированный поток MP4 (Smooth Streaming) с субтитрами внутри ISMT (текстовых дорожек Smooth Streaming), вы сможете доставлять контент только клиентам Smooth Streaming.</td></tr>
<tr><td>SCTE-35</td><td>Цифровая система передачи сигналов, которая используется для вставки рекламы. Получатели используют сигнал для вставки рекламы в поток на отведенное время. Данные SCTE-35 следует передавать в виде отдельной дорожки во входном потоке.<br/>Обратите внимание, что в настоящее время поддерживается только один формат входного потока, который рекламные переносит сигналы, - фрагментированный MP4 (Smooth Streaming). Единственным поддерживаемый выходной формат - это также Smooth Streaming.</td></tr>
</table>

##Рекомендации

При использовании локального динамического кодировщика для отправки потока с разными скоростями в канал действуют следующие ограничения.

- Убедитесь, что имеется достаточно свободных возможностей подключения к Интернету для отправки данных точкам приема. 
- Входящий поток с разными скоростями может предоставлять не более 10 уровней качества видео (10 слоев) и не более 5 звуковых дорожек.
- Наибольшая средняя скорость передачи для любого из уровней качества видео не должна превышать 10 Мбит/с.
- Общее значение средних скоростей для всех видео- и аудиопотоков всегда должно быть меньше 25 Мбит/с.
- Входной протокол не может быть изменен, если канал или связанные с ним программы запущены. Если требуются различные протоколы, необходимо создать отдельные каналы для каждого входного протокола. 


Другие вопросы по работе с каналами и связанными компонентами:


- Плата взимается, только когда канал используется.
- При каждой повторной настройке динамического кодировщика вызывайте метод **Reset** для канала. Перед сбросом канала необходимо остановить программу. После сброса канала перезапустите программу. 
- Канал может быть остановлен, только если он запущен, а все программы на канале остановлены.
- По умолчанию в учетную запись служб мультимедиа можно добавить только 5 каналов. Дополнительные сведения см. в разделе [Квоты и ограничения](media-services-quotas-and-limitations.md).
- Входной протокол не может быть изменен, если канал или связанные с ним программы запущены. Если требуются различные протоколы, необходимо создать отдельные каналы для каждого входного протокола. 

##<a id="tasks"></a>Связанные задачи динамической потоковой передачи

###Настройка компьютера

Сведения о настройке компьютера см. в разделе [Настройка компьютера](media-services-set-up-computer.md).

###Настройка конечных точек потоковой передачи

Общие сведения о конечных точках потоковой передачи и сведения об управлении ими см. в разделе [Управление конечными точками потоковой передачи в учетной записи служб мультимедиа](media-services-manage-origins.md).

###Использование локальных динамических кодировщиков для вывода потоков с разными скоростями

Дополнительную информацию см. в статье [Использование сторонних динамических кодировщиков со службами мультимедиа Azure](https://msdn.microsoft.com/library/azure/dn783464.aspx).

###Управление каналами, программами и ресурсами
Подробные сведения см. в разделе [Обзор управления каналами и программами](media-services-manage-channels-overview.md).

Для просмотра примеров выберите **Портал**, **.NET**, **API REST**.

[AZURE.INCLUDE [media-services-selector-manage-channels](../includes/media-services-selector-manage-channels.md)]

###Настройка политики доставки ресурсов

Настройте политики доставки ресурсов с помощью **.NET** или **REST API**.

[AZURE.INCLUDE [media-services-selector-asset-delivery-policy](../includes/media-services-selector-asset-delivery-policy.md)]

###Создание ключа содержимого

Создайте ключ содержимого, с помощью которого следует зашифровать ресурс, используя **.NET** или **API REST**.

[AZURE.INCLUDE [media-services-selector-create-contentkey](../includes/media-services-selector-create-contentkey.md)]

###Настройка политики авторизации ключей содержимого 

Настройка защиты содержимого и политики авторизации ключа с помощью **.NET** или **API REST**.

[AZURE.INCLUDE [media-services-selector-content-key-auth-policy](../includes/media-services-selector-content-key-auth-policy.md)]


###Публикация ресурсов

Опубликуйте ресурсы (создав указатели) с помощью **портала управления Azure** или **.NET**.

[AZURE.INCLUDE [media-services-selector-publish](../includes/media-services-selector-publish.md)]


###Включение сети Azure CDN

Службы мультимедиа поддерживают интеграцию с Azure CDN. Сведения о том, как включить Azure CDN, см. в разделе [Управление конечными точками потоковой передачи в учетной записи служб мультимедиа](media-services-manage-origins.md#enable_cdn).

###Масштабирование учетной записи служб мультимедиа

**Службы мультимедиа** можно масштабировать, указав число **зарезервированных единиц потоковой передачи**, которые необходимо использовать при подготовке учетной записи. 

Информацию о масштабировании единиц потоковой передачи см. в статье [Масштабирование единиц потоковой передачи](media-services-manage-origins.md#scale_streaming_endpoints.md).


[live-overview]: ./media/media-services-overview/media-services-live-streaming-current.png

<!--HONumber=52-->