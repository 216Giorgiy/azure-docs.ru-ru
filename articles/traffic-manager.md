<properties
   pageTitle="Обзор диспетчера трафика"
   description="В этой статье приводится технический обзор диспетчера трафика."
   services="traffic-manager"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/23/2015"
   ms.author="joaoma" />

# Обзор диспетчера трафика

Диспетчер трафика Microsoft Azure позволяет управлять распределением пользовательского трафика для заданных конечных точек, то есть облачных служб Azure, веб-сайтов и других конечных точек. Диспетчер трафика применяет интеллектуальную подсистему политик в запросах системы доменных имен (DNS) для доменных имен ваших интернет-ресурсов. Облачные службы Azure или веб-сайты могут выполняться в разных центрах данных по всему миру.

Диспетчер трафика позволяет решать указанные ниже задачи.

-**Повышение доступности критически важных приложений.** Диспетчер трафика позволяет повысить доступность важнейших приложений за счет мониторинга конечных точек, работающих в Azure, и автоматической отработки отказа при сбое облачной службы Azure, веб-сайта Azure или другого местоположения.

-**Улучшение отклика ресурсоемких приложений.** Платформа Azure позволяет размещать облачные службы и веб-сайты в распределенных по всему миру центрах данных. Диспетчер трафика может уменьшить время отклика приложений и возврата контента конечным пользователям, направляя их в конечную точку с наименьшим значением задержки сети для данного клиента.

-**Обновление и обслуживание без простоя.** Диспетчер трафика поддерживает расширенные сценарии для гибридных облачных и локальных развертываний, в том числе "повышение в облако", "миграция в облако" и "отработка отказа в облако". Для выполнения планового обслуживания конечную точку следует отключить в диспетчере трафика, а затем подождать, пока она не завершит обслуживание существующих соединений. Если трафик в конечную точку больше не поступает, обновите службу в этой точке, протестируйте ее, а затем повторно включите в диспетчере трафика. Это поможет поддерживать и обновлять службы без простоя.

-**Распределение трафика крупных, сложных развертываний.** Благодаря вложенным профилям диспетчера трафика, в которых профиль диспетчера трафика может иметь другой профиль в качестве конечной точки, можно создавать специальные конфигурации для оптимизации производительности и распределения в крупных, более сложных развертываниях. Подробнее см. в разделе [Вложенные профили](#Nested).

## Как работает диспетчер трафика

При настройке профиля диспетчера трафика указываемые параметры предоставляют диспетчеру трафика информацию, необходимую для определения того, какая конечная точка должна обслужить запрос на основании запроса DNS. Сам трафик конечных точек не проходит через диспетчер трафика.

На *рисунке 1* показано, как диспетчер трафика направляет пользователей в одну конечную точку из набора. Числа на рис. 1 соответствуют пронумерованным описаниям внизу.

![Как работает диспетчер трафика](./media/traffic-manager/IC740854.jpg)

Рис. 1

1. **Пользовательский трафик к домену компании.** Клиент запрашивает сведения с помощью доменного имени компании. Целью является преобразование DNS-имени в IP-адрес. Домены компании должны быть зарезервированы с использованием нормальной регистрации доменных имен Интернета. Их обслуживание выполняется вне диспетчера трафика. На рисунке 1 домен компании - www.contoso.com.
1. **От домена компании к домену диспетчера трафика.** Запись ресурса DNS для домена компании указывает на домен диспетчера трафика, обслуживаемый в диспетчере трафика Azure. Это достигается с помощью записи ресурса CNAME, сопоставляющей доменное имя компании и доменное имя диспетчера трафика. В примере доменное имя диспетчера трафика - contoso.trafficmanager.net.
1. **Домен и профиль диспетчера трафика.** Домен диспетчера трафика входит в состав профиля диспетчера трафика. DNS-сервер пользователя отправляет новый запрос DNS для домена диспетчера трафика (в нашем примере это contoso.trafficmanager.net), который принимается DNS-серверами диспетчера трафика.
1. **Обработка правил профиля диспетчера трафика.** Диспетчер трафика использует указанный метод балансировки нагрузки и данные мониторинга, чтобы определить, какая конечная точка Azure или другая конечная точка должна обработать запрос.
1. **Доменное имя конечной точки, отправляемое пользователю.** Диспетчер трафика возвращает запись CNAME, которая сопоставляет домен диспетчер трафика с доменом конечной точки. DNS-сервер пользователя разрешает доменное имя конечной точки в ее IP-адрес и отправляет его пользователю.
1. **Пользователь вызывает конечную точку.** Пользователь вызывает возвращенную конечную точку напрямую, используя ее IP-адрес.

Так как домен компании и разрешенный IP-адрес кэшируются в клиентском компьютере, пользователь продолжает взаимодействовать с выбранной конечной точкой, пока не истечет срок действия записи в локальном кэше DNS. Важно отметить, что DNS-клиент кэширует записи узла DNS в течение их срока жизни (TTL). Извлечение записей узлов из кэша DNS-клиента не затрагивает профиль диспетчера трафика, что может привести к задержке подключения, если конечная точка станет недоступна до истечения срока жизни. Если срок жизни DNS-записи узла в кэше клиента истекает и клиентскому компьютеру снова требуется разрешить доменное имя компании, он отправляет новый запрос DNS. Клиентский компьютер может получить IP-адрес другой конечной точки в зависимости от применяемого метода балансировки нагрузки и состояния работоспособности конечных точек во время запроса.

## Реализация диспетчера трафика


На *рисунке 2* пошагово показано, что необходимо сделать для реализации диспетчера трафика. Эти шаги можно будет выполнять немного в другом порядке после получения ясного понимания конфигурации и рекомендаций по использованию диспетчера трафика. Числа на рис. 2 соответствуют пронумерованным описаниям внизу.

![Настройка диспетчера трафика](./media/traffic-manager/IC740855.jpg)

Рис. 2

1. **Развертывание облачных служб Azure, веб-сайтов Azure или других конечных точек в рабочей среде.** При создании профиля диспетчера трафика его необходимо связать с подпиской. Затем можно добавить конечные точки для облачных служб и веб-сайтов уровня Standard, входящих в ту же подписку, в рабочей среде. Если конечная точка находится в промежуточной среде и не находится в рабочей среде Azure или не является частью той же подписки, ее можно добавить как внешнюю конечную точку. Подробнее об облачных службах см. в разделе [Облачные службы](http://go.microsoft.com/fwlink/p/?LinkId=314074). Подробнее о веб-сайтах см. в разделе [Веб-сайты](http://go.microsoft.com/fwlink/p/?LinkId=393327).
1. **Выбор имени для домена диспетчера трафика.** Рассмотрите возможность задать имя для своего домена с уникальным префиксом. Последняя часть доменного имени (trafficmanager.net) остается постоянной. Подробнее см. в разделе [Рекомендации](#bkmk_TrafficManagerBestPracticesProfile).
1. **Выбор конфигурации мониторинга, которая будет использоваться.** Диспетчер трафика наблюдает за конечными точками для обеспечения их доступности вне зависимости от применяемого метода балансировки нагрузки. После настройки параметров мониторинга диспетчер трафика не передает трафик конечным точкам, которые находятся в автономном режиме согласно системе мониторинга, если он не обнаружит, что все точки находятся в режиме "не в сети", или не сможет определить состояние какой-либо точки в профиле. Подробнее о мониторинге см. в разделе [О мониторинге диспетчера трафика](https://msdn.microsoft.com/library/azure/dn339013.aspx).
1. **Выбор используемого метода балансировки нагрузки.** Доступны три различных метода балансировки нагрузки. Найдите время и разберитесь, какой метод лучше всего соответствует вашим требованиям. Если потребуется изменить метод позже, то это можно сделать в любое время. Обратите внимание, что все методы требуют немного разных действий по настройке. Сведения о методах балансировки нагрузки см. в разделе [О методах балансировки нагрузки диспетчера трафика](https://msdn.microsoft.com/library/azure/dn339010.aspx).
1. **Создание профиля и настройка параметров.** Для создания профиля диспетчера трафика и настройки параметров можно использовать интерфейсы REST API, Windows PowerShell или портал управления. Подробнее см. в разделе [Настройка параметров диспетчера трафика](#Configure). Следующие шаги предполагают, что на портале управления используется быстрое создание.
	- 	**Создайте профиль диспетчера трафика -** о создании профиля с помощью пункта "Быстрое создание" на портале управления см. раздел [Создание профиля диспетчера трафика с помощью "Быстрого создания"](https://msdn.microsoft.com/library/azure/dn339012.aspx).
	- 	**Настройте параметры метода балансировки нагрузки -** в "Быстром создании" необходимо выбрать метод балансировки нагрузки для профиля. Этот параметр можно изменить в любой момент после завершения шагов "Быстрого создания". Инструкции по настройке см. в разделе, соответствующем вашему методу балансировки нагрузки. [Настройка балансировки нагрузки по производительности](https://msdn.microsoft.com/library/azure/hh744835.aspx)
	
	[AZURE.NOTE]**Метод балансировки нагрузки с циклическим перебором теперь поддерживает взвешенное распределение сетевого трафика. Однако теперь следует использовать интерфейсы REST API или Windows PowerShell для настройки веса. Дополнительные сведения и пример конфигурации см. в разделе [Внешние конечные точки диспетчера трафика Azure и взвешенный циклический перебор с помощью PowerShell](https://msdn.microsoft.com/library/azure/hh744829.aspx) в блоге Azure.**
	- 	**Настройка конечных точек -** конечные точки не настраиваются во время быстрого создания. После создания профиля и указания метода балансировки нагрузки можно указать диспетчеру трафика конечные точки.
	- 	**Параметры мониторинга -** параметры мониторинга нельзя настроить в ходе "Быстрого создания". После создания профиля и указания метода балансировки нагрузки можно указать диспетчеру трафика область мониторинга. Инструкции по настройке мониторинга см. в разделе [Настройка мониторинга диспетчера трафика](configure-traffic-manager-monitoring.md).
1. **Проверка профиля диспетчера трафика.** Проверьте, работают ли ваши профиль и домен в соответствии с ожиданиями. Подробнее о том, как это сделать, см. в разделе [Проверка параметров диспетчера трафика](testing-traffic-manager-settings.md).
1. **Направление записи ресурса DNS доменного имени вашей компании на профиль для его активации.** Подробнее см. в разделе [Направление интернет-домена компании на домен диспетчера трафика](point-a-company-internet-domain-to-a-traffic-manager-domain.md).

В примере на рисунке 1 необходимо изменить запись ресурса DNS на серверах на следующее значение, чтобы направить доменное имя компании на доменное имя диспетчера трафика:

    www.contoso.com IN CNAME contoso.trafficmanager.net


## Настройка параметров диспетчера трафика


Параметры диспетчера трафика можно задать на портале управления, с помощью интерфейсов REST API или командлетов Windows PowerShell.

Хотя на портале управления отображаются не все элементы интерфейсов REST API, многие параметры можно задать с помощью обоих этих методов. Подробнее об использовании REST API см. в разделе [Операции, относящиеся к диспетчеру трафика (справочник по интерфейсу REST API)](http://go.microsoft.com/fwlink/p/?LinkId=313584).


Подробнее о командлетах Windows PowerShell для диспетчера трафика см. в разделе [Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).


[AZURE.NOTE] **В текущий момент настройка внешних конечных точек (тип = "Любые"), весов для метода балансировки нагрузки с циклическим перебором и вложенных профилей на портале управления не поддерживается. Необходимо использовать REST (см. раздел "Создание определения") или Windows PowerShell (см. раздел, посвященный Add-AzureTrafficManagerEndpoint).**

### Настройка параметров на портале управления


На портале управления с помощью функции быстрого создания можно создать собственный профиль диспетчера трафика. Функция быстрого создания позволяет создать базовый профиль. После создания профиля можно задать дополнительные параметры либо изменить параметры, которые были заданы ранее. Подробнее о создании профиля диспетчера трафика с помощью функции быстрого создания см. в разделе "Создание профиля диспетчера трафика с помощью "Быстрого создания"".

[Создание профиля диспетчера трафика с помощью "Быстрого создания"](https://msdn.microsoft.com/library/azure/dn339012.aspx)

На портале управления можно настроить следующие параметры.

-**Префикс DNS.** Уникальный префикс, который вы создаете. Профили отображаются на портале управления по префиксам.

-**Срок жизни DNS.** Срок жизни DNS управляет тем, как часто сервер доменных имен локального кэширования клиента будет запрашивать систему DNS диспетчера трафика Azure для обнаружения обновленных DNS-записей.

-**Подписка.** Выберите подписку, к которой будет относиться этот профиль. Обратите внимание, что этот параметр отображается только в том случае, если у вас несколько подписок.

-**Метод балансировки нагрузки.** Способ, посредством которого диспетчер трафика будет балансировать нагрузку.

-**Порядок переключения.** При использовании метода балансировки нагрузки с отработкой отказа это порядок конечных точек.

-**Мониторинг.** Параметры мониторинга включают протокол (HTTP или HTTPS), порт, относительный путь и имя файла.

### Настройка параметров с помощью интерфейсов REST API


Создать и настроить профиль диспетчера трафика можно с помощью интерфейсов REST API. Подробнее см. в разделе [Операции, относящиеся к диспетчеру трафика (справочник по интерфейсу REST API)](http://go.microsoft.com/fwlink/?LinkId=313584).

-**Профиль**, который содержит префикс создаваемого доменного имени. Каждый профиль соответствует подписке. Можно создать несколько профилей для одной подписки. Имя профиля отображается на портале управления. Создаваемое имя, указанное в профиле, называется доменом диспетчера трафика.

-**Определение** содержит параметры политики и мониторов. Определение соответствует профилю. Для профиля может существовать только одно определение. Само определение не отображается на портале управления, хотя многие из параметров в определении видны и могут быть настроены на портале.

-**Параметры DNS** - в каждом определении есть параметры DNS. Здесь настраивается время жизни DNS.

-**Мониторы.** В каждом определении содержатся параметры монитора. Здесь настраиваются протокол, порт, имя файла и относительный путь. Параметры мониторов отображаются и могут быть изменены на портале управления. Подробнее см. в разделе [О мониторинге диспетчера трафика](https://msdn.microsoft.com/library/azure/dn339013.aspx).

-**Политика.** Параметры политики содержатся в каждом определении. В политике задаются методы и конечные точки балансировки нагрузки. Сама политика не отображается на портале управления, хотя многие из параметров политики видны и могут быть настроены на портале. Подробнее см. в разделе [О методах балансировки нагрузки диспетчера трафика](about-traffic-manager-balancing-methods.md).

## Настройка параметров с помощью Windows PowerShell

Создать и настроить профиль диспетчера трафика можно с помощью Windows PowerShell. Подробнее см. в разделе [Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).

## <a name=bkmk_TrafficManagerBestPracticesProfile>Best practices</a>

- **Сделайте префиксы уникальными и легкими для понимания -** DNS-имя профиля диспетчера трафика должно быть уникальным. Можно изменять только первую часть DNS-имени. Доменное имя диспетчера трафика используется только для идентификации и направления клиентских запросов. Клиентские компьютеры никогда не отображают эти имена для конечных пользователей. Однако это доменное имя определяет профили, поэтому важно, чтобы его можно было быстро отличить от других доменных имен, перечисленных на портале управления.
- **Используйте точки для обеспечения уникальности или облегчения чтения доменных имен -** также точки можно использовать для разделения частей префикса доменного имени.  Если вы планируете создать несколько политик в диспетчере трафика, используйте согласованную иерархию, чтобы различать службы. Например, в Contoso присутствуют глобальные службы для работы в Интернете, выставления счетов и управления программами. Можно было бы использовать три политики: web.contoso.trafficmanager.net, bill.contoso.trafficmanager.net и util.contoso.trafficmanager.net. При настройке облачных служб и веб-сайтов используйте имена, которые указывают на местоположение. Например, web-us-contoso.cloudapp.net и web-asia-contoso.cloudapp.net. Ограничения накладываются системой DNS. Предположим, что доменное имя - это последовательность меток, разделенная точками (метка.метка.метка.метка. и т. д.). На момент написания этой документации в диспетчере трафика существовали следующие ограничения для доменных имен.
	- Длина каждой метки не может превышать 63 символа.
	- Нельзя иметь более 40 меток. Две метки заняты trafficmanager.net, поэтому для префикса остается 38.
	- Длина всего доменного имени не может превышать 253 символа. Не забывайте, что trafficmanager.net занимает 19 из этих символов.
- **Срок жизни DNS.-** Срок жизни DNS управляет тем, как часто сервер доменных имен локального кэширования клиента будет запрашивать систему DNS диспетчера трафика Azure для обнаружения обновленных DNS-записей. Для любого изменения, происходящего в пределах диспетчера трафика, например изменения профиля или изменения доступности конечной точки, потребуется этот промежуток времени, чтобы оно распространилось по глобальной системе DNS-серверов. Рекомендуется оставить для этого параметра значение по умолчанию - 300 секунд (5 минут). При задании более высокого значения увеличивается время хранения ответов DNS диспетчера трафика в кэше сопоставителями и клиентами DNS, благодаря чему общая задержка запросов DNS уменьшается. Однако если требуется быстрая отработка отказа, то лучше задать более низкое значение.
- **Конечные точки должны находиться в одной подписке -** все конечные точки должны быть в той подписке, в которой создается профиль. Можно добавить конечные точки из разных подписок в профиль как внешние конечные точки, но Azure не удалит их автоматически, если отключить или удалить связанную службу. В результате внешние конечные точки сохранятся в профиле диспетчера трафика, и за них будет взиматься плата, если их вручную не удалить.

-**Только службы рабочей среды -** доступны только конечные точки в рабочей среде. Нельзя направлять трафик на конечные точки, работающие в промежуточной среде. Обратите внимание, что, если переключить виртуальный IP-адрес (VIP), когда профиль направляет трафик, трафик будет использовать конечную точку, только что введенную в рабочую среду.

-**Назовите конечные точки так, чтобы потом их можно было легко идентифицировать, -** учитывайте префикс DNS. DNS-имя используется, поскольку его уникальность гарантируется в пределах подписки. Имя облачной службы или веб-сайта этого не гарантирует. Во избежание путаницы присваивайте облачным службам и веб-сайтам одинаковые или схожие имена и префиксы DNS. При наличии более 20 облачных служб и веб-сайтов плохой метод именования затрудняет поиск нужных конечных точек. Кроме того, плохо названные конечные точки затрудняют обслуживание профилей.

-**Все конечные точки в профиле должны обслуживать одни и те же операции и порты -** если вы используете различающиеся в этом отношении конечные точки, возникает вероятность того, что клиент вызовет конечную точку, которая не сможет выполнить запрос.

-**Все облачные службы в профиле должны использовать одни и те же параметры мониторинга -** можно выбрать только один путь и файл для отслеживания всех конечных точек в заданном определении. Можно ввести "/" в поле "Относительный путь и имя файла", чтобы мониторинг попытался получить доступ к пути и имени файла по умолчанию.

-**Отключите конечные точки для внесения временных изменений, а не меняйте конфигурацию -** во многих случаях может потребоваться перевести конечную точку в режим "не в сети". Вместо удаления конечной точки из профиля просто отключите отдельную конечную точку в профиле. Эта операция оставляет конечную точку в рамках профиля, но при этом профиль действует так, как если бы конечная точка не была в него включена. Это полезно, если нужно временно удалить конечную точку, которая находится в режиме обслуживания или повторно развертывается. После повторного запуска конечной точки ее можно включить. Подробнее см. в разделе [Отключение или включение конечной точки](disable-or-enable-an-endpoint.md).

-**Хранилище -** разработка размещения и распределения данных хранилища является важным аспектом использования диспетчера трафика. Рассмотрите сквозную транзакцию и то, как данные будут перемещаться, при разработке и развертывании приложений для диспетчера трафика.

-**SQL Azure -** так же как при проектировании хранилища, необходимо проанализировать состояние и требования к данным для приложения при расширении конечных точек до нескольких географических регионов.

## <a name="Nested">Вложенные профили</a>

В качестве конечной точки можно указать имя другого профиля диспетчера трафика (это называется вложенными профилями). Именем профиля диспетчера трафика является соответствующее DNS-имя, например contoso-europe.trafficmanager.net.

Это позволяет настраивать диспетчер трафика так, чтобы входящие запросы DNS-имен анализировались в наборе уровней, чтобы запрашивающий клиент направлялся в правильный набор конечных точек. На рис. 3 приведен пример.

![Пример вложенных профилей диспетчера трафика](./media/traffic-manager/IC751072.png)

**Рис. 3**

Можно вложить до 10 уровней, и каждый профиль можно настраивать с разным методом балансировки нагрузки.

Например, можно создать конфигурацию для следующих задач.

- На верхнем уровне (профиль диспетчера трафика, который сопоставляется с внешним DNS-именем) можно настроить профиль с методом балансировки нагрузки по производительности.

- На среднем уровне набор профилей диспетчера трафика представляет различные центры данных и использует метод циклической балансировки нагрузки.

- На нижнем уровне набор конечных точек облачной службы в каждом центре данных обслуживает запросы пользователя.

В результате пользователи направляются в свой региональный центр данных на основании производительности и в облачную службу в этом центре данных на основании равномерного или взвешенного распределения нагрузки. Например, для распределения небольшой доли трафика в новое или пробное развертывание для тестирования или получения отзывов пользователей может использоваться взвешивание.

На рис. 4 показана эта конфигурация.

![Пример многоуровневых профилей диспетчера конфигурации](./media/traffic-manager/IC751073.png)

**Рис. 4**

На рис. 4 профиль диспетчера трафика на верхнем уровне является родительским профилем, а профили диспетчера трафика на среднем уровне - дочерними профилями.

Если диспетчер трафика направляет пользователей в дочерний профиль с небольшим количеством исправных конечных точек, то эти точки могут оказаться перегруженными, что приведет к проблемам с производительностью. Для предотвращения такой ситуации родительский профиль диспетчера трафика можно настроить с пороговым количеством исправных конечных точек, которое будет определять, может ли какая-либо из конечных точек в пределах дочерних профилей данного родительского элемента получать трафик. Например, если необходимо убедиться в том, что в дочерних профилях существуют по крайней мере три исправные конечные точки, установите пороговое значение 3. В примере на рис. 4 для этого порогового значения настроен профиль диспетчера трафика верхнего уровня.

Для добавления профиля диспетчера трафика в качестве конечной точки и настройки минимального количества исправных конечных точек необходимо использовать REST (см. раздел [Создание определения](http://go.microsoft.com/fwlink/p/?LinkId=400772)) или Windows PowerShell (см. раздел [Add-AzureTrafficManagerEndpoint](https://msdn.microsoft.com/library/azure/dn690257.aspx)). Портал управления использовать нельзя.

## Схемы диспетчера трафика


Если вам нужны схемы, приведенные в этом разделе, для слайдов презентации PowerPoint по диспетчеру трафика или для изменения в личных целях, см. [схемы диспетчера трафика в документации MSDN](http://gallery.technet.microsoft.com/Traffic-Manager-figures-in-887e7c99).

## См. также

[Задачи настройки диспетчера трафика](https://msdn.microsoft.com/library/azure/hh744830.aspx)

[Облачные службы](http://go.microsoft.com/fwlink/?LinkId=314074)

[Веб-сайты](http://go.microsoft.com/fwlink/p/?LinkId=393327)

[Операции с диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/?LinkId=313584)

<!--HONumber=49-->