<properties
	pageTitle="Предварительная версия Azure Active Directory B2C | Microsoft Azure"
	description="Построение веб-приложений с помощью реализации протокола проверки подлинности OpenID Connect в Azure Active Directory."
	services="active-directory-b2c"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory-b2c"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/28/2016"
	ms.author="dastrock"/>

# Предварительная версия Azure Active Directory B2C: поток кода авторизации OAuth 2.0

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. С помощью реализации OAuth 2.0 в Azure Active Directory B2C можно добавить регистрацию, вход и другие задачи по управлению пользователями в мобильные и настольные приложения. Это руководство не зависит от языка и описывает, как отправлять и получать сообщения HTTP, не используя ни одну из наших библиотек с открытым исходным кодом.

<!-- TODO: Need link to libraries -->

[AZURE.INCLUDE [active-directory-b2c-preview-note](../../includes/active-directory-b2c-preview-note.md)]

Описание потока кода авторизации OAuth 2.0 можно найти в [разделе 4.1 спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749). Его можно использовать для проверки подлинности и авторизации большинства типов приложений, включая [веб-приложения](active-directory-b2c-apps.md#web-apps) и [изначально установленные приложения](active-directory-b2c-apps.md#mobile-and-native-apps). Он позволяет приложениям безопасно получать **маркеры доступа**, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-b2c-reference-protocols.md#the-basics).

В этом руководстве мы сосредоточимся только на определенном типе потока кода авторизации OAuth 2.0 — **открытых клиентах**. Открытый клиент — это любое клиентское приложение, которому нельзя доверять в безопасном сохранении целостности секретного пароля. К ним относятся мобильные приложения, приложения для настольных компьютеров и практически любые приложения, которые выполняются на устройстве и должны получать маркеры доступа. Если вы хотите добавить идентификацию пользователей для веб-приложения с помощью Azure AD B2C, необходимо использовать [OpenID Connect](active-directory-b2c-reference-oidc.md), а не OAuth 2.0.

В Azure AD B2C стандартные потоки OAuth 2.0 выходят за рамки простой проверки подлинности и авторизации. В ней появляется [**параметр политики**](active-directory-b2c-reference-policies.md), который позволяет использовать OAuth 2.0 для добавления в приложение действий по управлению пользователями: регистрации, входа и управления профилями. Здесь мы покажем, как с помощью OAuth 2.0 и политик реализовать каждую из этих функций в собственных приложениях и получить маркеры доступа к веб-интерфейсам API.

В приведенных ниже запросах HTTP будет использован наш пример каталога B2C **fabrikamb2c.onmicrosoft.com**, а также наши примеры приложения и политик. Вы можете пробовать выполнять запросы с этими значениями или заменить их на собственные. Узнайте, как [получить собственный каталог B2C, приложения и политики](#use-your-own-b2c-directory).

## 1\. Получение кода авторизации
Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize`. Это интерактивная часть потока, в которой пользователь фактически выполняет действие. В этом запросе клиент указывает разрешения, необходимые для получения от пользователя в параметре `scope`, и политики для выполнения в параметре `p`. Ниже приведены три примера для разных политик (переносы строк добавлены для удобства чтения).

#### Пример с политикой входа в систему

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_sign_in
```

#### Пример с политикой регистрации

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_sign_up
```

#### Пример с политикой изменения профиля

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_edit_profile
```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | ----------------------- |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com) назначил вашему приложению. |
| response\_type | Обязательно | Тип ответа, который должен содержать `code` для потока кода авторизации. |
| redirect\_uri | Обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации** (подробнее об этом далее в статье). Область `offline_access` означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| response\_mode | Рекомендуется | Метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".
| state | Рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Этот параметр также включает информацию о состоянии пользователя в приложении перед созданием запроса на проверку подлинности (например, об открытой в тот момент странице или выполняемой политике). |
| p | Обязательно | Политика, которая будет выполняться. Это имя политики, созданной в каталоге B2C. Оно должно начинаться с "b2c\_1\_". Дополнительные сведения о политиках см. в статье [Расширяемая платформа политик](active-directory-b2c-reference-policies.md). |
| prompt | Необязательно | Требуемый тип взаимодействия с пользователем. На текущий момент единственное допустимое значение — "login", при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На этом этапе пользователю будет предложено завершить рабочий процесс для политики. Для этого могут потребоваться ввод имени пользователя и пароля, вход с помощью удостоверения социальной сети, регистрация в каталоге или любые другие действия, определенные в политике.

После того как пользователь завершит политику, Azure AD вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`. Во всех вышеперечисленных случаях ответ будет одинаковым независимо от политики, которая была выполнена.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET urn:ietf:wg:oauth:2.0:oob?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...        // the authorization_code, truncated
&state=arbitrary_data_you_can_receive_in_the_response                // the value provided in the request
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| Код | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| state | См. полное описание в предыдущей таблице. Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET urn:ietf:wg:oauth:2.0:oob?
error=access_denied
&error_description=The+user+has+cancelled+entering+self-asserted+information
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |
| state | См. полное описание в первой таблице этого раздела. Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |


## 2\. Получение маркера
После получения кода авторизации можно использовать `code` для получения маркера для необходимого ресурса путем отправки запроса `POST` на конечную точку `/token`. В предварительной версии Azure AD B2C единственный ресурс, для которого можно запросить маркер, — это веб-API серверной части вашего приложения. По соглашению при запросе маркера для себя следует использовать область `openid`.

```
POST fabrikamb2c.onmicrosoft.com/v2.0/oauth2/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6",
	"scope": "openid offline_access",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...",
	"redirect_uri": "urn:ietf:wg:oauth:2.0:oob"
}
```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | --------------------- |
| p | Обязательно | Политика, которая использовалась для получения кода авторизации. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к *строке запроса*, а не в тело запроса POST. |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com) назначил вашему приложению. |
| grant\_type | Обязательно | Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации**. Ее можно использовать для получения маркеров для веб-API серверной части приложения, идентификатор приложения которого совпадает с идентификатором приложения клиента. Область `offline_access` означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| Код | Обязательно | Код авторизации, полученный на первом участке потока. |
| redirect\_uri | Обязательно | URI перенаправления приложения, в котором вы получили код авторизации. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"not_before": "1442340812",
	"token_type": "Bearer",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"scope": "openid offline_access",
	"id_token_expires_in": "3600",
	"profile_info": "eyJ2ZXIiOiIxLjAiLCJ0aWQiOiI3NzU1MjdmZi05YTM3LTQzMDctOGIzZC1jY...",
	"refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
	"refresh_token_expires_in": "1209600"
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| not\_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token\_type | Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| id\_token | Подписанный веб-маркер JSON (JWT), который вы запрашивали. |
| scope | Области, для которых маркер является действительным и которые можно использовать для кэширования маркеров для последующего использования. |
| id\_token\_expires\_in | Срок действия маркера id\_token (в секундах). |
| profile\_info | Строка JSON в кодировке Base64, которая может содержать полезные сведения о пользователе для отображения в собственном приложении. Ее точное содержимое будет зависеть от утверждений приложения, настроенных в вашей политике. |
| refresh\_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения можно найти в [Справочнике по маркерам B2C](active-directory-b2c-reference-tokens.md). |
| refresh\_token\_expires\_in | Максимальное время действия маркера обновления (в секундах). Несмотря на это, маркер обновления может стать недействительным в любой момент времени. |

> [AZURE.NOTE]
	Если в этот момент вы думаете: "Где же маркер доступа?", примите во внимание следующее. При запросе области `openid` Azure AD будет выдавать в ответе веб-маркера JSON (JWT) `id_token`. Хотя этот `id_token` с технической точки зрения не является маркером доступа OAuth 2.0, он может использоваться в качестве маркера доступа для связи со службой серверной части приложения, идентификатор клиента которого совпадает с идентификатором клиента. `id_token` по-прежнему представляет собой подписанный токен носителя JWT, который можно отправить ресурсу в заголовке авторизации HTTP и который может использоваться в запросах проверки подлинности. <br><br>Различие в том, что у `id_token` отсутствует механизм для ограничения областей доступа конкретного клиентского приложения. Однако в том случае, когда ваше клиентское приложение — это единственное клиентское приложение, которое может взаимодействовать со службой серверной части приложения (а в текущей предварительной версии Azure AD B2C это именно так), такой механизм ограничений областей доступа не нужен. <br><br>Когда в предварительную версию Azure AD B2C будут добавлены возможности взаимодействия клиентов с ресурсами дополнительных первой и третьей сторон, будут также добавлены необходимые маркеры доступа. Однако даже тогда рекомендуемым подходом по-прежнему останется использование `id_tokens` для связи со службой серверной части приложения. Дополнительные сведения о типах приложений, которые можно создавать в предварительной версии Azure AD B2C, см. в [этой статье](active-directory-b2c-apps.md).

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## 3\. Использование маркера
После успешного получения `id_token` маркер можно использовать в запросах к веб-API серверной части приложения, включая маркер в заголовок `Authorization`.

```
GET /tasks
Host: https://mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## 4\. Обновление маркера
Срок действия маркеров id\_token крайне мал. Для сохранения доступа к ресурсам маркеры с истекшим сроком действия необходимо обновлять. Для этого нужно отправить еще один запрос `POST` в конечную точку `/token`, указав `refresh_token` вместо `code`:

```
POST fabrikamb2c.onmicrosoft.com/v2.0/oauth2/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "refresh_token",
	"client_id": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6",
	"scope": "openid offline_access",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...",
	"redirect_uri": "urn:ietf:wg:oauth:2.0:oob"
}
```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | -------- |
| p | Обязательно | Политика, которая использовалась для получения исходного маркера обновления. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к *строке запроса*, а не в тело запроса POST. |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com) назначил вашему приложению. |
| grant\_type | Обязательно | Тип предоставления. Для этого участка потока кода авторизации это должен быть тип `refresh_token`. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации**. Ее можно использовать для получения маркеров для веб-API серверной части приложения, идентификатор приложения которого совпадает с идентификатором приложения клиента. Область `offline_access` означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| redirect\_uri | Обязательно | URI перенаправления приложения, в котором вы получили код авторизации. |
| refresh\_token | Обязательно | Исходный маркер обновления, полученный на втором участке потока. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"not_before": "1442340812",
	"token_type": "Bearer",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"scope": "openid offline_access",
	"id_token_expires_in": "3600",
	"profile_info": "eyJ2ZXIiOiIxLjAiLCJ0aWQiOiI3NzU1MjdmZi05YTM3LTQzMDctOGIzZC1jY...",
	"refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
	"refresh_token_expires_in": "1209600"
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| not\_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token\_type | Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| id\_token | Подписанный маркер JWT, который вы запрашивали. |
| scope | Области, для которых маркер является действительным и которые можно использовать для кэширования маркеров для последующего использования. |
| id\_token\_expires\_in | Срок действия маркера id\_token (в секундах). |
| profile\_info | Строка JSON в кодировке Base64, которая может содержать полезные сведения о пользователе для отображения в собственном приложении. Ее точное содержимое будет зависеть от утверждений приложения, настроенных в вашей политике. |
| refresh\_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения можно найти в [Справочнике по маркерам B2C](active-directory-b2c-reference-tokens.md). |
| refresh\_token\_expires\_in | Максимальное время действия маркера обновления (в секундах). Несмотря на это, маркер обновления может стать недействительным в любой момент времени. |

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |


<!--

Here is the entire flow for a native app; each request is detailed in the sections below:

![OAuth Auth code flow](./media/active-directory-b2c-reference-oauth-code/convergence_scenarios_native.png)

-->

## Использование собственного каталога B2C

Если вы хотите попробовать выполнить эти запросы самостоятельно, необходимо сначала выполнить следующие три шага, а затем заменить значения в примере выше на собственные.

- [Создайте каталог B2C](active-directory-b2c-get-started.md) и используйте имя своего каталога в запросах.
- [Создайте приложение](active-directory-b2c-app-registration.md) для получения идентификатора приложения и URI перенаправления. Включите **собственный клиент** в свое приложение.
- [Создайте собственные политики](active-directory-b2c-reference-policies.md) для получения имен политик.

<!---HONumber=AcomDC_0302_2016-->