---
title: "Azure Active Directory B2C. Устранение неполадок в пользовательских политиках | Документация Майкрософт"
description: "Руководство по нескольким подходам к устранению ошибок в пользовательских политиках"
services: active-directory-b2c
documentationcenter: 
author: rojasja
manager: krassk
editor: rojasja
ms.assetid: 
ms.service: active-directory-b2c
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/07/2017
ms.author: joroja
ms.translationtype: Human Translation
ms.sourcegitcommit: 2db2ba16c06f49fd851581a1088df21f5a87a911
ms.openlocfilehash: 0f783062cd674edb0b6b49660f5aee69af4b3adb
ms.contentlocale: ru-ru
ms.lasthandoff: 05/09/2017


---
# <a name="azure-active-directory-b2c-custom-policies-and-identity-experience-framework-troubleshooting"></a>Устранение неполадок в пользовательских политиках Azure Active Directory B2C и инфраструктуре процедур идентификации
## <a name="the-basics"></a>Основные сведения

Разработчики удостоверений, использующие пользовательские политики Azure AD B2C, должны настраивать инфраструктуру процедур идентификации на языке политики в формате XML.  В этом руководстве содержится список рекомендуемых средств, а также советы по быстрому обнаружению и устранению проблем.  Обучение написанию пользовательских политик подобно изучению нового языка.  
*В этой статье основное внимание уделяется устранению неполадок конфигурации пользовательских политик Azure AD B2C, а не приложению проверяющей стороны или его библиотеки удостоверений.*



## <a name="xml-editing-inproperly-formatted-xml-is-the-most-common-error"></a>Самые распространенные ошибки связаны с изменением и неправильным форматом XML.

Вам нужен хороший редактор XML, который отображает XML в изначальном виде, помечает содержимое цветовыми кодами, предварительно заполняет общие термины, индексирует элементы XML и может проверять их по схеме.  Мы предлагаем использовать следующие два редактора.

* [Код VS](https://code.visualstudio.com/)
* [Notepad++](https://notepad-plus-plus.org/)

Получите определение схемы XML `TrustFrameworkPolicy_0.3.0.0.xsd` из корневой папки начального пакета. При проверке по схеме XML определяются ошибки перед отправкой.  Поищите `XML tools` и `XML Validation` в документации по своему редактору XML.

Кроме того, не помешает взглянуть на правила XML, так как Azure AD B2C будет отклонять любые обнаруженные ошибки форматирования.  Иногда, если используется XML неправильного формата, могут появляться сообщения об ошибках, вводящие в заблуждение.

## <a name="uploading-policies-and-policy-validation"></a>Передача политики и ее проверка

 Проверка **передачи** выполняется автоматически, и большинство ошибок вызовет прерывание передачи.  **Имейте в виду, что при проверке используется файл политики, который вы пытаетесь передать, и цепочка файлов, на которые он ссылается.  `RP policy file > Extensions file > Base File` Ниже представлены распространенные ошибки проверки.

Фрагмент кода ошибки: `... makes a reference to ClaimType with id "displaName" but neither the policy nor any of its base policies contain such an element`
* Параметр ClaimType может быть введен неверно или не существовать в схеме.
* Параметр ClaimType нужно определить по крайней мере в одном из файлов политики.  Например ` <ClaimType Id="socialIdpUserId">`
* Если параметр ClaimType определен в файле расширения, но используется в техническом профиле в базовом файле, передача базового файла приведет к ошибке.

Фрагмент кода ошибки: `...males a reference to a ClaimsTransformation with id...`
* То же, что и выше.

Фрагмент кода ошибки: `Reason: User is currently logged as a user of 'yourtenant.onmicrosoft.com' tenant. In order to manage 'yourtenant.onmicrosoft.com', please login as a user of 'yourtenant.onmicrosoft.com' tenant`
* Убедитесь, что параметр TenantId в элементах **<TrustFrameworkPolicy>** и **<BasePolicy>** соответствует целевому клиенту B2C.  



## <a name="runtime-troubleshooting"></a>Устранение неполадок во время выполнения

* Используйте `Run Now` и `https://jwt.io`, чтобы проверить свои политики независимо от мобильного приложения или веб-приложения. Этот веб-сайт выступает в качестве приложения проверяющей стороны, в котором отображается содержимое токена JWT, создаваемое политикой Azure AD B2C.  Чтобы создать тестовое приложение в инфраструктуре процедур идентификации, задайте следующие свойства:
    * Имя: TestApp.
    * Веб-приложение или веб-интерфейс API: нет.
    * Собственный клиент: нет.

* Используйте [fiddler](http://www.telerik.com/fiddler), чтобы отслеживать обмен сообщениями между клиентским браузером и Azure AD B2C.  Вы получите указание на место в шагах оркестрации, где происходит сбой пути взаимодействия пользователя.

* Используйте **Application Insights** в **режиме разработки**, чтобы отслеживать поведение инфраструктуры процедур идентификации (IEF).  В **режиме разработки** можно отслеживать обмен утверждениями между инфраструктурой процедур идентификации и различными поставщиками утверждений, определяемых техническими профилями, такими как поставщик удостоверений, службы на базе API, пользовательский каталог Azure AD B2C (каталог AAD) и другие службы, например Многофакторная идентификация.  

## <a name="recommended-practies"></a>Рекомендации

**Храните несколько версий своих сценариев и группируйте их в проект с вашим приложением.** Базовые файлы, файлы расширения и файлы проверяющей стороны напрямую зависят друг от друга. Сохраните их как группу, используя отдельные рабочие версии по мере реализации новых функций в ваших политиках.  Поместите их в свою файловую систему с кодом приложения, с которым они взаимодействуют.  Ваши приложения могут вызывать разные политики проверяющей стороны в клиенте и могут зависеть от утверждений, которые они ожидают от ваших политик Azure AD B2C.

**Разрабатывайте и тестируйте технические профили с известными путями взаимодействия пользователя.**  Используйте проверенные политики начального пакета, чтобы настроить свои технические профили и протестировать их отдельно, прежде чем включать в собственные пути взаимодействия пользователя.

**Разрабатывайте и тестируйте пути взаимодействия пользователя с помощью проверенных технических профилей.** Изменяйте шаги оркестрации путей взаимодействия пользователя шаг за шагом, постепенно создавая требуемый сценарий.







Давайте приступим:

1. Скачайте active-directory-b2c-custom-policy-starterpack из репозитория GitHub.  [Скачайте ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или выполните следующую команду:
### <a name="built-in"></a>Встроены



Инфраструктура расширяемых политик Azure Active Directory (Azure AD) B2C — это основное преимущество службы. Политики полностью описывают процесс идентификации пользователей: регистрацию, вход и редактирование профиля. К примеру, политика регистрации позволяет управлять поведением с помощью таких параметров:

* типы учетных записей (учетные записи в социальных сетях, например Facebook, или локальные учетные записи, например адрес электронной почты), которые пользователи могут использовать для регистрации в приложении;
* атрибуты (например имя, почтовый индекс и размер обуви), которые нужно получить от пользователя во время регистрации;
* многофакторная проверка подлинности;
* внешний вид и удобство использования всех страниц регистрации;
* сведения (объявляемые в качестве утверждений в маркере), которые получает приложение после завершения выполнения политики.

В своем клиенте вы можете создать несколько политик различных типов и при необходимости использовать их в приложениях. Политики могут повторно использоваться в разных приложениях. Это позволяет разработчикам определять и изменять процесс идентификации пользователя, внося лишь незначительные изменения в код или совсем не изменяя его.

Работа с политиками выполняется через простой интерфейс разработчика. Приложение запускает политику с помощью стандартного HTTP-запроса на проверку подлинности (передавая в запросе параметр политики) и в ответ получает настроенный маркер. Например, единственное различие между запросами, которые вызывают политику регистрации и политику входа, заключается в имени политики, которое используется в качестве строкового параметра "p" в запросе.

```

https://login.microsoftonline.com/contosob2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application ID
&redirect_uri=https%3A%2F%2Flocalhost%3A44321%2F    // Your registered Reply URL, url encoded
&response_mode=form_post                            // 'query', 'form_post' or 'fragment'
&response_type=id_token
&scope=openid
&nonce=dummy
&state=12345                                        // Any value provided by your application
&p=b2c_1_siup                                       // Your sign-up policy

```

```

https://login.microsoftonline.com/contosob2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application ID
&redirect_uri=https%3A%2F%2Flocalhost%3A44321%2F    // Your registered Reply URL, url encoded
&response_mode=form_post                            // 'query', 'form_post' or 'fragment'
&response_type=id_token
&scope=openid
&nonce=dummy
&state=12345                                        // Any value provided by your application
&p=b2c_1_siin                                       // Your sign-in policy

```

Дополнительные сведения об инфраструктуре политик см. [в этой записи блога](http://blogs.technet.com/b/ad/archive/2015/11/02/a-look-inside-azuread-b2c-with-kim-cameron.aspx).

## <a name="create-a-sign-up-policy"></a>Создание политики регистрации
Чтобы добавить возможность регистрации в приложение, необходимо создать политику регистрации. Эта политика описывает действия, которые пользователь должен выполнить во время регистрации, и содержимое маркеров, которые должно получить приложение при успешной регистрации.

1. [Выполните эти действия, чтобы перейти к колонке функций B2C на портале Azure](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Щелкните **Политики регистрации**.
3. Щелкните **+Добавить** в верхней части колонки.
4. **Имя** определяет имя политики регистрации, используемое приложением. Например, введите SiUp.
5. Щелкните **Поставщики удостоверений** и выберите регистрацию по электронной почте. При необходимости можно также выбрать поставщиков удостоверений в социальных сетях, если они уже настроены. Нажмите кнопку **ОК**.
6. Щелкните **Атрибуты регистрации**. Здесь следует выбрать атрибуты, которые пользователь должен предоставить во время регистрации. Например, выберите "Город", "Страна или регион" и "Почтовый индекс". Нажмите кнопку **ОК**.
7. Щелкните **Утверждения приложения**. Здесь вы можете выбрать утверждения, которые необходимо возвращать в маркерах, отправляемых приложению после успешной регистрации. Например, выберите "Отображаемое имя", "Поставщик удостоверений", "Почтовый индекс", "Новый пользователь" и "Идентификатор объекта пользователя".
8. Щелкните **Создать**. Обратите внимание, что в колонке **политик регистрации** только что созданная политика отображается как **B2C_1_SiUp** (фрагмент **B2C\_1\_** добавляется автоматически).
9. Откройте политику, щелкнув **B2C_1_SiUp**.
10. В раскрывающемся списке **Приложения** выберите пункт "Приложение Contoso B2C", а в списке **URL-адрес ответа и URI перенаправления** — `https://localhost:44321/`.
11. Щелкните **Запустить сейчас**. Откроется новая вкладка браузера, и вы сможете пройти процесс регистрации в своем приложении.
    
    > [!NOTE]
    > Создание, обновление и вступление политики в силу занимает около минуты.
    > 
    > 

## <a name="create-a-sign-in-policy"></a>Создание политики входа в систему
Чтобы добавить функцию входа в приложение, необходимо создать политику входа. Эта политика описывает действия, которые пользователь должен выполнить во время входа, и содержимое маркеров, которые должно получить приложение при успешном входе.

1. [Выполните эти действия, чтобы перейти к колонке функций B2C на портале Azure](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Щелкните **Политики входа**.
3. Щелкните **+Добавить** в верхней части колонки.
4. **Имя** определяет имя политики входа, используемое приложением. Например, введите SiIn.
5. Щелкните **Поставщики удостоверений** и выберите пункт Local Account SignIn (Локальная учетная запись для входа). При необходимости можно также выбрать поставщиков удостоверений в социальных сетях, если они уже настроены. Нажмите кнопку **ОК**.
6. Щелкните **Утверждения приложения**. Здесь вы можете выбрать утверждения, которые необходимо возвращать в маркерах, отправляемых приложению после успешного входа. Например, выберите "Отображаемое имя", "Поставщик удостоверений", "Почтовый индекс" и "Идентификатор объекта пользователя". Нажмите кнопку **ОК**.
7. Щелкните **Создать**. Обратите внимание, что в колонке **Политики регистрации** только что созданная политика отображается в следующем виде: **B2C_1_SiIn** (фрагмент **B2C\_1\_** добавляется автоматически).
8. Откройте политику, щелкнув **B2C_1_SiIn**.
9. В раскрывающемся списке **Приложения** выберите пункт "Приложение Contoso B2C", а в списке **URL-адрес ответа и URI перенаправления** — `https://localhost:44321/`.
10. Щелкните **Запустить сейчас**. Откроется новая вкладка браузера, и вы сможете взглянуть на процесс входа в ваше приложение глазами пользователя.
    
    > [!NOTE]
    > Создание, обновление и вступление политики в силу занимает около минуты.
    > 
    > 

## <a name="create-a-sign-up-or-sign-in-policy"></a>Создание политики регистрации или входа в систему
Эта политика регулирует процедуры регистрации и входа в систему в рамках одной конфигурации. Потребители проводятся через соответствующую процедуру (регистрации или входа в систему) в зависимости от контекста. В ней также описывается содержимое токенов, которые приложение будет получать при успешной регистрации или входе в систему.  Пример кода для политики регистрации или входа в систему см. [здесь](active-directory-b2c-devquickstarts-web-dotnet-susi.md).

1. [Выполните эти действия, чтобы перейти к колонке функций B2C на портале Azure](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Щелкните **Sign-up or sign-in policies**(Политики регистрации или входа в систему).
3. Щелкните **+Добавить** в верхней части колонки.
4. **Имя** определяет имя политики регистрации, используемое приложением. Например, введите "SiUpIn".
5. Щелкните **Поставщики удостоверений** и выберите регистрацию по электронной почте. При необходимости можно также выбрать поставщиков удостоверений в социальных сетях, если они уже настроены. Нажмите кнопку **ОК**.
6. Щелкните **Атрибуты регистрации**. Здесь следует выбрать атрибуты, которые пользователь должен предоставить во время регистрации. Например, выберите "Город", "Страна или регион" и "Почтовый индекс". Нажмите кнопку **ОК**.
7. Щелкните **Утверждения приложения**. Здесь вы можете выбрать утверждения, которые необходимо возвращать в токенах, отправляемых приложению после успешной регистрации или входа. Например, выберите "Отображаемое имя", "Поставщик удостоверений", "Почтовый индекс", "Новый пользователь" и "Идентификатор объекта пользователя".
8. Щелкните **Создать**. Обратите внимание, что в колонке **политик регистрации или входа в систему** только что созданная политика отображается в следующем виде: **B2C_1_SiUpIn** (фрагмент **B2C\_1\_** добавляется автоматически).
9. Откройте политику, щелкнув **B2C_1_SiUpIn**.
10. В раскрывающемся списке **Приложения** выберите пункт "Приложение Contoso B2C", а в списке **URL-адрес ответа и URI перенаправления** — `https://localhost:44321/`.
11. Щелкните **Запустить сейчас**. Откроется новая вкладка браузера, и вы сможете взглянуть на процесс регистрации или входа глазами пользователя.
    
    > [!NOTE]
    > Создание, обновление и вступление политики в силу занимает около минуты.
    > 
    > 

## <a name="create-a-profile-editing-policy"></a>Создание политики изменения профиля
Чтобы добавить в приложение возможность изменения профиля, необходимо создать политику изменения профиля. Эта политика описывает действия, которые необходимо выполнить пользователю для изменения профиля, и содержимое маркеров, которые должно получить приложение при успешном изменении.

1. [Выполните эти действия, чтобы перейти к колонке функций B2C на портале Azure](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Щелкните **Политики изменения профиля**.
3. Щелкните **+Добавить** в верхней части колонки.
4. **Имя** определяет имя политики изменения профиля, используемое приложением. Например, введите SiPe.
5. Щелкните **Поставщики удостоверений** и выберите "Локальная учетная запись для входа". При необходимости можно также выбрать поставщиков удостоверений в социальных сетях, если они уже настроены. Нажмите кнопку **ОК**.
6. Щелкните **Атрибуты профиля**. Здесь можно выбрать атрибуты, которые пользователь может просматривать и изменять. Например, выберите "Страна или регион", "Отображаемое имя" и "Почтовый индекс". Нажмите кнопку **ОК**.
7. Щелкните **Утверждения приложения**. Здесь вы можете выбрать утверждения, которые необходимо возвращать в маркерах, отправляемых приложению после успешного изменения профиля. Например, выберите "Отображаемое имя" и "Почтовый индекс".
8. Щелкните **Создать**. Обратите внимание, что в колонке **политик изменения профилей** только что созданная политика отображается в следующем виде: **B2C_1_SiPe** (фрагмент **B2C\_1\_** добавляется автоматически).
9. Откройте политику, щелкнув **B2C_1_SiPe**.
10. В раскрывающемся списке **Приложения** выберите пункт "Приложение Contoso B2C", а в списке **URL-адрес ответа и URI перенаправления** — `https://localhost:44321/`.
11. Щелкните **Запустить сейчас**. Откроется новая вкладка браузера, и вы сможете взглянуть на процесс изменения профиля в вашем приложении глазами пользователя.
    
    > [!NOTE]
    > Создание, обновление и вступление политики в силу занимает около минуты.
    > 
    > 

## <a name="create-a-password-reset-policy"></a>Создание политики сброса паролей
Чтобы обеспечить детально настроенный сброс паролей для приложения, необходимо создать политику сброса паролей. Обратите внимание, что возможность сброса паролей в рамках клиента, указанная [здесь](active-directory-b2c-reference-sspr.md) , по-прежнему применима для политик входа в систему. Эта политика описывает действия, которые необходимо выполнить потребителям для сброса пароля, и содержимое маркеров, которые должно получить приложение при успешном изменении.

1. [Выполните эти действия, чтобы перейти к колонке функций B2C на портале Azure](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Щелкните **Политики сброса паролей**.
3. Щелкните **+Добавить** в верхней части колонки.
4. **Имя** определяет имя политики сброса паролей, используемой приложением. Например, введите "SSPR".
5. Щелкните **Поставщики удостоверений** и выберите сброс пароля с помощью электронного адреса. Нажмите кнопку **ОК**.
6. Щелкните **Утверждения приложения**. Здесь вы можете выбрать утверждения, которые необходимо возвращать в маркерах, отправляемых приложению после успешного сброса пароля. Например, выберите "User's Object ID" (Идентификатор объекта пользователя).
7. Щелкните **Создать**. Обратите внимание, что в колонке **Политики сброса паролей** только что созданная политика отображается в следующем виде: **B2C_1_SSPR** (фрагмент **B2C\_1\_** добавляется автоматически).
8. Откройте политику, щелкнув **B2C_1_SSPR**.
9. В раскрывающемся списке **Приложения** выберите пункт "Приложение Contoso B2C", а в списке **URL-адрес ответа и URI перенаправления** — `https://localhost:44321/`.
10. Щелкните **Запустить сейчас**. Откроется новая вкладка браузера, и вы сможете взглянуть на процесс сброса пароля в приложении глазами потребителя.
    
    > [!NOTE]
    > Создание, обновление и вступление политики в силу занимает около минуты.
    > 
    > 

## <a name="how-to-link-a-sign-up-or-sign-in-policy-with-a-password-reset-policy"></a>Как связать политику регистрации или входа с политикой сброса пароля?
При создании политики регистрации или входа (с помощью локальных учетных записей) на первой странице потребитель увидит ссылку "Забыли пароль?". Нажатие этой ссылки не активирует политику сброса пароля автоматически. Вместо этого в приложении отобразится код ошибки `AADB2C90118`. Приложение должно обработать эту информацию и вызвать определенную политику сброса пароля. [Здесь](https://github.com/AzureADQuickStarts/B2C-WebApp-OpenIDConnect-DotNet-SUSI) приведен пример, демонстрирующий этот способ связывания политик.

## <a name="additional-resources"></a>Дополнительные ресурсы
* [Предварительная версия Azure Active Directory B2C: конфигурация маркера, сеанса и единого входа](active-directory-b2c-token-session-sso.md).
* [Azure Active Directory B2C: отключение проверки адреса электронной почты во время регистрации потребителя](active-directory-b2c-reference-disable-ev.md)


