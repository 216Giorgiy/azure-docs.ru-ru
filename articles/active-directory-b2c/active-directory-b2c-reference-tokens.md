<properties
	pageTitle="Предварительная версия Azure AD B2C | Microsoft Azure"
	description="Типы маркеров, формируемых в предварительной версии Azure AD B2C."
	services="active-directory-b2c"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory-b2c"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/04/2015"
	ms.author="dastrock"/>

# Предварительная версия Azure AD B2C: справочник по маркерам

При обработке каждого [потока проверки подлинности](active-directory-b2c-apps.md) Azure AD B2C формирует маркеры безопасности различных типов. В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

[AZURE.INCLUDE [active-directory-b2c-preview-note](../../includes/active-directory-b2c-preview-note.md)]

## Типы маркеров

Azure AD B2C поддерживает [протокол авторизации OAuth 2.0](active-directory-b2c-reference-protocols.md), использующий как маркеры доступа, так и маркеры обновления. Azure AD B2C также поддерживает проверку подлинности и вход с помощью [OpenID Connect](active-directory-b2c-reference-protocols.md), что приводит к появлению третьего типа маркеров — маркеров идентификации. Каждый из этих маркеров представляется как "токен носителя".

Токен носителя — это упрощенный маркер безопасности, предоставляющий его носителя (предъявителю) доступ к защищенному ресурсу. В этом смысле предъявителем является любая сторона, которая может предъявить маркер. Несмотря на то, что для получения токена носителя сторона должны сначала пройти проверку подлинности в Azure AD, если действия, необходимые для защиты маркера при его передаче и хранении не выполняются, его может перехватить и использовать несанкционированная сторона. Хотя в некоторых маркерах безопасности для предотвращения несанкционированного использования применяется специальный встроенный механизм, в токенах носителя такого механизма нет, и они должны передаваться по защищенному каналу, например с использованием стандарта безопасности транспортного уровня (HTTPS). Если токен носителя передается в незашифрованном виде, злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании токенов носителя для последующего использования. Необходимо всегда проверять, что приложение передает и сохраняет токены носителя безопасным образом. Дополнительные сведения о безопасности в случае применения маркеров носителя см. в [RFC 6750, раздел 5](http://tools.ietf.org/html/rfc6750).

Многие маркеры, формируемые Azure AD B2C, реализуются в виде веб-маркеров JSON (JWT). Маркер JWT — это компактное и безопасное для URL-адреса средство передачи информации между двумя сторонами. Сведения, содержащиеся в маркерах JWT, называются "утверждениями" информации о носителе и субъекте токена. Утверждения в маркерах JWT — это объекты JSON, закодированные и сериализованные для передачи. Поскольку формируемые Azure AD B2C маркеры подписываются, но не зашифровываются, их содержимое можно без труда изучить с целью отладки. Для этого существует несколько инструментов, таких как [calebb.net](https://calebb.net). Дополнительные сведения о маркерах JWT можно найти в [Спецификации JWT](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html).

## Id\_Tokens

Маркеры идентификации являются разновидностью маркеров безопасности, которые приложение получает от конечных точек Azure AD B2C `authorize` и `token` . Они представлены в виде [маркеров JWT](#types-of-tokens) и содержат утверждения, которые можно использовать для идентификации пользователя приложения. Если они получены из конечной точки `authorize`, маркеры идентификации часто используются для входа пользователя в веб-приложение. Если они получены из конечной точки `token`, маркеры идентификации могут отправляться в HTTP-запросах при обмене данными между двумя компонентами одного и того же приложения или службы. Вы можете использовать утверждения в маркере "id\_token" на свое усмотрение. Как правило, их используют для отображения сведений об учетной записи или управления доступом в приложении.

На текущий момент маркеры "id\_token" подписываются, но не зашифровываются. Когда приложение получает маркер идентификации, оно должно [проверить подпись](#validating-tokens), чтобы убедиться в подлинности маркера, а также проверить несколько содержащихся в нем утверждений для подтверждения его действительности. Утверждения, проверяемые приложением, зависят от требований сценария, но [проверка некоторых стандартных утверждений](#validating-tokens) должна выполняться в каждом сценарии.

Полное описание утверждений в маркерах "id\_token" приведено ниже вместе с примером такого маркера. Обратите внимание, что утверждения в маркерах "id\_token" не возвращаются в определенном порядке. Кроме того, в любой момент в маркеры "id\_token" можно добавлять новые утверждения. При этом сбоев в работе приложения возникать не должно. В следующем списке приведены утверждения, которые приложение гарантированно понимает на момент написания этой статьи. В целях обучения попробуйте изучить утверждения в примере маркера идентификации, скопировав его в [calebb.net](https://calebb.net). При необходимости дополнительные сведения можно найти в [Спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).

#### Пример маркера "id\_token"
```
// Line breaks for display purposes only

eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IklkVG9rZW5TaWduaW5nS2V5Q29udGFpbmVyIn0.
eyJleHAiOjE0NDIzNjAwMzQsIm5iZiI6MTQ0MjM1NjQzNCwidmVyIjoiMS4wIiwiaXNzIjoiaHR0cHM6Ly9s
b2dpbi5taWNyb3NvZnRvbmxpbmUuY29tLzc3NTUyN2ZmLTlhMzctNDMwNy04YjNkLWNjMzExZjU4ZDkyNS92
Mi4wLyIsImFjciI6ImIyY18xX3NpZ25faW5fc3RvY2siLCJzdWIiOiJOb3Qgc3VwcG9ydGVkIGN1cnJlbnRs
eS4gVXNlIG9pZCBjbGFpbS4iLCJhdWQiOiI5MGMwZmU2My1iY2YyLTQ0ZDUtOGZiNy1iOGJiYzBiMjlkYzYi
LCJpYXQiOjE0NDIzNTY0MzQsImF1dGhfdGltZSI6MTQ0MjM1NjQzNCwiaWRwIjoiZmFjZWJvb2suY29tIn0.
h-uiKcrT882pSKUtWCpj-_3b3vPs3bOWsESAhPMrL-iIIacKc6_uZrWxaWvIYkLra5czBcGKWrYwrAC8ZvQe
DJWZ50WXQrZYODEW1OUwzaD_I1f1HE0c2uvaWdGXBpDEVdsD3ExKaFlKGjFR2V7F-fPThkVDdKmkUDQX3bVc
yyj2V2nlCQ9jd7aGnokTPfLfpOjuIrTsAdPcGpe5hfSEuwYDmqOJjGs9Jp1f-eSNEiCDQOaTBSvr479L5ptP
XWeQZyX2SypN05Rjr05bjZh3j70ZUimiocfJzjibeoDCaQTz907yAg91WYuFOrQxb-5BaUoR7K-O7vxr2M-_
CQhoFA

```

#### Утверждения в маркерах "id\_token"

В Azure AD B2C у вас есть тщательный контроль над содержимым маркеров. Можно настроить [политики](active-directory-b2c-reference-policies.md) для отправки определенного набора пользовательских данных в утверждениях, которые необходимы приложению для работы. Эти утверждения могут включать стандартные свойства, например `displayName` и `emailAddress` пользователя, а также [пользовательские атрибуты](active-directory-b2c-reference-custom-attr), которые можно определить в своем каталоге B2C. Однако каждый маркер идентификации, который вы получаете, будет содержать определенный набор утверждений безопасности, используемых приложениями для безопасной проверки подлинности пользователей и запросов. Ниже представлены утверждения, которые должны существовать в каждом маркере идентификации, выданном Azure AD B2C, — все остальные утверждения определяются используемой политикой.

| Имя | Утверждение | Пример значения | Описание |
| ----------------------- | ------------------------------- | ------------ | --------------------------------- |
| Аудитория | `aud` | `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` | Определяет целевого получателя маркера. В маркерах "id\_token" целевая аудитория обозначена идентификатором приложения, назначенным ему на портале регистрации приложений. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| Issuer | `iss` | `https://login.microsoftonline.com/775527ff-9a37-4307-8b3d-cc311f58d925/v2.0/` | Определяет службу маркеров безопасности (STS), которая создает и возвращает маркер, а также каталог Azure AD, в котором пользователь прошел проверку подлинности. Приложение должно проверить утверждение издателя и убедиться, что маркер пришел от конечной точки версии 2.0. |
| Выдано в | `iat` | `1438535543` | Время выдачи маркера в виде времени эпохи. |
| Время окончания срока действия | `exp` | `1438539443` | Время окончания срока действия маркера в виде времени эпохи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| До | `nbf` | `1438535543` | Время начала срока действия маркера в виде времени эпохи. Обычно оно совпадает со временем выдачи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| Версия | `ver` | `1.0` | Версия маркера "id\_token", как указано в Azure AD. |
| Хэш-код | `c_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш-код включается в состав маркеров "id\_token", только если маркер выдается вместе с кодом авторизации OAuth 2.0. Его можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о выполнении этой проверки можно найти в [Спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html). |
| Хэш маркера доступа | `at_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш маркера доступа включается в состав маркеров "id\_token", только если маркер выдается вместе с маркером доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о выполнении этой проверки можно найти в [Спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html). |
| Специальное утверждение | `nonce` | `12345` | Специальные утверждения используются для предотвращения атак с использованием воспроизведения маркера. Приложение может указать специальное утверждение в запросе авторизации с помощью параметра `nonce`. Значение, указанное вами в запросе, будет использовано в утверждении `nonce` маркера идентификации без изменений. Это позволяет приложению проверять это значение на соответствие значению, указанному в запросе, что связывает сеанс приложения с определенным маркером "id\_token". Приложение должно выполнять эту проверку во время процесса проверки маркера "id\_token". |
| Субъект | `sub` | `Not supported currently. Use oid claim.` | Субъект, в отношении которого маркер утверждает сведения, например данные о пользователе приложения. Это значение является неизменным, его невозможно назначить другому объекту или использовать повторно. Следовательно, это значение можно использовать для безопасного проведения проверок авторизации, например, когда токен используется для доступа к ресурсу. Однако в предварительной версии Azure AD B2C утверждение субъекта еще не реализовано. Вместо использования утверждения субъекта для авторизации вам следует настроить политики для включения утверждения идентификатора объекта `oid` и использовать это значение для идентификации пользователей. |
| Authentication Context Class Reference | `acr` | `b2c_1_sign_in` | Имя политики, которая была использована для получения маркера идентификации. |
| Время проверки подлинности | `auth_time | `1438535543` | Момент времени, в который пользователь в последний раз вводил учетные данные (с начала эпохи). |



## Маркеры доступа

В настоящий момент Azure AD B2C не выдает маркеры доступа. В предварительной версии проверка подлинности между двумя различными сторонами не поддерживается; тем не менее маркеры идентификации можно использовать для взаимодействия между компонентами одного и того же приложения. Чтобы узнать о приложениях и сценариях проверки подлинности, поддерживаемых общедоступной предварительной версией Azure AD B2C, см. [статью "Приложения B2C"](active-directory-b2c-apps.md).

## Маркеры обновления

Маркеры обновления — это маркеры безопасности, которые приложение может использовать для получения новых маркеров идентификации и маркеров доступа в потоке OAuth 2.0. За счет этого приложение может получить длительный доступ к ресурсам от лица пользователя без необходимости участия самого пользователя.

Чтобы получить обновление в ответе маркера, приложение должно запросить область `offline_acesss`. Для получения дополнительных сведений об области `offline_access` обратитесь к [Справочнику по протоколу Azure AD B2C](active-directory-b2c-reference-protocols.md).

Маркеры обновления абсолютно непрозрачны для приложения и всегда будут таковыми. Они выдаются Azure AD и могут проверяться и интерпретироваться только Azure AD. Они действительны в течение продолжительного времени, но при создании приложение не следует ожидать, что срок действия маркера обновления неограничен. Маркеры обновления могут стать недействительными в любое время по разным причинам. Единственный способ, с помощью которого приложение может выяснить, является ли маркер действительным, — попытаться использовать его путем отправки запроса маркера Azure AD.

При обмене маркера обновления на новый маркер (если приложению предоставлена область `offline_access`) вы получите новый маркер обновления в ответе маркера. Новый маркер обновления необходимо сохранить, заменив им использованный в запросе. Такой подход обеспечит максимальный срок действия маркеров обновления.

## Проверка маркеров

В настоящее время приложениям нужно проверять только маркеры "id\_token". Для проверки маркера "id\_token" приложение должно проверить подпись маркера и содержащиеся в нем утверждения.

<!-- TODO: Link -->
Для проверки JWT доступны многие библиотеки с открытым исходным кодом в зависимости от выбранного языка программирования. Мы рекомендуем изучить различные библиотеки, а не реализовывать логику проверки самостоятельно. Приведенные здесь сведения помогут понять, как правильно использовать эти библиотеки.

#### Проверка подписи
Маркер JWT содержит три сегмента, разделенных символом `.`. Первый сегмент называется **заголовком**, второй — **телом**, а третий — **подписью**. Сегмент подписи можно использовать для проверки подлинности маркера "id\_token", чтобы приложение доверяло ему.

Маркеры "id\_token" подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256. Заголовок маркера "id\_token" содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
		"typ": "JWT",
		"alg": "RS256",
		"kid": "GvnPApfWMdLRi8PDmisFn7bprKg"
}
```

Утверждение `alg` указывает алгоритм, использованный для подписания маркера, а утверждения `kid` или `x5t` указывают конкретный общедоступный ключ, использованный для подписания маркера.

Azure AD может в любой момент времени подписать маркер идентификации с использованием любой пары открытого и закрытого ключей из определенного набора пар. Azure AD периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуем проверять наличие обновлений общедоступных ключей, используемых Azure AD, каждые 24 часа.

Azure AD B2C содержит конечную точку метаданных OpenID Connect, позволяющую приложению получать сведения о Azure AD B2C в среде выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Для каждой политики в каталоге B2C есть собственный документ метаданных JSON. Например, документ метаданных для политики `b2c_1_sign_in` находится в каталоге `fabrikamb2c.onmicrosoft.com`.

`https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_sign_in`

Данные ключа подписи, необходимые для проверки подписи, можно найти в документе метаданных OpenID Connect по ссылке:

```
https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_sign_in
```

где `fabrikamb2c.onmicrosoft.com` — каталог B2C, используемый для проверки подлинности пользователя, а `b2c_1_sign_in` — политика, используемая для получения маркера идентификации. Чтобы определить, какая политика была использована для подписи маркера идентификации (а также определить, откуда необходимо получать метаданные), можно воспользоваться одним из двух вариантов. Во-первых, имя политики включается в утверждение `acr` маркера идентификации. Утверждения из тела маркера JWT можно проанализировать, выполнив декодирование тела маркера из кодировки base-64 и десериализацию результирующей строки JSON. Утверждение `acr` будет представлять собой имя политики, которая использовалась для выпуска маркера идентификации. Другой вариант — закодировать политику в значении параметра `state` при отправке запроса и затем декодировать ее, чтобы определить, какая политика была использована. Каждый из этих методов дает совершенно достоверные результаты.

Этот документ метаданных представляет собой объект JSON, содержащий несколько ценных блоков информации, таких как расположение различных конечных точек, необходимых для проверки подлинности OpenID Connect. Он также включает `jwks_uri`, который содержит расположение набора общедоступных ключей, использованных для подписания маркеров. Расположение указано ниже, но лучше получить его динамическим образом с использованием документа метаданных и анализа `jwks_uri`.

`https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_sign_in`

Документ JSON, расположенный по этому URL-адресу, содержит все сведения об общедоступных ключах, используемые в конкретный момент времени. Приложение может использовать утверждения `kid` или `x5t` в заголовке маркера JWT, чтобы выбрать общедоступный ключ в этом документе, использованный для подписания определенного маркера. Затем оно может выполнить проверку подписи с использованием правильного общедоступного ключа и указанного алгоритма.

Выполнение проверки подписи выходит за рамки этого документа. Если вам требуется помощь в этом вопросе, воспользуйтесь всевозможными библиотеками с открытым исходным кодом.

#### Проверка утверждений
Когда ваше приложение или API получает маркер идентификации после входа пользователя, оно также должно выполнить несколько проверок утверждений в этом маркере. В частности, описаны такие возможности:

- Утверждение **Аудитория**. Необходимо для подтверждения того, что маркер идентификации действительно предназначался вашему приложению.
- Утверждения **Выдано в** и **Время окончания срока действия**. Необходимы для подтверждения того, что срок действия маркера идентификации не истек.
- Утверждение **Издатель**. Необходимо, чтобы убедиться, что маркер действительно был выдан Azure AD для вашего приложения.
- **Специальное** утверждение. Используется для предотвращения атак с использованием воспроизведения маркера.

Сведения об ожидаемых значениях для этих утверждений приведены в разделе [Маркер идентификации](#id_tokens) выше.

## Сроки действия маркеров

Следующие сведения о сроках действия маркеров приведены исключительно в целях ознакомления, поскольку они могут пригодиться при разработке и отладке приложений. При создании приложения не следует ожидать постоянства какого-либо из указанных сроков, поскольку они могут и будут изменяться в любой момент времени.

| токен | Срок действия | Описание |
| ----------------------- | ------------------------------- | ------------ |
| Id\_Tokens | 1 час | Маркеры "id\_token" обычно действительны в течение часа. Веб-приложение может использовать тот же срок действия в рамках собственного сеанса с пользователем (рекомендуется) или выбрать совершенно другое время проведения сеанса. Если приложению необходимо получить новый маркер идентификации, оно должно просто создать новый запрос входа в Azure AD. Если в браузере у пользователя есть действительный сеанс Azure AD, повторный ввод учетных данных может не потребоваться. |
| Маркеры обновления | До 14 дней | Один маркер обновления действителен до 14 дней. Однако маркер обновления может стать недействительным в любое время по различным причинам, поэтому приложение должно использовать маркер обновления, пока срок его действия не истечет, либо пока приложение не заменит его новым маркером. Маркер обновления также станет недействительным, если последний раз пользователь вводил учетные данные более 90 дней назад. |
| Коды авторизации | 5 мин | Срок действия кодов авторизации умышленно установлен очень коротким, и маркеры доступа, идентификации и обновления следует использовать сразу же после их получения. |

<!---HONumber=Sept15_HO3-->