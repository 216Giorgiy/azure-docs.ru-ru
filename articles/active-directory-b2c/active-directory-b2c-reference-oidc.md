<properties
	pageTitle="Предварительная версия Azure Active Directory B2C | Microsoft Azure"
	description="Построение веб-приложений с помощью реализации протокола проверки подлинности OpenID Connect в Azure Active Directory."
	services="active-directory-b2c"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory-b2c"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/31/2016"
	ms.author="dastrock"/>

# Предварительная версия Azure Active B2C: вход в веб-приложения с помощью OpenID Connect

OpenID Connect — это протокол проверки подлинности, который может использоваться для безопасного входа пользователей в веб-приложения. Он построен на основе OAuth 2.0. Используя реализацию OpenID Connect в Azure Active Directory (Azure AD) B2C, можно передать Azure AD регистрацию, вход в систему и другие действия по управлению пользователями в веб-приложениях. Это руководство показывает, как сделать это независимо от языка, и описывает, как отправлять и получать сообщения HTTP, не используя ни одну из наших библиотек с открытым исходным кодом.

<!-- TODO: Need link to libraries -->

[AZURE.INCLUDE [active-directory-b2c-preview-note](../../includes/active-directory-b2c-preview-note.md)]

[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *проверки подлинности*, что позволяет вам выполнять единый вход с помощью OAuth. Этот протокол вводит понятие `id_token`, маркера безопасности, который позволяет клиенту выполнять идентификацию пользователя и получать основные сведения о профиле пользователя.

Так как OpenID Connect представляет собой расширение OAuth 2.0, он также позволяет приложениям безопасно получать **маркеры доступа**, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-b2c-reference-protocols.md#the-basics). Мы рекомендуем использовать OpenID Connect для веб-приложений, которые размещаются на сервере и доступны через веб-браузер. Если вы хотите добавить идентификацию пользователей с помощью Azure AD B2C в мобильные или настольные приложения, необходимо использовать [OAuth 2.0](active-directory-b2c-reference-oauth-code.md), а не OpenID Connect.

В Azure AD B2C стандартный протокол OpenID Connect выходит за рамки простой проверки подлинности и авторизации. В нем появляется [**параметр политики**](active-directory-b2c-reference-policies.md), который позволяет использовать OpenID Connect для добавления в приложение действий по управлению пользователями: регистрации, входа и управления профилями. Здесь мы покажем, как с помощью OpenID Connect и политик реализовать каждую из этих функций в собственных веб-приложениях и получить маркеры доступа к веб-интерфейсам API.

В приведенных ниже запросах HTTP будет использован наш пример каталога B2C **fabrikamb2c.onmicrosoft.com**, а также наши примеры приложения ****https://aadb2cplayground.azurewebsites.net** и политик. Вы можете пробовать выполнять запросы с этими значениями или заменить их на собственные. Узнайте, как [получить собственный клиент, приложение и политики B2C](#use-your-own-b2c-directory).

## Отправка запросов проверки подлинности
Если веб-приложению требуется проверить подлинность пользователя и выполнить политику, оно может направить его к конечной точке `/authorize`. Это интерактивная часть потока, в которой пользователь фактически выполняет действие в зависимости от политики.

В этом запросе клиент указывает разрешения, необходимые для получения от пользователя в параметре `scope`, и политики для выполнения в параметре `p`. Ниже приведены три примера для разных политик (переносы строк добавлены для удобства чтения). Чтобы понять, как работает каждый запрос, попробуйте вставить его в браузер и запустить.

#### Пример с политикой входа в систему

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=form_post
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_sign_in
```

#### Пример с политикой регистрации

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=form_post
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_sign_up
```

#### Пример с политикой изменения профиля

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=fragment
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_edit_profile
```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | ----------------------- |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com/) назначил вашему приложению. |
| response\_type | Обязательно | Тип отклика, который должен включать `id_token` для OpenID Connect. Если веб-приложению также потребуются маркеры для вызова веб-API, можете использовать `code+id_token`, как и в наших примерах. |
| redirect\_uri | Обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации** (подробнее об этом далее в статье). Область `offline_access` для веб-приложений является необязательной. Она означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| response\_mode | Рекомендуется | Метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment". |
| state | Рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Этот параметр также включает информацию о состоянии пользователя в приложении перед созданием запроса на проверку подлинности (например, об открытой в тот момент странице). |
| nonce | Обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| p | Обязательно | Политика, которая будет выполняться. Это имя политики, созданной в клиенте B2C. Оно должно начинаться с "b2c\_1\_". Дополнительные сведения о политиках см. в статье [Расширяемая платформа политик](active-directory-b2c-reference-policies.md). |
| prompt | Необязательно | Требуемый тип взаимодействия с пользователем. На текущий момент единственное допустимое значение — "login", при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На этом этапе пользователю будет предложено завершить рабочий процесс для политики. Для этого могут потребоваться ввод имени пользователя и пароля, вход с помощью удостоверения социальной сети, регистрация в каталоге или любые другие действия, определенные в политике.

После того как пользователь завершит политику, Azure AD вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`. Во всех вышеперечисленных случаях ответ будет одинаковым независимо от политики, которая была выполнена.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://aadb2cplayground.azurewebsites.net/#
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о маркерах идентификации и их содержимом можно найти в [Справочнике по маркерам Azure AD B2C](active-directory-b2c-reference-tokens.md). |
| Код | Код авторизации, который запросило приложение, если вы использовали `response_type=code+id_token`. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://aadb2cplayground.azurewebsites.net/#
error=access_denied
&error_description=the+user+canceled+the+authentication
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |
| state | См. полное описание в предыдущей таблице. Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |


## Проверка маркера "id\_token"
Для проверки подлинности пользователя недостаточно просто получить маркер "id\_token". Вам также потребуется проверить подпись маркера "id\_token" и утверждения в нем в соответствии с требованиями приложения. В Azure AD B2C для подписи маркеров и проверки их действительности используются [веб-маркеры JSON (JWT)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Для проверки JWT доступны многие библиотеки с открытым исходным кодом в зависимости от выбранного языка программирования. Мы рекомендуем изучить различные библиотеки, а не реализовывать логику проверки самостоятельно. Приведенные здесь сведения помогут понять, как правильно использовать эти библиотеки.

Azure AD B2C содержит конечную точку метаданных OpenID Connect, позволяющую приложению получать сведения о Azure AD B2C в среде выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Для каждой политики в клиенте B2C есть собственный документ метаданных JSON. Например, документ метаданных для политики `b2c_1_sign_in` находится в каталоге `fabrikamb2c.onmicrosoft.com`.

`https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_sign_in`

Одно из свойств этого документа конфигурации — `jwks_uri`, значение которого для точно такой же политики будет следующим:

`https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_sign_in`.

Чтобы определить, какая политика была использована для подписи маркера идентификации (а также определить, откуда необходимо получать метаданные), можно воспользоваться одним из двух вариантов. Во-первых, имя политики включается в утверждение `acr` маркера идентификации. Сведения об анализе утверждений маркера идентификации см. в [Справочнике по маркерам Azure AD B2C](active-directory-b2c-reference-tokens.md). Другой вариант — закодировать политику в значении параметра `state` при отправке запроса и затем декодировать ее, чтобы определить, какая политика была использована. Каждый из этих методов дает совершенно достоверные результаты.

После получения документа метаданных из конечной точки метаданных OpenID Connect можно использовать открытые ключи RSA256, расположенные в этой конечной точке, для проверки подписи маркера идентификации. В каждый момент времени в этой конечной точке может находиться множество ключей, каждый из которых определяется `kid`. Заголовок токена "id\_token" также содержит утверждение `kid`, указывающее на ключ, который был использован для подписи токена "id\_token". См. [Справочник по маркерам Azure AD B2C](active-directory-b2c-reference-tokens.md), включая подразделы [Проверка маркеров](active-directory-b2c-reference-tokens.md#validating-tokens) и [Важные сведения о смене ключей подписи](active-directory-b2c-reference-tokens.md#validating-tokens).
<!--TODO: Improve the information on this-->

После проверки подписи маркера "id\_token" вам потребуется проверить несколько утверждений:

- Проверьте утверждение `nonce` во избежание атак с использованием воспроизведения маркера. Его значение должно совпадать с указанным вами в запросе на вход.
- Проверьте утверждение `aud` и убедитесь, что для вашего приложения был выдан маркер идентификации. Его значением должен быть идентификатор приложения вашего приложения.
- Проверьте утверждения `iat` и `exp`, чтобы убедиться, что срок действия маркера идентификации не истек.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в маркере идентификации можно найти в [Справочнике по маркерам Azure AD B2C](active-directory-b2c-reference-tokens.md).

После полной проверки маркера "id\_token" вы можете начать сеанс с пользователем и использовать утверждения в маркере "id\_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## Получение маркера
Если вашему веб-приложению требуется только выполнять политики, вы можете пропустить следующие несколько разделов. Эти разделы применяются только к веб-приложениям, которым необходимо выполнять защищенные проверкой подлинности вызовы веб-API, также защищенные Azure AD B2C.

Чтобы воспользоваться кодом авторизации маркера для необходимого ресурса (полученным с помощью `response_type=code+id_token`), отправьте запрос `POST` на конечную точку `/token`. В предварительной версии Azure AD B2C единственный ресурс, для которого можно запросить маркер, — это веб-API серверной части вашего приложения. По соглашению при запросе маркера для себя следует использовать область `openid`.

```
POST fabrikamb2c.onmicrosoft.com/v2.0/oauth2/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=openid offline_access&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob&client_secret=<your-application-secret>

```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | --------------------- |
| p | Обязательно | Политика, которая использовалась для получения кода авторизации. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к **строке запроса**, а не в тело запроса POST. |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com/) назначил вашему приложению. |
| grant\_type | Обязательно | Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации**. Ее можно использовать для получения маркеров для веб-API серверной части приложения, идентификатор приложения которого совпадает с идентификатором приложения клиента. Область `offline_access` означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| Код | Обязательно | Код авторизации, полученный на первом участке потока. |
| redirect\_uri | Обязательно | URI перенаправления приложения, в котором вы получили код авторизации. |
| client\_secret | Обязательно | Секрет приложения, созданный в [портале Azure](https://portal.azure.com/). Это важный артефакт безопасности, и он должен безопасно храниться на сервере. Также следует позаботиться о том, чтобы периодически изменять секрет клиента. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"not_before": "1442340812",
	"token_type": "Bearer",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"scope": "openid offline_access",
	"id_token_expires_in": "3600",
	"profile_info": "eyJ2ZXIiOiIxLjAiLCJ0aWQiOiI3NzU1MjdmZi05YTM3LTQzMDctOGIzZC1jY...",
	"refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
	"refresh_token_expires_in": "1209600"
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| not\_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token\_type | Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| id\_token | Подписанный маркер JWT, который вы запрашивали. |
| scope | Области, для которых маркер является действительным и которые можно использовать для кэширования маркеров для последующего использования. |
| id\_token\_expires\_in | Срок действия маркера id\_token (в секундах). |
| profile\_info | Строка JSON в кодировке Base64, которая может содержать полезные сведения о пользователе для отображения в собственном приложении. Ее точное содержимое будет зависеть от утверждений приложения, настроенных в вашей политике. |
| refresh\_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения можно найти в [Справочнике по маркерам B2C](active-directory-b2c-reference-tokens.md). Обратите внимание, что для получения маркера обновления необходимо использовать область `offline_access` как в запросе авторизации, так и в запросе маркера. |
| refresh\_token\_expires\_in | Максимальное время действия маркера обновления (в секундах). Несмотря на это, маркер обновления может стать недействительным в любой момент времени. |

> [AZURE.NOTE]
	Если в этот момент вы думаете: "Где же маркер доступа?", примите во внимание следующее. При запросе области `openid` Azure AD будет выдавать в ответе JWT `id_token`. Хотя этот `id_token` с технической точки зрения не является маркером доступа OAuth 2.0, он может использоваться в качестве маркера доступа для связи со службой серверной части приложения, идентификатор клиента которого совпадает с идентификатором клиента. `id_token` по-прежнему представляет собой подписанный токен носителя JWT, который можно отправить ресурсу в заголовке авторизации HTTP и который может использоваться в запросах проверки подлинности. <br><br>Различие в том, что у `id_token` отсутствует механизм для ограничения областей доступа конкретного клиентского приложения. Однако в том случае, когда ваше клиентское приложение — это единственное клиентское приложение, которое может взаимодействовать со службой серверной части приложения (а в текущей предварительной версии Azure AD B2C это именно так), такой механизм ограничений областей доступа не нужен. <br><br>Когда в предварительную версию Azure AD B2C будут добавлены возможности взаимодействия клиентов с ресурсами дополнительных первой и третьей сторон, будут также добавлены необходимые маркеры доступа. Однако даже тогда рекомендуемым подходом по-прежнему останется использование `id_tokens` для связи со службой серверной части приложения. Дополнительные сведения о типах приложений, которые можно создавать в предварительной версии Azure AD B2C, см. в [этой статье](active-directory-b2c-apps.md).

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## Использование маркера
После успешного получения `id_token` маркер можно использовать в запросах к веб-API серверной части приложения, включая маркер в заголовок `Authorization`.

```
GET /tasks
Host: https://mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## Обновление маркера
Срок действия маркеров id\_token крайне мал. Для сохранения доступа к ресурсам маркеры с истекшим сроком действия необходимо обновлять. Для этого нужно отправить еще один запрос `POST` в конечную точку `/token`, указав `refresh_token` вместо `code`:

```
POST fabrikamb2c.onmicrosoft.com/v2.0/oauth2/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=openid offline_access&refresh_token=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob&client_secret=<your-application-secret>
```

| Параметр | Обязательно | Описание |
| ----------------------- | ------------------------------- | -------- |
| p | Обязательно | Политика, которая использовалась для получения исходного маркера обновления. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к **строке запроса**, а не в тело запроса POST. |
| client\_id | Обязательно | Идентификатор приложения, который [портал Azure](https://portal.azure.com/) назначил вашему приложению. |
| grant\_type | Обязательно | Тип предоставления. Для этого участка потока кода авторизации это должен быть тип `refresh_token`. |
| scope | Обязательно | Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Область `openid` означает разрешение на вход пользователя и получение данных о пользователе в форме **маркеров идентификации**. Ее можно использовать для получения маркеров для веб-API серверной части приложения, идентификатор приложения которого совпадает с идентификатором приложения клиента. Область `offline_access` означает, что вашему приложению потребуется **маркер обновления** для продолжительного доступа к ресурсам. |
| redirect\_uri | Обязательно | URI перенаправления приложения, в котором вы получили код авторизации. |
| refresh\_token | Обязательно | Исходный маркер обновления, полученный на втором участке потока. Обратите внимание, что для получения маркера обновления необходимо использовать область `offline_access` как в запросе авторизации, так и в запросе маркера. |
| client\_secret | Обязательно | Секрет приложения, созданный в [портале Azure](https://portal.azure.com/). Это важный артефакт безопасности, и он должен безопасно храниться на сервере. Также следует позаботиться о том, чтобы периодически изменять секрет клиента. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"not_before": "1442340812",
	"token_type": "Bearer",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"scope": "openid offline_access",
	"id_token_expires_in": "3600",
	"profile_info": "eyJ2ZXIiOiIxLjAiLCJ0aWQiOiI3NzU1MjdmZi05YTM3LTQzMDctOGIzZC1jY...",
	"refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
	"refresh_token_expires_in": "1209600"
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| not\_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token\_type | Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| id\_token | Подписанный маркер JWT, который вы запрашивали. |
| scope | Области, для которых маркер является действительным и которые можно использовать для кэширования маркеров для последующего использования. |
| id\_token\_expires\_in | Срок действия маркера id\_token (в секундах). |
| profile\_info | Строка JSON в кодировке Base64, которая может содержать полезные сведения о пользователе для отображения в собственном приложении. Ее точное содержимое будет зависеть от утверждений приложения, настроенных в вашей политике. |
| refresh\_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения можно найти в [Справочнике по маркерам B2C](active-directory-b2c-reference-tokens.md). |
| refresh\_token\_expires\_in | Максимальное время действия маркера обновления (в секундах). Несмотря на это, маркер обновления может стать недействительным в любой момент времени. |

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |


<!--

Here is the entire flow for a native app; each request is detailed in the sections below:

![OAuth Auth Code Flow](./media/active-directory-b2c-reference-oauth-code/convergence_scenarios_native.png)

-->

## Отправка запроса на выход

Для выхода пользователя из приложения недостаточно очистить файлы cookie или каким-то другим образом завершить сеанс пользователя. Необходимо также перенаправить пользователя в Azure AD для выхода. Если этого не сделать, то пользователь сможет снова пройти проверку подлинности в приложении без ввода учетных данных, так как они будут иметь действительный сеанс единого входа с Azure AD.

Можно просто перенаправить пользователя на `end_session_endpoint`, который перечислен в том же документе метаданных OpenID, описанном выше в разделе "Проверка маркера id\_token":

```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/logout?
p=b2c_1_sign_in
&post_logout_redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
```

| Параметр | Обязательный? | Описание |
| ----------------------- | ------------------------------- | ------------ |
| p | Обязательно | Политика, которую пользователь использовал для входа в приложение последней. |
| post\_logout\_redirect\_uri | Рекомендуется | URL-адрес, на который пользователя следует перенаправить после успешного выхода. Если он не указан, то пользователю будет показано универсальное сообщение Azure AD B2C. |

> [AZURE.NOTE]
	Хотя при перенаправлении пользователя на `end_session_endpoint` произойдет очистка части данных состояния единого входа через Azure AD B2C для пользователей, фактически пользователь не выйдет из сеанса поставщика удостоверений социальных сетей. Если пользователь выберет тот же IDP во время последующего входа, он будет повторно аутентифицирован без ввода учетных данных. Если пользователь хочет выйти из приложения B2C, это совершенно не означает, что он также хочет полностью выйти из учетной записи Facebook. Тем не менее для локальных учетных записей необходимо правильно завершить сеанс пользователя.

## Использование собственного клиента B2C

Если вы хотите попробовать выполнить эти запросы самостоятельно, необходимо сначала выполнить следующие три шага, а затем заменить значения в примере выше на собственные.

- [Создайте клиент B2C](active-directory-b2c-get-started.md) и используйте имя своего клиента в запросах.
- [Создайте приложение](active-directory-b2c-app-registration.md) для получения идентификатора приложения и URI перенаправления. Вы можете включить в свое приложение **веб-приложение или веб-API** и при необходимости создать **секрет приложения**.
- [Создайте собственные политики](active-directory-b2c-reference-policies.md) для получения имен политик.

<!--

TODO

OpenID Connect for the v2.0 app model is the recommended way to implement sign-in for a [web app](active-directory-v2-flows.md#web-apps). The most basic sign-in flow contains the following steps:

image goes here

-->

<!---HONumber=AcomDC_0608_2016-->