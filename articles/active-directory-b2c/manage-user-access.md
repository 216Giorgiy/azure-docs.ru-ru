---
title: Управление доступом пользователей в Azure Active Directory B2C | Документация Майкрософт
description: Узнайте, как с помощью Azure AD B2C выявлять в приложении несовершеннолетних пользователей, собирать данные о дате рождения и стране пребывания, а также получать согласие с условиями использования.
services: active-directory-b2c
author: davidmu1
manager: mtillman
ms.service: active-directory
ms.workload: identity
ms.topic: article
ms.date: 05/04/2018
ms.author: davidmu
ms.component: B2C
ms.openlocfilehash: 52cf34d56f87d2543fb272ce99dbe011bc0ea037
ms.sourcegitcommit: 6116082991b98c8ee7a3ab0927cf588c3972eeaa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/05/2018
ms.locfileid: "34711133"
---
# <a name="manage-user-access-in-azure-ad-b2c"></a>Управление доступом пользователей в Azure AD B2C

Эта статья содержит сведения об управлении доступом пользователей к приложениям с помощью Azure Active Directory B2C. Управление доступом в приложении включает следующие аспекты:

- выявление несовершеннолетних и ограничение их доступа к отдельным функциям приложения;
- получение родительского согласия на использование приложений несовершеннолетним пользователем;
- сбор данных о дате рождения и стране пребывания пользователя;
- получение согласия с условиями использования и ограничение доступа при его отсутствии.

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

>[!Note] 
>Эта статья содержит сведения, которые позволят вам выполнить все обязанности, установленные Общим регламентом по защите данных (GDRP). Если вы ищете общие сведения о GDPR, обратитесь к [разделу о GDPR на портале служб защиты данных](https://servicetrust.microsoft.com/ViewPage/GDPRGetStarted).

## <a name="control-minor-access"></a>Управление доступом для несовершеннолетних

Разработчики приложений и организации могут ограничивать доступ несовершеннолетних пользователей к определенным приложениям и службам, которые не предназначены для такой аудитории. Также можно разрешить доступ несовершеннолетним с последующим получением родительского согласия и предоставлять им допустимые возможности с учетом бизнес-правил и действующих регламентов. 

Если в Azure AD B2C пользователь определяется как несовершеннолетний, для последовательности взаимодействия с пользователями можно задать один из трех вариантов действий:

- **Send a signed JWT id_token back to the application** (Отправлять подписанный маркер идентификации JWT обратно приложению). В этом случае пользователь регистрируется в каталоге, а маркер возвращается в приложение. Приложение самостоятельно выбирает варианты действий в соответствии с бизнес-правилами. Например, приложение может перейти к процессу получения родительского согласия. Для этого вам нужно получать утверждения **ageGroup** и **consentProvidedForMinor** из приложения.
- **Send an unsigned JSON token to the application** (Отправить приложению неподписанный маркер JSON). Azure AD B2C уведомит приложение, что пользователь является несовершеннолетним, и предоставит сведения о состоянии родительского согласия для этого пользователя. Приложение самостоятельно выбирает варианты действий в соответствии с бизнес-правилами. Маркер JSON не позволяет приложению успешно завершить аутентификацию. Приложение должно выполнить для такого пользователя некоторые действия с использованием утверждений, включенных в маркер JSON, который может содержать **имя**, **адрес электронной почты**, свойства **ageGroup** и **consentProvidedForMinor**.
- **Block the user** (Блокировать пользователя). Все несовершеннолетние пользователи, для которых не предоставлено родительское согласие, будут заблокированы.  В этом случае в Azure AD B2C пользователь может увидеть экран со сведениями о блокировке.  Маркер при этом не выдается и доступ не предоставляется, а если выполнялся процесс регистрации — учетная запись пользователя не создается. Для реализации этого варианта создайте HTML или CSS-страницу содержимого с информацией для пользователя и описанием доступных вариантов действий. Для новых регистраций приложению не нужно выполнять дополнительные действия.

## <a name="get-parental-consent"></a>Получение родительского согласия

В зависимости от действующих требований к приложению, для некоторых действий требуется родительское согласие от взрослого пользователя, возраст которого подтвержден.  Azure AD B2C не предоставляет интерфейс, который позволит проверить возраст человека и предоставить родительское согласие для несовершеннолетнего.  Такая возможность должна быть реализована самим приложением или сторонним поставщиком услуг.

Ниже приведен пример последовательности взаимодействия с пользователем для получения родительского согласия.

1. Операция в [API Graph Azure Active Directory](https://msdn.microsoft.com/en-us/library/azure/ad/graph/api/api-catalog) определяет, что пользователь является несовершеннолетним, и возвращает приложению данные этого пользователя в виде неподписанного маркера JSON.
2. Приложение обрабатывает полученный маркер JSON и отображает пользователю сообщение о том, что для некоторых действий требуется родительское согласие, а также предлагает возможность предоставить такое согласие. 
3. В Azure AD B2C отображается интерфейс входа, в котором пользователь может выполнить обычный вход, и выдается приложению маркер с утверждением **legalAgeGroupClassification = "minorWithParentalConsent"**. Приложение получает адрес электронной почты родителя и проверяет, что тот является взрослым, используя надежный источник информации: орган, выдавший удостоверение личности, интерфейс проверки водительских прав или подтверждения кредитной карты. При успешном выполнении приложение предлагает несовершеннолетнему пользователю выполнить вход через интерфейс Azure AD B2C. Если разрешение было отклонено (т. е. сохраняется утверждение **legalAgeGroupClassification = "minorWithoutParentalConsent"**, Azure AD B2C возвращает приложению маркер JSON (не дающий права входа), чтобы снова повторить процесс получения согласия. Также есть возможность настроить последовательность взаимодействия с пользователем, позволяющую взрослому или самому несовершеннолетнему получить доступ к учетной записи несовершеннолетнего, например отправляя код регистрации на сохраненный адрес электронной почты несовершеннолетнего или взрослого.
4. Приложение позволяет несовершеннолетнему пользователю отозвать согласие.
5. Если несовершеннолетний или взрослый отзывает согласие, можно через API Graph Azure AD изменить значение параметра **consetProvidedForMinor** на **denied**. Кроме того, приложение может удалить учетную запись несовершеннолетнего при отзыве разрешения. Также есть возможность настроить последовательность взаимодействия с пользователем так, чтобы прошедший аутентификацию несовершеннолетний (или его родитель, войдя с учетной записью несовершеннолетнего) мог отозвать согласие. Azure AD B2C сохраняет для параметра **consentProvidedForMinor** значение **denied**.

Дополнительные сведения об утверждениях **legalAgeGroupClassification**, **consentProvidedForMinor** и **ageGroup** можно найти в описании [типов ресурсов пользователя](https://developer.microsoft.com/en-us/graph/docs/api-reference/beta/resources/user). Дополнительные сведения о пользовательских атрибутах см. в статье [Azure Active Directory B2C: использование настраиваемых атрибутов для сбора данных о потребителях](active-directory-b2c-reference-custom-attr.md). При обращении к дополнительным атрибутам через API Graph Azure AD необходимо использовать полное представление атрибута, например "extension_18b70cf9bb834edd8f38521c2583cd86_dateOfBirth": "2011-01-01T00:00:00Z"

## <a name="gather-date-of-birth-and-country-data"></a>Сбор сведений о дате рождения и стране пребывания

Приложения могут доверить Azure AD B2C сбор сведений о дате рождения и стране пребывания для всех пользователей во время регистрации. Если сведения о дате рождения или стране отсутствуют, пользователю будет предложено ввести их при следующем входе (аутентификации). Пользователи не смогут продолжать работу, не предоставив данных о дате рождения и стране пребывания. На основе данных о дате рождения и стране пребывания Azure AD B2C определяет, считается ли пользователь несовершеннолетним по законам соответствующей страны. 

Можно настроить собственную последовательность для сбора данных о дате рождения и стране пребывания, а затем с помощью преобразования утверждений Azure AD B2C установить соответствующее значение параметра **ageGroup** и сохранить этот результат в каталоге (либо напрямую сохранить данные о дате рождения и стране пребывания).

Ниже описывается логика расчета значения для параметра **ageGroup** на основе даты рождения.

1. Попробуйте найти страну по коду из списка. Если подходящих значений не найдено, используйте вариант **по умолчанию**.
2. Если для элемента выбранной страны присутствует узел **MinorConsent**:  <br>a. Вычислите минимальную дату рождения, с которой пользователь может считаться взрослым. Пример: дата рождения 14-03-2015 и **MinorConsent** имеет значение 18, тогда минимальная дата рождения для взрослого — 14-03-2000.
    <br>Б. Сравните минимальную дату рождения с фактически указанной датой рождения. Если минимальная дата рождения наступает раньше даты рождения пользователя, результатом вычисления считается значение возрастной группы **Minor**.
3. Если в элементе страны присутствует узел **MinorNoConsentRequired**, повторите шаги 2а и 2б для значения параметра **MinorNoConsentRequired**. Результатом вычислений на шаге 2б будет считаться значение **MinorNoConsentRequired**, если минимальная дата рождения наступает до даты рождения пользователя. 
4. Если ни одно из описанных вычисление не возвращает значение true, результатом считается возрастная группа **Adult**.

Если приложение собирает данные о дате рождения и стране пребывания другим способом, оно может использовать API Graph для обновления полученной информации в учетной записи пользователя. Например: 

- Если пользователь достоверно считается взрослым, сохраните для атрибута каталога **ageGroup** значение **Adult**.
- Если пользователь достоверно считается несовершеннолетним, сохраните для атрибута каталога **ageGroup** значение **Minor** или **consentProvidedForMinor** с учетом всех данных.

Дополнительные сведения о сборе данных о дате рождения см. в статье [Использование фильтрации по возрасту в Azure AD B2C](basic-age-gating.md).

## <a name="capture-terms-of-use-agreement"></a>Сбор согласия с условиями использования

Обычно приложения разрабатываются так, что согласие пользователя с условиями использования подтверждается в самом приложении, без участия или с минимальным участием каталога пользователей.  Но у вас есть возможность использовать последовательность взаимодействия Azure AD B2C для сбора данных о согласии пользователей с условиями использования, ограничения доступа при отсутствии такого согласия и запроса на подтверждение согласия при любом изменении условий использования с учетом даты последнего подтверждения и даты публикации последней версии условий использования.

**Условия использования** могут включать согласие на передачу данных третьим лицам.  Подтверждение такого согласия пользователя можно технически совместить с подтверждением условий использования или предоставить возможность подтвердить только что-то одно, в зависимости от местных законодательных требований и бизнес-правил.

Далее описаны возможности для управления условиями использования:

1. Сохраните согласие с условиями использования и дату подтверждения с помощью API Graph и расширенных атрибутов. Это можно сделать с помощью стандартной или в настраиваемой последовательности взаимодействия. Мы рекомендуем создать и использовать атрибуты **extension_termsOfUseConsentDateTime** и **extension_termsOfUseConsentVersion**.
2. Создайте в интерфейсе флажок "Принять условия использования" и сохраните полученное значение во время регистрации пользователя. Это можно сделать с помощью стандартной или в настраиваемой последовательности взаимодействия.
3. Azure AD B2C хранит соглашение об условиях использования и подтверждение согласия с ним. С помощью API Graph можно получить состояние подтверждения для любого пользователя, считывая значение соответствующего расширенного атрибута, например **termsOfUseTestUpdateDateTime**. Это можно сделать с помощью стандартной или в настраиваемой последовательности взаимодействия.
4. Чтобы затребовать согласие с обновленными условиями использования, сравните дату подтверждения с датой публикации последней версии условий использования. Это можно сделать только с помощью настраиваемой последовательности взаимодействия. Получите расширенный атрибут **extension_termsOfUseConsentDateTime** и сравните его значение с утверждением **termsOfUseTextUpdateDateTime**. Если согласие считается устаревшим, отобразите экран для обязательного подтверждения нового согласия, а при отсутствии согласия заблокируйте доступ с помощью логики политик.
5. Чтобы потребовать согласие с обновленными условиями использования, сравните номер версии в сохраненном согласии с актуальным номером версии. Это можно сделать только с помощью настраиваемой последовательности взаимодействия. Получите расширенный атрибут **extension_termsOfUseConsentDateTime** и сравните его значение с утверждением **extension_termsOfUseConsentVersion**. Если согласие считается устаревшим, отобразите экран для обязательного подтверждения нового согласия, а при отсутствии согласия заблокируйте доступ с помощью логики политик.

Получение согласия с условиями использования можно реализовать в следующих сценариях взаимодействия с пользователем:

- Регистрация нового пользователя. Отображаются условия использования, сохраняется результат согласия.
- В систему входит пользователь, уже подтвердивший согласие с актуальной или активной версией условий. Условия использования не отображаются.
- В систему входит пользователь, еще не подтвердивший согласие с актуальной или активной версией условий. Отображаются условия использования, сохраняется результат согласия.
- В систему входит пользователь, ранее подтвердивший согласие с предыдущей версией условий использования, которая с тех пор была заменена на новую версию. Отображаются условия использования, сохраняется результат согласия.

На следующем изображении представлена рекомендованная последовательность взаимодействия с пользователем:

![Последовательность согласия пользователя](./media/manage-user-access/user-flow.png) 

В следующем примере реализуется логика согласия с условиями использования, основанная на утверждении и проверке даты и времени:

```
<ClaimsTransformations>
  <ClaimsTransformation Id="GetNewUserAgreeToTermsOfUseConsentDateTime" TransformationMethod="GetCurrentDateTime">
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="extension_termsOfUseConsentDateTime" TransformationClaimType="currentDateTime" />
    </OutputClaims>
  </ClaimsTransformation>
  <ClaimsTransformation Id="IsTermsOfUseConsentRequired" TransformationMethod="IsTermsOfUseConsentRequired">
    <InputClaims>
      <InputClaim ClaimTypeReferenceId="extension_termsOfUseConsentDateTime" TransformationClaimType="termsOfUseConsentDateTime" />
    </InputClaims>
    <InputParameters>
      <InputParameter Id="termsOfUseTextUpdateDateTime" DataType="dateTime" Value="2098-01-30T23:03:45" />
    </InputParameters>
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="termsOfUseConsentRequired" TransformationClaimType="result" />
    </OutputClaims>
  </ClaimsTransformation>
</ClaimsTransformations>
```

В следующем примере реализуется логика согласия с условиями использования, основанная на утверждении и проверке версии условий:

```
<ClaimsTransformations>
  <ClaimsTransformation Id="GetEmptyTermsOfUseConsentVersionForNewUser" TransformationMethod="CreateStringClaim">
    <InputParameters>
      <InputParameter Id="value" DataType="string" Value=""/>
    </InputParameters>
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="extension_termsOfUseConsentVersion" TransformationClaimType="createdClaim" />
    </OutputClaims>
  </ClaimsTransformation>
  <ClaimsTransformation Id="GetNewUserAgreeToTermsOfUseConsentVersion" TransformationMethod="CreateStringClaim">
    <InputParameters>
      <InputParameter Id="value" DataType="string" Value="V1"/>
    </InputParameters>
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="extension_termsOfUseConsentVersion" TransformationClaimType="createdClaim" />
    </OutputClaims>
  </ClaimsTransformation>
  <ClaimsTransformation Id="IsTermsOfUseConsentRequiredForVersion" TransformationMethod="CompareClaimToValue">
    <InputClaims>
      <InputClaim ClaimTypeReferenceId="extension_termsOfUseConsentVersion" TransformationClaimType="inputClaim1" />
    </InputClaims>
    <InputParameters>
      <InputParameter Id="compareTo" DataType="string" Value="V1" />
      <InputParameter Id="operator" DataType="string" Value="not equal" />
      <InputParameter Id="ignoreCase" DataType="string" Value="true" />
    </InputParameters>
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="termsOfUseConsentRequired" TransformationClaimType="outputClaim" />
    </OutputClaims>
  </ClaimsTransformation>
</ClaimsTransformations> 
```

## <a name="next-steps"></a>Дополнительная информация

- Узнайте, как правильно удалять и экспортировать данные пользователя, в [этой статье](manage-user-data.md).
