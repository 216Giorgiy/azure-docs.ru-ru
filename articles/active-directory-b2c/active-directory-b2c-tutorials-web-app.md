---
title: Руководство. Включение в веб-приложении аутентификации на основе учетных записей с помощью Azure Active Directory B2C | Документация Майкрософт
description: Руководство по предоставлению пользователю данных для входа в веб-приложение ASP.NET с помощью Azure Active Directory B2C.
services: active-directory-b2c
author: davidmu1
manager: daveba
ms.author: davidmu
ms.date: 11/30/2018
ms.custom: mvc
ms.topic: tutorial
ms.service: active-directory
ms.component: B2C
ms.openlocfilehash: 30a94cb5de2d618938f17c4e5733821ac7247785
ms.sourcegitcommit: 8115c7fa126ce9bf3e16415f275680f4486192c1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2019
ms.locfileid: "54851527"
---
# <a name="tutorial-enable-a-web-application-to-authenticate-with-accounts-using-azure-active-directory-b2c"></a>Руководство. Включение в веб-приложении аутентификации на основе учетных записей с помощью Azure Active Directory B2C

В этом руководстве описано использование Azure Active Directory (Azure AD) B2C для входа и регистрации пользователей в веб-приложении ASP.NET. Azure AD B2C позволяет приложениям выполнять проверку подлинности учетных записей социальных сетей, корпоративных учетных записей и учетных записей Azure Active Directory с помощью стандартных протоколов.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Зарегистрируйте пример веб-приложения ASP.NET в клиенте Azure AD B2C.
> * Создавайте потоки пользователей для регистрации пользователей, входа в систему, изменения профилей и сброса паролей.
> * Настройте пример веб-приложения для использования клиента Azure AD B2C. 

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

* Создайте свой собственный [клиент Azure AD B2C](active-directory-b2c-get-started.md).
* Установите [Visual Studio 2017](https://www.visualstudio.com/downloads/) с рабочей нагрузкой **ASP.NET и веб-разработка**.

## <a name="register-web-app"></a>Регистрация веб-приложения

Приложения должны быть [зарегистрированы](../active-directory/develop/developer-glossary.md#application-registration) в клиенте, чтобы иметь возможность получать [токены доступа](../active-directory/develop/developer-glossary.md#access-token) от Azure Active Directory. При регистрации приложения создается [идентификатор](../active-directory/develop/developer-glossary.md#application-id-client-id) для приложения в клиенте. 

Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора клиента Azure AD B2C.

[!INCLUDE [active-directory-b2c-switch-b2c-tenant](../../includes/active-directory-b2c-switch-b2c-tenant.md)]

1. Выберите **Все службы** в левом верхнем углу окна портала Azure, найдите службу **Azure AD B2C** и выберите ее. Нужно использовать клиент, созданный в рамках предыдущего руководства. 

2. В разделе параметров B2C щелкните **Приложения**, а затем — **Добавить**. 

    Чтобы зарегистрировать пример веб-приложения в клиенте, используйте следующие параметры.

    ![Добавление нового приложения](media/active-directory-b2c-tutorials-web-app/web-app-registration.png)
    
    | Параметр      | Рекомендуемое значение  | Описание                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Имя** | Пример веб-приложения | Введите **имя** приложения, которое будет описанием для пользователей. | 
    | **Включить веб-приложение или веб-интерфейс API** | Yes | Выберите **Да** для веб-приложения. |
    | **Разрешить неявный поток** | Yes | Выберите **Да**, так как приложение использует [вход в OpenID Connect](active-directory-b2c-reference-oidc.md). |
    | **URL-адрес ответа** | `https://localhost:44316` | URL-адреса ответа — это конечные точки, куда Azure AD B2C возвращает все токены, запрашиваемые вашим приложением. В этом руководстве пример выполняется локально (localhost) и прослушивает порт 44316. |
    | **Включить собственный клиент** | Нет  | Так как это веб-приложение, а не собственный клиент, выберите "Нет". |
    
3. Чтобы зарегистрировать приложение, щелкните **Создать**.

Зарегистрированные приложения отобразятся в списке приложений для клиента Azure AD B2C. Выберите веб-приложение в списке. Откроется панель свойств веб-приложения.

![Свойства веб-приложения](./media/active-directory-b2c-tutorials-web-app/b2c-web-app-properties.png)

Запишите значение **идентификатора приложения**. Идентификатор уникально идентифицирует приложение и необходим при настройке приложения далее в этом руководстве.

### <a name="create-a-client-password"></a>Создание пароля клиента

Azure AD B2C использует авторизацию OAuth2 для [клиентских приложений](../active-directory/develop/developer-glossary.md#client-application). Веб-приложения являются [конфиденциальными клиентами](../active-directory/develop/developer-glossary.md#web-client), поэтому для них требуется идентификатор клиента или приложения, а также секрет клиента, пароль клиента либо ключ приложения.

1. Выберите страницу ключей зарегистрированного веб-приложения и щелкните **Создать ключ**.

2. Щелкните **Сохранить**, чтобы отобразился ключ приложения.

    ![страница общих ключей приложения](media/active-directory-b2c-tutorials-web-app/app-general-keys-page.png)

На портале отобразится ключ. Скопируйте и сохраните значение ключа. Это значение требуется для настройки приложения. Ключ должен оставаться конфиденциальным. Не предоставляйте общий ключ другим пользователям.

## <a name="create-user-flows"></a>Создание потоков пользователей

Поток пользователя Azure AD B2C определяет пользовательский интерфейс для задачи идентификации. Например, распространенные потоки пользователей — это вход, регистрация, изменение паролей и профилей.

### <a name="create-a-sign-up-or-sign-in-user-flow"></a>Создание потока пользователя регистрации или входа в систему

Чтобы зарегистрировать пользователей для последующего входа в веб-приложение, создайте **поток пользователя регистрации или входа в систему**.

1. На странице портала Azure AD B2C выберите **Потоки пользователей** и щелкните **Создать поток пользователя**.
2. На вкладке **Recommended** (Рекомендуется) щелкните **Sign up and sign in** (Регистрация и вход).

    Чтобы настроить поток пользователя, используйте приведенные ниже параметры.

    ![Добавление потока пользователя регистрации или входа в систему](media/active-directory-b2c-tutorials-web-app/add-susi-user-flow.png)

    | Параметр      | Рекомендуемое значение  | Описание                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Имя** | SiUpIn | Введите **Имя** потока пользователя. Имя потока пользователя начинается с **b2c_1_**. В примере кода используйте полное имя потока пользователя **B2C_1_SiUpIn**. | 
    | **Поставщики удостоверений** | "Регистрация по электронной почте" | Поставщик удостоверений, используемый для идентификации пользователя. |

3. В разделе **Атрибуты пользователя и утверждения** щелкните **Показать еще** и выберите приведенные ниже параметры.

    ![Добавление потока пользователя регистрации или входа в систему](media/active-directory-b2c-tutorials-web-app/add-attributes-and-claims.png)

    | столбец      | Предлагаемые значения  | ОПИСАНИЕ                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Собрать атрибут** | "Отображаемое имя" и "Почтовый индекс" | Выберите атрибуты, получаемые от пользователя во время регистрации. |
    | **Вернуть утверждение** | "Отображаемое имя", "Почтовый индекс", User is new (Новый пользователь) и User's Object ID (Идентификатор объекта пользователя). | Выберите [утверждения](../active-directory/develop/developer-glossary.md#claim), которые следует включить в [маркер доступа](../active-directory/develop/developer-glossary.md#access-token). |

4. Последовательно выберите **ОК**.
5. Нажмите кнопку **Создать**, чтобы создать поток пользователя. 

### <a name="create-a-profile-editing-user-flow"></a>Создание потока пользователя изменения профиля

Чтобы пользователи могли самостоятельно сбросить сведения о своем профиле, создайте **поток пользователя редактирования профиля**.

1. На странице портала Azure AD B2C выберите **Потоки пользователей** и щелкните **Создать поток пользователя**.
2. На вкладке **Recommended** (Рекомендуется) щелкните **Profile editing** (Изменение профиля).

    Чтобы настроить поток пользователя, используйте приведенные ниже параметры.

    | Параметр      | Рекомендуемое значение  | Описание                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Имя** | SiPe | Введите **Имя** потока пользователя. Имя потока пользователя начинается с **b2c_1_**. В примере кода используйте полное имя потока пользователя **b2c_1_SiPe**. | 
    | **Поставщики удостоверений** | Локальная учетная запись для входа | Поставщик удостоверений, используемый для идентификации пользователя. |

3. В разделе **Атрибуты пользователя** щелкните **Показать еще** и выберите приведенные ниже параметры.

    | столбец      | Предлагаемые значения  | ОПИСАНИЕ                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Собрать атрибут** | "Отображаемое имя" и "Почтовый индекс" | Выберите атрибуты, которые пользователи смогут изменять во время редактирования профиля. |
    | **Вернуть утверждение** | "Отображаемое имя", "Почтовый индекс" и User's Object ID (Идентификатор объекта пользователя) | Выберите [утверждения](../active-directory/develop/developer-glossary.md#claim), которые следует включить в [маркер доступа](../active-directory/develop/developer-glossary.md#access-token) после редактирования профиля. |

4. Последовательно выберите **ОК**.
5. Нажмите кнопку **Создать**, чтобы создать поток пользователя. 

### <a name="create-a-password-reset-user-flow"></a>Создание потока пользователя сброса пароля

Чтобы обеспечить сброс паролей для приложения, необходимо создать **поток пользователя сброса паролей**. В этом потоке пользователя описываются действия, которые необходимо выполнить потребителям для сброса пароля, и содержимое маркеров, которые приложение должно получить при успешном завершении.

1. На странице портала Azure AD B2C выберите **Политики сброса пароля**, а затем щелкните **Добавить**.
2. На вкладке **Recommended** (Рекомендуется) щелкните **Password reset** (Сброс пароля).

    Чтобы настроить поток пользователя, используйте приведенные ниже параметры.

    | Параметр      | Рекомендуемое значение  | Описание                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Имя** | SSPR | Введите **Имя** потока пользователя. Имя потока пользователя начинается с **b2c_1_**. В примере кода используйте полное имя потока пользователя **b2c_1_SSPR**. | 
    | **Поставщики удостоверений** | Reset password using email address (Сброс пароля с использованием адреса электронной почты) | Поставщик удостоверений, используемый для идентификации пользователя. |

3. В разделе **Утверждения приложения** щелкните **Показать еще** и выберите приведенные ниже параметры.
    | столбец      | Рекомендуемое значение  | ОПИСАНИЕ                                        |
    | ------------ | ------- | -------------------------------------------------- |
    | **Вернуть утверждение** | User's Object ID (Идентификатор объекта пользователя) | Выберите [утверждения](../active-directory/develop/developer-glossary.md#claim), которые следует включить в [маркер доступа](../active-directory/develop/developer-glossary.md#access-token) после сброса пароля. |

4. Последовательно выберите **ОК**.
5. Нажмите кнопку **Создать**, чтобы создать поток пользователя. 

## <a name="update-web-app-code"></a>Обновление кода веб-приложения

После регистрации веб-приложения и создания потоков пользователей необходимо настроить приложение для использования клиента Azure AD B2C. С помощью этого руководства вы настроите пример веб-приложения, который можно скачать из репозитория GitHub. 

[Загрузите ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-dotnet-webapp-and-webapi/archive/master.zip) или клонируйте пример приложения с GitHub. Убедитесь, что вы извлекаете пример файла в папку, общая длина пути к которой меньше 260 символов.

```
git clone https://github.com/Azure-Samples/active-directory-b2c-dotnet-webapp-and-webapi.git
```

Пример веб-приложения ASP.NET представляет собой простое приложение для создания и обновления списка задач. Приложение использует [компоненты ПО промежуточного слоя Microsoft OWIN](https://docs.microsoft.com/aspnet/aspnet/overview/owin-and-katana/), которые позволяют пользователям регистрироваться для использования приложения в клиенте Azure AD B2C. Создав поток пользователя Azure AD B2C, пользователи могут использовать учетную запись социальной сети или создать учетную запись для использования в качестве идентификатора для доступа к приложению. 

Пример решения состоит из двух проектов.

**Пример веб-приложения (TaskWebApp):** веб-приложение для создания и изменения списка задач. Веб-приложение использует поток пользователя **регистрации или входа** для регистрации пользователей или входа в систему.

**Пример приложения веб-API (TaskService):** веб-API, поддерживающий функции создания, чтения, обновления и удаления списка задач. Веб-API защищен с помощью Azure AD B2C и вызывается веб-приложением.

Для использования регистрации приложения в клиенте необходимо изменить настройки приложения, в частности идентификатор приложения и ключ, записанные ранее. Кроме того, необходимо также настроить созданные потоки пользователя. Пример веб-приложения определяет значения конфигурации, такие как параметры приложения, в файле Web.config. Чтобы изменить параметры приложения:

1. Откройте решение **B2C-WebAPI-DotNet** в Visual Studio.

2. В проекте веб-приложения **TaskWebApp** откройте файл **Web.config**. Замените значение `ida:Tenant` именем клиента, которого вы создали. Замените значение `ida:ClientId` идентификатором приложения, которого вы записали. Замените значение `ida:ClientSecret` ключом, который вы записали.

3. В файле **Web.config** замените значение для `ida:SignUpSignInPolicyId` значением `b2c_1_SiUpIn`. Замените значение для `ida:EditProfilePolicyId` значением `b2c_1_SiPe`. Замените значение для `ida:ResetPasswordPolicyId` значением `b2c_1_SSPR`.

## <a name="run-the-sample-web-app"></a>Запуск примера веб-приложения

В обозревателе решений щелкните правой кнопкой мыши проект **TaskWebApp** и выберите **Назначить автозагружаемым проектом**.

Нажмите клавишу **F5** для запуска веб-приложения. Запустится браузер по умолчанию, и откроется адрес локального веб-сайта `https://localhost:44316/`. 

Пример приложения поддерживает регистрацию пользователей, вход в систему, редактирование профилей и сброс паролей. В этом руководстве показан процесс регистрации пользователя в приложении с помощью адреса электронной почты. Вы можете попытаться выполнить другие сценарии самостоятельно.

### <a name="sign-up-using-an-email-address"></a>Регистрация с помощью адреса электронной почты

1. Щелкните ссылку **Вход в службу или регистрация** в верхнем заголовке, чтобы зарегистрироваться как пользователь веб-приложения. В этом случае используется поток пользователя **b2c_1_SiUpIn**, определенный на предыдущем шаге.

2. Появляется страница входа в Azure AD B2C со ссылкой для регистрации. Щелкните ссылку **Зарегистрироваться сейчас**, так как у вас нет учетной записи. 

3. В рамках рабочего процесса регистрации появляется страница для сбора данных и проверки личности пользователя с использованием адреса электронной почты. Рабочий процесс регистрации также собирает пароль пользователя и запрашиваемые атрибуты, определенные в потоке пользователя.

    Используйте действительный адрес электронной почты и подтвердите его с помощью кода проверки. Задайте пароль. Введите значения запрашиваемых атрибутов. 

    ![Рабочий процесс регистрации](media/active-directory-b2c-tutorials-web-app/sign-up-workflow.png)

4. Щелкните **Создать**, чтобы создать локальную учетную запись в клиенте Azure AD B2C.

Теперь пользователь может использовать свой адрес электронной почты для входа в веб-приложение и работы с ним.

## <a name="clean-up-resources"></a>Очистка ресурсов

Вы можете использовать ваш клиент Azure AD B2C при работе с другими руководствами по Azure AD B2C. [Удалите клиент Azure AD B2C](active-directory-b2c-faqs.md#how-do-i-delete-my-azure-ad-b2c-tenant), если он больше не нужен.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как создать клиента Azure AD B2C, потоки пользователя и обновить пример веб-приложения для использования вашего клиента Azure AD B2C. Перейдите к следующему руководству, чтобы узнать, как регистрировать, настраивать и вызывать веб-приложение ASP.NET, защищенное с помощью клиента Azure AD B2C.

> [!div class="nextstepaction"]
> [Руководство по использованию Azure Active Directory B2C для защиты веб-API ASP.NET](active-directory-b2c-tutorials-web-api.md)
