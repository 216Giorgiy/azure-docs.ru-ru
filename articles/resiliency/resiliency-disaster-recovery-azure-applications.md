---
title: "Аварийное восстановление для приложений Azure | Документация Майкрософт"
description: "Технический обзор и подробные сведения о разработке приложений c аварийным восстановлением на платформе Microsoft Azure."
services: 
documentationcenter: na
author: adamglick
manager: saladki
editor: 
ms.assetid: f9e0cbdc-ec82-46dc-bee6-558b35518252
ms.service: resiliency
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2016
ms.author: aglick
translationtype: Human Translation
ms.sourcegitcommit: 0c23ee550d8ac88994e8c7c54a33d348ffc24372
ms.openlocfilehash: d0ea8137dcdd72cf09806006bdca4c24d6f1c1de
ms.lasthandoff: 02/11/2017


---
# <a name="disaster-recovery-for-applications-built-on-microsoft-azure"></a>Аварийное восстановление для приложений на платформе Microsoft Azure
Высокая доступность используется при управлении временными сбоями, а аварийное восстановление — при необратимых сбоях в работе приложений. Например, рассмотрим ситуацию, когда в регионе происходит сбой. В этом случае необходимо составить план для запуска приложения или доступа к данным за пределами региона Azure. Для выполнения этого плана нужны специалисты, процессы и вспомогательные приложения, которые обеспечат работу системы. Владельцы предприятий и технических решений, которые определяют режим работы системы при сбое, также задают уровень функционирования службы во время сбоя. Есть несколько уровней функционирования при сбое: полная недоступность, частичная недоступность (ограниченная функциональность или задержка при обработке) или полная доступность.

## <a name="azure-disaster-recovery-features"></a>Функции аварийного восстановления Azure
Как и в случае с доступностью, составлено [техническое руководство по обеспечению устойчивости](resiliency-technical-guidance.md) для Azure, которое позволяет решить проблемы при аварийном восстановлении. Кроме того, некоторые функции доступности и аварийного восстановления Azure связаны между собой. Например, управление ролями в доменах сбоя повышает доступность приложения. Без такого вида управления необработанный сбой оборудования стал бы аварийным сценарием. Поэтому правильное применение функций и стратегий по обеспечению доступности — важная часть защиты приложения от сбоев. Однако в этой статье описываются не общие проблемы с доступностью, а более серьезные (и редкие) ситуации.

## <a name="multiple-datacenter-regions"></a>Несколько регионов центра обработки данных
Azure обслуживает центры обработки данных во множестве регионов по всему миру. В этой инфраструктуре поддерживается ряд сценариев аварийного восстановления, например системная георепликация службы хранилища Azure в дополнительные регионы. Это также означает, что можно легко и экономично развернуть облачную службу в нескольких местах по всему миру. Сравните эти преимущества с затратами, требуемыми для работы центров обработки данных в нескольких регионах, а также учтите сложность выполнения этой задачи. Развертывая данные и службы в нескольких регионах, вы уберегаете свое приложение от последствий серьезных сбоев в одном регионе.

## <a name="azure-traffic-manager"></a>Azure Traffic Manager
При сбое в одном регионе следует перенаправить трафик в службы или развертывания в другом регионе. Это можно сделать вручную, но гораздо эффективнее автоматизировать этот процесс. Именно для этого предназначен диспетчер трафика Azure. Он позволяет автоматически управлять переключением пользовательского трафика на другой регион при сбое основного региона. Так как управление трафиком — важная часть общей стратегии, необходимо понимать основные принципы работы диспетчера трафика.

На схеме ниже пользователи подключаются к URL-адресу, указанному для диспетчера трафика (**http://myATMURL.trafficmanager.net**), который абстрагирует действительные URL-адреса веб-сайта (**http://app1URL.cloudapp.net** и **http://app2URL.cloudapp.net**). В зависимости от настроенных критериев маршрутизации пользователи будут направляться на соответствующий фактический сайт согласно настройкам политики. Политика предусматривает циклический перебор, учет производительности или отработку отказа. Согласно целям этой статьи мы уделим основное внимание отработке отказа.

![Маршрутизация с помощью диспетчера трафика Azure](./media/resiliency-disaster-recovery-azure-applications/routing-using-azure-traffic-manager.png)

При настройке диспетчера трафика следует указать новый префикс DNS для диспетчера трафика. Это префикс URL-адреса, с помощью которого пользователи будут получать доступ к службе. Теперь диспетчер трафика абстрагирует балансировку нагрузки не на уровне региона, а на более высоком уровне. Служба DNS диспетчера трафика выполняет сопоставление с записью CNAME для всех развертываний, которыми она управляет.

В диспетчере трафика указывается приоритет развертываний, на которые будут направляться пользователи при сбое. Диспетчер трафика выполняет мониторинг конечных точек развертываний и выявляет сбои основного развертывания. При сбое диспетчер трафика анализирует упорядоченный по приоритету список развертываний и направляет пользователей к следующему развертыванию в списке.

Хотя диспетчер трафика и выбирает расположение для перехода при отработке отказа, вы можете решить, каким будет домен для отработки отказа в других режимах: активным или неактивным. Диспетчер трафика Azure не отвечает за эту задачу. Диспетчер трафика обнаруживает сбой на основном сайте и переключается на сайт для отработки отказа. Переключение выполняется независимо от активности сайта в настоящее время.

Дополнительные сведения о том, как работает диспетчер трафика Azure, можно найти в следующих статьях:

* [Обзор диспетчера трафика](../traffic-manager/traffic-manager-overview.md)
* [Настройка метода маршрутизации с отработкой отказа](../traffic-manager/traffic-manager-configure-failover-routing-method.md)

## <a name="azure-disaster-scenarios"></a>Сценарии сбоев в Azure
В следующих разделах описаны различные типы аварийных сценариев. Нарушения работы служб на уровне региона — не единственная причина сбоев на уровне приложения. Сбои также могут влечь неэффективность архитектуры или ошибки администрирования. Важно учитывать возможные причины сбоя во время разработки и тестирования плана восстановления. План можно считать хорошим, если в нем задействуются возможности Azure, которые дополняются стратегиями для конкретных приложений. Выбор зависит от важности приложения, целевой точки восстановления (RPO) и целевого времени восстановления (RTO).

### <a name="application-failure"></a>Сбой приложения
Диспетчер трафика Azure автоматически обрабатывает сбои, возникающие в базовом оборудовании или программном обеспечении операционной системы на виртуальной машине узла. Azure создает экземпляр роли на работающем сервере и добавляет его в балансировщик нагрузки. При наличии нескольких экземпляров роли Azure перемещает обработку на другие работающие экземпляры роли и заменяет узел, на котором произошел сбой.

Существуют серьезные ошибки приложений, которые возникают независимо от сбоев оборудования или операционной системы. Сбой приложения может произойти из-за критических исключений, возникших из-за проблем логики или целостности данных. Необходимо добавить в код достаточно данных телеметрии, чтобы система мониторинга могла обнаружить условия возникновения ошибки и уведомить администратора приложения. Администратор, который знает все о процессах аварийного восстановления, может инициировать отработку отказа. Кроме того, он может просто подтвердить сбой доступности, чтобы устранить критические ошибки.

### <a name="data-corruption"></a>Повреждение данных
Azure автоматически сохраняет данные базы данных SQL Azure и службы хранилища Azure в трех избыточных экземплярах в различных доменах сбоя в одном регионе. При использовании георепликации создаются еще три экземпляра данных в другом регионе. Но если пользователи или приложение повреждают данные в основной копии, происходит быстрая репликация с использованием других копий. К сожалению, в результате вы получаете три копии поврежденных данных.

Существует два варианта управления возможным повреждением данных. Во-первых, можно использовать управление пользовательской стратегией архивации. В зависимости от бизнес-требований или нормативных требований резервные копии можно хранить в Azure или локально. Во-вторых, при восстановлении базы данных SQL можно использовать новую возможность восстановления до точки во времени. Дополнительные сведения см. в разделе о [стратегиях аварийного восстановления данных](#data-strategies-for-disaster-recovery).

### <a name="network-outage"></a>Сбой сети
Если части сети Azure недоступны, возможно, вы не сможете получить доступ к данным или приложениям. Если один или несколько экземпляров роли недоступны из-за проблем с сетью, Azure использует остальные доступные экземпляры приложения. Если приложение не может получить доступ к своим данным из-за сбоя сети Azure, можно работать в ограниченном режиме локально, используя кэшированные данные. Необходимо разработать стратегию аварийного восстановления для работы в приложении в ограниченном режиме. Для некоторых приложений это может оказаться непрактично.

Кроме того, можно хранить данные в другом расположении до восстановления подключения. Если невозможно работать в ограниченном режиме, остается только простой приложения или переключение на альтернативный регион. Разработка приложения, работающего в ограниченном режиме — сложная задача как с коммерческой, так и с технической точки зрения. Это описано далее в разделе о [работе приложения в ограниченном режиме](#degraded-application-functionality).

### <a name="failure-of-a-dependent-service"></a>Сбой зависимой службы
В Azure доступно множество служб, каждая из которых периодически может становиться недоступной. Рассмотрим [кэш Redis для Azure](https://azure.microsoft.com/services/cache/) в качестве примера. Эта мультитенантная служба предоставляет возможности кэширования для приложения. Важно учитывать, что происходит в приложении, если зависимая служба недоступна. Во многом этот сценарий похож на сценарий сбоя сети. Тем не менее, оценивая каждую службу по отдельности, можно добиться улучшений в общем.

Кэш Redis для Azure обеспечивает кэширование для приложения в развертывании облачной службы, предоставляя преимущества аварийного восстановления. Во-первых, теперь служба использует локальные роли развертывания. Это позволяет более эффективно контролировать состояние кэша и проводить его мониторинг в рамках общего управления облачной службой. С этим типом кэширования также стали доступны новые возможности. Одна из них — обеспечение высокой доступности для кэшированных данных. Это позволяет сохранить кэшированные данные при сбое одного узла за счет хранения нескольких копий на других узлах.

Обратите внимание, что при высоком уровне доступности уменьшается пропускная способность и увеличивается время задержки из-за обновления дополнительной копии при операциях записи. Кроме того, стоит учитывать, что для каждого элемента используется вдвое больше памяти. В этом конкретном примере показано, что каждая зависимая служба может предоставлять возможности, позволяющие повысить общий уровень доступности и устойчивости к критическим сбоям.

Необходимо осознавать последствия сбоя каждой зависимой службы. В этом примере кэширования доступ к данным можно получить прямо из базы данных до восстановления кэша. С точки зрения производительности это был бы ограниченный режим, но данные в этом случае были бы полностью доступны.

### <a name="region-wide-service-disruption"></a>Нарушение работы служб на уровне региона
С предыдущими сбоями можно справиться в одном регионе Azure. Тем не менее следует также подготовиться к прерыванию работы службы во всем регионе. В таком случае локальные избыточные копии данных недоступны. Если георепликация включена, в другом регионе есть три дополнительные копии больших двоичных объектов и таблиц. Если Майкрософт объявит, что связь с регионом утеряна, Azure повторно сопоставит все записи DNS в регионе с георепликацией.

> [!NOTE]
> Учтите, что этот процесс нельзя контролировать и он выполняется только при нарушении работы службы на уровне региона. Поэтому для обеспечения самого высокого уровня доступности необходимо использовать и другие стратегии архивации приложения. Дополнительные сведения см. в разделе о [стратегиях аварийного восстановления данных](#data-strategies-for-disaster-recovery).
> 
> 

### <a name="azure-wide-service-disruption"></a>Нарушение работы служб на уровне среды Azure
При планировании аварийного восстановления необходимо учитывать весь диапазон возможных аварий. Самым серьезным нарушением работы служб считается ситуация, когда это произошло во всех регионах Azure одновременно. Как и в других сценариях нарушения работы служб, в этом случае можно принять риск временного простоя. Крупномасштабные нарушения работы служб, охватывающие регионы, должны случаться гораздо реже, чем изолированные нарушения, охватывающие зависимые службы или один регион.

Тем не менее для некоторых критически важных приложений на такой случай можно также составить план архивации. Такой план может предусматривать переключение на службы в [альтернативных облаках](#alternative-cloud) или [гибридных локальных и облачных решениях](#hybrid-on-premises-and-cloud-solution).

### <a name="degraded-application-functionality"></a>работе приложения в ограниченном режиме
В правильно спроектированных приложениях обычно используется коллекция модулей, взаимодействующих друг с другом за счет реализации шаблонов обмена сведениями, которые слабо связаны между собой. Разделять задачи на уровне модуля необходимо для приложений, поддерживающих аварийное восстановление. Это необходимо для предотвращения нарушения работы всего приложения при нарушении работы зависимой службы. Например, рассмотрим приложение электронной торговли для компании Y. Оно может состоять из следующих модулей:

* **Каталог продуктов**. Здесь пользователи могут просматривать продукты.
* **Корзина**. Пользователи могут добавлять в корзину продукты и удалять их из нее.
* **Состояние заказа**. Состояние доставки заказов пользователей.
* **Отправка заказа**. Завершение сеанса покупок путем отправки заказа с оплатой.
* **Обработка заказа**. На этом этапе проверяется целостность данных заказа и выполняется проверка наличия товаров.

Если зависимый компонент модуля в этом приложении перестает работать, то как работает модуль до восстановления работы компонента? В системе с хорошо продуманной архитектурой внедряются изоляционные границы в виде разделения задач во время разработки и выполнения. Каждую ошибку можно классифицировать как устранимую или неустранимую. Неустранимые ошибки приводят к сбою модуля. Но риска устранимой ошибки можно избежать, применив альтернативные варианты. Как описано в разделе о высокой доступности, некоторые проблемы можно скрыть от пользователей, устранив неполадки и приняв альтернативные меры. При серьезных нарушениях в работе службы приложение может быть полностью недоступно. Тем не менее есть и третий вариант — продолжить обслуживание пользователей в ограниченном режиме.

Например, при сбое в базе данных для размещения заказов в модуле обработки заказов утрачивается возможность обработки транзакций продаж. В зависимости от архитектуры такие модули приложения, как отправки и обработки заказа, не смогут работать или наладить их работу будет очень сложно. Если в приложении не предусмотрен такой сценарий, оно может перейти в автономный режим работы.

Тем не менее в этом сценарии данные продуктов могут храниться в другом расположении. В таком случае модуль каталога продуктов можно по-прежнему использовать для просмотра продуктов. В ограниченном режиме некоторые возможности приложения остаются доступными для пользователей, например просмотр каталога продуктов. Тем не менее другие элементы приложения недоступны, например заказ или запрос наличия продуктов.

В другом варианте ограниченного режима основное внимание уделяется производительности, а не возможностям. Например, рассмотрим сценарий, в котором каталог продуктов кэшируется с помощью кэша Redis для Azure. Если кэширование становится недоступным, приложение может получать сведения каталога продуктов прямо из хранилища сервера. Но на это уходит больше времени, чем в кэшированной версии. Поэтому производительность приложения снижается до полного восстановления службы кэша.

Решение о том, какая часть приложения будет продолжать работать в ограниченном режиме, зависит от бизнес-требований и технических требований. Кроме того, необходимо определить, как приложение будет информировать пользователей о временных проблемах. В этом примере в приложении можно просматривать продукты и добавлять их в корзину. Тем не менее, если пользователь попытается совершить покупку, он получит уведомление о том, что модуль продаж временно недоступен. Это не лучший вариант для клиентов, но так можно предотвратить прерывание работы службы на уровне приложения.

## <a name="data-strategies-for-disaster-recovery"></a>Стратегии аварийного восстановления для данных
Самая сложная часть в любом плане аварийного восстановления — это правильная обработка данных. Кроме того, при восстановлении в общем больше всего времени занимает восстановление данных. При выборе любого варианта работы в ограниченном режиме возникают трудности восстановления данных и обеспечения согласованности после сбоя.

Одним из факторов является необходимость восстановления или сохранения копии данных приложения. Эти данные будут использоваться для ссылок и транзакций на дополнительном сайте. Реализация стратегии аварийного восстановления для нескольких регионов в локальной среде требует дорогостоящего и длительного планирования. К счастью, большинство поставщиков облачных услуг, в том числе Azure, позволяют развертывать приложения в различных регионах. Эти регионы так географически распределены, чтобы нарушение работы службы в нескольких регионах случалось крайне редко. Стратегия обработки данных в разных регионах является одним из ключевых факторов успешного выполнения любого плана аварийного восстановления.

В следующих разделах рассматриваются методы аварийного восстановления, связанные с архивированием данных, а также ссылочными данными и данными о транзакциях.

### <a name="backup-and-restore"></a>Архивация и восстановление
При регулярной архивации данных приложения могут поддерживаться некоторые сценарии аварийного восстановления. Для различных ресурсов хранения требуются разные методы.

Для восстановления уровней базы данных SQL (цен. категория "Базовый", "Стандартный" и "Премиум") преимущества предоставляет восстановление до точки во времени. Дополнительные сведения см. в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](../sql-database/sql-database-business-continuity.md). Кроме того, можно использовать активную георепликацию для базы данных SQL. При этом изменения базы данных автоматически реплицируются в базы данных-получатели в том же или даже в другом регионе Azure. Такой вариант представляет собой потенциальную альтернативу некоторым методам синхронизации данных вручную, представленных в этой статье. Дополнительные сведения см. в статье [Обзор: активная георепликация для базы данных SQL](../sql-database/sql-database-geo-replication-overview.md).

При архивации и восстановлении также можно использовать подход, предусматривающий больше ручных действий. Используйте команду DATABASE COPY, чтобы создать копию базы данных. Эта команда позволяет создать резервную копию с согласованными транзакциями. Вы также можете использовать службы импорта и экспорта Базы данных SQL Azure. Они поддерживают экспорт баз данных в файлы BACPAC, которые хранятся в хранилище BLOB-объектов Azure.

Благодаря встроенной избыточности службы хранилища Azure в одном регионе создается две реплики файла резервной копии. Тем не менее от частоты архивации зависит RPO, т. е. объем данных, которые можно потерять при сбое. Например, представьте, что архивация выполняется в начале часа, а сбой происходит за две минуты до начала часа. В этом случае будут утеряны данные, созданные за 58 минут с момента последней архивации. Кроме того, чтобы обеспечить защиту на случай нарушения работы службы на уровне региона, необходимо скопировать файлы BACPAC в другой регион. Затем вы сможете восстановить эти резервные копии в другом регионе. Дополнительные сведения см. в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](../sql-database/sql-database-business-continuity.md).

Для службы хранилища Azure можно разработать свой настраиваемый процесс архивации или использовать одно из множества средств архивации сторонних поставщиков. Обратите внимание, что в большинстве приложений возникают дополнительные сложности, если ресурсы хранения ссылаются друг на друга. Например, рассмотрим базу данных SQL, в которой есть столбец, ссылающийся на большой двоичный объект в службе хранилища Azure. Если архивация всех элементов не осуществляется одновременно, в базе данных может содержаться указатель на большой двоичный объект, для которого до сбоя не создана резервная копия. Приложение или план аварийного восстановления должны реализовать процессы для обработки этой несогласованности после восстановления.

### <a name="reference-data-pattern-for-disaster-recovery"></a>Шаблон ссылочных данных для аварийного восстановления
Ссылочные данные — это данные только для чтения, которые поддерживают функциональные возможности приложения. Обычно они редко изменяются. Хотя архивация и восстановление представляют один из методов устранения нарушений в работе служб на уровне региона, целевое время восстановления при этом относительно велико. При развертывании приложения в дополнительном регионе можно применить несколько стратегий, которые позволяют добиться малого целевого времени восстановления для ссылочных данных.

Так как ссылочные данные изменяются редко, целевое время восстановления можно уменьшить, создав постоянную копию ссылочных данных в дополнительном регионе. Это уменьшает количество времени, необходимое на восстановление из резервных копий в случае сбоя. В соответствии с требованиями к аварийному восстановлению после сбоев в нескольких регионах необходимо развернуть приложение и ссылочные данные одновременно во всех них. Как указано в разделе [Шаблон ссылочных данных для обеспечения высокой доступности](resiliency-high-availability-azure-applications.md#reference-data-pattern-for-high-availability), ссылочные данные можно развернуть в роли, во внешнем хранилище или и там, и там.

Модель развертывания ссылочных данных на вычислительных узлах неявно удовлетворяет требованиям аварийного восстановления. При развертывании ссылочных данных в базе данных SQL необходимо развернуть их копию в каждом регионе. Та же стратегия применяется к службе хранилища Azure. Необходимо развернуть копию всех ссылочных данных в службе хранилища Azure в основном и дополнительном регионах.

![Публикация ссылочных данных в основном и дополнительном регионах](./media/resiliency-disaster-recovery-azure-applications/reference-data-publication-to-both-primary-and-secondary-regions.png)

Для всех данных, в том числе ссылочных, необходимо реализовать свои процессы архивации в зависимости от приложения. Геореплицированные копии в регионах используются только при нарушении работы служб на уровне региона. Чтобы предотвратить длительные простои, разверните критически важные компоненты данных приложения в дополнительном регионе. Пример этой топологии см. в разделе о [модели "активный — пассивный"](#active-passive).

### <a name="transactional-data-pattern-for-disaster-recovery"></a>Шаблон данных о транзакциях для аварийного восстановления
Реализация полнофункциональной стратегии режима аварийного восстановления требует асинхронной репликации данных о транзакциях в дополнительный регион. Фактический период репликации будет служить для определения характеристик RPO приложения. В течение этого периода все еще можно восстановить данные, утерянные из основного региона. Кроме того, позже можно будет объединить эти данные с данными дополнительного региона.

В следующих примерах архитектуры представлены идеи в отношении различных способов обработки данных о транзакциях при отработке отказа. Важно отметить, что они не являются исчерпывающими. Например, промежуточные места хранения, такие как очереди, можно заменить Базой данных SQL Azure. Это могут быть очереди службы хранилища Azure или служебной шины Azure (см. статью [Очереди Azure и очереди служебной шины: сходства и различия](../service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)). Кроме того, можно использовать разные хранилища серверов, например таблицы Azure вместо базы данных SQL. Помимо этого на различных этапах в качестве посредников могут добавляться рабочие роли. Важно не моделировать эти архитектуры, а учесть различные варианты восстановления данных о транзакциях и связанных модулей.

#### <a name="replication-of-transactional-data-in-preparation-for-disaster-recovery"></a>Репликация данных о транзакциях при подготовке к аварийному восстановлению
Рассмотрим приложение, в котором данные о транзакциях хранятся в очередях службы хранилища Azure. В этом сценарии рабочие роли могут обрабатывать данные о транзакциях в базе данных сервера в несвязанной архитектуре. Если внутренним ролям необходимо немедленно запрашивать эти данные, транзакции должны использовать временное кэширование. В зависимости от допустимого уровня потери данных можно реплицировать очереди, базу данных или все ресурсы хранения. Если реплицируется только база данных, при сбое основного региона данные в очередях можно по-прежнему восстановить после восстановлении работы основного региона.

На следующей схеме показана архитектура, где базы данных сервера синхронизируются в разных регионах.

![Репликация данных о транзакциях при подготовке к аварийному восстановлению](./media/resiliency-disaster-recovery-azure-applications/replicate-transactional-data-in-preparation-for-disaster-recovery.png)

Самой большой сложностью при реализации этой архитектуры является разработка стратегии репликации между регионами. Служба синхронизации данных SQL Azure позволяет выполнить такую репликацию. Тем не менее эта служба доступна в предварительной версии и не рекомендуется для использования в рабочей среде. Дополнительные сведения см. в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](../sql-database/sql-database-business-continuity.md). Для рабочих приложений необходимо приобрести решение стороннего поставщика или создать собственную логику репликации в коде. В зависимости от архитектуры репликация может быть двунаправленной. Такая репликация является более сложной.

В одном из возможных способов реализации можно использовать промежуточную очередь из предыдущего примера. Рабочая роль, обрабатывающая данные в конечном хранилище, может вносить изменения в основном и дополнительном регионе. Это непростые задачи. Полное руководство по написанию кода репликации выходит за рамки этой статьи. Важно то, что способу репликации данных в дополнительный регион следует уделять больше всего внимания. Чтобы убедиться, что при отработке отказа и восстановлении все возможные несоответствия данных или повторяющиеся транзакции обрабатываются правильно, можно провести дополнительную обработку и тестирование.

> [!NOTE]
> Основная часть этого документа посвящена модели "платформа как услуга" (PaaS). Однако существуют дополнительные варианты репликации и обеспечения доступности для гибридных приложений, использующих виртуальные машины Azure. В этих гибридных приложениях для размещения SQL Server на виртуальных машинах в Azure используется модель "инфраструктура как услуга" (IaaS). Это позволяет использовать традиционные подходы к обеспечению доступности в SQL Server, например группы доступности AlwaysOn и доставку журналов. Некоторые методы, например AlwaysOn, работают только между локальными экземплярами SQL Server и виртуальными машинами Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md).
> 
> 

#### <a name="degraded-application-mode-for-transaction-capture"></a>Ограниченный режим приложения для записи транзакций
Рассмотрим вторую архитектуру, которая работает в ограниченном режиме. В приложении в дополнительном регионе отключаются все возможности, например отчетность, бизнес-аналитика или освобождение очередей. Оно принимает только самые важные типы транзакционных рабочих процессов в соответствии с бизнес-требованиями. Система фиксирует транзакции и записывает их в очереди. На начальной стадии нарушения работы службы система может отложить обработку данных. Если система в основном регионе восстанавливается в течение ожидаемого времени, рабочие роли в этом регионе могут освободить очереди. В результате не нужно объединять базы данных. Если нарушение работы службы основного региона выходит за рамки допустимого периода, приложение может начать обработку очередей.

В этом сценарии база данных в дополнительном регионе содержит добавочные данные о транзакциях, которые необходимо объединить после восстановления основного региона. На следующей схеме показана эта стратегия для временного хранения данных о транзакциях до восстановления основного региона.

![Ограниченный режим приложения для записи транзакций](./media/resiliency-disaster-recovery-azure-applications/degraded-application-mode-for-transaction-capture.png)

Дополнительные сведения о методах управления данными для устойчивых приложений Azure см. на странице [FailSafe: Building Scalable, Resilient Cloud Services](https://channel9.msdn.com/Series/FailSafe) (Отказоустойчивость. Создание устойчивых облачных служб).

## <a name="deployment-topologies-for-disaster-recovery"></a>Топологии развертывания для аварийного восстановления
Критически важные приложения нужно подготовить к возможному нарушению работы службы на уровне региона. Для этого необходимо внедрить стратегию развертывания в нескольких регионах в операционное планирование.

При развертывании в нескольких регионах ИТ-специалистам может понадобиться опубликовать приложение и ссылочные данные в дополнительном регионе после сбоя. Если приложение требует мгновенной отработки отказа, развертывание может включать настройку "активный — пассивный" или "активный — активный". Этот тип развертывания предусматривает существующие экземпляры приложения, работающие в другом регионе. Средство маршрутизации, например диспетчер трафика Azure, предоставляет службы балансировки нагрузки на уровне DNS. Оно может определить нарушения в работе службы и при необходимости перенаправить пользователей в другие регионы.

Для успешного аварийного восстановления Azure необходимо с самого начала внедрить возможность такого восстановления в решение. В облаке предусмотрены дополнительные варианты аварийного восстановления после сбоев, недоступные у традиционных поставщиков услуг размещения. В частности, можно динамически и быстро выделить ресурсы в другой регион. Таким образом вы не будете тратить много средств на неиспользуемые ресурсы, опасаясь, что произойдет сбой.

В следующих разделах рассматриваются различные топологии развертывания для аварийного восстановления. Как правило, при повышении уровня доступности необходимо идти на компромисс между увеличением затрат или сложности.

### <a name="single-region-deployment"></a>Развертывание в одном регионе
На самом деле развертывание в одном регионе не является топологией аварийного восстановления. Оно рассматривается в качестве противопоставления другим архитектурам. Развертывание в одном регионе часто используется для приложений в Azure. Однако такое развертывание не является серьезным шагом для включения в план аварийного восстановления.

На следующей схеме показано приложение, работающее в одном регионе Azure. Диспетчер трафика Azure, а также использование доменов сбоя и обновления повышают уровень доступности приложения в пределах региона.

![Развертывание в одном регионе](./media/resiliency-disaster-recovery-azure-applications/single-region-deployment.png)

В этом сценарии видно, что база данных является единой точкой отказа. Несмотря на то, что Azure реплицирует данные разных доменов сбоя во внутренние реплики, все это происходит в одном регионе. Приложение не может выдержать разрушительный сбой. При сбое региона отключаются все домены сбоя, в том числе все экземпляры службы и ресурсы хранения.

Для всех приложений, кроме наименее важных, необходимо создать план развертывания в нескольких регионах. При выборе используемой топологии необходимо также учитывать целевое время восстановления и ограничения бюджета.

Теперь давайте рассмотрим конкретные шаблоны для поддержки отработки отказа в разных регионах. В этих примерах для описания процесса используются два региона.

### <a name="redeployment-to-a-secondary-azure-region"></a>Повторное развертывание в дополнительном регионе Azure
При повторном развертывании в дополнительном регионе приложения и базы данных содержатся только в основном регионе. Дополнительный регион не настроен для автоматической отработки отказа. Поэтому при сбое все компоненты службы необходимо развернуть в новом регионе. При этом нужно добавить облачную службу в Azure, развернуть облачную службу, восстановить данные и изменить DNS для перенаправления трафика.

Хотя это и самый доступный вариант для нескольких регионов, он предполагает максимальное целевое время восстановления. В этой модели резервные копии пакета службы и базы данных сохраняются локально или в экземпляре хранилища BLOB-объектов Azure в дополнительном регионе. Тем не менее до возобновления работы нужно развернуть новую службу и восстановить данные. Даже если полностью автоматизировать передачу данных из хранилища резервных копий, развертывание новой среды базы данных занимает много времени. Перенос данных из дискового хранилища резервных копий в пустую базу данных в дополнительном регионе — самый дорогостоящий этап восстановления. Тем не менее его нужно выполнить, чтобы запустить новую базу данных, так как она не реплицируется.

Лучше всего хранить пакеты службы в хранилище BLOB-объектов в дополнительном регионе. Это устраняет необходимость передавать пакет в Azure, что происходит при развертывании из локального компьютера разработки. Вы можете быстро развернуть пакеты службы в новой облачной службе из хранилища BLOB-объектов, используя сценарии PowerShell.

Этот вариант применим только для некритических приложений, которые допускают высокое значение целевого времени восстановления. Например, его можно использовать для приложения, которое может не работать в течение нескольких часов, но должно быть запущено в течение 24 часов.

![Повторное развертывание в дополнительном регионе Azure](./media/resiliency-disaster-recovery-azure-applications/redeploy-to-a-secondary-azure-region.png)

### <a name="active-passive"></a>Шаблон "активный — пассивный"
Множество компаний выбирают шаблон "активный-пассивный". Этот шаблон позволяет улучшить показатели целевого времени восстановления. Он требует немного больше затрат по сравнению с повторным развертыванием.
В этом сценарии также используются основной и дополнительный регион Azure. Весь трафик передается в активное развертывание в основном регионе. Дополнительный регион лучше подготовлен к аварийному восстановлению, так как база данных работает в обоих регионах. Кроме того, между ними настроен механизм синхронизации. Существует два варианта такого резервного подхода: только с использованием базы данных или полное развертывание в дополнительном регионе.

#### <a name="database-only"></a>Только база данных
В первом варианте шаблона "активный-пассивный" облачная служба приложения развернута только в основном регионе. Однако в отличие от шаблона повторного развертывания оба региона синхронизируются с содержимым базы данных. Дополнительные сведения см. в разделе о [шаблоне данных о транзакциях для аварийного восстановления](#transactional-data-pattern-for-disaster-recovery). При сбое требований к активации меньше. Необходимо запустить приложение в дополнительном регионе, изменить строки подключения к новой базе данных, а также записи DNS, чтобы перенаправить трафик.

Как и в шаблоне повторного развертывания, пакеты служб уже должны быть в хранилище BLOB-объектов Azure в дополнительном регионе для более быстрого развертывания. В отличие от шаблона повторного развертывания здесь сокращается большая часть расходов, которые требуются для операции по восстановлению базы данных. База данных уже готова к работе. Таким образом экономится значительная часть времени. Поэтому этот шаблон аварийного восстановления стал доступным. Кроме того, он еще и самый популярный.

![Шаблон "активный — пассивный" (только база данных)](./media/resiliency-disaster-recovery-azure-applications/active-passive-database-only.png)

#### <a name="full-replica"></a>Полная реплика
Во втором варианте шаблона "активный — пассивный" в основном и дополнительном регионе содержится полное развертывание. Это развертывание включает в себя облачные службы и синхронизированную базу данных. Однако только основной регион активно обрабатывает сетевые запросы от пользователей. Дополнительный регион становится активным, только если в основном регионе происходит нарушение работы службы. В этом случае все новые сетевые запросы перенаправляются в дополнительный регион. Диспетчер трафика Azure может автоматически управлять такой отработкой отказа.

Отработка отказа выполняется быстрее, чем в варианте, когда используется только база данных, так как службы уже развернуты. Этот шаблон характеризуется очень низким значением целевого времени восстановления. Дополнительный регион для отработки отказа должен быть готов к работе сразу после сбоя основного региона.

Наряду с малым временем отклика этот шаблон предоставляет преимущество предварительного выделения и развертывания служб архивации. Не нужно беспокоиться о том, что в регионе не будет места для выделения новых экземпляров после сбоя. Это следует учитывать, если дополнительный регион Azure близок к заполнению. Нет никакой гарантии (соглашения об уровне обслуживания), что вы сразу же сможете развернуть несколько новых облачных служб в любом регионе.

Чтобы добиться минимального времени отклика в этой модели, необходимо использовать один и тот же масштаб (количество экземпляров ролей) в основном и дополнительном регионах. Несмотря на преимущества, есть неиспользуемые вычислительные операции, которые дорого обходятся, поэтому это не самый выгодный вариант с финансовой точки зрения. По этой причине чаще всего используется версия облачных служб меньшего масштаба в дополнительном регионе. Затем при необходимости можно быстро выполнить отработку отказа и дополнительное развертывание. Следует автоматизировать отработку отказа, чтобы в случае недоступности основного региона можно было активировать дополнительные экземпляры в зависимости от нагрузки. При этом может использоваться механизм автоматического масштабирования, например [наборы для масштабирования виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md).

На следующей схеме показана модель по шаблону "активный — пассивный", в которой основной и дополнительный регионы содержат полностью развернутую облачную службу.

![Шаблон "активный — пассивный" (полная реплика)](./media/resiliency-disaster-recovery-azure-applications/active-passive-full-replica.png)

### <a name="active-active"></a>Шаблон "активный — активный"
Теперь, скорее всего, вы поняли закономерность усовершенствования шаблонов: уменьшение целевого времени восстановления влечет увеличение затрат и сложности. С точки зрения затрат решение на основе шаблона "активный-активный" нарушает эту тенденцию.

В шаблоне "активный-активный" облачные службы и база данных полностью развертываются в обоих регионах. В отличие от трафика в модели "активный-пассивный" трафик от пользователей передается в оба региона. Этот вариант обеспечивает минимальное время восстановления. Службы уже масштабированы для обработки части нагрузки в каждом регионе. DNS уже настроена для использования в дополнительном регионе. Но при определении способа маршрутизации пользователей в соответствующий регион возникают дополнительные сложности. В этом случае возможно планирование циклического перебора. Скорее всего, некоторые пользователи будут использовать определенный регион, где хранится основная копия их данных.

В случае отработки отказа просто отключите DNS в основном регионе. Таким образом весь трафик будет направлен в дополнительный регион.

Даже для этой модели доступны некоторые варианты. Например, на следующей схеме показана модель, в которой основной регион содержит мастер-копию базы данных. Облачные службы в обоих регионах записывают данные в эту базу данных-источник. Дополнительное развертывание может считывать данные из базы данных-источника или реплицированной базы данных. В этом примере репликация выполняется в одном направлении.

![Шаблон "активный — активный"](./media/resiliency-disaster-recovery-azure-applications/active-active.png)

В архитектуре на основе шаблона "активный — активный" на предыдущей схеме есть недостаток. Во втором регионе должен быть доступ к базе данных первого региона, так как там содержится мастер-копия. Производительность значительно уменьшается при доступе к данным за пределами региона. Чтобы повысить производительность вызовов базы данных в различных регионах, следует разработать определенную стратегию пакетной обработки. Дополнительные сведения см. в статье [Как повысить производительность приложений базы данных SQL с помощью пакетной обработки](../sql-database/sql-database-use-batching-to-improve-performance.md).

В альтернативной архитектуре каждый регион может получать прямой доступ к своей базе данных. В этой модели для синхронизации баз данных в каждом регионе требуется двунаправленная репликация.

В шаблоне "активный-активный" в основном регионе может потребоваться меньше экземпляров по сравнению с их количеством в шаблоне "активный-пассивный". Если в архитектуре на основе шаблона "активный — пассивный" в основном регионе есть 10 экземпляров, в архитектуре на основе шаблона "активный — активный" в каждом регионе может потребоваться всего 5 экземпляров. Теперь нагрузка распределяется между обоими регионами. Если разместить "горячую" резервную копию с 10 экземплярами, ожидающими отработки отказа, в пассивном регионе, затраты будут меньше по сравнению с затратами в шаблоне "активный — пассивный".

Учтите, что до восстановления основного региона в дополнительном регионе может случиться неожиданный наплыв новых пользователей. Если при нарушении работы службы в основном регионе на каждом сервере было 10 000 пользователей, дополнительному региону внезапно потребуется обрабатывать 20 000 пользователей. Правила мониторинга в дополнительном регионе должны обнаружить такое увеличение и удвоить число экземпляров в этом регионе. Дополнительные сведения см. в разделе об [обнаружении сбоев](#failure-detection).

## <a name="hybrid-on-premises-and-cloud-solution"></a>гибридных локальных и облачных решениях
Дополнительная стратегия аварийного восстановления предусматривает создание гибридного приложения, которое работает локально и в облаке. В зависимости от приложения основной регион может находиться как в локальной среде, так и в облаке. Рассмотрим предыдущие архитектуры и представим, что основной или дополнительный регион располагается в локальной среде.

В таких гибридных архитектурах возникают некоторые сложности. В большей части этой статьи основное внимание уделяется шаблонам архитектуры PaaS. Типичные приложения PaaS в Azure используют конструкции Azure, например роли, облачные службы и диспетчер трафика. Чтобы создать локальное решение для этого типа приложений PaaS, потребовалась бы совсем другая архитектура. Это может не подойти с точки зрения управления или затрат.

Но при создании гибридного решения для аварийного восстановления с использованием традиционных архитектур возникает меньше трудностей, так как они просто перемещаются в облако. Это применимо к архитектурам, использующим модель IaaS. Приложения IaaS используют виртуальные машины в облаке, для которых могут существовать прямые эквиваленты в локальной среде. Кроме того, подключать компьютеры в облаке к локальным сетевым ресурсам можно с помощью виртуальных сетей. Таким образом открывается несколько возможностей, которые невозможно использовать в приложениях PaaS. Например, SQL Server может использовать решения аварийного восстановления, например группы доступности AlwaysOn и зеркальное отображение базы данных. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md).

Решения IaaS также предоставляют простой способ использования Azure в качестве варианта для отработки отказа для локальных приложений. В существующем локальном регионе может быть развернуто полнофункциональное приложение. Но что делать, если не хватает ресурсов для поддержки географически отделенного региона для отработки отказа? Чтобы запустить приложение в Azure, можно использовать виртуальные машины и виртуальные сети. В этом случае определите процессы синхронизации данных в облаке. После этого развертывание Azure станет дополнительным регионом для отработки отказа. Основным регионом останется локальное приложение. Дополнительные сведения об архитектурах и возможностях IaaS см. в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).

## <a name="alternative-cloud"></a>Альтернативное облако
В некоторых ситуациях даже надежность Microsoft Cloud может не удовлетворять внутренним правилам соответствия или политикам организации. Даже лучшая подготовка и архитектура для внедрения систем архивации во время сбоя становятся неэффективными при глобальном нарушении работы службы поставщика облачных служб.

Необходимо сравнить требования к доступности с затратами и сложностью повышения уровня доступности. Проанализируйте риски и определите целевое время восстановления и RPO для своего решения. Если приложение не допускает простоев, логично подумать об использовании другого облачного решения. Если вся среда Azure станет недоступной, другое облачное решение все еще может быть доступно (если не утерян доступ к Интернету).

Как и в гибридном сценарии, развертывания для отработки отказа в предыдущих архитектурах аварийного восстановления могут также содержаться в другом облачном решении. Альтернативные облачные сайты аварийного восстановления следует использовать только для решений с целевым временем восстановления, которое допускает очень малый простой или не допускает его вовсе. Обратите внимание, что для настройки, разработки, развертывания и обслуживания решения, использующего сайт аварийного восстановления вне Azure, требуется намного больше усилий. Кроме того, намного сложнее реализовать рекомендации в архитектуре, охватывающей несколько облаков. Хотя к облачным платформам применяются схожие общие принципы, API и архитектуры у них разные.

Если вы решили разместить решение аварийного восстановления на разных платформах, имеет смысл включить в архитектуру решения слои абстрагирования. После этого не понадобится разрабатывать и обслуживать две различные версии одного приложения для разных облачных платформ в случае сбоя. Как и в гибридном сценарии, в этих случаях может оказаться удобнее использовать виртуальные машины Azure или службу контейнеров Azure, чем решения PaaS в зависимости от облачных платформ.

## <a name="automation"></a>Автоматизация
Некоторые рассмотренные шаблоны требуют быстрой активации автономных развертываний, а также восстановления определенных компонентов системы. Автоматизация и написание сценариев поддерживают возможность активации ресурсов по запросу и быстрого развертывания решений. В этой статье автоматизация, связанная с аварийным восстановлением, выполняется в [Azure PowerShell](https://msdn.microsoft.com/library/azure/jj156055.aspx), но также можно использовать и [REST API управления службами](https://msdn.microsoft.com/library/azure/ee460799.aspx).

Разработка сценариев помогает управлять компонентами аварийного восстановления, которыми Azure не управляет открыто. Это предоставляет преимущество достижения постоянных результатов, что снижает вероятность возникновения ошибок, связанных с человеческим фактором. Предопределенные сценарии аварийного восстановления также сокращают перестройку системы и ее составных частей во время сбоя. Нецелесообразно пытаться вручную определить, как восстановить сайт при сбое, когда с каждой минутой убытки становятся все больше.

После создания сценария тщательно проверьте его несколько раз от начала и до конца. Проверив базовые возможности, протестируйте его, используя [моделирование сбоя](#disaster-simulation). Так вы сможете обнаружить недостатки сценариев или процессов.

Чтобы автоматизировать эту задачу, рекомендуется создать репозиторий сценариев PowerShell или сценариев интерфейса командной строки по аварийному восстановлению Azure. Четко обозначьте и классифицируйте их, чтобы упростить поиск. Выделите одного специалиста для управления репозиторием и версиями сценариев. Задокументируйте их, предоставив четкое описание параметров и примеры использования сценариев. Кроме того, обеспечьте синхронизацию этой документации с развертываниями Azure. Это подчеркивает необходимость наличия одного сотрудника, ответственного за все компоненты репозитория.

## <a name="failure-detection"></a>Обнаружение сбоев
Чтобы устранять проблемы доступности и выполнять аварийное восстановление должным образом, необходимо иметь возможность выявления и диагностики сбоев. Чтобы быстро узнавать о внезапном сбое системы или ее частей, необходимо внедрить расширенный мониторинг серверов и развертываний. Частично это задание могут выполнять средства мониторинга, которые отслеживают общую работоспособность облачной службы и ее зависимых компонентов. Одно из таких средств Майкрософт — [System Center 2016](https://www.microsoft.com/en-us/server-cloud/products/system-center-2016/). Возможности мониторинга могут также предоставлять сторонние средства. Большинство решений мониторинга отслеживают основные счетчики производительности, а также доступность службы.

Несмотря на то, что эти средства играют очень важную роль, они не избавляют от необходимости планирования обнаружения сбоев и отчетности в облачной службе. Чтобы правильно использовать диагностику Azure, необходимо составить план. Настраиваемые счетчики производительности или записи журнала событий также могут быть частью общей стратегии. С их помощью во время сбоев вы будете получать дополнительные данные, которые позволяют быстро определить проблему и восстановить все возможности. Вы также получаете дополнительные метрики, по которым средства мониторинга могут определить работоспособность приложения. Дополнительные сведения см. в статье [Включение системы диагностики Azure в облачных службах Azure](../cloud-services/cloud-services-dotnet-diagnostics.md). Обсуждение планирования общей модели работоспособности см. на странице [FailSafe: Building Scalable, Resilient Cloud Services](https://channel9.msdn.com/Series/FailSafe) (Отказоустойчивость. Создание устойчивых облачных служб).

## <a name="disaster-simulation"></a>моделирование сбоя
Проверка методом моделирования подразумевает создание небольших реалистичных ситуаций в рабочей среде, чтобы проверить, какие действия предпримут участники группы. Моделирование также позволяет оценить эффективность решений в плане восстановления. Выполняйте моделирование так, чтобы созданные сценарии не нарушали фактическую деятельность компании, но при этом походили на реальные ситуации.

Рассмотрим создание коммутационной панели в приложении, чтобы смоделировать проблемы с доступностью вручную. Например, с помощью программного коммутатора инициируйте исключения доступа к базе данных для модуля заказов, вызвав сбой в его работе. Подобные упрощенные подходы можно использовать для других модулей на уровне сетевого интерфейса.

Во время моделирования выделяются все проблемы, не решенные должным образом. Моделируемые сценарии должны быть полностью управляемыми. Это значит, что даже если кажется, что план восстановления не срабатывает, можно восстановить нормальный режим работы без значительного ущерба. Кроме того, важно сообщить руководителям более высокого уровня о времени и способе проведения моделирования. Этот план должен содержать сведения о времени или ресурсах, которые могут стать недоступными при проверке методом моделирования. При проверке плана аварийного восстановления также очень важно определить, как будет оцениваться успех.

Существует несколько других методов проверки планов аварийного восстановления. Тем не менее большинство из них — это просто измененные версии базовых методов. Основная цель тестирования заключается в оценке возможности реализации и практичности плана восстановления. При проверке аварийного восстановления основное внимание уделяется определению недостатков в базовом плане восстановления.

## <a name="next-steps"></a>Дальнейшие действия
Эта статья входит в серию статей, посвященных [аварийному восстановлению и высокой доступности для приложений на платформе Microsoft Azure](resiliency-disaster-recovery-high-availability-azure-applications.md). Предыдущая статья в этой серии — [Обеспечение высокой доступности для приложений на платформе Microsoft Azure](resiliency-high-availability-azure-applications.md).


