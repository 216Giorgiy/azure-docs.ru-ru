---
title: "Техническое руководство по обеспечению устойчивости для восстановления после потери региона Azure | Документация Майкрософт"
description: "Понимание и проектирование надежных высокодоступных отказоустойчивых приложений, а также планирование аварийного восстановления."
services: 
documentationcenter: na
author: adamglick
manager: saladki
editor: 
ms.assetid: f2f750aa-9305-487e-8c3f-1f8fbc06dc47
ms.service: resiliency
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2016
ms.author: aglick
translationtype: Human Translation
ms.sourcegitcommit: 65fe1b29b55b58a160c8c1a3baed117530040c71
ms.openlocfilehash: 4d98ff207e08184fffd6dbfa93a018c1e208fa95
ms.lasthandoff: 02/17/2017


---
# <a name="azure-resiliency-technical-guidance-recovery-from-a-region-wide-service-disruption"></a>Техническое руководство по обеспечению устойчивости в Azure. Восстановление после прерывания работы служб во всем регионе
Azure физически и логически разделяется на единицы, называемые регионами. Регион включает один или несколько центров обработки данных, расположенных в непосредственной близости друг от друга. Текущий список регионов указан на [странице регионов Azure](https://azure.microsoft.com/regions/).

В редких случаях ресурсы целого региона могут стать недоступными (например, из-за сбоев сети) или полностью потерянными (например, из-за стихийных бедствий). В этой статье объясняются возможности Azure по созданию приложений, которые распределяются между регионами. Подобное распределение позволяет минимизировать вероятность того, что сбой в одном регионе повлияет на другие регионы.

## <a name="cloud-services"></a>Облачные службы
### <a name="resource-management"></a>Управление ресурсами
Вы можете распределить вычислительные операции по регионам, создав отдельную облачную службу в каждом целевом регионе и опубликовав пакет развертывания в каждой из служб. При этом распределение трафика между облачными службами в разных регионах должно быть реализовано разработчиком приложения или с помощью службы управления трафиком.

Определение необходимого количества запасных экземпляров роли, которые нужно предварительно развертывать для аварийного восстановления, — это важный аспект планирования ресурсов. Наличие полномасштабной дополнительной развернутой службы гарантирует, что при необходимости ресурсы уже будут доступны. Стоимость при этом увеличится вдвое. Распространенный подход — развернуть небольшую дополнительную службу, достаточную для запуска критически важных служб. Это целесообразно для создания резервной мощности и тестирования конфигурации дополнительной среды.

> [!NOTE]
> Квота подписки не гарантирует наличие ресурсов. Квота — просто кредитный лимит. Чтобы обеспечить достаточное количество ресурсов, в модели службы нужно задать необходимое количество ролей, при этом роли должны быть развернуты.
>
>

### <a name="load-balancing"></a>Балансировка нагрузки.
Чтобы распределить нагрузку по трафику между регионами, требуется решение по управлению трафиком. Azure предоставляет [диспетчер трафика Azure](https://azure.microsoft.com/services/traffic-manager/). Кроме того, вы можете воспользоваться сторонними службами, которые предоставляют аналогичные возможности по управлению трафиком.

### <a name="strategies"></a>Стратегии
Существует множество альтернативных стратегий для реализации распределенных вычислительных ресурсов в разных регионах. Эти стратегии должны соответствовать определенным бизнес-требованиям и сценариям использования приложения. В сущности, подходы можно разделить на следующие категории.

* **Повторное развертывание после аварии**. Этот подход предусматривает повторное развертывание приложения с нуля в случае аварии. Такой вариант подходит для некритических приложений, для которых не требуется гарантированное время восстановления.
* **Теплая замена (активный — пассивный)**. Вторичная размещенная служба создается в альтернативном регионе, и для обеспечения минимальной производительности развертываются роли. При этом роли не получают рабочий трафик. Этот подход можно использовать для приложений, которые не предназначены для распределения трафика по регионам.
* **Горячая замена (активный —активный)**. Приложение предназначено для получения рабочей нагрузки в нескольких регионах. Приложение предназначено для получения рабочей нагрузки в нескольких регионах. Облачные службы в каждом регионе могут быть настроены для большего количества ресурсов, чем требуется для целей аварийного восстановления. Кроме того, в случае необходимости облачные службы можно развернуть при аварии и отработке отказа. включая малое и гарантированное время восстановления, непрерывное тестирование всех расположений для восстановления и эффективное использование ресурсов.

Полное описание распределенной архитектуры выходит за рамки этой статьи. Дополнительные сведения см. в статье [Аварийное восстановление и высокая доступность для приложений на платформе Azure](https://aka.ms/drtechguide).

## <a name="virtual-machines"></a>Виртуальные машины
Восстановление виртуальных машин IaaS ("инфраструктура как услуга") во многом подобно восстановлению вычислений приложений PaaS ("платформа как услуга"). Но есть и важные отличия, так как виртуальная машина IaaS включает как саму виртуальную машину, так и ее диск.

* **Использование службы архивации Azure для создания согласованных межрегиональных резервных копий приложения**.
  [службы архивации Azure](https://azure.microsoft.com/services/backup/) пользователи могут создавать согласованные резервные копии приложения с нескольких дисков виртуальных машин и поддерживать репликацию резервных копий по регионам. Это достигается за счет того, что при создании хранилища резервных копий для него выбирается георепликация. Репликацию хранилища резервных копий необходимо настроить во время создания. Ее нельзя настроить позже. В случае потери региона корпорация Майкрософт делает резервные копии доступными для пользователей. Благодаря этому пользователи могут восстановить данные в любой из своих настроенных точек восстановления.
* **Разделение диска данных и диска операционной системы**. Важным аспектом использования виртуальных машин IaaS является то, что нельзя изменить диск операционной системы без повторного создания виртуальной машины. Это не будет проблемой, если стратегия восстановления заключается в повторном развертывании после аварии. Но проблема может появиться, если вы используете подход "теплой замены" для резервной мощности. Чтобы правильно реализовать такой подход, и в основном, и в дополнительном расположениях должен быть развернут правильный диск операционной системы, а данные приложений должны храниться на отдельном диске. По возможности используйте стандартную конфигурацию операционной системы, которая может быть предоставлена в обоих расположениях. После отработки отказа следует подключить диск данных к имеющимся виртуальным машинам IaaS на дополнительном контроллере домена. Используйте AzCopy для копирования моментальных снимков дисков с данными на удаленный сайт.
* **Учитывайте возможные проблемы с согласованностью после географической отработки отказа нескольких дисков виртуальных машин**. Каждый диск виртуальной машины реализуется как экземпляр хранилища BLOB-объектов Azure. При этом все диски характеризуются сходными настройками георепликации. Если [служба архивации Azure](https://azure.microsoft.com/services/backup/) не используется, нет гарантий согласованности между дисками, так как георепликация выполняется асинхронно и диски реплицируются независимо друг от друга. При сбое отдельные диски виртуальных машин гарантированно будут в состоянии отказоустойчивости после географической отработки отказа, но они не будут согласованы между собой. В некоторых случаях (например, в случае чередования дисков) это может вызвать проблемы.

## <a name="storage"></a>Хранилище
### <a name="recovery-by-using-geo-redundant-storage-of-blob-table-queue-and-vm-disk-storage"></a>Восстановление с использованием геоизбыточного хранилища дискового пространства больших двоичных объектов, таблиц, очередей и виртуальных машин
В Azure все большие двоичные объекты, таблицы, очереди и диски виртуальных машин по умолчанию являются геореплицируемыми. Это называется геоизбыточным хранилищем. Геоизбыточное хранилище реплицирует данные хранилища в сопряженный центр обработки данных, расположенный на расстоянии нескольких сотен километров в определенном географическом регионе. Такое хранилище обеспечивает дополнительный уровень надежности на случай серьезной аварии в центре обработки данных. Корпорация Майкрософт контролирует отработку отказа. Она происходит только в случае серьезной аварии, при которой восстановить исходное основное расположение в разумные сроки невозможно. В некоторых случаях на это может уйти несколько дней. Данные обычно реплицируются несколько минут, хотя интервал синхронизации еще не регламентирован соглашением об уровне обслуживания.

Когда происходит географическая отработка отказа, способ получения доступа к учетной записи не меняется (URL-адрес и ключ учетной записи остаются неизменными). Однако после отработки отказа учетная запись хранения будет находиться в другом регионе. Это может повлиять на приложения, которые должны находиться в одном регионе с учетной записью хранения. Вы можете использовать службы и приложения, для работы которых учетная запись хранения необязательно должна располагаться в том же центре обработки данных. В таком случае задержка связи между центрами обработки данных и расходы, связанные с пропускной способностью, может послужить причиной временного перемещения трафика в регион отработки отказа. Эти факторы могут повлиять на общую стратегию аварийного восстановления.

Помимо автоматической отработки отказа, характерной для геоизбыточного хранилища, в Azure появилась служба, которая предоставляет доступ на чтение копии данных в расположении дополнительного хранилища. Она называется "геоизбыточное хранилище с доступом на чтение".

См. дополнительные сведения о геоизбыточном хранилище и геоизбыточном хранилище с доступом только для чтения в разделе, посвященном [репликации хранилища Azure](../storage/storage-redundancy.md).

### <a name="geo-replication-region-mappings"></a>Сопоставления регионов георепликации
Важно знать, в какой регион выполняется георепликация, чтобы понимать, где развертывать другие экземпляры данных, которые должны находиться в одном регионе с хранилищем данных. В представленной ниже таблице показаны пары основного и дополнительного расположений.

[!INCLUDE [paired-region-list](../../includes/paired-region-list.md)]

### <a name="geo-replication-pricing"></a>Расходы, связанные с георепликацией
Расходы на георепликацию включены в текущую стоимость службы хранилища Azure. Если георепликация данных не требуется, вы можете отключить ее для своей учетной записи. Такой вариант называется локально избыточным хранилищем с более низкой стоимостью.

### <a name="determine-if-a-geo-failover-occurred"></a>Определение выполнения географической отработки отказа
Сведения о выполненной географической отработке отказа публикуются на [панели мониторинга работоспособности служб Azure](https://azure.microsoft.com/status/). Но приложения могут автоматически определять отработку в ходе мониторинга географического региона своей учетной записи хранения. Такое автоопределение можно использовать для запуска других операций восстановления, включая активацию вычислительных ресурсов в географическом регионе, в который перемещено их хранилище. Для этого можно отправить запрос из API управления службами с помощью процедуры [получения свойств учетной записи хранения](https://msdn.microsoft.com/library/ee460802.aspx). Необходимы следующие свойства:

    <GeoPrimaryRegion>primary-region</GeoPrimaryRegion>
    <StatusOfPrimary>[Available|Unavailable]</StatusOfPrimary>
    <LastGeoFailoverTime>DateTime</LastGeoFailoverTime>
    <GeoSecondaryRegion>secondary-region</GeoSecondaryRegion>
    <StatusOfSecondary>[Available|Unavailable]</StatusOfSecondary>

### <a name="vm-disks-and-geo-failover"></a>Диски виртуальных машин и географическая отработка отказа
Как уже обсуждалось в разделе "Виртуальные машины" этой статьи, согласованность данных между разными дисками виртуальных машин после отработки отказа не может гарантироваться. Чтобы обеспечить правильность резервных копий, для резервного копирования и восстановления данных приложений следует использовать службу архивации, например System Center Data Protection Manager.

## <a name="database"></a>База данных
### <a name="azure-sql-database"></a>База данных SQL Azure
База данных SQL Azure предоставляет два типа восстановления данных: геовосстановление и активная георепликация.

#### <a name="geo-restore"></a>Геовосстановление
Функция [геовосстановления](../sql-database/sql-database-recovery-using-backups.md#geo-restore) также доступна для баз данных уровней "Базовый", "Стандартный" и "Премиум". Она используется по умолчанию, когда база данных недоступна из-за происшествия в регионе, где она размещена. Как и для функции восстановления до точки во времени, при геовосстановлении используются резервные копии базы данных из геоизбыточного хранилища Azure. Восстановление выполняется на основе резервной копии из удаленного хранилища, что позволяет защитить базу данных от сбоев в основном регионе. См. дополнительные сведения о [восстановлении базы данных SQL Azure или отработке отказа на базу данных-получатель](../sql-database/sql-database-disaster-recovery.md).

#### <a name="active-geo-replication"></a>Активная георепликация
[Активная георепликация](../sql-database/sql-database-geo-replication-overview.md) доступна для всех уровней баз данных. Она рассчитана на приложения, которые предъявляют более высокие требования к восстановлению по сравнению с теми, которые может обеспечить обычное геовосстановление. Активная георепликация позволяет создавать до четырех доступных для чтения реплик баз данных на серверах в разных регионах. Отработку отказа можно выполнить на любую из баз данных-получателей. Кроме того, активная георепликация применяется при обновлении приложений и их перемещении, а также для балансировки нагрузки (распределения операций чтения). См. дополнительные сведения о [настройке георепликации](../sql-database/sql-database-geo-replication-portal.md) и [отработке отказа на базу данных-получатель](../sql-database/sql-database-geo-replication-failover-portal.md). Дополнительные сведения о проектировании и реализации приложений и их обновлений без простоя см. в статьях [Проектирование приложения для облачного аварийного восстановления с использованием активной георепликации в базе данных SQL](../sql-database/sql-database-designing-cloud-solutions-for-disaster-recovery.md) и [Управление последовательными обновлениями для облачных приложений с помощью активной георепликации базы данных SQL](../sql-database/sql-database-manage-application-rolling-upgrade.md).

### <a name="sql-server-on-azure-virtual-machines"></a>SQL Server на виртуальных машинах Azure
Доступны разные способы восстановления и обеспечения высокой доступности службы SQL Server 2012 (и более поздних версий), запущенной на виртуальных машинах Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md).

## <a name="other-azure-platform-services"></a>Другие службы платформы Azure
При попытке запуска облачной службы в нескольких регионах Azure необходимо учитывать последствия каждой зависимости. В следующих разделах представлено руководство по конкретным службам для пользователей, которым нужно использовать ту же службу Azure в альтернативном центре обработки данных Azure. Это включает в себя как задачи конфигурации, так и задачи репликации данных.

> [!NOTE]
> В некоторых случаях эти действия помогают устранить сбой конкретной службы, а не целое событие в центре обработки данных. Если говорить о приложении, сбой определенной службы также может ограничивать ее функциональность, требуя ее временного переноса в альтернативный регион Azure.
>
>

### <a name="azure-service-bus"></a>Azure Service Bus
Служебная шина Azure использует уникальное пространство имен, которое не охватывает регионы Azure. Поэтому первое требование в такой ситуации — это настройка необходимых пространств имен служебной шины в альтернативном регионе. Тем не менее нужно также учитывать факторы, касающиеся надежности сообщений в очереди. Существует несколько стратегий репликации сообщений в регионах Azure. Дополнительные сведения об этих стратегиях репликации и других стратегиях аварийного восстановления см. в статье [Рекомендации по изолированию приложений от простоев и аварий служебной шины](../service-bus-messaging/service-bus-outages-disasters.md). Сведения о других вопросах доступности см. в разделе о [доступности служебной шины](resiliency-technical-guidance-recovery-local-failures.md#other-azure-platform-services).

### <a name="azure-app-service"></a>Служба приложений Azure
Чтобы переместить приложение Azure службы приложений Azure, например веб-приложение или мобильное приложение, в дополнительный регион Azure, требуется резервная копия веб-сайта, доступная для публикации. Если сбой охватывает лишь часть центра обработки данных Azure, можно использовать FTP для скачивания последней резервной копии содержимого веб-сайта. После этого создайте приложение в альтернативном регионе, если вы не сделали это ранее для обеспечения резервной мощности. Опубликуйте сайт в новом регионе и внесите все необходимые изменения конфигурации. Эти изменения могут включать строки подключения к базе данных или другие параметры, связанные с определенным регионом. При необходимости добавьте SSL-сертификат сайта и измените запись DNS CNAME, чтобы пользовательское доменное имя указывало на URL-адрес повторно развернутых веб-приложений.

### <a name="azure-hdinsight"></a>Azure HDInsight
Данные, связанные с Azure HDInsight, по умолчанию хранятся в хранилище BLOB-объектов Azure. Для HDInsight требуется, чтобы обрабатывающий задания MapReduce кластер Hadoop находился в том же регионе, что и учетная запись хранения, содержащая анализируемые данные. Используя функцию георепликации, доступную для службы хранилища Azure, вы можете получить доступ к своим данным в дополнительном регионе, в который они были реплицированы, если основной регион больше недоступен. Вы можете создать кластер Hadoop в том регионе, в который были реплицированы данные, и продолжить их обработку. Сведения о других вопросах доступности см. в разделе [HDInsight](resiliency-technical-guidance-recovery-local-failures.md#other-azure-platform-services).

### <a name="sql-reporting"></a>Служба отчетов SQL Reporting
Сейчас для восстановления после потери региона Azure требуется наличие нескольких экземпляров службы SQL Reporting в разных регионах Azure. Эти экземпляры службы SQL Reporting должны получать доступ к одним и тем же данным, для которых должен быть предусмотрен собственный план восстановления на случай аварии. Вы также можете создать внешние резервные копии RDL-файла для каждого отчета.

### <a name="azure-media-services"></a>Службы мультимедиа Azure
Для кодирования и потоковой передачи службы мультимедиа Azure используют разные способы восстановления. При региональном сбое, как правило, потоковая передача является более важной. Чтобы подготовиться к такому варианту событий, у вас должна быть учетная запись служб мультимедиа в двух разных регионах Azure. Закодированное содержимое должно быть расположено в обоих регионах. Во время сбоя вы можете перенаправить потоковый трафик в альтернативный регион. Кодирование может выполняться в любом регионе Azure. Если для кодировки важно время выполнения, например во время обработки интерактивного события, вы должны быть готовы к отправке заданий в альтернативный центр обработки данных во время сбоев.

### <a name="virtual-network"></a>Виртуальная сеть
Файлы конфигурации обеспечивают самый быстрый способ настройки виртуальной сети в альтернативном регионе Azure. После настройки виртуальной сети в основном регионе Azure [экспортируйте параметры текущей виртуальной сети](../virtual-network/virtual-networks-create-vnet-classic-portal.md) в файл конфигурации сети. При сбое в основном регионе [восстановите виртуальную сеть](../virtual-network/virtual-networks-create-vnet-classic-portal.md) из сохраненного файла конфигурации. Затем настройте другие облачные службы, виртуальные машины или распределенные параметры для работы с новой виртуальной сетью.

## <a name="checklists-for-disaster-recovery"></a>Контрольные списки для аварийного восстановления
## <a name="cloud-services-checklist"></a>Контрольный список для облачных служб
1. Просмотрите раздел "Облачные службы" этой статьи.
2. Создайте межрегиональную стратегию аварийного восстановления.
3. Оцените преимущества и недостатки резервирования ресурсов в альтернативных регионах.
4. Используйте средства маршрутизации трафика, такие как диспетчер трафика Azure.

## <a name="virtual-machines-checklist"></a>Контрольный список для виртуальных машин
1. Просмотрите раздел "Виртуальные машины" этой статьи.
2. Используйте [службу архивации Azure](https://azure.microsoft.com/services/backup/) для создания согласованных резервных копий приложения по регионам.

## <a name="storage-checklist"></a>Контрольный список для хранилища
1. Просмотрите раздел "Хранилище" этой статьи.
2. Не отключайте георепликацию ресурсов хранилища.
3. Определите альтернативный регион георепликации на случай отработки отказа.
4. Создайте пользовательские стратегии архивирования для управляемых пользователем стратегий отработки отказа.

## <a name="azure-sql-database-checklist"></a>Контрольный список для базы данных SQL Azure
1. Просмотрите раздел "База данных SQL Azure" этой статьи.
2. В зависимости от ситуации используйте [геовосстановление](../sql-database/sql-database-recovery-using-backups.md#geo-restore) или [георепликацию](../sql-database/sql-database-geo-replication-overview.md).

## <a name="sql-server-on-azure-virtual-machines-checklist"></a>Контрольный список для SQL Server на виртуальных машинах Azure
1. Просмотрите раздел "SQL Server на виртуальных машинах Azure" этой статьи.
2. Используйте межрегиональные группы доступности AlwaysOn или зеркальное отображение базы данных.
3. Можно также использовать резервное копирование и восстановление в хранилище BLOB-объектов.

## <a name="service-bus-checklist"></a>Контрольный список для служебной шины
1. Просмотрите раздел "Служебная шина Azure" этой статьи.
2. Настройте пространство имен служебной шины в альтернативном регионе.
3. Рассмотрите пользовательские стратегии репликации для сообщений между регионами.

## <a name="app-service-checklist"></a>Контрольный список для службы приложений
1. Просмотрите раздел "Служба приложений Azure" этой статьи.
2. Сохраните резервные копии сайта за пределами основного региона.
3. Если сбой частичный, попробуйте получить доступ к текущему сайту по протоколу FTP.
4. Спланируйте развертывание сайта на новом или существующем сайте в альтернативном регионе.
5. Создайте план изменений конфигурации для приложения и для записей DNS CNAME.

## <a name="hdinsight-checklist"></a>Контрольный список для HDInsight
1. Просмотрите раздел "Azure HDInsight" этой статьи.
2. Создайте кластер Hadoop в регионе с реплицированными данными.

## <a name="sql-reporting-checklist"></a>Контрольный список для службы SQL Reporting
1. Просмотрите раздел "Служба SQL Reporting" этой статьи.
2. Настройте альтернативный экземпляр службы SQL Reporting в другом регионе.
3. Разработайте отдельный план для репликации целевых данных в этот регион.

## <a name="media-services-checklist"></a>Контрольный список для служб мультимедиа
1. Просмотрите раздел "Службы мультимедиа" этой статьи.
2. Создайте учетную запись служб мультимедиа в альтернативном регионе.
3. Закодируйте одинаковое содержимое в обоих регионах для поддержки отработки отказа потоковой передачи.
4. Отправьте задания кодирования в альтернативный регион, если работа службы нарушена.

## <a name="virtual-network-checklist"></a>Контрольный список для виртуальной сети
1. Просмотрите раздел "Виртуальная сеть" этой статьи.
2. Используйте экспортированные параметры виртуальной сети, чтобы повторно создать ее в другом регионе.

## <a name="next-steps"></a>Дальнейшие действия
Этот материал входит в цикл статей, составляющих [техническое руководство по обеспечению устойчивости в Azure](resiliency-technical-guidance.md). Следующая статья этого цикла посвящена [восстановлению из локального центра обработки данных в Azure](resiliency-technical-guidance-recovery-on-premises-azure.md).

