<properties
   pageTitle="Техническое руководство по устойчивости для восстановления после потери региона Azure | Microsoft Azure"
   description="Эта статья поможет вам понять и освоить процедуру создания надежных, высокодоступных, отказоустойчивых приложений, а также планирование аварийного восстановления."
   services=""
   documentationCenter="na"
   authors="adamglick"
   manager="hongfeig"
   editor=""/>

<tags
   ms.service="resiliency"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="05/13/2016"
   ms.author="patw;jroth;aglick"/>

#Техническое руководство по устойчивости Azure: восстановление после прерывания работы служб во всем регионе Azure

Azure физически и логически разделяется на единицы, называемые регионами. Регион состоит из одного или нескольких центров обработки данных, расположенных в непосредственной близости друг от друга. На момент написания этой статьи Azure имеет двадцать четыре региона по всему миру. В редких случаях ресурсы целого региона могут стать недоступными (например, из-за сбоев сети) или полностью потерянными (например, из-за стихийных бедствий). В этом разделе объясняются возможности Azure по созданию приложений, которые распределяются по регионам. Деление на регионы позволяет минимизировать вероятность того, что сбой в одном регионе повлияет на другие регионы.

##Облачные службы

###Управление ресурсами
Распределение вычислительных операций по регионам достигается путем создания отдельной облачной службы в каждом целевом регионе и публикации пакета развертывания в каждой облачной службе. Однако обратите внимание, что распределение трафика по облачным службам в разных регионах должно быть реализовано разработчиком приложения или с помощью службы управления трафиком.

Определение необходимого количества запасных экземпляров роли, которые нужно предварительно развертывать для аварийного восстановления, — это важный аспект планирования ресурсов. Наличие полномасштабной дополнительной развернутой службы гарантирует, что при необходимости ресурсы уже будут доступны, однако стоимость при этом увеличится вдвое. Распространенный подход — развернуть небольшую дополнительную службу, достаточную для запуска критически важных служб. Мы рекомендуем развернуть хотя бы небольшую дополнительную службу для создания резервной мощности и для тестирования конфигурации дополнительной среды.

>[AZURE.NOTE]Квота подписки не гарантирует наличие ресурсов. Квота — просто кредитный лимит. Чтобы обеспечить достаточное количество ресурсов, в модели службы нужно задать необходимое количество ролей и роли должны быть развернуты.

###Балансировка нагрузки
Для балансировки нагрузки для трафика между регионами необходимо использовать решение по управлению трафиком. Azure предоставляет [диспетчер трафика Azure](https://azure.microsoft.com/services/traffic-manager/). Кроме того, вы можете воспользоваться сторонними службами, которые предоставляют аналогичные возможности по управлению трафиком.

###Стратегии
Существует множество альтернативных стратегий для реализации распределенных вычислительных ресурсов в разных регионах. Они должны быть приспособлены к конкретным бизнес-требованиям и обстоятельствам применения приложения. Существующие подходы можно разделить на три категории.

  * __Повторное развертывание после аварии__. Этот подход предусматривает повторное развертывание приложения с нуля в случае аварии. Такой вариант подходит для некритических приложений, которые не требуют гарантированного времени восстановления.

  * __Теплая замена (активная/пассивная)__. Дополнительная размещенная служба создается в альтернативном регионе, и роли развертываются, чтобы обеспечить минимальное количество ресурсов, однако роли не получают рабочий трафик. Этот подход можно использовать для приложений, которые не предназначены для распределения трафика по регионам.

  * __Горячая замена (активная/активная)__. Приложение предназначено для получения рабочей нагрузки в нескольких регионах. Облачные службы в каждом регионе могут быть настроены для большего количества ресурсов, чем требуется для целей аварийного восстановления. Кроме того, в случае необходимости облачные службы можно развернуть при аварии и отработке отказа. Этот подход требует значительных вложений в разработку приложения, но имеет массу преимуществ, включая низкое и гарантированное время аварийного восстановления, непрерывное тестирование всех расположений для восстановления и эффективное использование ресурсов.

Полное описание распределенной архитектуры выходит за рамки данного документа. Дополнительные сведения см. в статье, посвященной [аварийному восстановлению и высокой доступности для приложений Azure](https://aka.ms/drtechguide).

##Виртуальные машины
Процедура восстановления виртуальных машин (ВМ) инфраструктуры как службы (IaaS) во многих аспектах похожа на процедуру восстановления вычислений платформы как службы (PaaS). Однако они отличаются тем, что виртуальные машины IaaS включают в себя как саму виртуальную машину, так и диск виртуальной машины.

  * __Использование службы архивации Azure для создания согласованных межрегиональных резервных копий приложения__. [Служба архивации Azure](https://azure.microsoft.com/services/backup/) позволяет пользователям создавать согласованные резервные копии приложения с нескольких дисков виртуальных машин и поддерживать репликацию резервных копий по регионам. Это достигается за счет того, что при создании хранилища резервных копий для него выбирается георепликация. Учтите, что репликация хранилища резервных копий должна быть настроена во время создания, так как впоследствии ее уже нельзя настроить. В случае потери региона корпорация Майкрософт делает резервные копии доступными для пользователей. Благодаря этому пользователи могут восстановить данные в любой из своих настроенных точек восстановления.

  * __Разделение диска данных и диска ОС__. Важным аспектом использования виртуальной машины IaaS является то, что нельзя изменить диск операционной системы без повторного создания виртуальной машины. Это не проблема, если стратегия восстановления заключается в повторном развертывании после аварии. Тем не менее это может стать проблемой, если вы используете подход "теплой замены" для резервной мощности. Чтобы правильно реализовать этот подход, и в основном, и в дополнительном расположениях должен быть развернут правильный диск ОС, а данные приложений должны храниться на отдельном диске. По возможности используйте стандартную конфигурацию ОС, которая может быть предоставлена в обоих расположениях. После отработки отказа следует подключить диск данных к существующим виртуальным машинам IaaS на дополнительном контроллере домена. Используйте AzCopy для копирования моментальных снимков дисков с данными на удаленный сайт.

  * __Потенциальные проблемы согласованности после географической отработки отказа нескольких дисков виртуальных машин__ Диски виртуальных машин реализованы в виде BLOB-объектов хранилища Azure и имеют те же характеристики георепликации (см. ниже). Если [служба архивации Azure](https://azure.microsoft.com/services/backup/) не используется, нет гарантий согласованности между дисками, так как георепликация выполняется асинхронно и диски реплицируются независимо друг от друга. При сбое отдельные диски виртуальных машин гарантированно будут в состоянии отказоустойчивости после географической отработки отказа, но они не будут согласованы между собой. В некоторых случаях (например, в случае чередования дисков) это может вызвать проблемы.

##Хранилище

###Восстановление с использованием геоизбыточного хранилища BLOB-объектов, таблицы, очереди и хранилища дисков виртуальных машин
В Azure все BLOB-объекты, таблицы, очереди и диски виртуальных машин по умолчанию являются геореплицируемыми. Это называется геоизбыточным хранилищем (GRS). GRS реплицирует данные хранилища в сопряженный центр обработки данных, расположенный на расстоянии нескольких сотен километров в определенном географическом регионе. Хранилище GRS обеспечивает дополнительный уровень надежности на случай серьезной аварии в центре обработки данных. Майкрософт контролирует отработку отказа, и она происходит только в случае серьезной аварии, при которой восстановить исходное основное расположение в разумные сроки не представляется возможным. В некоторых случаях на это может уйти несколько дней. Данные обычно реплицируются несколько минут, хотя интервал синхронизации еще не регламентирован соглашением об уровне обслуживания.

В случае географической отработки отказа процедура получения доступа к учетной записи останется неизменной (URL-адрес и ключ учетной записи не изменяются). Однако после отработки отказа учетная запись хранения находится в другом регионе, что может повлиять на приложения, которые должны находиться в одном регионе с учетной записью хранения. Даже если используются службы и приложения, для которых необязательно, чтобы учетная запись хранения находилась в том же центре обработки данных, задержки связи между центрами обработки данных и расходы, связанные с пропускной способностью, могут послужить веской причиной для временного перемещения трафика в регион отработки отказа. Это может повлиять на общую стратегию аварийного восстановления.

Помимо автоматической отработки отказа, предоставляемой в GRS, в Azure появилась служба, которая предоставляет доступ для чтения копии данных в расположении дополнительного хранилища. Она называется так: геоизбыточное хранилище с доступом на чтение (RA-GRS).

Дополнительные сведения о хранилище GRS и RA-GRS см. в статье [Репликация службы хранилища Azure](../storage/storage-redundancy.md).

###Сопоставления регионов георепликации
Важно знать, в какой регион выполняется георепликация, чтобы понимать, где развертывать другие экземпляры данных, которые должны находиться в одном регионе с хранилищем данных. В представленной далее таблице показаны пары основного и дополнительного расположений.

[AZURE.INCLUDE [paired-region-list](../../includes/paired-region-list.md)]

###Стоимость георепликации
Георепликация включена в текущую стоимость службы хранилища Azure. Это называется геоизбыточным хранилищем. Если георепликация данных не требуется, вы можете отключить ее для своей учетной записи. Это называется локально избыточным хранилищем, и его стоимость меньше стоимости хранилища с георепликацией.

###Как определить, что произошла географическая отработка отказа
Если произошла географическая отработка отказа, сведения о ней появятся на [панели мониторинга работоспособности службы Azure](https://azure.microsoft.com/status/), однако приложения могут автоматически определять это, наблюдая за географическим регионом своей учетной записи хранения. Это можно использовать для запуска других операций восстановления, например активации вычислительных ресурсов в географическом регионе, в который перемещено их хранилище. Соответствующие запросы можно отправлять из API управления службами с помощью процедуры [получения свойств учетной записи хранения](https://msdn.microsoft.com/library/ee460802.aspx). Необходимы следующие свойства:

    <GeoPrimaryRegion>primary-region</GeoPrimaryRegion>
    <StatusOfPrimary>[Available|Unavailable]</StatusOfPrimary>
    <LastGeoFailoverTime>DateTime</LastGeoFailoverTime>
    <GeoSecondaryRegion>secondary-region</GeoSecondaryRegion>
    <StatusOfSecondary>[Available|Unavailable]</StatusOfSecondary>

###Диски виртуальных машин и географическая отработка отказа
Как уже обсуждалось в разделе о дисках виртуальных машин, нет никаких гарантий согласованности данных между различными дисками виртуальных машин после отработки отказа. Чтобы обеспечить правильность резервных копий, для резервного копирования и восстановления данных приложений следует использовать службу архивации, такую как Data Protection Manager.

##База данных

###База данных SQL
База данных SQL Azure предоставляла два типа восстановления данных: геовосстановление и активная георепликация.

####Геовосстановление
Функция [геовосстановления](../sql-database/sql-database-geo-restore.md) также доступна для баз данных уровней "Базовый", "Стандартный" и "Премиум". Она используется по умолчанию, когда база данных недоступна из-за происшествия в регионе, где она размещена. Как и функция восстановления на момент времени, геовосстановление использует резервные копии базы данных из геоизбыточного хранилища Azure. Восстановление выполняется на основе резервной копии из удаленного хранилища, что позволяет защитить базу данных от сбоев в регионе развертывания основной базы. Подробные сведения об использовании геовосстановления см. в статье [Восстановление после сбоя](../sql-database/sql-database-disaster-recovery.md).

####Активная георепликация
[Активная георепликация](../sql-database/sql-database-geo-replication-overview.md) доступна для всех уровней баз данных. Она рассчитана на приложения, которые предъявляют более высокие требования к восстановлению по сравнению с теми, которые может обеспечить обычное геовосстановление. Активная георепликация позволяет создавать до четырех доступных для чтения реплик баз данных на серверах в разных регионах. Отработку отказа можно выполнить на любую из баз данных-получателей. Кроме того, активная георепликация применяется при обновлении приложений и их перемещении, а также для балансировки нагрузки (распределения операций чтения). Дополнительные сведения о [настройке георепликации](../sql-database/sql-database-geo-replication-portal.md) и [отработке отказа на дополнительной базе данных](../sql-database/sql-database-geo-replication-failover-portal.md) предоставлены в статье [Разработка с учетом требований непрерывности бизнес-процессов](../sql-database/sql-database-business-continuity-design.md). Дополнительные сведения о развертывании обновления приложения без перерывов в работе см. в статье [Обновление приложений без простоев](../sql-database/sql-database-business-continuity-application-upgrade.md).

###SQL Server на виртуальных машинах
Существуют различные способы восстановления и обеспечения высокой доступности службы SQL Server 2012 (и более поздних версий), работающей на виртуальных машинах Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](../virtual-machines/virtual-machines-windows-sql-high-availability-dr.md).

##Другие службы платформы Azure
При попытке запуска облачной службы в нескольких регионах Azure необходимо учитывать последствия каждой зависимости. В следующих разделах представлено руководство по конкретным службам для пользователей, которым нужно использовать ту же службу Azure в альтернативном центре обработки данных Azure. Это включает в себя как задачи конфигурации, так и задачи репликации данных.

>[AZURE.NOTE]В некоторых случаях эти действия помогают устранить сбой конкретной службы, а не целое событие в центре обработки данных. Если говорить о приложении, сбой конкретной службы тоже может ограничивать работу службы и требовать временного переноса ее в альтернативный регион Azure.

###Service Bus
Служебная шина Azure использует уникальное пространство имен, которое не охватывает регионы Azure. Поэтому первым требованием является настройка необходимых пространств имен служебной шины в альтернативном регионе. Тем не менее нужно также учитывать факторы, касающиеся надежности сообщений в очереди. Существует несколько стратегий репликации сообщений в регионах Azure. Дополнительные сведения об этих стратегиях репликации и других стратегиях аварийного восстановления см. в статье [Рекомендации по изолированию приложений от простоев и аварий служебной шины](../service-bus/service-bus-outages-disasters.md). Сведения о других вопросах доступности см. в разделе [Служебная шина](./resiliency-technical-guidance-recovery-local-failures.md#service-bus).

###Веб-приложения
Для перемещения веб-приложения Azure в дополнительный регион Azure необходимо иметь резервную копию веб-сайта, доступную для публикации. Если сбой охватывает лишь часть центра обработки данных Azure, можно использовать FTP для скачивания последней резервной копии содержимого веб-сайта. После этого создайте новое веб-приложение в альтернативном регионе, если вы не сделали это ранее для обеспечения резервной мощности. Опубликуйте сайт в новом регионе и внесите все необходимые изменения конфигурации. Эти изменения могут включать строки подключения к базе данных или другие параметры для конкретного региона. При необходимости добавьте SSL-сертификат сайта и измените запись DNS CNAME таким образом, чтобы пользовательское доменное имя указывало на URL-адрес повторно развернутых веб-приложений Azure.

###Мобильные службы
В дополнительном регионе Azure создайте мобильную службу архивации для вашего приложения. Кроме того, восстановите базу данных SQL Azure в альтернативном регионе. Затем с помощью программ командной строки Azure переместите мобильную службу в альтернативный регион. Затем настройте мобильную службу таким образом, чтобы она использовала восстановленную базу данных. Дополнительные сведения об этом процессе см. в статье [Восстановление мобильной службы в случае аварии](../mobile-services/mobile-services-disaster-recovery.md). Сведения о других вопросах доступности см. в разделе [Мобильные службы](./resiliency-technical-guidance-recovery-local-failures.md#mobile-services).

###HDInsight
Данные, связанные с HDInsight, по умолчанию сохраняются в хранилище BLOB-объектов Azure. Для HDInsight требуется, чтобы обрабатывающий задания MapReduce кластер Hadoop находился в том же регионе, что и учетная запись хранения, содержащая анализируемые данные. Используя функцию георепликации, доступную для службы хранилища Azure, вы можете получить доступ к своим данным в дополнительном регионе, в который они были реплицированы, если по какой-то причине основной регион больше недоступен. Вы можете создать кластер Hadoop в том регионе, в который были реплицированы данные, и продолжить их обработку. Сведения о других вопросах доступности см. в разделе [HDInsight](./resiliency-technical-guidance-recovery-local-failures.md#hdinsight).

###Служба отчетов SQL Reporting
В настоящее время для восстановления после потери региона Azure требуется наличие нескольких экземпляров службы SQL Reporting в разных регионах Azure. Эти экземпляры службы SQL Reporting должны получать доступ к одним и тем же данным, и эти данные должны иметь собственный план восстановления на случай аварии. Вы также можете создать внешние резервные копии RDL-файла для каждого отчета.

###Службы носителей
Для кодирования и потоковой передачи службы мультимедиа Azure используют разные способы восстановления. При региональном сбое, как правило, потоковая передача является более важной. Чтобы подготовиться к этому, вы должны иметь учетную запись служб мультимедиа в двух разных регионах Azure. Закодированное содержимое должно быть расположено в обоих регионах. Во время сбоя вы можете перенаправить потоковый трафик в альтернативный регион. Кодирование может выполняться в любом регионе Azure. Если для кодировки важно время выполнения, например во время обработки интерактивного события, вы должны быть готовы к отправке заданий в альтернативный центр обработки данных во время сбоев.

###Виртуальная сеть
Файлы конфигурации обеспечивают самый быстрый способ настройки виртуальной сети в альтернативном регионе Azure. После настройки виртуальной сети в основном регионе Azure [экспортируйте параметры текущей виртуальной сети](../virtual-network/virtual-networks-create-vnet-classic-portal.md) в файл конфигурации сети. При возникновении сбоя в основном регионе [восстановите виртуальную сеть](../virtual-network/virtual-networks-create-vnet-classic-portal.md) из сохраненного файла конфигурации. Затем настройте другие облачные службы, виртуальные машины или распределенные параметры для работы с новой виртуальной сетью.

##Контрольные списки для аварийного восстановления

##Контрольный список для облачных служб
  1. Просмотрите раздел [Облачные службы](#cloud-services) этой статьи.
  2. Создайте межрегиональную стратегию аварийного восстановления.
  3. Оцените преимущества и недостатки резервирования ресурсов в альтернативных регионах.
  4. Используйте средства маршрутизации трафика, такие как диспетчер трафика Azure.

##Контрольный список для виртуальных машин
  1. Просмотрите раздел [Виртуальные машины](#virtual-machines) этой статьи.
  2. Используйте [службу архивации Azure](https://azure.microsoft.com/services/backup/) для создания согласованных копий приложения по регионам.

##Контрольный список для хранилища
  1. См. раздел [Хранилище](#storage) в этой статье.
  2. Не отключайте георепликацию ресурсов хранилища.
  3. Определите альтернативный регион для георепликации на случай отработки отказа.
  4. Создайте пользовательские стратегии резервного копирования для управляемых пользователем стратегий отработки отказа.

##Контрольный список для базы данных SQL
  1. См. раздел [База данных](#sql-database) в этой статье.
  2. В зависимости от ситуации используйте [геовосстановление](../sql-database/sql-database-geo-restore.md) или [георепликацию](../sql-database/sql-database-geo-replication-overview.md).

##Контрольный список для SQL Server на виртуальных машинах
  1. Просмотрите раздел [SQL Server на виртуальных машинах](#sql-server-on-virtual-machines) этой статьи.
  2. Используйте межрегиональные группы доступности AlwaysOn или зеркальное отображение базы данных.
  3. Можно также использовать резервное копирование и восстановление в хранилище BLOB-объектов.

##Контрольный список для служебной шины
  1. Просмотрите раздел [Служебная шина](#service-bus) этой статьи.
  2. Настройте пространство имен служебной шины в альтернативном регионе.
  3. Рассмотрите пользовательские стратегии репликации для сообщений между регионами.

##Контрольный список для веб-приложений
  1. Просмотрите раздел [Веб-приложения](#web-apps) этой статьи.
  2. Сохраните резервные копии веб-сайта за пределами основного региона.
  3. Если сбой частичный, попробуйте получить доступ к текущему сайту при помощи протокола FTP.
  4. Спланируйте развертывание веб-сайта на новом или существующем веб-сайте в альтернативном регионе.
  5. Создайте план изменений конфигурации для приложения и для записей DNS CNAME.

##Контрольный список для мобильных служб
  1. Просмотрите раздел [Мобильные службы](#mobile-services) этой статьи.
  2. Создайте резервную мобильную службу в альтернативном регионе.
  3. Используйте управление резервными копиями связанной базы данных SQL Azure для восстановления при обработке отказа.
  4. Используйте программы командной строки Azure для перемещения мобильной службы.

##Контрольный список для HDInsight
  1. Просмотрите раздел [HDInsight](#hdinsight) этой статьи.
  2. Создайте новый кластер Hadoop в регионе с реплицированными данными.

##Контрольный список для службы SQL Reporting
  1. Просмотрите раздел [Служба SQL Reporting](#sql-reporting) этой статьи.
  2. Настройте альтернативный экземпляр службы SQL Reporting в другом регионе.
  3. Разработайте отдельный план для репликации целевых данных в этот регион.

##Контрольный список для служб мультимедиа
  1. Просмотрите раздел [Службы мультимедиа](#media-services) этой статьи.
  2. Создайте учетную запись служб мультимедиа в альтернативном регионе.
  3. Закодируйте одинаковое содержимое в обоих регионах для поддержки отработки отказа потоковой передачи.
  4. Отправьте задания кодирования в альтернативный регион в случае сбоя.

##Контрольный список для виртуальной сети
  1. Просмотрите раздел [Виртуальная сеть](#virtual-network) этой статьи.
  2. Используйте экспортированные параметры виртуальной сети, чтобы повторно создать ее в другом регионе.
 
##Дальнейшие действия
Этот материал входит в цикл статей, составляющих [техническое руководство по обеспечению устойчивости в Azure](./resiliency-technical-guidance.md). Следующая статья этого цикла посвящена [восстановлению из локального центра данных в Azure](./resiliency-technical-guidance-recovery-on-premises-azure.md).

<!---HONumber=AcomDC_0525_2016-->