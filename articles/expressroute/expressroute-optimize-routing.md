<properties
   pageTitle="Оптимизация маршрутизации ExpressRoute | Microsoft Azure"
   description="В этой статье приведены сведения о том, как оптимизировать маршрутизацию при наличии нескольких каналов ExpressRoute, с помощью которых устанавливается подключение между сетью Майкрософт и корпоративной сетью клиента."
   documentationCenter="na"
   services="expressroute"
   authors="charwen"
   manager="carmonm"
   editor=""/>
<tags
   ms.service="expressroute"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/26/2016"
   ms.author="charwen"/>

# Оптимизация маршрутизации ExpressRoute
При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам. Поэтому маршрутизация может быть неоптимальной, а это значит, что при передаче трафика из вашей сети в сеть Майкрософт и наоборот он будет проходить более длинный маршрут. А это, в свою очередь, может стать причиной возникновения длительной задержки, которая прямо влияет на производительность приложения и работу пользователей. В настоящей статье описана эта проблема и объясняется, как оптимизировать маршрутизацию с помощью стандартных технологий.

## Неоптимальная маршрутизация. Пример 1.
Рассмотрим проблему маршрутизации более детально на следующем примере. Предположим, что есть два офиса, расположенных в США: один — в Лос-Анджелесе, а другой — в Нью-Йорке. Эти офисы подключены к глобальной сети (WAN): либо к вашей собственной магистральной, либо к предоставленной поставщиком услуг VPN на базе IP-сети. У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной. Они также подключены к глобальной сети. Очевидно, что подключение к сети Майкрософт можно установить по двум каналам. А теперь представьте, что и в западной части США, и в восточной расположены службы Azure (например, службы приложений Azure). Вы хотите подключить пользователей в Лос-Анджелесе к региону "Западная часть США", а пользователей в Нью-Йорке — к региону "Восточная часть США", так как администратор служб сообщил, что пользователи офисов используют ближайший регион Azure для оптимальной работы. К сожалению, этот вариант оптимален только для пользователей восточного, но не западного побережья. Причина заключается в следующем. Для каждого канала ExpressRoute объявляются префиксы: 23.100.0.0/16 — для канала в регионе "Восточная часть США" и 13.100.0.0/16 — для канала в регионе "Западная часть США" Azure. Не зная, какой префикс относится к тому или иному региону, вы не сможете должным образом управлять маршрутизацией. Глобальная сеть может распознать префиксы в качестве относящихся ближе к региону "Восточная часть США", чем к "Западная часть США" и направить трафик пользователей обоих офисов по каналу ExpressRoute в восточной части США. В результате пользователи в Лос-Анджелесе будут недовольны качеством передачи данных.

![](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### Решение. Использование сообщества BGP
Чтобы оптимизировать маршрутизацию для обоих офисов, необходимо определить, какой префикс относится к региону Azure "Западная часть США", а какой — к региону "Восточная часть США". Эти сведения кодируются с использованием [значений сообществ BGP](expressroute-routing.md). Каждому региону Azure назначаются уникальные значения сообществ BGP, например 12076:51004 — восточной части США и 12076:51006 — западной. Теперь, определив префикс для каждого региона Azure, можно настроить канал ExpressRoute, который необходимо использовать. Так как для обмена сведениями маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP. В нашем примере для префикса 13.100.0.0/16 западной части США можно установить более высокое значение локального предпочтения, чем для префикса восточной части США, и точно так же можно установить более высокое значение локального предпочтения для префикса 23.100.0.0/16 восточной части США по сравнению с префиксом западной. Эта конфигурация гарантирует, что когда доступно два маршрута к сети Майкрософт, для подключения к региону Azure "Западная часть США" пользователи в Лос-Анджелесе будут использовать канал ExpressRoute в западной части США, и аналогично для подключения к региону "Восточная часть США" пользователи в Нью-Йорке будут использовать канал ExpressRoute в восточной части США. Это обеспечивает оптимальную маршрутизацию на обоих сторонах.

![](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

## Неоптимальная маршрутизация. Пример 2.
Рассмотрим еще один пример, когда подключения из сети Майкрософт проходят более длинный маршрут для подключения к вашей сети. В этом случае используются Exchange Online и локальные серверы Exchange в [гибридной среде](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx). Офисы подключены к глобальной сети. Для подключения к сети Майкрософт через каналы ExpressRoute объявлены префиксы локальных серверов обоих офисов. При переносе почтовых ящиков Exchange Online будет инициировать подключения к локальным серверам. К сожалению, подключение к офису в Лос-Анджелесе перенаправляется на канал ExpressRoute в восточной части США, а затем весь трафик передается через весь континент обратно на западное побережье. В этом случае причина та же, что и в первом примере. Без соответствующих настроек сеть Майкрософт не распознает, какой префикс относится к восточной части США, а какой — к западной. Возможно, что подключение к офису в Лос-Анджелесе будет установлено по неправильному каналу.

![](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### Решение. Использование атрибута AS PATH
Эту проблему можно решить двумя способами. Первый способ — это просто объявить локальный префикс канала в западной части США для офиса в Лос-Анджелесе (177.2.0.0/31) и в восточной части США для офиса в Нью-Йорке (177.2.0.2/31). В результате для подключения сети Майкрософт к каждому из офисов будет использоваться только один маршрут. Это позволяет избежать возможной неоднозначности и оптимизировать маршрутизацию. В этом случае следует обдумать стратегию отработки отказа. Если путь к сети Майкрософт через канал ExpressRoute по каким-либо причинам недоступен, необходимо убедиться, что Exchange Online может по-прежнему подключиться к вашим локальным серверам.

Второе решение — вам также необходимо объявить префикс для обоих каналов ExpressRoute и, кроме того, предоставить сведения о том, какой префикс используется для каждого офиса. Так как Майкрософт поддерживает использование атрибута AS Path BGP, с его помощью можно управлять маршрутизацией. В этом примере можно удлинить атрибут AS PATH для 172.2.0.0/31 в восточной части США, чтобы для передачи трафика, предназначенного для этого префикса, использовался канал ExpressRoute в западной части США (сеть Майкрософт будет определять маршрут к этому префиксу как более короткий в западной части.) Точно так же можно удлинить атрибут AS PATH для 172.2.0.2/31 в западной части США, чтобы использовать канал ExpressRoute в восточной части США. Это позволит оптимизировать маршрутизацию для обоих офисов. Если один из каналов ExpressRoute недоступен, подключение Exchange Online к вашей сети будет установлено через другой канал ExpressRoute и вашу глобальную сеть.

>[AZURE.IMPORTANT] Для префиксов, полученных в пиринге Майкрософт, частные номера AS в атрибуте AS PATH удаляются. Чтобы управлять маршрутизацией пиринга Майкрософт, в атрибут AS PATH необходимо добавить частные номера AS.

![](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

<!---HONumber=AcomDC_0601_2016-->