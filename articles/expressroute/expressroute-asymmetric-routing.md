.<properties
   pageTitle="Асимметричная маршрутизация | Microsoft Azure"
   description="В этой статье рассматриваются проблемы, которые могут возникнуть у клиента при асимметричной маршрутизации в сети, когда есть несколько подключений к целевому расположению."
   documentationCenter="na"
   services="expressroute"
   authors="osamazia"
   manager="carmonm"
   editor=""/>
<tags
   ms.service="expressroute"
   ms.devlang="na"
   ms.topic="get-started-article" 
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="08/23/2016"
   ms.author="osamazia"/>

# Асимметричная маршрутизация с помощью нескольких сетевых путей

В этой статье объясняется, как прямой и обратный трафик может проходить по разным маршрутам при наличии нескольких путей между исходным и целевым расположениями.

Чтобы понять, что такое асимметричная маршрутизация, необходимо рассмотреть два фактора. Первый — влияние нескольких сетевых путей. Второй — поведение устройств, сохраняющих состояние (например, брандмауэров). Они называются устройствами с отслеживанием состояния. Сочетание этих двух факторов создает сценарии, где устройства с отслеживанием состояния не пропускают трафик, который не проходил через них.

## Несколько сетевых путей

Когда в корпоративной сети есть только одно подключение к Интернету через поставщика услуг, весь трафик, поступающий из Интернета и обратно, проходит по одному пути. Часто компании приобретают несколько каналов в качестве избыточных путей, чтобы повысить работоспособность сети. В таких случаях бывает, что трафик из сети в Интернет проходит через одно подключение, а обратный трафик — через другое. Это явление, при котором прямой и обратный трафик проходят по разным путям, обычно называют асимметричной маршрутизацией.

![Маршрутизация 3](./media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

Хотя приведенное выше описание касается Интернета, оно применимо и к другим сочетаниям путей. Некоторые примеры: интернет-путь и частный путь к одному и тому же целевому расположению, несколько частных путей к одному и тому же целевому расположению и т. д.

Каждый маршрутизатор вычисляет оптимальный путь из исходного расположения в целевое с помощью расчетов. Определение лучшего возможного пути строится на двух основных факторах.

1.	Маршрутизация между внешними сетям реализуется с использованием протокола маршрутизации под названием BGP. BGP принимает объявления от соседей, запускает их в несколько этапов, чтобы определить лучший путь к целевому расположению, и устанавливает этот путь в свою таблицу маршрутизации.
2.	Длина маски подсети, связанной с маршрутом. При получении нескольких объявлений для одного IP-адреса, но с разными масками подсети, предпочтительным является объявление с более длинной маской подсети, потому что такой маршрут считается более конкретным.

## Устройства с отслеживанием состояния

Маршрутизаторы анализируют IP-заголовок пакета в рамках задач маршрутизации. Но существуют устройства, которые анализируют пакет более подробно. Обычно эти устройства рассматривают заголовки на уровне 4 (TCP/UDP) или даже на уровне 7 (слой приложения). Это либо устройства для обеспечения безопасности, либо устройства для оптимизации пропускной способности. Распространенным примером устройства с отслеживанием состояния является брандмауэр. Брандмауэр разрешает или запрещает прохождение пакетов через свои интерфейсы в зависимости от различных факторов, включая протокол, порт TCP/UDP и URL-заголовки. Эта проверка пакетов многократно увеличивает нагрузку на устройство. Для повышения производительности брандмауэр проверяет первый пакет из потока. Если пакет разрешен, брандмауэр сохраняет информацию о потоке в своей таблице состояний. Разрешение для всех последующих пакетов, связанных с этим потоком, зависит от первоначального решения. Таким образом, если в брандмауэр поступает пакет, который является частью существующего потока, но в брандмауэре отсутствует информация о предыдущем состоянии этого пакета, брандмауэр удаляет этот пакет.

## Асимметричная маршрутизация с помощью ExpressRoute

При подключении к Майкрософт через ExpressRoute в сеть вносятся следующие изменения.

1.	Существует несколько подключений к Майкрософт. Одно из них — существующее подключение к Интернету, а другое — подключение через ExpressRoute. Часть трафика, направляемого в Майкрософт, может проходить через Интернет, но возвращаться через ExpressRoute, и наоборот.
2.	Вам присваиваются более конкретные IP-адреса через ExpressRoute. Поэтому трафик из вашей сети в Microsoft, предназначенный для служб, предоставляемых через ExpressRoute, всегда будет проходить через ExpressRoute.

Чтобы понять влияние двух указанных выше пунктов, давайте рассмотрим несколько сценариев. Предположим, у вас есть только один канал для Интернета и вы используете все службы Майкрософт через Интернет. Трафик из вашей сети в Майкрософт и обратно проходит через одно и то же интернет-подключение, а также через брандмауэр. Брандмауэр фиксирует поток при обнаружении первого пакета и разрешает обратные пакеты, если поток записан в таблице состояний.

![Маршрутизация 1](./media/expressroute-asymmetric-routing/AsymmetricRouting1.png)


Теперь включите ExpressRoute для использования служб, предлагаемых корпорацией Майкрософт, через ExpressRoute. Все остальные службы Майкрософт будут и дальше использоваться через Интернет. Разверните отдельный брандмауэр на границе, подключенной к ExpressRoute. Корпорация Майкрософт объявит вашей сети более конкретные префиксы для определенных служб, используемых через ExpressRoute. Инфраструктура маршрутизации выберет ExpressRoute в качестве предпочтительного пути для этих префиксов. Если вы не объявляете Майкрософт общедоступные IP-адреса через ExpressRoute, Майкрософт будет взаимодействовать с вашими общедоступными IP-адресами через Интернет. Таким образом, прямой трафик из вашей сети в Майкрософт будет проходить через ExpressRoute, а обратный трафик из Майкрософт — через Интернет. Когда брандмауэр на границе обнаружит обратный пакет для потока, который отсутствует в таблице состояний, он не пропустит такой обратный трафик.

Если вы решили использовать один и тот же пул NAT для ExpressRoute и Интернета, вы увидите аналогичные проблемы у клиентов с частными IP-адресами в вашей сети. Запросы для служб, таких как Центр обновления Windows, будут проходить через Интернет, так как IP-адреса для этих служб не объявляются через ExpressRoute. Тем не менее обратный трафик будет проходить через ExpressRoute. Если корпорация Майкрософт получает IP-адрес с одной и той же маской подсети из Интернета и ExpressRoute, предпочтение отдается ExpressRoute. Если брандмауэр или другое устройство с отслеживанием состояния на границе между сетью и ExpressRoute не содержит предыдущих сведений о потоке, пакеты из этого потока будут удалены.

## Решения при асимметричной маршрутизации

Существует два основных способа для решения проблемы асимметричной маршрутизации. Один — с помощью маршрутизации, другой — с помощью преобразования сетевых адресов на основе источника (SNAT).

1. Маршрутизация

    - Убедитесь, что общедоступные IP-адреса объявляются для соответствующих подключений к глобальной сети. Например, если вы хотите использовать Интернет для трафика проверки подлинности, а ExpressRoute — для трафика электронной почты, не следует объявлять общедоступные IP-адреса ADFS через ExpressRoute. Точно так же локальный сервер ADFS не должен быть доступным для IP-адресов, полученных через ExpressRoute. Маршруты, полученные через ExpressRoute, указываются более конкретно, поэтому ExpressRoute будет предпочтительным путем для проверки подлинности трафика, направляемого в Майкрософт, что приведет к асимметричной маршрутизации.

    - Если вы хотите использовать ExpressRoute для проверки подлинности, необходимо убедиться в том, что общедоступные IP-адреса ADFS объявляются через ExpressRoute без NAT. Таким образом трафик из Майкрософт на локальный сервер ADFS будет проходить через ExpressRoute, а обратный трафик от клиента в Майкрософт — также через ExpressRoute, так как этот путь предпочтительнее в сравнении с Интернетом.

2. NAT на основе источника

	Еще один способ решения проблемы асимметричной маршрутизации — NAT на основе источника (SNAT). Например, вы не объявили общедоступный IP-адрес локального SMTP-сервера через ExpressRoute, намереваясь использовать для этого подключения Интернет. Запрос от Майкрософт на ваш локальный SMTP-сервер проходит через Интернет. С помощью SNAT входящий запрос перенаправляется на внутренний IP-адрес. Обратный трафик с SMTP-сервера будет направляться на пограничный межсетевой экран (используется для выполнения NAT) вместо ExpressRoute. Таким образом обратный трафик будет проходить через Интернет.


![Маршрутизация 2](./media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## Обнаружение асимметричной маршрутизации

Лучшим подтверждением того, что трафик проходит по ожидаемому пути, является трассировка маршрута. Если вы ожидаете, что трафик от вашего локального сервера в Майкрософт будет проходить через Интернет, выполните трассировку маршрута от SMTP-сервера в Office 365. Ее результат подтвердит, что трафик из вашей сети действительно направляется к Интернету, а не к ExpressRoute.

<!---HONumber=AcomDC_0824_2016-->