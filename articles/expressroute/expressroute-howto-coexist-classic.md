<properties
   pageTitle="Настройка сосуществующих подключений VPN типа ExpressRoute и ";сеть-сеть"; | Microsoft Azure"
   description="В этой статье описывается настройка параллельных подключений ExpressRoute и VPN типа ";сеть-сеть"; для классической модели развертывания."
   documentationCenter="na"
   services="expressroute"
   authors="cherylmc"
   manager="carmonm"
   editor=""
   tags="azure-service-management"/>
<tags
   ms.service="expressroute"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/08/2016"
   ms.author="cherylmc"/>

# Настройка параллельных подключений ExpressRoute и "сайт-сайт"

Возможность настройки VPN типа "сеть-сеть" и ExpressRoute дает целый ряд преимуществ. Можно настроить VPN типа "сеть-сеть" как защищенный путь отработки отказа для ExressRoute или использовать этот VPN для подключения к узлам, которые не входят в вашу сеть, но подключены через ExpressRoute. В этой статье мы рассмотрим порядок действия в каждом из этих вариантов. **В настоящее время эту конфигурацию можно создать только для виртуальных сетей с использованием классической модели развертывания**. Когда у нас появится документация по модели развертывания диспетчера ресурсов, мы добавим сюда ссылку на нее.


**О моделях развертывания Azure**

[AZURE.INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)]


Перед выполнением приведенных ниже инструкций необходимо настроить каналы ExpressRoute. Прежде чем следовать дальше, выполните инструкции по [созданию канала ExpressRoute](expressroute-howto-circuit-classic.md) и [настройке маршрутизации](expressroute-howto-routing-classic.md).

## Квоты и ограничения

- **Транзитная маршрутизация не поддерживается**. Нельзя настроить маршрутизацию (через Azure) от локальной сети, подключенной к сети VPN типа "сеть-сеть", до локальной сети, подключенной к сети ExpressRoute.
- **Соединение типа "точка-сеть" не поддерживается**. Невозможно включить подключения VPN "точка-сеть" к одной виртуальной сети, подключенной к ExpressRoute. VPN типа "точка-сеть" и ExpressRoute не могут существовать в одной и той же виртуальной сети.
- **Принудительное туннелирование нельзя включить на VPN-шлюзе "сеть-сеть".** Весь интернет-трафик можно только "принудительно" направить в локальную сеть через ExpressRoute. 
- **Только стандартные шлюзы или шлюзы высокой производительности.** Для шлюза ExpressRoute и VPN-шлюза типа "сеть-сеть" необходимо использовать стандартный шлюз или шлюз высокой производительности. Сведения о номерах SKU шлюзов см. в разделе [Номера SKU шлюзов](../vpn-gateway/vpn-gateway-about-vpngateways.md).
- **Требуется статическая маршрутизация**. Если локальная сеть подключена как к сети VPN ExpressRoute, так и к сети типа "сеть-сеть", необходимо иметь статический маршрут, определенный в локальной сети, для маршрутизации VPN-подключения типа "сеть-сеть" к Интернету.
- **Шлюз ExpressRoute необходимо настроить в первую очередь.** Шлюз ExpressRoute необходимо создать перед добавлением шлюза VPN типа "сеть-сеть".


## Схемы конфигурации

### Настройка VPN типа "сеть-сеть" как пути отработки отказа для ExpressRoute

VPN-подключение типа "сеть-сеть" можно настроить как службу архивации для ExpressRoute. Это относится только к виртуальным сетям, привязанным к пути пиринга Azure Private. Для служб, доступ к которым осуществляется через пиринг Azure Public или Microsoft, решения для отработки отказа на основе VPN не существует. Канал ExpressRoute всегда является основной ссылкой. Данные передаются по пути VPN типа "сеть-сеть" только в том случае, если канал ExpressRoute не справляется с этой задачей.

![Существуют одновременно](media/expressroute-howto-coexist-classic/scenario1.jpg)

### Настройка VPN типа "сеть-сеть" для подключения к сайтам, не подключенным через ExpressRoute

Сети можно настроить таким образом, чтобы одни из них подключались непосредственно к Azure по VPN типа "сеть-сеть", а другие — через ExpressRoute.

![Существуют одновременно](media/expressroute-howto-coexist-classic/scenario2.jpg)

>[AZURE.NOTE] Настроить виртуальную сеть как транзитный маршрутизатор нельзя.

## Выбор действий для использования

Существует два различных набора процедур для настройки сосуществующих подключений. Выбор процедуры настройки зависит от того, существует ли уже виртуальная сеть, к которой необходимо подключиться, или требуется создать новую виртуальную сеть.


- У меня нет виртуальной сети, и мне нужно ее создать
	
	Если у вас еще нет виртуальной сети, то, выполнив эту процедуру, вы сможете создать новую виртуальную сеть с помощью классической модели развертывания и новые подключения ExpressRoute и VPN типа "сеть-сеть". Для настройки выполните действия из раздела [Создание новой виртуальной сети и параллельных подключений](#new).

- У меня уже есть виртуальная сеть с классической моделью развертывания

	Возможно, у вас уже имеется виртуальная сеть, а также подключения к VPN типа "сеть-сеть" или к ExpressRoute. В разделе [Настройка параллельных подключений для существующей виртуальной сети](#add) описано, как удалить шлюз, а затем создать новое подключение ExpressRoute и VPN типа "сеть-сеть". Обратите внимание, что при создании новых подключений, необходимо выполнять действия в строго определенном порядке. При создании шлюзов и подключений не пользуйтесь инструкциями, взятыми из других статей.

	В этой процедуре для создания одновременно существующих подключений потребуется удалить имеющийся шлюз, а затем настроить новые шлюзы. Это означает, что у вас будет перерыв в работе подключений между организациями, на время удаления и повторного создания шлюза и подключений, но вам не потребуется выполнять миграцию всех виртуальных машин и служб в новую виртуальную сеть. Виртуальные машины и службы смогут по-прежнему осуществлять связь через балансировщик нагрузки во время настройки шлюза, если они настроены соответствующим образом.


## <a name ="new"/> Создание виртуальной сети и параллельных подключений

В этой процедуре подробно рассматривается создание виртуальной сети, а также параллельных подключений ExpressRoute и "сеть-сеть".

1. Вам потребуется установить последнюю версию командлетов PowerShell диспетчера ресурсов Azure. Дополнительную информацию об установке командлетов PowerShell см. в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md). Обратите внимание, что командлеты, которые будут использоваться для этой конфигурации, могут немного отличаться от знакомых вам. Обязательно используйте командлеты, указанные в инструкциях. 

2. Создайте схему для виртуальной сети. Дополнительные сведения о схеме конфигурации см. в статье [Схема конфигурации виртуальной сети Azure](https://msdn.microsoft.com/library/azure/jj157100.aspx).

	При создании схемы, убедитесь, что используются следующие значения.

	- Подсеть шлюза для виртуальной сети должна иметь значение /27 или более короткий префикс (например, /26 или /25).
	- Тип подключения шлюза — "выделенное".

		      <VirtualNetworkSite name="MyAzureVNET" Location="Central US">
		        <AddressSpace>
		          <AddressPrefix>10.17.159.192/26</AddressPrefix>
		        </AddressSpace>
		        <Subnets>
		          <Subnet name="Subnet-1">
		            <AddressPrefix>10.17.159.192/27</AddressPrefix>
		          </Subnet>
		          <Subnet name="GatewaySubnet">
		            <AddressPrefix>10.17.159.224/27</AddressPrefix>
		          </Subnet>
		        </Subnets>
		        <Gateway>
		          <ConnectionsToLocalNetwork>
		            <LocalNetworkSiteRef name="MyLocalNetwork">
		              <Connection type="Dedicated" />
		            </LocalNetworkSiteRef>
		          </ConnectionsToLocalNetwork>
		        </Gateway>
		      </VirtualNetworkSite>

3. После создания и настройки XML-файла схемы отправьте этот файл. Это будет созданием виртуальной сети.

	Чтобы отправить файл с измененными значениями, используйте следующий командлет.

		Set-AzureVNetConfig -ConfigurationPath 'C:\NetworkConfig.xml'

4. <a name ="gw"/>Создайте шлюз ExpressRoute. Не забудьте указать для номера SKU шлюза значение *Standard* или *HighPerformance*, а для типа шлюза — значение *DynamicRouting*.

	Используйте следующий пример, подставив собственные значения.

		New-AzureVNetGateway -VNetName MyAzureVNET -GatewayType DynamicRouting -GatewaySKU HighPerformance

5. Свяжите шлюз ExpressRoute с каналом ExpressRoute. После выполнения этого действия подключение локальной сети к Azure через ExpressRoute будет установлено.

		New-AzureDedicatedCircuitLink -ServiceKey <service-key> -VNetName MyAzureVNET

6. Далее создайте VPN-шлюз к сети типа "сеть-сеть". Номер SKU шлюза должен иметь значение *Standard* или *HighPerformance*, а тип шлюза должен быть *DynamicRouting*.

		New-AzureVirtualNetworkGateway -VNetName MyAzureVNET -GatewayName S2SVPN -GatewayType DynamicRouting -GatewaySKU  HighPerformance

	Чтобы получить параметры шлюза виртуальной сети, включая идентификатор шлюза и общедоступный IP-адрес, используйте командлет `Get-AzureVirtualNetworkGateway`.

		Get-AzureVirtualNetworkGateway

		GatewayId            : 348ae011-ffa9-4add-b530-7cb30010565e
		GatewayName          : S2SVPN
		LastEventData        :
		GatewayType          : DynamicRouting
		LastEventTimeStamp   : 5/29/2015 4:41:41 PM
		LastEventMessage     : Successfully created a gateway for the following virtual network: GNSDesMoines
		LastEventID          : 23002
		State                : Provisioned
		VIPAddress           : 104.43.x.y
		DefaultSite          :
		GatewaySKU           : HighPerformance
		Location             :
		VnetId               : 979aabcf-e47f-4136-ab9b-b4780c1e1bd5
		SubnetId             :
		EnableBgp            : False
		OperationDescription : Get-AzureVirtualNetworkGateway
		OperationId          : 42773656-85e1-a6b6-8705-35473f1e6f6a
		OperationStatus      : Succeeded

7. Создайте сущность VPN-шлюза локального сайта. Эта команда не настраивает локальный VPN-шлюз. Она только позволяет указать параметры локального шлюза, такие как общедоступный IP-адрес и локальное адресное пространство, чтобы VPN-шлюз Azure мог подключиться к нему.

	> [AZURE.IMPORTANT] Локальный сайт для подключения VPN типа "сеть-сеть" не определяется в netcfg. Этот командлет можно использовать только для указания параметров локального сайта. Его нельзя определить с помощью портала или файла netcfg.

	Используйте следующий пример, подставив собственные значения.

	`New-AzureLocalNetworkGateway -GatewayName MyLocalNetwork -IpAddress <MyLocalGatewayIp> -AddressSpace <MyLocalNetworkAddress>`

	> [AZURE.NOTE] Если в локальной сети есть несколько маршрутов, их все можно передать как массив. $MyLocalNetworkAddress = @("10.1.2.0/24","10.1.3.0/24","10.2.1.0/24")


	Чтобы получить параметры шлюза виртуальной сети, включая идентификатор шлюза и общедоступный IP-адрес, используйте командлет `Get-AzureVirtualNetworkGateway`. См. указанный ниже пример.

		Get-AzureLocalNetworkGateway

		GatewayId            : 532cb428-8c8c-4596-9a4f-7ae3a9fcd01b
		GatewayName          : MyLocalNetwork
		IpAddress            : 23.39.x.y
		AddressSpace         : {10.1.2.0/24}
		OperationDescription : Get-AzureLocalNetworkGateway
		OperationId          : ddc4bfae-502c-adc7-bd7d-1efbc00b3fe5
		OperationStatus      : Succeeded


8. Настройте локальное VPN-устройство для подключения к новому шлюзу. При настройке VPN-устройства используйте сведения, полученные на этапе 6. Дополнительные сведения о настройке VPN-устройства см. в разделе [Настройка VPN-устройства](../vpn-gateway/vpn-gateway-about-vpn-devices.md).

9. Свяжите VPN-шлюз к сети типа "сеть-сеть" в Azure с локальным шлюзом.

	В этом примере connectedEntityId — идентификатор локального шлюза, который можно узнать, выполнив `Get-AzureLocalNetworkGateway`. virtualNetworkGatewayId можно узнать с помощью командлета `Get-AzureVirtualNetworkGateway`. После выполнения этого действия подключение локальной сети к Azure через сеть VPN типа "сеть-сеть" будет установлено.


	`New-AzureVirtualNetworkGatewayConnection -connectedEntityId <local-network-gateway-id> -gatewayConnectionName Azure2Local -gatewayConnectionType IPsec -sharedKey abc123 -virtualNetworkGatewayId <azure-s2s-vpn-gateway-id>`

## <a name ="add"/> Настройка параллельных подключений для существующей виртуальной сети

При наличии существующей виртуальной сети, подключенной через сеть VPN ExpressRoute или сеть типа "сеть-сеть", чтобы установить подключение к существующей виртуальной сети, необходимо сначала удалить существующий шлюз. Это означает, что локальные пользователи потеряют подключение к виртуальной сети через шлюз на время выполнения этой настройки.

**Перед началом настройки.** Убедитесь, что у вас достаточно свободных IP-адресов в виртуальной сети, и соответственно можно увеличить размер подсети шлюза. Обратите внимание, что вам придется удалить шлюз и создать его повторно, даже при наличии достаточного количества IP-адресов. Это вызвано тем, что при повторном создании шлюза будут учтены параллельные подключения.

1. Вам потребуется установить последнюю версию командлетов PowerShell диспетчера ресурсов Azure. Дополнительную информацию об установке командлетов PowerShell см. в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md). Обратите внимание, что командлеты, которые будут использоваться для этой конфигурации, могут немного отличаться от знакомых вам. Обязательно используйте командлеты, указанные в инструкциях. 

2. Удалите существующий VPN-шлюз к сети типа "сеть-сеть". Используйте командлет, приведенный ниже, подставив свои собственные значения.

	`Remove-AzureVNetGateway –VnetName MyAzureVNET`

3. Экспортируйте схему виртуальной сети. Используйте командлет PowerShell, приведенный ниже, подставив свои собственные значения.

	`Get-AzureVNetConfig –ExportToFile “C:\NetworkConfig.xml”`

4. Измените схему файла конфигурации сети так, чтобы подсеть шлюза имела значение /27 или более короткий префикс (например, /26 или /25). См. указанный ниже пример. Дополнительные сведения о схеме конфигурации см. в статье [Схема конфигурации виртуальной сети Azure](https://msdn.microsoft.com/library/azure/jj157100.aspx).

          <Subnet name="GatewaySubnet">
            <AddressPrefix>10.17.159.224/27</AddressPrefix>
          </Subnet>

5. Если ранее шлюз был к сети VPN типа «сеть-сеть», необходимо также изменить тип подключения на **выделенный**.

		         <Gateway>
		          <ConnectionsToLocalNetwork>
		            <LocalNetworkSiteRef name="MyLocalNetwork">
		              <Connection type="Dedicated" />
		            </LocalNetworkSiteRef>
		          </ConnectionsToLocalNetwork>
		        </Gateway>

6. На этом этапе вы будете иметь виртуальную сеть без шлюзов. Для создания новых шлюзов и выполнения подключений можете продолжить действие [Шаг 4. Создание шлюза ExpressRoute](#gw) из предыдущего набора действий.

## Дальнейшие действия

Дополнительную информацию об ExpressRoute см. в статье [Часто задаваемые вопросы об ExpressRoute](expressroute-faqs.md).

<!---HONumber=AcomDC_0309_2016-->