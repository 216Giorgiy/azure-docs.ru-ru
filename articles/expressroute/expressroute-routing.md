---
title: Требования к маршрутизации для Azure ExpressRoute | Документация Майкрософт
description: На этой странице подробно описаны требования по настройке маршрутизации для каналов ExpressRoute и управлению этой маршрутизацией.
documentationcenter: na
services: expressroute
author: ganesr
manager: ganesr
editor: ''
ms.assetid: 5b382e79-fa3f-495a-a764-c5ff86af66a2
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/28/2018
ms.author: ganesr
ms.openlocfilehash: b0c8be546b40b36746224ca43c7766ac310fd7ee
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32178761"
---
# <a name="expressroute-routing-requirements"></a>Требования ExpressRoute к маршрутизации
Для подключения к облачным службам Майкрософт с помощью ExpressRoute необходимо настроить маршрутизацию и управлять ею. Некоторые поставщики услуг подключения предлагают настройку маршрутизации как управляемой службы и управление этой службой. Узнайте у поставщика услуг подключения, предоставляет ли он такую услугу. В противном случае необходимо выполнить требования, указанные ниже:

Описание сеансов маршрутизации, которые необходимо настроить для установки подключения, см. в статье [Каналы ExpressRoute и домены маршрутизации](expressroute-circuit-peerings.md).

> [!NOTE]
> Майкрософт не поддерживает применение протоколов избыточности маршрутизаторов (например, HSRP, VRRP) в конфигурациях высокой доступности. Для обеспечения высокой доступности мы используем избыточную пару сеансов BGP на каждый пиринг.
> 
> 

## <a name="ip-addresses-used-for-peerings"></a>IP-адреса для пирингов
Для настройки маршрутизации между сетью и концевыми маршрутизаторами Microsoft Enterprise (MSEE) необходимо зарезервировать несколько блоков IP-адресов. В этом разделе приводится список требований и описание правил получения и использования этих IP-адресов.

### <a name="ip-addresses-used-for-azure-private-peering"></a>IP-адреса для частного пиринга Azure
Для настройки пиринга можно использовать либо частные, либо общедоступные IP-адреса. Диапазон адресов, используемых для настройки маршрутов, не должен пересекаться с диапазонами адресов, используемых для создания виртуальных сетей в Azure. 

* Для маршрутизации интерфейсов необходимо зарезервировать подсеть /29 или две подсети /30.
* В качестве используемых подсетей можно использовать либо частные, либо общедоступные IP-адреса.
* Подсети не должны конфликтовать с диапазоном, зарезервированным клиентом для использования в облаке Майкрософт.
* Если используется подсеть /29, ее можно разбить на две подсети /30. 
  * Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
  * Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
  * [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.  

#### <a name="example-for-private-peering"></a>Пример для частного пиринга
Если вы решите использовать для настройки пиринга подсеть a.b.c.d/29, она будет разделена на две подсети /30. В приведенном ниже примере мы рассмотрим, как используется подсеть a.b.c.d/29. 

Подсеть a.b.c.d/29 будет разбита на подсети a.b.c.d/30 и a.b.c.d+4/30 и передана в Майкрософт путем подготовки API. Подсеть a.b.c.d+1 будет использоваться как IP-адрес VRF для основного PE, а Майкрософт будет использовать подсеть a.b.c.d+2 как IP-адрес VRF для основного MSEE. Подсеть a.b.c.d+5 будет использоваться как IP-адрес VRF для дополнительного PE, а Майкрософт будет использовать подсеть a.b.c.d+6 как IP-адрес VRF для дополнительного MSEE.

Допустим, вы выбрали подсеть 192.168.100.128/29 для настройки частного пиринга. Подсеть 192.168.100.128/29 включает адреса с 192.168.100.128 по 192.168.100.135, причем:

* Подсеть 192.168.100.128/30 назначается связи link1, поставщик услуг подключения использует адрес 192.168.100.129, а Майкрософт — адрес 192.168.100.130.
* Подсеть 192.168.100.132/30 назначается связи link2, поставщик услуг подключения использует адрес 192.168.100.133, а Майкрософт — адрес 192.168.100.134.

### <a name="ip-addresses-used-for-azure-public-peering"></a>IP-адреса для общедоступного пиринга Azure
Для настройки сеансов BGP используйте принадлежащие вам общедоступные IP-адреса. У Майкрософт должна быть возможность проверить владельца IP-адреса по региональному интернет-реестру или интернет-реестру маршрутизации. 

* При настройке сеансов BGP для каждого пиринга в канале ExpressRoute (если их несколько) необходимо использовать уникальную подсеть /29 или две подсети /30. 
* Если используется подсеть /29, ее можно разбить на две подсети /30. 
  * Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
  * Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
  * [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.

### <a name="ip-addresses-used-for-microsoft-peering"></a>IP-адреса, используемые для пиринга Майкрософт
Для настройки сеансов BGP используйте принадлежащие вам общедоступные IP-адреса. У Майкрософт должна быть возможность проверить владельца IP-адреса по региональному интернет-реестру или интернет-реестру маршрутизации.

* При настройке сеансов BGP для каждого пиринга в канале ExpressRoute (если их несколько) необходимо использовать уникальную подсеть /29 (IPv4) или /125 (IPv6) либо две подсети /30 (IPv4) или /126 (IPv6).
* Если используется подсеть /29, ее можно разбить на две подсети /30.
* Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
* Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
* Если используется подсеть /125, ее можно разбить на две подсети /126.
* Первая подсеть /126 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
* Для каждой из подсетей /126 необходимо передать в маршрутизатор первый IP-адрес подсети /126. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /126.
* [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.

## <a name="public-ip-address-requirement"></a>Использование общедоступного IP-адреса

### <a name="private-peering"></a>Частный пиринг
Для частного пиринга можно использовать как частные, так и общедоступные адреса IPv4. Мы обеспечиваем сквозную изоляцию трафика, поэтому в случае частного пиринга перекрытие адресов другими клиентами исключено. Такие адреса не объявляются в Интернете. 


### <a name="public-peering"></a>Общедоступный пиринг
Путь общедоступного пиринга Azure позволяет подключаться ко всем службам, размещенным в Azure, по их открытым IP-адресам. Сюда входят службы, перечисленные в статье [Вопросы и ответы по ExpessRoute](expressroute-faqs.md), а также все службы, размещенные независимыми поставщиками программного обеспечения в Microsoft Azure. Подключение к службам Microsoft Azure через общедоступный пиринг всегда осуществляется от локальной сети к сети Microsoft. Необходимо использовать общедоступные IP-адреса для трафика, предназначенного для сети Microsoft.

> [!IMPORTANT]
> Все службы Azure PaaS также доступны через пиринг Майкрософт. Рекомендуется создать пиринг Майкрософт и подключиться через него к службам Azure PaaS.  
>   


Частный номер AS разрешен с общедоступным пирингом.

### <a name="microsoft-peering"></a>Пиринг Майкрософт
Путь пиринга Майкрософт позволяет подключаться к облачным службам Майкрософт, которые не поддерживаются по пути общедоступного пиринга Azure. В список этих служб входят службы Office 365, такие как Exchange Online, SharePoint Online, Skype для бизнеса и Dynamics 365. Корпорация Майкрософт поддерживает двустороннее подключение через пиринг Майкрософт. Входящий трафик облачных служб Майкрософт перед попаданием в сеть Майкрософт должен пройти через действительные общедоступные IPv4-адреса.

Убедитесь, что ваш IP-адрес и число AS зарегистрированы на ваше имя в одном из следующих реестров:


* [ARIN](https://www.arin.net/)
* [APNIC](https://www.apnic.net/)
* [AFRINIC](https://www.afrinic.net/)
* [LACNIC](http://www.lacnic.net/)
* [RIPENCC](https://www.ripe.net/)
* [RADB](http://www.radb.net/)
* [ALTDB](http://altdb.net/)

Если префиксы и номер AS не присвоены вам в предыдущих реестрах, нужно отправить запрос в службу поддержки, чтобы специалисты вручную проверили ваши префиксы и ASN. Им потребуется документация, такая как письмо проверки подлинности, которое доказывает, что вам разрешено использовать ресурсы.

Частный номер AS разрешен с пирингом Майкрософт, однако также потребуется проверка вручную. Кроме того, для полученных префиксов частные номера AS в атрибуте AS PATH удаляются. Вследствие этого вы не можете добавлять частные номера AS в атрибут AS PATH, чтобы [управлять маршрутизацией пиринга Майкрософт](expressroute-optimize-routing.md). 

> [!IMPORTANT]
> Общедоступные IP-адреса, объявленные для корпорации Майкрософт через ExpressRoute, не должны быть объявлены в Интернете. Это может привести к разрыву подключения к другим службам Microsoft. Тем не менее общедоступные IP-адреса, которые используются сетевыми серверами, взаимодействующими с конечными точками Office 365 в корпорации Майкрософт, могут быть доступны через ExpressRoute. 
> 
> 

## <a name="dynamic-route-exchange"></a>Динамический обмен маршрутами
Обмен маршрутами осуществляется по протоколу eBGP. Сеансы EBGP устанавливаются между MSEEs и вашими маршрутизаторами. Проверка подлинности сеансов BGP не требуется. При необходимости можно настроить MD5-хэш. Сведения о настройке сеансов BGP приведены в статьях [Создание и изменение маршрутизации для канала ExpressRoute](expressroute-howto-routing-classic.md) и [Процедуры ExpressRoute для подготовки каналов и состояний каналов](expressroute-workflows.md).

## <a name="autonomous-system-numbers"></a>Номера автономных систем (AS)
Майкрософт использует AS 12076 для общедоступного и частного пиринга Azure, а также пиринга Майкрософт. Номера AS с 65515 по 65520 зарезервированы для внутреннего использования. Поддерживаются 16- и 32-битные номера AS.

Требования к симметрии передачи данных не предъявляются. Прямые и обратные пути могут проходить по разным парам маршрутов. С каждой стороны в различных принадлежащих вам парах каналов должны быть объявлены идентичные маршруты. Метрики маршрута могут не совпадать.

## <a name="route-aggregation-and-prefix-limits"></a>Статистическая обработка маршрутов и ограничения префиксов
Мы поддерживаем до 4000 префиксов, объявляемых через частный пиринг Azure. При включении надстройки ExpressRoute Premium это число можно увеличить до 10 000 префиксов. Мы принимаем до 200 префиксов на сеанс BGP для общедоступного пиринга Azure и пиринга Майкрософт. 

Если количество префиксов превысит лимит, сеанс BGP будет сброшен. Маршруты по умолчанию принимаются только по связи частного пиринга. Поставщик должен отфильтровывать маршрут по умолчанию и частные IP-адреса (RFC 1918) от путей общедоступного пиринга Azure и пиринга Майкрософт. 

## <a name="transit-routing-and-cross-region-routing"></a>Транзитная и межрегиональная маршрутизация
ExpressRoute нельзя настроить как транзитный маршрутизатор. За услугами транзитной маршрутизации данных обращайтесь к поставщику услуг подключения.

## <a name="advertising-default-routes"></a>Объявление маршрутов по умолчанию
Маршруты по умолчанию разрешены только для сеансов частного пиринга Azure. В данном случае мы будем направлять весь трафик из связанных виртуальных сетей в вашу сеть. Объявление маршрутов по умолчанию в частный пиринг вызовет блокировку внутреннего пути из Azure. Для направления входящего и исходящего интернет-трафика служб, размещенных в Azure, используйте ресурсы своей корпоративной сети. 

 Для подключения к другим услугам и инфраструктурным службам Azure требуется соблюдение одного из следующих условий:

* общедоступный пиринг Azure включен для направления трафика в общедоступные конечные точки;
* маршрутизация определяется пользователем, что обеспечивает интернет-подключение к каждой подсети, требующей подключения к Интернету.

> [!NOTE]
> Объявление маршрутов по умолчанию аннулирует действие лицензий Windows и других виртуальных машин. Чтобы решить эту проблему, выполните [данные инструкции](http://blogs.msdn.com/b/mast/archive/2015/05/20/use-azure-custom-routes-to-enable-kms-activation-with-forced-tunneling.aspx) .
> 
> 

## <a name="bgp"></a>Поддержка сообществ BGP
Этот раздел содержит общие сведения об использовании сообществ BGP с ExpressRoute. Майкрософт объявляет маршруты в путях общедоступного пиринга и пиринга Microsoft с маршрутами, помеченными значениями соответствующего сообщества. Для чего это нужно и что такое значения сообществ, рассмотрим ниже. При этом Майкрософт не учитывает значения сообществ, которыми помечены маршруты, объявленные для Майкрософт.

Подключившись к Майкрософт через ExpressRoute в любом расположении пиринга в геополитической области, вы получите доступ ко всем облачным службам Майкрософт во всех регионах этой геополитической области. 

Например, подключившись через ExpressRoute к Майкрософт в Амстердаме, вы получите доступ ко всем облачным службам Майкрософт, размещенным в Северной и Западной Европе. 

Подробный список геополитических регионов, связанных с ними регионов Azure и расположений соответствующих пирингов ExpressRoute см. на странице [Партнеры и одноранговые расположения ExpressRoute](expressroute-locations.md).

Вы можете приобрести больше одного канала ExpressRoute на каждый геополитический регион. За счет геоизбыточности наличие нескольких подключений даст вам более высокий уровень доступности. Имея несколько каналов ExpressRoute, вы будете получать тот же набор префиксов, который объявляется из Майкрософт для путей общедоступного пиринга Azure и пиринга Майкрософт. Это означает, что из вашей сети в Майкрософт будет вести сразу несколько путей. В такой ситуации есть вероятность, что ваша сеть будет выбирать маршрутизацию не самым оптимальным образом, а значит, подключение к некоторым службам может оказаться недостаточно надежным. Значения сообществ помогут вам правильно сделать выбор и обеспечить своим пользователям [оптимальную маршрутизацию](expressroute-optimize-routing.md).

| **Регион Microsoft Azure** | **Значение сообщества BGP** |
| --- | --- |
| **Северная Америка** | |
| Восток США | 12076:51004 |
| Восток США 2 | 12076:51005 |
| Запад США | 12076:51006 |
| Западный регион США 2 | 12076:51026 |
| Западно-центральная часть США | 12076:51027 |
| Северо-центральный регион США | 12076:51007 |
| Южно-центральный регион США | 12076:51008 |
| Центральный регион США | 12076:51009 |
| Центральная Канада | 12076:51020 |
| Восточная Канада | 12076:51021 |
| **Северная Америка** | |
| Южная часть Бразилии | 12076:51014 |
| **Европа** | |
| Северная Европа | 12076:51003 |
| Западная Европа | 12076:51002 |
| Южная часть Великобритании | 12076:51024 |
| Западная часть Великобритании | 12076:51025 |
| Центральная Франция | 12076:51030 |
| Южная Франция | 12076:51031 |
| **Азиатско-Тихоокеанский регион** | |
| Восточная Азия | 12076:51010 |
| Юго-Восточная Азия | 12076:51011 |
| **Япония** | |
| Восточная часть Японии | 12076:51012 |
| Западная часть Японии | 12076:51013 |
| **Австралия** | |
| Восточная часть Австралии | 12076:51015 |
| Юго-Восточная часть Австралии | 12076:51016 |
| **Государственные организации Австралии** | |
| Центральная Австралия | 12076:51032 |
| Центральная Австралия 2 | 12076:51033 |
| **Индия** | |
| Южная Индия | 12076:51019 |
| Западная Индия | 12076:51018 |
| Центральная Индия | 12076:51017 |
| **Корея** | |
| Южная Корея | 12076:51028 |
| Центральная Корея | 12076:51029 |


Все объявляемые Майкрософт маршруты будут помечаться значением соответствующего сообщества. 

> [!IMPORTANT]
> В глобальные префиксы добавляется соответствующее значение сообщества.
> 
> 

Наряду с вышеизложенным Майкрософт будет также помечать префиксы в зависимости от того, к какой службе они относятся. Это правило действует только для пиринга Майкрософт. В представленной ниже таблице показано сопоставление служб и значений сообществ BGP.

| **Служба** | **Значение сообщества BGP** |
| --- | --- |
| Exchange Online | 12076:5010 |
| SharePoint Online | 12076:5020 |
| Skype для бизнеса Online | 12076:5030 |
| Dynamics 365 | 12076:5040 |
| Другие онлайн-службы Office 365 | 12076:5100 |

> [!NOTE]
> Майкрософт не учитывает установленные вами значения сообществ BGP в маршрутах, объявленных для Майкрософт.
> 
> 

### <a name="bgp-community-support-in-national-clouds-preview"></a>Поддержка сообщества BGP в национальных облаках (предварительная версия)

| **Регион Azure для национальных облаков**| **Значение сообщества BGP** |
| --- | --- |
| **Правительство США** |  |
| Аризона (для обслуживания государственных организаций США) | 12076:51106 |
| Правительство штата Айова | 12076:51109 |
| Правительство штата Вирджиния | 12076:51105 |
| Техас (для обслуживания государственных организаций США) | 12076:51108 |
| Центральная часть US DoD | 12076:51209 |
| Восточная часть US DoD | 12076:51205 |


| **Служба в национальных облаках** | **Значение сообщества BGP** |
| --- | --- |
| **Правительство США** |  |
| Exchange Online |12076:5110 |
| SharePoint Online |12076:5120 |
| Skype для бизнеса Online |12076:5130 |
| Dynamics 365 |12076:5140 |
| Другие онлайн-службы Office 365 |12076:5200 |

## <a name="next-steps"></a>Дополнительная информация
* Настройте подключение ExpressRoute.
  
  * [Создание и изменение канала ExpressRoute с помощью PowerShell](expressroute-howto-circuit-arm.md)
  * [Создание и изменение пиринга для канала ExpressRoute с помощью PowerShell](expressroute-howto-routing-arm.md)
  * [Связывание виртуальной сети с каналом ExpressRoute](expressroute-howto-linkvnet-arm.md)
