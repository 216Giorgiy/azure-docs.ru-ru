---
title: Планирование загрузки кластера Service Fabric | Документация Майкрософт
description: Рекомендации по планированию загрузки кластера Service Fabric. Типы узлов, операции, устойчивость и уровни надежности
services: service-fabric
documentationcenter: .net
author: ChackDan
manager: timlt
editor: ''
ms.assetid: 4c584f4a-cb1f-400c-b61f-1f797f11c982
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/04/2018
ms.author: chackdan
ms.openlocfilehash: 78cff3ba5bd2f8bc80f302a232e45864159ca88f
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34641889"
---
# <a name="service-fabric-cluster-capacity-planning-considerations"></a>Рекомендации по планированию загрузки кластера Service Fabric
Для любой рабочей развернутой службы важным шагом является планирование загрузки. Ниже приведено несколько факторов, которые необходимо учитывать при этом.

* Количество типов узлов, с которыми создается кластер
* Свойства каждого типа узла (размер, первичный узел, доступ к Интернету, количество виртуальных машин и т. п.).
* Надежность и устойчивость характеристик кластера.

Кратко рассмотрим каждый из пунктов.

## <a name="the-number-of-node-types-your-cluster-needs-to-start-out-with"></a>Количество типов узлов, с которыми создается кластер
Во-первых, необходимо выяснить, для чего будет использоваться создаваемый кластер  и какие виды приложений планируется в нем развернуть. Если назначение кластера не ясно, скорее всего, вы еще не готовы перейти к планированию загрузки.

Определите количество типов узлов, с которыми нужно создать кластер.  Каждый тип узла соответствует набору масштабирования виртуальных машин. Каждый тип узла поддерживает возможность независимого масштабирования, имеет разные наборы открытых портов и собственные метрики емкости. Поэтому решение о числе типов узлов, в сущности, сводится к следующему.

* Есть ли у вашего приложения несколько служб, среди которых есть службы, которые должны быть общедоступными или доступными из Интернета? Типичные приложения содержат интерфейсную службу шлюза, которая получает входные данные от клиента, и одну или несколько внутренних служб, взаимодействующих с интерфейсными службами. Поэтому в этом случае требуется как минимум два типа узлов.
* У служб (составляющих приложение) различные требования к инфраструктуре, например больше ОЗУ или тактов центрального процессора? Предположим, что приложение, которое вам необходимо развернуть, содержит интерфейсную и внутреннюю службы. Интерфейсная служба может выполняться на виртуальных машинах меньшего размера (например, D2) с портами, открытыми для доступа через Интернет.  Однако внутренняя служба, которая будет выполнять вычисления, должна размещаться на более крупных виртуальных машинах (D4, D6, D15) без выхода в Интернет.
  
  Хотя вы можете поместить все эти службы на узлы одного типа, в этом примере их лучше всего поместить в кластер с двумя типами узлов.  Так у каждого типа узла будут свои собственные свойства, например возможность подключения к Интернету или размер виртуальной машины. Кроме того, можно будет независимо менять число виртуальных машин.  
* Так как нельзя предсказать будущее, исходите из известных вам фактов и выберите, какое число типов узлов требуется, чтобы начать использовать приложения. Вы всегда сможете добавить или удалить типы узлов позже. У кластера Service Fabric должен быть по крайней мере один тип узла.

## <a name="the-properties-of-each-node-type"></a>Свойства каждого типа узла
**Тип узла** можно считать эквивалентом роли в облачных службах. Он определяет размер виртуальных машин, их количество и свойства. Каждый тип узла, определенный в кластере Service Fabric, сопоставляется c [масштабируемым набором виртуальных машин](https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview).  
Каждый тип узла — это отдельный масштабируемый набор, который поддерживает возможность независимого увеличения или уменьшения масштаба, имеет разные наборы открытых портов и собственные метрики емкости. Дополнительные сведения о связях между типами узлов и масштабируемыми наборами виртуальных машин, о подключении по протоколу удаленного рабочего стола к одному из экземпляров, об открытии новых портов и многом другом см. в [этой статье](service-fabric-cluster-nodetypes.md).

Кластер Service Fabric может состоять из нескольких типов узлов. При этом кластер состоит из одного основного узла и одного или нескольких дополнительных.

### <a name="primary-node-type"></a>Тип первичного узла

Системные службы Service Fabric (например, служба диспетчера кластера или службы хранилища образов) помещаются в основной узел. 

![Снимок экрана с двумя типами узлов][SystemServices]

* **Минимальный размер виртуальных машин** для типа первичного узла зависит от выбранного **уровня устойчивости**. Значение по умолчанию для уровня устойчивости — Bronze. Дополнительные сведения см. в разделе [Характеристики устойчивости кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).  
* **Минимальное количество виртуальных машин** для типа первичного узла зависит от выбранного **уровня надежности**. Значение по умолчанию для уровня надежности — Silver. Дополнительные сведения см. в разделе [Характеристики устойчивости кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-reliability-characteristics-of-the-cluster).  

В шаблоне Azure Resource Manager основной тип узла настраивается с помощью атрибута `isPrimary` в [определении типа узла](https://docs.microsoft.com/en-us/azure/templates/microsoft.servicefabric/clusters#nodetypedescription-object).

### <a name="non-primary-node-type"></a>Тип вторичного узла

В кластере с несколькими типами узлов имеется один тип основного узла, а остальные — дополнительные.

* **Минимальный размер виртуальных машин** для типов дополнительных узлов зависит от выбранного **уровня устойчивости**. Значение по умолчанию для уровня устойчивости — Bronze. Дополнительные сведения см. в разделе [Характеристики устойчивости кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).  
* **Минимальное количество виртуальных машин** для типов дополнительных узлов — одна. Тем не менее это число следует выбирать, руководствуясь количеством реплик приложения или служб, которые вы хотите запустить на узле этого типа. После развертывания кластера число виртуальных машин для типа узла можно увеличить.

## <a name="the-durability-characteristics-of-the-cluster"></a>Характеристики устойчивости кластера
Уровень устойчивости используется, чтобы указать системе привилегии, имеющиеся у виртуальных машин в базовой инфраструктуре Azure. Для типа первичного узла эта привилегия позволяет Service Fabric приостановить любой запрос инфраструктуры на уровне виртуальной машины (например, перезагрузку, переустановку из образа или перенос виртуальной машины), который влияет на требования к кворуму, установленные для системных служб и ваших служб с отслеживанием состояния. Для типов вторичных узлов эта привилегия позволяет Service Fabric приостановить любой запрос инфраструктуры на уровне виртуальной машины (например, перезагрузку, переустановку из образа и перенос виртуальной машины), который влияет на требования к кворуму, установленные для ваших служб с отслеживанием состояния.

| Уровень устойчивости  | Необходимое минимальное количество виртуальных машин | Поддерживаемые номера SKU виртуальных машин                                                                  | Обновления, внесенные в VMSS                               | Обновления и обслуживание, инициированные Azure                                                              | 
| ---------------- |  ----------------------------  | ---------------------------------------------------------------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| Gold             | 5                              | Номера SKU с полными узлами, выделенные для одного клиента (например, L32s, GS5, G5, DS15_v2, D15_v2) | Можно отложить до утверждения кластером Service Fabric | Можно приостановить в течение 2 часов для UD, чтобы предоставить репликам дополнительное время на восстановление после более ранних сбоев |
| Silver           | 5                              | Виртуальные машины с одним или несколькими ядрами                                                        | Можно отложить до утверждения кластером Service Fabric | Задержка на любой значительный период времени невозможна                                                    |
| Bronze           | 1                              | Все                                                                                | Не будет задержано кластером Service Fabric           | Задержка на любой значительный период времени невозможна                                                    |

> [!WARNING]
> Типы узлов, выполняющиеся с устойчивостью Bronze, _не получают привилегий_. Это означает, что задания инфраструктуры, которые влияют на рабочие нагрузки без отслеживания состояния, не будут остановлены или отложены, что может повлиять на рабочие нагрузки. Используйте уровень устойчивости Bronze для типов узлов, на которых выполняются только рабочие нагрузки без учета состояния. Для рабочих нагрузок рекомендуется использовать Silver или более высокий уровень. 
>

**Преимущества использования уровней устойчивости Silver или Gold**
 
- Сокращение обязательных действий в операции свертывания (т. е. деактивация узла и Remove-ServiceFabricNodeState вызываются автоматически).
- Уменьшение риска потери данных из-за операций инфраструктуры Azure или инициированных клиентом внутренних операций изменения номера SKU виртуальной машины.

**Недостатки использования уровней устойчивости Silver или Gold**
 
- Развертывания в масштабируемый набор виртуальных машин (и другие связанные ресурсы Azure) могут быть задержаны, просрочены или полностью заблокированы из-за проблем в кластере или на уровне инфраструктуры. 
- Увеличивается число [событий жизненного цикла реплики](service-fabric-reliable-services-lifecycle.md) (например, переключений первичного узла) из-за автоматизированной деактивации узлов во время операций инфраструктуры Azure.
- Узлы становятся недоступны в периоды обновления программного обеспечения платформы Azure или обслуживания оборудования. Во время этих операций вы можете видеть узлы в состоянии "Идет отключение" или "Отключено". При этом временно уменьшается размер кластера, но это не должно влиять на доступность кластера или приложений.

### <a name="recommendations-for-when-to-use-silver-or-gold-durability-levels"></a>Рекомендации по использованию уровней устойчивости Silver или Gold

Используйте уровни устойчивости Silver или Gold для всех типов узлов со службами с отслеживанием состояния, предполагающими частое свертывание (уменьшение числа экземпляров виртуальных машин), если вам предпочтительнее задержка операций развертывания и уменьшение емкости за счет упрощения этих операций свертывания. Сценарии развертывания (добавления экземпляров виртуальных машин) не влияют на выбор уровня устойчивости, только сценарии свертывания.

### <a name="changing-durability-levels"></a>Изменение уровней надежности
- Для типов узлов нельзя изменить уровни устойчивости с Silver или Gold на Bronze.
- Обновление с Bronze до Silver или Gold может занять несколько часов.
- Изменяя уровень устойчивости, не забудьте обновить его в конфигурации расширения Service Fabric в ресурсе масштабируемого набора виртуальных машин и определении типа узла в ресурсе кластера Service Fabric. Эти значения должны совпадать.

### <a name="operational-recommendations-for-the-node-type-that-you-have-set-to-silver-or-gold-durability-level"></a>Рекомендации по эксплуатации типа узла с уровнем устойчивости Silver или Gold

- Поддерживайте постоянную работоспособность кластера и приложений и проверяйте, своевременно ли реагируют приложения на все [события жизненного цикла реплики службы](service-fabric-reliable-services-lifecycle.md) (например, задержку сборки реплики).
- Реализуйте более безопасные способы изменения номера SKU виртуальной машины (масштабирования). Изменение номера SKU виртуальной машины для масштабируемого набора по своей сути является небезопасной операцией, поэтому рекомендуется по возможности ее избегать. Ниже описывается, как избежать распространенных проблем.
    - **Для типов узлов, не являющихся первичными:** рекомендуется создать масштабируемый набор виртуальных машин, изменить ограничение размещения служб, чтобы добавить новый тип узла для этого набора, а затем сократить число экземпляров старого масштабируемого набора до 0, удаляя по одному узлу (так удаление узлов не повлияет на надежность кластера).
    - **Для типа первичного узла:** рекомендуется не изменять номер SKU виртуальной машины. Изменение номера SKU для типа первичного узла не поддерживается. Если причиной создания номера SKU является увеличение емкости, рекомендуем добавить экземпляры. Если это невозможно, создайте кластер и [восстановите состояние приложения](service-fabric-reliable-services-backup-restore.md) (если это применимо) из старого кластера. Не нужно восстанавливать состояния службы системы, так как при развертывании приложений в новом кластере они будут созданы заново. Если приложения в кластере выполнялись без отслеживания состояния, достаточно развернуть их в новом кластере. Восстановление выполнять не нужно. Если вы используете неподдерживаемый маршрут и хотите изменить номер SKU виртуальной машины, внесите изменения в определение модели масштабируемого набора виртуальных машин, указав новый номер SKU. Если в кластере используется только один тип узла, то убедитесь, что все приложения с отслеживанием состояния своевременно реагируют на все [события жизненного цикла реплики службы](service-fabric-reliable-services-lifecycle.md) (например, задержку сборки реплики) и длительность восстановления реплики службы не превышает пяти минут (для уровня устойчивости Silver). 

    > [!WARNING]
    > Изменять размер (номер SKU) виртуальной машины для масштабируемого набора виртуальных машин, для которого не активирован по крайней мере уровень устойчивости Silver, не рекомендуется. Изменение размера (номера SKU) виртуальной машины — внутренняя операция инфраструктуры, которая может привести к потере данных. Без хоть какой-либо возможности отложить или отследить это изменение вероятна ситуация, в которой операция приведет к потере данных служб с отслеживанием состояния или вызовет другие непредвиденные проблемы в работе, даже для рабочих нагрузок без отслеживания состояния. 
    > 
    
- Обеспечьте как минимум пять узлов для любого масштабируемого набора виртуальных машин с уровнем устойчивости Gold или Silver.
- Каждый масштабируемый набор виртуальных машин с уровнем устойчивости Silver или Gold должен быть сопоставлен с собственным типом узла в кластере Service Fabric. Сопоставление нескольких масштабируемых наборов виртуальных машин в одном типе узла сделает невозможным координацию между кластером Service Fabric и инфраструктурой Azure.
- Не удаляйте случайные экземпляры виртуальных машин. Всегда используйте функцию уменьшения масштаба масштабируемого набора виртуальных машин. Удаление случайных экземпляров виртуальной машины может нарушить баланс в распределении экземпляров виртуальной машины в домене обновления и домене сбоя. Этот дисбаланс может негативно повлиять на возможность системы правильно распределять нагрузку между экземплярами служб или репликами служб.
- При использовании автомасштабирования установите правила таким образом, чтобы свертывание (удаление экземпляров виртуальной машины) выполнялось одновременно только на одном узле. Одновременно уменьшать масштаб более одного экземпляра небезопасно.
- При удалении или отмене выделения виртуальных машин на типе основного узла никогда не следует уменьшать количество выделенных виртуальных машин ниже требований уровня надежности. Эти операции будут заблокированы на неограниченное время в масштабируемом наборе с уровнем устойчивости Silver или Gold.

## <a name="the-reliability-characteristics-of-the-cluster"></a>Характеристики надежности кластера
Уровень надежности используется для задания числа реплик системных служб, которые будут выполняться в этом кластере на первичных узлах. Чем больше реплик, тем надежнее системные службы в кластере.  

Уровень надежности может принимать следующие значения:

* Platinum: запуск системных служб с целевым набором из девяти реплик.
* Gold: запуск системных служб с целевым набором из семи реплик.
* Silver: запуск системных служб с целевым набором из пяти реплик. 
* Bronze: запуск системных служб с целевым набором из трех реплик.

> [!NOTE]
> Выбранный уровень надежности определяет минимальное количество узлов для типа первичного узла. 
> 
> 

### <a name="recommendations-for-the-reliability-tier"></a>Рекомендации по уровню надежности

При увеличении или уменьшении размера кластера (суммы экземпляров виртуальных машин во всех типах узлов) необходимо изменить уровень надежности кластера с одного на другой. Это активирует обновления кластера, необходимые для изменения числа реплик системных служб. Подождите, пока обновление не будет завершено, прежде чем вносить другие изменения в кластер, например добавлять узлы.  Ход выполнения обновления можно отслеживать в Service Fabric Explorer или с помощью командлета [Get-ServiceFabricClusterUpgrade](/powershell/module/servicefabric/get-servicefabricclusterupgrade?view=azureservicefabricps).

Ниже приведены рекомендации по выбору уровня надежности.

| **Размер кластера** | **Уровень надежности** |
| --- | --- |
| 1 |Не указывайте параметр уровня надежности, система рассчитает его сама |
| 3 |Bronze |
| 5 или 6|Silver |
| 7 или 8 |Gold |
| 9 и более |Platinum |

## <a name="primary-node-type---capacity-guidance"></a>Рекомендации по загрузке типа первичного узла

Ниже приведены рекомендации по планированию загрузки типа первичного узла.

- **Количество экземпляров виртуальных машин для выполнения любой рабочей нагрузки в Azure:** необходимо указать минимальный размер для типа первичного узла, равный 5. 
- **Количество экземпляров виртуальных машин для запуска тестов рабочих нагрузок в Azure:** можно указать минимальный размер для типа первичного узла, равный 1 или 3. Одноузловой кластер работает со специальной конфигурацией, поэтому масштабирование этого кластера не поддерживается. Одноузловой кластер не является надежным, поэтому в шаблоне Resource Manager нужно удалить или не указывать эту конфигурацию (не задавать значение конфигурации будет недостаточно). Если одноузловой кластер настраивается через портал, то конфигурация задается автоматически. Одно- и трехузловые кластеры не поддерживаются для выполнения рабочих нагрузок. 
- **Номер SKU виртуальной машины:** тип первичного узла используется для запуска системных служб, поэтому выбранный для него номер SKU виртуальной машины должен обеспечивать достаточно ресурсов для общей пиковой загрузки, которую вы планируете разместить в кластере. Чтобы пояснить, что имеется ввиду, приведу аналогию. Представьте, что тип первичного узла — ваши легкие, которые снабжают кислородом мозг. Поэтому, если мозг не получает достаточно кислорода, то тело страдает. 

Необходимая загрузка кластера определяется рабочей нагрузкой, которую планируется в нем выполнять. Поэтому мы не можем дать качественные рекомендации именно для вашей рабочей нагрузки, однако ниже приведены общие рекомендации, которые помогут приступить к работе.

Для производственных рабочих нагрузок: 

- Рекомендуемый номер SKU виртуальной машины — Standard D3, Standard D3_V2 или их аналог, обеспечивающий не менее 14 ГБ на локальном SSD.
- Минимальный поддерживаемый номер SKU виртуальной машины — Standard D1, Standard D1_V2 или их аналог, обеспечивающий не менее 14 ГБ на локальном SSD. 
- Номера SKU виртуальных машин с неполным числом ядер (например, Standard A0) для производственных рабочих нагрузок не поддерживаются.
- Номер SKU Standard A1 не поддерживается для производственных рабочих нагрузок по соображениям производительности.

> [!WARNING]
> Сейчас изменение размера SKU виртуальной машины на первичном узле в работающем кластере не поддерживается. Внимательно выбирайте номер SKU виртуальной машины для типа первичного узла, учитывая будущую потребность в емкости. Сейчас единственный поддерживаемый способ изменить (уменьшить или увеличить) номер SKU виртуальной машины для типа первичного узла — создать новый кластер с надлежащей емкостью, развернуть в нем приложения и восстановить их состояние (если это применимо) из [последних резервных копий службы](service-fabric-reliable-services-backup-restore.md), созданных в старом кластере. Не нужно восстанавливать состояния службы системы, так как при развертывании приложений в новом кластере они будут созданы заново. Если приложения в кластере выполнялись без отслеживания состояния, достаточно развернуть их в новом кластере. Восстановление выполнять не нужно.
> 

## <a name="non-primary-node-type---capacity-guidance-for-stateful-workloads"></a>Рекомендации по производительности для рабочих нагрузок с отслеживанием состояния для прочих типов узлов

Эти рекомендации предназначены для рабочих нагрузок с отслеживанием состояния, использующих в Service Fabric интерфейсы [Reliable Collections или Reliable Actors](service-fabric-choose-framework.md), которые выполняются в типах узлов, не являющихся первичными.

**Количество экземпляров виртуальных машин:** рабочие нагрузки с отслеживанием состояния рекомендуется запускать как минимум на 5 репликах, задав это количество целевым. Это означает, что в стабильном состоянии в каждом домене сбоя и домене обновления будет по реплике (из набора реплик). Весь принцип уровня надежности для типа первичного узла состоит в том, чтобы просто задать этот параметр для системных служб. Та же рекомендация относится к службам с отслеживанием состояния.

Таким образом для производственных рабочих нагрузок минимальный рекомендуемый размер для типа узла, не являющегося первичным, равен 5, если этот тип используется для выполнения рабочих нагрузок с отслеживанием состояния.

**Номер SKU виртуальной машины:** этот тип узла используется для выполнения служб приложения, поэтому выбранный для него номер SKU виртуальной машины должен обеспечивать достаточно ресурсов для общей пиковой загрузки, которую вы планируете разместить в каждом узле. Необходимая загрузка для типа узла определяется рабочей нагрузкой, которую планируется выполнять в кластере. Поэтому мы не можем дать качественные рекомендации именно для вашей рабочей нагрузки, однако ниже приведены общие рекомендации, которые помогут приступить к работе.

Для производственных рабочих нагрузок 

- Рекомендуемый номер SKU виртуальной машины — Standard D3, Standard D3_V2 или их аналог, обеспечивающий не менее 14 ГБ на локальном SSD.
- Минимальный поддерживаемый номер SKU виртуальной машины — Standard D1, Standard D1_V2 или их аналог, обеспечивающий не менее 14 ГБ на локальном SSD. 
- Номера SKU виртуальных машин с неполным числом ядер (например, Standard A0) для производственных рабочих нагрузок не поддерживаются.
- В частности, номер SKU Standard A1 не поддерживается для производственных рабочих нагрузок по соображениям производительности.

## <a name="non-primary-node-type---capacity-guidance-for-stateless-workloads"></a>Рекомендации по производительности рабочих нагрузок без отслеживания состояния для прочих типов узлов

Эти рекомендации предназначены для рабочих нагрузок без отслеживания состояния, которые выполняются в типах узлов, не являющихся первичными.

**Количество экземпляров виртуальных машин:** для рабочих нагрузок без отслеживания состояния минимальное поддерживаемое количество для типа узла, не являющегося первичным, равно 2. Это дает возможность запустить два экземпляра приложения без отслеживания состояния и позволяет службе перенести потерю экземпляра виртуальной машины. 

**Номер SKU виртуальной машины:** этот тип узла используется для выполнения служб приложения, поэтому выбранный для него номер SKU виртуальной машины должен обеспечивать достаточно ресурсов для общей пиковой загрузки, которую вы планируете разместить в каждом узле. Необходимая загрузка для типа узла определяется рабочей нагрузкой, которую планируется выполнять в кластере. Поэтому мы не можем дать качественные рекомендации именно для вашей рабочей нагрузки, однако ниже приведены общие рекомендации, которые помогут приступить к работе.

Для производственных рабочих нагрузок 

- Рекомендуемый номер SKU виртуальной машины — Standard D3, Standard D3_V2 или их аналог. 
- Минимальный поддерживаемый номер SKU виртуальной машины — Standard D1, Standard D1_V2 или их аналог. 
- Номера SKU виртуальных машин с неполным числом ядер (например, Standard A0) для производственных рабочих нагрузок не поддерживаются.
- Номер SKU Standard A1 не поддерживается для производственных рабочих нагрузок по соображениям производительности.

<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->

## <a name="next-steps"></a>Дополнительная информация
Завершив планирование загрузки и настройку кластера, прочитайте следующие разделы:

* [Защита кластера Service Fabric](service-fabric-cluster-security.md)
* [Масштабирование кластера Azure Service Fabric](service-fabric-cluster-scaling.md)
* [План аварийного восстановления](service-fabric-disaster-recovery.md)
* [Связь между типами узлов Service Fabric и масштабируемыми наборами виртуальных машин](service-fabric-cluster-nodetypes.md)

<!--Image references-->
[SystemServices]: ./media/service-fabric-cluster-capacity/SystemServices.png
