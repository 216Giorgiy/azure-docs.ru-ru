---
title: 'Диспетчер кластерных ресурсов Service Fabric: сходство | Microsoft Docs'
description: Общие сведения о настройке сходства для служб Service Fabric
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''

ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/19/2016
ms.author: masnider

---
# Настройка и использование сходства служб в Service Fabric
Сходство — это элемент управления, который применяется в основном для облегчения перевода больших, монолитных приложений в мир микро- и облачных служб. С другой стороны, в некоторых случаях этот элемент может использоваться в качестве доступного инструмента оптимизации производительности служб, хотя и может иметь побочные эффекты.

Допустим, вам нужно добавить в Service Fabric большое приложение или приложение, не предназначенное для работы с микрослужбами. Мы не раз имели дело с клиентами (как внутренними, так и внешними), перед которыми стояла такая задача перевода. Сначала вы вводите приложение в среду, упаковываете его и запускаете. Затем вы начинаете делить его на различные более мелкие службы, взаимодействующие между собой.

И вот здесь возникают проблемы. Обычно проблемы относятся к одной из следующих категорий:

1. Некий компонент Х в монолитном приложении имел незадокументированную зависимость от компонента Y, который только что был превращен в отдельные службы. Так как теперь они выполняются на разных узлах кластера, их связь разрушена.
2. Компоненты взаимодействуют через (каналы с локальными именами | общую память | файлы на диске), но для того, чтобы ускорить процессы хотя бы немного, необходима возможность обновлять их независимо друг от друга. Чуть позже мы уберем жесткую зависимость.
3. Все работает, но оказывается, что эти два компонента выдают слишком много данных или слишком чувствительны к производительности. С их переносом в отдельные службы общая производительность приложения резко упала или увеличилась задержка. В результате приложение в целом не удовлетворяет требованиям.

В описанных ситуациях необходимо не потерять проделанную работу и не вернуться к монолитному решению, но выполнить действия, которые требуются для того, чтобы все работало как надо. Проблема сохранится до тех пор, пока компоненты не будут изменены и не заработают как службы, или пока мы не сможем решить вопрос повышения производительности каким-то другим способом.

Что делать? Попробуйте включить сопоставление.

## Настройка сходства
Для настройки сходства необходимо определить отношения сопоставления между двумя отдельными службами. Это все равно, что указать одной службе на другую и сказать: "Эта служба может работать только тогда, когда та служба работает". Иногда сходство называют родительско-дочерними отношениями (где вы указываете ребенку на родителя). В результате применения сходства реплики и экземпляры одной службы помещаются в те же узлы, что и реплики и экземпляры другой службы.

``` csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

## Различные параметры сходства
Сопоставление представляет одна из нескольких возможных схем корреляции, которая имеет два различных режима. Наиболее распространенный режим сопоставления — NonAlignedAffinity. В режиме NonAlignedAffinity реплики или экземпляры различных служб помещаются в одни и те же узлы. Другой режим — AlignedAffinity. Он применяется только для служб с отслеживанием состояния. Сопоставление двух служб с отслеживанием состояния в режиме AlignedAffinity гарантирует, что первичные реплики одной службы будут размещаться на тех же узлах, что и первичные реплики другой службы. И там же будет размещаться каждая пара вторичных реплик этих служб. Сопоставление в режиме NonAlignedAffinity также можно настроить для служб с отслеживанием состояния (хотя это встречается реже). В режиме NonAlignedAffinity разные реплики двух служб с отслеживанием состояния будут размещаться на одних и тех же узлах, но контроль за тем, чтобы первичные и вторичные реплики размещались на одних и тех узлах, не осуществляется.

![Режимы сопоставления и их воздействие][Image1]

### Требуемое состояние не гарантируется
Между сопоставленными и монолитными архитектурами существует несколько различий. Многие из них связаны с тем, что отношение сходства является наилучшим вариантом. Поскольку службы, сопоставленные с помощью отношения сходства, совершенно различны, они могут отказать независимо друг от друга, и так же независимо их можно перенести. Также существуют причины, по которым отношение сходства может быть разорвано. Например, ограничение емкости, из-за которого на заданном узле может разместиться только часть объектов обслуживания в отношении сходства. В этих случаях даже имеющееся отношение сходства не сможет работать из-за других ограничений. Проблема с нарушением ограничений сходства будет исправлена автоматически, если впоследствии удастся применить все другие ограничения и сходства.

### Цепочки и звезды
На данный момент моделировать цепочки отношений сопоставления нельзя. Это означает, что служба, которая является дочерней в одном отношении сопоставления, не может быть родительской в другом. Для моделирования такого типа связи это необходимо сделать не в виде цепочки, а как звезду. Для этого самый нижний дочерний элемент необходимо сделать родительским объектом для родительского объекта среднего дочернего элемента. В зависимости от расположения служб может потребоваться создать службу-заполнитель, которая будет выступать родительским объектом для нескольких дочерних элементов.

![Цепочки и звезды в контексте отношений сопоставления][Image2]

Также следует помнить, что на сегодняшний день отношения сопоставления являются направленными. Это означает, что правило сходства определяет только размещение дочернего элемента вместе с родительским. Например, когда в результате сбоя родительский элемент переносится на другой узел, диспетчер кластерных ресурсов не увидит в этом ничего плохого, пока не заметит, что дочерний и родительский элементы не размещаются вместе. После этого отношения будут немедленно восстановлены.

### Поддержка секционирования
И, наконец, отношения сопоставления не поддерживаются, если родительский элемент секционирован. Со временем ситуация может измениться, но на данном этапе такой вариант не допускается.

## Дальнейшие действия
* Дополнительные сведения о других вариантах настройки служб см. в статье [Настройка параметров диспетчера кластерных ресурсов для служб Service Fabric](service-fabric-cluster-resource-manager-configure-services.md).
* Большинство задач, для которых используется сходство, например работа служб на небольшом количестве компьютеров или сбор информации о нагрузке в коллекции служб, зачастую проще решить с помощью групп приложений. См. статью [Группы приложений](service-fabric-cluster-resource-manager-application-groups.md)

[Image1]: ./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]: ./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png

<!---HONumber=AcomDC_0824_2016-->