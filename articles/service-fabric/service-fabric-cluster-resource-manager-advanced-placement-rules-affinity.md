<properties
   pageTitle="Диспетчер ресурсов кластера Service Fabric — сопоставление"
   description="Общие сведения о дополнительных политиках размещения и правилах для служб Service Fabric"
   services="service-fabric"
   documentationCenter=".net"
   authors="masnider"
   manager="timlt"
   editor=""/>

<tags
   ms.service="Service-Fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="03/03/2016"
   ms.author="masnider"/>

# Сопоставление

Сопоставление — один из тех моментов, которые, по крайней мере, на первый взгляд не имеют большого смысла в среде микрослужб. И это действительно так. Сопоставление — это элемент управления, который применяется в основном для облегчения перевода больших, монолитных приложений в мир микро- и облачных служб.

Допустим, вам нужно добавить в Service Fabric большое приложение или приложение, не предназначенное для работы с микрослужбами. Мы не раз имели дело с клиентами (как внутренними, так и внешними), перед которыми стояла такая задача. Сначала вы вводите приложение в среду, упаковываете его и запускаете. Затем вы начинаете делить его на различные более мелкие службы, взаимодействующие между собой.

И вот здесь возникают проблемы. Обычно проблемы относятся к одной из следующих категорий:

1. Оказывается, что компонент Х в монолитном приложении имел незадокументированную зависимость от компонента Y, который только что был превращен в службу и перемещен в другую часть кластера. Эта связь оказалась разорвана.
2.	Компоненты взаимодействуют через (каналы с локальными именами | общую память | файлы на диске), но для того, чтобы ускорить процессы хотя бы немного, необходима возможность обновлять их независимо друг от друга.
3.	Все работает, но оказывается, что эти два компонента выдают слишком много данных или слишком чувствительны к производительности, так что с их переносом в отдельные службы производительность резко упала.

В любой из описанных ситуаций необходимо не потерять проделанную работу и не вернуться к монолитному решению, но попытаться собрать все так, чтобы до тех пор, пока проблема не будет решена, все работало как надо.

Что делать? Попробуйте включить сопоставление.

## Как работает сопоставление
Для настройки сопоставления нужно определить отношения сопоставления между двумя отдельными службами. Это все равно, что указать одной службе на другую и сказать: "Эта служба может работать только тогда, когда та служба работает". Иногда мы называем это родительско-дочерними отношениями (где вы указываете ребенку на родителя). В результате реплики и экземпляры одной службы помещаются в те же узлы, что и реплики и экземпляры службы, с которой она сопоставлена.

``` csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

## Различные параметры сопоставления
Сопоставление представляет одна из нескольких возможных схем корреляции, которая имеет два различных режима. Наиболее распространенный режим сопоставления — NonAlignedAffinity. В режиме NonAlignedAffinity реплики или экземпляры различных служб помещаются в одни и те же узлы. Другой режим — AlignedAffinity. Он применяется для служб с отслеживанием состояния. Сопоставление одной службы с отслеживанием состояния с другой такой же службой в режиме AlignedAffinity гарантирует, что первичные реплики одной службы будут размещаться на тех же узлах, что и первичные реплики другой службы, и там же будет размещаться каждая пара вторичных реплик. Сопоставление в режиме NonAlignedAffinity также можно настроить для служб с отслеживанием состояния (хотя это встречается реже). В этом случае вы получите примерно такой же результат, как при работе со службами без отслеживания состояния — разные реплики двух служб с отслеживанием состояния будут размещаться на одних и тех же узлах, но контроль за тем, чтобы первичные и вторичные реплики размещались на одних и тех узлах, не осуществляется.

![Режимы сопоставления и их воздействие][Image1]

#### Требуемое состояние не гарантируется
Между сопоставленными и монолитными архитектурами существует несколько различий. Почти все они связаны с тем, что отношение сопоставления не дает никаких гарантий — поскольку службы совершенно различны, они могут отказать независимо друг от друга. В результате каких-либо действий, например из-за ограничений емкости, различные реплики службы могут разделиться.


#### Цепочки и звезды
На данный момент моделировать цепочки отношений сопоставления нельзя. Это означает, что служба, которая является дочерней в одном отношении сопоставления, не может быть родительской в другом. В связи с этим подобные отношения необходимо моделировать не как цепочку, а как звезду, в которой самый нижний "ребенок" служит родителем для родителя среднего "ребенка".

![Цепочки и звезды в контексте отношений сопоставления][Image2]

Также следует помнить, что на сегодняшний день отношения сопоставления являются направленными. Это означает, что правило сопоставления определяет только размещение дочернего элемента вместе с родительским, так что в случае, когда в результате сбоя родительский элемент переносится на другой узел (или происходит другое ограниченное действие, вызывающее перемещение родительского элемента), диспетчер ресурсов не увидит в этом ничего плохого, пока не заметит, что дочерний и родительский элементы не размещаются вместе. После этого отношения будут немедленно восстановлены.

#### Поддержка секционирования
И, наконец, отношения сопоставления не поддерживаются, если родительский элемент секционирован. Со временем ситуация может измениться, но на данном этапе такой вариант не допускается.

<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->
## Дальнейшие действия
- [Дополнительные сведения о настройке служб](service-fabric-cluster-resource-manager-configure-services.md)

[Image1]: ./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]: ./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png

<!---HONumber=AcomDC_0309_2016-->