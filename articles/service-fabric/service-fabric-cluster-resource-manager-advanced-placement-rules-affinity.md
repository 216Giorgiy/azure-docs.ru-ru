---
title: "Диспетчер кластерных ресурсов Service Fabric: сходство | Документация Майкрософт"
description: "Общие сведения о настройке сходства для служб Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
translationtype: Human Translation
ms.sourcegitcommit: dafaf29b6827a6f1c043af3d6bfe62d480d31ad5
ms.openlocfilehash: 16863217eddf0a4bbd85c52f8481c03e50dd9108


---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a>Настройка и использование сходства служб в Service Fabric
Сходство — это элемент управления, который применяется в основном для облегчения перевода больших, монолитных приложений в мир микро- и облачных служб. Но кроме того, в некоторых случаях с его помощью можно улучшить производительность служб, хотя и не без возможных последствий.

Допустим, вам нужно добавить в Service Fabric большое приложение или приложение, не предназначенное для работы с микрослужбами. Это вполне распространенный сценарий перехода. Для этого вы сначала полностью переносите приложение в среду, упаковываете его и проверяете, чтобы все работало без сбоев. Затем вы начинаете делить его на различные более мелкие службы, взаимодействующие между собой.

И вот здесь возникают проблемы. Обычно проблемы относятся к одной из следующих категорий:

1. У компонента Х в монолитном приложении была незадокументированная зависимость от компонента Y, а теперь вы разделили эти компоненты на отдельные службы. Эти службы выполняются на разных узлах кластера, и из-за этого связь между ними нарушена.
2. Эти компоненты взаимодействуют через локальные именованные каналы, общую память или файлы на диске. Но пока эта возможность записи в общий ресурс необходима для повышения производительности. Вы планируете устранить эту зависимость позднее.
3. Все работает, но оказывается, что эти два компонента выдают слишком много данных или слишком чувствительны к уровню производительности. С их переносом в отдельные службы общая производительность приложения резко упала или увеличилась задержка. В результате приложение в целом не удовлетворяет требованиям.

В описанных ситуациях мы не хотим терять проделанную работу и возвращаться к монолитному решению. Но нам нужны какие-то средства локального взаимодействия, пока мы не внесем изменения в компоненты, чтобы они соответствовали концепции служб, или не решим вопрос производительности другим способом.

Что делать? Попробуйте включить сходство.

## <a name="how-to-configure-affinity"></a>Настройка сходства
Для настройки сходства необходимо определить отношения сопоставления между двумя отдельными службами. Это все равно, что указать одной службе на другую и сказать: "Эта служба может работать только тогда, когда та служба работает". Иногда сходство называют родительско-дочерними отношениями (где вы указываете ребенку на родителя). В результате применения сходства реплики и экземпляры одной службы помещаются в те же узлы, что и реплики и экземпляры другой службы.

``` csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

## <a name="different-affinity-options"></a>Различные параметры сходства
Сопоставление представляет одна из нескольких возможных схем корреляции, которая имеет два различных режима. Наиболее распространенный режим сопоставления — NonAlignedAffinity. В режиме NonAlignedAffinity реплики или экземпляры разных служб помещаются в одни и те же узлы. Другой режим — AlignedAffinity. Он применяется только для служб с отслеживанием состояния. Сопоставление двух служб с отслеживанием состояния в режиме AlignedAffinity гарантирует, что первичные реплики одной службы будут размещаться на тех же узлах, что и первичные реплики другой службы. И там же будет размещаться каждая пара вторичных реплик этих служб. Сопоставление в режиме NonAlignedAffinity также можно настроить для служб с отслеживанием состояния (хотя это встречается реже). В режиме NonAlignedAffinity разные реплики двух служб с отслеживанием состояния будут размещаться на одних и тех же узлах, но без контроля взаимного расположения первичных и вторичных реплик.

<center>
![Режимы сопоставления и их воздействие][Image1]
</center>

### <a name="best-effort-desired-state"></a>Требуемое состояние не гарантируется
Между сопоставленными и монолитными архитектурами существует несколько различий. Многие из них связаны с тем, что отношение сходства является наилучшим вариантом. Поскольку службы, сопоставленные с помощью отношения сходства, совершенно различны, они могут отказать независимо друг от друга, и так же независимо их можно перенести. Также существуют причины, по которым отношение сходства может быть разорвано. Например, ограничение емкости, из-за которого на заданном узле может разместиться только часть объектов обслуживания в отношении сходства. В этих случаях даже имеющееся отношение сходства не сможет работать из-за других ограничений. Если возможно, такое нарушение позже автоматически исправляется.

### <a name="chains-vs-stars"></a>Цепочки и звезды
Диспетчер ресурсов кластера сейчас не умеет обрабатывать цепочки отношений сходства. Это означает, что служба, которая является дочерней в одном отношении сопоставления, не может быть родительской в другом. Для моделирования такого типа связи это необходимо сделать не в виде цепочки, а как звезду. Чтобы перейти от цепочки к топологии звезды, последний в цепочке дочерний элемент следует сделать дочерним объектом для родительского объекта первого дочернего элемента. Для сложных конфигураций служб это нужно повторить несколько раз. Если нельзя однозначно выделить родительскую службу, создайте новую специально для этой роли. В зависимости от ваших задач вам могут быть полезны еще и [группы приложений](service-fabric-cluster-resource-manager-application-groups.md).

<center>
![Цепочки и звезды в контексте отношений сходства][Image2]
</center>

Также следует помнить, что на сегодняшний день отношения сопоставления являются направленными. Это означает, что правило сходства гарантирует только размещение дочернего элемента вместе с родительским, но не наоборот. Родительская служба может быть перенесена на другой узел, например в результате отработки отказа. Диспетчер ресурсов кластера будет считать такую ситуацию допустимой, пока не заметит, что дочерняя служба не размещена на одном узле с родительской. Отношения сходства не гарантируют идеального или мгновенного применения правил, так как разные службы имеют разные жизненные циклы.

### <a name="partitioning-support"></a>Поддержка секционирования
И, наконец, отношения сопоставления не поддерживаются, если родительский элемент секционирован. Со временем ситуация может измениться, но на данном этапе такой вариант не допускается.

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о других вариантах настройки служб см. в статье [Настройка параметров диспетчера кластерных ресурсов для служб Service Fabric](service-fabric-cluster-resource-manager-configure-services.md).
* Для некоторых задач, например для запуска служб только на ограниченном наборе компьютеров или для объединения нагрузок от нескольких служб, лучше использовать [группы приложений](service-fabric-cluster-resource-manager-application-groups.md).

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png



<!--HONumber=Jan17_HO1-->


