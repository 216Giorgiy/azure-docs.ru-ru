<properties
   pageTitle="Дефрагментация метрик в кластере Azure Service Fabric | Microsoft Azure"
   description="Общие сведения об использовании дефрагментации или упаковки в качестве стратегии для метрик в кластере Service Fabric"
   services="service-fabric"
   documentationCenter=".net"
   authors="masnider"
   manager="timlt"
   editor=""/>

<tags
   ms.service="Service-Fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="05/20/2016"
   ms.author="masnider"/>

# Дефрагментация метрик и нагрузки в Service Fabric
Диспетчер Resource Manager кластера Service Fabric в основном занимается балансировкой в контексте распределения нагрузки, т. е. обеспечивает равномерное использование всех узлов. Данный вариант обычно является наиболее безопасным и разумным способом предотвращения сбоев, так как при этом основная часть рабочей нагрузки не затрагивается. Однако Resource Manager кластера Service Fabric поддерживает также и стратегию дефрагментации. Обычно дефрагментация означает, что вместо того, чтобы распределять использование метрик по кластеру, выполняется попытка его консолидации. На самом деле это можно было сделать и раньше: вместо того, чтобы повышать оценку решения, минимизируя среднее стандартное отклонение нагрузки для соответствующей метрики, мы ее понижаем (но делаем это иначе — не пытаемся уменьшить растущее отклонение, а запускаем оптимизацию). Зачем это нужно?

При равномерном распределении нагрузки между узлами в кластере теряется часть ресурсов, которые они могут предложить. Обычно это не составляет проблемы, но в некоторых случаях службы создают исключительно большую рабочую нагрузку и задействуют большую часть ресурсов. В результате, скажем, 75-95 % ресурсов узла уходит на одну и ту же службу. Это не страшно. Диспетчер ресурсов сразу обнаружит, что кластер необходимо реорганизовать, освободив его для высокой нагрузки, и предпримет необходимые меры, но пока это не произойдет, рабочей нагрузке придется подождать.

Учитывая, что график новых рабочих нагрузок обычно хоть немного, но чувствителен к задержкам, если мы не изменим свой подход, а число перемещаемых служб и состояний станет слишком большим, мы просто не справимся. Измерив время создания на имитационных моделях, основанных на данных реальных кластеров, мы заметили, что если службы достаточно большие, а кластер активно используется, создание больших служб замедляется, а также что ситуацию можно улучшить с внедрением метрик дефрагментации.

Точно так же, как фрагментированный жесткий диск компьютера замедляет создание файлов или доступ к данным, а дефрагментация диска ускоряет его работу, дефрагментация метрик позволяет диспетчеру ресурсов по возможности выделять под нагрузку служб меньше узлов, так что в кластере (почти всегда) будет свободное место для еще более крупных служб, а значит, они будут создаваться быстрее. Большинству пользователей это не нужно, так как службы чаще всего малы, и поэтому найти для них место не составляет труда. Но если у вас есть большие службы и вам нужно, чтобы они создавались быстро (и при этом вы готовы идти на компромиссы), дефрагментация метрик идеально подойдет для вас.

На приведенной ниже схеме показано визуальное представление двух разных кластеров, один из которых дефрагментирован, а другой — нет. При выборе варианта с балансировкой продумайте перемещения, которые потребуются для размещения одного из самых больших объектов службы (если бы возникла необходимость создавать новый объект), и сравните его с вариантом использования дефрагментированного кластера, в котором этот объект можно немедленно разместить на узлах 4 или 5.

![Сравнение методов балансировки и дефрагментации кластеров][Image1]

## Преимущества и недостатки дефрагментации
О каких компромиссах идет речь? Мы рекомендуем тщательно измерить рабочую нагрузку, прежде чем активировать дефрагментацию метрик. Вот на что следует обратить внимание:

| Плюсы дефрагментации | Минусы дефрагментации |
|----------------------|----------------------|
|Позволяет ускорить создание больших служб |	Концентрирует нагрузку на меньшем числе узлов, увеличивая, таким образом, конкуренцию за ресурсы
|Позволяет уменьшить перемещения данных в процессе создания | Сбои могут затронуть больше служб и вызвать более серьезные последствия
|Обеспечивает подробное описание требований и оптимальное использование пространства |	Более сложная общая настройка управления ресурсами

В одном и том же кластере можно комбинировать дефрагментированные и обычные метрики, при этом диспетчер ресурсов постарается консолидировать как можно больше дефрагментированных метрик и распределить все остальное. Точные результаты будут зависеть от соотношения балансирующих и дефрагментированных метрик, их размера и других факторов.

## Настройка метрик для дефрагментации
Решение о дефрагментации метрик затрагивает весь кластер. Для дефрагментации можно выбрать отдельные метрики:

ClusterManifest.xml:

```xml
<Section Name="DefragmentationMetrics">
    <Parameter Name="Disk" Value="true" />
    <Parameter Name="CPU" Value="false" />
</Section>
```

## Дальнейшие действия
- В диспетчере кластерных ресурсов много параметров для описания кластера. Дополнительные сведения о них см. в статье с [описанием кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).
- Метрики показывают, как диспетчер кластерных ресурсов Service Fabric управляет потреблением и емкостью в кластере. Дополнительные сведения о метриках и их настройке см. в [этой статье](service-fabric-cluster-resource-manager-metrics.md).

[Image1]: ./media/service-fabric-cluster-resource-manager-defragmentation-metrics/balancing-defrag-compared.png

<!---HONumber=AcomDC_0525_2016-->