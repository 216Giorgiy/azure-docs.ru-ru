---
title: "Дефрагментация метрик в кластере Azure Service Fabric | Документация Майкрософт"
description: "Общие сведения об использовании дефрагментации или упаковки в качестве стратегии для метрик в кластере Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: e5ebfae5-c8f7-4d6c-9173-3e22a9730552
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
translationtype: Human Translation
ms.sourcegitcommit: dafaf29b6827a6f1c043af3d6bfe62d480d31ad5
ms.openlocfilehash: 5ef6381f7d182c818171eca3e3d32a00bc30268e


---
# <a name="defragmentation-of-metrics-and-load-in-service-fabric"></a>Дефрагментация метрик и нагрузки в Service Fabric
Диспетчер кластерных ресурсов Service Fabric в основном занимается балансировкой распределения нагрузки, т. е. обеспечивает равномерное использование узлов кластера. Обычно такое распределение — самый безопасный и взвешенный способ минимизировать риск сбоев, так как единичный сбой не сможет вывести из строя значительную часть рабочей нагрузки. Однако Resource Manager кластера Service Fabric поддерживает также и стратегию дефрагментации. Обычно дефрагментация означает, что вместо того, чтобы распределять использование метрик по кластеру, выполняется попытка его консолидации. Консолидация может быть удачным решением, противоположным нашей обычной стратегии. Теперь диспетчер кластерных ресурсов, вместо снижения среднего отклонения уровней нагрузки по каждой метрике, старается увеличить это отклонение. Зачем это нужно?

При равномерном распределении нагрузки между узлами в кластере теряется часть ресурсов, которые они могут предложить. Но некоторые рабочие нагрузки создают огромные службы, потребляющие почти все ресурсы узла. В таких случаях от 75 % до 95 % ресурсов узла могут быть заняты одним-единственным объектом службы. Крупные рабочие нагрузки не представляют проблем. Диспетчер кластерных ресурсов во время создания службы определяет, что ему нужно перераспределить ресурсы кластера, освобождая место для крупной рабочей нагрузки. Но тогда такой рабочей нагрузке нужно ожидать размещения в кластере.

Если перемещать нужно большое число служб и состояний, на размещение большой рабочей нагрузки в кластере потребуется много времени. Это еще более актуально, если другие рабочие нагрузки в кластере тоже крупные и требуют много времени для перемещения. Разработчики Service Fabric замерили время создания службы, смоделировав такой сценарий. Мы выяснили, что процесс создания большой службы будет очень медленным, если эта служба достаточно крупная, а кластер в существенной степени загружен. Чтобы решить эту проблему, мы создали стратегию балансировки, основанную на дефрагментации. Мы обнаружили, что для крупных рабочих нагрузок, особенно чувствительных к задержкам при создании, дефрагментация существенно оптимизирует размещение нагрузок в кластере.

Вы можете настроить метрики дефрагментации, чтобы диспетчер кластерных ресурсов заранее группировал нагрузки служб на меньшем числе узлов. Это позволит (почти) всегда найти свободное место для самых крупных служб. Тогда такие службы при необходимости будут создаваться очень быстро.

Для большинства клиентов дефрагментация не требуется. Обычно службы небольшие, и для них нетрудно найти свободное место в кластере. Но если вы используете крупные службы, которые должны создаваться быстро, и при этом готовы пожертвовать другими характеристиками, стратегия дефрагментации создана именно для вас.

Так чем же придется жертвовать? В первую очередь, дефрагментация повышает критичность сбоев, так как на проблемном узле собрано больше служб. Кроме того, при использовании дефрагментации некоторые ресурсы кластера не используются в ожидании рабочих нагрузок, которые могут быть в них распределены.

На следующей схеме показано визуальное представление двух разных кластеров, один из которых дефрагментирован, а другой — нет. Обратите внимание на число перемещений, необходимых для размещения крупного объекта службы в сценарии с балансировкой. По сравнению с этим дефрагментированный кластер намного лучше, так как большая рабочая нагрузка может быть немедленно размещена на четвертом или пятом узле.

<center>
![Сравнение методов балансировки и дефрагментации кластеров][Image1]
</center>

## <a name="defragmentation-pros-and-cons"></a>Преимущества и недостатки дефрагментации
О каких компромиссах идет речь? Мы рекомендуем тщательно измерить рабочую нагрузку, прежде чем активировать дефрагментацию метрик. Вот на что следует обратить внимание:

| Плюсы дефрагментации | Минусы дефрагментации |
| --- | --- |
| Позволяет ускорить создание больших служб |Концентрирует нагрузку на меньшем числе узлов, увеличивая, таким образом, конкуренцию за ресурсы |
| Позволяет уменьшить перемещения данных в процессе создания |Сбои могут затронуть больше служб и вызвать более серьезные последствия |
| Обеспечивает подробное описание требований и оптимальное использование пространства |Более сложная общая настройка управления ресурсами |

Для одного кластера можно одновременно применять метрики дефрагментации и обычного распределения. Диспетчер ресурсов кластера пытается объединить метрики дефрагментации, насколько это возможно, и равномерно распределить все остальные. Если у вас нет служб, для которых установлены и те, и другие метрики, результат будет хорошим. Точные результаты будут зависеть от соотношения числа метрик балансировки и дефрагментации, их взаимного перекрытия, их весов, используемых нагрузок и многих других факторов. Для поиска оптимальной конфигурации нужно экспериментировать.

## <a name="configuring-defragmentation-metrics"></a>Настройка метрик для дефрагментации
Решение о дефрагментации метрик затрагивает весь кластер. Для дефрагментации можно выбрать отдельные метрики:

ClusterManifest.xml:

```xml
<Section Name="DefragmentationMetrics">
    <Parameter Name="Disk" Value="true" />
    <Parameter Name="CPU" Value="false" />
</Section>
```

Для автономных развертываний используется ClusterConfig.json, а для размещенных в Azure кластеров — Template.json.

```json
"fabricSettings": [
  {
    "name": "DefragmentationMetrics",
    "parameters": [
      {
          "name": "Disk",
          "value": "true"
      },
      {
          "name": "CPU",
          "value": "false"
      }
    ]
  }
]
```


## <a name="next-steps"></a>Дальнейшие действия
* Диспетчер кластерных ресурсов предоставляет много параметров для описания кластера. Дополнительные сведения об этих параметрах см. в статье с [описанием кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).
* Метрики показывают, как диспетчер кластерных ресурсов Service Fabric управляет потреблением и емкостью в кластере. Дополнительные сведения о метриках и их настройке см. в [этой статье](service-fabric-cluster-resource-manager-metrics.md).

[Image1]:./media/service-fabric-cluster-resource-manager-defragmentation-metrics/balancing-defrag-compared.png



<!--HONumber=Jan17_HO1-->


