<properties
   pageTitle="Масштабирование кластера Service Fabric | Microsoft Azure"
   description="Масштабирование кластера Service Fabric путем настройки правил автомасштабирования для каждого типа узлов или набора масштабирования виртуальных машин."
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="05/04/2016"
   ms.author="chackdan"/>


# Масштабирование кластера Service Fabric с помощью правил автоматического масштабирования

Масштабируемые наборы виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания коллекции виртуальных машин и управления ею как набором. Каждый тип узла, определенный в кластере Service Fabric, настроен как отдельный масштабируемый набор ВМ. Каждый тип узла поддерживает возможность независимого масштабирования, имеет разные наборы открытых портов и собственные метрики емкости. Дополнительные сведения о типах узлов Service Fabric см. в этом [документе](service-fabric-cluster-nodetypes.md). Поскольку типы узлов Service Fabric в вашем кластере состоят из наборов масштабирования виртуальных машин на сервере, для каждого такого типа узлов или набора масштабирования необходимо настроить правила автомасштабирования.

>[AZURE.NOTE] Ваша подписка должна включать достаточное количество ядер для добавления виртуальных машин IaaS, которые войдут в состав этого кластера. В настоящее время проверка модели не предусмотрена, поэтому в случае, если пределы квоты будут нарушены, вы получите сбой во время развертывания.

## Выбор типа узла или масштабирования набора виртуальных машин для масштабирования

В настоящее время настроить правила автомасштабирования для наборов масштабирования виртуальных машин с помощью портала нельзя, поэтому мы используем Azure PowerShell (версии 1.0 или более поздней), чтобы сформировать список узлов и добавить в них правила автомасштабирования.

Чтобы получить список наборов масштабирования виртуальных машин в составе кластера, выполните следующие командлеты:

```powershell
Get-AzureRmResource -ResourceGroupName <RGname> -ResourceType Microsoft.Network/VirtualMachineScaleSets

Get-AzureRmVmss -ResourceGroupName <RGname> -VMScaleSetName <VM Scale Set name>
```

## Настройка правил автомасштабирования для типа узлов или набора масштабирования виртуальных машин

Если кластер содержит несколько типов узлов, эту процедуру необходимо выполнить для каждого типа узлов или набора масштабирования виртуальных машин, который нужно масштабировать. Перед настройкой автомасштабирования обратите внимание на необходимое количество узлов. Минимальное количество узлов, необходимое для основного типа узлов, зависит от выбранного уровня надежности. См. дополнительные сведения об [уровнях надежности](service-fabric-cluster-capacity.md).

>[AZURE.NOTE]  Уменьшение масштаба основного типа узлов до уровня ниже минимального приведет к нестабильности или сбою кластера. Это может вызвать потерю данных в приложениях или системных службах.

В настоящее время функция автомасштабирования не зависит от уровня нагрузки, который приложения сообщают Service Fabric. В связи с этим автомасштабирование регулируется исключительно счетчиками производительности, которые отправляются каждым экземпляром наборов масштабирования виртуальных машин.

Настройте автомасштабирование для каждого набора масштабирования виртуальных машин согласно [этим инструкциям](../virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview.md).

>[AZURE.NOTE] Если тип узла имеет уровень надежности Gold или Silver, в сценарии уменьшения масштаба необходимо вызывать [командлет Remove-ServiceFabricNodeState](https://msdn.microsoft.com/library/azure/mt125993.aspx) с именем соответствующего узла.

## Возможные варианты поведения в обозревателе Service Fabric

При вертикальном масштабировании кластер Service Fabric Explorer отражает число узлов (экземпляров наборов масштабирования виртуальных машин), которые входят в кластер. Тем не менее при уменьшении масштаба кластера удаленный узел или экземпляр виртуальной машины примет состояние неработоспособности, если не вызвать [командлет Remove-ServiceFabricNodeState](https://msdn.microsoft.com/library/mt125993.aspx) с именем соответствующего узла.

Вот как объясняется это поведение.

Узлы, перечисленные в Service Fabric Explorer, отражают то, что системным службам Service Fabric (в частности FM) известно о числе узлов в кластере. При уменьшении масштаба набора масштабирования виртуальных машин виртуальная машина удаляется, но системная служба FM считает, что узел (сопоставленный с удаленной виртуальной машиной) вернется. В связи с этим Service Fabric Explorer продолжает отображать этот узел (хотя состояние работоспособности может быть ошибочным или неизвестным).

Проверить удаление узла при удалении виртуальной машины можно двумя способами:

1) Выбрать уровень надежности Gold или Silver (будет доступно в ближайшее время) для типов узлов в кластере — это обеспечить интеграцию инфраструктуры. При уменьшении масштаба узлы будут удаляться из состояния системных служб (FM) автоматически. Дополнительные сведения об уровнях надежности см. [здесь](service-fabric-cluster-capacity.md).

2) После уменьшения масштаба экземпляра виртуальной машины необходимо вызвать [командлет Remove-ServiceFabricNodeState](https://msdn.microsoft.com/library/mt125993.aspx).

>[AZURE.NOTE] Для постоянной работы кластеров Service Fabric требуется определенное количество узлов, чтобы все время поддерживать доступность и сохранять состояние, которое называется "поддержание кворума". Поэтому обычно не рекомендуется завершать работу всех компьютеров в кластере, пока не будет выполнена [полная архивация состояния](service-fabric-reliable-services-backup-restore.md), так как это может быть небезопасно.

## Дальнейшие действия
Дополнительные сведения о планировании емкости кластера, обновлении кластера и секционировании служб см. в следующих статьях:

- [Планирование емкости кластера](service-fabric-cluster-capacity.md)
- [Обновления кластера](service-fabric-cluster-upgrade.md)
- [Секционирование служб с отслеживанием состояния для максимального масштабирования](service-fabric-concepts-partitioning.md)

<!--Image references-->
[BrowseServiceFabricClusterResource]: ./media/service-fabric-cluster-scale-up-down/BrowseServiceFabricClusterResource.png
[ClusterResources]: ./media/service-fabric-cluster-scale-up-down/ClusterResources.png

<!---HONumber=AcomDC_0518_2016-->