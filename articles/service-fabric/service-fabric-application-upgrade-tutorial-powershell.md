<properties
   pageTitle="Обновление приложения Service Fabric с помощью PowerShell | Microsoft Azure"
   description="В этой статье рассматривается процесс развертывания приложения Service Fabric, изменения кода и развертывания обновления с помощью PowerShell."
   services="service-fabric"
   documentationCenter=".net"
   authors="mani-ramaswamy"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="02/04/2016"
   ms.author="subramar"/>




# Обновление приложения Service Fabric с помощью PowerShell

Наиболее часто используемый и рекомендуемый подход к выполнению обновлений состоит в отслеживаемом последовательном обновлении. Платформа Azure Service Fabric осуществляет мониторинг работоспособности обновляемого приложения на основе набора политик работоспособности. После обновления приложений в домене обновления Service Fabric оценивает работоспособность приложения. Затем выполняется переход к следующему домену обновления или регистрация сбоя на основе политик работоспособности.

Отслеживаемое обновление приложения может выполняться с использованием управляемых или собственных API, PowerShell или REST. Инструкции по выполнению обновления в Visual Studio см. в статье [Руководство по обновлению приложений Service Fabric с помощью Visual Studio](service-fabric-application-upgrade-tutorial.md).

Service Fabric выполняет отслеживаемое последовательное обновление, позволяя администратору приложений настраивать политики оценки работоспособности, которые Service Fabric будет использовать для определения работоспособности приложения. Кроме того, администратор может настраивать действия, выполняемые при сбое оценки работоспособности (например, автоматический откат приложения). В этом разделе представлено пошаговое руководство по отслеживаемому обновлению одного из образцов пакета SDK с использованием PowerShell.

## Шаг 1. Построение и развертывание образца визуальных объектов

Эти шаги можно выполнить, загрузив приложение из GitHub и добавив в проект файлы **webgl utils.js** и **gl-matrix-min.js**, как указано в файле сведений примера. Без выполнения этих действий приложение работать не будет.

Добавив эти элементы в проект, создайте и опубликуйте приложение. Для этого щелкните правой кнопкой мыши проект приложения **VisualObjectsApplication** и выберите в меню Service Fabric команду **Опубликовать**, как описано ниже. Дополнительные сведения см. в статье [Руководство по обновлению приложений Service Fabric с помощью Visual Studio](service-fabric-application-upgrade-tutorial.md). Или разверните приложение с помощью PowerShell.

> [AZURE.NOTE] До того как в PowerShell можно будет использовать хотя бы одну из команд Service Fabric, необходимо сначала подключиться к соответствующему кластеру с помощью командлета `Connect-ServiceFabricCluster`. Предполагается, что кластер уже настроен на локальном компьютере. См. статью, посвященную [настройке среды разработки структуры служб](service-fabric-get-started.md).

Создав проект в Visual Studio, вы можете использовать команду PowerShell **Copy-ServiceFabricApplicationPackage**, чтобы скопировать пакет приложения в ImageStore. Затем необходимо зарегистрировать приложение в среде выполнения Service Fabric с помощью командлета **Register-ServiceFabricApplicationPackage**. Завершающий шаг — это запуск экземпляра приложения с помощью командлета **New-ServiceFabricApplication**. Эти три шага аналогичны действиям при использовании меню **Развертывание** в Visual Studio.

Теперь можно использовать [обозреватель структуры служб для просмотра кластера и приложения](service-fabric-visualizing-your-cluster.md). Приложение имеет веб-службу, к которой можно перейти, введя в адресной строке браузера Internet Explorer следующее: [http://localhost:8081/visualobjects](http://localhost:8081/visualobjects). Вы сможете увидеть несколько плавающих визуальных объектов, перемещающихся по экрану. Кроме того, можно использовать командлет **Get-ServiceFabricApplication**, чтобы проверить состояние приложения.

## Шаг 2. Обновление образца визуальных объектов

Вы можете заметить, что в версии, развернутой на шаге 1, визуальные объекты не вращаются. Давайте обновим это приложение до версии, в которой визуальные объекты будут вращаться.

Выберите проект VisualObjects.ActorService в решении VisualObjects и откройте файл StatefulVisualObjectActor.cs. В этом файле перейдите к методу `MoveObject`, а затем закомментируйте `this.State.Move()` и раскомментируйте `this.State.Move(true)`. Это изменение заставит объекты вращаться после обновления службы.

Вам также необходимо обновить файл *ServiceManifest.xml* (в разделе PackageRoot) проекта **VisualObjects.ActorService**. Обновите *CodePackage* и версию службы до версии 2.0 и соответствующие строки в файле *ServiceManifest.xml*. Чтобы изменить файл манифеста, в Visual Studio можно щелкнуть решение правой кнопкой мыши и выбрать пункт меню *Изменить файлы манифеста*.


После внесения изменений манифест должен выглядеть следующим образом (измененные части выделены полужирным шрифтом):

```xml
<ServiceManifestName="VisualObjects.ActorService"Version="2.0"xmlns="http://schemas.microsoft.com/2011/01/fabric"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

<CodePackageName="Code"Version="2.0">
```

Теперь нужно обновить файл *ApplicationManifest.xml* (находится в проекте **VisualObjects** в решении **VisualObjects**) так, чтобы в нем использовалась версия 2.0 проекта **VisualObjects.ActorService**. Также нужно обновить приложение с версии 1.0.0.0 до версии 2.0.0.0. Теперь соответствующие строки в файле *ApplicationManifest.xml* должны выглядеть следующим образом:

```xml
<ApplicationManifestxmlns:xsd="http://www.w3.org/2001/XMLSchema"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"ApplicationTypeName="VisualObjects"ApplicationTypeVersion="2.0.0.0"xmlns="http://schemas.microsoft.com/2011/01/fabric">

 <ServiceManifestRefServiceManifestName="VisualObjects.ActorService"ServiceManifestVersion="2.0" />
```


Теперь выполните сборку проекта, выбрав проект **ActorService** и щелкнув правой кнопкой мыши пункт **Построить** в Visual Studio. (Если вы выберете пункт **Перестроить все**, возможно, вам потребуется обновить версии других проектов, а также изменить файлы *ServiceManifest.xml* и *ApplicationManifest.xml*, так как код тоже изменится.) Теперь давайте создадим пакет обновленного приложения, щелкнув правой кнопкой проект ***VisualObjectsApplication*** и выбрав в меню Service Fabric пункт **Создать пакет**. При этом должен создаться пакет приложения, пригодный для развертывания. Теперь обновленное приложение готово к развертыванию.


## Шаг 3. Определение политик работоспособности и параметров обновления

Ознакомьтесь с [параметрами обновления приложений](service-fabric-application-upgrade-parameters.md) и [процессом обновления](service-fabric-application-upgrade.md), чтобы вы лучше понимали функции разных применяемых параметров обновления, значений времени ожидания и критериев работоспособности. В этом пошаговом руководстве мы оставим критерий оценки работоспособности службы в значении по умолчанию (с рекомендуемыми значениями). Это значит, что все службы и экземпляры после обновления должны быть работоспособными (иметь статус _healthy_).

Но давайте повысим значение атрибута *HealthCheckStableDuration* до 60 секунд (чтобы все службы были работоспособны хотя бы 20 секунд, до того как обновление будет запущено на другом домене обновления). Давайте также установим значение атрибута *UpgradeDomainTimeout* в значение "1200 секунд", а значение *UpgradeTimeout* — в значение "3000 секунд".

И наконец, давайте также настроим атрибут *UpgradeFailureAction* на откат, запросив таким образом от Service Fabric откат приложения до предыдущей версии при возникновении любых неполадок во время обновления. Следовательно, параметры обновления, которые мы зададим при запуске обновления (на шаге 4), будут такими:

FailureAction = Rollback

HealthCheckStableDurationSec = 60

UpgradeDomainTimeoutSec = 1200

UpgradeTimeout = 3000


## Шаг 4. Подготовка приложения к обновлению

Теперь приложение создано и готово для обновления. Если открыть окно PowerShell с правами администратора и ввести команду **Get-ServiceFabricApplication**, в нем отобразится информация о том, что вы развернули приложение типа **VisualObjects** версии 1.0.0.0.

Пакет приложения хранится по следующем относительному пути в зависимости от того, куда был извлечен SDK структуры служб: *Samples\\Services\\Stateful\\VisualObjects\\VisualObjects\\obj\\x64\\Debug*. Следует найти папку Package в этом каталоге (где хранится пакет приложения). С помощью временных меток проверьте, что это самая последняя версия (возможно, вам нужно будет соответствующим образом изменить пути).

Теперь давайте скопируем обновленный пакет приложения в ImageStore структуры службы (место, где структурой служб сохраняются пакеты приложения). Параметр *ApplicationPackagePathInImageStore* информирует структуру служб о том, где находится пакет приложения. Мы поместили обновленное приложение в папку VisualObjects\_V2 с помощью следующей команды (возможно, вам снова нужно будет изменить пути).

```powershell
Copy-ServiceFabricApplicationPackage  -ApplicationPackagePath .\Samples\Services\Stateful\VisualObjects\VisualObjects\obj\x64\Debug\Package
-ImageStoreConnectionString fabric:ImageStore   -ApplicationPackagePathInImageStore "VisualObjects\_V2"
```

Следующим шагом необходимо зарегистрировать приложение в структуре служб. Это можно сделать при помощи следующей команды:

```powershell
Register-ServiceFabricApplicationType -ApplicationPathInImageStore "VisualObjects\_V2"
```

Если вышеупомянутая команда не выполняется, скорее всего, вам нужно перестроить все связанные службы. Как упомянуто на шаге 2, возможно, потребуется обновить версию объекта WebService.

## Шаг 5. Начало обновления приложения

Теперь мы можем начать обновление приложения с помощью следующей команды:

```powershell
Start-ServiceFabricApplicationUpgrade -ApplicationName fabric:/VisualObjects -ApplicationTypeVersion 2.0.0.0 -HealthCheckStableDurationSec 60 -UpgradeDomainTimeoutSec 1200 -UpgradeTimeout 3000   -FailureAction Rollback -Monitored
```


Обратите внимание, что имя приложения соответствует имени, указанному в файле *ApplicationManifest.xml*. Структура служб использует это имя, чтобы распознать приложение, которое будет обновлено. Если для времени ожидания вы установили слишком малые значения, может возникнуть сообщение об ошибке, информирующее о проблеме. См. раздел по устранению неполадок или увеличьте значения времени ожидания.

Вы можете отслеживать ход обновления с помощью обозревателя Service Fabric или следующей команды PowerShell: **Get-ServiceFabricApplicationUpgrade fabric:/VisualObjects**.

Через несколько минут в состоянии, полученном с помощью этой команды, отобразится информация о завершении обновления всех доменов обновления. Теперь все визуальные объекты в окне браузера должны вращаться.

Вы можете попробовать изменить версии и перейти от версии 2 к версии 3 в качестве упражнения или даже от версии 2 назад к версии 1 (да, обновление с версии v2 до версии v1 возможно). Попробуйте изменить значения времени ожидания и параметры политики работоспособности в качестве тренировки. При развертывании в кластере Azure используемые параметры будут отличаться от тех, которые применялись при развертывании в локальном кластере. Поэтому мы рекомендуем указывать значения времени ожидания в рамках консервативного подхода.


## Дальнейшие действия

[Руководство по обновлению приложений Service Fabric с помощью Visual Studio](service-fabric-application-upgrade-tutorial.md) поможет вам выполнить поэтапное обновление приложения с помощью Visual Studio.

Узнайте, как управлять обновлениями приложений с помощью [параметров обновления](service-fabric-application-upgrade-parameters.md).

Узнайте, как использовать [сериализацию данных](service-fabric-application-upgrade-data-serialization.md), чтобы обеспечить совместимость обновлений приложений.

[Дополнительные разделы](service-fabric-application-upgrade-advanced.md) содержат сведения о работе с расширенными функциями при обновлении приложения.

Сведения об устранении распространенных проблем при обновлении приложений см. в разделе [Устранение неполадок при обновлениях приложений](service-fabric-application-upgrade-troubleshooting.md).

<!---HONumber=AcomDC_0211_2016-->