<properties
   pageTitle="Жизненный цикл надежных субъектов"
   description="Описание жизненного цикла и сборки мусора для надежных субъектов Service Fabric"
   services="service-fabric"
   documentationCenter=".net"
   authors="jessebenson"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="08/05/2015"
   ms.author="amanbha"/>


# Жизненный цикл субъектов и сборка мусора
Субъект активируется при первом вызове к нему и отключается, если он не используется в течение определенного времени (среда выполнения субъектов собирает мусор). Чтобы настроить этот период времени, ознакомьтесь с разделом о сборке мусора ниже.

Что происходит при активации субъекта

- Когда поступает вызов субъекта, который еще не активен, создается новый субъект.
- Если для субъекта отслеживается состояние, оно загружается.
- Вызывается метод `OnActivateAsync` (он может быть переопределен в реализации субъекта).
- Субъект добавляется в таблицу активных субъектов.

Что происходит при деактивации субъекта

- Если субъект не используется в течение некоторого периода времени, он удаляется из таблицы активных субъектов.
- Вызывается метод `OnDeactivateAsync` (он может быть переопределен в реализации субъекта), удаляющий все таймеры для субъекта.

> [AZURE.TIP]Среда выполнения субъектов Service Fabric генерирует некоторые [события, связанные с активацией и деактивацией субъектов](service-fabric-reliable-actors-diagnostics.md#actor-activation-and-deactivation-events). Они полезны при диагностике и мониторинге производительности.

## Сборка мусора и субъекты
Среда выполнения субъектов периодически проверяет наличие субъектов, которые не используются в течение определенного времени, и отключает их. Отключенные субъекты могут быть удалены при сборке мусора средой CLR.

Что считается «использованием» субъекта в контексте сборки мусора

- Получение вызова.
- Вызов метода `IRemindable.ReceiveReminderAsync` (применимо только в том случае, если субъект использует напоминания).

Следует отметить, что если субъект использует таймеры и выполняется обратный вызов по таймеру, то субъект **не** считается «используемым».

Прежде чем перейти к подробному рассмотрению сборки мусора, важно определить два понятия.

- *Интервал сканирования* — это интервал, с которым среда выполнения проверяет таблицу активных субъектов, чтобы определить, какие субъекты можно удалить во время сборки мусора. По умолчанию интервал равен 1 минуте.
- *Время ожидания в состоянии простоя* — это период времени, в течение которого субъект должен находиться в неиспользуемом состоянии (в состоянии простоя) до того, как он будет удален сборщиком мусора. По умолчанию это время равно 60 минутам.

Как правило, эти значения изменять не требуется. Однако при необходимости их можно изменить на уровне сборки для всех типов субъектов в ней или на уровне типов субъектов с помощью атрибута `ActorGarbageCollection`. Ниже приведен пример изменения интервалов сборки мусора для HelloActor.

```csharp
[ActorGarbageCollection(IdleTimeoutInSeconds = 10, ScanIntervalInSeconds = 2)]
class HelloActor : Actor, IHello
{
    public Task<string> SayHello(string greeting)
    {
        return Task.FromResult("You said: '" + greeting + "', I say: Hello Actors!");
    }
}
```

Чтобы изменить значение по умолчанию атрибута `ActorGarbageCollection` на уровне сборки, добавьте следующий фрагмент в файл `AssemblyInfo.cs`.

```csharp
[assembly: ActorGarbageCollection(IdleTimeoutInSeconds = 10, ScanIntervalInSeconds = 2)]
```

Для каждого субъекта в таблице активных субъектов среда выполнения субъектов хранит информацию о времени, в течение которого он простаивает (не используется). Среда проверяет каждый субъект с интервалом `ScanIntervalInSeconds`, чтобы узнать, можно ли его удалить во время сборки мусора, и забирает его, если он не используется в течение срока, равного `IdleTimeoutInSeconds`.

При каждом использовании субъекта его время простоя обнуляется, после чего сборщик мусора сможет его удалить, только если субъект снова будет бездействовать в течение срока, равного `IdleTimeoutInSeconds`. Считается, что субъект был использован, если метод вызван через интерфейс субъекта или если выполнен обратный вызов по напоминанию. **Не** считается, что субъект был использован, если выполняется обратный вызов по таймеру.

Ниже приведена схема, иллюстрирующая эти понятия.

![][1]

В примере предполагается, что в таблице активных субъектов есть только один активный субъект. Пример демонстрирует, как вызов методов, напоминания и таймеры влияют на время существования субъекта. Обратите внимание на следующие важные моменты:

- В примере для ScanInterval и IdleTimeout установлены значения 5 и 10 соответственно (единицы измерения не имеют значения, так как цель примера — только проиллюстрировать понятия).
- Поиск субъектов, которые нужно удалить во время сборки мусора, происходит при T = 0, 5, 10, 15, 20 и 25, так как ScanInterval = 5.
- Таймер срабатывает при T = 4, 8, 12, 16, 20 и 24, после чего выполняется обратный вызов. Это не влияет на время простоя субъекта.
- Вызов метода субъекта при T = 7 обнуляет время простоя и откладывает удаление субъекта при сборке мусора.
- При T = 14 выполняется обратный вызов по напоминанию, что снова откладывает удаление субъекта при сборке мусора.
- На момент поиска объектов, которые можно удалить при сборке мусора, при T = 25 время простоя субъекта превышает заданное значение IdleTimeout (10) и субъект удаляется сборщиком мусора.

Обратите внимание, что субъект никогда не удаляется сборщиком мусора, если выполняется какой-либо из его методов, независимо от того, сколько времени занимает выполнение этого метода. Как упоминалось ранее, выполнение методов, определенных в интерфейсе субъекта, и обратных вызовов по напоминанию предотвращает сборку мусора, так как время простоя субъекта обнуляется. Выполнение обратных вызовов по таймеру не обнуляет время простоя. Однако сборка мусора для субъекта откладывается до завершения выполнения функции обратного вызова по таймеру.

<!--Image references-->
[1]: ./media/service-fabric-reliable-actors-lifecycle/garbage-collection.png

<!---HONumber=Oct15_HO3-->