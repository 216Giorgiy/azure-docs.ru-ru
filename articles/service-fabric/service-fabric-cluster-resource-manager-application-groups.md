.<properties
   pageTitle="Диспетчер кластерных ресурсов Service Fabric: группы приложений | Microsoft Azure"
   description="Общие сведения о назначении групп приложений в диспетчере кластерных ресурсов службы Fabric Service"
   services="service-fabric"
   documentationCenter=".net"
   authors="masnider"
   manager="timlt"
   editor=""/>

<tags
   ms.service="Service-Fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="08/19/2016"
   ms.author="masnider"/>

# Введение в группы приложений
Диспетчер кластерных ресурсов Service Fabric, который управляет ресурсами кластера, обычно равномерно распределяет нагрузку (представленную в метриках) по всему кластеру. Service Fabric также управляет емкостью узлов в кластере и кластером в целом в рамках концепции емкости. Это применимо для многих типов рабочих нагрузок, но для структур, активно использующих разные экземпляры приложений Service Fabric, иногда возникают дополнительные требования. К таким дополнительным требованиям обычно относятся:

- возможность резервировать емкость для служб экземпляров приложений на некотором количестве узлов;
- возможность ограничивать общее количество узлов, на которых может выполняться определенный набор служб в рамках приложения;
- определение емкости для самого экземпляра приложения, чтобы ограничивать внутренний объем потребления ресурсов.

Чтобы выполнить эти требования, мы организовали поддержку так называемых групп приложений.

## Управление емкостью приложения
Емкость приложения можно использовать для ограничения количества узлов, используемых приложением, а также общей нагрузки, представленной метриками, для экземпляров приложений на отдельных узлах. Также вы можете резервировать ресурсы кластера для приложения.

Емкость приложения можно настраивать при создании новых приложений или уже существующих (созданных без указания емкости приложения).

### Ограничение максимального количества узлов
В простейшем варианте использования емкость приложения позволяет ограничить количество узлов, на которых создаются экземпляры приложения. Если емкость приложения не указана, диспетчер кластерных ресурсов Service Fabric будет создавать реплики по обычным правилам (для балансировки или дефрагментации). Обычно это означает, что службы будут распределены по всем доступным узлам в кластере или по некоторому произвольному меньшему количеству узлов, если включена дефрагментация.

На следующем рисунке показаны варианты размещения экземпляра приложения для сценария, в котором не ограничено максимальное количество узлов. Рядом показан сценарий с тем же приложением, когда указано максимальное количество узлов. Обратите внимание: такой подход не определяет, какие реплики или экземпляры каких служб будут расположены вместе.

![Определение максимального количества узлов для экземпляров приложения][Image1]

В примере слева для приложения с тремя службами не задана емкость приложения. Логичное решение CRM — распределить реплики по всем шести доступным узлам, чтобы сбалансировать нагрузку на кластер. В примере справа мы видим то же приложение, но с установленным ограничением до трех узлов. Service Fabric CRM использует оптимальное соотношение реплик для служб этого приложения.

Такое поведение управляется параметром MaximumNodes. Этот параметр можно задать при создании приложения или обновить для уже запущенного экземпляра приложения. В этом случае Service Fabric CRM будет ограничивать количество реплик служб приложения в соответствии с определенным максимальным количеством узлов.

PowerShell

``` posh
New-ServiceFabricApplication -ApplicationName fabric:/AppName -ApplicationTypeName AppType1 -ApplicationTypeVersion 1.0.0.0 -MaximumNodes 3
Update-ServiceFabricApplication –Name fabric:/AppName –MaximumNodes 5
```

C#

``` csharp
ApplicationDescription ad = new ApplicationDescription();
ad.ApplicationName = new Uri("fabric:/AppName");
ad.ApplicationTypeName = "AppType1";
ad.ApplicationTypeVersion = "1.0.0.0";
ad.MaximumNodes = 3;
fc.ApplicationManager.CreateApplicationAsync(ad);

ApplicationUpdateDescription adUpdate = new ApplicationUpdateDescription(new Uri("fabric:/AppName"));
adUpdate.MaximumNodes = 5;
fc.ApplicationManager.UpdateApplicationAsync(adUpdate);

var appMetric = new ApplicationMetricDescription();
appMetric.Name = "Metric1";
appMetric.TotalApplicationCapacity = 1000;

adUpdate.Metrics.Add(appMetric);
```

## Метрики, нагрузка и емкость приложения
Группы приложений позволяют также определять метрики, связанные с определенным экземпляром приложения, а также емкость приложения для этих метрик. Например, вы можете определить, сколько служб будет создаваться.

Для каждой метрики вы можете задать два значения, которые описывают емкость для экземпляра приложения.

-	Общая емкость приложения — представляет общую емкость всего приложения по определенной метрике. Service Fabric CRM попытается удерживать сумму показателей по этой метрике для всех служб этого приложения не выше указанного ограничения. Более того, если службы приложения уже создают предельную нагрузку, диспетчер кластерных ресурсов Service Fabric запретит создание новых служб или секций, которые могут привести к превышению заданного ограничения.
-	Максимальная емкость узла — определяет максимальную общую нагрузку для реплик служб приложения на одном узле. Если общая нагрузка на одном узле превысит эту емкость, Service Fabric CRM попытается переместить реплики на другие узлы, чтобы соблюдать ограничение по емкости.

## Резервирование емкости
Другой распространенный вариант использования групп приложения — резервирование ресурсов кластера для конкретного экземпляра приложения, который еще не содержит службы или содержит службы, которые пока не потребляют ресурсы. Рассмотрим, как это должно работать.

### Минимальное количество узлов и резервирование ресурсов
Чтобы зарезервировать ресурсы для экземпляра приложения, следует использовать два других дополнительных параметра: *MinimumNodes* и *NodeReservationCapacity*.

- MinimumNodes — позволяет указать минимальное количество узлов, на которых должно выполняться приложение. Этот параметр используется примерно так же, как и максимальное количество узлов, на которых могут работать службы приложения. Этот параметр фактически определяет количество узлов, на которых будут зарезервированы ресурсы, обеспечивая определенную емкость ресурсов кластера для экземпляра приложения при его создании.
- NodeReservationCapacity — этот параметр можно установить для любой метрики в пределах приложения. Он устанавливает, какая величина этой метрики будет зарезервирована для приложения на любом узле, на котором размещаются любые реплики или экземпляры служб этого приложения.

Рассмотрим пример резервирования емкости.

![Определение резервируемой емкости для экземпляров приложения][Image2]

В примере слева для приложений не определены параметры емкости. Диспетчер кластерных ресурсов Service Fabric распределяет реплики и экземпляры дочерних служб как нашего приложения, так и других приложений, поддерживая баланс в кластере.

В примере справа мы предположили, что при создании приложения параметру MinimumNodes присвоено значение 2, параметру MaximumNodes — значение 3, а также определена метрика с резервированием на уровне 20. Максимальная емкость одного узла составляет 50, а общая емкость приложения — 100. Service Fabric в такой ситуации будет резервировать для синего приложения ресурсы на двух узлах, и не позволит использовать эту емкость другим репликам в этом кластере. Зарезервированная для приложения емкость будет считаться потребляемой и будет учитываться при определении доступной емкости кластера.

Если приложение создается с резервированием, диспетчер кластерных ресурсов зарезервирует в кластере емкость, равную произведению MinimumNodes на NodeReservationCapacity. Но он не резервирует емкость на конкретных узлах, пока на них не будут созданы или перемещены реплики служб приложения. Это обеспечивает гибкость, так как узлы назначаются для новых реплик только при их создании. Емкость резервируется на конкретном узле, когда на нем появляется хотя бы одна реплика.

## Получение сведений о нагрузке приложения
Для каждого приложения с определенной емкостью вы можете получить сведения о суммарной нагрузке, создаваемой репликами его служб. В Service Fabric для этого можно использовать запросы PowerShell и управляемого API.

Например, следующий командлет PowerShell позволяет получить информацию о нагрузке:

``` posh
Get-ServiceFabricApplicationLoad –ApplicationName fabric:/MyApplication1

```

Результаты этого запроса содержат основные сведения о емкости приложения, которая была указана для приложения, в том числе параметры для минимального и максимального количества узлов. Также будут предоставлены сведения о количестве узлов, используемых приложением в текущий момент. Так, для каждой метрики нагрузки вы получите следующие данные.
- Metric Name: имя метрики.
-	Reservation Capacity: емкость, зарезервированная в кластере для этого приложения.
-	Application Load: общая нагрузка, создаваемая дочерними репликами этого приложения.
-	Application Capacity: максимально допустимое значение нагрузки приложения.

## Удаление емкости приложения
Когда для приложения будут установлены параметры емкости приложения, их можно будет удалить с помощью API-интерфейсов обновления приложения или командлетов PowerShell. Например:

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 –RemoveApplicationCapacity

```

Эта команда удалит все параметры емкости приложения, установленные для приложения. После этого диспетчер кластерных ресурсов Service Fabric будет обрабатывать это приложение как обычное приложение, для которого эти параметры не определены. Команда применяется немедленно, и диспетчер ресурсов кластера удаляет все параметры емкости приложения, установленные для этого приложения. Чтобы снова применить эти параметры, следует снова вызвать API-интерфейсы обновления приложения с соответствующими параметрами.

## Ограничения на емкость приложений
Существует ряд ограничений на параметры емкости приложений, которые необходимо соблюдать. Если при проверке параметров обнаружатся ошибки, создание или обновление приложения будет отклонено. Все числовые параметры должны иметь неотрицательные значения. Также есть следующие ограничения для отдельных параметров.

-	MinimumNodes не может иметь значение больше, чем MaximumNodes.
-	Если определены емкости для метрики нагрузки, они должны соответствовать следующим правилам.
  - NodeReservationCapacity не может иметь значение больше, чем MaximumNodeCapacity. Например, вы не можете для показателя ЦП на узле установить ограничение в 2 единицы и одновременно зарезервировать по 3 единицы этого ресурса на каждом узле.
  - Если указан параметр MaximumNodes, произведение значений MaximumNodes и MaximumNodeCapacity не может быть больше, чем значение TotalApplicationCapacity. Например, если максимальная емкость узла для метрики нагрузки ЦП имеет значение 8, а максимальное количество узлов имеет значение 10, общая емкость приложения для этой метрики нагрузки должна быть больше 80.

Эти ограничения применяются как при создании приложения (на стороне клиента), так и при его обновлении (на стороне сервера). Ниже указан пример команды создания приложения, в котором явно нарушены описанные выше требования (MaximumNodes < MinimumNodes). Такая команда завершится ошибкой в клиенте до этапа отправки запроса в кластер Service Fabric.

``` posh
New-ServiceFabricApplication –Name fabric:/MyApplication1 –MinimumNodes 6 –MaximumNodes 2
```

Ниже приведен пример недопустимого обновления. Если мы хотим для существующего приложения указать некоторое значение максимального количества узлов, запрос на обновление будет выглядеть так:

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 6 –MaximumNodes 2
```

Предположим, что после этого мы пытаемся обновить минимальное количество узлов:

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 6 –MinimumNodes 6
```

Клиент не имеет достаточной информации о приложении, поэтому такое обновление будет передано в кластер Service Fabric. Однако затем Service Fabric проверит новый параметр для этого кластера вместе с другими установленными параметрами. Обновление завершится сбоем, так как предложенное минимальное количество узлов превышает установленное максимальное количество узлов. В этом случае параметры емкости приложения останутся неизменными.

Эти ограничения нужны для того, чтобы позволить диспетчеру кластерных ресурсов правильно размещать реплики служб приложения.

## Как не следует использовать емкость приложения

-	Не пытайтесь с помощью емкости приложения привязать приложение к конкретному набору узлов. Хотя Service Fabric будет соблюдать максимальное количество узлов для каждого приложения с указанной емкостью, пользователь не сможет выбрать, на каких именно узлах это приложение будет развертываться. Для этого следует использовать ограничения на размещение для служб.
-	Не пытайтесь с помощью емкости приложений разместить две службы одного приложения вместе. Для этого можно использовать отношения сходства между службами, но их следует применять только для тех служб, для которых совместное размещение действительно необходимо.

## Дальнейшие действия
- Дополнительные сведения о других вариантах настройки служб см. в статье [Настройка параметров диспетчера кластерных ресурсов для служб Service Fabric](service-fabric-cluster-resource-manager-configure-services.md).
- Чтобы узнать, как диспетчер кластерных ресурсов управляет нагрузкой кластера и балансирует ее, ознакомьтесь со статьей о [балансировке нагрузки](service-fabric-cluster-resource-manager-balancing.md).
- Начните с самого начала, [изучив общие сведения о диспетчере кластерных ресурсов Service Fabric](service-fabric-cluster-resource-manager-introduction.md).
- Дополнительные сведения об использовании метрик см. в статье [Управление потреблением ресурсов и нагрузкой в Service Fabric с помощью метрик](service-fabric-cluster-resource-manager-metrics.md).
- В диспетчере кластерных ресурсов много параметров для описания кластера. Дополнительные сведения о них см. в статье с [описанием кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).


[Image1]: ./media/service-fabric-cluster-resource-manager-application-groups/application-groups-max-nodes.png
[Image2]: ./media/service-fabric-cluster-resource-manager-application-groups/application-groups-reserved-capacity.png

<!---HONumber=AcomDC_0824_2016-->