---
title: "Приложение для управления исправлениями Azure Service Fabric | Документация Майкрософт"
description: "Приложение для автоматизации установки исправлений ОС в кластере Service Fabric."
services: service-fabric
documentationcenter: .net
author: novino
manager: timlt
editor: 
ms.assetid: de7dacf5-4038-434a-a265-5d0de80a9b1d
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 5/9/2017
ms.author: nachandr
ms.translationtype: Human Translation
ms.sourcegitcommit: 95b8c100246815f72570d898b4a5555e6196a1a0
ms.openlocfilehash: a3554881e7db894c602e73feb385b5b361837409
ms.contentlocale: ru-ru
ms.lasthandoff: 05/18/2017


---

# <a name="application-to-patch-windows-os-in-your-service-fabric-cluster"></a>Приложение для установки исправлений ОС Windows в кластере Service Fabric

Приложение для управления исправлениями — это приложение Service Fabric, которое позволяет автоматизировать установку исправлений ОС в кластере Service Fabric в Azure или локальной среде без простоев.

Приложение для управления исправлениями имеет следующие ключевые функции:

1. **Автоматическая установка обновлений ОС.** Приложение для управления исправлениями обеспечивает автоматическое скачивание и установку обновлений (при необходимости узел перезагружается).
    Это делается на всех узлах кластера без простоев.

1. **Исправление с учетом состояния кластера и интеграция функций работоспособности.** Во время применения обновлений приложение для управления исправлениями контролирует работоспособность кластера, обновляя по одному узлу или по одному домену обновления за раз. 
    Если приложение обнаружит, что работоспособность кластера ухудшается из-за установки исправлений, оно остановит процесс, чтобы проблема не усугублялась.

1. **Поддержка всех кластеров Service Fabric.** Приложение достаточно универсально, чтобы работать как в кластерах Azure Service Fabric, так и в автономных кластерах.
    > [!NOTE]
    > Поддержка автономных кластеров будет реализована в ближайшее время.

## <a name="link-to-download-the-application-package"></a>Ссылка на скачивание пакета приложения

Скачайте приложение по [этой ссылке](https://go.microsoft.com/fwlink/P/?linkid=849590).

## <a name="internal-details-of-the-application"></a>Внутренние сведения приложения

Приложение для управления исправлениями состоит из следующих подкомпонентов:

- **Служба координатора** — это служба с отслеживанием состояния. Она отвечает за:
    - координацию задания обновления Windows во всем кластере;
    - хранение результатов завершенных операций обновления Windows.
- **Служба агента узла** — это служба без отслеживания состояния, которая выполняется на всех узлах кластера Service Fabric. Она отвечает за:
    - начальную загрузку NTService агента узла;
    - мониторинг службы NTService агента узла.
- **NTService агента узла** — это служба Windows NT. Служба NTService агента узла работает с более высокими привилегиями (система). Служба агента узла и служба координатора, в свою очередь, выполняются с привилегиями более низкого уровня (сетевая служба). Служба отвечает за выполнение следующих заданий обновления Windows на всех узлах кластера:
    - выключение автоматического обновления Windows на узле;
    - скачивание и установку обновлений Windows в соответствии с предоставленной пользователем политикой;
    - перезапуск машины после установки обновлений Windows;
    - передачу результатов обновления Windows в службу координатора;
    - сообщение сведений о работоспособности, если операцию не удалось выполнить, исчерпав все повторные попытки.

> [!NOTE]
> Приложение для управления исправлениями использует системную службу Service Fabric под названием **Repair Manager** для включения и выключения узла и выполнения проверки работоспособности. Задание восстановления, созданное приложением для управления исправлениями, отслеживает ход обновления Windows для каждого узла.

## <a name="prerequisites-for-using-the-application"></a>Предварительные требования для использования приложения

### <a name="ensure-service-fabric-version-is-55-or-above"></a>Использование Service Fabric версии 5.5 или выше

Приложение для управления исправлениями может выполняться на кластерах со средой выполнения Service Fabric версии 5.5 или выше.

### <a name="enable-repair-manager-service-if-not-running-already"></a>Включение службы Repair Manager (если еще не запущена)

Приложению для управления исправлениями необходимо, чтобы системная служба Repair Manager была включена в кластере.

#### <a name="service-fabric-clusters-on-azure"></a>Кластеры Service Fabric в Azure

В кластерах Azure на уровне надежности Silver Repair Manager включен по умолчанию. В кластерах Azure на уровне надежности Gold Repair Manager может быть не включен, в зависимости от того, как давно были созданы эти кластеры. В кластерах Azure на уровне надежности Bronze Repair Manager по умолчанию не включен. 

Вы можете использовать [шаблон Azure Resource Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm) для включения службы Repair Manager в новых или имеющихся кластерах Service Fabric в случае, если вы не видите эту службу в разделе системных служб в Service Fabric Explorer.

Сначала следует получить шаблон для кластера, который требуется развернуть. Можно использовать примеры шаблонов или создать пользовательский шаблон Resource Manager. Затем вы можете включить Repair Manager, выполнив следующие действия:

1. Сначала убедитесь, что `apiversion` ресурса `Microsoft.ServiceFabric/clusters` имеет значение `2017-07-01-preview`, как показано в следующем фрагменте. Если оно отличается, то необходимо задать для `apiVersion` значение `2017-07-01-preview`.

    ```json
    {
        "apiVersion": "2017-07-01-preview",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        ...
    }
    ```

2. Включите службу Repair Manager, добавив следующий раздел `addonFeaturres` после раздела `fabricSettings`, как показано ниже.

    ```json
    "fabricSettings": [
        ...      
        ],
        "addonFeatures": [
            "RepairManager"
        ],
    ```

3. После обновления шаблона кластера примените изменения и дождитесь завершения обновления. По завершении вы увидите, что системная служба Repair Manager выполняется в кластере, который называется `fabric:/System/RepairManagerService`, в разделе системных служб в Service Fabric Explorer. 

#### <a name="standalone-on-premise-clusters"></a>Автономные локальные кластеры

> [!NOTE]
> Поддержка автономных кластеров будет реализована в ближайшее время.

### <a name="disable-automatic-windows-update-on-all-nodes"></a>Отключение автоматического обновления Windows на всех узлах

Включенное автоматическое обновление Windows в кластере Service Fabric может вызвать потерю доступности, так как несколько узлов могут перезапуститься одновременно для завершения обновления.

Приложение для управления исправлениями по умолчанию попытается выключить автоматическое обновление Windows на каждом узле кластера.

Тем не менее в случае, если параметры задаются администратором или групповой политикой, мы советуем явно настроить для политики обновления Windows параметр уведомления о скачивании.


### <a name="optional-enable-windows-azure-diagnostics"></a>Включение системы диагностики Microsoft Azure (необязательно)

Скоро журналы приложения для управления исправлениями будут собираться как часть журналов Service Fabric. Однако до этих пор журналы будут собираться локально на каждом узле кластера. Мы советуем настроить систему диагностики Microsoft Azure таким образом, чтобы журналы, отправленные со всех узлов, сохранялись центре.

Инструкции по включению системы диагностики Microsoft Azure см. в статье [Сбор журналов с помощью системы диагностики Azure](https://docs.microsoft.com/azure/service-fabric/service-fabric-diagnostics-how-to-setup-wad).

Журналы приложения для управления исправлениями будут формироваться в расположениях, соответствующих следующим фиксированным идентификаторам поставщиков.

- e39b723c-590c-4090-abb0-11e3e6616346
- fc0028ff-bfdc-499f-80dc-ed922c52c5e9
- 24afa313-0d3b-4c7c-b485-1047fd964b60
- 05dc046c-60e9-4ef7-965e-91660adffa68

В разделе "WadCfg" шаблона Azure Resource Manager добавьте следующий раздел: 

```json
"PatchOrchestrationApplication": \[
  {
    "provider": "e39b723c-590c-4090-abb0-11e3e6616346",
    "scheduledTransferPeriod": "PT5M",
    "DefaultEvents": {
      "eventDestination": "PatchOrchestrationApplicationTable"
    }
  },
  {
    "provider": "fc0028ff-bfdc-499f-80dc-ed922c52c5e9",
    "scheduledTransferPeriod": "PT5M",
    "DefaultEvents": {
    "eventDestination": " PatchOrchestrationApplicationTable"
    }
  },
  {
    "provider": "24afa313-0d3b-4c7c-b485-1047fd964b60",
    "scheduledTransferPeriod": "PT5M",
    "DefaultEvents": {
    "eventDestination": " PatchOrchestrationApplicationTable"
    }
  },
  {
    "provider": "05dc046c-60e9-4ef7-965e-91660adffa68",
    "scheduledTransferPeriod": "PT5M",
    "DefaultEvents": {
    "eventDestination": " PatchOrchestrationApplicationTable"
    }
  },
\]
```

> [!NOTE]
> Если кластер Service Fabric состоит из нескольких типов узлов, то этот раздел должен быть добавлен для всех разделов "WadCfg".

## <a name="configuring-the-application"></a>Настройка приложения

Ниже перечислены конфигурации, которые пользователь может задать для настройки поведения приложения для управления исправлениями в соответствии с его потребностями.

Значения по умолчанию можно переопределить, передав параметр приложения во время создания или обновления приложения. Параметры приложения могут быть заданы указанием параметра `ApplicationParameter` командлету `Start-ServiceFabricApplicationUpgrade` или `New-ServiceFabricApplication`.

|**Параметр**        |**Тип**                          | **Дополнительные сведения**|
|:-|-|-|
|MaxResultsToCache    |длинное целое                              | Максимальное количество историй результатов Центра обновления Windows, которые необходимо кэшировать. <br>Значение по умолчанию — 3000 при условии, что: <br> количество узлов — 20; <br> количество обновлений, происходящих на узле в месяц, — 5; <br> количество результатов на операцию может быть 10; <br> результаты за последние 3 месяца должны быть сохранены. |
|TaskApprovalPolicy   |Перечисление. <br> { NodeWise, UpgradeDomainWise }                          |TaskApprovalPolicy указывает политику, которая будет использоваться службой координатора для установки обновлений Windows на узлы кластера Service Fabric.<br>                         Допустимые значения: <br><br>                                                           <b>NodeWise</b> — обновление Windows устанавливается на один узел за раз. <br>                                                           <b>UpgradeDomainWise</b> — обновление Windows будет устанавливаться на один домен обновления за раз (как максимум на всех узлах, принадлежащих домену обновления).
|LogsDiskQuotaInMB   |длинное целое  <br> (значение по умолчанию: 1024)               |Максимальный размер журналов приложения для управления исправлениями в мегабайтах, которые могут быть сохранены локально на узле.
| WUQuery               | string<br>(значение по умолчанию: IsInstalled=0)                | Запрос для получения обновлений Windows. Дополнительные сведения см. в статье о методе поиска [IUpdateSearcher::Search](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
| InstallWindowsOSOnlyUpdates | Bool <br> (значение по умолчанию: True)                 | Этот параметр позволяет устанавливать обновления ОС Windows.            |
| WUOperationTimeOutInMinutes | int <br>(значение по умолчанию: 90)                   | Указывает время ожидания для любой операции обновления Windows (поиск, скачивание, установка). Если операция не завершена по истечении заданного времени ожидания, она будет прервана.       |
| WURescheduleCount     | int <br> (значение по умолчанию: 5)                  | Эта конфигурация определяет, какое максимальное количество раз служба может изменять расписание обновления Windows в случае постоянных сбоев операции.          |
| WURescheduleTimeInMinutes | int <br>(значение по умолчанию: 30) | Эта конфигурация определяет интервал, согласно которому служба будет назначать обновление Windows, если сбой продолжает происходить. |
| WUFrequency           | Строка с разделителями-запятыми (по умолчанию: Weekly, Wednesday, 7:00:00)     | Частота установки обновлений Windows. Формат и возможные значения приведены ниже. <br>Monthly, день, ЧЧ:ММ:СС. Например, Monthly, 5, 12:22:32. <br> Weekly, день, ЧЧ:ММ:СС. Например, Weekly, Tuesday, 12:22:32.  <br> Daily, ЧЧ:ММ:СС. Например, Daily, 12:22:32.  <br> None — указывает, что обновление Windows не должно выполняться.  <br><br> Примечание. Все значения времени указаны в формате UTC.|
| AcceptWindowsUpdateEula | Bool <br>(значение по умолчанию: True) | Если задать этот параметр, приложение принимает лицензионное соглашение для обновления Windows от имени владельца компьютера.              |


## <a name="steps-to-deploy-the-application"></a>Шаги для развертывания приложения

1. Завершите все предварительные шаги, чтобы подготовить кластер.
1. Развернуть приложение можно с помощью PowerShell. Дополнительные сведения см. в статье [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).
1. Для настройки приложения во время развертывания используйте параметр `ApplicationParamater` для командлета `New-ServiceFabricApplication`.

    Для удобства пользователя вместе с нашим приложением мы предоставили сценарий Deploy.ps1. Чтобы использовать его, сделайте следующее:

    - Подключитесь к кластеру Service Fabric с помощью `Connect-ServiceFabricCluster`.
    - Выполните сценарий PowerShell Deploy.ps1 с соответствующим значением `ApplicationParameter`.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="steps-to-upgrade-the-application"></a>Действия по обновлению приложения

Дополнительные сведения об обновлении существующего приложения для управления исправлениями с помощью PowerShell см. в [этой статье](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-upgrade-tutorial-powershell).

Чтобы изменить только параметры приложения, предоставьте `ApplicationParamater` командлету `Start-ServiceFabricApplicationUpgrade` с существующей версией приложения.

## <a name="steps-to-remove-the-application"></a>Действия по удалению приложения

Сведения об удалении приложения см. в статье [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).

Для удобства пользователя вместе с нашим приложением мы предоставили сценарий Undeploy.ps1. Чтобы использовать его, сделайте следующее:
    - Подключитесь к кластеру Service Fabric с помощью ```Connect-ServiceFabricCluster```.
    - Выполните сценарий PowerShell Undeploy.ps1.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="viewing-the-windows-update-results"></a>Просмотр результатов обновления Windows

Приложение для управления исправлениями предоставляет REST API для отображения исторических результатов пользователю.

Чтобы запросить результаты обновления Windows, необходимо войти в кластер, а затем узнать адрес реплики для первичной службы координатора и перейти по этому URL-адресу в браузере.
http://&lt;адрес_реплики&gt;:&lt;порт_приложения&gt;/PatchOrchestrationApplication/v1/GetWindowsUpdateResults. Конечная точка REST для службы координатора имеет динамический порт. Чтобы узнать точный URL-адрес, обратитесь к Service Fabric Explorer.
Для примера ниже результаты будут доступны по адресу `http://10.0.0.7:20000/PatchOrchestrationApplication/v1/GetWindowsUpdateResults`
![Представление конечной точки REST](media/service-fabric-patch-orchestration-application/Rest_Endpoint.png).


Пользователь может также получить доступ к URL-адресу за пределами кластера, если в кластере включен обратный прокси-сервер.
Конечная точка, к которой нужно перейти: http://&lt;URL-адрес_сервера&gt;:&lt;порт_обратного_прокси&gt;/PatchOrchestrationApplication/CoordinatorService/v1/GetWindowsUpdateResults. Обратный прокси-сервер можно включить в кластере, выполнив шаги из статьи [Обратный прокси-сервер в Azure Service Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-reverseproxy). 

> 
> [!WARNING]
> Настройка обратного прокси-сервера обеспечит адресацию извне кластера всех микрослужб в этом кластере, которые предоставляют конечную точку HTTP.

## <a name="diagnostics--health-events"></a>События диагностики и работоспособности

### <a name="collecting-patch-orchestration-application-logs"></a>Сбор журналов приложения для управления исправлениями

Скоро журналы приложения для управления исправлениями будут собираться как часть журналов Service Fabric.
До этого времени журналы можно собрать одним из следующих способов.

#### <a name="locally-on-each-node"></a>Локально на каждом узле

Журналы собираются локально на каждом узле кластера Service Fabric. Журналы располагаются в каталоге "\[Диск\_установки\_Service Fabric\]:\\PatchOrchestrationApplication\\logs".

Например, если Service Fabric установлена на диске D, путь будет иметь следующий вид: "D:\\PatchOrchestrationApplication\\logs".

#### <a name="central-location"></a>Центральное расположение

Если система диагностики Microsoft Azure была настроена предварительно, то журналы приложения для управления исправлениями будут доступны в службе хранилища Azure.

### <a name="health-reports"></a>Отчеты о работоспособности

Приложение для управления исправлениями также публикует отчеты о работоспособности для службы координатора или службы агента узла в приведенных ниже случаях.

#### <a name="windows-update-operation-failed"></a>Сбой операции обновления Windows

Если сбой операции обновления Windows происходит на узле, будет создан отчет о работоспособности службы агента узла.
В подробных сведениях об отчете о работоспособности будет содержаться имя проблемного узла.

Отчет будет автоматически очищен после того, как исправление будет успешно установлено на проблемном узле.

#### <a name="node-agent-ntservice-is-down"></a>Служба NTService агента узла не работает

Если служба NTService агента узла не работает на узле, будет сгенерирован отчет о работоспособности уровня предупреждения в отношении службы агента узла.

#### <a name="repair-manager-is-not-enabled"></a>Repair Manager не включен

Если служба Repair Manager не найдена в кластере, для службы координатора создается отчет о работоспособности уровня предупреждения.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

В. **Мой кластер находится в состоянии ошибки, когда работает приложение для управления исправлениями**.

О. Приложение для управления исправлениями может отключать и перезапускать узлы во время процесса установки, что может временно привести к ухудшению работоспособности кластера.

Основываясь на политике приложения, любой узел может выйти из строя во время операции установки исправления или же сбой может произойти во всем домене обновления.

Обратите внимание, что к концу установки обновлений Windows узлы будут повторно включены после перезагрузки.

Пример. В представленном ниже сценарии кластер временно перешел в состояние ошибки из-за 2 неработающих узлов и нарушения политики MaxPercentageUnhealthNodes. Это временная ошибка. Она исчезнет, как только операция установки исправлений будет завершена.

![Представление неработоспособного кластера](media/service-fabric-patch-orchestration-application/MaxPercentage_causing_unhealthy_cluster.png)

Если проблема не будет устранена, см. сведения в разделе об устранении неполадок.

В. **Можно ли использовать приложение управления исправлениями для автономных кластеров?**

О. Пока нет. Поддержка автономных кластеров будет реализована в ближайшее время.

В. **Приложение для управления исправлениями находится в состоянии предупреждения.**

О. Проверьте, является ли отчет о работоспособности, опубликованный для приложения, основной причиной. Обычно в описании предупреждения содержатся сведения о проблеме.
Если проблема временная, приложение автоматически восстановится из этого состояния.

В. **Кластер находится в неработоспособном состоянии. Однако необходимо срочно выполнить обновление операционной системы.**

О. Приложение для управления исправлениями не устанавливает обновления, пока кластер находится в неработоспособном состоянии.
Попробуйте перевести кластер в работоспособное состояние, чтобы разблокировать рабочий процесс приложения для управления исправлениями.

В. **Почему операция исправления в кластере так долго выполняется?**

О. Время, необходимое приложению для управления исправлениями, обычно зависит от следующих факторов:

- Политика службы координатора. В соответствии с политикой по умолчанию (`NodeWise`) выполняется исправление только одного узла за раз. В случае больших кластеров мы советуем использовать политику `UpgradeDomainWise`, чтобы исправление в кластере выполнялось быстрее.
- Количество обновлений, доступных для скачивания и установки. Среднее время, необходимое для скачивания и установки, не превышает несколько часов.
- Производительность виртуальных машин и пропуская способность сети.

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- Приложение для управления исправлениями принимает лицензионное соглашение Центра обновления Windows от имени пользователя. При необходимости этот параметр можно отключить в конфигурации приложения.

- Приложение для управления исправлениями собирает данные телеметрии для отслеживания использования и производительности.
    Телеметрия приложения выполняется в соответствии с настройкой телеметрии в среде выполнения Service Fabric (которая включена по умолчанию).

## <a name="troubleshooting-help"></a>Справка по устранению неполадок

### <a name="node-not-coming-back-to-up-state"></a>Узел не возвращается в рабочее состояние

**Узел может зависнуть в отключенном состоянии.** Это может произойти, когда узел, который охватывает операция, нельзя отключить из-за ожидания проверки безопасности. В этом случае необходимо убедиться, что достаточное количество узлов находятся в работоспособном состоянии.

**Узел может зависнуть в отключенном состоянии из-за следующих причин:**

- Узел был отключен вручную.
- Узел был отключен из-за текущего задания инфраструктуры Azure.
- Узел был временно отключен приложением управления исправлениями для исправления узла.

**Узел может зависнуть в неработоспособном состоянии из-за следующих причин:**

- Узел был переведен в неработоспособное состояние вручную.
- Узел перезапускается (может быть запущен приложением управления исправлениями).
- Узел не работает из-за неисправности виртуальной машины, компьютера или проблем с подключением.

### <a name="updates-were-skipped-on-some-nodes"></a>Обновления на некоторых узлах пропущены

Приложение управления исправлениями пытается установить обновление Windows согласно политике переноса. Служба попытается восстановить узел и пропустить обновление в соответствии с политикой приложения.

В этом случае для службы узла агента будет создан отчет о работоспособности уровня предупреждения.
Результат обновления Windows также должен содержать возможные причины сбоя.

### <a name="health-of-the-cluster-goes-to-error-while-update-was-getting-installed"></a>Кластер перешел в неработоспособное состояние при установке обновления.

Некорректное обновление Windows может вызвать сбой работоспособности приложения или кластера в определенном узле или домене обновления. Приложение для управления исправлениями останавливает обновление Windows, пока кластер не станет снова работоспособен.

Администратор должен разобраться, почему обновление Windows приводит к ухудшению работоспособности приложения или кластера.

