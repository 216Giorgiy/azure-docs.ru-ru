<properties 
   pageTitle="Сценарии Testability Service Fabric: взаимодействие между службами" 
   description="Взаимодействие между службами — критически важная точка интеграции приложения Service Fabric. В этой статье обсуждаются вопросы разработки и методы тестирования." 
   services="service-fabric" 
   documentationCenter=".net" 
   authors="vturecek" 
   manager="timlt" 
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA" 
   ms.date="08/25/2015"
   ms.author="vturecek"/>

# Сценарии Testability Service Fabric: взаимодействие между службами

Микрослужбы и стили сервисноориентированной архитектуры естественным образом развертываются на платформе Service Fabric. В распределенных архитектурах этих типов компонентные приложения микрослужб обычно состоят из нескольких служб, которые должны взаимодействовать друг с другом. Даже в простейшем случае у вас обычно имеется по крайней мере веб-служба без отслеживания состояния и служба хранилища данных с отслеживанием состояния, которые должны взаимодействовать друг с другом.

Взаимодействие между службами — критически важная точка интеграции приложения, так как каждая служба предоставляет удаленный интерфейс API для других служб. Работа с набором границ API, включающая ввод-вывод данных, обычно требует тщательного подхода с интенсивным тестированием и проверкой.

При объединении этих границ служб другом в распределенной системе следует ответить на ряд вопросов.

 - **Транспортный протокол**. Вы будете использовать протокол HTTP для улучшения взаимодействия или пользовательский двоичный протокол, чтобы обеспечить максимальную пропускную способность?
 - **Обработка ошибок**. Как обрабатываются постоянные и временные ошибки? Что происходит, когда служба перемещается на другой узел?
 - **Время ожидания и задержка**. Как каждый слой службы обрабатывает задержку через стек до пользователя в многоуровневых приложениях?

Если вы используете один из встроенных компонентов взаимодействия между службами, доступных в Service Fabric, или выполняете сборку собственного компонента, тестирование взаимодействия между службами является важнейшей частью обеспечения устойчивости приложения.

## Где находится моя служба?

Экземпляры служб могут со временем перемещаться, особенно если они настроены с использованием метрик нагрузки для оптимальной балансировки ресурсов. Обновления, отработки отказов, масштабирование и другие различные ситуации, которые происходят в течение времени существования распределенной системы, являются расположениями, в которые Service Fabric перемещает экземпляры вашей службы, чтобы обеспечить максимальную доступность.

По мере перемещения служб в кластере существует два сценария, к которым должны быть готовы ваши клиенты и другие службы при взаимодействии со службой.

 + Экземпляр службы или реплика раздела перемещены с момента последнего обмена данными с ними. Это характерно для жизненного цикла службы и вполне может произойти в течение жизненного цикла приложения.
 + Экземпляр службы или реплика раздела перемещается. Хотя отработка отказа службы с одного узла на другой выполняется в Service Fabric очень быстро, возможны задержки в доступности, если компонент связи службы медленно запускается.

Для бесперебойной работы системы важно правильно обрабатывать такие сценарии. Для этого необходимо учесть несколько моментов.

+ Каждая служба, к которой можно подключиться, включает *адрес* для прослушивания (HTTP, WebSockets и т. д.). Если экземпляр службы или раздел перемещены, изменяется адрес их конечной точки (выполняется перемещение на другой узел с другим IP-адресом). Если вы используете встроенные компоненты связи, они будут автоматически обрабатывать повторно разрешающиеся адреса служб. 
+ Может наблюдаться временное увеличение задержки, так как экземпляр службы снова запускает свой прослушиватель в зависимости от того, насколько быстро служба открывает его после перемещения.
+ Все существующие подключения потребуется закрыть и заново открыть при открытии службы на новом узле. Нормальное завершение работы или перезапуск узла обеспечивает экономию времени для нормального завершения работы существующих подключений.

### Тестирование: перемещение экземпляров службы

С помощью средств Testability платформы Service Fabric можно создать сценарий тестирования для проверки этих ситуаций различными способами.

1. Переместите первичную реплику службы с отслеживанием состояния.
 
    Первичную реплику раздела службы с отслеживанием состояния может понадобиться переместить по ряду причин. Используйте это применительно к первичной реплике определенного раздела, чтобы посмотреть, как ваши службы реагируют на перемещение, полностью их контролируя.

    ```powershell

    PS > Move-ServiceFabricPrimaryReplica -PartitionId 6faa4ffa-521a-44e9-8351-dfca0f7e0466 -ServiceName fabric:/MyApplication/MyService

    ```

2. Остановите работу узла.

    Когда работа узла остановлена, Service Fabric переместит все экземпляры служб или раздела, которые находились на этом узле, на один из других доступных узлов в кластере. Используйте это для проверки ситуации, при которой узел теряется из кластера, что приводит к необходимости переместить все экземпляры служб и реплики на этом узле.

    Узел можно остановить с помощью командлета PowerShell Stop-ServiceFabricNode:

    ```powershell

    PS > Restart-ServiceFabricNode -NodeName Node.1

    ```

    
    


### Доступность службы

Service Fabric — это платформа, обеспечивающая высокую доступность служб. Однако проблемы с базовой инфраструктуры все еще могут привести к недоступности в крайних случаях. Поэтому очень важно протестировать и такой сценарий.

В службах с отслеживанием состояния используется система на основе кворума для репликации данных о состоянии и обеспечения высокого уровня доступности. Это значит, что для выполнения операций записи необходимо наличие кворума реплик. В редких случаях, например при масштабном сбое оборудования, кворум реплик может быть недоступен. В этом случае вы не сможете выполнять операции записи, но по-прежнему будете иметь возможность выполнять операции чтения.

### Тестирование: недоступность операции записи

Средства Testability платформы Service Fabric позволяют вносить ошибку, которая приводит к потере кворума, для проверки сценария этого типа. Хотя такие случаи возникают редко, клиенты и службы, которые зависят от службы с отслеживанием состояния, должны быть готовы к ситуациям, когда они не могут отправлять запросы на запись в службу с отслеживанием состояния. В то же время следует помнить, что сама служба с отслеживанием состояния знает о такой возможности и может нормально сообщить о ней вызывающим сторонам.

Потерю кворума можно вызвать с помощью командлета PowerShell Invoke-ServiceFabricPartitionQuorumLoss:

```powershell

PS > Invoke-ServiceFabricPartitionQuorumLoss -ServiceName fabric:/Myapplication/MyService -QuorumLossMode PartialQuorumLoss -QuorumLossDurationInSeconds 20

```

В этом примере мы задаем для параметра `QuorumLossMode` значение `PartialQuorumLoss` для указания о необходимости вызвать потерю кворума без отключения всех реплик, чтобы по-прежнему выполнять операции чтения. Чтобы протестировать сценарий, при котором недоступен весь раздел, для этого параметра можно задать значение `FullQuorumLoss`.

## Дальнейшие действия

[Дополнительные сведения о действиях, доступных благодаря Testability](service-fabric-testability-actions.md)

[Дополнительные сведения о сценариях Testability](service-fabric-testability-scenarios.md)

<!---HONumber=Oct15_HO3-->