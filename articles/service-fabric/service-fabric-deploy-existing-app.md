<properties
   pageTitle="Развертывание настраиваемого приложения в Azure Service Fabric | Microsoft Azure"
   description="Пошаговое руководство по упаковыванию существующего приложения для развертывания в кластере Azure Service Fabric"
   services="service-fabric"
   documentationCenter=".net"
   authors="bmscholl"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="11/17/2015"
   ms.author="bscholl"/>

# Развертывание настраиваемого приложения в Service Fabric

В Service Fabric можно запустить существующее приложение любого типа, например Node.js, Java или приложение в машинном коде. Service Fabric обрабатывает эти приложения как службы без отслеживания состояния и размещает их на узлах в кластере на основе доступности и других метрик. В этой статье описывается упаковка и развертывание существующего приложения в кластере Service Fabric.

## Преимущества выполнения настраиваемого приложения в Service Fabric

Существует несколько преимуществ, связанных с выполнением приложения в кластере Service Fabric.

- Высокий уровень доступности: для приложений, работающих в среде Service Fabric, характерна высокая доступность без дополнительной настройки. Service Fabric гарантирует постоянную работу одного экземпляра приложения.
- Наблюдение за работоспособностью: готовая к использованию функция наблюдения за работоспособностью Service Fabric обнаруживает исправную работу приложения и предоставляет диагностические данные в случае сбоя.   
- Управление жизненным циклом приложения: помимо обновления без времени простоя Service Fabric также позволяет выполнить откат к предыдущей версии в случае возникновения проблемы во время обновления.    
- Плотность: вы можете запускать несколько приложений в кластере, что позволяет отказаться от выполнения каждого приложения на собственном оборудовании.

В этой статье мы рассмотрим основную процедуру упаковки существующего приложения и его развертывания в Service Fabric.


## Краткий обзор файлов манифестов приложений и служб

Перед изучением подробных сведений о развертывании существующего приложения рекомендуется ознакомиться с моделью развертывания и упаковки Service Fabric. Модель развертывания и упаковки Service Fabric основана преимущественно на двух файлах.


* **Манифест приложения**

  Манифест приложения содержит описание приложения и список образующих его служб, а также другие параметры, например количество экземпляров, которые определяют, как будут развертываться службы. Приложение в Service Fabric — расширяемая единица. Приложение можно расширить как единицу, где потенциальные сбои (и потенциальные откаты) управляются платформой, гарантируя, что процесс обновления либо будет полностью успешным, либо, в случае сбоя, не оставит приложение в неизвестном или нестабильном состоянии.


* **Манифест службы**

  Манифест службы описывает ее компоненты. Он включает такие данные, как имя и тип службы (сведения, которые Service Fabric использует для управления службой), ее код, конфигурацию и компоненты данных, а также некоторые дополнительные параметры, которые позволяют настраивать службу после ее развертывания. Мы не будем углубляться в подробности различных параметров, доступных в манифесте службы, но рассмотрим их подмножество, необходимое для запуска существующего приложения в Service Fabric.


## Структура файла пакета приложения
Для развертывания приложения в Service Fabric оно должно следовать предопределенной структуре каталогов. Ниже приведен пример этой структуры.

```
|-- AppplicationPackage
	|-- code
		|-- existingapp.exe
	|-- config
		|--Settings.xml
    |--data    
    |-- ServiceManifest.xml
|-- ApplicationManifest.xml
```

Корневой каталог содержит файл ApplicationManifest.xml, определяющий приложение. Дочерний каталог для каждой службы, включенной в приложение, используется для хранения всех артефактов, необходимых службе: файла ServiceManifest.xml и, как правило, 3 каталогов:

- *code*: содержит код службы.
- *config*: содержит файл settings.xml (и другие файлы в случае необходимости), который служба может использовать во время работы для получения определенных параметров конфигурации.
- *data*: дополнительный каталог для хранения дополнительных локальных данных, необходимых службе. Примечание: каталог Data следует использовать только для хранения временных данных. Service Fabric не копирует и не реплицирует изменения каталога данных, если службу требуется переместить, например во время отработки отказа.

Примечание. Нет необходимости создавать каталоги `config` и `data`, если они вам не нужны.

## Процесс упаковки существующего приложения

Процесс упаковки существующего приложения включает следующие этапы:

- Создание структуры каталогов пакета
- Добавление файлов кода и конфигурации приложения
- Обновление файла манифеста службы
- Обновление манифеста приложения

>[AZURE.NOTE]Мы предоставляем средство упаковки, что позволяет автоматически создавать пакет приложения. Это средство в настоящее время доступно в предварительной версии. Его можно загрузить [здесь](http://aka.ms/servicefabricpacktool).

### Создание структуры каталогов пакета
Для начала можно создать структуру каталогов, как описано выше.

### Добавление файлов кода и конфигурации приложения
После создания структуры каталогов вы можете добавить файлы кода и конфигурации приложения в каталоги code и config. Вы также можете создавать дополнительные каталоги или дочерние папки в каталогах code и config. Service Fabric выполняет операцию xcopy для содержимого корневого каталога, поэтому, за исключением каталогов верхнего уровня code и settings, не существует предопределенной структуры (вы можете выбрать другие имена каталогов, подробнее см. в следующем разделе).

>[AZURE.NOTE]Убедитесь, что включены все файлы и зависимости, необходимые приложению. Service Fabric скопирует содержимое пакета приложения на все узлы кластера, где будут развертываться службы приложения. Пакет должен содержать весь код, необходимый для работы приложения. Не рекомендуется рассчитывать на то, что зависимости уже установлены.

### Редактирование файла манифеста службы
Следующий этап — редактирование файла манифеста служб с добавлением следующих сведений:

- Имя типа службы. Это идентификатор, используемый решением Service Fabric для идентификации службы.
- Команда для запуска приложения (ExeHost).
- Любой сценарий, который нужно выполнить для установки и настройки приложения (SetupEntrypoint)

Ниже приведен пример `ServiceManifest.xml`.

```xml
<?xml version="1.0" encoding="utf-8"?>
<ServiceManifest xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Name="NodeApp" Version="1.0.0.0" xmlns="http://schemas.microsoft.com/2011/01/fabric">
   <ServiceTypes>
      <StatelessServiceType ServiceTypeName="NodeApp" UseImplicitHost="true"/>
   </ServiceTypes>
   <CodePackage Name="code" Version="1.0.0.0">
      <SetupEntryPoint>
         <ExeHost>
             <Program>scripts\launchConfig.cmd</Program>
         </ExeHost>
      </SetupEntryPoint>
      <EntryPoint>
         <ExeHost>
            <Program>node.exe</Program>
            <Arguments>bin/www</Arguments>
            <WorkingFolder>CodePackage</WorkingFolder>
         </ExeHost>
      </EntryPoint>
   </CodePackage>
   <Resources>
      <Endpoints>
         <Endpoint Name="NodeAppTypeEndpoint" Protocol="http" Port="3000" Type="Input" />
      </Endpoints>
   </Resources>
</ServiceManifest>
```

Рассмотрим другую часть файла, которую необходимо изменить:

### ServiceTypes

```xml
<ServiceTypes>
  <StatelessServiceType ServiceTypeName="NodeApp" UseImplicitHost="true" />
</ServiceTypes>
```

- Вы можете выбрать для `ServiceTypeName` любое имя. Это значение используется в `ApplicationManifest.xml` для идентификации службы.
- Необходимо указать `UseImplicitHost="true"`. Этот атрибут сообщает Service Fabric, что служба основана на автономном приложении, поэтому достаточно запустить ее как процесс и отслеживать ее работоспособность.

### CodePackage
Атрибут CodePackage задает расположение (и версию) кода службы.

```xml
<CodePackage Name="Code" Version="1.0.0.0">
```

Элемент `Name` используется для указания имени каталога в пакете приложения, который содержит код службы. `CodePackage` также имеет атрибут `version`, который позволяет указать версию кода и может быть использован для обновления кода службы за счет инфраструктуры управления жизненным циклом приложений в Service Fabric.
### SetupEntrypoint

```xml
<SetupEntryPoint>
   <ExeHost>
       <Program>scripts\launchConfig.cmd</Program>
   </ExeHost>
</SetupEntryPoint>
```
Элемент SetupEntrypoint позволяет задать исполняемый или пакетный файл, который следует выполнить перед запуском кода службы. Это необязательный элемент, поэтому его не требуется включать, если отсутствует необходимость в инициализации и установке. Точка входа SetupEntryPoint выполняется при каждом перезапуске службы. Существует только одна точка входа для установки, поэтому сценарии установки и настройки необходимо объединить в один пакетный файл, если для установки или настройки приложения требуется несколько сценариев. Как и элемент Entrypoint, SetupEntrypoint может выполнять файлы любого типа: исполняемые и пакетные файлы, а также командлеты PowerShell. В приведенном выше примере SetupEntrypoint основывается на пакетном файле launchConfig.cmd, расположенном в дочерней папке `scripts` каталога code (при условии, что элемент WorkingDirectory имеет значение code).

### Entrypoint

```xml
<EntryPoint>
  <ExeHost>
    <Program>node.exe</Program>
    <Arguments>bin/www</Arguments>
    <WorkingFolder>CodeBase</WorkingFolder>
  </ExeHost>
</EntryPoint>
```

Элемент `Entrypoint` в файле манифеста службы позволяет указать, как запускать службу. Элемент `ExeHost` задает исполняемый файл (и аргументы), которые следует использовать для запуска службы.

- `Program`: задает имя исполняемого файла, который следует выполнить для запуска службы.
- `Arguments`: задает аргументы, которые нужно передать исполняемому файлу. Это может быть список параметров с аргументами.
- `WorkingFolder`: задает рабочий каталог процесса, который будет запущен. Вы можете задать два значения:
	- `CodeBase`: рабочим каталогом будет каталог code в пакете приложения (каталог `Code` в показанной ниже структуре).
	- `CodePackage`: рабочим каталогом будет корневой каталог пакета приложения (`MyServicePkg`).
- Элемент `WorkingDirectory` позволяет задать правильный рабочий каталог, чтобы приложение или сценарии инициализации могли использовать относительные пути.

### Конечные точки

```xml
<Endpoints>
   <Endpoint Name="NodeAppTypeEndpoint" Protocol="http" Port="3000" Type="Input" />
</Endpoints>

```
Элемент `Endpoint` задает конечные точки, которые может прослушивать приложение. В этом примере приложение Node.js прослушивает порт 3000.

## Файл манифеста приложения

После настройки файла `servicemanifest.xml` потребуется внести в файл `ApplicationManifest.xml` некоторые изменения, чтобы использовались правильные тип и имя службы.

```xml
<?xml version="1.0" encoding="utf-8"?>
<ApplicationManifest xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ApplicationTypeName="NodeAppType" ApplicationTypeVersion="1.0" xmlns="http://schemas.microsoft.com/2011/01/fabric">
   <ServiceManifestImport>
      <ServiceManifestRef ServiceManifestName="NodeApp" ServiceManifestVersion="1.0.0.0" />
   </ServiceManifestImport>
</ApplicationManifest>
```

### ServiceManifestImport

В `ServiceManifestImport` можно указать одну или несколько служб, которые требуется включить в приложение. Ссылки на службы указываются в элементе `ServiceManifestName`, задающем имя каталога, в котором находится файл `ServiceManifest.xml`.

```xml
<ServiceManifestImport>
  <ServiceManifestRef ServiceManifestName="NodeApp" ServiceManifestVersion="1.0.0.0" />
</ServiceManifestImport>
```

### Настройка ведения журнала
Для существующих приложений очень удобна возможность просматривать журналы консоли, чтобы убедиться, что сценарии приложения и настройки не возвращают ошибок. Перенаправление консоли можно настроить в файле `ServiceManifest.xml` с помощью элемента `ConsoleRedirection`.

```xml
<EntryPoint>
  <ExeHost>
    <Program>node.exe</Program>
    <Arguments>bin/www</Arguments>
    <WorkingFolder>CodeBase</WorkingFolder>
    <ConsoleRedirection FileRetentionCount="5" FileMaxSizeInKb="2048"/>
  </ExeHost>
</EntryPoint>
```

* Элемент `ConsoleRedirection` позволяет перенаправлять выходные данные консоли (stdout и stderr) в рабочий каталог для проверки на ошибки во время установки или выполнения приложения в кластере Service Fabric.

	* Элемент `FileRetentionCount` определяет, сколько файлов сохраняется в рабочем каталоге. Например, значение 5 означает, что в рабочем каталоге сохраняются файлы журналов для предыдущих 5 запусков.
	* `FileMaxSizeInKb` задает максимальный размер файлов журналов.

Файлы журналов сохраняются в одном из рабочих каталогов службы. Чтобы определить расположение файлов, необходимо использовать обозреватель Service Fabric для поиска узла, где запущена служба, и используемого в данный момент рабочего каталога. Эта процедура рассматривается далее в этой статье.

### Развертывание
Последним шагом является развертывание приложения. Приведенный ниже сценарий PowerShell демонстрирует развертывание приложения в локальном кластере разработки и запуск новой службы Service Fabric.

```Powershell

Connect-ServiceFabricCluster localhost:19000

Write-Host 'Copying application package...'
Copy-ServiceFabricApplicationPackage -ApplicationPackagePath 'C:\Dev\MulitpleApplications' -ImageStoreConnectionString 'file:C:\SfDevCluster\Data\ImageStoreShare' -ApplicationPackagePathInImageStore 'Store\nodeapp'

Write-Host 'Registering application type...'
Register-ServiceFabricApplicationType -ApplicationPathInImageStore 'Store\nodeapp'

New-ServiceFabricApplication -ApplicationName 'fabric:/nodeapp' -ApplicationTypeName 'NodeAppType' -ApplicationTypeVersion 1.0

New-ServiceFabricService -ApplicationName 'fabric:/nodeapp' -ServiceName 'fabric:/nodeapp/nodeappservice' -ServiceTypeName 'NodeApp' -Stateless -PartitionSchemeSingleton -InstanceCount 1

```
Службу Service Fabric можно развернуть в нескольких конфигурациях, например как один или несколько экземпляров либо так, чтобы в каждом узле кластера Service Fabric находилось по одному экземпляру службы.

Параметр `InstanceCount` командлета `New-ServiceFabricService` позволяет указать, сколько экземпляров службы следует запускать в кластере Service Fabric. Вы можете задать значение `InstanceCount` в зависимости от типа развертываемого приложения. Ниже приводятся два наиболее распространенных сценария. * `InstanCount = "1"`: в этом случае в кластере развертывается только один экземпляр службы. Служба планирования Service Fabric определяет, в каком узле будет развертываться служба.

* `InstanceCount ="-1"`: в этом случае в каждом узле кластера Service Fabric будет развернуто по одному экземпляру службы. В результате в каждом узле кластера будет по одному (и только одному) экземпляру службы. Эта конфигурация удобна для интерфейсных приложений (например, конечной точки REST), поскольку клиентским приложениям достаточно подключиться к любому узлу кластера, чтобы использовать конечную точку. Эту конфигурацию также можно использовать, если, к примеру, все узлы кластера Service Fabric подключены к подсистеме балансировки нагрузки, чтобы трафик клиента можно было распределять между экземплярами службы во всех узлах кластера.

### Проверка работающего приложения

В обозревателе Service Fabric определите узел, где запущена служба. В этом примере она выполняется на узле Node1.

![выполнение приложения](./media/service-fabric-deploy-existing-app/runningapplication.png)

Если вы перейдете к узлу, а затем к приложению, то увидите важные сведения об узле, включая его расположение на диске.

![расположение на диске](./media/service-fabric-deploy-existing-app/locationondisk.png)

Если перейти в каталог с помощью обозревателя серверов, можно найти рабочий каталог и папку журналов службы, как показано ниже.

![расположение на диске](./media/service-fabric-deploy-existing-app/loglocation.png)


## Дальнейшие действия
В этой статье вы ознакомились с основной процедурой упаковки существующего приложения и его развертывания в Service Fabric. Далее вы можете ознакомиться с дополнительным содержимым для этого раздела.

- Пример кода для упаковки и развертывания настраиваемого приложения на [Github](https://github.com/Azure-Samples/service-fabric-dotnet-getting-started/tree/master/Custom/SimpleApplication), включая ссылку на предварительную версию средства упаковки.
- Узнайте, как [развернуть несколько настраиваемых приложений](service-fabric-deploy-multiple-apps.md).
- Начальные сведения о [создании первого приложения Service Fabric с помощью Visual Studio](service-fabric-create-your-first-application-in-visual-studio.md).

<!---HONumber=AcomDC_1125_2015-->