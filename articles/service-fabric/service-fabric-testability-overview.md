<properties
   pageTitle="Обзор возможностей тестирования | Microsoft Azure"
   description="В этой статье описывается подсистема тестирования в Service Fabric, используемая для вызова ошибок и запуска сценариев тестирования для служб."
   services="service-fabric"
   documentationCenter=".net"
   authors="rishirsinha"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="01/26/2016"
   ms.author="rsinha"/>

# Обзор Testability

Подсистема тестирования предназначена для проверки служб, созданных с помощью платформы Microsoft Azure Service Fabric. Эта подсистема позволяет вызывать значимые ошибки и запускать сценарии. Вызываемые ошибки и сценарии позволяют воспроизвести и проверить в контролируемых, безопасных и согласованных условиях разные состояния и переходы, происходящие со службой в течение ее жизненного цикла.

Подсистема тестирования предоставляет действия и сценарии, обеспечивающие эти возможности. Действия являются отдельными ошибками, специально выполняющимися в службе для ее тестирования. Разработчик службы может использовать их в качестве стандартных блоков для создания сложных сценариев. Например:

  * Перезапустите узел для моделирования любого количества ситуаций, в которых выполняется перезагрузка компьютера или виртуальной машины.

  * Переместите реплики службы с отслеживанием состояния для имитации балансировки нагрузки, отработки отказа или обновления приложения.

  * Вызовите потерю кворума в службе с отслеживанием состояния, чтобы создать ситуацию, в которой операции записи невозможны, так как отсутствуют "резервные" или "вторичные" реплики, необходимые для приема новых данных.

  * Вызовите потерю данных в службе с отслеживанием состояния, чтобы создать ситуацию, в которой все данные о состоянии в памяти полностью уничтожаются.

Сценарии — это сложные операции, состоящие из одного или нескольких действий. Эти действия являются командами PowerShell и вызовами API C#, поэтому они могут принимать любую форму: долговременные службы, команды PowerShell, приложения командной строки и т. д. В наборе Testability доступны два готовых к использованию сценария:

  * Сценарий хаотического тестирования
  * Сценарий отработки отказа

В наборе Testability представлены интерфейсы API PowerShell и C#. Это расширяет возможности разработчика по использованию сценариев PowerShell и обеспечивает улучшенный контроль над интерфейсами API C# (при необходимости).

## Важность набора Testability

Платформа Service Fabric значительно упрощает задания, связанные с созданием распределенных масштабируемых приложений и управлением ими. Подсистема тестирования в Service Fabric примерно так же упрощает тестирование распределенного приложения. При тестировании необходимо устранить три основные проблемы.

1. Моделирование и создание ошибок, которые могут возникнуть в реальных сценариях. Одним из важных свойств Service Fabric является то, что эта платформа обеспечивает восстановление распределенных приложений при различных сбоях. Однако чтобы убедиться, что приложение может восстанавливаться после этих сбоев, нам нужен механизм моделирования и создания таких реальных сбоев в управляемой тестовой среде.

2. Возможность создания коррелированных ошибок. Основные сбои в системе, такие как ошибки сети и аппаратные сбои, легко создавать по отдельности. Создание значительное количество сценариев, возможных в реальном мире в результате взаимодействия этих отдельных ошибок, — нетривиальная задача.

3. Унифицированные возможности для разных уровней разработки и развертывания. Существует множество систем внесения ошибок, которые позволяют моделировать сбои различных типов. Однако эти возможности уменьшаются, когда мы переходим от универсальных сценариев разработки к выполнению аналогичных проверок в больших тестовых средах и в рабочей среде.

Хотя существует ряд механизмов для решения этих проблем, нет системы, которая реализует все эти возможности с необходимыми гарантиями (как в универсальной среде разработки, так и при тестировании в производственных кластерах). Подсистема тестирования помогает разработчикам сосредоточиться на тестировании своей бизнес-логики. Она предоставляет все возможности, необходимые для проверки взаимодействия службы с базовой распределенной системой.

### Моделирование и создание реальных сценариев возникновения ошибок

Чтобы проверить устойчивость распределенной системы к сбоям, нам нужен механизм создания ошибок. Хотя теоретически создать ошибку (например, прервать работу узла) не так и сложно, на практике возникают распространенные проблемы с согласованностью, которые призвана решить платформа Service Fabric. Например, если нужно завершить работу узла, рабочий процесс будет выглядеть следующим образом.

1. Клиент отправляет запрос на завершение работы узла.

2. Запрос отправляется в нужный узел.

    а. Если узел не найден, возникнет ошибка.

    b. Если узел найден, запрос должен вернуться, только если узел не работает.

При проверке сбоя процессу тестирования необходимо знать, что сбой происходит фактически во время его вызова. Service Fabric гарантирует следующее: узел либо завершает работу, либо уже не работает, когда команда достигает узла. В любом случае при тестировании важно правильно определить причину состояния, а затем либо успешно, либо неудачно выполнить ее правильную проверку. В системе, реализованной за пределами платформы Service Fabric для создания аналогичного набора ошибок, может возникнуть ряд проблем с сетями, оборудованием и программным обеспечением, которые могут помешать такой системе обеспечить описанные выше условия. При наличии упомянутых проблем Service Fabric перенастроит состояние кластера для решения проблем, благодаря чему подсистема тестирования сможет предоставить нужные гарантии.

### Создание необходимых событий и сценариев

Хотя во время моделирования реальной ошибки обеспечить изначальную согласованность непросто, создание коррелированных сбоев — еще более сложная задача. Например, в постоянной службе с отслеживанием состояния потеря данных наблюдается в следующих случаях.

1. Кворум записи реплик обеспечивается только во время репликации. Все вторичные реплики отстают от первичной.

2. Кворум записи не работает правильно, так как реплики выходят из строя (из-за пакета кода или завершения работы узла).

3. Не удается снова обеспечить кворум записи из-за потери данных для реплик (вследствие повреждения диска или повторного создания образа компьютера).

Эти коррелированные ошибки действительно случаются на практике, но не так часто, как отдельные сбои. Очень важна возможность проверить эти сценарии до их возникновения в рабочей среде. Но важнее иметь возможность моделировать их с рабочей нагрузкой в контролируемых условиях (в середине дня в присутствии всех инженеров), а не при первом возникновении в рабочей среде в 02:00 ночи.

### Единые возможности в различных средах

Общепринятая практика заключается в создании трех разных наборов возможностей: по одному для среды разработки, тестов и рабочей среды. Использовалась следующая модель.

1. В среде разработки создавались переходы состояний, что позволяло выполнять модульные тесты отдельных методов.

2. В тестовой среде создавались сбои, что позволяло проводить сквозные тесты различных сценариев ошибок.

3. Рабочая среда поддерживалась в начальном состоянии во избежание неестественных ошибок, а также для обеспечения быстрого реагирования специалистов на сбои.

Так как в платформе Service Fabric есть подсистема тестирования, мы предлагаем качественно новый подход, который состоит в использовании одного метода, начиная со среды разработки и заканчивая рабочей средой. Это достигается двумя способами.

1. Для вызова управляемых сбоев интерфейсы API подсистемы тестирования постоянно используются как в универсальной среде, так и в рабочих кластерах.

2. Чтобы автоматически создавать сбои на кластере, используется подсистема тестирования. Управление частотой сбоев путем настройки позволяет разными способами проверять одну службу в разных средах.

Аналогичный механизм используется и в платформе Service Fabric (только мы имеем дело с другим масштабом сбоев и другими средами). Это позволяет намного быстрее внедрить код в конвейере развертывания и проверить службы в условиях реальных нагрузок.

## Использование компонента Testability

### Использование компонента Testability с языком C#

Возможности тестирования представлены в сборке System.Fabric.Testability.dll. Этот DLL-файл расположен в пакете NuGet Microsoft.ServiceFabric.Testability.nupack. Чтобы использовать возможности тестирования, включите пакет NuGet в качестве ссылки в свой проект.

### Использование компонента Testability в оболочке PowerShell

Чтобы использовать модуль тестирования PowerShell, необходимо установить MSI среды выполнения. После установки MSI автоматически загрузится модуль ServiceFabricTestability для PowerShell, который смогут использовать разработчики.

## Заключение

Чтобы создать службы в масштабе облака, очень важно убедиться, что службы будут устойчивы к реальным ошибкам до и после развертывания. В современном мире служб огромное значение имеет возможность быстро внедрять и перемещать код в рабочей среде. Подсистема тестирования в Service Fabric позволяет разработчикам служб выполнять указанные выше задачи.

## Дальнейшие действия

- [Действия, доступные благодаря Testability](service-fabric-testability-actions.md)
- [Сценарии Testability](service-fabric-testability-actions.md)
- Тестирование службы
  - [Моделирование ошибок во время рабочих нагрузок службы](service-fabric-testability-workload-tests.md)
  - [Ошибки обмена данными между службами](service-fabric-testability-scenarios-service-communication.md)

<!---HONumber=AcomDC_0204_2016-->