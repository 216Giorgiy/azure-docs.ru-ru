<properties
   pageTitle="Общие сведения о наблюдении за работоспособностью системы в Service Fabric"
   description="В этой статье описывается модель мониторинга работоспособности Azure Service Fabric, включая сущности работоспособности, отчеты и оценку."
   services="service-fabric"
   documentationCenter=".net"
   authors="oanapl"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="06/16/2015"
   ms.author="oanapl"/>

# Общие сведения о наблюдении за работоспособностью системы в Service Fabric
В платформе Service Fabric используется модель работоспособности c широкими и гибкими возможностями оценки работоспособности и создания отчетов, включая мониторинг состояния кластера и выполняющихся в нем служб практически в реальном времени. Вы можете легко получить сведения о работоспособности и попытаться устранить потенциальные проблемы до того, как они приведут к серьезным перебоям в работе. Службы в рамках типичной модели отправляют отчеты на локальном уровне, а затем полученная информация агрегируется на уровне кластера.

Компоненты Service Fabric используют эту модель для отправки отчетов о своем текущем состоянии. Вы тоже можете использовать этот механизм для получения информации о работоспособности своих приложений. То, насколько легко вам будет выявлять и исправлять неполадки в работе приложения, зависит от качества отчетов и степени их соответствия конкретным условиям.

> [AZURE.NOTE]Мы выпустили подсистему обеспечения работоспособности, когда возникла потребность в реализации контролируемых обновлений. Платформа Service Fabric позволяет выполнять контролируемые обновления, то есть обновлять кластер или приложения без перерывов в работе, с минимальным участием пользователя в процессе и сохранением полной доступности кластера и приложений. Перед обновлением работоспособность проверяется на основе заданных политик обновления и обновление выполняется, только если работоспособность находится в пределах допустимых значений. В противном случае автоматически выполняется откат или обновление приостанавливается, пока администраторы не устранят проблему. Дополнительные сведения об обновлении приложений см. в [этой статье](service-fabric-application-upgrade.md).

## Хранилище данных о работоспособности
В хранилище данных о работоспособности хранится информация, связанная с состоянием сущностей в кластере. Ее можно извлечь оттуда и изучить. Хранилище реализовано в виде хранимой службы Service Fabric с отслеживанием состояния, что позволяет обеспечить высокую доступность и масштабируемость. Оно является частью приложения fabric:/System и доступно сразу после запуска кластера.

## Сущности и иерархия работоспособности
Сущности работоспособности упорядочены в логическую иерархию со связями и зависимостями между сущностями. Хранилище данных о работоспособности создает сущности и иерархию автоматически на основе отчетов, получаемых от компонентов Service Fabric.

Сущности работоспособности зеркально отражают сущности Service Fabric (например, сущность работоспособности приложения соответствует экземпляру приложения, развернутому в кластере, а сущность работоспособности узла —узлу кластера Service Fabric). Иерархия работоспособности закрепляет связи с системными сущностями и является основой для расширенной оценки работоспособности. Для получения дополнительных сведений о ключевых понятиях Service Fabric см. статью [Технический обзор Service Fabric](service-fabric-technical-overview.md). Дополнительную информацию о приложениях см. в статье [Модель приложения Service Fabric](service-fabric-application-model.md).

Сущности и иерархия работоспособности обеспечивают эффективность отчетов и отладки, а также отслеживания состояния кластера и приложений, а модель в целом отображает точные и **подробные** сведения о работоспособности различных компонентов кластера.

![Сущности работоспособности.][1] Сущности работоспособности, упорядоченные на основе иерархических отношений «родительский элемент-дочерний элемент».

[1]: ./media/service-fabric-health-introduction/servicefabric-health-hierarchy.png

К сущностям работоспособности относятся:

- **Cluster** (кластер). Отражает работоспособность кластера Service Fabric. Отчеты о работоспособности кластера описывают условия, которые влияют на весь кластер и не могут быть отнесены к одному или нескольким неработоспособным дочерним элементам. Пример: разделение мощностей кластера из-за проблем связи или фрагментации сети.

- **Node** (узел). Отражает работоспособность узла Service Fabric. Отчеты о работоспособности узла описывают условия, которые влияют на функциональность узла и, как правило, затрагивают все развернутые и запущенные на нем сущности. Пример: узлу не хватает места на диске (памяти, подключений или других ресурсов уровня компьютера) или узел не работает. Сущность узла идентифицируется по имени узла (строка).

- **Application** (приложение). Отражает работоспособность экземпляра приложения, выполняющегося в кластере. Отчеты о работоспособности приложения описывают условия, которые влияют на общую работоспособность приложения и не могут быть отнесены к отдельным дочерним элементам (службам или развернутым приложениям). Пример: сквозное взаимодействие между различными службами в приложении. Сущность приложения идентифицируется по имени приложения (URI).

- **Service** (служба). Отражает работоспособность службы, выполняющейся в кластере. Отчеты о работоспособности службы описывают условия, которые влияют на общую работоспособность службы и не могут быть отнесены к отдельным разделам или репликам. Пример: конфигурация службы (например, порт или внешняя общая папка), которая является причиной проблем во всех разделах. Сущность службы идентифицируется по имени службы (URI).

- **Partition** (раздел). Отражает работоспособность раздела службы. Отчеты о работоспособности раздела описывают условия, которые влияют на весь набор реплик. Пример: количество реплик меньше требуемого или в разделе нет кворума. Сущность раздела определяется идентификатором раздела (GUID).

- **Replica** (реплика). Отражает работоспособность реплики службы с отслеживанием состояния или экземпляра службы без отслеживания состояния. Это самая малая единица, которую модули наблюдения и компоненты системы могут включать в отчеты по приложению. Например, если речь идет о службе с отслеживанием состояния, основная реплика может включать в отчет сведения о невозможности реплицировать операции на вторичные реплики или о существенном снижении скорости репликации. Экземпляр службы без сохранения состояния может отправлять отчет, если заканчиваются ресурсы или возникают проблемы с подключением. Сущность реплики определяется идентификатором раздела (GUID) и (длинным) идентификатором реплики или экземпляра.

- **DeployedApplication** (развернутое приложение). Отражает работоспособность *приложения, выполняющегося на узле*. Отчеты о работоспособности развернутого приложения описывают условия, специфические для конкретного приложения на узле, которые не могут быть отнесены к уровню пакетов служб, развернутых на том же узле. Пример: не удается загрузить пакет приложения на узле или есть проблема с настройкой субъектов безопасности приложения на узле. Развернутое приложение определяется именем приложения (URI) и именем узла (строка).

- **DeployedServicePackage** (развернутый пакет службы). Отражает работоспособность пакета службы приложения, работающего на узле в кластере. Описываются условия, относящиеся к конкретному пакету службы и не влияющие на другие пакеты служб того же приложения на том же узле. Пример: не удается запустить пакет кода в пакете службы или не удается прочитать пакет конфигурации. Развернутый пакет службы определяется именем приложения (URI), именем узла (строка) и именем манифеста службы (строка).

Детализация модели работоспособности упрощает выявление и устранение проблем. Например, если служба не отвечает, теоретически можно сообщить в отчете, что экземпляр приложения находится в неработоспособном состоянии. Однако такая схема неидеальна, так как проблема может не затрагивать все службы в приложении. Отчет должен касаться неработоспособной службы или конкретного дочернего раздела, если есть информация о том, что проблема находится в нем. Данные автоматически передаются вверх по иерархии: неработоспособный раздел будет виден на уровне службы и приложения. Это помогает быстрее выявлять и устранять причины проблем.

Иерархия работоспособности состоит из отношений между родительскими и дочерними объектами. Кластер состоит из узлов и приложений, приложения — из служб и развернутых приложений, развернутые приложения — из развернутых пакетов служб. Службы состоят из разделов, а каждый раздел включает одну или несколько реплик. Между узлами и развернутыми сущностями существует особая связь. Если ответственный за узел системный компонент (служба диспетчера отработки отказов) сообщает о его неработоспособности, то эта проблема затрагивает развернутые на узле приложения, пакеты служб и реплики.

Иерархия работоспособности отражает актуальное состояние системы на основе отчетов о работоспособности, получаемых практически в реальном времени. Внутренние и внешние модули наблюдения могут включать в отчеты данные по одним и тем же сущностям. Причиной этого может быть логика конкретного приложения или специфические условия мониторинга. Пользовательские отчеты сосуществуют с системными.

Если при разработке службы планировать, как будет выполняться отчетность по работоспособности и к каким мерам по устранению выявленных проблем следует прибегать, это упрощает отладку, мониторинг состояния масштабных облачных служб и общее управление ими.

## Состояния работоспособности
Для описания работоспособности в Service Fabric используются три состояния: ОК, Warning (предупреждение) и Error (ошибка). Во всех отчетах, отправляемых в хранилище данных о работоспособности, должно быть указано одно из них. Эти же значения используются в качестве результата оценки работоспособности.

Рассмотрим их подробнее.

- ОК. Сущность работоспособна. Известных проблем с сущностью или ее дочерними элементами (если таковые есть) не выявлено.

- Warning (предупреждение). Есть некоторые проблемы с сущностью, но она работоспособна (например, неожиданная задержка, которая не вызывает функциональных проблем). В некоторых случаях условие выдачи предупреждения может самоустраниться без действий со стороны пользователя, однако предупреждения помогают лучше понимать, что происходит. В других случаях, если нет внешнего вмешательства, предупреждение может перерасти в серьезную проблему.

- Error (ошибка). Сущность неработоспособна. Следует выполнить определенные действия для исправления состояния сущности, так как она не может работать корректно.

- Неизвестно. Сущность не существует в хранилище данных работоспособности. Это значение можно получить от распределенных запросов, например запросов на получение узлов или приложений Service Fabric. В этих запросах объединяются результаты, полученные от нескольких компонентов системы. Если в одном из компонентов есть сущность, которая не добавлена в хранилище данных о работоспособности или удалена из него, то в объединенных результатах запроса будет указано состояние «Неизвестно».

## Политики работоспособности
Для определения работоспособности сущности хранилище данных о работоспособности применяет к отчетам по ней и ее дочерним элементам политики работоспособности.

> [AZURE.NOTE]Политики можно указать в манифесте кластера (для оценки работоспособности кластера и узла) или в манифесте приложения (для оценки состояния приложения и его дочерних элементов). Запросы на оценку работоспособности можно включать также в пользовательские политики оценки работоспособности, которые будут применяться только при конкретной оценке.

По умолчанию на платформе Service Fabric действуют строгие правила (работоспособным должно быть все) касательно иерархических отношений «родительский элемент-дочерний элемент»: если хотя бы один дочерний элемент неработоспособен, то и родитель считается неработоспособным.

### Политика работоспособности кластера
Политика работоспособности кластера используется для оценки состояния кластера и входящих в него узлов. Ее можно определить в манифесте кластера. Если политика не определена, то используется политика по умолчанию (сбои не допускаются). Она включает такие параметры:

- **ConsiderWarningAsError**. Указывает, следует ли при оценке работоспособности обрабатывать предупреждения как ошибки. Значение по умолчанию: False.

- **MaxPercentUnhealthyApplications**. Максимально допустимый процент неработоспособных приложений, превышение которого приведет к оценке кластера как неработоспособного (состояние Error).

- **MaxPercentUnhealthyNodes**. Максимально допустимый процент неработоспособных узлов, превышение которого приведет к оценке кластера как неработоспособного (состояние Error). В больших кластерах всегда есть отключенные узлы или узлы на восстановлении. Следует учитывать это при настройке параметра.

Ниже приведен фрагмент манифеста кластера:

```xml
<FabricSettings>
  <Section Name="HealthManager/ClusterHealthPolicy">
    <Parameter Name="ConsiderWarningAsError" Value="False" />
    <Parameter Name="MaxPercentUnhealthyApplications" Value="0" />
    <Parameter Name="MaxPercentUnhealthyNodes" Value="20" />
  </Section>
</FabricSettings>
```

### Политика работоспособности приложения
Политика работоспособности приложения описывает, как выполняется оценка и агрегирование событий и состояний приложения и его дочерних элементов. Ее можно определить в манифесте приложения (файл ApplicationManifest.xml в пакете приложения). Если политика не определена, платформа Service Fabric предполагает, что сущность неработоспособна, если в отчете по ней или ее дочернему элементу указано состояние Warning (предупреждение) или Error (ошибка). В политике можно настроить такие параметры:

- **ConsiderWarningAsError**. Указывает, следует ли при оценке работоспособности обрабатывать предупреждения как ошибки. Значение по умолчанию: False.

- **MaxPercentUnhealthyDeployedApplications**. Максимально допустимый процент неработоспособных развернутых приложений, превышение которого приведет к оценке приложения как неработоспособного (состояние Error). Рассчитывается путем деления количества неработоспособных развернутых приложений на количество узлов в кластере, на которых сейчас развернуто приложение. Расчет округляется: на небольшом количестве узлов допускается один сбой. Значение по умолчанию: 0 %.

- **DefaultServiceTypeHealthPolicy**. Задает политику работоспособности типов служб по умолчанию, которая заменяет политику работоспособности по умолчанию для всех типов служб в приложении.

- **ServiceTypeHealthPolicyMap**. Карта политик работоспособности служб по типу службы. Эти политики заменяют используемую по умолчанию политику работоспособности типов служб для выбранных типов служб. Например, в приложении, которое содержит тип службы Gateway (шлюз) без отслеживания состояния и тип службы Engine (подсистема) с отслеживанием состояния, для служб с отслеживанием и без отслеживания состояния можно использовать разные политики работоспособности. Настройка отдельных политик для разных типов служб позволяет отслеживать работоспособность на более детализированном уровне.

### Политика работоспособности типа службы
Политика работоспособности типа службы определяет способ оценки и агрегации состояний дочерних элементов службы. Она включает такие параметры:

- **MaxPercentUnhealthyPartitionsPerService**. Максимально допустимый процент неработоспособных разделов, превышение которого приведет к оценке службы как неработоспособной. Значение по умолчанию: 0 %.

- **MaxPercentUnhealthyReplicasPerPartition**. Максимально допустимый процент неработоспособных реплик, превышение которого приведет к оценке раздела как неработоспособного. Значение по умолчанию: 0 %.

- **MaxPercentUnhealthyServices**. Максимально допустимый процент неработоспособных служб, превышение которого приведет к оценке приложения как неработоспособного. Значение по умолчанию: 0 %.

Ниже приведен фрагмент манифеста приложения:

```xml
    <Policies>
        <HealthPolicy ConsiderWarningAsError="true" MaxPercentUnhealthyDeployedApplications="20">
            <DefaultServiceTypeHealthPolicy
                   MaxPercentUnhealthyServices="0"
                   MaxPercentUnhealthyPartitionsPerService="10"
                   MaxPercentUnhealthyReplicasPerPartition="0"/>
            <ServiceTypeHealthPolicy ServiceTypeName="FrontEndServiceType"
                   MaxPercentUnhealthyServices="0"
                   MaxPercentUnhealthyPartitionsPerService="20"
                   MaxPercentUnhealthyReplicasPerPartition="0"/>
            <ServiceTypeHealthPolicy ServiceTypeName="BackEndServiceType"
                   MaxPercentUnhealthyServices="20"
                   MaxPercentUnhealthyPartitionsPerService="0"
                   MaxPercentUnhealthyReplicasPerPartition="0">
            </ServiceTypeHealthPolicy>
        </HealthPolicy>
    </Policies>
```

## Оценка работоспособности
Пользователи или автоматизированные службы могут оценивать работоспособность любых сущностей в любой момент времени. Для этого хранилище данных о работоспособности агрегирует все отчеты о работоспособности сущности и ее дочерних элементов (если таковые есть). Алгоритм агрегирования данных о работоспособности использует политики работоспособности, определяющие методы оценки и параметры агрегирования данных о состоянии дочерних элементов (если таковые есть).

### Агрегирование отчетов о работоспособности
Для каждой сущности в системе может существовать несколько отчетов, отправляемых из разных источников (системных компонентов или модулей наблюдения) и сформированных по разным правилам. При агрегировании учитываются соответствующие политики работоспособности, в частности параметр ConsiderWarningAsError политики уровня кластера или приложения, который указывает, как следует оценивать предупреждения.

Сводное состояние работоспособности определяется по отчетам с **наихудшими** оценками состояния сущности. Если есть хотя бы один отчет о работоспособности со значением Error (ошибка), сводным состоянием будет Error.

![Агрегирование отчетов о работоспособности с состоянием Error.][2]

Если отчет о работоспособности имеет значение Error (ошибка), иметь значение Error будет также состояние сущности работоспособности.

[2]: ./media/service-fabric-health-introduction/servicefabric-health-report-eval-error.png

Если отчетов со значением Error нет, но есть одно или несколько предупреждений, то сводным состоянием может быть как Error (ошибка), так и Warning (предупреждение), в зависимости от флажка политики ConsiderWarningAsError.

![Агрегирование отчетов о работоспособности, где есть отчет с предупреждением, а флаг ConsiderWarningAsError имеет значение False.][3]

На схеме представлено агрегирование отчетов о работоспособности, где есть отчет с предупреждением, а флаг ConsiderWarningAsError имеет значение False (по умолчанию).

[3]: ./media/service-fabric-health-introduction/servicefabric-health-report-eval-warning.png

### Агрегирование данных о работоспособности дочерних элементов
Сводное состояние работоспособности сущности отражает состояние работоспособности ее дочерних элементов (если таковые есть). Алгоритм, применяемый для агрегирования состояний работоспособности дочерних элементов, использует политики, применимые к конкретным типам сущностей.

![Агрегирование данных о работоспособности дочерних элементов.][4]

Агрегирование состояний дочерних элементов на основе политик работоспособности.

[4]: ./media/service-fabric-health-introduction/servicefabric-health-hierarchy-eval.png

После оценки состояния всех дочерних элементов хранилище данных о работоспособности агрегирует сведения о состояниях на основе процента неработоспособных элементов, заданного в политике, которая основана на типе сущности и ее дочерних элементов.

- Если все дочерние элементы находятся в состоянии ОК, то их сводным состоянием тоже будет ОК.

- Если дочерние элементы имеют состояния как ОК, так и Warning (предупреждение), то их сводным состоянием будет Warning.

- Если количество дочерних элементов с состоянием Error (ошибка) превышает максимальный допустимый процент неработоспособных дочерних элементов, их сводным состоянием будет Error.

- Если не превышает, то состоянием будет Warning (предупреждение).

## Создание отчетов о работоспособности
Системные компоненты и внутренние и внешние модули мониторинга могут создавать отчеты по сущностям Service Fabric. *Создатели отчетов* определяют работоспособность контролируемых сущностей **локально** на основе определенных условий мониторинга. Им не требуется глобальное состояние или агрегированные данные. Сбор или анализ агрегированных данных привел бы к чрезмерному усложнению создателей отчетов и самого процесса отправки отчетов.

Для отправки данных о работоспособности в хранилище создателям отчетов необходимо определить, какая сущность затронута, и создать отчет о ее работоспособности. Затем отчет может быть отправлен с использованием интерфейса API (команда FabricClient.HealthManager.ReportHealth) через Powershell или REST.

### Отчеты о работоспособности
Отчеты о работоспособности каждой сущности в кластере содержат такие сведения:

- SourceId (идентификатор источника). Это строка обозначает создателя отчета, содержащего сведения о событии, которое затрагивает работоспособность.

- Entity Identifier (идентификатор сущности). Сущность, к которой применяется отчет. Этот идентификатор зависит от [типа сущности](service-fabric-health-introduction.md#health-entities-and-hierarchy):

  - Cluster (кластер) — нет.

  - Node (узел) — имя узла (строка).

  - Application (приложение) — имя приложения (URI). Имя экземпляра приложения, развернутого в кластере.

  - Service (служба) — имя службы (URI). Имя экземпляра службы, развернутого в кластере.

  - Partition (раздел) — идентификатор раздела (GUID). Уникальный идентификатор раздела.

  - Replica (реплика) — идентификатор реплики с отслеживанием состояния или идентификатор службы без отслеживания состояния (Int64).

  - DeployedApplication (развернутое приложение) — имя приложения (URI) и имя узла (строка).

  - DeployedServicePackage (развернутый пакет службы) — имя приложения (URI), имя узла (строка) и имя манифеста службы (строка).

- Property (свойство). *Строка* (не фиксированное перечисление), позволяющая создателям отчетов классифицировать событие, связанное с работоспособностью, используя конкретное свойство сущности. Например, создатель отчетов A может отправить отчет о работоспособности для свойства storage узла Node01, а создатель отчетов B — отчет о работоспособности для свойства connectivity того же узла. В хранилище данных о работоспособности эти отчеты считаются независимыми событиями работоспособности для сущности Node01.

- Description (описание). Строка, позволяющая создателям отчетов добавлять подробные сведения о событии работоспособности. Как правило, содержимое отчета полностью описывается идентификатором источника, свойством и состоянием работоспособности. Описание содержит сведения об отчете в удобном для чтения формате и упрощает анализ отчета администраторами и пользователями.

- HealthState (состояние работоспособности). [Перечисление](service-fabric-health-introduction.md#health-states), описывающее указанное в отчете состояние. Допустимы значения ОК, Warning (предупреждение) и Error (ошибка).

- TimeToLive (срок жизни). Период времени, в течение которого отчет о работоспособности действителен. В сочетании с параметром RemoveWhenExpired сообщает хранилищу данных о работоспособности, как нужно оценивать события с истекшим сроком действия. По умолчанию срок действия не ограничен и отчет действителен вечно.

- RemoveWhenExpired (удалять после истечения срока действия). Логическое значение. Если задано значение True, отчет о работоспособности с истекшим сроком действия автоматически удаляется из хранилища данных о работоспособности и не влияет на оценку состояния сущности. Используется, если отчет действителен только в течение определенного периода времени и создателям отчетов не нужно явно удалять его. Применяется также для удаления отчетов из хранилища данных о работоспособности. Например, модуль наблюдения изменяется и перестает отправлять отчеты из предыдущего источника и на основе ранее указанного свойства. Он может отправить отчет с небольшим сроком жизни и установленным флажком RemoveWhenExpired, чтобы удалить все предыдущие состояния из хранилища данных о работоспособности. Если задано значение False, просроченный отчет в процессе оценки рассматривается как ошибка. Для хранилища данных о работоспособности это является индикатором того, что с модулем наблюдения что-то не так, потому что он должен был периодически отправлять отчеты по определенному свойству, но по каким-то причинам перестал это делать. Это событие рассматривается как ошибка, и таким образом фиксируется работоспособность такого модуля наблюдения.

- SequenceNumber (порядковый номер). Положительное целое число, которое представляет порядковый номер отчетов и постоянно увеличивается. Хранилище данных о работоспособности использует этот номер для выявления устаревших отчетов, полученных с запозданием из-за задержек в сети или по другим причинам. Если порядковый номер отчета меньше или равен номеру последнего примененного отчета для тех же сущности, источника и свойства, то такой отчет отклоняется. Если порядковый номер не указан, он задается автоматически. Специально указывать порядковый номер отчета нужно в том случае, если состояние изменяется: источник должен помнить, какие отчеты он отправил, и сохранить эту информацию для отработки отказа.

Идентификатор источника, идентификатор сущности, свойство и состояние являются обязательными для всех отчетов. Строка с идентификатором источника не может начинаться с префикса «System.» — он зарезервирован для системных отчетов. Для одной сущности может храниться только один отчет с указанием одних и тех же источника и свойства. Если для одного и того же источника и свойства создаются несколько отчетов, то один из них переопределит остальные либо на стороне клиента работоспособности (при объединении в пакет), либо на стороне хранилища данных о работоспособности. Замена выполняется на основе порядкового номера: старые отчеты заменяются новыми (с большим порядковым номером).

### События работоспособности
Хранилище данных о работоспособности хранит события работоспособности, включающие всю информацию из отчетов, а также метаданные, такие как время, когда отчет был передан клиенту работоспособности, и время, когда он был изменен на стороне сервера. События работоспособности возвращаются с помощью [запросов работоспособности](service-fabric-view-entities-aggregated-health.md#health-queries).

Добавляемые метаданные:

- SourceUtcTimestamp: время передачи отчета клиенту работоспособности (в формате UTC).

- LastModifiedUtcTimestamp: время последнего изменения отчета на стороне сервера (UTC).

- IsExpired: флаг, указывающий, истек ли срок действия отчета в момент выполнения запроса хранилищем работоспособности. Срок действия события может быть истекшим только в том случае, если флаг RemoveWhenExpired имеет значение False. В противном случае событие не возвращается запросом, а удаляется из хранилища.

- LastOkTransitionAt, LastWarningTransitionAt, LastErrorTransitionAt: время последней смены состояния (ОК/Warning/Error). Эти поля содержат историю переходов события из одного состояния работоспособности в другое.

Поля смены состояния можно использовать для более точной настройки уведомлений, а также в качестве журнала данных о событии работоспособности. Возможные сценарии их использования:

- Выдача предупреждения, если свойство находится в состоянии Warning (предупреждение) или Error (ошибка) более X мин. Это позволяет избежать выдачи предупреждений, связанных с временными условиями. Например, если состояние Warning (предупреждение) сохраняется более 5 минут, то предупреждение может быть таким: (HealthState = Warning, Now – LastWarningTransitionTime > 5 minutes).
> 

- Выдача предупреждений, связанных с условиями, которые изменились за последние X мин. Если состояние Error (ошибка) включено в отчет раньше, чем X мин назад, то его можно проигнорировать (так как этот сигнал уже был получен).

- Если состояние свойства меняется с Warning (предупреждение) на Error (ошибка) и обратно, можно определить, как долго сохраняется неработоспособность (т. е. состояние, отличное от ОК). Например, если свойство является неработоспособным более 5 минут, то предупреждение может быть таким: (HealthState != ОК и Now – LastOkTransitionTime > 5 minutes).

## Пример: отправка отчетов и оценка работоспособности приложения
В приведенном ниже фрагменте отправляется отчет о работоспособности приложения fabric:/WordCount из источника MyWatchdog с помощью PowerShell. Отчет содержит сведения по свойству Availability (доступность): состояние — Error (ошибка), срок действия — не ограничен. Затем выполняется запрос работоспособности приложения, который возвращает сводное состояние Error (ошибка) и рассматриваемое событие работоспособности в списке других событий работоспособности.

```powershell
PS C:> Send-ServiceFabricApplicationHealthReport –ApplicationName fabric:/WordCount –SourceId "MyWatchdog" –HealthProperty "Availability" –HealthState Error

PS C:> Get-ServiceFabricApplicationHealth fabric:/WordCount

ApplicationName                 : fabric:/WordCount
AggregatedHealthState           : Error
UnhealthyEvaluations            :
                                  Error event: SourceId='MyWatchdog', Property='Availability'.

ServiceHealthStates             :
                                  ServiceName           : fabric:/WordCount/WordCount.Service
                                  AggregatedHealthState : Warning

                                  ServiceName           : fabric:/WordCount/WordCount.WebService
                                  AggregatedHealthState : Ok

DeployedApplicationHealthStates :
                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : Node.4
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : Node.1
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : Node.5
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : Node.2
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : Node.3
                                  AggregatedHealthState : Ok

HealthEvents                    :
                                  SourceId              : System.CM
                                  Property              : State
                                  HealthState           : Ok
                                  SequenceNumber        : 5102
                                  SentAt                : 4/15/2015 5:29:15 PM
                                  ReceivedAt            : 4/15/2015 5:29:15 PM
                                  TTL                   : Infinite
                                  Description           : Application has been created.
                                  RemoveWhenExpired     : False
                                  IsExpired             : False
                                  Transitions           : ->Ok = 4/15/2015 5:29:15 PM

                                  SourceId              : MyWatchdog
                                  Property              : Availability
                                  HealthState           : Error
                                  SequenceNumber        : 130736794527105907
                                  SentAt                : 4/16/2015 5:37:32 PM
                                  ReceivedAt            : 4/16/2015 5:37:32 PM
                                  TTL                   : Infinite
                                  Description           :
                                  RemoveWhenExpired     : False
                                  IsExpired             : False
                                  Transitions           : ->Error = 4/16/2015 5:37:32 PM

```

## Использование модели работоспособности
Данная модель обеспечивает масштабирование облачных служб и базовой платформы Service Fabric, так как мониторинг и диагностика работоспособности распределены по разным мониторам в кластере. В других системах используется централизованная служба на уровне кластера, которая анализирует все *потенциально* полезные сведения, генерируемые службами. Это затрудняет масштабирование и не позволяет собирать конкретные сведения для точного выявления основных причин проблем, в том числе потенциальных.

Описанная модель часто используется для мониторинга и диагностики, оценки работоспособности кластера и приложения, а также для контролируемых обновлений. В других службах данные о работоспособности используются для автоматического исправления, создания истории работоспособности кластера и выдачи предупреждений по определенным условиям.

## Дальнейшие действия
[Просмотр отчетов о работоспособности Service Fabric](service-fabric-view-entities-aggregated-health.md)

[Использование отчетов о работоспособности системы для устранения неполадок](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[Добавление настраиваемых отчетов о работоспособности Service Fabric](service-fabric-report-health.md)

[Локальный мониторинг и диагностика состояния служб](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[Обновление приложения Service Fabric](service-fabric-application-upgrade.md)
 

<!---HONumber=58_postMigration-->