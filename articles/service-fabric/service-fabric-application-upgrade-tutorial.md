<properties
   pageTitle="Учебник по обновлению приложений структуры служб"
   description="В этой статье рассматривается обновление приложения структуры служб."
   services="service-fabric"
   documentationCenter=".net"
   authors="mani-ramaswamy"
   manager="samgeo"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="07/17/2015"
   ms.author="subramar"/>



# Учебник по обновлению приложений

Наиболее часто используемый и рекомендуемый подход к выполнению обновлений состоит в отслеживаемом последовательном обновлении. Структура службы осуществляет мониторинг работоспособности обновляемого приложения на основе набора политик работоспособности. После обновления приложений в домене обновления структура служб оценивает работоспособность приложения и определяет, следует ли переходить к следующему домену обновления или зарегистрировать сбой на основании политик работоспособности. Отслеживаемое обновление приложения может выполняться с использованием управляемых или собственных API, PowerShell или REST.

Последовательное отслеживаемое обновление структуры службы позволяет администратору приложений настраивать политики оценки работоспособности, которые будут использоваться структурой службы для определения работоспособности приложения. Кроме того, оно позволяет администратору настраивать действия, которые необходимо предпринять при сбое оценки работоспособности, например выполнять автоматический откат приложения. В этом разделе пошагового руководства представлено отслеживаемое обновление одного из образцов пакета SDK.

## Шаг 1. Построение и развертывание образца визуальных объектов

Эти шаги можно выполнить, открыв проект в Visual Studio, щелкнув правой кнопкой мыши раздел "Решение" и выбрав команду развертывания в элементе меню "Структура служб". Дополнительные сведения см. в разделе [Управление приложением структуры служб в Visual Studio](service-fabric-manage-application-in-visual-studio.md). В качестве альтернативы можно использовать PowerShell.

> [AZURE.NOTE]До того как в PowerShell можно будет использовать хотя бы одну из команд структуры служб, необходимо сначала подключиться к соответствующему кластеру при помощи командлета `Connect-ServiceFabricCluster`. Аналогичным образом предполагается, что кластер уже установлен на локальном компьютере. См. статью, посвященную [настройке среды разработки структуры служб](service-fabric-get-started.md).

После создания проекта в Visual Studio можно использовать команду PowerShell **Copy-ServiceFabricApplicationPackage**, чтобы скопировать пакет приложения в ImageStore, с последующей регистрацией приложения в среде структуры служб при помощи командлета **Register-ServiceFabricApplicationPackage** и с последующим запуском экземпляра приложения при помощи командлета **New-ServiceFabricApplication**. Эти три шага аналогичны использованию меню "Развертывание" в Visual Studio.

Теперь можно использовать [обозреватель структуры служб для просмотра кластера и приложения](service-fabric-visualizing-your-cluster.md). Приложение имеет веб-службу, на которую можно перейти при помощи Internet Explorer, набрав адрес [http://localhost:80](http://localhost:80) в адресной строке. Вы сможете увидеть несколько плавающих визуальных объектов, перемещающихся по экрану. В дополнение можно использовать командлет **Get-ServiceFabricApplication** для проверки состояния приложения.

## Шаг 2. Обновление образца визуальных объектов

Вы можете заметить, что в версии, развернутой на шаге 1, визуальные объекты не вращаются. Давайте обновим это приложение до версии, в которой визуальные объекты будут вращаться.

Выберите проект VisualObjects.DataService в решении VisualObjects, после чего откройте файл VisualObjects.cs в этом проекте. В этом файле перейдите к методу `CreateMovedObject` и найдите строку, в которой устанавливается вращение визуальных объектов (ищите следующие строчки в методе `CreateMovedObject`). Закомментируйте строку `nextObject.Rotation = 1` и снимите оператор комментария со строки под ней. После внесения изменений код должен выглядеть следующим образом:

```c#
            //nextObject.Rotation = 1;

            // Once that's deployed, uncomment this line and upgrade the application:

             nextObject.Rotation = (nextObject.Rotation + 10) % 360;
```

Вам также необходимо обновить файл *ServiceManifest.xml* (в разделе PackageRoot) проекта **VisualObjects.DataService**. Обновите *CodePackage* и версию службы до версии 2.0. Соответствующие строки в *ServiceManifest.xml* должны выглядеть следующим образом (изменения выделены цветом в тексте кода):

```xml
<ServiceManifestName="VisualObjects.DataService"Version="2.0"xmlns="http://schemas.microsoft.com/2011/01/fabric"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

<CodePackageName="Code"Version="2.0">
```

Теперь нужно обновить файл *ApplicationManifest.xml* (находится в проекте **VisualObjects** в решении **VisualObjects**) так, чтобы в нем использовалась версия 2.0 проекта **VisualObjects.DataService**, а также обновить приложение с версии 1.0.0.0 до версии 2.0.0.0. Теперь соответствующие строки в файле *ApplicationManifest.xml* должны выглядеть следующим образом:

```xml
<ApplicationManifestxmlns:xsd="http://www.w3.org/2001/XMLSchema"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"ApplicationTypeName="VisualObjects"ApplicationTypeVersion="2.0.0.0"xmlns="http://schemas.microsoft.com/2011/01/fabric">

 <ServiceManifestRefServiceManifestName="VisualObjects.DataService"ServiceManifestVersion="2.0" />
```

Теперь создайте проект, выбрав проект **VisualObjects** и щелкнув правой кнопкой мыши пункт "Построить" в Visual Studio (при выборе пункта "Построить все" может потребоваться обновление версии проекта **VisualObjects.WebService**, а также изменение соответствующих файлов *ServiceManifest.xml* и *ApplicationManifest.xml*, поскольку код тоже изменится). Теперь давайте создадим пакет обновленного приложения, щелкнув правой кнопкой проект *VisualObjects*, выбрав меню "Структура служб" и пункт "Создать пакет". При этом должен создаться пакет приложения, пригодный для развертывания. Теперь обновленное приложение готово к развертыванию.

## Шаг 3. Определение политик работоспособности и параметров обновления

Ознакомьтесь с [параметрами обновления приложений](service-fabric-application-upgrade-parameters.md) и [процессом обновления](service-fabric-application-upgrade.md) для лучшего понимания различных параметров обновления, значений времени ожидания и применяемых критериев. В этом пошаговом руководстве мы оставим критерий оценки работоспособности службы в значении по умолчанию (с рекомендуемыми значениями), что означает, что все службы и экземпляры должны иметь статус _healthy_ (работоспособна) после обновления. Однако давайте повысим значение атрибута *HealthCheckStableDuration* до 60 секунд (чтобы все службы были работоспособны хотя бы 20 секунд перед переходом к другому домену обновления). Давайте также установим значение атрибута *UpgradeDomainTimeout* в значение "1200 секунд", а значение *UpgradeTimeout* — в значение "3000 секунд". И наконец, давайте также настроим атрибут *UpgradeFailureAction* на откат, запросив таким образом от структуры служб откат приложения до предыдущей версии при возникновении любых неполадок во время обновления. Таким образом, параметры обновления, которые мы зададим при запуске обновления (на шаге 4), будут таковы:

FailureAction = Rollback

HealthCheckStableDurationSec = 60

UpgradeDomainTimeoutSec = 1200

UpgradeTimeout = 3000

## Шаг 4. Подготовка приложения к обновлению

Теперь приложение создано и готово для обновления. Если открыть окно PowerShell с правами администратора и ввести команду **Get-ServiceFabricApplication**, то в нем должна отобразиться информация о том, что развернуто приложение 1.0.0.0 типа **VisualObjects**. Пакет приложения хранится по следующем относительному пути в зависимости от того, куда был извлечен SDK структуры служб: *Samples\\Services\\Stateful\\VisualObjects\\VisualObjects\\obj\\x64\\Debug*. Следует найти папку Package в этом каталоге, где хранится пакет приложения. Проверьте временные отметки, чтобы убедиться в том, что это самая последняя версия (возможно, потребуется также изменить пути).

Теперь давайте скопируем обновленный пакет приложения в ImageStore структуры службы (место, где структурой служб сохраняются пакеты приложения). Параметр *ApplicationPackagePathInImageStore* информирует структуру служб о том, где находится пакет приложения. Мы поместили обновленное приложение в папку VisualObjects\_V2 при помощи следующей команды (возможно, снова потребуется изменить пути).

```powershell
Copy-ServiceFabricApplicationPackage  -ApplicationPackagePath .\Samples\Services\Stateful\VisualObjects\VisualObjects\obj\x64\Debug\Package
-ImageStoreConnectionString fabric:ImageStore   -ApplicationPackagePathInImageStore "VisualObjects\_V2"
```

Следующим шагом необходимо зарегистрировать приложение в структуре служб. Это можно сделать при помощи следующей команды:

```powershell
Register-ServiceFabricApplicationType -ApplicationPathInImageStore "VisualObjects\_V2"
```

Если вышеупомянутая команда не будет успешно выполнена, возможно, следует заново построить все связанные службы. Как упомянуто на шаге 2, возможно, потребуется обновить версию объекта WebService.

## Шаг 5. Начало обновления приложения

Теперь у нас все готово для начала обновления приложения при помощи следующей команды:

```powershell
Start-ServiceFabricApplicationUpgrade -ApplicationName fabric:/VisualObjects -ApplicationTypeVersion 2.0.0.0 -HealthCheckStableDurationSec 60 -UpgradeDomainTimeoutSec 1200 -UpgradeTimeout 3000   -FailureAction Rollback -Monitored
```


Обратите внимание, что имя приложения соответствует описанному в файле *ApplicationManifest.xml*. Структура служб использует это имя, чтобы распознать приложение, которое будет обновлено. Если у вас установлены слишком малые значения времени ожидания, может возникнуть сообщение об ошибке, в котором будет обозначена возникшая проблема. Обратитесь к разделу по поиску и устранению неисправностей или увеличьте значения времени ожидания.

Теперь по мере продолжения обновления вы можете отслеживать его ход при помощи проводника структуры служб или следующей команды PowerShell: **Get-ServiceFabricApplicationUpgrade fabric:/VisualObjects**.

Через несколько минут в состоянии, связанном с используемой выше командой, должна отобразиться информация, что все домены обновления были обновлены (завершены). Теперь все визуальные объекты в окне браузера должны вращаться.

Вы можете попробовать изменить версии и перейти от версии 2 к версии 3 в качестве упражнения или даже от версии 2 назад к версии 1 (да, обновление с версии v2 до версии v1 возможно). Измените значения времени ожидания и политики работоспособности в качестве тренировки. При развертывании в кластере Azure используемые параметры будут отличаться от тех, которые применялись при развертывании в локальном кластере. Рекомендуется использовать консервативный подход при установке значений времени ожидания.


## Дальнейшие действия

[Параметры обновления](service-fabric-application-upgrade-parameters.md)

[Сериализация данных](service-fabric-application-upgrade-data-serialization.md)

[Дополнительные разделы](service-fabric-application-upgrade-advanced.md)

[Поиск и устранение неисправностей при обновлении приложения](service-fabric-application-upgrade-troubleshooting.md)
 

<!---HONumber=Oct15_HO3-->