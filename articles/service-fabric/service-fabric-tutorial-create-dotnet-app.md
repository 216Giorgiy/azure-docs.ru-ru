---
title: "Создание приложения .NET для Service Fabric | Документы Майкрософт"
description: "Узнайте, как создать приложение с клиентской частью ASP.NET Core и серверной частью в виде надежной службы с отслеживанием состояния и развернуть приложение в кластер."
services: service-fabric
documentationcenter: .net
author: rwike77
manager: timlt
editor: 
ms.assetid: 
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/09/2017
ms.author: ryanwi, mikhegn
ms.translationtype: HT
ms.sourcegitcommit: 14915593f7bfce70d7bf692a15d11f02d107706b
ms.openlocfilehash: 71d910bc0e459528805521ba991e5291396a3b8d
ms.contentlocale: ru-ru
ms.lasthandoff: 08/10/2017

---

# <a name="create-and-deploy-an-application-with-an-aspnet-core-web-api-front-end-service-and-a-stateful-back-end-service"></a>Создание и развертывание приложения с клиентской частью ASP.NET Core и серверной частью в виде надежной службы с отслеживанием состояния
Это руководство является одним из цикла. В нем показано, как создать приложение Azure Service Fabric с внешним интерфейсом веб-API ASP.NET Core и серверной частью в виде надежной службы с отслеживанием состояния для хранения данных. 

![Диаграмма приложения](./media/service-fabric-tutorial-create-dotnet-app/application-diagram.png)

В первой части цикла вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание службы веб-API ASP.NET Core как надежной службы
> * Создание надежной службы с отслеживанием состояния
> * Реализация удаленного взаимодействия служб и использование прокси службы

Из этого цикла руководств вы узнаете, как выполнять такие задачи:
> [!div class="checklist"]
> * Создание приложения .NET Service Fabric.
> * [Развертывание приложения в удаленном кластере](service-fabric-tutorial-deploy-app-to-party-cluster.md).
> * [Настройка непрерывной интеграции и непрерывного развертывания с помощью Visual Studio Team Services](service-fabric-tutorial-deploy-app-with-cicd-vsts.md).

## <a name="prerequisites"></a>Предварительные требования
Перед началом работы с этим руководством выполните следующие действия:
- Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
- [Установите Visual Studio 2017](https://www.visualstudio.com/), а также рабочие нагрузки **разработка Azure** и **ASP.NET и веб-разработка**.
- [Установка пакета SDK для Service Fabric](service-fabric-get-started.md)

## <a name="create-an-aspnet-web-api-service-as-a-reliable-service"></a>Создание службы веб-API ASP.NET как надежной службы
ASP.NET Core — это простое кросс-платформенное средство для разработки веб-страниц, позволяющее создавать современные пользовательские веб-интерфейсы и интерфейсы веб-API. Чтобы получить полное представление об интеграции ASP.NET Core с Service Fabric, мы настоятельно рекомендуем ознакомиться со статьей [ASP.NET Core в Service Fabric Reliable Services](service-fabric-reliable-services-communication-aspnetcore.md). А пока можете воспользоваться этим руководством, чтобы быстро приступить к работе. Дополнительные сведения об ASP.NET Core см. в [документации по ASP.NET Core](https://docs.microsoft.com/aspnet/core/).

> [!NOTE]
> Этот учебник опирается на [средства ASP.NET Core для Visual Studio 2017](https://docs.microsoft.com/aspnet/core/tutorials/first-mvc-app/start-mvc). Средства .NET Core для Visual Studio 2015 больше не обновляются.

1. Запустите Visual Studio от имени **администратора**.

2. Выберите **Файл**->**Создать**->**Проект**, чтобы создать проект.

3. В диалоговом окне **Создание проекта** выберите **Облако > Приложение Service Fabric**.

4. Укажите имя приложения **MyApplication** и нажмите кнопку **ОК**.

   ![Диалоговое окно "Новый проект" в Visual Studio](./media/service-fabric-tutorial-create-dotnet-app/new-project-dialog.png)

5. На странице **Новая служба Service Fabric** выберите **ASP.NET Core без отслеживания состояния** и укажите имя службы **MyWebAPIFrontEnd**.
   
   ![Выбор веб-службы ASP.NET в диалоговом окне создания службы](./media/service-fabric-tutorial-create-dotnet-app/new-project-dialog-2.png) 

6. На следующей странице представлен набор шаблонов проекта ASP.NET Core. В этом руководстве мы будем использовать **веб-API**. Однако те же идеи можно использовать и при построении полноценного веб-приложения.
   
   ![Выбор типа проекта ASP.NET](./media/service-fabric-tutorial-create-dotnet-app/vs-new-aspnet-project-dialog.png)

   Visual Studio создает приложение и проект службы и отображает их в обозревателе решений.

   ![Обозреватель решений после создания приложения и службы веб-API ASP.NET Core]( ./media/service-fabric-tutorial-create-dotnet-app/solution-explorer-aspnetcore-service.png)

### <a name="deploy-and-debug-the-application-locally"></a>Локальное развертывание и отладка приложения
Теперь можно выполнить отладку приложения и посмотреть на поведение шаблона веб-API ASP.NET Core по умолчанию.

Чтобы начать отладку, разверните приложение, нажав в Visual Studio клавишу `F5`. Если Visual Studio не была открыта ранее с правами **администратора**, `F5` завершается неудачно.

> [!NOTE]
> Во время первого запуска и развертывания приложения локально Visual Studio создает локальный кластер для отладки. Это может занять некоторое время. Процесс создания кластера можно наблюдать в окне вывода Visual Studio.

Когда кластер будет готов, вы получите уведомление от диспетчера локального кластера Service Fabric в области состояния.

1. В Visual Studio нажмите клавишу F5, чтобы начать отладку приложения.
2. После завершения развертывания Visual Studio запустит браузер и откроет в нем корневой каталог службы веб-API ASP.NET. Так как шаблон веб-API ASP.NET Core не предоставляет поведение по умолчанию для корневого каталога, в браузере будет показано сообщение об ошибке.
3. Добавьте `/api/values` к URL-адресу в адресной строке браузера. При этом будет вызван метод `Get` объекта ValuesController в шаблоне веб-API. Он вернет ответ по умолчанию, предоставленный шаблоном, — массив JSON, который содержит две строки:
   
![Значения по умолчанию, возвращаемые шаблоном веб-API ASP.NET Core](./media/service-fabric-tutorial-create-dotnet-app/browser-aspnet-template-values.png)

> [!NOTE]
> Чтобы изменить поведение Visual Studio 2017 по умолчанию при отладке приложения, измените свойства проекта приложения Service Fabric **MyApplication**.
> В этом учебнике для оптимизации отладки используется режим отладки приложения **Обновление приложения**, а к свойству "URL-адрес приложения" добавляется **'/api/values'**.
> 

Чтобы остановить отладку приложения, вернитесь в Visual Studio и нажмите **SHIFT+F5**.

### <a name="understanding-the-service-fabric-application-and-service"></a>Основные сведения о приложении и службе Service Fabric
Теперь решение Visual Studio содержит два проекта.
1. Проект приложения Service Fabric — **MyApplication**
    - Этот проект не содержит кода. Он только ссылается на набор проектов служб. Кроме того, он содержит другие типы содержимого, которые определяют, как формируется и развертывается ваше приложение.
2. Проект службы — **MyWebAPIFrontEnd**
    - Этот проект веб-API ASP.NET Core, содержащий код и конфигурацию для службы. Взглянув на файл кода ValuesController.cs в папке Controllers, вы увидите, что это обычный контроллер веб-API ASP.NET Core. Существуют особые требования к коду контроллеров при запуске веб-API ASP.NET Core в качестве надежной службы в Service Fabric.

Дополнительные сведения о моделировании приложений в Service Fabric см. в разделе [Моделирование приложений в Service Fabric](service-fabric-application-model.md).

Дополнительные сведения о содержимом проекта службы см. в разделе [Приступая к работе с надежными службами](service-fabric-reliable-services-quick-start.md).

## <a name="add-a-stateful-back-end-service-to-your-application"></a>Добавление в приложение серверной службы с отслеживанием состояния
Теперь, когда в нашем приложении есть служба веб-API ASP.NET, давайте добавим надежную службу с отслеживанием состояния, чтобы сохранить в нашем приложении некоторые данные.

Service Fabric позволяет согласованно и надежно хранить данные прямо в службе с помощью надежных коллекций. Надежные коллекции — это простой набор классов коллекций с высокой доступностью и надежностью, которые будут знакомы всем, кто использовал коллекции C#.

В этом руководстве вы создадите службу, которая хранит значение счетчика в надежной коллекции.

1. В обозревателе решений в проекте приложения щелкните правой кнопкой мыши **Службы** и последовательно выберите **Добавить > Новая служба Service Fabric**.
   
    ![Добавление новой службы в существующее приложение](./media/service-fabric-tutorial-create-dotnet-app/vs-add-new-service.png)

2. В диалоговом окне **Новая служба Service Fabric** выберите **Служба с отслеживанием состояния**, укажите имя службы **MyStatefulService** и нажмите кнопку **ОК**.

    ![Диалоговое окно "Новая служба" в Visual Studio](./media/service-fabric-tutorial-create-dotnet-app/add-stateful-service.png)

    После создания проекта службы в вашем приложении будут две службы. По мере разработки приложения можно добавить дополнительные службы точно таким же образом. Каждая из этих служб может быть отдельно обновлена, в том числе до определенной версии.

### <a name="deploy-and-debug-the-application-locally"></a>Локальное развертывание и отладка приложения
Добавив в приложение новую службу, давайте выполним отладку приложения и посмотрим на поведение новой службы по умолчанию.

В Visual Studio нажмите клавишу F5, чтобы начать отладку приложения.

> [!NOTE]
> Если вы решили использовать **Обновление приложения** в качестве режима отладки приложения, вам будет предложено предоставить локальный доступ к выходной папке сборки приложения для кластера Service Fabric.
> 

Обе службы собраны, развернуты в локальном кластере Service Fabric и сохраняют состояние. После запуска служб Visual Studio запустит браузер, а также автоматически откроет **Средство просмотра диагностических событий**, в котором отображаются данные трассировки служб.
   
![Средство просмотра диагностических событий](./media/service-fabric-tutorial-create-dotnet-app/diagnostic-events-viewer.png)

В средстве просмотра диагностических событий отображаются сообщения трассировки для всех служб, которые являются частью отлаживаемого решения Visual Studio. Приостановив средство просмотра диагностических событий, вы сможете развернуть необходимое сообщение службы и просмотреть его свойства. Таким образом, можно увидеть, какие службы в кластере отправили сообщение, на каком из узлов сейчас запущен этот экземпляр службы и другие сведения.

![Средство просмотра диагностических событий](./media/service-fabric-tutorial-create-dotnet-app/expanded-diagnostics-viewer.png)

Вы видите, что сообщения службы поступают от службы с отслеживанием состояния, так как тип службы (**serviceTypeName**) — **MyStatefulServiceType**. Вы также видите, что эта служба отправляет сообщения с текстом "Текущее значение счетчика: ...". Это сообщение формируется выделенной строкой кода в методе `RunAsync` файла **MyStatefulService.cs**, который показан на следующем снимке экрана.

![Код сообщения службы](./media/service-fabric-tutorial-create-dotnet-app/service-message-code.png)

Дополнительные сведения об отправке диагностической информации из служб и приложений см. в разделе [Мониторинг и диагностика для Azure Service Fabric](service-fabric-diagnostics-overview.md).

Чтобы остановить отладку приложения, вернитесь в Visual Studio и нажмите **SHIFT+F5**.

### <a name="understanding-the-mystatefulservice-code"></a>Общие сведения о коде службы MyStatefulService
Чтобы понять, как эта служба сохраняет данные в кластере с помощью надежного словаря, посмотрим на код службы **MyStatefulService**.

В коде службы есть пять строк, которые связаны с созданием, изменением и чтением надежного словаря.

![Код надежного словаря](./media/service-fabric-tutorial-create-dotnet-app/reliable-dictionary-code.png)

1. Каждый раз при выполнении метода `RunAsync` службы (это происходит при запуске службы) эта строка кода получает надежный словарь с именем `myDictionary` или добавляет этот надежный словарь к службе.
2. Все взаимодействие с надежным словарем осуществляется с помощью транзакций. Для создания транзакции используется инструкция using, которую вы видите в этой строке кода.
3. Эта строка кода возвращает значение, связанное с ключом, который указан в вызове метода, например `Counter`.
4. Эта строка кода изменяет значение, связанное с ключом `Counter`, увеличивая это значение.
5. При вызове этого метода транзакция фиксируется. После того как измененное значение сохраняется в кворуме узлов в кластере, выполняется возврат из метода.

Дополнительные сведения о надежных словарях и надежных коллекциях см. в разделе [Общие сведения о надежных коллекциях в службах с отслеживанием состояния Azure Service Fabric](service-fabric-reliable-services-reliable-collections.md).

## <a name="connect-the-services"></a>Подключение служб
На следующем этапе мы свяжем две службы и сделаем так, чтобы веб-API клиентской части возвращал текущее значение счетчика, полученное из надежного словаря служб серверной части.

Service Fabric позволяет пользователям самим определять способ взаимодействия со службами Reliable Services. В составе одного приложения одни службы могут быть доступны по протоколу TCP. Другие службы могут быть доступны через API REST HTTP, третьи — через веб-сокеты. Сведения о доступных возможностях и их преимуществах и недостатках см. в статье [Подключение к службам в Service Fabric и взаимодействие с ними](service-fabric-connect-and-communicate-with-services.md).

В этом учебнике мы используем [Удаленное взаимодействие служб с использованием надежных служб](service-fabric-reliable-services-communication-remoting.md).

При удаленном взаимодействии со службой (на основе удаленных вызовов процедур, или RPC) вы определяете интерфейс, который будет выступать в качестве общедоступного контракта службы. Затем этот интерфейс используется для создания класса прокси для взаимодействия со службой.

### <a name="create-the-remoting-interface"></a>Создание интерфейса удаленного взаимодействия
Мы начнем с создания интерфейса, который будет выступать в качестве контракта между двумя службами. На этот интерфейс должны ссылаться все службы, которые его используют, поэтому мы создаем его в отдельном проекте библиотеки классов.

1. В обозревателе решений щелкните решение правой кнопкой мыши и выберите **Добавить** > **Новый проект**.
2. В области навигации слева выберите **Visual C#**, а затем — шаблон **Библиотека классов (.NET Framework)**. Убедитесь, что для платформы .NET Framework установлена версия **4.5.2** или более поздняя.
   
    ![Создание проекта интерфейса для службы с отслеживанием состояния](./media/service-fabric-tutorial-create-dotnet-app/vs-add-class-library-project.png)

3. Укажите имя библиотеки классов **MyStatefulService.Interface** и нажмите кнопку **ОК**.

4. В обозревателе решений щелкните решение правой кнопкой мыши и выберите **Управление пакетами NuGet для решения**.

5. Нажмите кнопку **Обзор** и найдите пакет **Microsoft.ServiceFabric.Services.Remoting**. Установите его для трех проектов служб в решении: 
   
    ![Добавление пакета NuGet для служб](./media/service-fabric-tutorial-create-dotnet-app/add-nuget.png)

6. В библиотеке классов создайте интерфейс с помощью одиночного метода `GetCountAsync`и выполните расширение интерфейса из `Microsoft.ServiceFabric.Services.Remoting.IService`. Интерфейс удаленного доступа должен быть производным от этого интерфейса для указания, что он является интерфейсом удаленного взаимодействия со службой. 
   
    ```c#
    using Microsoft.ServiceFabric.Services.Remoting;  
    using System.Threading.Tasks;
    ...
    namespace MyStatefulService.Interface
    {           
        public interface ICounter: IService
        {
            Task<long> GetCountAsync();
        }
    }
    ```
7. Щелкните проект **MyStatefulService.Interface** в обозревателе решений правой кнопкой мыши и выберите **Свойства**. Перейдите на вкладку **Сборка** и выберите **x64** в раскрывающемся списке **Целевая платформа**. 

8. Сохраните изменения.

### <a name="implement-the-interface-in-your-stateful-service"></a>Реализация интерфейса в службе с отслеживанием состояния
Теперь, когда мы определили интерфейс, нам нужно реализовать его в нашей службе с отслеживанием состояния.

1. Добавьте ссылку на проект библиотеки классов, который содержит интерфейс из проекта **MyStatefulService**.
   
    ![Добавление ссылки на проект библиотеки классов в службе с отслеживанием состояния](./media/service-fabric-tutorial-create-dotnet-app/vs-add-class-library-reference.png)

    ![Добавление ссылки на проект библиотеки классов в службе с отслеживанием состояния](./media/service-fabric-tutorial-create-dotnet-app/vs-add-class-library-reference-2.png)

2. Откройте файл `MyStatefulService.cs` и унаследуйтесь от него, чтобы реализовать интерфейс `ICounter`, который мы создали.
   
    ```c#
    using MyStatefulService.Interface;
    ...
   
    public class MyStatefulService : StatefulService, ICounter
    {        
          // ...
    }
    ```

3. Теперь реализуйте одиночный метод `GetCountAsync`, определенный в интерфейсе `ICounter`.
   
    ```c#
    public async Task<long> GetCountAsync()
    {
        var myDictionary =
          await this.StateManager.GetOrAddAsync<IReliableDictionary<string, long>>("myDictionary");
   
        using (var tx = this.StateManager.CreateTransaction())
        {          
            var result = await myDictionary.TryGetValueAsync(tx, "Counter");
            return result.HasValue ? result.Value : 0;
        }
    }
    ```

    - Этот метод возвращает значение ключа `Counter`, который хранится в надежном словаре `myDictionary`. 

### <a name="expose-the-stateful-service-using-service-remoting"></a>Предоставление доступа к службе с отслеживанием состояния с помощью удаленного взаимодействия служб
После реализации интерфейса `ICounter` необходимо открыть конечную точку для удаленного взаимодействия служб. Для служб с отслеживанием состояния Service Fabric предоставляет переопределяемый метод `CreateServiceReplicaListeners`. С помощью этого метода можно указать один или несколько прослушивателей связи, на основе типа связи, который вы хотите включить в службе.

В нашем случае мы заменим имеющийся метод `CreateServiceReplicaListeners` и укажем экземпляр `ServiceRemotingListener`, создающий конечную точку RPC, вызываемую с клиентов с помощью `ServiceProxy`.  

Измените метод **CreateServiceReplicaListeners** в файле **MyStatefulService.cs** и добавьте инструкцию using в пространство имен `Microsoft.ServiceFabric.Services.Remoting.Runtime`.

```c#
using Microsoft.ServiceFabric.Services.Remoting.Runtime;

...

protected override IEnumerable<ServiceReplicaListener> CreateServiceReplicaListeners()
{
    return new List<ServiceReplicaListener>()
    {
        new ServiceReplicaListener(
            (context) =>
                this.CreateServiceRemotingListener(context))
    };
}
```

Теперь наша служба с отслеживанием состояния готова получать трафик от других служб через RPC с помощью удаленного взаимодействия служб.

### <a name="call-the-stateful-back-end-service-from-the-front-end-service"></a>Вызов службы с отслеживанием состояния серверной части из службы клиентской части
Теперь, когда наша служба серверной части предоставила интерфейс, остается только добавить код для взаимодействия с этой службой из службы веб-API ASP.NET. Для взаимодействия со службой с помощью удаленного взаимодействия мы используем прокси службы из контроллера Values.

1. В обозревателе решений разверните **MyWebAPIFrontEnd**, щелкните правой кнопкой мыши **Зависимости** и выберите **Добавить ссылку**.  Выберите **MyStatefulService.Interface** и нажмите кнопку **OK**.
   
2. В папке **Controllers** откройте файл `ValuesController.cs`. Добавьте в этот файл следующие инструкции using:

    ```c#
    using MyStatefulService.Interface;
    using Microsoft.ServiceFabric.Services.Client;
    using Microsoft.ServiceFabric.Services.Remoting.Client;
    ```
    
3. Сейчас метод `Get` просто возвращает жестко закодированный строковый массив значений "value1" и "value2", соответствующих тем, которые мы видели ранее в браузере. Замените эту реализацию следующим кодом:
   
    ```
    public async Task<IEnumerable<string>> Get()
    {
        ICounter counter =
            ServiceProxy.Create<ICounter>(new Uri("fabric:/MyApplication/MyStatefulService"), new ServicePartitionKey(0));
   
        long count = await counter.GetCountAsync();
   
        return new string[] { count.ToString() };
    }
    ```
 
    В первой строке кода в этом методе создается объект ServiceProxy для службы с отслеживанием состояния с использованием интерфейса ICounter. При создании объекта ServiceProxy необходимо указать два параметра: идентификатор раздела и имя службы.
   
    Для масштабирования служб с отслеживанием состояния можно разбить данные на различные контейнеры на основе ключа, например идентификатора клиента или почтового индекса. Так как в обычном приложении у службы с отслеживанием состояния есть только один раздел, ключ не имеет особого значения. При указании любого ключа будет создан один и тот же раздел. Дополнительные сведения о секционировании служб см. в статье [Секционирование служб Reliable Services в Service Fabric](service-fabric-concepts-partitioning.md).
   
    Имя службы — это универсальный код ресурса в формате fabric:/&lt;имя_приложения&gt;/&lt;имя_службы&gt;.
   
    Service Fabric использует эти два блока информации для уникальной идентификации компьютера, на который должны отправляться запросы. Класс `ServiceProxy` также согласованно переключает операции на другой компьютер, когда на компьютере с размещенной секцией службы с отслеживанием состояния происходит сбой. Эта абстракция упрощает написание кода клиента для взаимодействия с другими службами.
   
    После создания прокси мы вызываем метод `GetCountAsync`, который возвращает результат.

4. Нажмите клавишу F5 еще раз, чтобы запустить измененное приложение. Visual Studio автоматически откроет в браузере корень веб-проекта. Добавьте путь api/values, и вы увидите возвращаемое текущее значение счетчика.
   
    ![Отображаемое в браузере значение счетчика с отслеживанием состояния](./media/service-fabric-tutorial-create-dotnet-app/browser-aspnet-counter-value.png)
   
    Периодически обновляйте браузер, чтобы отслеживать актуальные показания счетчика.

Чтобы остановить отладку приложения, вернитесь в Visual Studio и нажмите **SHIFT+F5**.

## <a name="next-steps"></a>Дальнейшие действия
В этой части руководства вы узнали, как выполнить следующие действия:

> [!div class="checklist"]
> * Создание службы веб-API ASP.NET Core как надежной службы
> * Создание надежной службы с отслеживанием состояния
> * Реализация удаленного взаимодействия служб и использование прокси службы

Перейдите к следующему руководству:
> [!div class="nextstepaction"]
> [Развертывание приложения в Azure](service-fabric-tutorial-deploy-app-to-party-cluster.md)
