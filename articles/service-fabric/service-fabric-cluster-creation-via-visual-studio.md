<properties
   pageTitle="Настройка кластера Service Fabric с помощью Visual Studio | Microsoft Azure"
   description="Описание настройки кластера Service Fabric с помощью шаблона диспетчера ресурсов Azure (ARM), созданного с использованием проекта группы ресурсов в Visual Studio"
   services="service-fabric"
   documentationCenter=".net"
   authors="karolz-ms"
   manager="adegeo"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotNet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="04/04/2016"
   ms.author="karolz@microsoft.com"/>

# Настройка кластера Service Fabric с помощью Visual Studio
В этой статье описывается настройка кластера Azure Service Fabric с помощью Visual Studio и шаблона диспетчера ресурсов Azure (ARM). Для создания шаблона мы будем использовать проект группы ресурсов Azure Visual Studio. Созданный шаблон можно напрямую развернуть из Visual Studio в Azure, но его также можно использовать в сценарии или в ходе процесса непрерывной интеграции (CI).

## Создание шаблона кластера Service Fabric с помощью проекта группы ресурсов Azure
Чтобы начать работу, откройте Visual Studio и создайте проект группы ресурсов Azure (он доступен в папке **Облако**).

![Диалоговое окно "Новый проект" с выбранным проектом группы ресурсов Azure][1]

Можно создать новое решение Visual Studio для данного проекта или добавить его в существующее решение.

>[AZURE.NOTE] Если проект группы ресурсов Azure не отображается в узле "Облако", значит у вас не установлен пакет SDK Azure. Запустите установщик веб-платформы ([установите его отсюда](http://www.microsoft.com/web/downloads/platform.aspx), если еще этого не сделали), затем выполните поиск по фразе "пакет SDK Azure для .NET" и установите версию, совместимую с используемой версией Visual Studio.

После нажатия кнопки OK Visual Studio предложит выбрать шаблон диспетчера ресурсов, который требуется создать:

![Диалоговое окно "Выбор шаблона Azure" с выбранным шаблоном кластера Service Fabric][2]

Выберите шаблон "Кластер Service Fabric" и нажмите кнопку ОК. Проект и шаблон диспетчера ресурсов созданы.

## Подготовка шаблона к развертыванию
Перед развертыванием шаблона для создания кластера необходимо указать значения для обязательных параметров шаблона. Эти значения параметров считываются из файла `ServiceFabricCluster.parameters.json`, который находится в папке `Templates` проекта группы ресурсов. Откройте файл и укажите следующие значения.

|Имя параметра |Описание|
|-----------------------  |--------------------------|
|certificateThumbprint |Отпечаток сертификата, который обеспечивает защиту кластера.|
|sourceVaultResourceId |*Идентификатор ресурса* хранилища ключей, где хранится сертификат, который обеспечивает защиту кластера.|
|certificateUrlValue |URL-адрес сертификата безопасности кластера.|

Шаблон диспетчера ресурсов Service Fabric Visual Studio создает безопасный кластер, защищенный с помощью сертификата. Этот сертификат идентифицируется по трем последним параметрам шаблона (`certificateThumbprint`, `sourceVaultValue` и `certificateUrlValue`) и должен существовать в **хранилище ключей Azure**. Дополнительные сведения о создании сертификата безопасности кластера см. в подразделе [Защита кластеров Service Fabric с помощью сертификатов](service-fabric-cluster-security.md#secure-a-service-fabric-cluster-by-using-certificates).

## Изменение имени кластера (необязательно)
У каждого кластера Service Fabric есть имя. При создании кластера Fabric в Azure имя кластера (вместе с регионом Azure) определяет имя системы доменных имен (DNS) для кластера. Например, если указать имя кластера `myBigCluster`, а параметр `clusterLocation` при этом имеет значение "Восточная часть США", DNS-имя кластера будет выглядеть следующим образом: `myBigCluster.eastus.cloudapp.azure.com`.

По умолчанию имя кластера создается автоматически, и для того, чтобы оно было уникальным, к префиксу "cluster" добавляется случайный суффикс. Это позволяет легко использовать шаблон в системе **непрерывной интеграции** (CI). Если вы хотите использовать определенное осмысленное имя для кластера, установите его в переменной `clusterName` в файле шаблона Resource Manager (`ServiceFabricCluster.json`). Это первая переменная, определенная в этом файле.

## Добавление общедоступных портов приложения (необязательно)
Также можно изменить открытые порты приложений кластера перед его развертыванием. По умолчанию в шаблоне открыты только два TCP-порта (80 и 8081). Если вашим приложениям необходимо больше открытых портов, измените определение балансировщика нагрузки Azure в шаблоне. Определение хранится в файле основного шаблона (`SecureFabricCluster.json`). Откройте этот файл и выполните поиск `loadBalancedAppPort`. Вы заметите, что каждый порт связан с тремя артефактами.

1. Переменная шаблона, который определяет значение TCP-порта для порта:

	```json
	"loadBalancedAppPort1": "80"
	```

2. *Проба*, которая определяет, как часто и как долго балансировщик нагрузки Azure будет пытаться использовать конкретный узел Service Fabric до перехода на другой узел. Пробы являются частью ресурса балансировщика нагрузки. Далее приводится определение проверки для первого порта приложения по умолчанию:

	```json
	{
        "name": "AppPortProbe1",
        "properties": {
            "intervalInSeconds": 5,
            "numberOfProbes": 2,
            "port": "[variables('loadBalancedAppPort1')]",
            "protocol": "Tcp"
        }
    }
	```

3. *Правило балансировки нагрузки*, которое связывает порт и пробу, которая включает балансировку нагрузки в наборе узлов кластера Service Fabric.

    ```json
	{
	    "name": "AppPortLBRule1",
	    "properties": {
	        "backendAddressPool": {
	            "id": "[variables('lbPoolID0')]"
	        },
	        "backendPort": "[variables('loadBalancedAppPort1')]",
	        "enableFloatingIP": false,
	        "frontendIPConfiguration": {
	            "id": "[variables('lbIPConfig0')]"
	        },
	        "frontendPort": "[variables('loadBalancedAppPort1')]",
	        "idleTimeoutInMinutes": 5,
	        "probe": {
	            "id": "[concat(variables('lbID0'),'/probes/AppPortProbe1')]"
	        },
	        "protocol": "Tcp"
	    }
	}
    ```
Если приложениям, которые вы хотите развернуть в кластере, нужны дополнительные порты, их можно добавить путем создания дополнительной проверки и определений правил балансировки нагрузки. Дополнительные сведения о работе с балансировщиком нагрузки Azure с помощью шаблонов Resource Manager см. в статье [Начало работы по созданию внутреннего балансировщика нагрузки с помощью шаблона](../load-balancer/load-balancer-get-started-ilb-arm-template.md).

## Развертывание шаблона с помощью Visual Studio
После сохранения всех обязательных параметров в файл `ServiceFabricCluster.param.dev.json` можно приступить к развертыванию шаблона и созданию кластера Service Fabric. Щелкните правой кнопкой мыши проект группы ресурсов в обозревателе решений Visual Studio и выберите **Развернуть**. В Visual Studio откроется диалоговое окно **Развернуть в группе ресурсов** с запросом на аутентификацию в Azure (если необходимо).

![Диалоговое окно "Развертывание в группе ресурсов"][3]

В диалоговом окне можно выбрать существующую группу ресурсов диспетчера ресурсов для кластера или создать новую. Как правило, для кластера Service Fabric целесообразно использовать отдельную группу ресурсов.

После нажатия кнопки "Развернуть" Visual Studio предложит подтвердить значения параметров шаблона. Нажмите кнопку **Сохранить**. Один параметр не имеет сохраненного значения: это пароль учетной записи администратора для кластера. Это значение необходимо указать, когда Visual Studio предложит это сделать.

>[AZURE.NOTE] Если средство PowerShell никогда не использовалось для администрирования Azure с компьютера, который используется в настоящий момент, необходимо выполнить некоторые служебные действия.
>1. Включите поддержку сценариев PowerShell, выполнив команду [`Set-ExecutionPolicy`](https://technet.microsoft.com/library/hh849812.aspx). Для компьютеров разработчиков обычно устанавливается политика "Без ограничений".
>2. Решите, следует ли разрешить сбор диагностических данных с помощью команд Azure PowerShell, и при необходимости выполните команды [`Enable-AzureRmDataCollection`](https://msdn.microsoft.com/library/mt619303.aspx) или [`Disable-AzureRmDataCollection`](https://msdn.microsoft.com/library/mt619236.aspx). Это позволит избежать вывода ненужных запросов во время развертывания шаблона.

Ход выполнения процесса развертывания можно отследить в окне выходных данных Visual Studio. После завершения развертывания шаблонов новый кластер готов к использованию!

При появлении ошибок перейдите к [порталу Azure](https://portal.azure.com/) и откройте группу ресурсов, в которую вы выполнили развертывание. Щелкните **Все настройки**, затем **Развертывания** в колонке "Настройки". В области уведомлений будут находиться подробные диагностические сведения о неудачном развертывании группы ресурсов.

>[AZURE.NOTE] Для постоянной работы кластеров Service Fabric требуется определенное количество узлов, чтобы все время поддерживать доступность и сохранять состояние, которое называется "поддержание кворума". Поэтому обычно не рекомендуется завершать работу всех компьютеров в кластере, пока не будет выполнена [полная архивация состояния](service-fabric-reliable-services-backup-restore.md), так как это может быть небезопасно.

## Дальнейшие действия
- [Узнайте больше о настройке кластера Service Fabric с помощью портала Azure](service-fabric-cluster-creation-via-portal.md)
- [Узнайте больше о развертывании приложений Service Fabric и управлении ими с помощью Visual Studio](service-fabric-manage-application-in-visual-studio.md)

<!--Image references-->
[1]: ./media/service-fabric-cluster-creation-via-visual-studio/azure-resource-group-project-creation.png
[2]: ./media/service-fabric-cluster-creation-via-visual-studio/selecting-azure-template.png
[3]: ./media/service-fabric-cluster-creation-via-visual-studio/deploy-to-azure.png

<!---HONumber=AcomDC_0406_2016-->