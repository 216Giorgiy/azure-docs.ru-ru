<properties
   pageTitle="Непрерывная интеграция для Service Fabric | Microsoft Azure"
   description="Общие сведения о том, как настроить непрерывную интеграцию для приложения Service Fabric, используя Visual Studio Team Services (VSTS)."
   services="service-fabric"
   documentationCenter="na"
   authors="cawams"
   manager="timlt"
   editor="" />
<tags
   ms.service="multiple"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="multiple"
   ms.date="01/27/2016"
   ms.author="cawa" />

# Настройка непрерывной интеграции для приложения Service Fabric с использованием Visual Studio Team Services (VSTS)

В этой статье подробно описаны действия по настройке непрерывной интеграции для приложения Service Fabric с использованием служб Visual Studio Team Services (VSTS), которые обеспечат автоматические сборку, упаковку и развертывание приложения. Обратите внимание: следуя этим инструкциям, вы каждый раз будете создавать кластер с нуля.

Этот документ описывает текущую процедуру, которая со временем будет изменена.

## Предварительные требования

Чтобы приступить к работе, необходимо выполнить сборку проекта в Visual Studio Team Services.

1. Создайте учетную запись Team Services, используя [учетную запись Майкрософт](http://www.microsoft.com/account), если вы еще не сделали это.

2. Создайте проект в Team Services, используя учетную запись Майкрософт.

3. Добавьте источник нового или существующего приложения Service Fabric в этот проект.

Дополнительные сведения о работе с проектами Team Services см. в разделе [Подключение к Visual Studio](https://www.visualstudio.com/get-started/setup/connect-to-visual-studio-online).

## Настройка субъекта-службы

### Настройка проверки подлинности для службы автоматизации

Прежде чем настроить компьютер сборки, создайте [субъект-службу](../resource-group-create-service-principal-portal.md), которую агент сборки будет использовать для проверки подлинности в Azure. Вам также необходимо создать сертификат и передать его в хранилище ключей Azure, так как хранилище ключей не поддерживает проверку подлинности с использованием субъекта-службы. Эти шаги можно выполнить на любом компьютере. Больше всего для этого подходит компьютер разработки.

### Установка Azure PowerShell и вход в среду

1.	Установите Azure PowerShell.
2. Установите PowerShellGet. Для этого установите платформу [Windows Management Framework 5.0](http://www.microsoft.com/download/details.aspx?id=48729), в состав которой входит PowerShellGet.

    >[AZURE.NOTE] Этот шаг можно пропустить, если вы используете Windows 10 с последними обновлениями.

3.	Установите и обновите модуль AzureRM. Если установлен модуль Azure PowerShell предыдущих версий, удалите его:

    а. Щелкните правой кнопкой мыши кнопку "Пуск", а затем выберите **Установка и удаление программ**.

    b. Найдите Azure PowerShell и удалите ее.

    c. Запустите командную строку PowerShell.

    г) Установите модуль AzureRM с помощью команды `Install-Module AzureRM`.

    д. Обновите модуль AzureRM, используя команду `Update-AzureRM`.

3.	Отключите или включите сбор данных Azure.

    Командлеты Azure будут запрашивать согласие на принятие или отключение сбора данных, пока вы не сделаете выбор. Эти запросы будут блокировать службу автоматизации, пока пользователь не введет данные. Чтобы отключить эти запросы, сделайте выбор на упреждение, выполнив одну из следующих команд:

    - Enable-AzureRmDataCollection

    - Disable-AzureRmDataCollection

4.	Войдите в Azure PowerShell.

    а. Выполните команду `Login-AzureRmAccount`.

    b. В отобразившемся диалоговом окне введите учетные данные Azure.

    c. Выполните команду `Get-AzureRmSubscription`.

    г) Найдите подписку, которая будет использоваться.

    д. Выполните команду `Select-AzureRmSubscription -SubscriptionId <id for your subscription>`.

### Создание субъекта-службы

1.	Загрузите и извлеките файл [ServiceFabricContinuousIntegrationScripts.zip](https://gallery.technet.microsoft.com/Set-up-continuous-f8b251f6) в папку на этом компьютере.

2.	В командной строке администратора PowerShell перейдите в каталог `Powershell\Manual` извлеченного архива.

3.	Выберите пароль для субъекта-службы, используя следующую команду. Запомните этот пароль, так как он будет использоваться как переменная сборки.

    ```
    $password = Read-Host -AsSecureString
    ```
4.	Запустите сценарий PowerShell Create-ServicePrincipal.ps1, используя следующие параметры:

|Параметр|Значение|
|---|---|
|DisplayName|Любое имя.|
|HomePage|Любой универсальный код ресурса. Не должен существовать на самом деле.|
|IdentifierUri|Любой уникальный универсальный код ресурса. Не должен существовать на самом деле.|
|SecurePassword|$password|

После выполнения сценария он выведет следующие три значения. Обратите внимание на значения, так как они будут использоваться в качестве переменных сборки:

*  `ServicePrincipalId`
*  `ServicePrincipalTenantId`
*  `ServicePrincipalSubscriptionId`

### Создание сертификата и его передача в новое хранилище ключей Azure

>[AZURE.NOTE] В этом примере скрипт создает самозаверяющий сертификат. На практике так делать не стоит, и такой вариант допустим только для эксперимента. Вместо этого следуйте рекомендациям по получению законного сертификата своей организации.

1.	В командной строке PowerShell перейдите в каталог, из которого извлечен архив `Manual.zip`.

2.	Запустите сценарий PowerShell `CreateAndUpload-Certificate.ps1` со следующими параметрами:

| Параметр | Значение |
| --- | --- |
| KeyVaultLocation | Любое значение. Этот параметр должен соответствовать расположению, в котором планируется создание кластера. |
| CertificateSecretName | Любое значение. |
| SecureCertificatePassword | Любое значение. Этот параметр используется при импорте сертификата на компьютер сборки. |
| KeyVaultResourceGroupName | Любое значение. Тем не менее, не используйте имя группы ресурсов, которую планируете использовать для кластера. |
| KeyVaultName | Любое значение. |
| PfxFileOutputPath|Любое значение. Этот файл используется для импорта сертификата на компьютер сборки. |

После выполнения сценария он выведет следующие три значения. Обратите внимание на эти значения, так как они будут использоваться в качестве переменных сборки:

* `ServiceFabricCertificateThumbprint`
* `ServiceFabricKeyVaultId`
* `ServiceFabricCertificateSecretId`

## Настройка компьютера сборки

### Установка Visual Studio 2015.

Если вы уже подготовили компьютер (или собираетесь использовать свой), установите на нем [Visual Studio 2015](https://www.visualstudio.com/downloads/download-visual-studio-vs.aspx).

Если компьютер еще не подготовлен, вы можете быстро подготовить виртуальную машину Azure с предустановленной средой Visual Studio 2015. Для этого:

1. Войдите на [портал Azure](https://portal.azure.com).

2. Выберите команду **Создать** в левом верхнем углу экрана.

3. Выберите **Marketplace**.

4. Найдите **Visual Studio 2015**.

5. Последовательно выберите **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**.

6. Выберите образ **Visual Studio Enterprise 2015, обновление 1 с пакетом SDK для Azure версии 2.8 на Windows Server 2012 R2**.

    >[AZURE.NOTE] Пакет SDK для Azure — необязательный компонент, но на данный момент нет других доступных образов, в которых установлен только Visual Studio 2015.

7.	Следуйте инструкциям в диалоговом окне, чтобы создать виртуальную машину.

### Установка пакета SDK для Service Fabric

Установите [пакет SDK для Service Fabric](https://azure.microsoft.com/campaigns/service-fabric/) на своем компьютере.

### Установка Azure PowerShell

Чтобы установить Azure PowerShell, выполните шаги, описанные в предыдущем разделе **Установка Azure PowerShell и вход в среду**. Пропустите подраздел **Вход в Azure PowerShell**.

### Регистрация модулей Azure PowerShell с использованием учетной записи локальной службы

>[AZURE.NOTE] Это нужно сделать *до* запуска агента сборки. В противном случае он не получит новую переменную среды.

1. Нажмите клавиши WIN+R, а затем введите **regedit** и нажмите клавишу ВВОД.

2. Щелкните правой кнопкой мыши узел `HKEY_Users\.Default\Environment` и последовательно выберите **Создать > Расширяемый строковый параметр**.

3. Введите `PSModulePath` в качестве имени и `%PROGRAMFILES%\WindowsPowerShell\Modules` в качестве значения. Замените `%PROGRAMFILES%` значением переменной среды `PROGRAMFILES`.

### Импорт сертификата службы автоматизации

1.	Импортируйте сертификат на компьютер сборки. Для этого:

    а. Скопируйте файл PFX, созданный в результате выполнения сценария CreateAndUpload Certificate.ps1, на компьютер сборки.

    b. Откройте командную строку администратора PowerShell и выполните следующие команды, используя тот же пароль, который ранее был передан в `CreateAndUpload-Certificate.ps1`.

        ```
        $password = Read-Host -AsSecureString
        Import-PfxCertificate -FilePath <path/to/cert.pfx> -CertStoreLocation Cert:\LocalMachine\My -Password $password -Exportable
        ```

2.	Запустите диспетчер сертификатов.

    а. Откройте панель управления Windows. Щелкните правой кнопкой мыши кнопку "Пуск" и выберите **Панель управления**.

    b. Найдите **сертификат**.

    c. Последовательно выберите **Администрирование** > **Управление сертификатами компьютеров**.

3.	Предоставьте учетной записи локальной службы разрешение на использование сертификата службы автоматизации.

    а. В разделе **Сертификаты — локальный компьютер** разверните **Личные** и выберите **Сертификаты**.

    b. Найдите сертификат в списке.

    c. Щелкните сертификат правой кнопкой мыши и последовательно выберите **Все задачи** > **Управление закрытыми ключами**.

    г) Нажмите кнопку **Добавить**, а затем введите имя в поле **Локальная служба** и щелкните **Проверить имена**.

    д. Нажмите кнопку **ОК**, а затем закройте диспетчер сертификатов.

![](media/service-fabric-set-up-continuous-integration/windows-certificate-manager.png)

### Регистрация агента сборки

1.	Скачайте архив agent.zip. Для этого:

    а. Перейдите к командному проекту, например ****https://[your-VSTS-account-name].visualstudio.com**.

    b. Щелкните значок шестеренки в правом верхнем углу экрана.

    c. На панели управления выберите вкладку **Пулы агентов**.

    г) Выберите **Скачать агент**, чтобы скачать архив agent.zip.

    д. Скопируйте архив agent.zip на созданный компьютер сборки.

    Е. Распакуйте архив agent.zip в `C:\agent` (или другое расположение с коротким путем) на компьютере сборки.

        >[AZURE.NOTE] If you plan on building ASP.NET 5 Web Services, it's recommended that you  choose the shortest name possible for this folder to avoid running into **PathTooLongExceptions** errors during deployment.

2.	В командной строке с правами администратора выполните `C:\agent\ConfigureAgent.cmd`. Сценарий запросит следующие параметры:

|Параметр|Значение|
|---|---|
|Имя агента|Примите значение по умолчанию `Agent-[machine name]`.|
|URL-адрес TFS|Введите URL-адрес в командном проекте, например `https://[your-VSTS-account-name].visualstudio.com`.|
|Пул агентов|Введите имя пула агентов. (Если вы его еще не создали, примите значение по умолчанию).|
|Рабочая папка|Примите значение по умолчанию. Это папка, в которой агент сборки создаст приложение. Примечание. Если вы планируете сборку веб-служб ASP.NET 5, для этой папки лучше выбрать самое короткое имя, чтобы во время развертывания не возникали ошибки PathTooLongExceptions.|
|Установить в качестве службы Windows?|Значение по умолчанию — N. Измените это значение на **Y**.|
|Учетная запись пользователя для запуска службы|Примите значение по умолчанию `NT AUTHORITY\LocalService`.|
|Отменить настройку существующего агента?|Примите значение по умолчанию **Н**.|

3.  Отобразится запрос на ввод учетных данных. Введите соответствующие данные учетной записи Майкрософт, у которой есть права на работу с командным проектом.

4.  Убедитесь, что агент сборки зарегистрирован. Для этого:

    а. Вернитесь в веб-браузер и обновите страницу, которая должна быть открыта — `https://[your-VSTS-account-name].visualstudio.com/_admin/_AgentPool`.

    b. Выберите пул агентов, выбранный при запуске ConfigureAgent.ps1.

    c. Убедитесь, что агент сборки отображается в списке и его состояние выделено зеленым цветом. Если он выделен красным, в агенте сборки есть проблемы с подключением к Team Services.

![](media/service-fabric-set-up-continuous-integration/vso-configured-agent.png)


## Создание определения сборки

>[AZURE.NOTE] Определение сборки, созданное в результате выполнения этих инструкций, не поддерживает параллельное выполнение сборки даже на разных компьютерах. Это связано с тем, что каждая сборка выполняется для одной и той же группы ресурсов или кластера. Если вам необходимо запустить несколько агентов сборки, во избежание этих помех следующие инструкции и сценарии нужно изменить.

### Добавление сценариев непрерывной интеграции в систему управления версиями для приложения

1.	Извлеките файл [ServiceFabricContinuousIntegrationScripts.zip](https://gallery.technet.microsoft.com/Set-up-continuous-f8b251f6) в любую папку на своем компьютере. Скопируйте содержимое `Powershell\Automation` в любую папку в системе управления версиями.

2.	Зарегистрируйте полученные файлы.

### Создание определения сборки

1.	Создайте пустое определение сборки. Для этого:

    а. Откройте проект в Visual Studio Team Services.

    b. Выберите вкладку **Сборка**.

    c. Щелкните зеленый значок **+**, чтобы создать определение сборки.

    г) Выберите **Пустое** и нажмите кнопку **Далее**.

    д. Убедитесь, что выбраны правильные репозиторий и ветвь.

    Е. Выберите очередь агента, в которой вы зарегистрировали агент сборки, и установите флажок **Непрерывная интеграция**.

2.	На вкладке **Переменные** создайте переменные с такими значениями:

|Переменная|Значение|Секрет|Разрешить во время ожидания|
|---|---|---|---|
|BuildConfiguration|Выпуск||X|
|BuildPlatform|x64|||
|ServicePrincipalPassword|Пароль, который передается в файл CreateServicePrincipal.ps1|X||
|ServicePrincipalId|Из выходных данных CreateServicePrincipal.ps1|||
|ServicePrincipalTenantId|Из выходных данных CreateServicePrincipal.ps1|||
|ServicePrincipalSubscriptionId.|Из выходных данных CreateServicePrincipal.ps1|||
|ServiceFabricCertificateThumbprint|Из выходных данных GenerateCertificate.ps1|||
|ServiceFabricKeyVaultId|Из выходных данных GenerateCertificate.ps1|||
|ServiceFabricCertificateSecretId|Из выходных данных GenerateCertificate.ps1|||
|ServiceFabricClusterName|Любое имя.|||
|ServiceFabricClusterResourceGroupName|Любое имя.|||
|ServiceFabricClusterLocation|Имя, соответствующее расположению хранилища ключей.|||
|ServiceFabricClusterAdminPassword|Любое имя.|X||
|ServiceFabricClusterResourceGroupTemplateFilePath|`<path/to/extracted/automation/scripts/ArmTemplate-Full-3xVM-Secure.json>`|||
|ServiceFabricPublishProfilePath|`<path/to/your/publish/profiles/MyPublishProfile.xml>` Примечание. Конечная точка подключения в профиле публикации будет игнорироваться. Вместо нее будет использоваться конечная точка подключения временного кластера.|||
|ServiceFabricDeploymentScriptPath|`<path/to/Deploy-FabricApplication.ps1>`|||
|ServiceFabricApplicationProjectPath|`<path/to/your/fabric/application/project/folder>` — это должен быть путь к папке, содержащей файл SFPROJ.||||

3.  Сохраните определение сборки и назначьте ему имя. (При необходимости его можно будет изменить.)

### Добавление шага "Сборка"
@<Author GitHub alias> — Просмотрите, пожалуйста, правки к статье и мои вопросы в комментариях, а затем сообщите мне, если я где-нибудь изменил техническое значение.

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2.	Выберите **Сборка** > **MSBuild**.

3.	Выберите значок карандаша возле имени шага сборки и переименуйте его на **Сборка**.

4.	Нажмите кнопку **...** рядом с полем **Решение**, а затем выберите файл SLN.

5.	Введите `$(BuildPlatform)` для параметра **Платформа**.

6.	Введите `$(BuildConfiguration)` для параметра **Конфигурация**.

7.	Установите флажок **Восстановить пакеты NuGet** (если он не установлен).

8.	Сохраните определение сборки.

### Добавление шага "Пакет"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2.	Выберите **Сборка** > **MSBuild**.

3.	Выберите значок карандаша возле имени шага сборки и переименуйте его на **Пакет**.

4.	Нажмите кнопку **...** рядом с полем **Решение** и выберите файл SFPROJ проекта приложения.

5.	Введите `$(BuildPlatform)` для параметра **Платформа**.

6.	Введите `$(BuildConfiguration)` для параметра **Конфигурация**.

7.	Введите `/t:Package` для параметра **Аргументы MSBuild**.

8.	Снимите флажок **Восстановить пакеты NuGet** (если он не снят).

9.	Сохраните определение сборки.

### Добавление шага "Удаление группы ресурсов кластера"

Если после предыдущей сборки не была выполнена очистка (например, если сборка была отменена до очистки), остается группа ресурсов, которая может конфликтовать с новой группой ресурсов. Во избежание конфликтов очистите все оставшиеся группы ресурсов (и связанные ресурсы), прежде чем создать новую группу.

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2.	Выберите **Служебная программа** > **PowerShell**.

3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг в **Удаление группы ресурсов кластера**.

4.	Выберите команду **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **Remove-ClusterResourceGroup.ps1**.

5.	В поле **Аргументы** введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)"`.

6.	Сохраните определение сборки.

### Добавление шага "Подготовка безопасного кластера и развертывание в него"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2.	Выберите **Служебная программа** > **PowerShell**.

3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг в **Подготовка безопасного кластера и развертывание в него**.

4.	Нажмите кнопку **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **ProvisionAndDeploy-SecureCluster.ps1**.

5.	В поле **Аргументы** введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)" -ServiceFabricClusterAdminPassword "$(ServiceFabricClusterAdminPassword)"`.

6.	Сохраните определение сборки.

### Добавление шага "Удаление группы ресурсов кластера"

Теперь, когда временный кластер готов, его следует очистить. Если этого не сделать, и далее будет взиматься плата за временный кластер. Этот шаг позволяет удалить группу ресурсов, в результате чего удаляется кластер и другие ресурсы в группе.

>[AZURE.NOTE] Между этим шагом и предыдущим шагом "Удаление группы ресурсов кластера" существует одного различие: на этом шаге должен быть установлен флажок "Запускать всегда".

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2.	Выберите **Служебная программа** > **PowerShell**.

3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг в **Удаление группы ресурсов кластера**.

4.	Нажмите кнопку **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **RemoveClusterResourceGroup.ps1**.

5.	В поле **Аргументы** введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)`.

6.	В разделе **Параметры управления** установите флажок **Запускать всегда**.

7.	Сохраните определение сборки.

### Попробовать

Щелкните **Поставить сборку в очередь**, чтобы запустить сборку. Сборки также будут активированы после принудительного запуска или возврата.


## Альтернативные решения

Инструкции выше позволяют создать новый кластер для каждой сборки и удалить его по завершении. Чтобы вместо этого в ходе каждой сборки обновлялось приложение (на существующем кластере), выполните следующие шаги.

1.	Создайте тестовый кластер вручную, используя портал Azure или Azure PowerShell. При этом можно использовать сценарий `ProvisionAndDeploy-SecureCluster.ps1` в качестве примера.

2.	Настройте профиль публикации, чтобы он поддерживал обновление приложения. Для этого выполните [следующие инструкции](service-fabric-visualstudio-configure-upgrade.md).

3.	Замените шаг **Подготовка безопасного кластера и развертывание в него** шагом, на котором Deploy-FabricApplication.ps1 вызывается напрямую (и передается в профиль публикации).

4.	Удалите все шаги сборки **Удаление группы ресурсов кластера** из определения сборки.

## Дальнейшие действия

Дополнительные сведения о непрерывной интеграции с приложениями Service Fabric см. в следующих статьях:

- [Домашняя страница документации по сборке](https://msdn.microsoft.com/Library/vs/alm/Build/overview)
- [Развертывание агента построения](https://msdn.microsoft.com/Library/vs/alm/Build/agents/windows)
- [Создание и настройка определения сборки](https://msdn.microsoft.com/Library/vs/alm/Build/vs/define-build)

<!---HONumber=AcomDC_0316_2016-->