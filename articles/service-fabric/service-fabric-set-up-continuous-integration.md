<properties
   pageTitle="Непрерывная интеграция для Service Fabric | Microsoft Azure"
   description="Общие сведения о том, как настроить непрерывную интеграцию для приложения Service Fabric, используя Visual Studio Team Services (VSTS)."
   services="service-fabric"
   documentationCenter="na"
   authors="cawams"
   manager="timlt"
   editor="" />
<tags
   ms.service="multiple"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="multiple"
   ms.date="03/29/2016"
   ms.author="cawa" />

# Настройка непрерывной интеграции для приложения Service Fabric с использованием Visual Studio Team Services

В этой статье подробно описаны действия по настройке непрерывной интеграции для приложения Azure Service Fabric с использованием служб Visual Studio Team Services (VSTS), которые обеспечивают автоматизацию сборки, упаковки и развертывания приложения. Обратите внимание: следуя этим инструкциям, вы каждый раз будете создавать кластер с нуля.

Этот документ описывает текущую процедуру, которая со временем будет изменена.

## Предварительные требования

Чтобы приступить к работе, необходимо выполнить сборку проекта в Visual Studio Team Services.

1. Создайте учетную запись Team Services, используя [учетную запись Майкрософт](http://www.microsoft.com/account), если вы еще не сделали это.

2. Создайте проект в Team Services, используя учетную запись Майкрософт.

3. Добавьте источник нового или существующего приложения Service Fabric в этот проект.

Дополнительные сведения о работе с проектами Team Services см. в разделе [Connect to Visual Studio Team Services](https://www.visualstudio.com/get-started/setup/connect-to-visual-studio-online) (Подключение к Visual Studio Team Services).

## Настройка субъекта-службы

### Настройка проверки подлинности для службы автоматизации

Прежде чем настроить компьютер сборки, создайте [субъект-службу](../resource-group-create-service-principal-portal.md), которую агент сборки будет использовать для проверки подлинности в Azure. Вам также необходимо создать сертификат и передать его в хранилище ключей Azure, так как хранилище ключей не поддерживает проверку подлинности с использованием субъекта-службы. Эти шаги можно выполнить на любом компьютере. Больше всего для этого подходит компьютер разработки.

### Установка Azure PowerShell и вход в среду

1.  Установите PowerShellGet.

    а. Этот шаг можно пропустить, если вы используете Windows 10 с последними обновлениями (PowerShellGet уже установлен).

    b. В противном случае установите платформу [Windows Management Framework 5.0](http://www.microsoft.com/download/details.aspx?id=48729), в состав которой входит PowerShellGet.

2.	Установите и обновите модуль AzureRM. Если установлен модуль Azure PowerShell предыдущих версий, удалите его:

    а. Щелкните правой кнопкой мыши кнопку "Пуск" и выберите **Установка и удаление программ**.

    b. Найдите Azure PowerShell и удалите ее.

    c. Откройте командную строку PowerShell.

    г) Установите модуль AzureRM, используя команду `Install-Module AzureRM`.

    д. Обновите модуль AzureRM, используя команду `Update-AzureRM`.

3.	Отключите или включите сбор данных Azure.

    Командлеты Azure будут запрашивать согласие на принятие или отключение сбора данных, пока вы не сделаете выбор. Эти запросы будут блокировать службу автоматизации, пока пользователь не введет данные. Чтобы отключить эти запросы, сделайте выбор на упреждение, выполнив одну из следующих команд:

    - Enable-AzureRmDataCollection

    - Disable-AzureRmDataCollection

4.	Войдите в Azure PowerShell.

    а. Выполните команду `Login-AzureRmAccount`.

    b. В отобразившемся диалоговом окне введите учетные данные Azure.

    c. Выполните команду `Get-AzureRmSubscription`.

    г) Найдите подписку, которая будет использоваться.

    д. Выполните команду `Select-AzureRmSubscription -SubscriptionId <ID for your subscription>`.

### Создание субъекта-службы

1. Следуйте [этим инструкциям](https://blogs.msdn.microsoft.com/visualstudioalm/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/) для создания субъекта-службы и конечной точки службы для вашего проекта.

2. Обратите внимание на значения, которые печатаются в конце выходных данных скрипта. Они потребуются для настройки определения сборки.

### Создание сертификата и его передача в новое хранилище ключей Azure

>[AZURE.NOTE] В этом примере скрипт создает самозаверяющий сертификат. На практике так делать не стоит, и такой вариант допустим только для эксперимента. Вместо этого следуйте рекомендациям по получению законного сертификата своей организации. Эти инструкции также используют один сертификат для сервера и клиента. В рабочей среде следует применять отдельные сертификаты сервера и клиента.

1. Загрузите и извлеките файл [ServiceFabricContinuousIntegrationScripts.zip](https://gallery.technet.microsoft.com/Set-up-continuous-f8b251f6) в папку на этом компьютере.

2. В командной строке PowerShell перейдите в каталог `<extracted zip>/Manual`.

3. Запустите сценарий PowerShell `CreateAndUpload-Certificate.ps1` со следующими параметрами:

| Параметр | Значение |
| --- | --- |
| KeyVaultLocation | Любое значение. Этот параметр должен соответствовать расположению, в котором планируется создание кластера. |
| CertificateSecretName | Любое значение. |
| CertificateDnsName | Должно соответствовать DNS-имени кластера. Пример: `mycluster.westus.azure.cloudapp.net` |
| SecureCertificatePassword | Любое значение. Этот параметр используется при импорте сертификата на компьютер сборки. |
| KeyVaultResourceGroupName | Любое значение. Тем не менее, не используйте имя группы ресурсов, которую планируете использовать для кластера. |
| KeyVaultName | Любое значение. |
| PfxFileOutputPath| Любое значение. Этот файл используется для импорта сертификата на компьютер сборки. |

После выполнения сценария он выведет следующие три значения. Обратите внимание на эти значения, так как они будут использоваться в качестве переменных сборки:

 - `ServiceFabricCertificateThumbprint`
 - `ServiceFabricKeyVaultId`
 - `ServiceFabricCertificateSecretId`

## Настройка компьютера сборки

### Установка Visual Studio 2015.

Если вы уже подготовили компьютер (или собираетесь использовать свой), установите на нем [Visual Studio 2015](https://www.visualstudio.com/downloads/download-visual-studio-vs.aspx).

Если компьютер еще не подготовлен, вы можете быстро подготовить виртуальную машину Azure с предустановленной средой Visual Studio 2015. Для этого:

1. Войдите на [портал Azure](https://portal.azure.com).

2. В левом верхнем углу экрана выберите команду **Создать**.

3. Выберите **Marketplace**.

4. Найдите **Visual Studio 2015**.

5. Последовательно выберите элементы **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**.

6. Выберите образ **Visual Studio Enterprise 2015, обновление 1 с пакетом SDK для Azure версии 2.8 на Windows Server 2012 R2**.

    >[AZURE.NOTE] Пакет SDK для Azure — необязательный компонент, но на данный момент нет других доступных образов, в которых установлен только Visual Studio 2015.

7.	Следуйте инструкциям в диалоговом окне, чтобы создать виртуальную машину.

### Установка пакета SDK для Service Fabric

Установите [пакет SDK для Service Fabric](https://azure.microsoft.com/campaigns/service-fabric/) на своем компьютере.

### Установка Azure PowerShell

Чтобы установить Azure PowerShell, выполните шаги, описанные в предыдущем разделе "Установка Azure PowerShell и вход в среду". Пропустите шаг "Вход в Azure PowerShell".

### Регистрация модулей Azure PowerShell с использованием учетной записи сетевой службы

>[AZURE.NOTE] Это нужно сделать *перед* запуском агента сборки. В противном случае он не сможет получить новую переменную среды.

1. Нажмите клавиши Windows+R, введите **regedit** и нажмите клавишу ВВОД.

2. Щелкните правой кнопкой мыши узел `HKEY_Users\.Default\Environment` и последовательно выберите **Создать** > **Расширяемый строковый параметр**.

3. Введите `PSModulePath` в качестве имени и `%PROGRAMFILES%\WindowsPowerShell\Modules` в качестве значения. Замените `%PROGRAMFILES%` значением переменной среды `PROGRAMFILES`.

### Импорт сертификата службы автоматизации

1.	Импортируйте сертификат на компьютер сборки. Для этого:

    а. Скопируйте файл PFX, созданный в результате выполнения сценария CreateAndUpload Certificate.ps1, на компьютер сборки.

    b. Откройте командную строку администратора PowerShell и выполните следующие команды, используя тот же пароль, который ранее был передан в `CreateAndUpload-Certificate.ps1`.

        ```
        $password = Read-Host -AsSecureString
        Import-PfxCertificate -FilePath <path/to/cert.pfx> -CertStoreLocation Cert:\LocalMachine\My -Password $password -Exportable
        ```

2.	Запустите диспетчер сертификатов.

    а. Откройте панель управления в Windows. Щелкните правой кнопкой мыши кнопку "Пуск" и выберите **Панель управления**.

    b. Найдите **сертификат**.

    c. Последовательно выберите **Администрирование** > **Управление сертификатами компьютеров**.

3.	Предоставьте учетной записи сетевой службы разрешение на использование сертификата службы автоматизации.

    а. В разделе **Сертификаты — локальный компьютер** разверните узел **Личные** и выберите **Сертификаты**.

    b. Найдите сертификат в списке.

    c. Щелкните сертификат правой кнопкой мыши и последовательно выберите **Все задачи** > **Управление закрытыми ключами**.

    г) Нажмите кнопку **Добавить**, а затем введите имя в поле **Сетевая служба** и выберите **Проверить имена**.

    д. Нажмите кнопку **ОК**, а затем закройте диспетчер сертификатов.

    ![Снимок экрана: шаги для предоставления разрешения учетной записи локальной службы](media/service-fabric-set-up-continuous-integration/windows-certificate-manager.png)

4.  Скопируйте сертификат в папку `Trusted People`.

    а. Ваш сертификат был импортирован в папку **Личные/сертификаты**, но нам нужно добавить его в папку **Доверенные лица**. Щелкните правой кнопкой мыши сертификат и выберите **Копировать**. Щелкните правой кнопкой мыши папку **Доверенные лица** и выберите **Вставить**.

### Регистрация агента сборки

1.	Скачайте архив agent.zip. Для этого:

    а. Перейдите к командному проекту, например ****https://[your-VSTS-account-name].visualstudio.com**.

    b. Щелкните значок шестеренки в правом верхнем углу экрана.

    c. Выберите вкладку **Пулы агентов**.

    г) Выберите **Скачать агент**, чтобы скачать архив agent.zip.

    >[AZURE.NOTE] Если скачивание не начинается, проверьте средство блокирования всплывающих окон.

    д. Скопируйте архив agent.zip на созданный компьютер сборки.

    Е. Распакуйте архив agent.zip в `C:\agent` (или другое расположение с коротким путем) на компьютере сборки.

    >[AZURE.NOTE] Если вы планируете использовать веб-службы ASP.NET 5, для этой папки лучше выбрать самое короткое имя, чтобы во время развертывания не возникали ошибки **PathTooLongExceptions**. После выпуска ASP.NET Core эта проблема будет устранена.

2.	В командной строке с правами администратора выполните `C:\agent\ConfigureAgent.cmd`. Сценарий запросит следующие параметры:

|Параметр|Значение|
|---|---|
|Имя агента|Примите значение по умолчанию `Agent-[machine name]`.|
|URL-адрес TFS|Введите URL-адрес в командном проекте, например `https://[your-VSTS-account-name].visualstudio.com`.|
|Пул агентов|Введите имя пула агентов. (Если вы его еще не создали, примите значение по умолчанию).|
|Рабочая папка|Примите значение по умолчанию. Это папка, в которой агент сборки создаст приложение. Если вы планируете использовать веб-службы ASP.NET 5, для этой папки лучше выбрать самое короткое имя, чтобы во время развертывания не возникали ошибки PathTooLongExceptions.|
|Установить в качестве службы Windows?|Значение по умолчанию — N. Измените это значение на **Y**.|
|Учетная запись пользователя для запуска службы|Примите значение по умолчанию `NT AUTHORITY\NetworkService`.|
|Пароль для `NT AUTHORITY\Network Service`|У учетной записи сетевой службы нет пароля, но пустые пароли будут отклонены. Введите любую непустую строку в качестве пароля (все введенные данные игнорируются).|
|Отменить настройку существующего агента?|Примите значение по умолчанию **Н**.|

3.  Когда появится запрос на ввод учетных данных, введите данные учетной записи Майкрософт с правами доступа к командному проекту.

4.  Убедитесь, что агент сборки был зарегистрирован, и настройте его возможности. Для этого:

    а. Вернитесь в веб-браузер (`https://[your-VSTS-account-name].visualstudio.com/_admin/_AgentPool`) и обновите страницу.

    b. Выберите пул агентов, выбранный при запуске ConfigureAgent.ps1.

    c. Убедитесь, что агент сборки отображается в списке и его состояние выделено зеленым цветом. Если он выделен красным, в агенте сборки есть проблемы с подключением к Team Services.

    ![Снимок экрана: состояние агента сборки](media/service-fabric-set-up-continuous-integration/vso-configured-agent.png)

    г) Выберите агент сборки, а затем вкладку **Возможности**.

    д. Добавьте возможность с именем **azureps** с любым значением. Так службы VSTS поймут, что на этом компьютере установлена среда Azure PowerShell, которая необходима для использования некоторых задач построения, предоставляемых VSTS.


## Создание определения сборки

>[AZURE.NOTE] Определение сборки, созданное в результате выполнения этих инструкций, не поддерживает параллельное выполнение сборки даже на разных компьютерах. Это связано с тем, что каждая сборка выполняется для одной и той же группы ресурсов или кластера. Если вам необходимо запустить несколько агентов сборки, во избежание этих помех следующие инструкции и сценарии нужно изменить.

### Добавление шаблона Azure Resource Manager службы Service Fabric в приложение

1. Скачайте `azuredeploy.json` и `azuredeploy.parameters.json` из [этого примера](https://github.com/Azure/azure-quickstart-templates/tree/master/service-fabric-secure-cluster-5-node-1-nodetype-wad).

2. Откройте `azuredeploy.parameters.json` и измените указанные далее параметры.

    |Параметр|Значение|
    |---|---|
    |clusterLocation|Должно соответствовать расположению хранилища ключей. Пример: `westus`|
    |clusterName|Должно соответствовать DNS-имени сертификата. Например, если DNS-имя сертификата — `mycluster.westus.cloudapp.net`, то `clusterName` должен иметь значение `mycluster`.|
    |adminPassword|Символы 8–123 с по крайней мере 3 из следующих типов символов: прописные буквы, строчные буквы, цифры, специальные символы.|
    |certificateThumbprint|Из выходных данных `CreateAndUpload-Certificate.ps1`|
    |sourceVaultValue|Из выходных данных `CreateAndUpload-Certificate.ps1`|
    |certificateUrlvalue|Из выходных данных `CreateAndUpload-Certificate.ps1`|

3. Добавление новых файлов в систему управления версиями и отправка в VSTS.

### Создание определения сборки

1.	Создайте пустое определение сборки. Для этого:

    а. Откройте проект в Visual Studio Team Services.

    b. Выберите вкладку **Сборка**.

    c. Щелкните зеленый значок **+**, чтобы создать определение сборки.

    г) Щелкните **Пусто**, а затем нажмите кнопку **Далее**.

    д. Убедитесь, что выбраны правильные репозиторий и ветвь.

    Е. Выберите очередь агента, в которой вы зарегистрировали агент сборки, и установите флажок **Непрерывная интеграция**.

2.	На вкладке **Переменные** создайте переменные с такими значениями:

    |Переменная|Значение|Секрет|Разрешить во время ожидания|
    |---|---|---|---|
    |BuildConfiguration|Выпуск||X|
    |BuildPlatform|x64||||

3.  Сохраните определение сборки и назначьте ему имя. (При необходимости его можно будет изменить.)

### Добавление действия "Восстановить пакеты NuGet"

1. На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.

2. Выберите **Пакет** > **Установщик NuGet**.

3. Выберите значок карандаша возле имени шага сборки и переименуйте его на **Восстановление пакетов NuGet**.

4. Нажмите кнопку **...** рядом с полем **Решение**, а затем выберите файл SLN.

5. Сохраните определение сборки.

### Добавление шага "Сборка"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки**.

2.	Выберите **Сборка** > **MSBuild**.

3.	Выберите значок карандаша возле имени шага сборки и переименуйте шаг в **Сборка**.

4. Выберите следующие значения:

    |Имя параметра|Значение|
    |---|---|
    |Решение|Нажмите кнопку **...** и выберите файл `.sln` для решения.|
    |платформа|`$(BuildPlatform)`|
    |Конфигурация|`$(BuildConfiguration)`|

5.	Сохраните определение сборки.

### Добавление шага "Пакет"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки**.

2.	Выберите **Сборка** > **MSBuild**.

3.	Выберите значок карандаша возле имени шага сборки и переименуйте шаг в **Пакет**.

4. Выберите следующие значения:

    |Имя параметра|Значение|
    |---|---|
    |Решение|Нажмите кнопку **...** и выберите файл `.sfproj` проекта приложения.|
    |платформа|`$(BuildPlatform)`|
    |Конфигурация|`$(BuildConfiguration)`|
    |Аргументы MSBuild|`/t:Package`|

5.	Сохраните определение сборки.

### Добавление шага "Удаление группы ресурсов кластера"

Если после предыдущей сборки не выполнена очистка (например, если сборка была отменена до очистки), останется группа ресурсов, которая может конфликтовать с новой группой ресурсов. Во избежание конфликтов удалите все оставшиеся группы ресурсов (и связанные ресурсы), прежде чем создать новую группу.

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки**.

2.	Выберите **Развернуть** > **Развертывание группы ресурсов Azure**.

3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг в **Удаление группы ресурсов кластера**.

4. Выберите следующие значения:

    |Имя параметра|Значение|
    |---|---|
    |AzureConnectionType|**Диспетчер ресурсов Azure**|
    |Подписка Azure RM|Выберите конечную точку подключения, созданную в разделе **Создание субъекта-службы**.|
    |Действие|**Удаление группы ресурсов**|
    |Группа ресурсов|Введите любое неиспользуемое имя. Это же имя необходимо использовать на следующем шаге.|

5.	Сохраните определение сборки.

### Добавление шага "Подготовка безопасного кластера"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки**.

2.	Выберите **Развернуть** > **Развертывание группы ресурсов Azure**.

3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг в **Подготовка безопасного кластера**.

4. Выберите следующие значения:

    |Имя параметра|Значение|
    |---|---|
    |AzureConnectionType|**Диспетчер ресурсов Azure**|
    |Подписка Azure RM|Выберите конечную точку подключения, созданную в разделе **Создание субъекта-службы**.|
    |Действие|**Создание или изменение группы ресурсов**|
    |Группа ресурсов|Должно соответствовать имени, которое использовалось на предыдущем шаге.|
    |Расположение|Должно соответствовать расположению хранилища ключей.|
    |Шаблон|Нажмите кнопку **...** и выберите `azuredeploy.json`.|
    |Параметры шаблона|Нажмите кнопку **...** и выберите `azuredeploy.parameters.json`.|

5.	Сохраните определение сборки.

### Добавить действие "Развертывание"

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки**.

2.	Выберите **Служебная программа** > **PowerShell**.

3.	Выберите значок карандаша возле имени шага сборки и переименуйте шаг в **Развертывание**.

4. Выберите следующие значения:

    |Имя параметра|Значение|
    |---|---|
    |Тип|**Путь к файлу**|
    |Имя файла сценария|Нажмите кнопку **...** и перейдите к каталогу **Сценарии** в проекте приложения. Выберите `Deploy-FabricApplication.ps1`.|
    |Аргументы|`-PublishProfileFile path/to/MySolution/MyApplicationProject/PublishProfiles/MyPublishProfile.xml -ApplicationPackagePath path/to/MySolution/MyApplicationProject/pkg/$(BuildConfiguration)`|

5.	Сохраните определение сборки.

### Попробовать

Щелкните **Поставить сборку в очередь**, чтобы запустить сборку. Сборки также будут активированы после принудительного запуска или возврата.

## Альтернативные решения

Инструкции выше позволяют создать новый кластер для каждой сборки и удалить его по завершении. Чтобы вместо этого в ходе каждой сборки обновлялось приложение (на существующем кластере), выполните следующие шаги.

1.	Создайте тестовый кластер вручную, используя портал Azure или Azure PowerShell и следуя [этим инструкциям](service-fabric-cluster-creation-via-portal.md).

2.	Настройте профиль публикации, чтобы он поддерживал обновление приложения. Для этого выполните [следующие инструкции](service-fabric-visualstudio-configure-upgrade.md).

4.	Удалите шаги сборки **Удаление группы ресурсов кластера** и **Подготовка кластера** из определения сборки.

## Дальнейшие действия

Дополнительные сведения о непрерывной интеграции с приложениями Service Fabric см. в следующих статьях:

 - [Домашняя страница документации по сборке](https://msdn.microsoft.com/Library/vs/alm/Build/overview)
 - [Развертывание агента построения](https://msdn.microsoft.com/Library/vs/alm/Build/agents/windows)
 - [Создание и настройка определения сборки](https://msdn.microsoft.com/Library/vs/alm/Build/vs/define-build)

<!---HONumber=AcomDC_0420_2016-->