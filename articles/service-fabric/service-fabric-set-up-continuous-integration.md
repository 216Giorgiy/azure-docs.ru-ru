<properties
   pageTitle="Непрерывная интеграция для Service Fabric | Microsoft Azure"
   description="Общие сведения о том, как настроить непрерывную интеграцию для приложения Service Fabric, используя Visual Studio Online (VSO)."
   services="service-fabric"
   documentationCenter="na"
   authors="cawa"
   manager="paulyuk"
   editor="" />
<tags
   ms.service="multiple"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="multiple"
   ms.date="10/16/2015"
   ms.author="cawa" />

# Настройка непрерывной интеграции для приложения Service Fabric с использованием Visual Studio Online (VSO)

В этой статье подробно описана настройка непрерывной интеграции для приложения Service Fabric с использованием Visual Studio Online (VSO), а именно автоматические сборка, упаковка и развертывание приложения. Обратите внимание, что в этом документе описаны текущие настройки и в ходе разработки они будут изменены. Кроме того, эти инструкции позволят вам создать кластер с нуля.

## Предварительные требования

Чтобы приступить к работе, необходимо настроить проект в Visual Studio Online.

1. Создайте учетную запись VSO, используя [учетную запись Майкрософт](http://www.microsoft.com/account), если вы еще не сделали этого.
2. Создайте проект в VSO, используя учетную запись Майкрософт.
3. Добавьте источник нового или существующего приложения Service Fabric в этот проект.

Дополнительные сведения о работе с проектами VSO см. в разделе [Подключение к Visual Studio](https://www.visualstudio.com/get-started/setup/connect-to-visual-studio-online).

## Шаги настройки

### Настройка проверки подлинности для службы автоматизации

Прежде чем настроить компьютер сборки, вам необходимо создать субъект-службу, которую служба автоматизации будет использовать для проверки подлинности в Azure. Вам также необходимо создать сертификат и передать его в хранилище ключей, так как хранилище ключей Azure не поддерживает проверку подлинности с использованием субъекта-службы. Эти шаги можно выполнить на любом компьютере. Больше всего для этого подходит компьютер разработки.

### Установка Azure PowerShell и вход в среду

1.	Установите Azure PowerShell.
    - Установите PowerShellGet. Для этого установите платформу [Windows Management Framework 5.0](http://www.microsoft.com/download/details.aspx?id=48729), в состав которой входит PowerShellGet.
    >[AZURE.NOTE]Этот шаг можно пропустить, если вы используете Windows 10 с последними обновлениями.

1.	Установите и обновите модуль AzureRM.
    1.  Если установлена Azure PowerShell предыдущих версий, удалите ее. Щелкните правой кнопкой мыши кнопку «Пуск» и выберите «Установка и удаление программ». Найдите Azure PowerShell и удалите ее.
    1.  Запустите командную строку PowerShell.
    1.	Установите модуль AzureRM, используя команду `Install-Module AzureRM`.
    1.	Обновите модуль AzureRM, используя команду `Update-AzureRM`.
1.	Отключите или включите сбор данных Azure.

    Командлеты Azure будут запрашивать согласие на принятие или отключение сбора данных, пока вы не сделаете выбор. Эти запросы будут блокировать службу автоматизации, пока пользователь не введет данные. Чтобы подавить эти запросы и сделать выбор заранее, выполните одну из следующих команд:

    - Enable-AzureRmDataCollection
    - Disable-AzureRmDataCollection

1.	Войдите в Azure PowerShell.
    1. Запустите командную строку PowerShell, используя учетные данные администратора, и выполните команду `Login-AzureRMAccount`.
    1. В отобразившемся диалоговом окне введите учетные данные Azure.
    1. Выполните команду `Get-AzureRmSubscription`.
    1. Найдите подписку, которую нужно использовать, а затем выполните команду `Select-AzureRmSubscription -SubscriptionId <id for your subscription>`.

### Создание субъекта-службы

1.	Извлеките архив [ServiceFabricCIManualScripts.zip](http://go.microsoft.com/fwlink/?LinkId=703773) в папку на этом компьютере.
1.	В командной строке PowerShell с правами администратора измените каталог на тот, в который извлечен архив ServiceFabricCIManualScripts.zip.
1.	Выберите пароль для субъекта-службы, используя следующую команду. Запомните этот пароль, так как он будет использоваться как переменная сборки.

    ```
    $password = Read-Host -AsSecureString
    ```
1.	Запустите сценарий PowerShell Create-ServicePrincipal.ps1, используя следующие параметры:

    |Параметр|Значение|
    |---|---|
    |ServicePrincipalDisplayName|Любое имя.|
    |ServicePrincipalHomePage|Любой универсальный код ресурса. Не должен существовать на самом деле.|
    |ServicePrincipalIdentifierUri|Любой уникальный универсальный код ресурса. Не должен существовать на самом деле.|
    |ServicePrincipalSecurePassword|$password|

    После выполнения сценария он выведет следующие три значения. Обратите внимание на значения, так как они будут использоваться в качестве переменных сборки:

    - ServicePrincipalId
    - ServicePrincipalTenantId
    - ServicePrincipalSubscriptionId.

### Создание сертификата и его передача в новое хранилище ключей Azure

1.	В командной строке PowerShell с правами администратора измените каталог на тот, в который извлечен архив ServiceFabricCIManualScripts.zip.
1.	Запустите сценарий PowerShell CreateAndUpload-Certificate.ps1, используя следующие параметры:

    |Параметр|Значение|
    |---|---|
    |ServiceFabricKeyVaultLocation|Любое значение. Оно должно соответствовать расположению, в котором планируется создание кластера.|
    |ServiceFabricCertificateSecretName|Любое значение.|
    |ServiceFabricSecureCertificatePassword|Любое значение. Используется при импорте сертификата на компьютер сборки.|
    |ServiceFabricKeyVaultResourceGroupName|Любое значение. Тем не менее, не используйте имя группы ресурсов, которую планируете использовать для кластера.|
    |ServiceFabricKeyVaultName|Любое значение.|
    |ServiceFabricPfxFileOutputPath|Любое значение. Этот файл используется для импорта сертификата на компьютер сборки.|

    После выполнения сценария он выведет следующие три значения. Обратите внимание на эти значения, так как они будут использоваться в качестве переменных сборки:

    - ServiceFabricCertificateThumbprint
    - ServiceFabricKeyVaultId
    - ServiceFabricCertificateSecretId


## Настройка компьютера сборки

Обратите внимание, что определение сборки, созданное в результате выполнения этих инструкций, не поддерживает параллельное выполнение сборки даже на разных компьютерах. (Это связано с тем, что сборка выполняется для одной и той же группы ресурсов или кластера.) Если вам необходимо запустить несколько агентов сборки, во избежание этих помех следующие инструкции и сценарии нужно изменить.

### Установка Visual Studio 2015.

1.	Если вы уже подготовили компьютер (или собираетесь использовать свой), установите на нем [Visual Studio 2015](https://www.visualstudio.com/downloads/download-visual-studio-vs.aspx).
2.	Если компьютер еще не подготовлен, можно быстро подготовить виртуальную машину Azure с предустановленной средой Visual Studio 2015. Для этого:
    1.	Выполните вход на [портал управления Azure](http://portal.azure.com).
    1.	Выберите команду **Создать** в левом верхнем углу экрана.
    1.	Выберите **Marketplace**.
    1.	Найдите **Visual Studio 2015**.
    1.	Последовательно выберите **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**.
    1.	Выберите образ **Visual Studio Enterprise 2015 с пакетом SDK для Azure 2.7 на Windows Server 2012 R2**.

        >[AZURE.NOTE]Пакет SDK для Azure — необязательный компонент, но больше нет доступных образов с установленной Visual Studio 2015.

    1.	Следуйте инструкциям в диалоговом окне, чтобы создать виртуальную машину. (Рекомендуется выбрать виртуальную машину серии D, чтобы добиться максимальной производительности диска и ЦП.)

### Установка пакета SDK для Service Fabric

Установите [пакет SDK для Service Fabric](https://azure.microsoft.com/ru-RU/campaigns/service-fabric/).

### Регистрация репозитория NuGet пакета SDK для Service Fabric

1.	Создайте каталог `%SYSTEMDRIVE%\Windows\ServiceProfiles\LocalService\AppData\Roaming\NuGet` на компьютере сборки (если еще не создали).
2.	Если в этом каталоге уже существует файл NuGet.config, откройте его и добавьте следующий элемент в качестве дочернего элемента `<packageSources>`:

    ```
    <add key="Service Fabric SDK" value="<path to service fabric SDK>\packages" />`
    ```

3.	Если еще нет файла NuGet.config, создайте его со следующим содержимым. На компьютере сборки замените `<path to service fabric SDK>` на путь к пакету SDK для Service Fabric.
>[AZURE.NOTE]По умолчанию `<path to service fabric SDK>` — `%ProgramFiles%\Microsoft SDKs\Service Fabric`.

    NuGet.config:

    ```
    <?xml version="1.0" encoding="utf-8"?>
    <configuration>
      <packageSources>
        <!-- Add this repository to the list of available repositories -->
        <add key="Service Fabric SDK" value="<path to service fabric SDK>\packages" />
      </packageSources>
    </configuration>
    ```

### Установка Azure PowerShell

Чтобы установить Azure PowerShell, выполните шаги, описанные в предыдущем разделе **Установка Azure PowerShell и вход в среду**. Пропустите подраздел **Вход в Azure PowerShell**.

### Регистрация модулей Azure PowerShell с использованием учетной записи локальной службы

1. Нажмите клавиши WIN+R, а затем введите **regedit** и нажмите клавишу ВВОД.
2. Щелкните правой кнопкой мыши узел `HKEY_Users\.Default\Environment` и последовательно выберите **Создать > Расширяемый строковый параметр**.
3. Введите `PSModulePath` в качестве имени и `%PROGRAMFILES%\WindowsPowerShell\Modules` в качестве значения.

>[AZURE.NOTE]Это нужно сделать *до* запуска агента сборки. В противном случае он не получит новую переменную среды.

### Импорт сертификата службы автоматизации

1.	Импортируйте сертификат на компьютер сборки. Для этого:
    1. Скопируйте файл PFX, созданный в результате выполнения сценария CreateAndUpload Certificate.ps1, на компьютер сборки.
    1. Откройте учетную запись администратора PowerShell и выполните следующие команды, используя тот же пароль, что и для GenerateCertificate.ps1.

        ```
        $password = Read-Host -AsSecureString
        Import-PfxCertificate -FilePath <path/to/cert.pfx> -CertStoreLocation Cert:\LocalMachine\My -Password $password -Exportable
        ```  

1.	Запустите диспетчер сертификатов.
    1. Откройте панель управления Windows. Щелкните правой кнопкой мыши кнопку «Пуск» и выберите **Панель управления**.
    1. Найдите **сертификат**.
    1. Последовательно выберите **Администрирование** > **Управление сертификатами компьютеров**.


1.	Предоставьте учетной записи локальной службы разрешение на использование сертификата службы автоматизации.
    1.	В разделе **Сертификаты — локальный компьютер** разверните **Личные** и выберите **Сертификаты**.
    1.	Найдите сертификат в списке.
    1.	Щелкните сертификат правой кнопкой мыши и последовательно выберите **Все задачи** > **Управление закрытыми ключами**.
    1.	Нажмите кнопку **Добавить**, а затем введите имя в поле **Локальная служба** и выберите **Проверить имена**.
    1.	Нажмите кнопку **ОК**, а затем закройте диспетчер сертификатов.

![](media/service-fabric-set-up-continuous-integration/windows-certificate-manager.png)

### Регистрация агента сборки

1.	Скачайте архив agent.zip. Для этого:
    1.	Перейдите к командному проекту, такому как ****https://[your-VSO-account-name].visualstudio.com**.
1.	Щелкните значок шестеренки в правом верхнем углу экрана.
    1.	На панели управления выберите вкладку **Пулы агентов**.
    1.	Выберите **Скачать агент**, чтобы скачать архив agent.zip.
    1.	Скопируйте архив agent.zip на созданный компьютер сборки.
    1.	Распакуйте архив agent.zip в `C:\agent` (или другое расположение с коротким путем) на компьютере сборки.

        >[AZURE.NOTE]Если вы планируете сборку веб-служб ASP.NET 5, для этой папки лучше выбрать самое короткое имя, чтобы во время развертывания не возникали ошибки **PathTooLongExceptions**.

1.	Из командной строки PowerShell с правами администратора запустите `C:\agent\ConfigureAgent.ps1`. Сценарий запросит следующие параметры:

    |Параметр|Значение|
    |---|---|
    |Имя агента|Примите значение по умолчанию `Agent-[machine name]`.
    |URL-адрес TFS|Введите URL-адрес в командном проекте, такой как `https://[your-VSO-account-name].visualstudio.com`.
    |Пул агентов|Введите имя пула агентов. (Если вы его еще не создали, примите значение по умолчанию).|
    |Рабочая папка|Примите значение по умолчанию. Это папка, в которой агент сборки создаст приложение. Примечание. Если вы планируете сборку веб-служб ASP.NET 5, для этой папки лучше выбрать самое короткое имя, чтобы во время развертывания не возникали ошибки PathTooLongExceptions.|
    |Установить в качестве службы Windows?|Значение по умолчанию: «Н». Измените значение на «Д».|
    |Учетная запись пользователя для запуска службы|Примите значение по умолчанию `NT AUTHORITY\LocalService)`.|
    |Отменить настройку существующего агента?|Примите значение по умолчанию **Н**.|

1. Отобразится запрос на ввод учетных данных. Введите соответствующие данные учетной записи Майкрософт, у которой есть права на работу с командным проектом.
1. Убедитесь, что агент сборки зарегистрирован. Для этого:

    1. Вернитесь в веб-браузер (должен находиться на странице `https://[your-VSO-account-name].visualstudio.com/_admin/_AgentPool`), а затем обновите страницу.
    1. Выберите пул агентов, выбранный при запуске ConfigureAgent.ps1.
    1. Убедитесь, что агент сборки отображается в списке и его состояние выделено зеленым цветом. Если он выделен красным, в агенте сборки есть проблемы с подключением к VSO.

![](media/service-fabric-set-up-continuous-integration/vso-configured-agent.png)


## Настройка определения сборки

### Добавьте сценарии непрерывной интеграции в систему управления версиями для приложения.

1.	Извлеките архив [ServiceFabricCIAutomationScripts.zip](http://go.microsoft.com/fwlink/?LinkId=703775) в любую папку в системе управления версиями.
1.	Зарегистрируйте полученные файлы.

### Создание определения сборки

1.	Создайте пустое определение сборки. Для этого:
    1.	Откройте проект в Visual Studio Online.
    1.	Выберите вкладку **Сборка**.
    1.	Щелкните зеленый значок **+**, чтобы создать определение сборки.
    1.	Выберите **Пустое** и нажмите кнопку **Далее**.
    1.  Убедитесь, что выбраны правильные репозиторий и ветвь.
    1.  Выберите очередь агента, в которой вы зарегистрировали агент сборки, и установите флажок **Непрерывная интеграция**.
1.	На вкладке **Переменные** создайте переменные с такими значениями:

    |Переменная|Значение|Секрет|Разрешить во время ожидания|
    |---|---|---|---|
    |BuildConfiguration|Выпуск||X|
    |BuildPlatform|x64|||
    |ServicePrincipalPassword|Пароль, который передается в файл CreateServicePrincipal.ps1|X||
    |ServicePrincipalId|Из выходных данных CreateServicePrincipal.ps1|||
    |ServicePrincipalTenantId|Из выходных данных CreateServicePrincipal.ps1|||
    |ServicePrincipalSubscriptionId.|Из выходных данных CreateServicePrincipal.ps1|||
    |ServiceFabricCertificateThumbprint|Из выходных данных GenerateCertificate.ps1|||
    |ServiceFabricKeyVaultId|Из выходных данных GenerateCertificate.ps1|||
    |ServiceFabricCertificateSecretId|Из выходных данных GenerateCertificate.ps1|||
    |ServiceFabricClusterResourceGroupName|Любое имя.|||
    |ServiceFabricClusterName|Любое имя.|||
    |ServiceFabricClusterLocation|Имя, соответствующее расположению хранилища ключей.|||
    |ServiceFabricClusterAdminPassword|Любое имя.|X||
    |ServiceFabricClusterResourceGroupTemplateFilePath|`<path/to/extracted/automation/scripts/ArmTemplate-Full-3xVM-Secure.json>`|||
    |ServiceFabricPublishProfilePath|`<path/to/your/publish/profiles/MyPublishProfile.xml>` Примечание. Конечная точка подключения в профиле публикации будет игнорироваться. Вместо нее будет использоваться конечная точка подключения временного кластера.|||
    |ServiceFabricDeploymentScriptPath|`<path/to/Deploy-FabricApplication.ps1>`|||
    |ServiceFabricApplicationProjectPath|`<path/to/your/fabric/application/project/folder>` — это должен быть путь к папке, содержащей файл SFPROJ.||||

1.	На вкладке **Триггеры** выберите параметры **Непрерывная интеграция** и **Пакетные изменения**.
1.	На вкладке **Общие** выберите очередь, в которой зарегистрированы агенты сборки.
1.	Сохраните определение сборки и назначьте ему имя. (При необходимости его можно будет изменить.)

### Добавление шага «Сборка»

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.
2.	Выберите **Сборка** > **MSBuild**.
3.	Выберите значок карандаша возле имени шага сборки и переименуйте его на **Сборка**.
4.	Нажмите кнопку **...** рядом с полем **Решение**, а затем выберите файл SLN.
5.	Введите `$(BuildPlatform)` для параметра **Платформа**.
6.	Введите `$(BuildConfiguration)` для параметра **Конфигурация**.
7.	Установите флажок **Восстановить пакеты NuGet** (если он не установлен).
8.	Сохраните определение сборки.

### Добавление шага «Пакет»

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.
2.	Выберите **Сборка** > **MSBuild**.
3.	Выберите значок карандаша возле имени шага сборки и переименуйте его на **Пакет**.
4.	Нажмите кнопку **...** рядом с полем **Решение**, а затем выберите файл SFPROJ проекта приложения.
5.	Введите `$(BuildPlatform)` для параметра **Платформа**.
6.	Введите `$(BuildConfiguration)` для параметра **Конфигурация**.
7.	Введите `/t:Package` для параметра **Аргументы MSBuild**.
8.	Снимите флажок **Восстановить пакеты NuGet** (если он не снят).
9.	Сохраните определение сборки.

### Добавление шага «Удаление группы ресурсов кластера»

Если файлы предыдущей сборки не очищены (например, если сборку отменили до очистки), могла остаться группа ресурсов, которая будет конфликтовать с новой группой ресурсов. Во избежание конфликтов очистите все оставшиеся группы ресурсов (и связанные ресурсы), прежде чем создать новую группу.

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.
2.	Выберите **Служебная программа** > **PowerShell**.
3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг на **Удаление группы ресурсов кластера**.
4.	Выберите команду **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **Remove-ClusterResourceGroup.ps1**.
5.	В поле **Аргументы** введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)"`.
6.	Сохраните определение сборки.

### Добавление шага «Подготовка безопасного кластера и развертывание в него»

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.
2.	Выберите **Служебная программа** > **PowerShell**.
3.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг на **Подготовка безопасного кластера и развертывание в него**.
4.	Нажмите кнопку **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **ProvisionAndDeploy-SecureCluster.ps1**.
5.	В поле «Аргументы» введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)" -ServiceFabricClusterAdminPassword "$(ServiceFabricClusterAdminPassword)"`
6.	Сохраните определение сборки.

### Добавление шага «Удаление группы ресурсов кластера»

Теперь, когда временный кластер готов, его следует очистить. Если этого не сделать, и далее будет взиматься плата за временный кластер. Этот шаг позволяет удалить группу ресурсов, в результате чего удаляется кластер и другие ресурсы в группе.

1.	На вкладке **Сборка** выберите команду **Добавить шаг сборки...**.
1.	Выберите **Служебная программа** > **PowerShell**.
1.	Щелкните значок карандаша возле имени шага сборки, а затем переименуйте шаг на **Удаление группы ресурсов кластера**.
1.	Нажмите кнопку **...** рядом с полем **Имя файла сценария**. Перейдите в расположение, в которое извлекли сценарии службы автоматизации, а затем выберите **RemoveClusterResourceGroup.ps1**.
1.	В поле «Аргументы» введите `-ServicePrincipalPassword "$(ServicePrincipalPassword)`.
1.	В разделе **Параметры управления** установите флажок **Всегда запускать**.
1.	Сохраните определение сборки.

### Тестирование

Выберите команду **Поставить сборку в очередь**, чтобы запустить сборку. Сборки также будут активированы после возврата.


## Альтернативные решения

Инструкции выше позволяют создать новый кластер для каждой сборки и удалить его по завершении. Если вместо этого нужно, чтобы в рамках каждой сборки обновлялось приложение (в соответствии с существующим кластером), выполните следующие шаги.

1.	Создайте тестовый кластер вручную, используя портал управления Azure или Azure PowerShell. Для справки можно использовать сценарий ProvisionAndDeploy-SecureCluster.ps1.
1.	Настройте профиль публикации, чтобы он поддерживал обновление приложения. Для этого выполните [следующие инструкции](service-fabric-visualstudio-configure-upgrade.md).

1.	Замените шаг **Подготовка безопасного кластера и развертывание в него** шагом, на котором Deploy-FabricApplication.ps1 вызывается напрямую (и передается в профиль публикации).
1.	Удалите все шаги сборки **Удаление группы ресурсов кластера** из определения сборки.

## Дальнейшие действия

Дополнительные сведения о непрерывной интеграции с приложениями Service Fabric: [Домашняя страница документации по сборке](https://msdn.microsoft.com/Library/vs/alm/Build/overview); [Развертывание агента сборки](https://msdn.microsoft.com/Library/vs/alm/Build/agents/windows); [Создание и настройка определения сборки](https://msdn.microsoft.com/Library/vs/alm/Build/vs/define-build).

<!---HONumber=Nov15_HO4-->