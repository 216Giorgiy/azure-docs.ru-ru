<properties
   pageTitle="Создание локального или универсального облачного кластера Azure Service Fabric | Microsoft Azure"
   description="Узнайте, как создать кластер Azure Service Fabric на любом компьютере (физическом или виртуальном) под управлением Windows Server, расположенном в локальной системе или в любом облаке."
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="07/05/2016"
   ms.author="chackdan"/>


# Создание кластера под управлением Windows Server

Azure Service Fabric позволяет создавать кластеры Service Fabric на любых виртуальных машинах или компьютерах под управлением Windows Server. Это означает, что вы сможете разворачивать и запускать приложения Service Fabric в любой среде с набором подключенных друг к другу компьютеров под управлением Windows Server как локально, так и у любого поставщика облачных служб. Service Fabric предоставляет установочный пакет для создания кластеров Service Fabric, который называется изолированным пакетом Windows Server.

В этой статье подробно рассматривается создание кластера с использованием изолированного пакета для локальной версии Service Fabric, хотя эту процедуру легко адаптировать к любой среде, в том числе к облачным службам других поставщиков.

>[AZURE.NOTE] Этот изолированный пакет Windows Server сейчас доступен в виде предварительной версии. Его использование не поддерживается для рабочих нагрузок. [Щелкните здесь](http://go.microsoft.com/fwlink/?LinkID=733084), если хотите скачать копию лицензионного соглашения.

<a id="downloadpackage"></a>
## Загрузка изолированного пакета Service Fabric


[Скачайте изолированный пакет для Service Fabric для Windows Server 2012 R2 и более поздней версии](http://go.microsoft.com/fwlink/?LinkId=730690) с именем *Microsoft.Azure.ServiceFabric.WindowsServer.&lt;version&gt;.zip*.

В скачиваемом пакете вы найдете следующие файлы.

|**Имя файла**|**Краткое описание**|
|-----------------------|--------------------------|
|MicrosoftAzureServiceFabric.cab|CAB-файл, содержащий двоичные файлы, которые развертываются на каждом компьютере в кластере.|
|ClusterConfig.Unsecure.DevCluster.json|Пример файла конфигурации кластера, содержащий параметры незащищенного кластера разработки с тремя узлами и одной виртуальной машиной или компьютером, в том числе сведения о каждом узле, который является частью кластера. |
|ClusterConfig.Unsecure.MultiMachine.json|Пример файла конфигурации кластера, содержащий параметры незащищенного кластера с несколькими виртуальными машинами или компьютерами, в том числе сведения о каждом компьютере, который находится в кластере.|
|ClusterConfig.Windows.DevCluster.json|Пример файла конфигурации кластера, содержащий все параметры защищенного кластера разработки с тремя узлами и одной виртуальной машиной или компьютером, в том числе сведения о каждом узле, который является частью кластера. Этот кластер защищен с помощью [удостоверений Windows](https://msdn.microsoft.com/library/ff649396.aspx).|
|ClusterConfig.Windows.MultiMachine.json|Пример файла конфигурации кластера, который содержит все параметры кластера, защищенного с помощью системы безопасности Windows, с несколькими виртуальными машинами или компьютерами, в том числе сведения о каждом компьютере, который находится в защищенном кластере. Этот кластер защищен с помощью [удостоверений Windows](https://msdn.microsoft.com/library/ff649396.aspx).|
|ClusterConfig.x509.DevCluster.json|Пример файла конфигурации кластера, содержащий все параметры защищенного кластера разработки с тремя узлами и одной виртуальной машиной или компьютером, в том числе сведения о каждом узле, который находится в кластере. Этот кластер защищен с помощью сертификатов x.509.|
|ClusterConfig.x509.MultiMachine.json|Пример файла конфигурации кластера, содержащий все параметры защищенного кластера разработки с несколькими виртуальными машинами или компьютерами, в том числе сведения о каждом узле, который находится в защищенном кластере. Этот кластер защищен с помощью сертификатов x.509.|
|EULA.txt|Условия лицензии на использование изолированного пакета Windows Server Microsoft Azure Service Fabric. [Щелкните здесь](http://go.microsoft.com/fwlink/?LinkID=733084), если хотите скачать копию лицензионного соглашения.|
|Readme.txt|Ссылка на заметки о выпуске и инструкции по стандартной установке. На этой странице вы найдете набор инструкций.|
|CreateServiceFabricCluster.ps1|Сценарий PowerShell, который создает кластер, используя параметры в файле ClusterConfig.json.|
|RemoveServiceFabricCluster.ps1|Сценарий PowerShell, который удаляет кластер, используя параметры в файле ClusterConfig.json.|
|AddNode.ps1|Сценарий PowerShell, который добавляет узел в имеющийся развернутый кластер.|
|RemoveNode.ps1|Сценарий PowerShell, который удаляет узел из имеющегося развернутого кластера.|


## Планирование и подготовка развертывания кластера
Перед созданием кластера нужно выполнить следующие действия.

### Шаг 1. Планирование инфраструктуры кластера
Вы собираетесь создать кластер Service Fabric на принадлежащих вам компьютерах, поэтому вам нужно решить, к каким сбоям должен быть устойчив кластер. Например, нужны ли отдельные линии электропитания или подключения к Интернету для этих компьютеров? Кроме того, следует также учитывать физическую безопасность этих компьютеров. Где они расположены и кому нужен доступ к ним? После принятия этих решений следует логически сопоставить компьютеры с различными доменами сбоя (ниже приведены дополнительные сведения). Планирование инфраструктуры рабочих кластеров потребует больше усилий, чем для тестовых кластеров.

### Шаг 2. Подготовка компьютеров для соблюдения предварительных требований
Предварительные требования к каждому компьютеру, который требуется добавить в кластер.

- Рекомендуется не менее 2 ГБ памяти.
- Сетевое подключение. Убедитесь, что эти компьютеры находятся в защищенной сети или сетях.
- Windows Server 2012 R2 или Windows Server 2012 (для этой версии необходимо установить исправление KB2858668).
- Полностью установленная платформа .NET Framework 4.5.1 или более поздней версии.
- Windows PowerShell 3.0.
- У администратора кластера, который развертывает и настраивает кластер, должны быть привилегии администратора на всех компьютерах.
- На всех компьютерах должна быть запущена служба RemoteRegistry.

### Шаг 3. Определение исходного размера кластера
Каждый узел является частью кластера, и на нем развернута среда выполнения Service Fabric. В типичном рабочем развертывании используется один узел на экземпляр ОС (физический или виртуальный). Размер кластера определяется потребностями бизнеса. Тем не менее размер кластера не должен быть меньше минимального, равного трем узлам (это могут быть компьютеры или виртуальные машины). Обратите внимание, что в целях разработки на одном компьютере можно настроить более одного узла. В рабочей среде Service Fabric поддерживает только один узел на физический компьютер или виртуальную машину.

### Шаг 4. Определение количества доменов сбоя и доменов обновления
**Домен сбоя** — это физическая единица сбоя, непосредственно связанная с физической инфраструктурой в центрах обработки данных. Домен сбоя состоит из аппаратных компонентов (компьютеры, коммутаторы, сеть и многое другое), совместно использующих единую точку отказа. Хотя нет однозначного соответствия между доменами сбоя и стойками, грубо говоря, каждую стойку можно считать доменом сбоя. При выборе узлов в кластере настоятельно рекомендуется распределить узлы по крайней мере на три домена сбоя.

При указании доменов сбоя в файле *ClusterConfig.json* необходимо выбрать имя для каждого из них. Service Fabric поддерживает иерархические домены сбоя, поэтому в них можно отразить имеющуюся топологию инфраструктуры. Например, допускаются следующие домены сбоя.

- "faultDomain": "fd:/Room1/Rack1/Machine1"
- "faultDomain": "fd:/FD1"
- "faultDomain": "fd:/Room1/Rack1/PDU1/M1"


**Домен обновления** — это логическая единица узлов. Во время обновления под управлением Service Fabric (обновления приложения или кластера) все узлы в домене обновления отключаются, а узлы в других доменах обновления остаются доступными для обслуживания запросов. Обновления встроенного ПО, выполняемые на компьютерах, не связаны с работой доменов обновления, поэтому их необходимо выполнять на компьютерах по очереди.

Проще всего рассматривать эти понятия, считая домен сбоя единицей незапланированного сбоя, а домен обновления — единицей планового обслуживания.

При указании доменов обновления в файле *ClusterConfig.json* необходимо выбрать имя для каждого из них. Например, допускается следующее.

- "upgradeDomain": "UD0"
- "upgradeDomain": "UD1A"
- "upgradeDomain": "DomainRed"
- "upgradeDomain": "Blue"

Дополнительные сведения о доменах обновления и доменах сбоя см. в статье [Описание кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).

### Шаг 5. Скачивание изолированного пакета Service Fabric для Windows Server
[Скачайте изолированный пакет Service Fabric для Windows Server](http://go.microsoft.com/fwlink/?LinkId=730690) и извлеките его содержимое на компьютер развертывания, который не является частью кластера, или на один из компьютеров, который будет частью кластера.

<a id="createcluster"></a>
## Создание кластера

Выполнив шаги, описанные в предыдущем разделе о планировании и подготовке, вы готовы к созданию кластера.

### Шаг 1. Изменение конфигурации кластера
Кластер описан в файле *ClusterConfig.json*. Сведения о разделах в этом файле см. в статье [Параметры конфигурации для автономного кластера Windows](service-fabric-cluster-manifest.md). Откройте один из файлов *ClusterConfig.json* из скачанного пакета и настройте следующие параметры.

|**Параметр конфигурации**|**Описание**|
|-----------------------|--------------------------|
|**NodeTypes**|Типы узлов позволяют разделить узлы кластера на различные группы. У кластера должен быть по крайней мере один NodeType. Все узлы в группе имеют следующие общие характеристики. <br> **Name** — имя типа узла. <br>**Endpoints Ports** — различные именованные конечные точки (порты), связанные с этим типом узла. Вы можете использовать любой номер порта на свой выбор, если он не конфликтует ни с одним из параметров в этом манифесте и не используется другим приложением, запущенным на компьютере или виртуальной машине. <br> **Placement Properties** — свойства данного типа узла, которые можно будет использовать как ограничения размещения для системных или ваших служб. Это свойства представляют собой определяемые пользователем пары "ключ-значение", которые содержат дополнительные метаданные для заданного узла. К свойствам узла относится, например, наличие у него жесткого диска или видеоадаптера, количество шпинделей в его жестком диске, число ядер и другие физические качества. <br> **Capacities** — емкость узла определяет имя и величину конкретного ресурса, доступного для использования на определенном узле. Например, для узла может быть определена емкость для метрики MemoryInMb и выделено 2048 МБ памяти, доступной по умолчанию. Емкости используются во время выполнения функций, чтобы гарантировать, что службы, которым требуется определенный объем ресурсов, будут размещены на узлах, обладающими такими ресурсами.<br>**IsPrimary** — при наличии нескольких определенных параметров NodeType задайте значение *true* только для одного узла (основного), который находится там, где выполняются системные службы. Узлам всех остальных типов необходимо присвоить значение *false*.|
|**Nodes**|Сведения о каждом из узлов, которые являются частью кластера (тип узла, имя узла, IP-адрес, домен сбоя и домен обновления узла). В этом разделе необходимо перечислить компьютеры, на основе которых вы хотите создать кластер, и их IP-адреса. <br> Если использовать одинаковые IP-адреса для всех узлов, то будет создан универсальный кластер, который можно использовать для тестирования. Универсальные кластеры не должны использоваться для развертывания рабочих нагрузок в рабочей среде.|

### Шаг 2. Выполнение сценария создания кластера
Изменив конфигурацию кластера в документе JSON и добавив все сведения об узлах, в папке пакета выполните сценарий PowerShell *CreateServiceFabricCluster.ps1* для создания кластера и передайте в него путь к файлу конфигурации JSON и расположение CAB-файла пакета.

Этот сценарий может выполняться на любом компьютере, у которого есть доступ администратора ко всем компьютерам, перечисленным в качестве узлов в файле конфигурации кластера. Компьютер, на котором выполняется этот сценарий, может и не входить в кластер.

```
#Create an unsecure local development cluster

.\CreateServiceFabricCluster.ps1 -ClusterConfigFilePath .\ClusterConfig.Unsecure.DevCluster.json -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab -AcceptEULA $true
```
```
#Create an unsecure multi-machine cluster

.\CreateServiceFabricCluster.ps1 -ClusterConfigFilePath .\ClusterConfig.Unsecure.MultiMachine.json -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab -AcceptEULA $true
```

>[AZURE.NOTE] Журналы развертывания доступны локально на виртуальной машине или компьютере, на котором был выполнен сценарий PowerShell CreateServiceFabricCluster. Они будут доступны во вложенной папке DeploymentTraces, которая расположена в папке, где была выполнена команда PowerShell. Кроме того, чтобы просмотреть, правильно ли развернута служба Service Fabric на компьютере, можно найти установленные файлы в каталоге C:\\ProgramData. Просмотреть выполняемые процессы FabricHost.exe и Fabric.exe можно в диспетчере задач.

### Шаг 3. Подключение к кластеру
Теперь к кластеру можно подключиться при помощи Service Fabric Explorer непосредственно с одного из компьютеров с помощью http://localhost:19080/Explorer/index.html или удаленно с помощью http://<*IPAddressofaMachine*>: 19080/Explorer/index.html.

## Добавление узлов в кластер

1. Подготовьте виртуальную машину или компьютер, который необходимо добавить в кластер (см. шаг 2 в разделе "Планирование и подготовка развертывания кластера" выше).
2. Подумайте, в какой домен сбоя и домен обновления нужно добавить эту виртуальную машину или компьютер.
3. Скопируйте или [скачайте изолированный пакет для Service Fabric для Windows Server](http://go.microsoft.com/fwlink/?LinkId=730690) и извлеките его содержимое на виртуальную машину или компьютер, который планируете добавить в кластер.
4. Откройте командную строку PowerShell с правами администратора и перейдите к расположению распакованного пакета.
5. Запустите файл Powershell *AddNode.ps1*, указав параметры, описывающие новый узел для добавления. В следующем примере в домен сбоя 1 и домен обновления 1 добавляется новый узел с именем VM5, типом NodeType0 и IP-адресом 182.17.34.52. *ExistingClusterConnectionEndPoint* — это конечная точка подключения для узла в имеющемся кластере. Для нее в этом кластере можно выбрать *любой* IP-адрес узла.

```
.\AddNode.ps1 -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab -NodeName VM5 -NodeType NodeType0 -NodeIPAddressorFQDN 182.17.34.52 -ExistingClusterConnectionEndPoint 182.17.34.50:19000 -UpgradeDomain UD1 -FaultDomain FD1
```

## Удаление узлов из кластера

1. Подключитесь к виртуальной машине или компьютеру, который нужно удалить из кластера, с помощью удаленного рабочего стола.
2. Скопируйте или [скачайте изолированный пакет для Service Fabric для Windows Server](http://go.microsoft.com/fwlink/?LinkId=730690) и извлеките его содержимое на виртуальную машину или компьютер, который планируете добавить в кластер.
3. Откройте командную строку PowerShell с правами администратора и перейдите к расположению распакованного пакета.
4. Запустите файл Powershell *RemoveNode.ps1*. В приведенном ниже примере текущий узел удаляется из кластера. *ExistingClusterConnectionEndPoint* — это конечная точка подключения для узла в имеющемся кластере. Для нее в этом кластере можно выбрать *любой* IP-адрес узла.

```
.\RemoveNode.ps1 -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab -ExistingClusterConnectionEndPoint 182.17.34.50:19000
```

## Удаление кластера
Чтобы удалить кластер, запустите сценарий Powershell *RemoveServiceFabricCluster.ps1* из папки пакета и передайте в него путь к файлу конфигурации JSON и расположение CAB-файла пакета.

Этот сценарий может выполняться на любом компьютере, у которого есть доступ администратора ко всем компьютерам, перечисленным в качестве узлов в файле конфигурации кластера. Компьютер, на котором выполняется этот сценарий, может и не входить в кластер.

```
.\RemoveServiceFabricCluster.ps1 -ClusterConfigFilePath .\ClusterConfig.Unsecure.MultiMachine.json   -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab
```

## Практическое руководство. Создание кластера с тремя узлами с использованием виртуальных машин IaaS Azure
В этом разделе описано, как создать кластер на виртуальных машинах IaaS Azure с помощью автономного установщика Windows Server. Обратите внимание, что среда выполнения Service Fabric на этом кластере IaaS полностью управляется пользователем, в отличие от кластеров, созданных на портале Azure, которые обновляются поставщиком ресурсов Service Fabric.

1. Войдите на портал Azure и создайте виртуальную машину Windows Server 2012 R2 Datacenter в группе ресурсов.
2. Добавьте две дополнительные виртуальные машины Windows Server 2012 R2 Datacenter в ту же самую группу ресурсов. При создании каждой из них необходимо использовать одно и то же имя пользователя администратора и пароль. После создания все три виртуальные машины появятся в одной и той же виртуальной сети.
3. Подключитесь к каждой из виртуальных машин и выключите брандмауэр Windows с помощью диспетчера серверов и панели мониторинга локального сервера. Это гарантирует, что сетевой трафик может передаваться между компьютерами. Получите IP-адрес каждого компьютера, открыв командную строку и введя *ipconfig*. IP-адрес каждого компьютера можно также увидеть, выбрав ресурс виртуальной сети для группы ресурсов на портале Azure.
4. Подключитесь к одному из компьютеров и протестируйте связь с остальными двумя компьютерами.
5. Подключитесь к одной из виртуальных машин, скачайте изолированный пакет Windows Server в новую папку на компьютере и извлеките содержимое пакета.
6. Откройте файл *ClusterConfig.Unsecure.MultiMachine.json* в Блокноте и измените каждый узел, введя три IP-адреса компьютеров, переименуйте кластер в верхней части и сохраните файл. Ниже приведен частичный пример манифеста кластера. В нем представлен IP-адрес каждого компьютера.

    ```
    {
        "name": "TestCluster",
        "clusterManifestVersion": "1.0.0",
        "apiVersion": "2015-01-01-alpha",
        "nodes": [
        {
            "nodeName": "vm0",
        	"metadata": "Replace the localhost with valid IP address or FQDN below",
            "iPAddress": "10.7.0.5",
            "nodeTypeRef": "NodeType0",
            "faultDomain": "fd:/dc1/r0",
            "upgradeDomain": "UD0"
        },
        {
            "nodeName": "vm1",
        	"metadata": "Replace the localhost with valid IP address or FQDN below",
            "iPAddress": "10.7.0.4",
            "nodeTypeRef": "NodeType0",
            "faultDomain": "fd:/dc2/r0",
            "upgradeDomain": "UD1"
        },
        {
            "nodeName": "vm2",
        	"metadata": "Replace the localhost with valid IP address or FQDN below",
            "iPAddress": "10.7.0.6",
            "nodeTypeRef": "NodeType0",
            "faultDomain": "fd:/dc3/r0",
            "upgradeDomain": "UD2"
        }
    ],
    ```

7. Откройте окно Powershell ISE и перейдите к папке, в которую был скачан и распакован пакет автономного установщика, и сохраните файл манифеста выше. Выполните следующую команду PowerShell.

    ```
    .\CreateServiceFabricCluster.ps1 -ClusterConfigFilePath .\ClusterConfig.Unsecure.MultiMachine.json -MicrosoftServiceFabricCabFilePath .\MicrosoftAzureServiceFabric.cab
    ```

8. Вы должны увидеть, как Powershell запустится, подключится к каждому компьютеру и создаст кластер. Примерно через 1 минуту можно проверить работоспособность кластера, подключившись к Service Fabric Explorer на одном из IP-адресов компьютеров, например http://10.7.0.5:19080/Explorer/index.html. Чтобы сделать этот процесс безопасным (учитывая, что это автономный кластер на виртуальных машинах IaaS), необходимо развернуть сертификаты на виртуальных машинах или настроить один из компьютеров в качестве контроллера Windows Server Active Directory для проверки подлинности Windows так же, как и в локальной среде. Сведения о настройке безопасных кластеров см. в разделе "Дальнейшие действия" ниже.

## Дальнейшие действия
- [Создание автономных кластеров Service Fabric в Windows Server или Linux](service-fabric-deploy-anywhere.md)
- [Параметры конфигурации для автономного кластера Windows](service-fabric-cluster-manifest.md)

- [Защита автономного кластера под управлением Windows с помощью системы безопасности Windows](service-fabric-windows-cluster-windows-security.md)
- [Защита автономного кластера под управлением Windows с помощью сертификатов](service-fabric-windows-cluster-x509-security.md)

<!---HONumber=AcomDC_0713_2016-->