<properties
   pageTitle="Безопасность кластера Service Fabric | Microsoft Azure"
   description="Обеспечение безопасности кластера Service Fabric. Каковы варианты?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/10/2015"
   ms.author="chackdan"/>

# Защита кластеров Service Fabric с помощью сертификатов

Чтобы настроить безопасный кластер Service Fabric, требуется хотя бы один сертификат сервера или сертификат x509. Затем его нужно отправить в хранилище ключей Azure и использовать при создании кластера. Подробное описание см. в статье [Процесс создания кластера Service Fabric](service-fabric-cluster-creation-via-portal.md).

Процесс состоит из трех шагов.

1. Получение сертификата x509.
2. Отправка сертификата в хранилище ключей Azure.
3. Предоставление сведений о сертификате и его расположении в ходе создания кластера Service Fabric.

Прежде чем углубляться в детали, давайте вспомним, что такое сценарии.

##  Какие сценарии рассматриваются?

Service Fabric обеспечивает безопасность для следующих сценариев.

1. Защита кластера при обмене данными между узлами.
2. Безопасность клиента Service Fabric при обмене данными с определенным узлом в кластере.
3. Управление доступом на основе ролей (RBAC) позволяет разграничить в кластере операции администрирования и чтения набора сертификатов.   

Service Fabric использует сертификаты сервера X509, указанные как часть конфигураций типа узла при создании кластера. Краткий обзор этих сертификатов, а также способы их получения или создания см. в конце этой страницы.

 
## Получение сертификатов x509

1. Для защиты кластеров, на которых выполняются рабочие нагрузки, необходимо использовать сертификат x509, подписанный [центром сертификации (ЦС)](https://en.wikipedia.org/wiki/Certificate_authority). Сведения о получении этих сертификатов см. по адресу [http://msdn.microsoft.com/library/aa702761.aspx](http://msdn.microsoft.com/library/aa702761.aspx).
2. Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты.


## Создание самозаверяющего сертификата для тестирования

Сведения о создании самозаверяющих сертификатов см. по адресу [https://technet.microsoft.com/library/hh848633.aspx](https://technet.microsoft.com/library/hh848633.aspx).
    
Я создаю тестовые сертификаты с помощью приведенного ниже кода PS. Обязательно прочтите указанный выше документ, чтобы убедиться в соответствии описанного сценария вашим потребностям. ```
$password = Read-Host -AsSecureString 
``` ```
New-SelfSignedCertificate -CertStoreLocation Cert:\CurrentUser\My -DnsName ChackdanTestCertificate | Export-PfxCertificate -FilePath E:\MyCertificates\ChackdanTestCertificate.pfx -Password $password
```

**Примечание**. В строке DnsName <String> содержится одно или несколько DNS-имен для включения в расширение альтернативного имени субъекта сертификата, когда копируемый сертификат не задан в параметре CloneCert. Первое DNS-имя также сохраняется как имя субъекта. Если сертификат для подписи не указан, первое DNS-имя также сохраняется как имя издателя.

## Отправка сертификата x509 в хранилище ключей

Инструкции по отправке сертификата в хранилище ключей см. на странице [ссылка на документацию хранилища ключей](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).

Обязательно запишите URL-адрес исходного хранилища, URL-адрес сертификата и отпечаток сертификата. Они потребуются при настройке безопасного кластера Service Fabric. Необходимые вам данные будут выглядеть следующим образом.



1. **Идентификатор ресурса хранилища ключей или URL-адрес исходного хранилища**: /subscriptions/6c653126-e4ba-42cd-a1dd-f7bf96af7a47/resourceGroups/chackdan-keyvault/providers/Microsoft.KeyVault/vaults/chackdan-kmstest.
2. **URL-адрес расположения сертификата в хранилище ключей**: https://chackdan-kmstest.vault.azure.net:443/secrets/MyCert/dcf17bdbb86b42ad864e8e827c268431. 
3. **Отпечаток сертификата**: 2118C3BCE6541A54A0236E14ED2CCDD77EA4567A.



##Настройка безопасного кластера 

Используемые сертификаты можно выбрать в поле типа узла в разделе конфигураций безопасности. Их нужно указывать для каждого типа узла в кластере. Хотя в этой статье описано, как выбрать сертификат на портале, это также можно сделать с помощью шаблона ARM.

![SecurityConfigurations\_01][SecurityConfigurations_01]

Обязательные параметры

- **Режим безопасности** — обязательно установите флажок «Сертификат x509». Так вы сообщите Service Fabric о необходимости настройки безопасного кластера. 
- **Уровень защиты кластера** — пояснение всех значений см. в [документе об уровнях защиты](https://msdn.microsoft.com/library/aa347692.aspx). Вы можете использовать три значения: EncryptAndSign, Sign и None. Лучше всего оставить значение по умолчанию, «EncryptAndSign», если вы не совсем уверены в том, что делаете.
- **Исходное хранилище** — это идентификатор ресурса хранилища ключей в формате ```
/subscriptions/<Sub ID>/resourceGroups/<Resource group name>/providers/Microsoft.KeyVault/vaults/<vault name>
```.

- **URL-адрес сертификата** — это URL-адрес расположения в хранилище ключей, в которое отправлен сертификат, в формате ```
https://<name of the vault>.vault.azure.net:443/secrets/<exact location>
https://chackdan-kmstest-eastus.vault.azure.net:443/secrets/MyCert/6b5cc15a753644e6835cb3g3486b3812
```.
- **Отпечаток сертификата** — это отпечаток сертификата, который можно найти по URL-адресу, указанному ранее.

Необязательные параметры — при необходимости вы также можете указать дополнительные сертификаты, которые используются клиентскими компьютерами для выполнения операций в кластере. По умолчанию указанный в обязательных параметрах отпечаток добавляется в список авторизованных отпечатков, разрешенных для каждой операции клиента.

Клиент администрирования — с помощью этих сведений можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций администрирования и чтения в кластере. Вы можете указать несколько сертификатов для авторизации операций администрирования.


- **Авторизовать с помощью** — указывает способ поиска сертификата в Service Fabric (по имени субъекта или отпечатку). Хотя использовать имя субъекта для авторизации нежелательно, это обеспечивает большую гибкость.


- **Имя субъекта** — требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя** — обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.

Клиент только для чтения — с помощью этих сведений можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций чтения в кластере. Вы можете указать несколько сертификатов для авторизации операций чтения.


- **Авторизовать с помощью** — указывает способ поиска сертификата в Service Fabric (по имени субъекта или отпечатку). Хотя использовать имя субъекта для авторизации нежелательно, это обеспечивает большую гибкость.

- **Имя субъекта** — требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя** — обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.


## Обновление сертификатов в кластере

Service Fabric позволяет указать два сертификата — основной и дополнительный. Сертификат, указанный во время создания, по умолчанию становится основным. Чтобы добавить еще один сертификат, его необходимо развернуть на виртуальных машинах, входящих в кластер. Подробные сведения см. в документе [Развертывание сертификатов на виртуальных машинах из хранилища ключей, управляемого клиентом](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx).

Завершив эту операцию, укажите для Service Fabric (на портале или с помощью ARM) дополнительный сертификат, который также можно использовать. Вам потребуется только отпечаток.

На портале выберите нужный ресурс кластера, к которому нужно добавить сертификат, щелкните параметр сертификата, введите отпечаток дополнительного сертификата и щелкните «Сохранить». Запустится развертывание. После его успешного завершения вы сможете использовать оба сертификата, чтобы выполнять операции управления в кластере.

![SecurityConfigurations\_02][SecurityConfigurations_02]

При необходимости один из сертификатов можно удалить. После удаления обязательно щелкните «Сохранить», чтобы запустить новое развертывание. После завершения развертывания удаленный сертификат больше не будет использоваться для подключения к кластеру. Для работы с безопасным кластером всегда требуется хотя бы один действительный (не отозванный или просроченный) развернутый сертификат. В противном случае вы не сможете получить доступ к кластеру.

Событие диагностики всегда вовремя оповещает об истечении срока действия сертификатов.



## Что такое сертификаты X509?

Цифровые сертификаты X509 обычно используются для проверки подлинности клиентов и серверов, а также для шифрования и цифровой подписи сообщений. Подробные сведения об этих сертификатах см. по адресу [http://msdn.microsoft.com/library/ms731899.aspx](http://msdn.microsoft.com/library/ms731899.aspx).

**Примечание.**

1. Сертификаты, которые используются в кластерах, выполняющих рабочие нагрузки, можно создать с помощью правильно настроенной службы сертификации Windows Server. Их также можно получить в утвержденном [центре сертификации (ЦС)](https://en.wikipedia.org/wiki/Certificate_authority).
2. Никогда не используйте в рабочей среде временные или тестовые сертификаты, созданные с помощью таких средств, как MakeCert.exe.
3. Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты. 


##Что такое сертификаты сервера и клиента?

**Сертификаты сервера или сертификаты X509**

Основной задачей сертификатов сервера является проверка подлинности сервера (узла) для клиентов или сервера (узла) для сервера (узла). Одна из начальных проверок подлинности узла, выполняемая клиентом или узлом, заключается в сопоставлении общего имени в поле «Субъект» с настроенным списком разрешенных общих имен. Это общее имя или одно из альтернативных имен субъекта сертификатов должно присутствовать в списке разрешенных общих имен.

Способы создания сертификатов с альтернативными именами субъектов (SAN) см. по адресу [http://support.microsoft.com/kb/931351](http://support.microsoft.com/kb/931351).
 
**Примечание.** В поле «Субъект» может быть несколько значений, каждое из которых содержит определяющее сокращение в виде префикса. Чаще всего для общего имени (common name) используется сокращение CN, например: CN = www.contoso.com. Поле «Субъект» также можно оставить пустым. Обратите внимание на необязательное поле «Альтернативное имя субъекта». Заполняющее его значение должно содержать общее имя сертификата и альтернативное имя субъекта. Эти имена вводятся как значения DNS-имени.

Также учтите, что поле «Назначения» должно содержать соответствующие значения, например «Проверка подлинности сервера» или «Проверка подлинности клиента».

**Сертификаты клиента**

Как правило, сертификаты клиентов не выдаются сторонними центрами сертификации. В личном хранилище текущего пользователя обычно содержатся сертификаты, помещенные туда корневым центром сертификации. Значение поля назначения — «Проверка подлинности клиента». Клиент может использовать такой сертификат, когда требуется взаимная проверка подлинности. Для выполнения всех операций управления в кластере Service Fabric необходимы сертификаты серверов. Не следует использовать сертификаты клиентов.


<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->
## Дальнейшие действия
- [Обновление кластера Service Fabric](service-fabric-cluster-upgrade.md)
- [Управление приложениями Service Fabric в Visual Studio](service-fabric-manage-application-in-visual-studio.md)
- [Общие сведения о наблюдении за работоспособностью системы в Service Fabric](service-fabric-health-introduction.md)

<!--Image references-->
[SecurityConfigurations_01]: ./media/service-fabric-cluster-security/SecurityConfigurations_01.png
[SecurityConfigurations_02]: ./media/service-fabric-cluster-security/SecurityConfigurations_02.png

<!---HONumber=Nov15_HO4-->