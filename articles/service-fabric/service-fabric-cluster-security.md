<properties
   pageTitle="Как настроить защиту кластера Service Fabric | Microsoft Azure"
   description="Сведения о защите кластера Service Fabric. Каковы варианты?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/10/2015"
   ms.author="chackdan"/>

# Защита кластера Service Fabric

Кластер Service Fabric — это ресурс, владельцем которого вы являетесь. Во избежание несанкционированного доступа, следует защитить его, особенно, если на нем выполняются рабочие нагрузки. В этом документе содержится пошаговое руководство по защите кластеров.

##  Сценарии защиты кластеров

Service Fabric обеспечивает безопасность для следующих сценариев.

1. **Безопасность при обмене данными между узлами** или защита кластера при обмене данными между узлами. Обеспечивает безопасность обмена данными между виртуальными машинами или компьютерами в кластере. Такая защита гарантирует, что размещать приложения и службы в кластере смогут владельцы только тех компьютеров, которые прошли авторизацию для подключения к кластеру.

	![Обмен данными между узлами][Node-to-Node]

2. **Безопасность при обмене данными между клиентом и узлом** или защита клиента Service Fabric при обмене данными с определенным узлом в кластере. Выполняет проверку подлинности и обеспечивает безопасность обмена данными с клиентом, благодаря чему к кластеру и приложениям, развернутым в кластере Windows Fabric, могут получить доступ только те пользователи, которые прошли авторизацию. Клиенты однозначно определяются с помощью своих учетных данных системы безопасности Windows или учетных данных сертификата безопасности.

	![Обмен данными между узлом и клиентом][Client-to-Node]

	Для любого из типов сценариев обмена данными (между узлами или между клиентом и узлом) Service Fabric поддерживает использование как [сертификата безопасности](https://msdn.microsoft.com/library/ff649801.aspx), так и [системы безопасности Windows](https://msdn.microsoft.com/library/ff649396.aspx). Параметры безопасности для защиты обмена данными между узлами или между клиентом и узлом не зависят друг от друга. Они могут быть одинаковыми или разными.

	Azure Service Fabric использует сертификаты сервера X509, которые указываются как часть конфигурации типа узла при создании кластера. Краткий обзор этих сертификатов, а также способы их получения или создания см. в конце этой страницы.

3. **Управление доступом на основе ролей (RBAC)** позволяет разграничить в кластере операции администрирования и чтения набора сертификатов.

4. **Учетные записи служб и запуск от имени**. В Service Fabric выполняется процесс службы Windows (Fabric.exe), и учетную запись системы безопасности, под которой он выполняется, можно настроить. Можно защитить учетные записи процесса, под которыми выполняется Fabric.exe на каждом узле кластера, а также процессы узлов служб, запущенные для каждой службы. Дополнительные сведения см. в документе [Безопасность приложений и запуск от имени](service-fabric-application-runas-security.md).
  

## Защита кластеров Service Fabric с помощью сертификатов

Чтобы настроить безопасный кластер Service Fabric, требуется хотя бы один сертификат сервера или сертификат x509. Затем его нужно отправить в хранилище ключей Azure и использовать при создании кластера.

Процесс состоит из трех шагов.

1. Получение сертификата x509.
2. Отправка сертификата в хранилище ключей Azure.
3. Предоставление сведений о сертификате и его расположении в ходе создания кластера Service Fabric.

 
## Шаг 1. Получение сертификатов x509

1. Для защиты кластеров, на которых выполняются рабочие нагрузки, необходимо использовать сертификат x509, подписанный [центром сертификации](https://en.wikipedia.org/wiki/Certificate_authority). Сведения о получении этих сертификатов см. по адресу [http://msdn.microsoft.com/library/aa702761.aspx](http://msdn.microsoft.com/library/aa702761.aspx).
2. Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты. На шаге 2.5 подробно описано, как это сделать.


## Шаг 2. Отправка сертификата x509 в хранилище ключей

Это сложный процесс, поэтому для его выполнения мы отправили в репозиторий Git модуль Powershell.

**Шаг 2.1.**. Скопируйте эту папку на компьютер из [репозитория Git](https://github.com/ChackDan/Service-Fabric/tree/master/Scripts/ServiceFabricRPHelpers).

**Шаг 2.2.**. Убедитесь, что на компьютере установлен пакет SDK для Azure версии 1.0 или более поздней.

**Шаг 2.3.**. Откройте окно Powershell и импортируйте файл ServiceFabricRPHelpers.psm.

```
Remove-Module ServiceFabricRPHelpers
```

Скопируйте следующие данные и измените путь к файлу PSM1, как на вашем компьютере. Вот пример: ```
Import-Module "C:\Users\chackdan\Documents\GitHub\Service-Fabric\Scripts\ServiceFabricRPHelpers\ServiceFabricRPHelpers.psm1"
```
  

**Шаг 2.4**. При использовании уже полученного сертификата выполните действия ниже. В противном случае перейдите сразу к шагу 2.5.


Войдите в свою учетную запись Azure.

```
Login-AzureRmAccount
```

Сценарий создаст группу ресурсов и/или хранилище, если они еще не созданы.

```
Invoke-AddCertToKeyVault -SubscriptionId <you subscription id> -ResourceGroupName <string> -Location <region> -VaultName <Name of the Vault> -CertificateName <Name of the Certificate> -Password <Certificate password> -UseExistingCertificate -ExistingPfxFilePath <Full path to the .pfx file> 
```
Вот пример заполненного сценария: ```
Invoke-AddCertToKeyVault -SubscriptionId 35389201-c0b3-405e-8a23-9f1450994307 -ResourceGroupName chackdankeyvault4doc -Location westus -VaultName chackdankeyvault4doc  -CertificateName chackdantestcertificate2 -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password ") -UseExistingCertificate -ExistingPfxFilePath C:\MyCertificates\ChackdanTestCertificate.pfx 
```

При успешном выполнении сценария вы получите следующие выходные данные, которые потребуются на шаге 3.

1. **Отпечаток сертификата**: 2118C3BCE6541A54A0236E14ED2CCDD77EA4567A.
2. **Хранилище ресурсов**/идентификатор ресурса хранилища ключей: /subscriptions/35389201-c0b3-405e-8a23-9f1450994307/resourceGroups/chackdankeyvault4doc/providers/Microsoft.KeyVault/vaults/chackdankeyvault4doc.
3. **URL-адрес сертификата**/URL-адрес расположения сертификата в хранилище ключей: https://chackdankeyvalut4doc.vault.azure.net:443/secrets/chackdantestcertificate3/ebc8df6300834326a95d05d90e0701ea. 

Теперь у вас есть сведения, необходимые для настройки безопасного кластера. Перейдите к шагу 3.


**Шаг 2.5**. Если вы хотите создать самозаверяющий сертификат и отправить его в хранилище ключей, сделайте следующее.

Войдите в свою учетную запись Azure.

```
Login-AzureRmAccount
```

Сценарий создаст группу ресурсов и/или хранилище, если они еще не созданы.

```
Invoke-AddCertToKeyVault -SubscriptionId <you subscription id> -ResourceGroupName <string> -Location <region> -VaultName <Name of the Vault> -CertificateName <Name of the Certificate> -Password <Certificate password> -CreateSelfSignedCertificate -DnsName <string- see note below.> -OutputPath <Full path to the .pfx file> 
```
Параметр OutputPath, используемый в сценарии, будет содержать новый самозаверяющий сертификат, который был отправлен в хранилище ключей.


**Примечание**. В строке DnsName <String> содержится одно или несколько DNS-имен, которые необходимо включить в расширение альтернативного имени субъекта сертификата, если копируемый сертификат не задан в параметре CloneCert. Первое DNS-имя также сохраняется как имя субъекта. Если сертификат для подписи не указан, первое DNS-имя также сохраняется как имя издателя.

Общие сведения о создании самозаверяющих сертификатов см. по адресу [https://technet.microsoft.com/library/hh848633.aspx](https://technet.microsoft.com/library/hh848633.aspx).

Вот пример заполненного сценария: ```
Invoke-AddCertToKeyVault -SubscriptionId 35389201-c0b3-405e-8a23-9f1450994307 -ResourceGroupName chackdankeyvault4doc -Location westus -VaultName chackdankeyvault4doc  -CertificateName chackdantestcertificate3 -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password ") -CreateSelfSignedCertificate -DnsName www.chackdan.westus.azure.com -OutputPath C:\MyCertificates
```

Так как это самозаверяющий сертификат, перед его использованием для подключения к безопасному кластеру необходимо импортировать его в хранилище TrustedPeople на вашем компьютере. ```
Import-PfxCertificate -Exportable -CertStoreLocation Cert:\CurrentUser\TrustedPeople -FilePath C:C:\MyCertificates\ChackdanTestCertificate.pfx -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password ")
``` ```
Import-PfxCertificate -Exportable -CertStoreLocation Cert:\CurrentUser\My -FilePath C:C:\MyCertificates\ChackdanTestCertificate.pfx -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password ")
```

При успешном выполнении сценария вы получите следующие выходные данные, которые потребуются на шаге 3.

1. **Отпечаток сертификата**: 64881409F4D86498C88EEC3697310C15F8F1540F.
2. **Хранилище ресурсов**/идентификатор ресурса хранилища ключей: /subscriptions/35389201-c0b3-405e-8a23-9f1450994307/resourceGroups/chackdankeyvault4doc/providers/Microsoft.KeyVault/vaults/chackdankeyvault4doc.
3. **URL-адрес сертификата**/URL-адрес расположения сертификата в хранилище ключей: https://chackdankeyvalut4doc.vault.azure.net:443/secrets/chackdantestcertificate3/fvc8df6300834326a95d05d90e0720ea. 

##Шаг 3. Настройка безопасного кластера 

Выполняйте действия, описанные в документе [Создание кластера Service Fabric](service-fabric-cluster-creation-via-portal.md), пока не достигнете раздела «Конфигурации безопасности». Ниже описано, как настроить конфигурации безопасности.

Используемые сертификаты можно выбрать в поле типа узла в разделе конфигураций безопасности. Их нужно указывать для каждого типа узла в кластере. Хотя в этой статье описано, как выбрать сертификат на портале, это также можно сделать с помощью шаблона ARM.

![SecurityConfigurations\_01][SecurityConfigurations_01]

Обязательные параметры

- **Режим безопасности** — обязательно выберите «Сертификат x509». Этим вы укажете Service Fabric на необходимость настройки безопасного кластера. 
- **Уровень защиты кластера** — пояснение всех значений см. в [документе об уровнях защиты](https://msdn.microsoft.com/library/aa347692.aspx). Здесь можно использовать три значения: EncryptAndSign, Sign и None. Лучше всего оставить значение по умолчанию, «EncryptAndSign», если вы не совсем уверены в том, что делаете.
- **Исходное хранилище** — это идентификатор ресурса хранилища ключей в формате ```
/subscriptions/<Sub ID>/resourceGroups/<Resource group name>/providers/Microsoft.KeyVault/vaults/<vault name>
```.

- **URL-адрес сертификата** — это URL-адрес расположения в хранилище ключей, в которое отправлен сертификат, в формате ```
https://<name of the vault>.vault.azure.net:443/secrets/<exact location>
https://chackdan-kmstest-eastus.vault.azure.net:443/secrets/MyCert/6b5cc15a753644e6835cb3g3486b3812
```.
- **Отпечаток сертификата** — это отпечаток сертификата, который можно найти по URL-адресу, указанному ранее.

Необязательные параметры — при необходимости вы также можете указать дополнительные сертификаты, которые используются клиентскими компьютерами для выполнения операций в кластере. По умолчанию указанный в обязательных параметрах отпечаток добавляется в список авторизованных отпечатков, разрешенных для каждой операции клиента.

Клиент администрирования — с помощью этих сведений можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций администрирования и чтения в кластере. Вы можете указать несколько сертификатов для авторизации операций администрирования.


- **Авторизовать по** — указывает способ поиска сертификата в Service Fabric (по имени субъекта или по отпечатку). Хотя использовать имя субъекта для авторизации нежелательно, это обеспечивает большую гибкость.


- **Имя субъекта** — требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя** — обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.

Клиент только для чтения — с помощью этих сведений можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций чтения в кластере. Вы можете указать несколько сертификатов для авторизации операций чтения.


- **Авторизовать по** — указывает способ поиска сертификата в Service Fabric (по имени субъекта или по отпечатку). Хотя использовать имя субъекта для авторизации нежелательно, это обеспечивает большую гибкость.

- **Имя субъекта** — требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя** — обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.


## Обновление сертификатов в кластере

Service Fabric позволяет указать два сертификата — основной и дополнительный. Сертификат, указанный во время создания, по умолчанию становится основным. Чтобы добавить еще один сертификат, его необходимо развернуть на виртуальных машинах, входящих в кластер. На шаге 2 выше описано, как отправить новый сертификат в хранилище ключей. Для этого можно использовать то же хранилище ключей, что и для первого сертификата.

Дополнительные сведения см. в документе [Развертывание сертификатов на виртуальных машинах из хранилища ключей, управляемого клиентом](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx).

Завершив эту операцию, укажите для Service Fabric (на портале или с помощью ARM) дополнительный сертификат, который также можно использовать. Вам потребуется только отпечаток.

Вот как это делается. На портале выберите нужный ресурс кластера, к которому нужно добавить сертификат, щелкните параметр сертификата, введите отпечаток дополнительного сертификата и щелкните «Сохранить». Запустится развертывание. После его успешного завершения вы сможете использовать оба сертификата, чтобы выполнять операции управления в кластере.

![SecurityConfigurations\_02][SecurityConfigurations_02]

При необходимости один из сертификатов можно удалить. После удаления обязательно щелкните «Сохранить», чтобы запустить новое развертывание. После завершения развертывания удаленный сертификат больше не будет использоваться для подключения к кластеру. Для работы с безопасным кластером всегда требуется хотя бы один действительный (не отозванный или просроченный) развернутый сертификат. В противном случае вы не сможете получить доступ к кластеру.

Событие диагностики всегда вовремя оповещает об истечении срока действия сертификатов.



## Что такое сертификаты X509?

Цифровые сертификаты X509 обычно используются для проверки подлинности клиентов и серверов, а также для шифрования и цифровой подписи сообщений. Дополнительные сведения об этих сертификатах см. по адресу [http://msdn.microsoft.com/library/ms731899.aspx](http://msdn.microsoft.com/library/ms731899.aspx).

**Примечание.**

1. Сертификаты, которые используются в кластерах, выполняющих рабочие нагрузки, можно создать с помощью правильно настроенной службы сертификации Windows Server. Их также можно получить через утвержденный [центр сертификации](https://en.wikipedia.org/wiki/Certificate_authority).
2. Никогда не используйте в рабочей среде временные или тестовые сертификаты, созданные с помощью таких средств, как MakeCert.exe.
3. Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты. 


## Что такое сертификаты сервера и клиента?

**Сертификаты сервера или сертификаты X509**

Основной задачей сертификатов сервера является проверка подлинности сервера (узла) для клиентов или сервера (узла) для сервера (узла). Одна из начальных проверок подлинности узла, выполняемая клиентом или узлом, заключается в сопоставлении общего имени в поле «Субъект» с настроенным списком разрешенных общих имен. Это общее имя или одно из альтернативных имен субъекта сертификатов должно присутствовать в списке разрешенных общих имен.

Способы создания сертификатов с альтернативными именами субъектов (SAN) см. по адресу [http://support.microsoft.com/kb/931351](http://support.microsoft.com/kb/931351).
 
**Примечание.** В поле «Субъект» может быть несколько значений, каждое из которых содержит определяющее сокращение в виде префикса. Чаще всего для общего имени (common name) используется сокращение CN, например: CN = www.contoso.com. Поле «Субъект» также можно оставить пустым. Обратите внимание на необязательное поле «Альтернативное имя субъекта». Заполняющее его значение должно содержать общее имя сертификата и альтернативное имя субъекта. Эти имена вводятся как значения DNS-имени.

Также учтите, что поле «Назначения» должно содержать соответствующие значения, например «Проверка подлинности сервера» или «Проверка подлинности клиента».

**Сертификаты клиента**

Как правило, сертификаты клиентов не выдаются сторонними центрами сертификации. В личном хранилище текущего пользователя обычно содержатся сертификаты, помещенные туда корневым центром сертификации. Значение поля назначения — «Проверка подлинности клиента». Клиент может использовать такой сертификат, когда требуется взаимная проверка подлинности. Для выполнения всех операций управления в кластере Service Fabric необходимы сертификаты серверов. Не следует использовать сертификаты клиентов.


<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->
## Дальнейшие действия
- [Обновление кластера Service Fabric](service-fabric-cluster-upgrade.md)
- [Управление приложениями Service Fabric в Visual Studio](service-fabric-manage-application-in-visual-studio.md)
- [Общие сведения о модели работоспособности в Service Fabric](service-fabric-health-introduction.md)

<!--Image references-->
[SecurityConfigurations_01]: ./media/service-fabric-cluster-security/SecurityConfigurations_01.png
[SecurityConfigurations_02]: ./media/service-fabric-cluster-security/SecurityConfigurations_02.png
[Node-to-Node]: ./media/service-fabric-cluster-security/node-to-node.png
[Client-to-Node]: ./media/service-fabric-cluster-security/client-to-node.png

<!---HONumber=AcomDC_1210_2015-->