<properties
   pageTitle="Настройка безопасности кластера Service Fabric | Microsoft Azure"
   description="Сведения о настройке безопасности кластера Service Fabric. Каковы варианты?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/01/2016"
   ms.author="chackdan"/>

# Защита кластера Service Fabric

Кластер Azure Service Fabric — это ресурс, владельцем которого вы являетесь. Во избежание несанкционированного доступа, следует защитить его, особенно, если на нем выполняются рабочие нагрузки. В этой статье описывается процесс настройки безопасности кластера Service Fabric.

## Сценарии обеспечения безопасности кластера

Service Fabric обеспечивает безопасность для следующих сценариев.

1. **Безопасность обмена данными между узлами**. Обеспечивает безопасность обмена данными между виртуальными машинами и компьютерами в кластере. Такая защита гарантирует, что размещать приложения и службы в кластере смогут владельцы только тех компьютеров, которые прошли авторизацию для подключения к кластеру.

	![Схема обмена данными между узлами][Node-to-Node]

2. **Безопасность обмена данными между узлом и клиентом**. Обеспечивает безопасность обмена данными между клиентом Service Fabric и отдельными узлами в кластере. Этот тип защиты выполняет проверку подлинности и обеспечивает безопасность обмена данными с клиентом, благодаря чему к кластеру и развернутым в нем приложениям могут получить доступ только авторизованные пользователи. Клиенты однозначно определяются с помощью своих учетных данных системы безопасности Windows или учетных данных сертификата безопасности.

	![Схема обмена данными между узлом и клиентом][Client-to-Node]

	Для обеспечения безопасности обмена данными между узлами или между узлом и клиентом можно использовать [сертификат безопасности](https://msdn.microsoft.com/library/ff649801.aspx) или [безопасность Windows](https://msdn.microsoft.com/library/ff649396.aspx). Параметры безопасности для защиты обмена данными между узлами или между клиентом и узлом не зависят друг от друга. Они могут быть одинаковыми или разными.

	Azure Service Fabric использует сертификаты сервера X.509, которые указываются как часть конфигурации типа узла при создании кластера. Краткий обзор этих сертификатов и способа их получения или создания приведен в конце этой статьи.

3. **Контроль доступа на основе ролей**. Ограничивает операции администрирования в кластере в зависимости от определенного набора сертификатов.

## Защита кластеров Service Fabric с помощью сертификатов

Чтобы настроить безопасный кластер Service Fabric, нужен по крайней мере один сертификат X.509 сервера, который необходимо передать в хранилище ключей Azure и использовать в процессе создания кластера.

Процесс состоит из трех шагов.

1. Получение сертификата x509.
2. Отправка сертификата в хранилище ключей Azure.
3. Предоставление сведений о сертификате и его расположении в ходе создания кластера Service Fabric.

### Шаг 1. Получение сертификатов X.509

1. Для защиты кластеров, на которых выполняются рабочие нагрузки, необходимо использовать сертификат X.509, подписанный [центром сертификации](https://en.wikipedia.org/wiki/Certificate_authority). Сведения о получении этих сертификатов приведены в разделе [Практическое руководство: получение сертификата](http://msdn.microsoft.com/library/aa702761.aspx).
2. Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты. На шаге 2.5 ниже объясняется, как это сделать.

### Шаг 2. Отправка сертификата X.509 в хранилище ключей

Это сложный процесс, поэтому для его выполнения мы передали в репозиторий Git модуль PowerShell.

**Шаг 2.1**. Скопируйте эту папку на компьютер из [репозитория Git](https://github.com/ChackDan/Service-Fabric/tree/master/Scripts/ServiceFabricRPHelpers).

**Шаг 2.2**. Убедитесь, что на компьютере установлен Azure PowerShell версии 1.0 или более поздней версии. Если вы не сделали этого ранее, настоятельно рекомендуем выполнить инструкции в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md).

**Шаг 2.3**. Откройте окно PowerShell и импортируйте файл ServiceFabricRPHelpers.psm. (Это модуль, который вы загрузили на шаге 2.1.)

```
Remove-Module ServiceFabricRPHelpers
```

Скопируйте следующий пример и измените путь к PSM1-файлу, чтобы он соответствовал пути на вашем компьютере.

```
Import-Module "C:\Users\chackdan\Documents\GitHub\Service-Fabric\Scripts\ServiceFabricRPHelpers\ServiceFabricRPHelpers.psm1"
```

**Шаг 2.4**. При использовании уже полученного сертификата выполните действия, описанные в этом шаге. В противном случае перейдите к шагу 2.5, в котором объясняется, как создать и развернуть самозаверяющий сертификат в хранилище ключей.

Войдите в учетную запись Azure. Если команды PowerShell по какой-то причине завершаются неудачно, проверьте, правильно ли установлен Azure PowerShell.

```
Login-AzureRmAccount
```

Следующий сценарий создаст группу ресурсов и/или хранилище ключей, если они еще не созданы. **Обратите внимание: если используется существующее хранилище ключей, оно должно быть настроено для поддержки развертывания с помощью этого сценария.**
```
Set-AzureRmKeyVaultAccessPolicy -VaultName <Name of the Vault> -ResourceGroupName <string> -EnabledForDeployment
```

```
Invoke-AddCertToKeyVault -SubscriptionId <your subscription id> -ResourceGroupName <string> -Location <region> -VaultName <Name of the Vault> -CertificateName <Name of the Certificate> -Password <Certificate password> -UseExistingCertificate -ExistingPfxFilePath <Full path to the .pfx file>
```
Вот пример заполненного сценария.

```
Invoke-AddCertToKeyVault -SubscriptionId 35389201-c0b3-405e-8a23-9f1450994307 -ResourceGroupName chackdankeyvault4doc -Location westus -VaultName chackdankeyvault4doc  -CertificateName chackdantestcertificate2 -Password abcd123 -UseExistingCertificate -ExistingPfxFilePath C:\MyCertificates\ChackdanTestCertificate.pfx
```

Если сценарий успешно выполнен, вы получите следующие выходные данные, которые потребуются для выполнения шага 3 (Настройка безопасного кластера).

- **Отпечаток сертификата**: 2118C3BCE6541A54A0236E14ED2CCDD77EA4567A.

- **Исходное хранилище**, то есть идентификатор ресурса хранилища ключей: /subscriptions/35389201-c0b3-405e-8a23-9f1450994307/resourceGroups/chackdankeyvault4doc/providers/Microsoft.KeyVault/vaults/chackdankeyvault4doc.

- **URL-адрес сертификата**, то есть URL-адрес расположения сертификата в хранилище ключей: https://chackdankeyvalut4doc.vault.azure.net:443/secrets/chackdantestcertificate3/ebc8df6300834326a95d05d90e0701ea.

Теперь у вас есть сведения, необходимые для настройки безопасности кластера. Перейдите к шагу 3.

**Шаг 2.5**. Если у вас *нет* сертификата и вы хотите создать самозаверяющий сертификат и отправить его в хранилище ключей, выполните описанные ниже действия.

Войдите в свою учетную запись Azure. Если команды PowerShell по какой-то причине завершаются неудачно, проверьте, правильно ли установлен Azure PowerShell.

```
Login-AzureRmAccount
```

Следующий сценарий создаст группу ресурсов и/или хранилище ключей, если они еще не созданы.

```
Invoke-AddCertToKeyVault -SubscriptionId <you subscription id> -ResourceGroupName <string> -Location <region> -VaultName <Name of the Vault> -CertificateName <Name of the Certificate> -Password <Certificate password> -CreateSelfSignedCertificate -DnsName <string- see note below.> -OutputPath <Full path to the .pfx file>
```

Параметр OutputPath, используемый в сценарии, будет содержать новый самозаверяющий сертификат, отправленный скриптом в хранилище ключей.

>[AZURE.NOTE] В строке DnsName содержится одно или несколько DNS-имен, которые необходимо включить в расширение альтернативного имени субъекта сертификата, если копируемый сертификат не задан в параметре CloneCert. Первое DNS-имя также сохраняется как имя субъекта. Если сертификат для подписи не указан, первое DNS-имя также сохраняется как имя издателя.

Дополнительные сведения о создании самозаверяющих сертификатов см. по адресу [https://technet.microsoft.com/library/hh848633.aspx](https://technet.microsoft.com/library/hh848633.aspx).

Вот пример заполненного сценария.

```
Invoke-AddCertToKeyVault -SubscriptionId 35389201-c0b3-405e-8a23-9f1450994307 -ResourceGroupName chackdankeyvault4doc -Location westus -VaultName chackdankeyvault4doc  -CertificateName chackdantestcertificate3 -Password abcd123 -CreateSelfSignedCertificate -DnsName www.chackdan.westus.azure.com -OutputPath C:\MyCertificates
```

Так как это самозаверяющий сертификат, перед его использованием для подключения к безопасному кластеру необходимо импортировать его в хранилище TrustedPeople на вашем компьютере.

```
Import-PfxCertificate -Exportable -CertStoreLocation Cert:\CurrentUser\TrustedPeople -FilePath C:\MyCertificates\ChackdanTestCertificate.pfx -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password")
```

```
Import-PfxCertificate -Exportable -CertStoreLocation Cert:\CurrentUser\My -FilePath C:\MyCertificates\ChackdanTestCertificate.pfx -Password (Read-Host -AsSecureString -Prompt "Enter Certificate Password")
```

Если сценарий успешно выполнен, вы получите следующие выходные данные. Они понадобятся для выполнения шага 3.

- **Отпечаток сертификата**: 64881409F4D86498C88EEC3697310C15F8F1540F.

- **Исходное хранилище**, то есть идентификатор ресурса хранилища ключей: /subscriptions/35389201-c0b3-405e-8a23-9f1450994307/resourceGroups/chackdankeyvault4doc/providers/Microsoft.KeyVault/vaults/chackdankeyvault4doc.

- **URL-адрес сертификата**, то есть URL-адрес расположения сертификата в хранилище ключей: https://chackdankeyvalut4doc.vault.azure.net:443/secrets/chackdantestcertificate3/fvc8df6300834326a95d05d90e0720ea.

### Шаг 3. Настройка безопасного кластера

Выполняйте действия, описанные в статье [Настройка кластера Service Fabric на портале Azure](service-fabric-cluster-creation-via-portal.md), пока не достигнете раздела "Настройка безопасности". Затем перейдите к инструкциям для настройки безопасности в этом разделе.

>[AZURE.NOTE]
Необходимые сертификаты указываются в поле "Тип узла" в разделе "Настройки безопасности". Их нужно указывать для каждого типа узла в кластере. Хотя в этой статье описано, как выбрать сертификат на портале, это также можно сделать с помощью шаблона диспетчера ресурсов Azure.

![Снимок экрана: раздел настройки безопасности на портале Azure][SecurityConfigurations_01]

Обязательные параметры:

- **Режим безопасности.** Выберите **Сертификат X509**. Этим вы укажете Service Fabric на необходимость настройки безопасного кластера.
- **Уровень защиты кластера.** Пояснение всех значений см. в статье [Основные сведения об уровне защиты](https://msdn.microsoft.com/library/aa347692.aspx). Несмотря на то, что можно использовать три значения (EncryptAndSign, Sign и None), если вы недостаточно знакомы с этим процессом, лучше оставить значение по умолчанию (EncryptAndSign).
- **Исходное хранилище —** это идентификатор ресурса хранилища ключей. Он должен быть представлен в следующем формате:

    ```
    /subscriptions/<Sub ID>/resourceGroups/<Resource group name>/providers/Microsoft.KeyVault/vaults/<vault name>
    ```

- **URL-адрес сертификата —** это URL-адрес расположения в хранилище ключей, в которое отправлен сертификат. Он должен быть представлен в следующем формате:

    ```
    https://<name of the vault>.vault.azure.net:443/secrets/<exact location>
```
```
    https://chackdan-kmstest-eastus.vault.azure.net:443/secrets/MyCert/6b5cc15a753644e6835cb3g3486b3812
    ```

- **Отпечаток сертификата —** это отпечаток сертификата, который можно найти по URL-адресу, указанному ранее.

Необязательные параметры:

 - При необходимости вы также можете указать дополнительные сертификаты, которые используются клиентскими компьютерами для выполнения операций в кластере. По умолчанию указанный в обязательных параметрах отпечаток добавляется в список авторизованных отпечатков, разрешенных для операций клиента.

"Клиент администрирования": с помощью сведений в этом разделе можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций администрирования и чтения в кластере. Можно указать несколько сертификатов, которые требуется авторизовать для выполнения операций администрирования.

- **Авторизовать с помощью —** указывает способ поиска сертификата в Service Fabric (по имени субъекта или по отпечатку). Хотя использование имени субъекта для авторизации нежелательно, оно обеспечивает большую гибкость.
- **Имя субъекта —** требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя** — обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.

"Клиент только для чтения": с помощью сведений в этом разделе можно проверить, предоставляет ли клиент, подключаемый к конечной точке управления кластера, действительные учетные данные для выполнения операций чтения в кластере. Можно указать несколько сертификатов, которые требуется авторизовать для выполнения операций только для чтения.

- **Авторизовать с помощью —** указывает способ поиска сертификата в Service Fabric (по имени субъекта или по отпечатку). Хотя использование имени субъекта для авторизации нежелательно, оно обеспечивает большую гибкость.
- **Имя субъекта —** требуется только в том случае, если задана авторизация по имени субъекта.
- **Отпечаток издателя —** обеспечивает дополнительный уровень проверки, которую сервер может выполнить, получив учетные данные клиента.

## Обновление сертификатов в кластере

Service Fabric позволяет указать два сертификата — основной и дополнительный. По умолчанию сертификат, указанный во время создания, является основным. Чтобы добавить еще один сертификат, его необходимо развернуть в виртуальных машинах в кластере. В шаге 2 описано, как отправить новый сертификат в хранилище ключей. Для этого можно использовать одно и то же хранилище ключей, как и в случае с первым сертификатом. Дополнительные сведения см. в статье [Развертывание сертификатов в виртуальных машинах из хранилища ключей, управляемого клиентом](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx).

Завершив эту операцию, укажите для Service Fabric (на портале или с помощью диспетчера ресурсов) дополнительный сертификат, который также можно использовать. Вам потребуется только отпечаток.

Ниже приведены шаги по добавлению дополнительного сертификата:

1. На портале перейдите к ресурсу кластера, к которому необходимо добавить этот сертификат.
2. В разделе **Настройки** щелкните настройки сертификатов и введите отпечаток дополнительного сертификата.
3. Щелкните **Сохранить**. Запустится развертывание, после успешного завершения которого вы сможете использовать основной или дополнительный сертификат, чтобы выполнять операции управления в кластере.

![Снимок экрана: раздел отпечатков сертификатов на портале][SecurityConfigurations_02]

Ниже описан процесс удаления старого сертификата, чтобы кластер больше не использовал его:

1. Перейдите на портал к параметрам безопасности кластера.
2. Удалите один из сертификатов.
3. Щелкните **Сохранить**, после чего будет запущено новое развертывание. После завершения этого развертывания удаленный сертификат больше нельзя использовать для подключения к кластеру.

>[AZURE.NOTE] Для работы с безопасным кластером всегда требуется хотя бы один действительный (не отозванный и не просроченный) развернутый сертификат (основной или дополнительный). В противном случае вы не сможете получить доступ к кластеру.


## Типы сертификатов, используемых Service Fabric

### Сертификаты X.509

Цифровые сертификаты X.509 обычно используются для проверки подлинности клиентов и серверов, а также для шифрования и цифровой подписи сообщений. Дополнительные сведения об этих сертификатах см. в статье [Работа с сертификатами](http://msdn.microsoft.com/library/ms731899.aspx) в библиотеке MSDN.

>[AZURE.NOTE]
- Сертификаты, которые используются в кластерах, выполняющих рабочие нагрузки, можно создать с помощью правильно настроенной службы сертификации Windows Server или получить через утвержденный [центр сертификации](https://en.wikipedia.org/wiki/Certificate_authority).
- Никогда не используйте в рабочей среде любые временные или тестовые сертификаты, созданные с помощью таких средств, как MakeCert.exe.
- Для кластеров, которые используются только для тестирования, можно использовать самозаверяющие сертификаты.

### Сертификаты сервера и клиента

#### Сертификаты X.509

Основной задачей сертификатов сервера является проверка подлинности сервера (узла) для клиентов или сервера (узла) для сервера (узла). Одна из начальных проверок при проверке подлинности узла — сопоставление значения общего имени в поле "Субъект". В списке разрешенных общих имен должно быть это общее имя или одно из альтернативных имен субъекта сертификатов.

Способы создания сертификатов с альтернативными именами субъектов (SAN) см. в статье [Как добавить дополнительное имя субъекта сертификата безопасного LDAP](http://support.microsoft.com/kb/931351).

>[AZURE.NOTE] В поле "Субъект" может быть несколько значений, каждое из которых содержит сокращение в виде префикса, определяющее тип значения. Чаще всего для общего имени используется сокращение CN. Например, CN = www.contoso.com. Поле "Субъект" также можно оставить пустым. Если необязательное поле "Альтернативное имя субъекта" заполнено, его значение должно содержать общее имя сертификата и альтернативное имя субъекта. Эти имена вводятся как значения DNS-имени.

Поле "Назначения" для сертификата должно содержать соответствующие значения, например "Проверка подлинности сервера" или "Проверка подлинности клиента".

#### Сертификаты клиента

Как правило, сертификаты клиентов не выдаются сторонними центрами сертификации. В личном хранилище текущего расположения пользователя обычно содержатся сертификаты клиента, помещенные туда корневым центром сертификации. Значение поля назначения — "Проверка подлинности клиента". Клиент может использовать такой сертификат, когда требуется взаимная проверка подлинности.

>[AZURE.NOTE] Для выполнения всех операций управления в кластере Service Fabric необходимы сертификаты серверов. Для управления нельзя использовать сертификаты клиента.

<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->

## Дальнейшие действия

- [Обновление кластера Service Fabric](service-fabric-cluster-upgrade.md)
- [Управление приложениями Service Fabric в Visual Studio](service-fabric-manage-application-in-visual-studio.md)
- [Общие сведения о модели работоспособности в Service Fabric](service-fabric-health-introduction.md)
- [Безопасность приложений и запуск от имени](service-fabric-application-runas-security.md)

<!--Image references-->
[SecurityConfigurations_01]: ./media/service-fabric-cluster-security/SecurityConfigurations_01.png
[SecurityConfigurations_02]: ./media/service-fabric-cluster-security/SecurityConfigurations_02.png
[Node-to-Node]: ./media/service-fabric-cluster-security/node-to-node.png
[Client-to-Node]: ./media/service-fabric-cluster-security/client-to-node.png

<!---HONumber=AcomDC_0427_2016-->