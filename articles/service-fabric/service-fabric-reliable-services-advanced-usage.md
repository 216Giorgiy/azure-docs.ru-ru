---
title: "Расширенное использование Reliable Services | Документация Майкрософт"
description: "Узнайте о расширенном использовании Service Fabric Reliable Services для повышения гибкости служб."
services: Service-Fabric
documentationcenter: .net
author: vturecek
manager: timlt
editor: masnider
ms.assetid: f2942871-863d-47c3-b14a-7cdad9a742c7
ms.service: Service-Fabric
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 02/10/2017
ms.author: vturecek
translationtype: Human Translation
ms.sourcegitcommit: eeb56316b337c90cc83455be11917674eba898a3
ms.openlocfilehash: 71a4ccb1914c147b1504068a09ef957a51067c08
ms.lasthandoff: 04/03/2017


---
# <a name="advanced-usage-of-the-reliable-services-programming-model"></a>Дополнительные возможности использования модели программирования надежных служб
Приложение Azure Service Fabric упрощает написание надежных служб с отслеживанием или без отслеживания состояния и управление ими. В этом руководстве пойдет речь о расширенном использовании Reliable Services для получения большей управляемости и гибкости служб. Перед чтением этого руководства ознакомьтесь с [моделью программирования надежных служб](service-fabric-reliable-services-introduction.md).

Службы с отслеживанием и без отслеживания состояния имеют две основные точки входа для пользовательского кода.

* `RunAsync(C#) / runAsync(Java)` — точка входа общего назначения для кода службы.
* `CreateServiceReplicaListeners(C#)` и `CreateServiceInstanceListeners(C#) / createServiceInstanceListeners(Java)` служат для открытия прослушивателей связи для клиентских запросов.

Этих двух точек входа достаточно для большинства служб. В редких случаях, когда необходим больший контроль над жизненным циклом службы, можно использовать дополнительные события жизненного цикла.

## <a name="stateless-service-instance-lifecycle"></a>Жизненный цикл экземпляра службы без отслеживания состояния
Жизненный цикл службы без отслеживания состояния очень прост. Службу без отслеживания состояния можно только открыть, закрыть или прервать ее работу. `RunAsync` в службе без отслеживания состояния выполняется при открытии экземпляра службы и отменяется, когда экземпляр службы закрывается или его работа прерывается.

Хотя `RunAsync` должно быть достаточно почти во всех случаях, также доступны события открытия, закрытия и прерывания службы без отслеживания состояния.

* `Task OnOpenAsync(IStatelessServicePartition, CancellationToken) - C# / CompletableFuture<String> onOpenAsync(CancellationToken) - Java`
   OnOpenAsync вызывается, когда требуется использовать экземпляр службы без отслеживания состояния. В этот момент можно запустить расширенные задачи инициализации службы.
* `Task OnCloseAsync(CancellationToken) - C# / CompletableFuture onCloseAsync(CancellationToken) - Java`
   OnCloseAsync вызывается, когда работу экземпляра службы без отслеживания состояния планируется корректно завершить. Это может произойти при обновлении кода службы, перемещении экземпляра службы в целях балансировки нагрузки или при обнаружении временной ошибки. Объект OnCloseAsync позволяет безопасно закрыть все ресурсы, остановить все фоновые задачи, завершить сохранение внешнего состояния или закрыть существующие соединения.
* `void OnAbort() - C# / void onAbort() - Java`
   OnAbort вызывается при принудительном завершении работы экземпляра службы без отслеживания состояния. Обычно такой вызов осуществляется при обнаружении на узле постоянной неисправности или когда платформа Service Fabric не может надежно управлять жизненным циклом экземпляра службы из-за внутренних сбоев.

## <a name="stateful-service-replica-lifecycle"></a>Жизненный цикл реплики службы с отслеживанием состояния

> [!NOTE]
> Сейчас Java не поддерживает службы Reliable Services с отслеживанием состояния.
>
>

Жизненный цикл реплики службы с отслеживанием состояния намного сложнее, чем экземпляра службы без отслеживания состояния. Кроме того событий открытия, закрытия и прерывания во время существования реплика службы с отслеживанием состояния подвергается изменениям роли. При изменении роли реплики службы с отслеживанием состояния активируется событие `OnChangeRoleAsync` .

* `Task OnChangeRoleAsync(ReplicaRole, CancellationToken)`
   OnChangeRoleAsync вызывается, когда реплика службы с отслеживанием состояния меняет роль, например с первичной на вторичную, или наоборот. Основным репликам присваивается статус записи (им разрешено создавать и записывать надежные коллекции), а дополнительным — статус чтения (могут только читать из существующих надежных коллекций). Большинство операций службы с отслеживанием состояния выполняется в основной реплике. Вторичные реплики могут выполнять проверку, предусматривающую только чтение, создавать отчеты, выполнять интеллектуальный анализ данных, а также другие задания, доступные только для чтения.

В службе с отслеживанием состояния только у первичной реплики есть доступ на запись состояния, используемый, когда служба выполняет фактическую работу. Метод `RunAsync` в службе с отслеживанием состояния выполняется только в том случае, когда реплика службы с отслеживанием состояния является первичной. Метод `RunAsync` отменяется при смене роли первичной реплики, а также во время событий закрытия и прерывания.

С помощью события `OnChangeRoleAsync` можно выполнять работу в зависимости от роли реплики, а также в ответ на изменение роли.

Кроме того, служба с отслеживанием состояния дает возможность использовать те же четыре события жизненного цикла, что и служба без отслеживания состояния, с такой же семантикой и вариантами использования.

```csharp
* Task OnOpenAsync(IStatefulServicePartition, CancellationToken)
* Task OnCloseAsync(CancellationToken)
* void OnAbort()
```

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные разделы, относящиеся к Service Fabric, приведены ниже.

* [Настройка надежных служб с отслеживанием состояния](service-fabric-reliable-services-configuration.md)
* [Общие сведения о работоспособности Service Fabric](service-fabric-health-introduction.md)
* [Использование отчетов о работоспособности системы для устранения неполадок](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)
* [Настройка служб с помощью диспетчера кластерных ресурсов Service Fabric](service-fabric-cluster-resource-manager-configure-services.md)

