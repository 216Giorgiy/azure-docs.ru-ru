<properties
   pageTitle="Обновление кластера Service Fabric | Microsoft Azure"
   description="Обновление кода структуры и (или) конфигурации с кластером Service Fabric, включая обновление сертификатов, добавление портов приложений, применение исправления для ОС и т. д. Чего можно ожидать при выполнении обновлений?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/23/2015"
   ms.author="chackdan"/>

# Обновление кластера Service Fabric

Кластер Service Fabric представляет собой принадлежащий вам ресурс, который частично управляется корпорацией Майкрософт. В этой статье содержатся сведения о компонентах, управляемых автоматически, и о том, что можно настроить самостоятельно.

## Конфигурация кластера, которая управляется автоматически

Корпорация Майкрософт поддерживает код структуры и конфигурацию, которые работают в кластере, и по мере необходимости выполняет автоматически отслеживаемые обновления программного обеспечения. Эти обновления могут затрагивать код, конфигурацию или и то, и другое. Чтобы обновления не затрагивали приложение или оказывали на него минимальное влияние, процесс обновления проходит в три этапа.

### Этап 1. Выполнение обновления с помощью всех политик работоспособности кластера

В ходе этого этапа обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В течение применения обновления действуют политики работоспособности кластера (это сочетание состояния работоспособности узла и всех приложений, выполняющихся в кластере).

Если политики работоспособности кластера не соблюдаются, выполняется откат обновления, владельцу подписки отправляется сообщение, информирующее о том, что пришлось откатить обновление кластера, указываются действия по устранению ошибок и сообщается о реализации этапа 2 через n дней. n — переменное значение. Мы пытаемся осуществить это же обновление еще несколько раз, чтобы исключить обновления, которые не удалось применить по связанным с инфраструктурой причинам, и через n дней с момента отправки сообщения мы перейдем к этапу 2.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторных запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется. (Это позволяет избежать отправки чрезмерного количества сообщений. Получение сообщения следует рассматривать как исключение из обычного режима. Мы надеемся, что большинство обновлений кластера будет выполнено без ущерба для доступности вашего приложения.)

Более подробные сведения о задании настраиваемых политик работоспособности для кластера см. в статье [Обновление кластера и параметры работоспособности](service-fabric-cluster-health-parameters.md).

### Этап 2. Выполнение обновления с помощью только политик работоспособности по умолчанию

Политики работоспособности задаются таким образом, что ряд приложений, которые были работоспособны в начале обновления, остаются неизменными в течение всего процесса обновления. Как и на этапе 1, в ходе этого этапа обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В течение применения обновления действуют политики работоспособности кластера (это сочетание состояния работоспособности узла и всех приложений, выполняющихся в кластере).

Если политики работоспособности кластера не соблюдаются, выполняется откат обновления, владельцу подписки отправляется сообщение, информирующее о том, что пришлось откатить обновление кластера, предпринять действия по устранению ошибок, а этап 3 будет реализован через указанное число дней.

Мы пытаемся выполнить это же обновление еще несколько раз, чтобы исключить обновления, которые не удалось применить по связанным с инфраструктурой причинам. За несколько дней до назначенного срока владельцу подписки отправляется сообщение с напоминанием. Через n дней с момента отправки сообщения мы переходим к этапу 3. К сообщениям, которые отправляются на этапе 2, следует отнестись серьезно и выполнить действия по устранению ошибок.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторных запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

### Этап 3. Выполнение обновления с помощью жестких политик работоспособности кластера

Эти политики работоспособности предназначены для выполнения обновления, а не обеспечения работоспособности приложений. На этом этапе выполняется очень мало обновлений кластера. Если ваш кластер достигает этого этапа, существует возможность, что приложение перейдет в неработоспособное состояние или будет недоступно.

Как и на других двух этапах, обновления на этапе 3 применяются к одному домену обновления за раз.

Если действующие политики работоспособности кластера не соблюдаются, выполняется откат обновления. Мы пытаемся выполнить это же обновление еще несколько раз, чтобы исключить обновления, которые не удалось применить по связанным с инфраструктурой причинам. После этого кластер закрепляется так, что он больше не будет получать поддержку и обновления.

Владельцу подписки будет отправлено соответствующие сообщение с указанием действий по устранению ошибок. Мы не ожидаем, что кластеры перейдут в состояние при сбое этапа 3.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторных запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

## Управляемая пользователем конфигурация кластера

Ниже перечислены конфигурации, которые можно изменять в динамическом кластере.

### Сертификаты

Основные или дополнительные сертификаты можно без труда обновить с портала или с помощью команды PUT в ресурсе servicefabric.cluster.

![CertificateUpgrade][CertificateUpgrade]

### Порты приложения

Это можно сделать, изменив свойства ресурса балансировщика нагрузки, связанные с типом узла. Можно использовать портал или ARM PowerShell.

Чтобы открыть новый порт на всех виртуальных машинах в типе узла, необходимо выполнить следующие действия.

1. **Добавление новых проб в соответствующий балансировщик нагрузки**

    Если вы развернули кластер с помощью портала, балансировщик нагрузки получит имя "loadBalancer- 0", "loadBalancer-1" и т. д. по одному для каждого типа узла. Поскольку имена балансировщиков нагрузки являются уникальными только в группе ресурсов, рекомендуется искать их в данной группе ресурсов.

    ![AddingProbes][AddingProbes]


2. **Добавление нового правила в балансировщик нагрузки**

    В тот же балансировщик нагрузки добавьте новое правило, используя пробу, созданную на предыдущем шаге.

    ![AddingLBRules][AddingLBRules]


### Свойства размещения

  Для каждого типа узла можно добавить настраиваемые свойства размещения, которые будут использоваться в приложениях. NodeType — это свойство по умолчанию, которое можно использовать без его явного добавления.

  >[AZURE.NOTE]Сведения об использовании свойства размещения см. в [документации по ограничениям размещения](service-fabric-placement-constraint.md).

### Метрики емкости

Для каждого типа узла можно добавить настраиваемые метрики емкости, которые будут использоваться в приложениях для передачи данных о нагрузке. Сведения об использовании метрик емкости для отчетов о нагрузке см. в [обзоре передачи данных о динамической нагрузке](service-fabric-resource-balancer-dynamic-load-reporting.md).

### Применение исправлений ОС к виртуальным машинам, входящим в состав кластера
Это функция будет выпущена в будущем. В настоящее время вы отвечаете за применение исправлений к виртуальным машинам. Исправления применяются к одной машине за раз, поэтому в определенный момент в нерабочем состоянии будет находиться только одна виртуальная машина.

### Обновление операционной системы на виртуальных машинах, входящих в состав кластера
Обновление используемого образа ОС выполняется на одной виртуальной машине за раз. Ответственность за это обновление лежит на вас. В настоящее время автоматизация не поддерживается.


## Дальнейшие действия

- Узнайте о [масштабировании кластера](service-fabric-cluster-scale-up-down.md).
- Узнайте об [обновлениях приложений](service-fabric-application-upgrade.md).

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

<!---HONumber=AcomDC_1125_2015-->