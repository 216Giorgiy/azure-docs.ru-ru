<properties
   pageTitle="Обновление кластера Service Fabric | Microsoft Azure"
   description="Обновление кода и/или конфигурации Service Fabric, под управлением которых работает кластер Service Fabric, включая обновление сертификатов, добавление портов приложений, применение исправлений для ОС и т. д. Чего можно ожидать при выполнении обновлений?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="chackdan"/>

# Обновление кластера Service Fabric

Кластер Service Fabric Azure представляет собой ресурс, который принадлежит вам, но частично управляется корпорацией Майкрософт. В этой статье содержатся сведения о компонентах, управляемых автоматически, и о том, что можно настроить самостоятельно.

## Конфигурация кластера, которая управляется автоматически

Корпорация Майкрософт поддерживает код структуры, а также конфигурации, которые выполняются в кластере. По мере необходимости мы выполняем автоматические контролируемые обновления программного обеспечения. Эти обновления могут затрагивать код, конфигурацию или и то, и другое. Чтобы обновления не затрагивали приложение или оказывали на него минимальное влияние, процесс обновления проходит в три этапа, которые описаны ниже.

### Этап 1. Выполнение обновления с помощью всех политик работоспособности кластера

В ходе этого этапа обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В течение применения обновления действуют политики работоспособности кластера (это сочетание состояния работоспособности узла и всех приложений, выполняющихся в кластере).

Если политики работоспособности кластера не соблюдаются, происходит откат обновления, и владельцу подписки отправляется оповещение по электронной почте. Оно содержит следующую информацию:

- Уведомление о том, что нам пришлось выполнить откат обновления кластера.
- Рекомендуемые действия по решению проблемы, при их наличии.
- Количество дней (n) до выполнения этапа 2.

Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. Через n дней с момента отправки сообщения мы переходим к этапу 2.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется. Это позволяет избежать отправки чрезмерного количества сообщений. Получение сообщения следует рассматривать как исключение из обычного режима. Мы надеемся, что большинство обновлений кластера будет выполнено без ущерба для доступности вашего приложения.

### Этап 2. Выполнение обновления с помощью только политик работоспособности по умолчанию

Политики работоспособности задаются таким образом, что ряд приложений, которые были работоспособны в начале обновления, остаются неизменными в течение всего процесса обновления. В ходе этапа 2, как и на этапе 1, обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В течение применения обновления действуют политики работоспособности кластера (это сочетание состояния работоспособности узла и всех приложений, выполняющихся в кластере).

Если применяемые политики работоспособности кластера не соблюдаются, происходит откат обновления, и владельцу подписки отправляется оповещение по электронной почте. Оно содержит следующую информацию:

- Уведомление о том, что нам пришлось выполнить откат обновления кластера.
- Рекомендуемые действия по решению проблемы, при их наличии.
- Количество дней (n) до выполнения этапа 3.

Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. За несколько дней до назначенного срока владельцу подписки отправляется сообщение с напоминанием. Через n дней с момента отправки сообщения мы переходим к этапу 3. К сообщениям, которые отправляются на этапе 2, следует отнестись серьезно и выполнить действия по устранению ошибок.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

### Этап 3. Выполнение обновления с помощью жестких политик работоспособности кластера

Эти политики работоспособности предназначены для выполнения обновления, а не обеспечения работоспособности приложений. На этом этапе выполняется очень мало обновлений кластера. Если ваш кластер достигает этого этапа, есть высокая вероятность того, что ваше приложение перейдет в неработоспособное состояние или будет недоступно.

Как и на других двух этапах, обновления на этапе 3 применяются к одному домену обновления за раз.

Если применяемые политики работоспособности кластера фактически не соблюдаются, выполняется откат обновления. Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. После этого кластер закрепляется и больше не будет получать поддержку и обновления.

Сообщение с этими сведениями и корректирующими действиями будет отправлено владельцу подписки. Мы не ожидаем перехода кластеров в состояние, в котором произошел сбой этапа 3.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

## Управляемая пользователем конфигурация кластера

Ниже перечислены конфигурации, которые можно изменять в динамическом кластере.

### Сертификаты

Основные или дополнительные сертификаты можно без труда обновить с портала (как показано ниже) или выполнив команду PUT для ресурса servicefabric.cluster.

![Снимок экрана, демонстрирующий отпечатки сертификатов на портале Azure.][CertificateUpgrade]

>[AZURE.NOTE] Перед идентификацией сертификата, который вы хотите использовать для ресурсов кластера, необходимо выполнить описанные ниже действия, иначе новые сертификаты не будут использоваться. 1. Загрузите новый сертификат в хранилище ключей. Инструкции см. в статье [Защита кластера Service Fabric](service-fabric-cluster-security.md). Начните с шага 2 в этом документе. 2. Обновите все виртуальные машины в составе кластера, чтобы развернуть на них сертификат. Для этого обратитесь к [Блогу команды разработчиков хранилища ключей Azure](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx).

### Порты приложения

Порты приложения можно изменить путем изменения свойств ресурса балансировщика нагрузки, связанных с типом узла. Для этого можно использовать портал или диспетчер ресурсов PowerShell напрямую.

Чтобы открыть новый порт на всех виртуальных машинах в типе узла, необходимо выполнить следующие действия:

1. Добавьте новую проверку к соответствующему балансировщику нагрузки.

    Если вы развернули кластер с помощью портала, балансировщики нагрузки получат имена "loadBalancer- 0", "loadBalancer-1" и т. д. по одному для каждого типа узла. Поскольку имена балансировщиков нагрузки являются уникальными только в группе ресурсов, рекомендуется искать их в данной группе ресурсов.

    ![Снимок экрана, демонстрирующий добавление проверки к балансировщику нагрузки на портале.][AddingProbes]

2. Добавьте новое правило к балансировщику нагрузки.

    Добавьте в тот же балансировщик нагрузки новое правило, используя проверку, созданную на предыдущем шаге.

    ![Снимок экрана, демонстрирующий добавление нового правила к балансировщику нагрузки на портале.][AddingLBRules]


### Свойства размещения

Для каждого типа узла можно добавить настраиваемые свойства размещения, которые будут использоваться в приложениях. NodeType — это свойство по умолчанию, которое можно использовать без его явного добавления.

>[AZURE.NOTE] Сведения об использовании свойств размещения см. в статье [Общие сведения об ограничениях на размещение](service-fabric-placement-constraint.md).

### Метрики емкости

Для каждого типа узла можно добавить настраиваемые метрики емкости, которые будут использоваться в приложениях для передачи данных о нагрузке. Сведения об использовании метрик емкости для отчетов о нагрузке см. в статье [Общие сведения о передаче данных о динамической нагрузке](service-fabric-resource-balancer-dynamic-load-reporting.md).

### Исправления ОС на виртуальных машинах, составляющих кластер

Эта функция будет реализована как автоматическая. Но сегодня за применение исправлений к виртуальным машинам отвечаете вы. Необходимо делать это по очереди для каждой виртуальной машины, чтобы не отключать более одной виртуальной машины в один момент времени.

### Обновления ОС на виртуальных машинах, составляющих кластер

При обновлении используемого образа ОС на виртуальных машинах необходимо делать это поочередно для каждой виртуальной машины, и ответственность за это обновление лежит на вас. В настоящее время автоматизация не поддерживается.

## Дальнейшие действия

- Узнайте о [масштабировании кластера](service-fabric-cluster-scale-up-down.md).
- Узнайте об [обновлениях приложений](service-fabric-application-upgrade.md).

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

<!---HONumber=AcomDC_0218_2016-->