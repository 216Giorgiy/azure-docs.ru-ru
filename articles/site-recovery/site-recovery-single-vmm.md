
<properties
	pageTitle="Azure Site Recovery: репликация виртуальных машин Hyper-V на обособленный сервер VMM | Microsoft Azure"
	description="В этой статье описывается, как выполнить репликацию виртуальных машин Hyper-V, если имеется только один сервер VMM."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="backup-recovery"
	ms.date="07/06/2016"
	ms.author="raynew"/>

#  Репликация виртуальных машин Hyper-V на обособленный сервер VMM

Прочтите эту статью, чтобы узнать, как выполнить репликацию виртуальных машин Hyper-V, расположенных на сервере узла Hyper-V в облаке VMM, если в развертывании доступен только один сервер VMM.

Если после прочтения статьи у вас возникнут какие-либо вопросы, вы можете задать их в конце этой статьи или на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Обзор

Виртуальные машины Hyper-V, размещенные на узлах Hyper-V в облаках VMM, можно реплицировать двумя способами:

- Репликация в Azure
- Репликация на дополнительный сайт VMM

Но что произойдет, если вы хотите выполнить репликацию в дополнительное расположение VMM, а в развертывании есть только один сервер VMM?

В этом случае у вас есть два варианта:

- Репликация виртуальных машин Hyper-V из облаков VMM в Azure. Дополнительные сведения об этом сценарии см. [здесь](site-recovery-vmm-to-azure.md).
- Репликация между облаками на одном сервере VMM.

Рекомендуется использовать первый вариант, поскольку отработка отказа и восстановление во втором случае не выполняются автоматически, и ряд действий придется выполнить вручную. Если вы предпочитаете репликацию между сайтами, а не репликацию в Azure, у вас есть несколько вариантов.


## Репликация между сайтами с одним автономным сервером VMM

Для репликации между сайтами в этом сценарии вы развертываете отдельный сервер VMM в качестве виртуальной машины на основном сайте и реплицируете эту виртуальную машину на дополнительный сайт с помощью Site Recovery и реплики Hyper-V. Для этого:

1. Настройте VMM на виртуальной машине Hyper-V. При этом рекомендуется расположить экземпляр SQL Server, используемый VMM, на той же виртуальной машине. Это экономит время, так как требуется создавать экземпляр только одной виртуальной машины. Если вы используете удаленный экземпляр SQL Server и возникает сбой, вам потребуется восстановить этот экземпляр перед восстановлением VMM.
2. Убедитесь, что на каждом сервере VMM настроено по крайней мере два облака. Одно облако будет содержать виртуальные машины, которые требуется реплицировать, а другое облако будет использоваться в качестве дополнительного расположения. Облако, содержащее виртуальные машины, которые необходимо защитить, должно иметь:

	- Одну или несколько групп узлов VMM, содержащих один или несколько серверов узлов Hyper-V в каждой группе узлов.
	- По крайней мере одну виртуальную машину Hyper-V на каждом сервере узла Hyper-V.
3. Создайте хранилище Site Recovery, создайте и скачайте регистрационный ключ хранилища и зарегистрируйте сервер VMM в хранилище. Во время регистрации вы установите поставщик Azure Site Recovery на сервере VMM.
4. Настройте одно или несколько облаков на виртуальной машине VMM и добавьте узлы Hyper-V, содержащие виртуальные машины, которые требуется защитить, в эти облака.
3. В Azure Site Recovery настройте параметры защиты для облаков. В полях исходного расположения и целевого расположения укажите имя одного VMM-сервера. При настройке сетевого сопоставления вы сопоставляете сеть виртуальных машин для облака, которое содержит защищаемые виртуальные машины, с сетью виртуальных машин для облака, в которое требуется выполнить репликацию.
4. Включите репликацию для защищаемых виртуальных машин, используя метод репликации **По сети**, так как оба облака расположены на одном сервере.
4. В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины. Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.
5. Если вы хотите создать планы восстановления, укажите один сервер VMM в качестве исходного и целевого.

Для создания хранилища, получения ключа, регистрации сервера и настройки защиты следуйте инструкциям в [этой статье](site-recovery-vmm-to-vmm.md).

### После сбоя

При возникновении сбоя восстановление рабочих нагрузок на виртуальных машинах Hyper-V осуществляется следующим образом:

1. Выполните отработку отказа для реплики виртуальной машины VMM вручную на дополнительный сайт, используя диспетчер Hyper-V с плановой отработкой отказа.
2. После восстановления виртуальной машины VMM вы можете войти в диспетчер восстановления Hyper-V с дополнительного сайта и выполнить незапланированную отработку отказа для виртуальных машин с основного сайта на дополнительный сайт. Обратите внимание, что для виртуальной машины VMM необходимо вручную выполнить отработку отказа на вторичный сайт. Только после этого можно выполнить отработку отказа для виртуальных машин рабочих нагрузок.
3. После завершения незапланированной отработки все ресурсы снова будут доступны на основном сайте.


![Автономный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-standalone.png)

## Репликация между сайтами с одним сервером VMM в растянутом кластере

Вместо развертывания отдельного сервера VMM в качестве виртуальной машины, которая реплицируется на дополнительный сайт, можно сделать сервер VMM высокодоступным, развернув его в качестве виртуальной машины в отказоустойчивом кластере Windows. Это позволяет обеспечить устойчивость рабочих нагрузок и защиту от сбоев оборудования. Для развертывания с Site Recovery виртуальная машина VMM должна быть развернута в кластере, растянутом по географически разделенным сайтам. Для этого:

1. Установите VMM на виртуальных машинах в отказоустойчивом кластере Windows и укажите, что сервер должен быть высокодоступным, во время установки.
2. Экземпляр SQL Server, используемый VMM, должен реплицироваться с помощью групп доступности SQL Server AlwaysOn, чтобы на дополнительном сайте присутствовала реплика базы данных.

Обратите внимание, что при настройке Site Recovery необходимо зарегистрировать каждый сервер VMM в кластере в хранилище Site Recovery. Для этого установите поставщик на активном узле и завершите установку, чтобы зарегистрировать этот сервер VMM в хранилище. Затем установите поставщик на других узлах.
 
### После сбоя 

При возникновении сбоя сервер VMM и его соответствующая база данных SQL Server переносятся на дополнительный сайт, где они становятся доступными.

![Кластеризованный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-cluster.png)

## Дальнейшие действия

[Ознакомьтесь с дополнительными сведениями](site-recovery-vmm-to-vmm.md) о подробном развертывании Site Recovery для репликации с VMM на VMM.




 

<!---HONumber=AcomDC_0706_2016-->