
---
title: 'Azure Site Recovery: репликация виртуальных машин Hyper-V на обособленный сервер VMM | Microsoft Docs'
description: В этой статье описывается, как выполнить репликацию виртуальных машин Hyper-V, если имеется только один сервер VMM.
services: site-recovery
documentationcenter: ''
author: rayne-wiselman
manager: jwhit
editor: ''

ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: backup-recovery
ms.date: 08/24/2016
ms.author: raynew

---
# Репликация виртуальных машин Hyper-V на обособленный сервер VMM
Прочтите эту статью, чтобы узнать, как выполнить репликацию виртуальных машин Hyper-V, расположенных на сервере узла Hyper-V в облаке VMM, если в развертывании доступен только один сервер VMM.

В Azure предлагаются две [модели развертывания](../resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager и классическая модель. Кроме того, Azure предоставляет два портала — классический портал Azure, поддерживающий классическую модель развертывания, и портал Azure, поддерживающий обе модели развертывания. Эта статья содержит инструкции по настройке репликации на портале Azure.

Если после прочтения этой статьи у вас возникнут какие-либо вопросы, вы можете задать их на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr), или оставить свои комментарии в конце статьи в разделе Disqus.

## Обзор
Если вы планируете выполнять репликацию виртуальных машин Hyper-V, размещенных на узлах Hyper-V в VMM, и у вас есть только один сервер VMM, то вы можете [выполнить репликацию в Azure](site-recovery-vmm-to-azure.md) или между облаками на одном сервере VMM.

Рекомендуется выполнять репликацию в Azure, так как при репликации между облаками отработка отказа и восстановление не всегда проходят без затруднений, и может потребоваться ряд корректирующих действий. Если вы хотите выполнить репликацию, используя только сервер VMM, можно сделать следующее:

* выполнить репликацию, используя один изолированный сервер VMM;
* выполнить репликацию, используя обособленный сервер VMM в растянутом кластере Windows.

## Репликация между сайтами с одним автономным сервером VMM
![Автономный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-standalone.png)

В этом сценарии вы развертываете обособленный сервер VMM в качестве виртуальной машины на первичном сайте и реплицируете эту виртуальную машину на вторичный сайт с помощью Site Recovery и реплики Hyper-V.

1. Настройте VMM на виртуальной машине Hyper-V. Для экономии времени рекомендуется установить экземпляр SQL Server, используемый VMM, на той же виртуальной машине. Если вы хотите использовать удаленный экземпляр SQL Server, то в случае сбоя вам потребуется восстановить этот экземпляр перед восстановлением VMM.
2. Убедитесь, что на каждом сервере VMM настроено по крайней мере два облака. Одно облако содержит виртуальные машины, которые требуется реплицировать, а другое облако используется в качестве дополнительного расположения. Облако, содержащее виртуальные машины, которые необходимо защитить, должно иметь:
   
   * Одну или несколько групп узлов VMM, содержащих один или несколько серверов узлов Hyper-V в каждой группе узлов.
   * По крайней мере одну виртуальную машину Hyper-V на каждом сервере узла Hyper-V.
3. Создайте хранилище служб восстановления, создайте и скачайте регистрационный ключ хранилища и зарегистрируйте сервер VMM в хранилище. Во время регистрации вы установите поставщик Azure Site Recovery на сервере VMM.
4. Настройте одно или несколько облаков на виртуальной машине VMM и добавьте в эти облака узлы Hyper-V.
5. Настройте параметры защиты для облаков. Укажите имя обособленного сервера VMM в полях исходного расположения и целевого расположения. Для настройки сетевого сопоставления сопоставьте сеть виртуальных машин для облака и защищаемые виртуальные машины с сетью виртуальных машин для облака репликации.
6. Включите начальную репликацию для защищаемых по сети виртуальных машин, так как оба облака расположены на одном сервере.
7. В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины. Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery. Это необходимо, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.
8. Если вы хотите создать планы восстановления, укажите один сервер VMM в качестве исходного и целевого.

Следуйте инструкциям, приведенным в [этой статье](site-recovery-vmm-to-vmm.md), чтобы создать хранилище, зарегистрировать сервер и настроить защиту.

### Что делать в случае сбоя?
Если произошла полная остановка работы и вам необходимо воспользоваться вторичным сайтом, выполните перечисленные ниже действия.

1. В консоли диспетчера Hyper-V на вторичном сайте выполните внеплановую отработку отказа, чтобы перенести виртуальную машину VMM с первичного сайта на вторичный.
2. Убедитесь, что виртуальной машина VMM запущена и работает на вторичном сайте.
3. В хранилище служб восстановления выполните внеплановую отработку отказа, чтобы перенести виртуальные машины рабочих нагрузок из основного облака в дополнительное. Для завершения внеплановой отработки отказа виртуальных машин необходимо применить отработку отказа или выбрать другую точку восстановления.
4. По завершении внеплановой отработки отказа пользователи получат доступ к ресурсам рабочих нагрузок на вторичном сайте.

Когда первичный сайт вернется к нормальной работе, выполните перечисленные ниже действия.

1. В консоли диспетчера Hyper-V включите обратную репликацию виртуальной машины VMM, чтобы начать ее репликацию со вторичного сайта на первичный.
2. В консоли диспетчера Hyper-V выполните плановую отработку отказа, чтобы восстановить виртуальную машину VMM на первичном сайте. Примените отработку отказа, чтобы завершить ее. Затем включите обратную репликацию, чтобы начать репликацию VMM с первичного сайта на вторичный.
3. В хранилище служб восстановления включите обратную репликацию виртуальных машин рабочих нагрузок, чтобы начать их репликацию со вторичного сайта на первичный.
4. В хранилище служб восстановления выполните плановую отработку отказа, чтобы восстановить виртуальные машины рабочих нагрузок на первичном сайте. Примените отработку отказа, чтобы завершить ее. Затем включите обратную репликацию, чтобы начать репликацию виртуальных машин рабочих нагрузок с первичного сайта на вторичный.

## Репликация между сайтами с одним сервером VMM в растянутом кластере
![Кластеризованный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-cluster.png)

Вместо развертывания изолированного сервера VMM в качестве виртуальной машины, которая реплицируется на вторичный сайт, можно сделать сервер VMM высокодоступным, развернув его в качестве виртуальной машины в отказоустойчивом кластере Windows. Это позволяет обеспечить устойчивость рабочих нагрузок и защиту от сбоев оборудования. Для развертывания с Site Recovery виртуальная машина VMM должна быть развернута в кластере, растянутом по географически разделенным сайтам. Для этого:

1. Установите VMM на виртуальной машине в отказоустойчивом кластере Windows и укажите, что во время установки сервер должен быть высокодоступным.
2. Экземпляр SQL Server, используемый VMM, должен реплицироваться с помощью групп доступности SQL Server AlwaysOn, чтобы на дополнительном сайте присутствовала реплика базы данных.
3. Следуйте инструкциям, приведенным в [этой статье](site-recovery-vmm-to-vmm.md), чтобы создать хранилище, зарегистрировать сервер и настроить защиту. Необходимо зарегистрировать каждый сервер VMM в кластере в хранилище служб восстановления. Для этого установите поставщик на активном узле и зарегистрируйте сервер VMM. Затем установите поставщик на других узлах.

### Что делать в случае сбоя?
При возникновении сбоя сервер VMM и его соответствующая база данных SQL Server переносятся на вторичный сайт, где они становятся доступными.

## Дальнейшие действия
[Ознакомьтесь с дополнительными сведениями](site-recovery-vmm-to-vmm.md) о подробном развертывании Site Recovery для репликации с VMM на VMM.

<!---HONumber=AcomDC_0824_2016-->