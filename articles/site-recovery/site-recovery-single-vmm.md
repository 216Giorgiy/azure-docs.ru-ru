
<properties
	pageTitle="Azure Site Recovery: репликация виртуальных машин Hyper-V (один сервер VMM)"
	description="Azure Site Recovery предназначен для выполнения таких операций, как репликация виртуальных машин, размещенных в локальных облаках VMM на Azure, отработка их отказа, а также восстановление."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="backup-recovery"
	ms.date="12/01/2015"
	ms.author="raynew"/>

#  Azure Site Recovery: репликация виртуальных машин Hyper-V (один сервер VMM)

Служба Azure Site Recovery вносит свой вклад в работу надежного решения по обеспечению непрерывности бизнес-процессов и аварийного восстановления, осуществляя оркестрацию и автоматизируя репликацию ваших локальных физических серверов и виртуальных машин в Azure или в дополнительный локальный центр обработки данных. Эта статья описывает процесс развертывания Site Recovery для защиты виртуальных машин Hyper-V, расположенных в облаке VMM, если в развертывании доступен только один сервер VMM. Если после прочтения статьи у вас возникнут какие-либо вопросы, вы можете задать их на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Обзор

Вы можете реплицировать виртуальные машины Hyper-V двумя способами.

- Реплицируйте виртуальные машины Hyper-V, находящиеся на узлах Hyper-V, которые не находятся в облаке VMM, в Azure.
- Реплицируйте виртуальные машины Hyper-V, находящиеся на узлах Hyper-V, в Azure.
- Реплицируйте виртуальные машины Hyper-V, находящиеся на узлах Hyper-V, в Azure.

Но что произойдет, если вы хотите использовать VMM, но имеете в инфраструктуре всего один сервер VMM?

В этом случае у вас есть два варианта.

- Реплицируйте виртуальные машины Hyper-V из ваших облаков VMM в Azure. Дополнительные сведения об этом сценарии см. [здесь](site-recovery-vmm-to-azure.md).
- Выполняйте репликацию между облаками на одном сервере VMM.

Рекомендуется использовать первый вариант, поскольку отработка отказа и восстановление во втором случае не являются полностью интегрированными, поэтому необходимо выполнить ряд действий вручную.


### Репликация между сайтами с одним автономным сервером VMM

В этом сценарии вы развертываете отдельный автономный сервер VMM в качестве виртуальной машины на основном сайте и реплицируете эту виртуальную машину на дополнительный сайт с помощью Site Recovery и реплики Hyper-V. Для этого:

1. Настройте VMM на виртуальной машине Hyper-V. Рекомендуется расположить экземпляр SQL Server, используемый VMM, на той же виртуальной машине. Это экономит время, так как требуется создавать экземпляр только одной виртуальной машины. Если вы хотите использовать удаленный экземпляр и возникает сбой, вам потребуется восстановить этот экземпляр перед восстановлением VMM.
2. Убедитесь, что на каждом сервере VMM настроено по крайней мере два облака. Одно облако будет содержать виртуальные машины, которые требуется реплицировать, а другое облако будет использоваться в качестве дополнительного расположения. Облако с виртуальными машинами, которые требуется защитить, должно иметь одну или несколько групп узлов VMM, каждая из которых содержит один или несколько серверов узлов Hyper-V, при этом на каждом сервере узла должна присутствовать хотя бы одна виртуальная машина Hyper-V.
2. Создайте хранилище Site Recovery, создайте и скачайте регистрационный ключ хранилища и зарегистрируйте сервер VMM в хранилище.
2. Настройте одно или несколько облаков на виртуальной машине VMM и добавьте узлы Hyper-V, содержащие виртуальные машины, которые требуется защитить, в эти облака.
3. В Azure Site Recovery настройте параметры защиты для облаков. В полях исходного расположения и целевого расположения укажите имя одного VMM-сервера. При настройке сетевого сопоставления вы сопоставляете сеть виртуальных машин для облака, которое содержит защищаемые виртуальные машины, с сетью виртуальных машин для облака, в которое требуется выполнить репликацию.
4. Включите репликацию для защищаемых виртуальных машин, используя метод репликации **По сети**, так как оба облака расположены на одном сервере.
4. В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины. Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.
5. Если вы хотите создать планы восстановления, укажите один сервер VMM в качестве исходного и целевого. 

При возникновении сбоев восстановление рабочих нагрузок на виртуальных машинах Hyper-V осуществляется следующим образом.

1. Вручную выполните отработку отказа реплики виртуальной машины VMM на дополнительный сайт, используя диспетчер Hyper-V с плановой отработкой отказа.
2. После восстановления виртуальной машины VMM вы можете войти в диспетчер восстановления Hyper-V с дополнительного сайта и выполнить незапланированную отработку отказа виртуальных машин с основного сайта на дополнительный сайт.
3. После завершения незапланированной отработки отказа пользователям будут доступны все ресурсы на основном объекте.

Обратите внимание, что ВМ с VMM необходимо будет переключить на вторичный объект вручную и только после этого можно будет переключить рабочие нагрузки.

![Автономный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-standalone.png)

### Репликация между сайтами с одним сервером VMM в растянутом кластере

Вместо развертывания автономного сервера VMM в качестве виртуальной машины, которая реплицируется на дополнительный сайт, вы можете сделать VMM высокодоступным, развернув его в качестве виртуальной машины в отказоустойчивом кластере Windows для обеспечения устойчивости рабочих нагрузок и защиты от сбоев оборудования. Для развертывания с Site Recovery сервер VMM должен быть развернут в кластере, растянутом по географически разделенным сайтам. Для этого:

1. Установите VMM на виртуальных машинах в отказоустойчивом кластере Windows и выберите во время установки параметр для запуска сервера с высокой доступностью.
2. Экземпляр SQL Server, используемый VMM, должен реплицироваться с помощью групп доступности AlwaysOn SQL Server, чтобы на дополнительном сайте присутствовала реплика базы данных. 

В случае возникновения сбоев сервер VMM и его соответствующая база данных SQL Server переносятся на дополнительный сайт, где они становятся доступны.

![Кластеризованный виртуальный сервер VMM](./media/site-recovery-single-vmm/single-vmm-cluster.png)




 

<!---HONumber=AcomDC_1203_2015-->