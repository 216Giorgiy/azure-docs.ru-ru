---
title: Перенос виртуальных машин IaaS Azure в другой регион Azure с помощью службы Azure Site Recovery | Документация Майкрософт
description: Используйте службу Azure Site Recovery для переноса виртуальных машин IaaS Azure из одного региона Azure в другой.
services: site-recovery
author: rajani-janaki-ram
ms.service: site-recovery
ms.topic: tutorial
ms.date: 01/28/2019
ms.author: rajanaki
ms.custom: MVC
ms.openlocfilehash: c1171a6b118797c2aafda137ec532259921c0713
ms.sourcegitcommit: 50ea09d19e4ae95049e27209bd74c1393ed8327e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/26/2019
ms.locfileid: "56880552"
---
# <a name="move-azure-vms-to-another-region"></a>Перенос виртуальных машин Azure в другой регион

Существуют различные сценарии, когда следует переместить существующие виртуальные машины Azure IaaS из одного региона в другой для повышения надежности и доступности ваших существующих виртуальных машин, для улучшения управляемости или из-за причин системы управления и т. д., как описано [здесь](azure-to-azure-move-overview.md). Службу [Azure Site Recovery](site-recovery-overview.md) можно использовать не только для управления и координации аварийного восстановления локальных компьютеров и виртуальных машин Azure в целях обеспечения непрерывности бизнеса и аварийного восстановления (BCDR), но и для управления миграцией виртуальных машин Azure в дополнительный регион.       

В этом руководстве показано, как выполнить перенос виртуальных машин Azure в другой регион с помощью Azure Site Recovery. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * [Проверка предварительных требований](#verify-prerequisites).
> * [Подготовка исходных виртуальных машин](#prepare-the-source-vms).
> * [Подготовка целевого региона](#prepare-the-target-region).
> * [Копирование данных в целевой регион.](#copy-data-to-the-target-region)
> * [Тестирование конфигурации.](#test-the-configuration) 
> * [Выполнение перемещения.](#perform-the-move-to-the-target-region-and-confirm) 
> * [Отмена ресурсов в исходном регионе.](#discard-the-resource-in-the-source-region) 

> [!IMPORTANT]
> В этом документе описывается, как переместить виртуальные машины Azure из одного региона в другой без их изменения. Если вам необходимо повысить уровень доступности, переместив виртуальные машины в группе доступности на виртуальные машины, прикрепленные к зонам, в другом регионе, см. это [руководство](move-azure-VMs-AVset-Azone.md).

## <a name="verify-prerequisites"></a>Проверка предварительных требований

- Убедитесь, что в регионе Azure, из которого необходимо выполнить миграцию, есть виртуальные машины Azure.
- Проверьте, поддерживается ли выбранная вами [комбинация исходного и целевого региона](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-support-matrix#region-support), и примите взвешенное решение о целевом регионе.
- Вам должны быть понятны [архитектура и компоненты сценария](azure-to-azure-architecture.md).
- Просмотрите [ограничения и требования для поддержки](azure-to-azure-support-matrix.md).
- Проверка разрешений учетной записи. Если вы создали бесплатную учетную запись Azure, тогда вы являетесь администратором подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Чтобы включить репликацию для виртуальной машины и в конечном итоге скопировать данные с помощью Azure Site Recovery, необходимо следующее.

    1. Разрешения на создание виртуальной машины в ресурсах Azure. Встроенная роль "Участник виртуальных машин" обладает такими разрешениями:
        - разрешение на создание виртуальной машины в выбранной группе ресурсов;
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в выбранной учетной записи хранения.

    2. Кроме того, требуется разрешение на управление операциями Azure Site Recovery. Роль "Участник Site Recovery" имеет все разрешения, необходимые для управления операциями Azure Site Recovery в хранилище служб восстановления.

## <a name="prepare-the-source-vms"></a>Подготовка исходных виртуальных машин.

1. Убедитесь, что на виртуальных машинах Azure, которые следует перенести, установлены все новейшие корневые сертификаты. Если такие сертификаты отсутствуют, копирование данных в целевой регион невозможно включить из-за ограничений по соображениям безопасности.

    - При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать присутствие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификатам в вашей организации.
    - На виртуальных машинах Linux выполните инструкции распространителя Linux, чтобы установить на виртуальные машины все свежие доверенные корневые сертификаты и список отзыва сертификатов.
2. Убедитесь, что для переносимых виртуальных машин не используется прокси-сервер аутентификации для управления подключением к сети.
3. Если виртуальная машина, которую вы пытаетесь переместить, не имеет доступа к Интернету и использует прокси-сервер брандмауэра для управления исходящим доступом, проверьте требования [здесь](azure-to-azure-tutorial-enable-replication.md#configure-outbound-network-connectivity).
4. Определите исходный сетевой макет и все ресурсы, которые вы сейчас используете, включая подсистемы балансировки нагрузки, группы безопасности сети, общедоступные IP-адреса и т. д.

## <a name="prepare-the-target-region"></a>Подготовка целевого региона

1. Убедитесь, что подписка Azure позволяет создавать виртуальные машины в целевом регионе, используемом для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить необходимые квоты.

2. Убедитесь, что подписка располагает достаточными ресурсами для поддержки виртуальных машин таких же размеров, которые установлены для исходных виртуальных машин. Если для копирования данных в целевой объект вы используете Site Recovery, эта служба выберет для целевой виртуальной машины такой же или другой наиболее подходящий размер.

3. Убедитесь, что вы создали целевой ресурс для каждого компонента, указанного в исходном сетевом макете. Это важно для того, чтобы после перехода в целевой регион ваши виртуальные машины имели все функции и возможности исходных виртуальных машин.

    > [!NOTE]
    > Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть, когда вы включаете репликацию для исходной виртуальной машины. Вы также можете предварительно создать сеть и назначить ее виртуальной машине в потоке пользователя для включения репликации. Любые другие ресурсы, как это описано далее, необходимо создавать вручную в целевом регионе.

     Чтобы создать нужные вам наиболее часто используемые сетевые ресурсы, в зависимости от конфигурации исходной виртуальной машины, перейдите по следующим ссылкам.

    - [Группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group)
    - [Подсистемы балансировки нагрузки](https://docs.microsoft.com/azure/load-balancer/#step-by-step-tutorials)
    - [Общедоступный IP-адрес](https://docs.microsoft.com/azure/load-balancer/#step-by-step-tutorials)
    
    Сведения о других сетевых компонентах см. в [документации по сетям](https://docs.microsoft.com/azure/#pivot=products&panel=network). 

4. Вручную [создайте непроизводственную сеть](https://docs.microsoft.com/azure/virtual-network/quick-create-portal) в целевом регионе, если вы хотите проверить конфигурацию перед выполнением окончательного перехода в целевой регион. При этом помехи в рабочей среде будут минимальными (рекомендуется выполнить этот шаг).
    
## <a name="copy-data-to-the-target-region"></a>Копирование данных в целевой регион
Ниже приведены шаги по копированию данных в целевой регион с помощью Azure Site Recovery.

### <a name="create-the-vault-in-any-region-except-the-source-region"></a>Создайте хранилище в любом регионе, за исключением исходного.

1. Войдите на [портал Azure](https://portal.azure.com) > **Службы восстановления**.
2. Щелкните **Создать ресурс** > **Средства управления** > **Backup and Site Recovery**.
3. В поле **Имя** укажите понятное имя **ContosoVMVault**. Выберите соответствующую подписку, если их у вас несколько.
4. Создайте группу ресурсов **ContosoRG**.
5. Укажите регион Azure. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. В хранилище Служб восстановления щелкните **Обзор** > **ConsotoVMVault** > **+Реплицировать**.
7. В поле **Источник** выберите **Azure**.
8. В поле **Исходное расположение** выберите исходный регион Azure, в котором сейчас запущены виртуальные машины.
9. Выберите модель развертывания Resource Manager. Затем выберите настройку **Исходная подписка** и **Исходная группа ресурсов**.
10. Нажмите кнопку **ОК**, чтобы сохранить настройки.

### <a name="enable-replication-for-azure-vms-and-start-copying-the-data"></a>Включите репликацию для виртуальных машин Azure и начните копирование данных.

Site Recovery получает список виртуальных машин, связанных с подпиской и группой ресурсов.

1. Теперь сделайте следующее. Выберите виртуальную машину, которую требуется перенести. Нажмите кнопку **ОК**.
3. В разделе **Параметры** щелкните **Аварийное восстановление**.
4. В разделе **Настройка аварийного восстановления** > **Целевой регион** выберите целевой регион, в который будет выполняться репликация.
5. Для работы с этим руководством примите остальные значения по умолчанию.
6. Щелкните **Включить репликацию**. Будет запущено задание для включения репликации виртуальной машины.

    ![включение репликации](media/tutorial-migrate-azure-to-azure/settings.png)

 

## <a name="test-the-configuration"></a>Тестирование конфигурации


1. Перейдите в хранилище, в разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину, которую вы планируете переместить в целевой регион, и щелкните значок **+Тестовая отработка отказа**.
2. На странице **Тестовая отработка отказа** выберите точку восстановления:

   - **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана службой Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
   - **Последняя с согласованием приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
   - **Настраиваемая**. Вы можете выбрать любую точку восстановления.

3. Чтобы проверить конфигурацию, выберите целевую виртуальную сеть Azure, в которую вы хотите переместить виртуальные машины Azure. 

> [!IMPORTANT]
> Для проверки сбоя мы советуем использовать отдельную сеть виртуальных машин Azure, а не рабочую сеть в целевой сети виртуальных машин, в которую вы хотите перенести свои виртуальные машины и которая была настроена при включении репликации.

4. Чтобы начать тестирование переноса, щелкните **ОК**. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Также можно щелкнуть задание **Тестовая отработка отказа** в разделе "Имя хранилища" > **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина работает, имеет соответствующий размер и подключена к соответствующей сети.
6. Если вы хотите удалить виртуальную машину, созданную в ходе тестирования переноса, щелкните **Очистить тестовую отработку отказа** для реплицированного элемента. При необходимости в разделе **Примечания** можно записать и сохранить сведения о тестировании.

## <a name="perform-the-move-to-the-target-region-and-confirm"></a>Выполните и подтвердите перенос в целевой регион.

1.  Перейдите в хранилище, в разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В области **Отработка отказа**выберите **Последнее**. 
3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается выключить исходную виртуальную машину перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа. 
4. Когда задание будет завершено, проверьте, отображается ли виртуальная машина в целевом регионе Azure, как и ожидалось.
5. В разделе **Реплицированные элементы** нажмите правой кнопкой мыши пункт "Виртуальная машина" и выберите **Зафиксировать**. Перенос в целевой регион будет завершен. Дождитесь завершения фиксации задания.

## <a name="discard-the-resource-in-the-source-region"></a>Отмена ресурса в исходном регионе 

1. Перейдите к виртуальной машине.  Щелкните **Отключить репликацию**.  Это остановит процесс копирования данных для виртуальной машины.  

> [!IMPORTANT]
> Очень важно выполнить этот шаг, чтобы не платить за репликацию Azure Site Recovery.

Если вы не планируете повторно использовать исходные ресурсы, выполните следующие шаги:

1. Удалите все соответствующие сетевые ресурсы в исходном регионе, перечисленные на шаге 4 в разделе [Подготовка исходных виртуальных машин](#prepare-the-source-vms). 
2. Удалите соответствующую учетную запись хранения в исходном регионе.



## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы перенесли виртуальную машину Azure в другой регион Azure. Теперь можно настроить аварийное восстановление для перенесенной виртуальной машины.

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления после миграции](azure-to-azure-quickstart.md)

