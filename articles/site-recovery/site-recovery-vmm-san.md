---
title: "Репликация виртуальных машин Hyper-V в VMM с сетью SAN с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается, как реплицировать виртуальные машины Hyper-V между двумя ЦОД, используя службу Azure Site Recovery и репликацию сети SAN."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: eb480459-04d0-4c57-96c6-9b0829e96d65
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/14/2017
ms.author: raynew
ms.openlocfilehash: 3df38802fcdc86e4553253d38c49faff455f873e
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="replicate-hyper-v-vms-in-vmm-clouds-to-a-secondary-site-with-azure-site-recovery-by-using-san"></a>Репликация виртуальных машин Hyper-V в облаках VMM на вторичный сайт с помощью службы Azure Site Recovery и сети SAN


Эта статья поможет вам выполнить развертывание службы [Azure Site Recovery](site-recovery-overview.md) для управления репликацией виртуальных машин Hyper-V (управляемых в облаках System Center Virtual Machine Manager) на вторичный сайт VMM с помощью классического портала. Этот сценарий не поддерживается на новом портале Azure.



Оставьте комментарии в конце статьи. Получите ответы на вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="why-replicate-with-san-and-site-recovery"></a>В чем преимущества репликации с помощью сети SAN и службы Site Recovery?

* Сеть SAN предоставляет масштабируемое решение для репликации корпоративного уровня. С его помощью первичный сайт, содержащий виртуальные машины Hyper-V с сетью SAN, может реплицировать LUN на вторичный сайт с сетью SAN. Управление хранилищем осуществляется с помощью VMM, а репликация и отработка отказа организованы через службу Site Recovery.
* Служба Site Recovery сотрудничает с несколькими [партнерами хранилища SAN](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx) для обеспечения репликации между хранилищами с протоколом Fibre Channel и iSCSI.  
* Используйте существующую инфраструктуру сети SAN для защиты критически важных приложений, развернутых в кластерах Hyper-V. Виртуальные машины могут реплицироваться как группа, чтобы отработка отказов n-уровневых приложений выполнялась согласованно.
* Репликация сети SAN гарантирует согласованную репликацию на различных уровнях приложения. В зависимости от возможностей массива хранения синхронизированная репликация обеспечивает низкие показатели целевого времени восстановления (RTO) и целевой точки восстановления (RPO), а асинхронная — высокую гибкость.  
* Вы можете управлять хранилищем сети SAN в структуре VMM и использовать SMI-S в VMM для обнаружения существующего хранилища.  

Обратите внимание на следующее.
- Репликация типа "сеть — сеть" с помощью сети SAN не поддерживается на портале Azure. Это можно сделать только на классическом портале. На классическом портале невозможно создавать хранилища. Но можно обслуживать существующие хранилища.
- Репликация из сети SAN в Azure не поддерживается.
- Невозможно реплицировать общие VHDX-файлы или логические устройства (LUN), которые напрямую подключены к виртуальным машинам через iSCSI или Fibre Channel. Гостевые кластеры не реплицируются.


## <a name="architecture"></a>Архитектура

![Архитектура SAN](./media/site-recovery-vmm-san/architecture.png)

- **Azure.** Настройте хранилище Site Recovery на портале Azure.
- **Хранилище SAN**. Управление хранилищем SAN осуществляется в структуре VMM. Добавьте поставщик хранилища, создайте классификации хранилищ и настройте пулы носителей.
- **VMM и Hyper-V**. Рекомендуется использовать сервер VMM на каждом сайте. Настройте частные облака VMM и поместите в них кластеры Hyper-V. Во время развертывания поставщик Azure Site Recovery устанавливается на каждом сервере VMM, а сервер регистрируется в хранилище. Поставщик взаимодействует со службой Site Recovery для управления репликацией, отработкой отказа и восстановлением размещения.
- **Репликация**. После настройки хранилища в VMM и настройки репликации в службе Site Recovery между основным и дополнительным хранилищами SAN выполняется репликация. В службу Site Recovery данные репликации не отправляются.
- **Отработка отказа.** Включите отработку отказа на портале Site Recovery. Во время отработки отказа потеря данных исключена, так как репликация является синхронной.
- **Восстановление размещения.** Для восстановления размещения включите обратную репликацию, чтобы перенести разностные изменения со вторичного сайта на первичный. После завершения обратной репликации вы можете запустить плановую отработку отказа со вторичного сайта на первичный. Эта плановая отработка отказа останавливает виртуальные машины реплики на вторичном сайте и запускает их на первичном.


## <a name="before-you-start"></a>Перед началом работы


**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** |Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/) . Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. Создайте хранилище Azure Site Recovery для настройки репликации и отработки отказа, а также для управления ими.
**VMM** | Можно использовать один сервер VMM и выполнять репликацию между разными облаками, но рекомендуется иметь по одному серверу VMM на каждом сайте (первичном и вторичном). Сервер VMM можно развернуть как отдельный физический или виртуальный изолированный сервер или как виртуальный кластер. <br/><br/>На сервере VMM должен выполняться System Center 2012 R2 или более поздней версии с последними накопительными обновлениями.<br/><br/> Для каждого сервера должно быть настроено как минимум одно облако на основном сервере VMM и одно облако на дополнительном сервере VMM, который предполагается использовать для отработки отказа.<br/><br/> Исходное облако должно содержать одну или несколько групп узлов VMM.<br/><br/> Для всех облаков VMM необходимо настроить профиль емкости Hyper-V.<br/><br/> Дополнительные сведения о настройке облаков VMM см. в статье [Сценарий: развертывание частного облака VMM](https://technet.microsoft.com/en-us/system-center-docs/vmm/scenario/cloud-overview).
**Hyper-V** | Вам потребуется один или несколько кластеров Hyper-V в основном и дополнительном облаках VMM.<br/><br/> Исходный кластер Hyper-V должен содержать одну или несколько виртуальных машин.<br/><br/> В каждой группе узлов VMM на первичном и вторичном сайтах должен быть как минимум один кластер Hyper-V.<br/><br/>Сервер узла и целевой сервер Hyper-V должны работать под управлением Windows Server 2012 (или более поздней версии) с ролью Hyper-V, и на них должны быть установлены последние обновления.<br/><br/> Если Hyper-V выполняется в кластере при использовании кластера на основе статических IP-адресов, брокер кластера не создается автоматически. Его необходимо настроить вручную. Дополнительные сведения см. в статье [Preparing host clusters for Hyper-V replica](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters) (Подготовка кластеров узлов для реплики Hyper-V).
**Хранилище SAN** | Можно реплицировать размещенные на гостевых кластерах виртуальные машины при помощи протоколов iSCSI или Channel или общих виртуальных жестких дисков (VHDX).<br/><br/> Установите два массива сети SAN: один на первичном сайте, а другой — на вторичном.<br/><br/> Настройте инфраструктуру сети между массивами. Выполните настройку пиринга и репликации. Лицензии репликации должны быть настроены в соответствии с требованиями массива хранения данных.<br/><br/>Настройте сеть между серверами узлов Hyper-V и массивом хранения, чтобы обеспечить взаимодействие узлов с логическими номерами устройств хранилища с помощью iSCSI или Fibre Channel.<br/><br/> Узнайте, [какие массивы хранения поддерживаются](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx).<br/><br/> Должны быть установлены поставщики SMI-S от производителей массивов хранения, а массивы сети SAN должны управляться поставщиком. Настройте поставщик в соответствии с инструкциями производителя.<br/><br/>Убедитесь, что поставщик SMI-S массива находится на сервере, к которому сервер VMM имеет сетевой доступ через IP-адрес или полное доменное имя (FQDN).<br/><br/> Каждый массив SAN должен иметь один или несколько доступных пулов носителей.<br/><br/> Основной сервер VMM должен управлять основным массивом данных, а дополнительный сервер VMM — дополнительным массивом.
**Сетевое сопоставление** | Настройте сетевое сопоставление, чтобы оптимально разместить реплики виртуальных машин на дополнительных серверах узла Hyper-V после отработки отказа и обеспечить их подключение к соответствующим сетям виртуальных машин. Если не настроить сетевое сопоставление, реплицированные виртуальные машины после отработки отказа не будут подключены ни к какой сети.<br/><br/> Убедитесь в правильности настроек сетей VMM, чтобы иметь возможность настроить сетевое сопоставление во время развертывания службы Site Recovery. В VMM виртуальные машины на исходном узле Hyper-V должны быть подключены к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.<br/><br/> В целевом облаке должна быть соответствующая сеть виртуальных машин, которая, в свою очередь, должна быть связана с соответствующей логической сетью, сопоставленной с целевым облаком.<br/><br/>.

## <a name="step-1-prepare-the-vmm-infrastructure"></a>Шаг 1. Подготовка инфраструктуры VMM
Для подготовки инфраструктуры VMM:

1. Проверьте облака VMM.
2. Интегрируйте и классифицируйте системы хранения данных сети SAN в VMM.
3. Создайте LUN и выделите хранилище.
4. Создайте группы репликации.
5. Настройте сети виртуальных машин.

### <a name="verify-vmm-clouds"></a>Проверьте облака VMM

Перед началом развертывания службы Site Recovery убедитесь, что облака VMM настроены должным образом.

### <a name="integrate-and-classify-san-storage-in-the-vmm-fabric"></a>Интегрируйте и классифицируйте хранилище SAN в структуре VMM

1. В консоли VMM щелкните **Структура** > **Хранилище** > **Добавление ресурсов** > **Запоминающие устройства**.
2. В мастере **добавления ресурсов хранилища** щелкните **Выберите тип поставщика хранилища**, а затем выберите **SAN and NAS devices discovered and managed by an SMI-S provider** (Устройства SAN и NAS, обнаруженные и управляемые поставщиком SMI-S).

    ![Тип поставщика](./media/site-recovery-vmm-san/provider-type.png)

3. На странице **Укажите протокол и адрес SMI-S поставщика хранилища** выберите **SMI-S CIMXML** и укажите параметры для подключения к поставщику.
4. В полях **Provider IP address or FQDN** (IP-адрес поставщика или полное доменное имя) и **Порт TCP/IP** укажите параметры для подключения к поставщику. Соединение SSL можно использовать только для CIMXML SMI-S.

    ![Подключение поставщика](./media/site-recovery-vmm-san/connect-settings.png)
5. В меню **Учетная запись запуска от имени** укажите учетную запись запуска от имени VMM, имеющую доступ к поставщику, или создайте новую.
6. На странице **Собрать сведения** VMM пытается автоматически обнаружить и импортировать информацию об устройстве хранения. Чтобы повторить попытку обнаружения, нажмите кнопку **Проверить поставщик**. В случае успешного завершения на странице будут перечислены обнаруженные массивы хранения данных, пулы носителей, производитель, модель и емкость.

    ![Обнаружение хранилища](./media/site-recovery-vmm-san/discover.png)
7. В разделе **Выбрать пулы носителей для помещения в группе управления и назначить классификацию**выберите пулы носителей, которыми будет управлять VMM, и назначьте их классификацию. Сведения о LUN импортируются из пулов носителей. Создайте LUN, основываясь на приложениях, которые следует защитить, их требованиях к емкости и выборе компонентов, нуждающихся в совместной репликации.

    ![Классифицировать хранилище](./media/site-recovery-vmm-san/classify.png)

### <a name="create-luns-and-allocate-storage"></a>Создание LUN и выделение хранилища

Создайте LUN, основываясь на приложениях, которые следует защитить, их требованиях к емкости и выборе компонентов, нуждающихся в совместной репликации.

1. Когда хранилище отобразится в структуре VMM, можно [провести подготовку LUN](https://technet.microsoft.com/en-us/system-center-docs/vmm/manage/manage-storage-host-groups#create-a-lun-in-vmm).

     > [!NOTE]
     > Не добавляйте виртуальные жесткие диски (VHD) для виртуальных машин, на которых включена репликация в LUN. Если эти номера LUN не входят в группу репликации Site Recovery, они не будут обнаружены с помощью Site Recovery.
     >

2. Выделите достаточный объем памяти для кластера узлов Hyper-V, чтобы сервер VMM мог развернуть данные виртуальной машины в подготовленное хранилище:

   * Перед выделением хранилища кластеру необходимо выделить хранилище группе узлов VMM, на которой расположен соответствующий кластер. Дополнительные сведения см. в статьях [How to Allocate Storage Logical Units to a Host Group in VMM](https://technet.microsoft.com/library/gg610686.aspx) (Как выделить логические устройства хранилища для группы узлов в VMM) и [How to Allocate Storage Pools to a Host Group in VMM](https://technet.microsoft.com/library/gg610635.aspx) (Как выделить пулы носителей для группы узлов в VMM).
   * Выделение емкости хранилища для кластера описано в статье [Настройка хранилища в кластере узлов Hyper-V в VMM](https://technet.microsoft.com/library/gg610692.aspx).

    ![Тип поставщика](./media/site-recovery-vmm-san/provider-type.png)
3. На странице **Укажите протокол и адрес SMI-S поставщика хранилища** выберите **CIMXML SMI-S**. Укажите параметры для подключения к поставщику. Можно использовать соединение SSL только для CIMXML SMI-S.

    ![Подключение поставщика](./media/site-recovery-vmm-san/connect-settings.png)
4. В меню **Учетная запись запуска от имени** укажите учетную запись запуска от имени VMM, имеющую доступ к поставщику, или создайте новую.
5. На странице **Сбор данных** VMM пытается автоматически обнаружить и импортировать сведения об устройствах хранения. Чтобы повторить попытку, нажмите кнопку **Проверить поставщик**. В случае успешного обнаружения на странице будут перечислены массивы хранения, пулы носителей, производитель, модель и емкость.

    ![Обнаружение хранилища](./media/site-recovery-vmm-san/discover.png)
7. На странице **Выберите пул хранилища, чтобы задать для него управление, и назначьте классификацию** выберите пулы носителей, которыми будет управлять VMM, и назначьте их классификацию. Сведения о LUN импортируются из пулов носителей.

    ![Классифицировать хранилище](./media/site-recovery-vmm-san/classify.png)


### <a name="create-replication-groups"></a>Создание групп репликации

Создайте группы репликации, включая все LUN, которые требуется реплицировать друг с другом.

1. В консоли VMM откройте в свойствах массива хранения данных вкладку **Группы репликации** и щелкните **Создать**.
2. Создайте группу репликации.

    ![Группа репликации SAN](./media/site-recovery-vmm-san/rep-group.png)

### <a name="set-up-networks"></a>Настройка сетей

Если вы хотите настроить сетевое сопоставление:

1. См. раздел о сетевом сопоставлении Site Recovery.
2. Подготовьте сети виртуальных машин в VMM:

   * [Настройте логические сети](https://technet.microsoft.com/en-us/system-center-docs/vmm/manage/manage-network-logical-networks).
   * [Настройте сети виртуальных машин](https://technet.microsoft.com/en-us/system-center-docs/vmm/manage/manage-network-vm-networks).


## <a name="step-2-create-a-vault"></a>Шаг 2. Создание хранилища

1. Войдите на [портал Azure](https://portal.azure.com) с сервера VMM, который нужно зарегистрировать в хранилище.
2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.
3. Щелкните **Создать** > **Быстрое создание**.
4. В поле **Имя**введите понятное имя для идентификации хранилища.
5. В поле **Область**выберите географический регион для хранилища архивации. Список поддерживаемых регионов указан на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. Щелкните элемент **Создать хранилище**.

    ![Новое хранилище](./media/site-recovery-vmm-san/create-vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. На главной странице **служб восстановления** это хранилище будет иметь состояние **Активно**.

### <a name="register-the-vmm-servers"></a>Регистрация серверов VMM

1. Откройте страницу **Быстрый запуск** со страницы **Службы восстановления**. Страницу быстрого запуска можно также открыть в любой другой момент, щелкнув значок.

    ![Значок быстрого запуска](./media/site-recovery-vmm-san/quick-start-icon.png)
2. В раскрывающемся списке выберите элемент **Between Hyper-V on-premises site using array replication** (Между локальным сайтом Hyper-V с помощью репликации массива).

    ![Регистрационный ключ](./media/site-recovery-vmm-san/select-san.png)
3. В разделе **Подготовка серверов VMM**скачайте последнюю версию файла для установки поставщика Azure Site Recovery.
4. Запустите этот файл на исходном сервере VM. Если развертывание VMM выполняется в кластере и вы устанавливаете поставщик впервые, то установите его на активном узле и завершите установку, чтобы зарегистрировать сервер VMM в хранилище. Затем установите поставщик на других узлах. При обновлении поставщика требуется обновить его на всех узлах, так как все они должны иметь одну версию поставщика.
5. Установщик проверяет предварительные требования и запрашивает разрешение на остановку службы VMM, чтобы начать установку поставщика. Служба автоматически перезапустится после завершения установки. В кластере VMM отобразится запрос на остановку роли "Кластер".
6. Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.

    ![Центр обновления Майкрософт](./media/site-recovery-vmm-san/ms-update.png)

7. По умолчанию для установки поставщика задано такое расположение: <SystemDrive>\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin. Чтобы начать установку, нажмите кнопку **Установить**.

    ![Установка расположения](./media/site-recovery-vmm-san/install-location.png)

8. После установки поставщика нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер VMM в хранилище.

    ![Установка завершена](./media/site-recovery-vmm-san/install-complete.png)

9. На странице **Подключение к Интернету** укажите, как поставщик подключается к Интернету. Выберите пункт **Use default system proxy settings** (Использовать настройки прокси-сервера по умолчанию), чтобы использовать настройки подключения к Интернету, по умолчанию заданные на сервере.

    ![Параметры Интернета](./media/site-recovery-vmm-san/proxy-details.png)

   * Если вы хотите использовать настраиваемый прокси-сервер, настройте его перед установкой поставщика. При настройке параметров прокси-сервера выполняется проверка подключения к прокси-серверу.
   * Если вы используете настраиваемый прокси-сервер или прокси-сервер по умолчанию требует аутентификации, то необходимо указать сведения о прокси-сервере, включая его адрес и порт.
   * Необходимые URL-адреса должны быть доступны с сервера VMM.
   * При использовании настраиваемого прокси-сервера на сервере VMM автоматически создается учетная запись запуска от имени (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла проходить аутентификацию. Параметры учетной записи запуска от имени можно изменить в консоли VMM (**Параметры** > **Безопасность** > **Учетные записи запуска от имени** > **DRAProxyAccount**). Необходимо перезапустить службу VMM, чтобы изменение вступило в силу.
10. В поле **Регистрационный ключ** выберите ключ, который вы скачали с портала и скопировали на сервер VMM.
11. В поле **Имя хранилища**проверьте имя хранилища, в котором будет зарегистрирован сервер.

    ![Регистрация сервера](./media/site-recovery-vmm-san/vault-creds.png)
12. Параметр шифрования используется только при репликации из VMM в Azure. Его можно пропустить.

    ![Регистрация сервера](./media/site-recovery-vmm-san/encrypt.png)
13. В поле **Имя сервера**укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
14. В поле **Initial cloud metadata sync** (Начальная синхронизация метаданных в облаке) выберите, нужно ли синхронизировать метаданные для всех облаков на сервере VMM. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.

    ![Регистрация сервера](./media/site-recovery-vmm-san/friendly-name.png)

15. Для завершения процесса нажмите кнопку **Далее** . После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Чтобы просмотреть этот сервер в хранилище, выберите **Серверы** > **Серверы VMM**.

### <a name="command-line-installation"></a>Установка из командной строки

Поставщик Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\ASR.
2. Остановите службу VMM.
3. Извлеките установщик поставщика. Выполните эти команды от имени администратора:

        C:\Windows\System32> CD C:\ASR
        C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
4. Установите поставщик:

        C:\ASR> setupdr.exe /i
5. Зарегистрируйте поставщик:

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>         

Параметры

* **/Credentials** — обязательный параметр, который задает расположение файла регистрационного ключа.  
* **/FriendlyName** — обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
* **/EncryptionEnabled** — необязательный параметр, который используется только при репликации из VMM в Azure.
* **/proxyAddress**— необязательный параметр, определяющий адрес прокси-сервера.
* **/proxyport**— необязательный параметр, определяющий порт прокси-сервера.
* **/proxyUsername** — необязательный параметр, определяющий имя пользователя прокси-сервера (если прокси-сервер требует аутентификации).
* **/proxyPassword** — необязательный параметр, который указывает пароль для аутентификации на прокси-сервере (если прокси-сервер требует аутентификации).

## <a name="step-3-map-storage-arrays-and-pools"></a>Шаг 3. Сопоставление пулов и массивов хранения

Сопоставьте основной и дополнительный массивы, чтобы указать, какой дополнительный пул носителей получает данные репликации из основного пула. Сопоставьте хранилища перед настройкой репликации, так как сведения о сопоставлении используются при включении защиты для групп репликации.

Перед началом работы убедитесь, что облака VMM обнаруживаются в хранилище. Их можно обнаружить, выполнив синхронизацию всех облаков при установке поставщика или синхронизацию определенного облака в консоли VMM.

1. Щелкните **Ресурсы** > **Хранилище сервера** > **Сопоставить исходные и целевые массивы**.
    ![Регистрация сервера](./media/site-recovery-vmm-san/storage-map.png)

2. Выберите массивы хранения на первичном сайте и сопоставьте их с массивами на вторичном. В поле **Пулы носителей** выберите исходный и целевой пулы носителей для сопоставления.

    ![Регистрация сервера](./media/site-recovery-vmm-san/storage-map-pool.png)

## <a name="step-4-configure-replication-settings"></a>Шаг 4. Настройка параметров репликации

После регистрации серверов VMM настройте параметры защиты облаков.

1. На странице **Быстрый запуск** щелкните **Настройка защиты для облаков VMM**.
2. На вкладке **Защищенные элементы** выберите облако и перейдите на вкладку **Конфигурация**.
3. В разделе **Цель** выберите **VMM**.
4. В поле **Целевое расположение** выберите сервер VMM, управляющий облаком, которое вы хотите использовать для восстановления.
5. В поле **Целевое облако** укажите целевое облако, которое требуется использовать для отработки отказа виртуальных машин.
   * Рекомендуется выбрать целевое облако, отвечающее требованиям к восстановлению для виртуальных машин, которые планируется защитить.
   * Облако может относиться только к одной паре облаков — в качестве основного или целевого.
6. Служба Site Recovery проверяет наличие доступа облаков к хранилищу SAN и сопоставление массивов хранения.
7. Если проверка прошла успешно, в поле **Тип репликации** выберите **SAN**.

После сохранения параметров создается задание, которое можно отслеживать на вкладке **Задания**. Параметры можно изменить на вкладке **Настройка**. Чтобы изменить целевое расположение или целевое облако, необходимо удалить эту конфигурацию облака и затем повторно настроить облако.

## <a name="step-5-enable-network-mapping"></a>Шаг 5. Включение сетевого сопоставления

1. На странице **Быстрый запуск** щелкните **Сопоставление сетей**.
2. Выберите исходный сервер VMM, а затем целевой сервер VMM, на котором будут сопоставляться сети. На экран будет выведен список исходных сетей и соответствующих им целевых сетей. Для сетей, которые не сопоставляются, отображается пустое значение. Щелкните значок сведений рядом с именами исходной и целевой сетей для просмотра их подсетей.
3. Выберите сеть в меню **Network on source** (Сеть источника), а затем щелкните **Сопоставить**. Служба обнаруживает сети виртуальных машин на целевом сервере и отображает их.

    ![Архитектура SAN](./media/site-recovery-vmm-san/network-map1.png)
4. Выберите одну из сетей виртуальных машин целевого сервера VMM.

    ![Архитектура SAN](./media/site-recovery-vmm-san/network-map2.png)

5. При выборе целевой сети отображаются защищенные облака, использующие сеть источника. Также отображаются доступные целевые сети. Рекомендуется выбрать целевую сеть, которая доступна для всех облаков, используемых для репликации.
6. Установите флажок для завершения процесса сопоставления. Запустится задание, которое отслеживает ход выполнения. Его можно просмотреть на вкладке **Задания** .

## <a name="step-6-enable-replication-for-replication-groups"></a>Шаг 6. Включение репликации для групп репликации

Перед включением защиты для виртуальных машин требуется активировать репликацию для групп репликации хранилища.

1. На портале Azure Site Recovery на странице **свойств** основного облака откройте вкладку **Виртуальные машины** и щелкните **Добавление группы репликации**.
2. Выберите одну или несколько групп репликации VMM, связанных с облаком, проверьте исходные и целевые массивы и укажите частоту репликации.

Site Recovery, VMM и поставщики SMI-S подготавливают логические номера устройств для хранилища целевого сайта и включают репликацию хранилища. Если группа репликации уже реплицирована, то Site Recovery использует существующую связь репликации и обновляет данные.

## <a name="step-7-enable-protection-for-virtual-machines"></a>Шаг 7. Включение защиты для виртуальных машин


После репликации группы хранения включите защиту для виртуальных машин в консоли VMM, применив один из следующих методов:

* **Новая виртуальная машина.** При создании виртуальной машины включите репликацию и свяжите виртуальную машину с группой репликации.
  С помощью этого параметра VMM задействует интеллектуальное размещение, чтобы оптимально расположить хранилище виртуальных машин на логические номера устройств группы репликации. Site Recovery организует создание теневой копии виртуальной машины на вторичном сайте и выделит емкость так, чтобы реплику виртуальных машин можно было запустить после отработки отказа.
* **Существующая виртуальная машина.** Если виртуальная машина уже развернута в VMM, то вы можете включить репликацию и выполнить миграцию хранилища в группу репликации. После этого VMM и Site Recovery определят новую виртуальную машину и приступят к управлению этой машиной в Site Recovery. Теневая копия виртуальной машины создается на вторичном сайте, а емкости выделяются так, чтобы реплику виртуальной машины можно было запустить после отработки отказа.

![Включить защиту](./media/site-recovery-vmm-san/enable-protect.png)

После включения репликации виртуальных машин они отображаются в консоли Site Recovery. В ней можно просматривать свойства виртуальных машин, отслеживать состояние и отслеживать отработку отказа групп репликации, которые содержат несколько виртуальных машин. В репликации сети SAN все виртуальные машины, связанные с группой репликации, должны выполнить отработку отказа вместе. Это обусловлено тем, что данный переход сначала происходит на уровне хранилища. Очень важно правильно сформировать группы репликации и расположить вместе только связанные друг с другом виртуальные машины.

> [!NOTE]
> После включения репликации для виртуальной машины не следует добавлять для нее виртуальные жесткие диски в логические номера устройств, если они не находятся в группе репликации Site Recovery. VHD-файлы могут быть обнаружены с помощью Site Recovery, только если они находятся в группе репликации Site Recovery.
>
>

Следить за процессом, включая выполнение первоначальной репликации, можно на вкладке **Задания**. После запуска задания "Завершить подготовку защиты" виртуальная машина готова к отработке отказа.

![Задание защиты виртуальной машины](./media/site-recovery-vmm-san/job-props.png)

## <a name="step-8-test-the-deployment"></a>Шаг 8. Тестирование развертывания

Протестируйте развертывание, чтобы убедиться, что отработка отказа виртуальных машин происходит должным образом. Для этого создайте план восстановления и выполните тестовую отработку отказа.

1. На вкладке **Планы восстановления** выберите **Создать план восстановления**.
2. Укажите имя плана восстановления, а также выберите исходный и целевой серверы VMM. Исходный сервер должен содержать виртуальные машины, активированные для отработки отказа и восстановления. Выберите **SAN** для просмотра только тех облаков, которые настроены для репликации сети SAN.

    ![Создать план восстановления](./media/site-recovery-vmm-san/r-plan.png)

3. В разделе **Выбор виртуальных машин** выберите группы репликации. Все виртуальные машины, связанные с группой, добавляются в план восстановления. Эти виртуальные машины добавляются в группу плана восстановления по умолчанию (группа 1). При необходимости можно внести дополнительные группы. После репликации виртуальные машины запустятся в порядке в соответствии с группами плана восстановления.

    ![Выбор виртуальных машин](./media/site-recovery-vmm-san/r-plan-vm.png)
4. После создания план восстановления отобразится в списке на вкладке **Планы восстановления**. Выберите план и щелкните **Тестовая отработка отказа**.
5. На странице **Подтвердить тестовую отработку отказа** выберите **Нет**. После отработки отказа реплики виртуальных машин не будут подключены к какой-либо сети, если этот параметр включен. Этот тест дает возможность убедиться, что отработка отказа виртуальных машин происходит должным образом, но при этом не тестируется сетевая среда. Дополнительные сведения о других сетевых параметрах см. в статье [Отработка отказа Site Recovery](site-recovery-failover.md).

    ![Выбрать тестовую сеть](./media/site-recovery-vmm-san/test-fail1.png)

6. Тестовая виртуальная машина создается на том же узле, что и реплика виртуальной машины. Она не добавляется в облако, в котором находится реплика виртуальной машины.
2. Когда репликация завершена, реплика виртуальной машины получит другой IP-адрес, отличный от IP-адреса основной виртуальной машины. Если адреса выдаются из DHCP-сервера, то обновление будет происходить автоматически. Если DHCP не используется и нужно применить одинаковые адреса, то потребуется выполнить несколько скриптов.
3. Выполните следующий скрипт, чтобы получить IP-адрес:

       $vm = Get-SCVirtualMachine -Name <VM_NAME>
       $na = $vm[0].VirtualNetworkAdapters>
       $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
       $ip.address  

4. Выполните этот образец сценария, чтобы обновить DNS. Укажите полученный IP-адрес.

       [string]$Zone,
       [string]$name,
       [string]$IP
       )
       $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
       $newrecord = $record.clone()
       $newrecord.RecordData[0].IPv4Address  =  $IP
       Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord


## <a name="next-steps"></a>Дальнейшие действия

Протестировав отработку отказа и убедившись, что среда работает так, как нужно, [ознакомьтесь с разными типами отработки отказа](site-recovery-failover.md).
