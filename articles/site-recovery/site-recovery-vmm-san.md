<properties
	pageTitle="Репликация виртуальных машин Hyper-V (в облаке VMM) на дополнительный сайт с Azure Site Recovery с помощью SAN | Microsoft Azure"
	description="Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин Hyper-V между локальными сайтами с использованием репликации сети SAN."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/12/2016"
	ms.author="raynew"/>

# Репликация виртуальных машин Hyper-V (в облаке VMM) на дополнительный сайт с Azure Site Recovery с помощью SAN

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## Обзор

В этой статье описывается развертывание службы Site Recovery для организации и автоматизации защиты виртуальных машин Hyper-V, размещаемых в частных облаках System Center Virtual Machine Manager (VMM). В этом сценарии виртуальные машины реплицируются с первичного сайта VMM на вторичный сайт VMM с помощью репликации Site Recovery и SAN.

Статья содержит общие сведения и предварительные требования к развертыванию. Здесь вы найдете инструкции по настройке и включению репликации в VMM и хранилище Site Recovery. Вы обнаружите и классифицируете системы хранения данных SAN в VMM, проведете подготовку LUN и выделение хранилища для кластеров Hyper-V. В заключение приводится процедура тестирования отработки отказа для подтверждения правильной работы всех компонентов.

Вы можете задать любые вопросы на [форуме по Azure Recovery Services](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Этот сценарий отличается следующими преимуществами для предприятий.

- Обеспечение корпоративного решения по масштабируемой репликации, автоматизированное с помощью службы Site Recovery.
- Использование возможностей репликации сети SAN, предоставляемых партнерами корпоративного хранения при помощи протоколов Fibre Сhannel и iSCSI. См. наших [партнеров хранилища SAN](http://go.microsoft.com/fwlink/?LinkId=518669).
- Использование существующей инфраструктуры SAN для защиты критически важных приложений, развернутых в кластерах Hyper-V.
- Предоставление поддержки для гостевых кластеров.
- Гарантия согласованности репликации SAN на различных уровнях приложения с синхронизированной репликацией для малого RTO и RPO и асинхронизированной репликацией для высокой гибкости, в зависимости от возможностей массива хранения.  
- Интеграция с VMM позволяет управлять SAN с помощью консоли VMM, и SMI-S в VMM обнаруживает существующее хранилище.  



## Архитектура

Этот сценарий обеспечивает защиту рабочих нагрузок путем резервного копирования виртуальных машин Hyper-V с одного локального сайта VMM на другой с помощью репликации сети SAN.

![Архитектура SAN](./media/site-recovery-vmm-san/architecture.png)

Компоненты этого сценария:

- **Локальные виртуальные машины**  — ваши локальные серверы Hyper-V, управляемые в частных облаках VMM, содержат виртуальные машины, которые вы хотите защитить.
- **Локальные серверы VMM** — один или несколько серверов VMM, работающих на первичном сайте, который вы хотите защитить, а также на вторичном сайте.
- **Хранилище SAN** — массив SAN на первичном сайте и на вторичном сайте
-  **Хранилище Azure Site Recovery** — это хранилище координирует и организует репликацию данных, отработку отказа и восстановление между локальными сайтами.
- **Поставщик Azure Site Recovery** — поставщик устанавливается на каждом сервере VMM.

## Перед началом работы

Убедитесь, что выполнены следующие предварительные требования.

**Предварительные требования** | **Дополнительные сведения** 
--- | ---
**Таблицы Azure**| Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). См. [дополнительные сведения](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. 
**VMM** | Вам понадобится по крайней мере один сервер VMM, развернутый как отдельный физический или виртуальный сервер либо как виртуальный кластер. <br/><br/>Сервер VMM должен работать под управлением System Center 2012 R2 с последними накопительными пакетами обновления.<br/><br/>Требуется по крайней мере одно облако на основном сервере VMM, который необходимо защитить, и одно облако на дополнительном сервере VMM, который вы хотите использовать для защиты и восстановления.<br/><br/>Исходное облако, которое требуется защитить, должно содержать одну или несколько групп узлов VMM.<br/><br/>Для всех облаков VMM необходимо задать профиль емкости Hyper-V.<br/><br/>Дополнительные сведения о настройке облаков VMM см. в статьях [Планирование инфраструктуры VMM](https://msdn.microsoft.com/library/azure/dn469075.aspx#BKMK_Fabric) и [Walkthrough: Creating Private Clouds with System Center 2012 SP1 Virtual Machine Manager](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) (Пошаговое руководство: создание частных облаков с System Center 2012 SP1 VMM).
**Hyper-V** | Вам потребуется один или несколько кластеров Hyper-V на основных и дополнительных сайтах и одна или несколько виртуальных машин в исходном кластере Hyper-V. В каждой группе узлов VMM в основных и дополнительных расположениях должен быть один или несколько кластеров Hyper-V.<br/><br/>Серверы узлов и целевые серверы Hyper-V должны работать под управлением Windows Server 2012 (или более поздней версии) с ролью Hyper-V, и на них должны быть установлены последние пакеты обновлений.<br/><br/>Все серверы Hyper-V, содержащие виртуальные машины, которые необходимо защитить, должны быть расположены в облаке VMM.<br/><br/>Если Hyper-V выполняется в кластере, учтите, что брокер кластера не создается автоматически при наличии кластера на основе статических IP-адресов. Вам потребуется настроить брокер кластера вручную. [Подробная информация](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx).
**Хранилище SAN** | Благодаря репликации SAN можно реплицировать размещенные на гостевых кластерах виртуальные машины с помощью протоколов iSCSI или Fibre Channel либо же с помощью общих виртуальных жестких дисков (VHDX).<br/><br/>Настройте один массив SAN на основном сайте, а другой — на дополнительном.<br/><br/>Настройте инфраструктуру сети между массивами. Выполните настройку пиринга и репликации. Лицензии репликации следует настроить в соответствии с требованиями массива хранения данных.<br/><br/>Создайте рабочую сеть между серверами узлов Hyper-V и массивом хранения, чтобы обеспечить взаимодействие узлов с LUN (логические номера устройств) хранилища с помощью ISCSI и Fibre Channel.<br/><br/> См. список [поддерживаемых массивов хранения](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx).<br/><br/>Следует установить поставщики SMI-S, предоставленные производителями массивов хранения, а массивы SAN должны управляться поставщиком. Настройте поставщик в соответствии с документацией.<br/><br/>Убедитесь в наличии на сервере поставщика SMI-S для массива данных и наличии сетевого доступа к серверу VMM через IP-адрес или полное доменное имя (FQDN).<br/><br/>Каждый массив SAN должен иметь один или несколько пулов носителей, которые можно задействовать в данном развертывании.<br/><br/>Сервер VMM на основном сайте должен управлять основным массивом данных, а дополнительный сервер — дополнительным массивом.
**Сетевое сопоставление** | Вы можете настроить сетевое сопоставление, чтобы оптимально разместить реплики виртуальных машин на дополнительных серверах узла Hyper-V после отработки отказа и обеспечить их подключение к соответствующим сетям виртуальных машин. Если не настроить сетевое сопоставление, реплики виртуальных машин не будут подключаться к сетям после отработки отказа.<br/><br/>Чтобы настроить сетевое сопоставление во время развертывания, убедитесь, что виртуальные машины на исходном сервере узла Hyper-V подключены к сети виртуальной машины VMM. Эта сеть должна быть подключена к логической сети, которая сопоставлена с облаком.<br/<br/>Для целевого облака на дополнительном сервере VMM, используемом для восстановления, необходимо настроить соответствующую сеть виртуальных машин, которая, в свою очередь, должна быть связана с соответствующей логической сетью, сопоставленной с целевым облаком.<br/><br/>[Дополнительные сведения](site-recovery-network-mapping.md) о сетевом сопоставлении.


## Шаг 1. Подготовка инфраструктуры VMM

Для подготовки инфраструктуры VMM:

1. Проверьте, что облака VMM настроены
2. Интегрируйте и классифицируйте системы хранения данных SAN в VMM
3. Создание LUN и выделение хранилища
4. Создание групп репликации
5. Настройте сети виртуальных машин

### Проверьте, что облака VMM настроены

Site Recovery организует защиту виртуальных машин, расположенных на серверах узла Hyper-V в облаках VMM. Перед началом развертывания службы Site Recovery убедитесь, что эти облака настроены должным образом. Несколько полезных источников:

- [Настройка структуры облака VMM](https://msdn.microsoft.com/library/azure/dn883636.aspx#BKMK_Fabric)
- [Руководство по созданию частных облаков](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) в блоге Кита Майера (Keith Mayer).

### Интегрируйте и классифицируйте системы хранения данных SAN в VMM

Добавьте и классифицируйте протоколы SAN в консоли VMM:

1. В рабочей области **Структуры** нажмите **Хранилище**. Щелкните **Главная** > **Добавить ресурсы** > **Устройства хранения данных**, чтобы запустить Мастер добавления устройств хранения.
2. На странице **Выбрать тип поставщика хранилища** выберите **SAN и NAS-устройства, обнаруживаемые и управляемые поставщиком SMI-S**.

	![Тип поставщика](./media/site-recovery-vmm-san/provider-type.png)

3. На странице **Указать протокол и адрес поставщика хранилища SMI-S** выберите **SMI-S CIMXML** и укажите параметры для подключения к поставщику.
4. В полях **IP-адрес поставщика или полное доменное имя** и **Порт TCP/IP** укажите параметры для подключения к поставщику. Соединение SSL можно использовать только для CIMXML SMI-S.

	![Подключение поставщика](./media/site-recovery-vmm-san/connect-settings.png)

5. В меню **Запуск от имени учетной записи** укажите сервер VMM, имеющий доступ к поставщику, для запуска от имени учетной записи или создайте новую учетную запись.
6. На странице **Собрать сведения** VMM пытается автоматически обнаружить и импортировать информацию об устройстве хранения. Чтобы повторить попытку обнаружения, нажмите кнопку **Проверить поставщик**. В случае успешного завершения на странице будут перечислены обнаруженные массивы хранения данных, пулы носителей, производитель, модель и емкость.

	![Обнаружение хранилища](./media/site-recovery-vmm-san/discover.png)

7. В разделе **Выбрать пулы носителей для помещения в группе управления и назначить классификацию** выберите пулы носителей, которыми будет управлять VMM, и назначьте их классификацию. Сведения о LUN будут импортированы из пулов носителей. Создайте LUN, основываясь на приложениях, которые следует защитить, их требованиях к емкости и выборе компонентов, нуждающихся в совместной репликации.

	![Классифицировать хранилище](./media/site-recovery-vmm-san/classify.png)

### Создание LUN и выделение хранилища

1. После интеграции хранилища SAN в VMM создайте (подготовьте) логические устройства (LUN):

	- [Выбор метода создания логических устройств в VMM](https://technet.microsoft.com/library/gg610624.aspx)
	- [Подготовка логических устройств хранилища в VMM](https://technet.microsoft.com/library/gg696973.aspx)

2. Затем выделите достаточный объем памяти для кластера узлов Hyper-V, чтобы сервер VMM мог развернуть данные виртуальной машины в подготовленное хранилище:

	- Перед выделением хранилища кластеру необходимо выделить хранилище группе узлов VMM, на которой расположен соответствующий кластер. См. разделы [Выделение логических устройств хранилища для группы узлов](https://technet.microsoft.com/library/gg610686.aspx) и [Выделение пулов носителей для группы узлов](https://technet.microsoft.com/library/gg610635.aspx).</a>.
	- Затем выделите емкость хранилища для кластера, как описано в разделе [Настройка хранилища в кластере узлов Hyper-V в VMM](https://technet.microsoft.com/library/gg610692.aspx).</a>.

### Создание групп репликации

Создайте группы репликации, включая все LUN, которые требуется реплицировать друг с другом.

1. В консоли VMM откройте вкладку **Группы репликации** в свойствах массива хранения данных и щелкните **Создать**.
2. Затем создайте группу репликации.

	![Группа репликации SAN](./media/site-recovery-vmm-san/rep-group.png)

### Настройка сетей

Если вы хотите настроить сетевое сопоставление:

1. [Прочтите эту статью](site-recovery-network-mapping.md) о сетевом сопоставлении.
2. Подготовьте сети виртуальных машин в VMM:

	- [Настройте логические сети](https://technet.microsoft.com/library/jj721568.aspx).
	- [Настройте сети виртуальных машин](https://technet.microsoft.com/library/jj721575.aspx).

## Шаг 2. Создание хранилища


1. Войдите на [Портал управления](https://portal.azure.com) с сервера VMM, который хотите зарегистрировать.

2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.

3. Выберите **Создать** > **Быстрое создание**.

4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Регион** выберите географический регион для хранилища. Сведения о поддерживаемых регионах см. в разделе «Регионы» на странице [Расценки на службу Azure Site Recovery](http://go.microsoft.com/fwlink/?LinkId=389880).

6. Щелкните элемент **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-vmm-san/create-vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. Хранилище будет указано как **Активное** на главной странице **Службы восстановления**.


### Регистрация серверов VMM

1. Откройте страницу "Быстрый запуск" со страницы **Службы восстановления**. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Значок быстрого запуска](./media/site-recovery-vmm-san/quick-start-icon.png)

2. В раскрывающемся списке выберите элемент **Между локальным сайтом Hyper-V с помощью репликации массива**.

	![Регистрационный ключ](./media/site-recovery-vmm-san/select-san.png)


3. В разделе **Подготовка серверов VMM** скачайте последнюю версию файла для установки поставщика Azure Site Recovery.
4. Запустите этот файл на исходном сервере VM. Если развертывание VMM выполняется в кластере и вы устанавливаете поставщик впервые, установите его на активном узле и завершите установку, чтобы зарегистрировать сервер VMM в хранилище. Затем установите поставщик на других узлах. Учтите, что при обновлении поставщика потребуется обновить его на всех узлах, так как все они должны работать под управлением одной версии.
5. Установщик выполняет несколько **проверок предварительных требований** и запрашивает разрешение на остановку службы VMM, чтобы начать установку поставщика. Служба VMM автоматически перезапустится после завершения установки. При установке в кластере VMM будет выдан запрос на остановку роли Cluster.
6. В **Центре обновления Майкрософт** вы можете настроить обновления. Если этот параметр включен, то обновления поставщика будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Центр обновления Майкрософт](./media/site-recovery-vmm-san/ms-update.png)

7. Задано такое расположение установки: **<SystemDrive>\\Program Files\\Microsoft System Center 2012 R2\\Virtual Machine Manager\\bin**. Нажмите кнопку "Установить", чтобы начать установку поставщика.

	![InstallLocation](./media/site-recovery-vmm-san/install-location.png)

8. После установки поставщика нажмите кнопку "Зарегистрировать", чтобы зарегистрировать сервер в хранилище.

	![InstallComplete](./media/site-recovery-vmm-san/install-complete.png)

9. На странице **Подключение к Интернету** укажите, как запущенный на сервере VMM поставщик подключается к Интернету. Выберите пункт **Use default system proxy settings** (Использовать настройки прокси-сервера по умолчанию), чтобы использовать настройки подключения к Интернету, по умолчанию заданные на сервере.

	![Параметры Интернета](./media/site-recovery-vmm-san/proxy-details.png)

	- Если вы хотите использовать настраиваемый прокси-сервер, его следует настроить перед установкой поставщика. При настройке параметров прокси-сервера выполняется проверка подключения к прокси-серверу.
	- Если вы используете настраиваемый прокси-сервер или прокси-сервер по умолчанию требует выполнения проверки подлинности, вам потребуется указать сведения о прокси-сервере, включая его адрес и порт.
	- C сервера VMM должны быть доступны следующие URL-адреса и узлы Hyper-V:
		- **.hypervrecoverymanager.windowsazure.com
- **.accesscontrol.windows.net
- **.backup.windowsazure.com
- **.blob.core.windows.net
- **.store.core.windows.net
- Разрешите IP-адреса, перечисленные в статье [Диапазоны IP-адресов центров обработки данных Azure ](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протоколы HTTPS (443). Необходимо разрешить диапазоны IP-адресов региона Azure, который вы планируете использовать, и Запада США.
	- При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM. Для этого откройте рабочую область "Параметры", щелкните "Учетные записи запуска от имени", а затем измените пароль для учетной записи DRAProxyAccount. Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.

10. В поле **Регистрационный ключ** укажите, что вы скачали его с Azure Site Recovery и скопировали на сервер VMM.
11. В поле **Имя хранилища** проверьте имя хранилища, в котором будет зарегистрирован сервер. 

	![Регистрация сервера](./media/site-recovery-vmm-san/vault-creds.png)

12. Этот параметр шифрования используется только при репликации из VMM в Azure. Если вы используете только репликацию из VMM в VMM, этот экран можно проигнорировать.

	![Регистрация сервера](./media/site-recovery-vmm-san/encrypt.png)

13. В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
14. В разделе **Синхронизация метаданных в облаке** укажите понятное имя для сервера, которое будет отображаться в хранилище, и выберите, нужно ли синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.

	![Регистрация сервера](./media/site-recovery-vmm-san/friendly-name.png)

15. Для завершения процесса нажмите кнопку **Далее**. После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Сервер отображается на вкладке *Серверы VMM* на странице **Серверы** в хранилище.

### Установка из командной строки

Поставщик Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Например, скачайте файл установки поставщика и ключ регистрации в каталог C:\\ASR.
2. Остановите службу System Center Virtual Machine Manager.
3. Извлеките установщик поставщика, выполнив приведенные ниже команды в командной строке. Для этого нужны права **администратора**.

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. Установите поставщик с помощью следующей команды:

		C:\ASR> setupdr.exe /i

5. Зарегистрируйте поставщик с помощью следующей команды:

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>         

Используются следующие параметры:

 - **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.  
 - **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
 - **/EncryptionEnabled**: необязательный параметр, который необходимо использовать только при репликации из VMM в Azure, если требуется шифрование виртуальных машин, хранящихся в Azure. Убедитесь, что указанный файл имеет расширение **PFX**.
 - **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
 - **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
 - **/proxyusername**: необязательный параметр, указывающий имя пользователя прокси-сервера (если прокси-сервер требует выполнения проверки подлинности).
 - **/proxypassword**: необязательный параметр, который указывает пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует выполнения проверки подлинности).


## Шаг 3. Сопоставление пулов и массивов хранения

Сопоставьте массивы, чтобы указать пул вторичного хранилища, получающий данные репликации из основного пула. Сопоставьте хранилище перед настройкой облачной защиты, так как сведения о сопоставлении используются при включении защиты для групп репликации.

Перед началом работы убедитесь, что облака обнаруживаются в хранилище. Их можно обнаружить, выбрав синхронизацию всех облаков при установке поставщика или выбрав синхронизацию определенного облака на вкладке **Общие** меню свойств облака в консоли VMM. Затем сопоставьте массивы хранения данных следующим образом:

1. Щелкните **Ресурсы** > **Хранилище сервера** > **Сопоставить исходные и целевые массивы**.![Регистрация сервера](./media/site-recovery-vmm-san/storage-map.png)
2. Выберите массивы хранения данных на первичном узле и сопоставьте их с массивами на вторичном.
3.  Сопоставьте исходные и целевые пулы носителей в массивах. Для этого в поле **Пулы носителей** выберите исходный и целевой пулы носителей для сопоставления.

	![Регистрация сервера](./media/site-recovery-vmm-san/storage-map-pool.png)

## Шаг 4. Настройка параметров защиты облачных систем

После регистрации серверов VMM можно настроить параметры защиты облачных систем. Параметр **Синхронизировать облачные данные с хранилищем** был включен при установке поставщика, поэтому все облака на сервере VMM появятся на вкладке <b>Защищенные элементы</b> в хранилище.

![Опубликованное облако](./media/site-recovery-vmm-san/clouds-list.png)

1. На странице быстрого запуска щелкните **Set up protection for VMM clouds** (Установить защиту для облаков VMM).
2. На вкладке **Защищенные элементы** выберите облако, которое нужно настроить, и перейдите на вкладку **Конфигурация**. Обратите внимание на следующее:
3. В разделе <b>Цель</b> выберите <b>VMM</b>.
4. В поле <b>Целевое расположение</b> выберите локальный сервер VMM, управляющий облаком, которое вы хотите использовать для восстановления.
5. В поле <b>Целевое облако</b> укажите целевое облако, которое вы хотите использовать для отработки отказа виртуальных машин в исходном облаке. Обратите внимание на следующее:
	- Рекомендуется выбрать целевое облако, удовлетворяющее требованиям к восстановлению для виртуальных машин, которые планируется защитить.
	- Облако может относиться только к одной паре облаков — в качестве основного или целевого.
6. Azure Site Recovery проверяет наличие доступа облаков к действующему хранилищу репликации SAN и объединение массивов хранения данных в пиринговую сеть. Участвующие узлы массива отображаются.
7. Если проверка прошла успешно, в поле **Тип репликации** выберите **SAN**.

<p>После сохранения параметров создается задание, которое можно отслеживать на вкладке <b>Задания</b>. Параметры облака можно изменить на вкладке <b>Настройка</b>. Чтобы изменить целевое расположение или целевое облако после сохранения конфигурации, необходимо удалить эту конфигурацию облака и затем повторно настроить облако.</p>

## Шаг 5. Включение сетевого сопоставления

1. На странице быстрого запуска щелкните **Сопоставить сети**.
2. Выберите исходный сервер VMM, с которого требуется выполнять сопоставление сетей, а затем целевой сервер VMM, на котором будут сопоставляться сети. На экран будет выведен список исходных сетей и соответствующих им целевых сетей. Для сетей, которые не сопоставляются на данный момент, отображается пустое значение. Щелкните значок сведений рядом с именами исходной и целевой сетей для просмотра их подсетей.
3. Выберите сеть в меню **Сеть источника**, а затем **Сопоставить**. Служба обнаруживает сети виртуальных машин на целевом сервере и отображает их.

	![Архитектура SAN](./media/site-recovery-vmm-san/network-map1.png)

4. В появившемся диалоговом окне выберите одну из сетей виртуальных машин целевого сервера VMM.

	![Архитектура SAN](./media/site-recovery-vmm-san/network-map2.png)

5. При выборе целевой сети отображаются защищенные облака, использующие сеть источника. Также отображаются доступные целевые сети, связанные с облаками, используемыми для защиты. Рекомендуется выбрать целевую сеть, которая доступна для всех облаков, используемых для защиты.
6.  Установите флажок для завершения процесса сопоставления. Запускается задание, отслеживающее ход выполнения сопоставления. Его можно просмотреть на вкладке **Задания**.


## Шаг 6. Включение репликации для групп репликации</h3>

Перед включением защиты для виртуальных машин требуется активировать процесс репликации для групп хранения.

1. На портале Azure Site Recovery пройдите на страницу свойств основного облака и откройте вкладку **Виртуальные машины**. Щелкните **Добавить группу репликации**.
2. Выберите одну или несколько групп репликации VMM, связанных с облаком, проверьте исходные и целевые массивы и укажите частоту репликации.

После завершения этой операции Azure Site Recovery вместе с VMM и поставщиками SMI-S подготовят LUN для целевого узла хранилища и включат репликацию хранилища. Если группы репликации уже реплицированы, Azure Site Recovery использует существующую связь репликации и обновляет данные в Azure Site Recovery.

## Шаг 7. Включение защиты для виртуальных машин

После репликации группы хранения включите защиту для виртуальных машин в консоли VMM, применив один из следующих методов:

- **Новая виртуальная машина**. Во время создания новой виртуальной машины включите в консоли VMM защиту Azure Site Recovery и свяжите виртуальную машину с группой репликации. С помощью этого параметра VMM задействует интеллектуальное размещение, чтобы оптимально расположить хранилища виртуальных машин на LUN группы репликации. Azure Site Recovery организует создание теневой копии виртуальной машины на дополнительный узел и выделяет емкости так, чтобы реплики виртуальных машин можно было запустить после отработки отказа.
- **Существующая виртуальная машина**. Если виртуальная машина уже развернута в VMM, вы можете включить защиту Azure Site Recovery и выполнить миграцию хранилища в группу репликации. После этого VMM и Azure Site Recovery определят новую виртуальную машину в Azure Site Recovery для ее защиты и приступят к управлению этой машиной. Теневая копия виртуальной машины создается на дополнительном узле, а емкости выделены так, чтобы реплику виртуальной машины можно было запустить после отработки отказа.

	![Включить защиту](./media/site-recovery-vmm-san/enable-protect.png)

После включения защиты виртуальных машин, они отображаются в консоли Azure Site Recovery. На ней можно просмотреть свойства виртуальной машины, отслеживать состояние и аварийный переход на другой ресурс групп репликации, которые содержат несколько виртуальных машин. Обратите внимание, что в сети SAN репликации всех виртуальных машин, связанных с группой репликации, должны выполнить аварийный переход вместе. Это обусловлено тем, что данный переход сначала происходит на уровне хранилища. Очень важно правильно сформировать группы репликации групп и расположить вместе только связанные друг с другом виртуальные машины.

Следить за выполнением действия "Включение защиты", в том числе и за первоначальной репликацией, можно на вкладке **Задания**. После запуска задачи финализации защиты виртуальная машина готова к отработке отказа.

![Задание защиты виртуальной машины](./media/site-recovery-vmm-san/job-props.png)

## Шаг 8. Тестирование развертывания

Проведите тестирование развертывания, чтобы убедиться, что аварийный переход виртуальных машин и данных на другой ресурс происходит должным образом. Для этого требуется создать план восстановления, выбрав группы репликации. Затем нужно запустить тестовую отработку отказа для плана.

1. На вкладке **Планы восстановления** выберите **Создать план восстановления**.
2. Укажите имя плана восстановления, а также исходный и целевой серверы VMM. Исходный сервер должен содержать виртуальные машины, активированные для отработки отказа и восстановления. Выберите **SAN** для просмотра только тех облаков, которые настроены для репликации сети SAN. 3. ![Создать план восстановления](./media/site-recovery-vmm-san/r-plan.png)

4. В разделе **Выбор виртуальной машины** выберите группы репликации. Все виртуальные машины, связанные с группой репликации, будут выбраны и добавлены в план восстановления. Эти виртуальные машины добавляются в группу плана восстановления по умолчанию — группу 1. При необходимости можно внести дополнительные группы. Обратите внимание, что после репликации виртуальные машины запустятся в порядке, обеспечиваемым группами плана восстановления.

	![Добавить виртуальные машины](./media/site-recovery-vmm-san/r-plan-vm.png)
5. После создания план восстановления отобразится в списке на вкладке **Планы восстановления**.
6. На вкладке **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.
7. На странице **Подтверждение тестовой отработки отказа** выберите **Нет**. Обратите внимание, что реплики виртуальных машин, перешедших на другой ресурс, не будут подключены к какой-либо сети, если этот параметр включен. В данном случае проверяется, происходит ли аварийный переход виртуальной машины на другой ресурс, но не проверяется сетевая среда репликации. Узнайте, как [выполнить тестовую отработку отказа](site-recovery-failover.md#run-a-test-failover), чтобы больше узнать об использовании различных вариантов сетевых подключений.


	![Выбрать тестовую сеть](./media/site-recovery-vmm-san/test-fail1.png)


8. Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она не добавляется в облако, в котором находится реплика виртуальной машины.
9. Когда репликация завершена, реплика виртуальной машины получит IP-адрес, отличный от IP-адреса основной виртуальной машины. Если адреса выдаются из DHCP-сервера, то обновление будет происходить автоматически. Если DHCP не используется и нужно убедиться, что адреса совпадают, необходимо запустить несколько скриптов.
10. Запустите пример скрипта для получения IP-адреса.

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

11. Запустите пример скрипта для обновления DNS, указав IP-адрес, полученный с помощью предыдущего примера скрипта.

		[string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

## Дальнейшие действия

Запустив тестовую отработку отказа, чтобы проверить правильность работы среды, [ознакомьтесь](site-recovery-failover.md) с разными типами отработки отказа.

<!---HONumber=AcomDC_0128_2016-->