---
title: "Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware с помощью Azure Site Recovery | Документация Майкрософт"
description: "Узнайте, как настраивать аварийное восстановление в Azure для локальных виртуальных машин VMware с помощью службы Azure Site Recovery."
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 01/15/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 8acc8deff8b635c97e8722d65a728aebf0e49bb3
ms.sourcegitcommit: 7edfa9fbed0f9e274209cec6456bf4a689a4c1a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2018
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware

В этом руководстве показано, как настроить аварийное восстановление в Azure для локальных виртуальных машин VMware, работающих под управлением Windows. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Указание источника и целевого объекта репликации.
> * Настройка среды исходной репликации, включая локальные компоненты Site Recovery и целевую среду репликации.
> * Создание политики репликации
> * Включение репликации для виртуальных машин.

Это третье руководство в серии. В этом руководстве предполагается, что вы уже выполнили задачи в предыдущих руководствах:

1. [Подготовка Azure](tutorial-prepare-azure.md).
2. [Подготовка локальной среды VMware](tutorial-prepare-on-premises-vmware.md).

Перед началом работы полезно [изучить архитектуру](concepts-vmware-to-azure-architecture.md) для сценария аварийного восстановления.


## <a name="select-a-replication-goal"></a>Выбор цели репликации

1. В **хранилище служб восстановления** щелкните имя хранилища **ContosoVMVault**.
2. В разделе **Getting Started** (Начало работы) щелкните Site Recovery. Затем выберите **Prepare Infrastructure** (Подготовка инфраструктуры).
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе Where do you want to replicate your machines (Куда следует реплицировать компьютеры?) выберите **To Azure** (В Azure).
5. В разделе **Are your machines virtualized** (Ваши компьютеры виртуализированы?) выберите **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere). Нажмите кнопку **ОК**.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Чтобы настроить исходную среду, вам понадобится один высокодоступный локальный компьютер для размещения локальных компонентов Site Recovery. К этим компонентам относится сервер конфигурации и обработки, а также главный целевой сервер.

- Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- Сервер обработки выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service на виртуальную машину, которую требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.
- Главный целевой сервер обрабатывает данные репликации при восстановлении размещения с переносом из Azure.

Чтобы настроить сервер конфигурации в качестве высокодоступной виртуальной машины VMware, необходимо скачать подготовленный шаблон OVF и импортировать его в VMware для создания виртуальной машины. После настройки сервера конфигурации зарегистрируйте его в хранилище. После регистрации Site Recovery обнаружит локальные виртуальные машины VMware.

### <a name="download-the-vm-template"></a>Скачивание шаблона виртуальной машины

1. В хранилище выберите **Prepare Infrastructure** (Подготовка инфраструктуры)  > **Source** (Источник).
2. В разделе **Prepare source** (Подготовка источника) щелкните **+ Configuration Server** (+ Сервер конфигурации).
3. В колонке **Add Server** (Добавление сервера) в поле **Server type** (Тип сервера) должно быть указано **Configuration server for VMware** (Сервер конфигурации для VMware).
4. Скачайте шаблон Open Virtualization Format (OVF) для сервера конфигурации.

  > [!TIP]
  Вы можете скачать последнюю версию шаблона сервера конфигурации непосредственно из [Центра загрузки Майкрософт](https://aka.ms/asrconfigurationserver).

## <a name="import-the-template-in-vmware"></a>Импорт шаблона в VMware

1. Подключитесь к серверу VMware vCenter или узлу vSphere ESXi с помощью клиента VMWare vSphere.
2. В меню **File** (Файл) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить мастер развертывания шаблона OVF.  

     ![Шаблон OVF](./media/tutorial-vmware-to-azure/vcenter-wizard.png)

3. Укажите расположение загруженного шаблона OVF в разделе **Select source** (Выбрать источник).
4. В разделе **Review details** (Просмотр сведений) нажмите кнопку **Next** (Далее).
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** (Выбор хранилища), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки) в области **Select virtual disk format** (Выбор формата виртуального диска).
4. На остальных страницах мастера примите значение параметров по умолчанию.
5. На странице **Ready to complete** (Все готово к выполнению) сделайте следующее:
  - Чтобы настроить виртуальную машину с параметрами по умолчанию, выберите **Power on after deployment** (Включение после развертывания)  > **Finish** (Готово).
  - Если вы хотите добавить дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** (Включение после развертывания), а затем выберите **Finish** (Готово). По умолчанию шаблон сервера конфигурации развертывается с одним сетевым адаптером, но вы можете добавить дополнительные сетевые адаптеры после развертывания.

  
## <a name="add-an-additional-adapter"></a>Добавление дополнительного адаптера

Если вы хотите добавить дополнительный сетевой адаптер к серверу конфигурации, сделайте это до регистрации сервера в хранилище. Возможность добавления дополнительных адаптеров не поддерживается после регистрации.

1. В списке клиента vSphere щелкните виртуальную машину правой кнопкой мыши и выберите **Edit Settings** (Изменить параметры).
2. В разделе **Hardware** (Оборудование) выберите **Add** (Добавить)  > **Ethernet Adapter** (Адаптер Ethernet). Нажмите кнопку **Далее**.
3. Выберите тип адаптера и сеть. 
4. Чтобы подключить виртуальный сетевой адаптер на включенной виртуальной машине, выберите **Connect at power on** (Подключиться, когда включено). Выберите **Next** (Далее)  > **Finish** (Готово), а затем нажмите кнопку **ОК**.


## <a name="register-the-configuration-server"></a>Регистрация сервера конфигурации 

1. Из консоли клиента VMWare vSphere включите виртуальную машину.
2. Виртуальная машина загружается в среду установки Windows Server 2016. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите на виртуальную машину от имени администратора.
4. При первом входе в систему будет запущено средство настройки Azure Site Recovery.
5. Укажите имя, которое используется для регистрации сервера конфигурации с помощью Site Recovery. Нажмите кнопку **Далее**.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.
7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. Войдите на компьютер снова. Мастер управления сервером конфигурации запустится автоматически.

### <a name="configure-settings-and-connect-to-vmware"></a>Настройка параметров и подключение к VMware

1. В мастере управления сервером конфигурации щелкните **Setup connectivity** (Настройка подключения) и выберите сетевой адаптер, который будет принимать трафик репликации. Нажмите кнопку **Сохранить**. Этот параметр уже нельзя изменить после настройки.
2. В разделе **Select Recovery Services vault** (Выбор хранилища служб восстановления) выберите подписку Azure и соответствующие группу и хранилище ресурсов.
3. В разделе **Install third-party software** (Установка стороннего программного обеспечения) примите условия лицензионного соглашения и выберите **Download and Install** (Скачать и установить), чтобы установить сервер MySQL.
4. Щелкните **Install VMware PowerLCI** (Установить VMware PowerCLI). Прежде чем это сделать, закройте все окна браузера. Затем нажмите кнопку **Continue** (Продолжить).
5. Прежде чем вы продолжите, будут проверены предварительные требования в разделе **Validate appliance configuration** (Проверка конфигурации приложения).
6. В разделе **Configure vCenter Server/vSphere ESXi server** (Настройка сервера vCenter Server и vSphere ESXi) укажите полное доменное имя или IP-адрес сервера vCenter или узел vSphere, на которых расположены виртуальные машины для репликации. Укажите порт, который прослушивает сервер, и понятное имя, которое будет использоваться для сервера VMware в хранилище.
7. Укажите учетные данные, которые будут использоваться сервером конфигурации для подключения к серверу VMware. Site Recovery использует эти учетные данные для автоматического обнаружения виртуальных машин VMware, доступных для репликации. Щелкните **Add** (Добавить), а затем — **Continue** (Продолжить).
8. В разделе **Configure virtual machine credentials** (Настройка учетных данных виртуальной машины) укажите имя пользователя и пароль, которые будут использоваться для автоматической установки службы Mobility Service на компьютерах, когда репликация включена. Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать. Для Linux предоставьте сведения для учетной записи root.
9. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации. 
10. По окончании регистрации на портале Azure убедитесь, что сервер конфигурации и VMware указаны на странице **Источник** в хранилище. Нажмите кнопку **ОК** для настройки параметров целевого объекта.


Site Recovery подключается к серверам VMware, используя указанные вами параметры, и обнаруживает виртуальные машины.

> [!NOTE]
> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > ***имя сервера*** > **Обновить сервер**.

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите, какая целевая модель развертывания используется: классическая или Resource Manager.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Цель](./media/tutorial-vmware-to-azure/storage-network.png)

## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Откройте [портал Azure](https://portal.azure.com) и щелкните **Все ресурсы**.
2. Щелкните хранилище служб восстановления, которое называется **ContosoVMVault**.
3. Чтобы создать политику репликации, щелкните **Инфраструктура Site Recovery** > **Политики репликации** > **+Политика репликации**.
4. На странице **Создать политику репликации** укажите имя политики **VMwareRepPolicy**.
5. На странице **Пороговое значение RPO** используйте значение по умолчанию (60 минут). Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
6. В поле **Хранение точки восстановления** используйте значение по умолчанию (24 часа) для продолжительности периода хранения каждой точки восстановления. В этом руководстве мы используем 72 часа. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
7. В разделе **App-consistent snapshot frequency** (Периодичность создания моментальных снимков) используйте значение по умолчанию (60 минут) для частоты создания согласованных с приложением моментальных снимков. Нажмите кнопку **ОК** , чтобы создать политику.

   ![Политика](./media/tutorial-vmware-to-azure/replication-policy.png)

Политика автоматически сопоставляется с сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

## <a name="enable-replication"></a>Включение репликации

Site Recovery установит службу Mobility Service, если репликация включена для виртуальной машины. Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

Включите репликацию следующим образом:

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. Выберите сервер обработки (сервер конфигурации). Затем нажмите кнопку **ОК**.
6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.
7. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных.
8. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.
9. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
10. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.
11. В поле **Свойства** > **Настройка свойств** выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
12. Выберите **Параметры репликации** > **Configure replication settings** (Настройка параметров репликации) и убедитесь, что выбрана правильная политика репликации.
13. Щелкните **Включить репликацию**.

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

Для мониторинга добавляемых виртуальных машин можно указать последнее время обнаружения виртуальных машин, выбрав **Серверы конфигурации**.
> **Последний контакт в.** Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Run a disaster recovery drill to Azure](site-recovery-test-failover-to-azure.md) (Выполнение отработки аварийного восстановления в Azure)
