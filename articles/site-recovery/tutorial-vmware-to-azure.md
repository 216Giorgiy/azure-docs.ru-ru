---
title: "Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware с помощью Azure Site Recovery | Документация Майкрософт"
description: "Узнайте, как настраивать аварийное восстановление в Azure для локальных виртуальных машин VMware с помощью службы Azure Site Recovery."
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/18/2017
ms.author: raynew
ms.openlocfilehash: ee445c8af2fc6620385d9c462d4c6551da3d7367
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware

В этом руководстве показано, как настроить аварийное восстановление в Azure для локальных виртуальных машин VMware, работающих под управлением Windows. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание хранилища служб восстановления для Site Recovery.
> * Настройка исходной и целевой сред для репликации.
> * Создание политики репликации
> * Включение репликации для виртуальных машин.

Это третье руководство в серии. В этом руководстве предполагается, что вы уже выполнили задачи в предыдущих руководствах:

1. [Подготовка Azure](tutorial-prepare-azure.md).
2. [Подготовка локальной среды VMware](tutorial-prepare-on-premises-vmware.md).

Перед началом работы полезно [изучить архитектуру](concepts-vmware-to-azure-architecture.md) для сценария аварийного восстановления.

## <a name="configure-vmware-account-permissions"></a>Настройка разрешений учетной записи VMware

1. Создайте роль на уровне vCenter. Присвойте роли имя **Azure_Site_Recovery**.
2. Присвойте роли **Azure_Site_Recovery** следующие разрешения.

   **Задача.** | **Роль/Разрешения** | **Дополнительные сведения**
   --- | --- | ---
   **Обнаружение виртуальных машин** | Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь только для чтения (минимум).<br/><br/> Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
   **Полная репликация, отработка отказа, восстановление размещения** |  Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

## <a name="specify-what-you-want-to-replicate"></a>Настройка ресурсов для репликации

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для виртуальной машины. Для автоматической установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальной машине.

Вы можете использовать доменную или локальную учетную запись. Для виртуальных машин Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux. Для виртуальных машин Windows, если учетная запись домена не используется, отключите контроль удаленного доступа пользователей на локальном компьютере:

  - В разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Настройка среды источника состоит из следующих этапов: скачивание программы единой установки Site Recovery, настройка сервера конфигурации и его регистрация в хранилище, обнаружение виртуальных машин.

Сервер конфигурации — это единая локальная виртуальная машина VMware, на которой размещены все компоненты Site Recovery. На этой виртуальной машине выполняется сервер конфигурации и обработки, а также главный целевой сервер.

- Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- Сервер обработки выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service на виртуальную машину, которую требуется реплицировать, и выполняет автоматическое обнаружение виртуальных машин на локальных серверах VMware.
- Главный целевой сервер обрабатывает данные репликации при восстановлении размещения с переносом из Azure.

Виртуальная машина сервера конфигурации должна быть высокодоступной виртуальной машиной VMware, которая соответствует таким требованиям:

| **Требование** | **Дополнительные сведения** |
|-----------------|-------------|
| Количество ядер ЦП| 8 |
| ОЗУ | 12 ГБ |
| Количество дисков | 3 (диск ОС, диск кэша сервера обработки, диск хранения (для восстановления размещения)) |
| Свободное место на диске (кэш сервера обработки) | 600 ГБ |
| Свободное место на диске (диск хранения) | 600 ГБ |
| Версия операционной системы | Windows Server 2012 R2 |
| Язык операционной системы | Английский (en-us) |
| Версия VMware vSphere PowerCLI | [PowerCLI 6.0](https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=PCLI600R1 "PowerCLI 6.0") |
| Роли Windows Server | На включайте такие роли: доменные службы Active Directory, службы IIS, Hyper-V |
| Тип сетевой карты | VMXNET3 |
| Тип IP-адреса | Статическое |
| порты; | 443 (оркестрация канала управления)<br/>9443 (передача данных)|

Убедитесь, что на виртуальной машине сервера конфигурации системные часы синхронизированы с сервером времени.
Время должно быть синхронизировано до разницы не более 15 минут. Если разница во времени больше 15 минут, произойдет сбой установки.

Убедитесь, что сервер конфигурации виртуальной машины может получить доступ к таким URL-адресам:

- *.accesscontrol.windows.net. Используется для управления доступом и идентификаторами.
- *.backup.windowsazure.com. Используется для передачи данных репликации и координации.
- *.blob.core.windows.net. Используется для доступа к учетной записи хранения, в которой хранятся реплицируемые данные.
- *.hypervrecoverymanager.windowsazure.com. Используется для операций управления репликацией и координации.
- time.nist.gov и time.windows.com. Используются для проверки синхронизации системного и глобального времени.

URL-адреса для облака Azure для государственных организаций:

- *.ugv.hypervrecoverymanager.windowsazure.us
- *.ugv.backup.windowsazure.us
- *.ugi.hypervrecoverymanager.windowsazure.us
- *.ugi.backup.windowsazure.us

Любые правила брандмауэра на основе IP-адресов должны разрешать обмен данными с [IP-адресами из диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653), а также с портами 443 (HTTPS) и 9443 (репликация данных). Разрешите доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).

### <a name="download-the-site-recovery-unified-setup"></a>Скачивание программы единой установки Site Recovery

1. Откройте [портал Azure](https://portal.azure.com) и щелкните **Все ресурсы**.
2. Щелкните хранилище служб восстановления, которое называется **ContosoVMVault**.
3. Щелкните **Site Recovery** > **Prepare Infrastructure** (Подготовка инфраструктуры) > **Protection goal** (Цель защиты).
4. Выберите **Локально** для расположения ваших компьютеров и **В Azure** для расположения, в которое нужно реплицировать компьютеры, а затем выберите **Yes, with VMware vSphere Hypervisor** (Да, с использованием гипервизора VMware vSphere). Затем нажмите кнопку **ОК**.
5. В области подготовки источника щелкните **+ Configuration Server** (+ Сервер конфигурации).
6. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
7. Скачайте файл единой установки Site Recovery.
8. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение пяти дней после создания.

   ![Настройка источника](./media/tutorial-vmware-to-azure/source-settings.png)

### <a name="set-up-the-configuration-server"></a>Настройка сервера конфигурации

1. Запустите файл единой установки.
2. На странице **Перед началом работы** выберите **Install the configuration server and process server** (Установить сервер конфигурации и сервер обработки) и нажмите кнопку **Далее**.

3. В окне **Third Party Software License** (Лицензия на программное обеспечение стороннего поставщика) щелкните **Принимаю**, чтобы скачать и установить MySQL, а затем щелкните **Далее**.

4. В окне **Регистрация** выберите регистрационный ключ, скачанный из хранилища.

5. В окне **Internet Settings** (Параметры Интернета) укажите параметры для подключения поставщика, который будет выполняться на сервере конфигурации, к Azure Site Recovery через Интернет.

   - Чтобы подключаться с помощью прокси-сервера, который уже настроен на компьютере, выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**.
   - Чтобы поставщик подключался напрямую, выберите **Подключиться к Azure Site Recovery напрямую без прокси-сервера**.
   - Если для имеющегося прокси-сервера требуется аутентификация или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера), а затем укажите адрес, порт и учетные данные.

   ![Брандмауэр](./media/tutorial-vmware-to-azure/combined-wiz4.png)

6. В окне **Проверка необходимых компонентов** программа установки проверяет возможность установки. Если появится предупреждение о **проверке глобальной синхронизации времени**, убедитесь, что время системных часов (параметры **даты и времени**) соответствует часовому поясу.

   ![Предварительные требования](./media/tutorial-vmware-to-azure/combined-wiz5.png)

7. На странице **Конфигурация MySQL** создайте учетные данные для входа в экземпляр сервера MySQL, который будет установлен.

8. В области **Сведения о среде** выберите **Да**, чтобы защитить виртуальные машины VMware. Программа установки проверяет, установлен ли компонент PowerCLI 6.0.

9. На странице **Расположение установки** выберите место для установки двоичных файлов и хранения кэша. Выбранный вами диск кэша должен иметь не менее 5 ГБ доступной памяти. Однако рекомендуемый объем — не менее 600 ГБ.

10. На странице **Выбор сети** укажите прослушиватель (сетевой адаптер и порт SSL), через который сервер конфигурации будет отправлять и получать данные репликации. Порт 9443 — это стандартный порт для отправки и приема трафика репликации, но вы можете изменить номер порта в соответствии с требованиями среды. Мы также откроем порт 433, который используется для оркестрации операций репликации. Не следует использовать порт 443 для отправки и приема трафика репликации.

11. Просмотрите информацию на странице **Сводка** и нажмите кнопку **Установить**. Программа установки установит сервер конфигурации и зарегистрирует его в службе Azure Site Recovery.

    ![Сводка](./media/tutorial-vmware-to-azure/combined-wiz10.png)

    Когда установка завершится, будет создана парольная фраза. Они потребуются при включении репликации, поэтому ее необходимо скопировать и сохранить в безопасном месте. Сервер отображается в области **Параметры** > **Серверы** в хранилище.

### <a name="configure-automatic-discovery"></a>Настройка автоматического обнаружения

Чтобы обнаружить виртуальные машины, серверу конфигурации необходимо подключиться к локальным серверам VMware. В рамках этого руководства добавьте сервер vCenter или узлы vSphere на сервер с помощью учетной записи с правами администратора.

1. На сервере конфигурации запустите файл **CSPSConfigtool.exe**. Он доступен через ярлык на рабочем столе и расположен в папке *install location*\home\svsystems\bin.

2. Выберите **Управление учетными записями** > **Добавить учетную запись**.

   ![Добавить учетную запись](./media/tutorial-vmware-to-azure/credentials1.png)

3. В разделе **Сведения об учетной записи** добавьте учетную запись, которая будет использоваться для автоматического обнаружения.

   ![Сведения](./media/tutorial-vmware-to-azure/credentials2.png)

Чтобы добавить сервер, сделайте следующее:

1. Откройте [портал Azure](https://portal.azure.com) и щелкните **Все ресурсы**.
2. Щелкните хранилище служб восстановления, которое называется **ContosoVMVault**.
3. Щелкните **Site Recovery** > **Prepare Infrastructure** (Подготовка инфраструктуры) > **Источник**.
4. Выберите **+vCenter**, чтобы подключиться к серверу vCenter или узлу vSphere ESXi.
5. В области **Add vCenter** (Добавить vCenter) укажите понятное имя для сервера. Затем задайте IP-адрес или полное доменное имя.
6. Если серверы VMware ожидают передачи данных запросов через другой порт, оставьте порт 443.
7. Выберите учетную запись, используемую для подключения к серверу. Нажмите кнопку **ОК**.

Site Recovery подключается к серверам VMware, используя указанные вами параметры, и обнаруживает виртуальные машины.

> [!NOTE]
> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > ***имя сервера*** > **Обновить сервер**.

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите, какая целевая модель развертывания используется: классическая или Resource Manager.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Цель](./media/tutorial-vmware-to-azure/storage-network.png)

## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Откройте [портал Azure](https://portal.azure.com) и щелкните **Все ресурсы**.
2. Щелкните хранилище служб восстановления, которое называется **ContosoVMVault**.
3. Чтобы создать политику репликации, щелкните **Инфраструктура Site Recovery** > **Политики репликации** > **+Политика репликации**.
4. На странице **Создать политику репликации** укажите имя политики **VMwareRepPolicy**.
5. На странице **Пороговое значение RPO** используйте значение по умолчанию (60 минут). Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
6. В поле **Хранение точки восстановления** используйте значение по умолчанию (24 часа) для продолжительности периода хранения каждой точки восстановления. В этом руководстве мы используем 72 часа. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
7. В разделе **App-consistent snapshot frequency** (Периодичность создания моментальных снимков) используйте значение по умолчанию (60 минут) для частоты создания согласованных с приложением моментальных снимков. Нажмите кнопку **ОК** , чтобы создать политику.

   ![Политика](./media/tutorial-vmware-to-azure/replication-policy.png)

Политика автоматически сопоставляется с сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

## <a name="enable-replication"></a>Включение репликации

Site Recovery установит службу Mobility Service, если репликация включена для виртуальной машины. Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

Включите репликацию следующим образом:

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. Выберите сервер обработки (сервер конфигурации). Затем нажмите кнопку **ОК**.
6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.
7. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных.
8. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.
9. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
10. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.
11. В поле **Свойства** > **Настройка свойств** выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
12. Выберите **Параметры репликации** > **Configure replication settings** (Настройка параметров репликации) и убедитесь, что выбрана правильная политика репликации.
13. Щелкните **Включить репликацию**.

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

Для мониторинга добавляемых виртуальных машин можно указать последнее время обнаружения виртуальных машин, выбрав **Серверы конфигурации**.
> **Последний контакт в.** Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Run a disaster recovery drill to Azure](site-recovery-test-failover-to-azure.md) (Выполнение отработки аварийного восстановления в Azure)
