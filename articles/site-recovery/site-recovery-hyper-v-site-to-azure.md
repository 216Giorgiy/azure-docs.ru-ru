<properties
	pageTitle="Настройка защиты между локальным узлом Hyper-V и Azure"
	description="Azure Site Recovery управляет репликацией, восстановлением и отработкой отказа виртуальных машин, размещенных на локальных серверах Hyper-V, с использованием Azure."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="11/18/2015"
	ms.author="raynew"/>


# Настройка защиты между локальным узлом Hyper-V и Azure


## Обзор

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнеса и восстановления после сбоев (BCDR), управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Сведения о возможных сценариях развертывания см. в статье [Обзор Site Recovery](site-recovery-overview.md).

В этой статье описывается развертывание Site Recovery для репликации виртуальных машин, размещенных на локальных серверах Hyper-V под управлением Windows Server 2012 R2. Репликацией в хранилище Azure управляет Site Recovery. Такое развертывание особенно полезно, если запущены серверы Hyper-V, но среда System Center Virtual Machine Manager (VMM) не развернута.


## Об этой статье

Эта статья содержит необходимые условия развертывания, а также поможет вам настроить параметры репликации и включить защиту виртуальных машин. В заключение приводится процедура тестирования отработки отказа для подтверждения правильной работы всех компонентов.

Если у вас возникают проблемы, опубликуйте свои вопросы на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Перед началом работы

Прежде чем приступить к работе с учебником, убедитесь в выполнении всех предварительных требований.

### Предварительные требования Azure

- Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](pricing/free-trial/).
- Для хранения реплицируемых данных потребуется учетная запись хранения Azure. На учетной записи необходимо включить георепликацию. Она должна находиться в том же регионе, что и хранилище Azure Site Recovery, и быть связана с той же подпиской. Дополнительные сведения см. в статье [Введение в хранилище Microsoft Azure](../storage/storage-introduction.md).
- Вам потребуется виртуальная сеть Azure, чтобы реплицированные виртуальные машины были подключены к сети после отработки отказа.

### Предварительные требования Hyper-V

- В исходном локальном сайте вам понадобится как минимум один сервер, работающий под управлением версии Windows Server 2012 R2 с ролью Hyper-V.
- Сервер Hyper-V должен содержать одну или несколько виртуальных машин.
- Серверы Hyper-V должны быть подключены к Интернету напрямую или через прокси-сервер.
- На серверах Hyper-V должны быть установлены исправления, упомянутые в статье базы знаний [KB2961977](https://support.microsoft.com/ru-RU/kb/2961977 "KB2961977").

### Предварительные требования к виртуальным машинам

Виртуальные машины, которые требуется защитить, должны отвечать [предварительным требованиям к виртуальным машинам](site-recovery-best-practices.md#virtual-machines).

### Предварительные требования к поставщикам и агентам

При развертывании Azure Site Recovery мы установим поставщика Azure Site Recovery и агента служб восстановления Azure на каждом сервере Hyper-V, где запущены виртуальные машины, которые необходимо защитить. Обратите внимание на следующее.

- Следует запускать последние версии поставщика и агента.
- Все серверы Hyper-V в хранилище должны иметь одинаковые версии.
- Поставщику потребуется подключиться к Azure Site Recovery через Интернет. Это можно сделать без прокси-сервера, используя параметры прокси, настроенные на сервере VMM, или с помощью пользовательских параметров прокси, которые вы настраиваете во время установки поставщика. Чтобы использовать существующий прокси-сервер, убедитесь, что URL-адреса для подключения к Azure пропускаются через брандмауэр:
	- *.hypervrecoverymanager.windowsazure.com
	- *.accesscontrol.windows.net
	- *.backup.windowsazure.com
	- *.blob.core.windows.net
	- *.store.core.windows.net
 
- Чтобы использовать пользовательский прокси, настройте прокси-сервер перед установкой поставщика. Во время установки поставщика необходимо указать адрес прокси-сервера и порт, а также учетные данные, которые можно использовать для доступа. Обратите внимание, что прокси-сервер на основе HTTPS не поддерживается.

На рисунке ниже показаны различные каналы связи и порты, используемые Azure Site Recovery для оркестрации и репликации.

![Топология B2A](./media/site-recovery-hyper-v-site-to-azure/B2ATopology.png)


## Шаг 1. Создание хранилища

1. Выполните вход на [Портал управления](https://portal.azure.com).


2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.


3. Выберите **Создать** > **Быстрое создание**.

4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Область** выберите географический регион для хранилища архивации. Сведения о поддерживаемых регионах см. в разделе "Регионы" страницы [Расценки на службу Azure Site Recovery](pricing/details/site-recovery/).

6. Щелкните элемент **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/SR_HvVault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. На главной странице служб восстановления это хранилище будет указано с состоянием **Активно**.


## Шаг 2. Создание узла Hyper-V

1. На странице Службы восстановления щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Быстрый запуск](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_QuickStartIcon.png)

2. В раскрывающемся списке выберите элемент **Между локальным узлом Hyper-V и Microsoft Azure**.

	![Сценарий узла Hyper-V](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_SelectScenario.png)

3. В разделе **Создание узла Hyper-V** щелкните **Создать узел Hyper-V**. Укажите имя узла и сохраните.

	![Узел Hyper-V](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_CreateSite2.png)


## Шаг 3. Установка поставщика и агента
Установка поставщика и агента При установке в кластере Hyper-V выполните шаги с 5-11 на каждом узле отказоустойчивого кластера. После регистрации всех узлов и включения защиты виртуальные машины будут защищены, даже если они будут переноситься между узлами отказоустойчивого кластера.

1. В разделе **Подготовка серверов Hyper-V** нажмите пункт **Загрузить регистрационный ключ**.
2. На странице **Загрузить регистрационный ключ** щелкните пункт **Загрузка** рядом с узлом. Скачайте ключ в безопасное расположение, легко доступное для сервера Hyper-V. Ключ действителен в течение пяти дней после создания.

	![Регистрационный ключ](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_DownloadKey2.png)

4. Щелкните **Скачать поставщик** для получения последней версии.
5. Запустите файл на каждом сервере Hyper-V, который нужно зарегистрировать в хранилище. Файл устанавливает два компонента:
	- **Поставщик Azure Site Recovery** — обеспечивает возможность связи и оркестрации между сервером Hyper-V и порталом Azure Site Recovery.
	- **Агент служб восстановления Azure** — обрабатывает передачу данных между виртуальными машинами, работающими на исходном сервере Hyper-V и в хранилище Azure.
6. В **Центре обновления Майкрософт** вы можете настроить обновления. Если этот параметр включен, то обновления поставщика и агента будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Центр обновления Майкрософт](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider1.png)

7. В поле **Установка** укажите место на сервере Hyper-V для установки поставщика и агента.

	![Расположение установки](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider2.png)

8. После завершения установки продолжите настройку, чтобы зарегистрировать сервер в хранилище.

	![Установка завершена](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider3.png)


9. На странице **Подключение к Интернету** укажите способ подключения поставщика к Azure Site Recovery. Выберите пункт **Use default system proxy settings** (Использовать настройки прокси-сервера по умолчанию), чтобы использовать настройки подключения к Интернету, по умолчанию заданные на сервере. Если значение не указано, будут использоваться параметры по умолчанию.

	![Параметры Интернета](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider4.png)

	Обратите внимание на следующее.

	- Если прокси-сервер по умолчанию на сервере Hyper-V требует проверку подлинности, то следует выбрать пользовательский прокси-сервер. Введите параметры прокси-сервера по умолчанию и укажите учетные данные.
	- Если вы хотите использовать настраиваемый прокси-сервер, настройте его перед установкой поставщика.
	- Следующие URL-адреса должны быть доступны c узла Hyper-v:
		- *.hypervrecoverymanager.windowsazure.com
		- *.accesscontrol.windows.net
		- *.backup.windowsazure.com
		- *.blob.core.windows.net
		- *.store.core.windows.net

	- Разрешите IP-адреса, перечисленные в статье [Диапазоны IP-адресов центров обработки данных Azure ](http://go.microsoft.com/fwlink/?LinkId=511094) и протоколы HTTPS (443). Необходимо разрешить диапазоны IP-адресов региона Azure, который вы планируете использовать, и Запада США.

9. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать файл ключа. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_SelectKey.png)


11. Начнется процесс регистрации сервера в хранилище.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider6.png)

11. После завершения регистрации Azure Site Recovery извлекает метаданные из сервера Hyper-V, а сам сервер отображается на вкладке **Узлы Hyper-V** страницы **Серверы** в хранилище.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider7.png)

>[AZURE.NOTE]Поставщик Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Например, скачайте файл установки поставщика и ключ регистрации в каталог C:\\ASR.
1. Извлеките установщик поставщика, выполнив приведенные ниже команды в командной строке. Для этого нужны права **администратора**.

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
1. Установите поставщик с помощью следующей команды:

		C:\ASR> setupdr.exe /i
1. Зарегистрируйте поставщик с помощью следующей команды:

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>         



#### Список параметров установки для командной строки

 - **/Credentials**: обязательный параметр, который задает расположение регистрационного ключа.  
 - **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
 - **/EncryptionEnabled**: необязательный параметр, который необходимо использовать только при репликации из VMM в Azure, если требуется шифрование виртуальных машин, находящихся в неактивном состоянии в Azure. Убедитесь, что указанный файл имеет расширение **PFX**.
 - **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
 - **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
 - **/proxyUsername**: необязательный параметр, указывающий имя пользователя прокси-сервера (если прокси-сервер требует выполнения проверки подлинности).
 - **/proxyPassword**: необязательный параметр, который задает пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует проверки подлинности).  

>[AZURE.TIP]При репликации виртуальных машин в Azure можно настроить различные настройки полосы пропускания сети в каждом узле Hyper-V. Ознакомьтесь с дополнительной информацией о том, [как управлять локальными ресурсами для использования пропускной способности защищенной сети Azure](https://support.microsoft.com/RU-RU/kb/3056159).


## Шаг 4. Создание ресурсов Azure

1. В разделе **Подготовка ресурсов** выберите **Создать учетную запись хранения** для создания учетной записи хранения Azure, если таковой нет. Для учетной записи необходимо включить георепликацию. Она должна находиться в том же регионе, что и хранилище Azure Site Recovery, и быть связана с той же подпиской.

	![Создание учетной записи хранения](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_CreateResources1.png)

## Шаг 5. Создание и настройка групп защиты

Группы защиты — это логические группы виртуальных машин, которые требуется защитить, используя те же параметры защиты. Параметры, установленные для группы защиты, будут применяться ко всем виртуальным машинам, добавленным в группу. 1. В поле **Создание и настройка групп защиты** щелкните **Создать группу защиты**. Если выполнены не все предварительные требования, выдается сообщение об этом. Чтобы получить подробную информацию, щелкните пункт сообщения **Просмотр сведений**.

2. На вкладке **Группы защиты** добавьте группу защиты. Укажите имя, исходный узел Hyper-V, целевой ресурс **Azure**, имя подписки Azure Site Recovery и учетную запись хранения Azure.

	![Группа защиты](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_ProtectionGroupCreate3.png)


2. В разделе **Параметры репликации** задайте параметр **Частота копирования**, чтобы указать, как часто дельта данных должна быть синхронизирована между источником и целью. Можно выбрать значение 30 секунд, 5 минут или 15 минут.
3. В поле **Сохранять точки восстановления** укажите, сколько часов журнала восстановления следует сохранять.
4. В поле **Частота моментальных снимков, соответствующих приложению** можно указать, создавать ли снимки, использующие службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. По умолчанию они не создаются. Это значение должно быть меньше количества дополнительных точек восстановления, которое было настроено. Это поддерживается только в том случае, если виртуальная машина работает под управлением операционной системы Windows.
5. В поле **Время запуска начальной репликации** укажите, когда начальная репликация виртуальных машин в группе защиты должна отправляться в Azure.

	![Группа защиты](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_ProtectionGroup4.png)


## Шаг 6. Включение защиты виртуальной машины


Добавьте виртуальные машины в группу защиты, чтобы включить для них защиту.

1. На вкладке **Машины** для группы защиты щелкните **Add virtual machines to protection groups to enable protection** (Добавить виртуальные машины в группы защиты для обеспечения защиты).
2. На странице **Включение защиты виртуальной машины** выберите виртуальные машины, которые следует защитить.

	![Включение защиты виртуальной машины](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_AddVM3.png)

	Запускается задание включения защиты. Ход выполнения операции можно отслеживать на вкладке **Задания**. После запуска задачи финализации защиты виртуальная машина готова к отработке отказа.
3. После настройки защиты вы можете:

	- просмотреть виртуальные машины, выбрав элементы **Защищенные элементы** > **Группы защиты** > *имя\_группы* > **Виртуальные машины**. Вы можете просмотреть подробные сведения о машинах на вкладке **Свойства**;
	- настраивать свойства отработки отказа для виртуальных машин в разделе **Защищенные элементы** > **Группы защиты** > *имя\_группы* > **Виртуальные машины** *имя\_виртуальной\_машины* > **Настройка**. Вы можете настроить:
		- **Имя**: имя виртуальной машины в Azure.
		- **Размер**: целевой размер виртуальной машины, отрабатывающей отказ.

		![Настройка свойств виртуальной машины](./media/site-recovery-hyper-v-site-to-azure/VMProperties.png)
	- настраивать в разделе **Защищенные элементы** > **Группы защиты** > *имя\_группы* > **Виртуальные машины** *имя\_виртуальной\_машины* > **Настройка** дополнительные параметры виртуальных машин, в том числе:

		- **Сетевые адаптеры**: количество сетевых адаптеров диктуется размером, указанным для целевой виртуальной машины. Ознакомьтесь со [спецификациями размеров виртуальной машины](../virtual-machines/virtual-machines-size-specs.md#size-tables), чтобы узнать количество сетевых адаптеров, поддерживаемых размером виртуальной машины. 
		

			После изменения размера виртуальной машины и сохранения параметров при следующем открытии страницы **Настройка** будут показаны сетевые адаптеры. Количество сетевых адаптеров целевой виртуальной машины равно меньшему из числа сетевых адаптеров исходной виртуальной машины и максимального числа сетевых адаптеров, поддерживаемых размером выбранной виртуальной машины. Пояснения приведены ниже.


			- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
			- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
			- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер. 	
		- **Сеть Azure**: укажите сеть, в которую должна переходить виртуальная машина. Если у виртуальной машины несколько сетевых адаптеров, то все адаптеры должны быть подключены к одной сети Azure.
		- **Подсеть**: выберите для каждого сетевого адаптера на виртуальной машине подсеть в сети Azure, к которой машина должна подключаться после отработки отказа.
		- **Целевой IP-адрес**: если сетевой адаптер исходной виртуальной машины настроен для использования статического IP-адреса, то вы можете указать IP-адрес для целевой виртуальной машины, чтобы IP-адрес машины гарантированно не изменился после отработки отказа. Если IP-адрес не указан, то во время отработки отказа будет назначен любой доступный адрес. Если указать адрес, который уже используется, то при отработке отказа произойдет сбой.

		![Настройка свойств виртуальной машины](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_VMMultipleNic.png)

>[AZURE.NOTE]Виртуальные машины Linux, использующие статический IP-адрес, не поддерживаются.


## Шаг 7. Создание плана восстановления

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин. Создать план восстановления можно с помощью [этих инструкций](site-recovery-create-recovery-plans.md).

## Шаг 8. Тестирование развертывания

Существует два способа запуска тестовой отработки отказа в Azure.

- Тестовая отработка отказа без сети Azure. Этот тип тестовой отработки отказа проверяет правильную работу виртуальной машины в Azure. Виртуальная машина не подключается к сети Azure после отработки отказа.
- Тестовая отработка отказа с сетью Azure. Этот тип отработки отказа проверяет, работает ли вся среда репликации, как ожидалось, и подключаются ли виртуальные машины, для которых выполнена отработка отказа, к указанной целевой сети Azure. Что касается подсетей, для тестовой отработки отказа подсеть тестовой виртуальной машины будет определяться в зависимости от подсети реплики виртуальной машины. Этот режим отличается от обычной репликации, когда подсеть реплики виртуальной машины основывается на подсети исходной виртуальной машины.

Если вы хотите выполнить тестовую отработку отказа для виртуальной машины с включенной защитой в Azure без указания целевой сети Azure, никакой подготовки не требуется. Для запуска тестовой отработки отказа с целевой сетью Azure потребуется создать новую сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании новой сети в Azure). Дополнительные сведения см. в разделе [Запуск тестовой отработки отказа](site-recovery-failover.md#run-a-test-failover).


Также необходимо будет настроить инфраструктуру так, чтобы реплицируемая виртуальная машина работала должным образом. Допустим, виртуальная машина с контроллером домена и DNS может быть реплицирована в Azure с помощью Azure Site Recovery и создана в тестовой сети с помощью тестовой отработки отказа. Дополнительные сведения см. в разделе [Рекомендации по отработке отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).

Для запуска тестовой отработки отказа сделайте вот что:

1. На вкладке **Планы восстановления** выберите план и нажмите **Тестовая отработка отказа**.
2. На **странице подтверждения тестовой отработки отказа** выберите **Нет** или конкретную сеть Azure. Учтите, что при выборе варианта **Нет** в ходе тестовой отработки отказа будет проверяться правильность репликации виртуальной машины в Azure, но не конфигурация сети репликации.

	![Тестовая отработка отказа](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_TestFailoverNoNetwork.png)

3. На вкладке **Задания** можно отследить ход выполнения отработки отказа. Кроме того, вы можете просмотреть тестовую реплику виртуальной машины на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
4. После того как отработка отказа достигнет фазы **Полное тестирование**, нажмите **Завершить тестирование**, чтобы закончить действие. Вы можете перейти на вкладку **Задания**, чтобы отслеживать ход выполнения отработки отказа и изменение ее состояния, а также выполнять прочие необходимые действия.
5. После отработки отказа тестовая реплика виртуальной машины будет отображаться на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.

	1. Проверьте, успешно ли выполнен запуск виртуальных машин.
    2. При необходимости подключиться к виртуальной машине в Azure с использованием удаленного рабочего стола после отработки отказа, включите подключение удаленного рабочего стола на виртуальной машине до запуска тестирования отработки отказа. Кроме того, на виртуальной машине потребуется добавить конечную точку RDP. Для этого можно использовать модули [Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).
    3. После отработки отказа, если вы используете общедоступный IP-адрес для подключения к виртуальной машине в Azure с помощью удаленного рабочего стола, убедитесь, что у вас нет политик доменов, которые препятствуют подключению к виртуальной машине с помощью общедоступного адреса.

6. После завершения тестирования выполните следующие действия:

	- Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовые виртуальные машины.
	- Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
7. После того как отработка отказа достигнет фазы **Полное тестирование**, выполните следующую проверку:
	1. Просмотрите реплику виртуальной машины на портале Azure. Проверьте, успешно ли выполнен запуск виртуальной машины.
	2. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
	3. Щелкните **Завершить проверку** для завершения действия.
	4. Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
	5.  Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовую виртуальную машину.

## Дальнейшие действия

Настроив и запустив развертывание, см. [дополнительные сведения](site-recovery-failover.md) об обработке отказов.

<!---HONumber=AcomDC_1125_2015-->