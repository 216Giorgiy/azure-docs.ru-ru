---
title: "Репликация виртуальных машин Hyper-V в Azure | Документация Майкрософт"
description: "В этот статье описано, как управлять репликацией, отработкой отказа и восстановлением локальных виртуальных машин Hyper-V в Azure"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 1777e0eb-accb-42b5-a747-11272e131a52
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 02/19/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: 67b4861ac564565b2a36932ae15141a1e1f56035
ms.openlocfilehash: c4129d5b5ebd0295035e81760b2a39f3caf16499
ms.lasthandoff: 02/23/2017

---

# <a name="replicate-hyper-v-virtual-machines-without-vmm-to-azure-using-azure-site-recovery-with-the-azure-portal"></a>Репликация виртуальных машин Hyper-V (без VMM) в облако Azure с помощью службы Azure Site Recovery и портала Azure
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-hyper-v-site-to-azure.md)
> * [Классическая модель Azure](site-recovery-hyper-v-site-to-azure-classic.md)
> * [PowerShell — Resource Manager](site-recovery-deploy-with-powershell-resource-manager.md)
>
>

В этой статье описано, как выполнить репликацию локальных виртуальных машин Hyper-V в Azure с помощью [Azure Site Recovery[](site-recovery-overview.md) на портале Azure.

Вы можете реплицировать виртуальные машины Hyper-V в службу хранилища Azure и выполнить отработку отказа виртуальных машин в Azure, если основной сайт недоступен. Вы можете получать доступ к рабочим нагрузкам в Azure и восстановить размещение на локальном сайте, когда он вернется к нормальному режиму работы. Вы также можете перенести виртуальные машины в Azure, используя сведения в этой статье. В сценарии переноса данных можно выполнить репликацию и отработку отказа виртуальных машин, но нельзя выполнить обратную обработку отказа.

Комментарии или вопросы технического характера можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="scenario-architecture"></a>Архитектура сценария
Ниже приведены компоненты, участвующие в сценарии:

* **Узел или кластер Hyper-V**. Локальные серверы узлов или кластеры Hyper-V. При развертывании службы Site Recovery узлы Hyper-V, где запущены виртуальные машины, которые нужно защитить, будут собраны в логические узлы Hyper-V.
* **Агент служб восстановления и поставщик Azure Site Recovery**. Во время развертывания необходимо установить поставщик Azure Site Recovery, а на узле Hyper-V — агент служб восстановления Microsoft Azure. Поставщик обменивается данными со службой Azure Site Recovery через порт HTTPS 443 для репликации оркестрации. По умолчанию агент на сервере узла Hyper-V реплицирует данные в службу хранилища Azure через порт HTTPS 443.
* **Azure**. Требуется подписка Azure, учетная запись хранения Azure для хранения реплицированных данных и виртуальная сеть Azure для подключения виртуальных машин Azure к сети после отработки отказа.

![Архитектура узла Hyper-V](./media/site-recovery-hyper-v-site-to-azure/architecture.png)

## <a name="azure-prerequisites"></a>Предварительные требования Azure


| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Учетная запись Azure** | Учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. |
| **Служба хранилища Azure** | Учетная запись хранения класса Standard. Подойдет учетная запись хранения LRS или GRS. Рекомендуется использовать учетную запись хранения GRS, чтобы обеспечить устойчивость данных в случае отключения электричества в регионе или при отсутствии возможности восстановления основного региона. [Подробнее](../storage/storage-redundancy.md).<br/><br/> Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.<br/><br/> Хранилище класса Premium не поддерживается.<br/><br/> Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure создаются при отработке отказа.<br/><br/> [Прочтите статью](../storage/storage-introduction.md) о службе хранилища Azure. |
| **Сеть Azure** |Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище служб восстановления. |

## <a name="on-premises-prerequisites"></a>Предварительные требования для локальной среды
Вам потребуются следующие компоненты в локальной среде.

| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Hyper-V** |Один или несколько локальных серверов под управлением **Windows Server 2012 R2** с последними обновлениями и установленной ролью Hyper-V или **Microsoft Hyper-V Server 2012 R2**.<br/><br/>Сервер Hyper-V должен содержать одну или несколько виртуальных машин.<br/><br/>Серверы Hyper-V должны быть подключены к Интернету напрямую или через прокси-сервер.<br/><br/>На серверах Hyper-V должны быть установлены исправления, упомянутые в статье базы знаний [KB2961977](https://support.microsoft.com/en-us/kb/2961977 "KB2961977"). |
| **Поставщик и агент** |Во время развертывания Azure Site Recovery устанавливается поставщик Azure Site Recovery. На каждом сервере Hyper-V, где запущены виртуальные машины, которые необходимо защитить, при установке поставщика также устанавливается агент служб восстановления Azure. На всех серверах Hyper-V в хранилище Site Recovery должны быть одинаковые версии поставщика и агента.<br/><br/>Поставщику потребуется подключиться к Azure Site Recovery через Интернет. Трафик может передаваться напрямую или через прокси-сервер. Обратите внимание, что прокси-сервер на основе HTTPS не поддерживается. На прокси-сервере должен быть разрешен доступ к следующим URL-адресам: <br/><br/> ``*.accesscontrol.windows.net``<br/><br/> ``*.backup.windowsazure.com``<br/><br/> ``*.hypervrecoverymanager.windowsazure.com`` <br/><br/> ``*store.core.windows.net``<br/><br/> ``*.blob.core.windows.net``<br/><br/> ``https://www.msftncsi.com/ncsi.txt``<br/><br/> ``time.windows.com``<br/><br/> ``time.nist.gov``<br/><br/> При использовании на сервере правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/><br/> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).<br/><br/> Необходимо разрешить диапазоны IP-адресов для региона Azure в вашей подписке и для региона "Западная часть США". |

## <a name="virtual-machine-prerequisites"></a>Предварительные требования к виртуальным машинам
| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Защищенные виртуальные машины** |Перед отработкой отказа на виртуальной машине убедитесь, что имя, которое будет назначено виртуальной машине Azure, соответствует [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements). После включения репликации для виртуальной машины это имя можно будет изменить.<br/><br/> Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ).<br/><br/> Гостевые кластеры общих дисков не поддерживаются.<br/><br/> Если исходная виртуальная машина содержит объединение сетевых адаптеров, то после отработки отказа в Azure оно преобразуется в единый сетевой адаптер.<br/><br/>Защита виртуальных машин под управлением Linux со статическими IP-адресами не поддерживается. |

## <a name="prepare-for-deployment"></a>Подготовка к развертыванию
Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Настроить сеть](#set-up-an-azure-network) , в которой будут размещаться виртуальные машины Azure, созданные в результате отработки отказа.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить узлы Hyper-V](#prepare-the-hyper-v-hosts) , чтобы они могли обращаться к необходимым URL-адресам.

### <a name="set-up-an-azure-network"></a>Настроить сеть

Настройка сети Azure. К этой сети должны будут подключиться виртуальные машины Azure, созданные после отработки отказа.

* Сеть должна располагаться в том же регионе, в котором будет развернуто хранилище служб восстановления.
* В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для сети Azure необходимо настроить [режим Resource Manager](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
* Рекомендуется настроить сеть перед началом работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery.

> [!NOTE]
> [Миграция сетей](../azure-resource-manager/resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.
>
>

### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure

- Для хранения данных, реплицированных в Azure, понадобится учетная запись хранения Azure класса "Стандартный".
- В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для учетной записи необходимо настроить [режим Resource Manager](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
- Рекомендуется настроить учетную запись хранения до начала работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.
- Учетные записи хранения, используемые для Site Recovery, нельзя перемещать между группами в одной подписке или между разными подписками.


### <a name="prepare-the-hyper-v-hosts"></a>Подготовить узлы Hyper-V
* Убедитесь, что узлы VMM соответствуют [предварительным требованиям](#on-premises-prerequisites).

### <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Служба архивации и Site Recovery (OMS)**. Кроме того, можно щелкнуть **Обзор** > **Хранилища служб восстановления** > **Добавить**.

    ![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault3.png)
3. В поле **Имя** укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите уже имеющуюся и укажите регион Azure. В него будут реплицированы данные компьютеров. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
5. Если нужно быстро получить доступ к хранилищу с панели мониторинга, установите флажок **Закрепить на панели мониторинга** и щелкните **Создать хранилище**.

    ![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.

## <a name="get-started"></a>Приступая к работе
В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание как можно быстрее. Перед развертыванием проверяется соответствие предварительным требованиям. Кроме того, вы получаете указания для выполнения этапов развертывания в правильной последовательности.

Приступая к работе, необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Затем нужно настроить локальные серверы, учетные записи хранения Azure и сети. Кроме того, требуется создать политики репликации и выполнить планирование ресурсов. После настройки инфраструктуры включается репликация виртуальных машин. Можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.

## <a name="step-1-choose-your-protection-goals"></a>Шаг 1. Выбор целевых объектов для защиты
Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище и щелкните **Параметры**.
2. Выбрав **Параметры** > **Приступая к работе**, щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals.png)
3. На странице **Цель защиты** выберите **В Azure** и затем выберите **Да, с помощью Hyper-V**. Выберите **Нет** , чтобы подтвердить, что VMM не используется. Нажмите кнопку **ОК**.

    ![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals2.png)

## <a name="step-2-set-up-the-source-environment"></a>Шаг 2. Настройка исходной среды
Настройте узел Hyper-V, установите поставщика Azure Site Recovery и агента служб восстановления Azure на узлах Hyper-V и зарегистрируйте узлы в хранилище.

1. Щелкните **Шаг 2. Подготовка инфраструктуры** > **Источник**. Чтобы добавить новый узел Hyper-V в качестве контейнера для узлов или кластеров Hyper-V, щелкните **+Hyper-V Site**(+ Сайт Hyper-V).

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source1.png)
2. В колонке **Создание сайта Hyper-V** укажите имя для сайта. Нажмите кнопку **ОК**. Выберите только что созданный сайт.

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source2.png)
3. Щелкните **+Hyper-V Server** (+ Hyper-V Server), чтобы добавить сервер на сайт.
4. Убедитесь, что **сервер Hyper-V** отображается в разделе **Добавить сервер** > **Тип сервера**. Убедитесь, что сервер Hyper-V Server, который вы хотите добавить, соответствует [предварительным требованиям](#on-premises-prerequisites) и имеет доступ к указанным URL-адресам.
5. Скачайте файл установки поставщика Azure Site Recovery. Запустите этот файл, чтобы установить поставщик и агент служб восстановления на каждый узел Hyper-V.
6. Скачайте ключ регистрации. Он потребуется при запуске программы установки. Ключ действителен в течение 5 дней после создания.

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source3.png)
7. Запустите файл установки поставщика на каждом узле, добавленном в узел Hyper-V. Если установка выполняется в кластер Hyper-V, программу установки необходимо запустить на каждом узле кластера. Установка и регистрация всех узлов кластера Hyper-V гарантирует, что виртуальные машины останутся защищенными даже в случае переноса между узлами.

### <a name="install-the-provider-and-agent"></a>Установка поставщика и агента
1. Запустите файл установки поставщика.
2. На странице **Центр обновления Майкрософт** можно включить обновления, чтобы обновления поставщика устанавливались в соответствии с политикой Центра обновления Майкрософт.
3. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.
4. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа хранилища. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.

    ![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/provider3.png)

5. На странице **Параметры прокси-сервера** укажите параметры для подключения поставщика, который будет установлен на сервере, к Azure Site Recovery через Интернет.

    * Чтобы поставщик подключался напрямую, выберите **Connect directly without a proxy**(Прямое подключение без прокси-сервера).
    * Чтобы подключаться с помощью прокси-сервера, который уже настроен на сервере, выберите **Connect with existing proxy settings**(Подключение с параметрами существующего прокси-сервера).
    * Если для имеющегося прокси-сервера требуется аутентификация или для подключения поставщика нужно использовать пользовательский прокси-сервер, выберите **Connect with custom proxy settings**(Подключение с параметрами пользовательского прокси-сервера).
    * При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
    * Если используется прокси-сервер, убедитесь, что он не блокирует URL-адреса, описанные в [предварительных требованиях](#on-premises-prerequisites).

    ![Интернет](./media/site-recovery-hyper-v-site-to-azure/provider7.PNG)

6. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

    ![Расположение установки](./media/site-recovery-hyper-v-site-to-azure/provider2.png)

7. После завершения регистрации Azure Site Recovery извлекает метаданные с сервера Hyper-V, а сам сервер отображается в колонке **Параметры** > **Инфраструктура Site Recovery** > **Узлы Hyper-V**.

### <a name="command-line-installation"></a>Установка из командной строки
Поставщик и агент Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\ASR.
2. В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:

            C:\Windows\System32> CD C:\ASR
            C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
3. Выполните следующую команду для установки компонентов:

            C:\ASR> setupdr.exe /i
4. Затем выполните следующие команды для регистрации сервера в хранилище:

            CD C:\Program Files\Microsoft Azure Site Recovery Provider\
            C:\Program Files\Microsoft Azure Site Recovery Provider\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file>

<br/>
Описание

* **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.  
* **/FriendlyName**— обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
* **/proxyAddress**— необязательный параметр, определяющий адрес прокси-сервера.
* **/proxyport** : необязательный параметр, указывающий порт прокси-сервера.
* **/proxyUsername**— необязательный параметр, определяющий имя пользователя прокси-сервера (если прокси-сервер требует аутентификацию).
* **/proxypassword**— необязательный параметр, который указывает пароль для аутентификации на прокси-сервере (если прокси-сервер требует аутентификацию).

## <a name="step-3-set-up-the-target-environment"></a>Шаг 3. Настройка целевой среды

Укажите учетную запись хранения Azure для репликации и сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1. Щелкните **Подготовка инфраструктуры** > **Цель**, выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.

3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

      ![Хранилище](./media/site-recovery-vmware-to-azure/enable-rep3.png))


4. Если учетная запись хранения еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Storage account** (+ Учетная запись хранения). В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

      ![Хранилище](./media/site-recovery-hyper-v-site-to-azure/gs-createstorage.png)


Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md).


Если сеть Azure еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Network** (+ Сеть), чтобы сделать это в процессе настройки. В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.

   ![Сеть](./media/site-recovery-hyper-v-site-to-azure/gs-createnetwork.png)

Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).

## <a name="step-4-set-up-replication-settings"></a>Этап 4. Настройка параметров репликации
1. Чтобы создать политику репликации, последовательно выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создать и настроить привязку**.

    ![Сеть](./media/site-recovery-hyper-v-site-to-azure/gs-replication.png)
2. На странице **Создать и связать политику** укажите имя политики.
3. В раскрывающемся списке **Частота копирования** выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
4. В поле **Хранение точки восстановления**укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями (от&1; до&12; часов). Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.
6. В поле **Время запуска начальной репликации** укажите, когда должна запускаться начальная репликация. При репликации используется полоса пропускания Интернета. Поэтому проведение репликации нужно запланировать на свободное от работы время. Нажмите кнопку **ОК**.

    ![Политика репликации](./media/site-recovery-hyper-v-site-to-azure/gs-replication2.png)

При создании политики она автоматически сопоставляется с сайтом Hyper-V. Нажмите кнопку **ОК**. Узел Hyper-V (и входящие в него виртуальные машины) можно связать с несколькими политиками репликации, последовательно выбрав **Параметры** > **Репликация** > имя политики > **Привязать узел Hyper-V**.

## <a name="step-5-capacity-planning"></a>Шаг 5. Планирование ресурсов
Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

Планировщик ресурсов Site Recovery позволяет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища с помощью планировщика ресурсов. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

* Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
* Определите частоту ежедневных изменений (обновлений) реплицированных данных. Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057) .

1. Щелкните ссылку **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).
2. После этого выберите **Да** in **Have you run the Capacity Planner(Вы запустили планировщик ресурсов?).**(Вы запустили планировщик ресурсов?).

   ![Планирование загрузки](./media/site-recovery-hyper-v-site-to-azure/gs-capacity-planning.png)

### <a name="network-bandwidth-considerations"></a>Рекомендации по пропускной способности сети
С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Существует несколько вариантов управления объемом пропускной способности, используемой для репликации:

* **Регулирование пропускной способности.** Трафик Hyper-V, который реплицируется в Azure, проходит через определенный узел Hyper-V. Пропускную способность можно регулировать на сервере этого узла.
* **Настройка пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.

#### <a name="throttle-bandwidth"></a>Регулирование пропускной способности
1. Откройте на сервере узла Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы архивации Microsoft Azure доступен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

    ![Регулирование пропускной способности](./media/site-recovery-hyper-v-site-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

#### <a name="influence-network-bandwidth"></a>Изменение пропускной способности сети
1. В реестре перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM**или создайте его, если он еще не существует.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## <a name="step-6-enable-replication"></a>Шаг 6. Включение репликации
Включите репликацию следующим образом:

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных компьютеров.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication.png)
2. В колонке **Источник** выберите сайт Hyper-V. Нажмите кнопку **ОК**.
3. В поле **Целевой объект** выберите подписку хранилища и модель отработки отказа (классическую или с управлением ресурсами), которую следует использовать в Azure после отработки отказа.
4. Выберите учетную запись хранения, которую нужно использовать. Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account). Чтобы создать учетную запись хранения с использованием модели Resource Manager, щелкните **Создать**. Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md). Нажмите кнопку **ОК**.
5. Выберите сеть и подсеть Azure, к которой будут подключаться развернутые виртуальные машины Azure после отработки отказа. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым компьютерам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если требуется использовать другую сеть, [создайте ее](#set-up-an-azure-network). Чтобы создать сеть, используя модель Resource Manager, щелкните **Создать**. Если нужно создать сеть с помощью классической модели, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.
   ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication11.png)

6. В поле **Виртуальные машины** > **Выбор виртуальных машин** , выберите каждый компьютер, который нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication5-for-exclude-disk.png)
7. В поле **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы. По умолчанию для репликации выбраны все диски виртуальной машины. Чтобы уменьшить использование пропускной способности и избежать репликации ненужных данных в Azure, может потребоваться исключить диски из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb Microsoft SQL Server). Чтобы исключить диск из репликации, достаточно отменить его выбор. Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальной машине Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) , и измените его, если нужно. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства.

     ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication6-with-exclude-disk.png)

     > [!NOTE]
     >
     > * Из репликации можно исключать только базовые диски. Нельзя исключить диск операционной системы. Также не рекомендуется исключать динамические диски. Site Recovery не может определить тип виртуального жесткого диска (базовый или динамический) в гостевой виртуальной машине.  Если все зависимые динамические диски не исключены, то при отработке отказа виртуальной машины защищенный динамический диск будет считаться неисправным и данные на нем будут недоступны.
    > * После включения репликации добавить или удалить диски для репликации нельзя. Если вы хотите добавить или исключить диск, отключите защиту виртуальной машины, а затем включите ее повторно.
    > * Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную. Кроме того, можно интегрировать службу автоматизации Azure
    > * в план восстановления, чтобы создать диск во время отработки отказа виртуальной машины.
    > * Диски, создаваемые в Azure вручную, не будут восстановлены в исходном расположении. Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, восстановление размещения из Azure в Hyper-V будет выполнено только для трех дисков, задействованных при отработке отказа. Восстановление размещения после сбоя и обратная репликация из Hyper-V в Azure недоступны для дисков, созданных вручную.
    >
    >       

8. Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам. Нажмите кнопку **ОК**. Политику репликации можно изменить, последовательно выбрав **Параметры** > **Политики репликации** > имя политики > **Изменить параметры**. Изменения будут применяться к компьютерам, для которых уже выполняется репликация, и к новым компьютерам.

   ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication7.png)

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими
Рекомендуется проверить свойства исходного компьютера.

1. Щелкните **Параметры** > **Защищенные элементы** > **Реплицированные элементы** и выберите компьютер.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover1.png)
2. На странице **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover2.png)
3. Выбрав **Вычисления и сеть** > **Свойства вычислений**, можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure. Кроме того, можно просмотреть и изменить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure. Обратите внимание на следующее.

   * Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
   * Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

     * Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     * Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
     * Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
     * Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.
     * Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером *по умолчанию* для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.

     ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover4.png)

4. На странице **Диски** отображаются сведения о дисках ОС и дисках данных на виртуальной машине, для которой будет выполняться репликация.



### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа
Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, обязательно сделайте следующее:

**На локальном компьютере до отработки отказа**.

* Чтобы получить доступ через Интернет, включите протокол RDP. Убедитесь, что правила TCP и UDP добавлены в разделе **Общее** и что RDP разрешен в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для всех профилей.
* Чтобы получить доступ через подключение типа "сеть-сеть", включите протокол RDP на компьютере. Убедитесь, что протокол RDP разрешен в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для сетей **домена** и **частных** сетей.
* Установите [агент виртуальной машины Azure](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) на локальном компьютере.
* Задайте для политики сети SAN операционной системы значение OnlineAll. [Дополнительные сведения](https://support.microsoft.com/kb/3031135)
* Отключите службу IPSec перед выполнением отработки отказа.

**На виртуальной машине Azure после отработки отказа**.

* Добавьте общедоступный IP-адрес для сетевой карты, связанной с виртуальной машиной Azure, чтобы разрешить использование RDP.
* Убедитесь в отсутствии политик домена, которые не допускают подключение к виртуальной машине с использованием общедоступного адреса.
* Попытайтесь подключиться. Если вам не удалось это сделать, убедитесь, что виртуальная машина запущена. Дополнительные советы по устранению неполадок см. в этой [статье](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Если после отработки отказа нужно получить доступ к виртуальной машине Azure под управлением Linux с помощью клиента SSH, выполните следующее:

**На локальном компьютере до отработки отказа**.

* Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).
* Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.

**На виртуальной машине Azure после отработки отказа**.

* Правила группы сетевой безопасности на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения на порт SSH.
* Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию), необходимо создать общедоступную конечную точку.
* Если доступ к виртуальной машине осуществляется через VPN-подключение (Express Route или VPN типа "сеть — сеть"), можно использовать клиент для прямого подключения к виртуальной машине по протоколу SSH.

## <a name="step-7-run-a-test-failover"></a>Шаг 7. Запуск тестовой отработки отказа
Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.

1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину, а затем — значок **Добавить тестовую отработку отказа**.
2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).
3. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
4. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое открывается щелчком по виртуальной машине, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Параметры** > **Задания** > **Задания Site Recovery**.
5. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
6. Если вы заранее [подготовились к подключению после отработки отказа](#prepare-to-connect-to-azure-vms-after-failover), то сможете подключиться к виртуальной машине Azure.
7. Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.

Ознакомьтесь с дополнительными сведениями о [тестовой отработке отказа в Azure](site-recovery-test-failover-to-azure.md).


## <a name="failover"></a>Отработка отказа
По завершении начальной репликации для компьютеров по мере необходимости можно вызывать отработку отказа. Site Recovery поддерживает различные типы отработки отказа: тестовую, плановую и внеплановую.
[Узнайте больше](site-recovery-failover.md) о различных типах отработки отказа и ознакомьтесь с дополнительными сведениями о том, когда и как выполнять каждую из них.

> [!NOTE]
> Если вашей целью является миграция виртуальных машин в Azure, мы настоятельно рекомендуем использовать для этого [операцию плановой отработки отказа](site-recovery-failover.md). После проверки перенесенного приложения в Azure с помощью тестовой отработки отказа используйте инструкции, описанные в разделе [Завершение миграции виртуальных машин в Azure](#Complete-migration-of-your-virtual-machines-to-Azure), чтобы выполнить миграцию виртуальных машин. Нет необходимости выполнять фиксацию или удаление. При завершении миграции выполняется перенос виртуальной машины, удаляется ее защита и прекращается выставление счетов за использование Azure Site Recovery для этой виртуальной машины.


### <a name="run-a-planned-failover"></a>Запуск запланированной отработки отказа
Выбирается для обеспечение соответствия требованиям, во время планового обслуживания и при отработке отказа с переносом данных для обеспечения непрерывного выполнения рабочих нагрузок во время прогнозируемых неблагоприятных обстоятельств, например при плановых отключениях питания или экстремальных погодных условиях. В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке "Виртуальные машины" можно запустить отработку отказа для отдельной виртуальной машины. Перед началом работы убедитесь, что все виртуальные машины, для которых необходимо выполнить отработку отказа, завершили начальную репликацию.

1. В разделе **Планы восстановления** выберите пункт с именем плана восстановления.
2. В колонке "План восстановления" щелкните **Плановая отработка отказа**.
3. На странице **Подтвердить плановую отработку отказа **выберите исходное и целевое расположения.
4. Когда начнется плановая отработка отказа, прежде всего необходимо завершить работу виртуальных машин, чтобы предотвратить потерю данных. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. Если при отработке отказа возникнет ошибка (либо на виртуальной машине, либо в сценарии, который включен в план восстановления), плановая отработка отказа в рамках плана восстановления будет остановлена. Вы сможете запустить отработку отказа еще раз.
6. После создания реплицированных виртуальных машин они находятся в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать** .
7. По завершении репликации виртуальные машины будут запущены в дополнительном расположении.


### <a name="run-an-unplanned-failover"></a>Запуск внеплановой отработки отказа
Этот тип отработки отказа следует выбрать, когда первичный сайт становится недоступным из-за неожиданного инцидента, например из-за сбоя питания или атаки вируса. В этой процедуре описывается, как запустить внеплановую отработку отказа для плана восстановления. В качестве альтернативы на вкладке "Виртуальные машины" можно запустить отработку отказа для отдельной виртуальной машины. Перед началом работы убедитесь, что все виртуальные машины, для которых необходимо выполнить отработку отказа, завершили начальную репликацию.

1. В разделе **Планы восстановления** выберите пункт с именем плана восстановления.
2. В колонке плана восстановления щелкните **Внеплановая отработка отказа**.
3. На странице **Внеплановая отработка отказа** выберите исходное и целевое расположения.
4. Установите флажок **Завершать работу виртуальных машин и синхронизировать последние данные**. Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных.
5. После отработки отказа виртуальные машины будут находиться в состоянии ожидании фиксации.  Для фиксации отработки отказа выберите команду **Зафиксировать** .

[Подробнее](site-recovery-failover.md)

## <a name="complete-migration-of-your-virtual-machines-to-azure"></a>Завершение миграции виртуальных машин в Azure
> [!NOTE]
> Следующие инструкции применяются только в том случае, если вы переносите виртуальные машины в Azure.
>
>

1. Выполните плановую отработку отказа, как описано [здесь](site-recovery-failover.md).
2. Выберите **Параметры > Реплицированные элементы**, щелкните правой кнопкой мыши виртуальную машину и выберите **Завершение миграции**.

    ![Завершение миграции](./media/site-recovery-hyper-v-site-to-azure/migrate.png)
3. Нажмите кнопку **ОК** , чтобы завершить миграцию. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании завершения миграции, выбрав **Параметры > Site Recovery jobs (Задания Site Recovery)**.

## <a name="monitor-your-deployment"></a>Мониторинг развертывания
Вот как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery:

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты** . На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях.  Эту панель можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.

    ![Основные компоненты](./media/site-recovery-hyper-v-site-to-azure/essentials.png)
2. В элементе **Работоспособность** можно следить за серверами сайта, в которых возникают ошибки, а также за событиями, которые произошли в Site Recovery за последние 24 часа.
3. Мониторинг репликации и управление ею можно осуществлять в элементах **Реплицированные элементы**, **Планы восстановления** и **Задания Site Recovery**. Для получения подробных сведений о заданиях выберите **Параметры** -> **Задания** -> **Задания Site Recovery**.

