---
title: "Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery | Документация Майкрософт"
description: "В этой статье рассматривается репликация SQL Server с помощью возможностей аварийного восстановления SQL Server и Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 9126f5e8-e9ed-4c31-b6b4-bf969c12c184
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/19/2016
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: c5e80c3cd3caac07e250d296c61fb3813e0000dd
ms.openlocfilehash: 40c4f88bc91773158d416d5e89424b92cf15cf91


---
# <a name="protect-sql-server-with-sql-server-disaster-recovery-and-azure-site-recovery"></a>Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery
Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

 В этой статье описывается способ организации защиты серверной части SQL Server приложения с помощью сочетания технологий SQL Server BCDR и Azure Site Recovery. Для развертывания сценариев, описанных в этой статье, требуется хорошее понимание возможностей аварийного восстановления SQL Server (отказоустойчивая кластеризация, группы доступности AlwaysOn, зеркальное отображение базы данных, доставка журналов) и Azure Site Recovery.

## <a name="overview"></a>Обзор
В основе многих рабочих нагрузок используется SQL Server. Для реализации служб данных приложения, такие как SharePoint, Dynamics и SAP, используют SQL Server.  Приложения развертывают SQL Server различными способами.

* **Изолированный сервер SQL Server**. SQL Server и все базы данных размещаются на одном компьютере (физическом или виртуальном). Если сервер виртуальный, то для обеспечения локальной высокой доступности используется кластеризация размещения. Высокая доступность на уровне гостя не обеспечивается.
* **Экземпляры отказоустойчивого кластера SQL Server (AlwaysOn FCI)**. В этом случае два или несколько узлов экземпляров SQL Server с общими дисками настраиваются в отказоустойчивом кластере Windows. Если один из экземпляров кластеров выйдет из строя, кластер сможет выполнить отработку отказа SQL на другой экземпляр. Обычно этот вариант используется для обеспечения высокой доступности на основном сайте. Он не защищает от сбоев и неполадок на уровне общего хранилища. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или общих VHDX-файлов.
* **Группы доступности SQL AlwaysOn в Azure**. В этом случае два узла настраиваются в кластере без общих ресурсов, в котором базы данных SQL Server настроены в группе доступности с синхронной репликацией и автоматической отработкой отказа.

SQL Server Enterprise предлагает собственные технологии аварийного восстановления баз данных на удаленный сайт. В этой статье мы применим и интегрируем следующие исходные технологии аварийного восстановления SQL.

* Группа доступности SQL AlwaysOn для аварийного восстановления SQL Server Enterprise 2012 или 2014.
* Зеркальное отображение базы данных SQL в режиме высокого уровня безопасности для SQL Server Standard (любой версии) или SQL Server 2008 R2.

В таблице представлены сведения о защите SQL Server службой Site Recovery.

| **Из локальной среды в локальную среду** | **Из локальной среды в Azure** |
| --- | --- | --- |
| **Hyper-V** |Да |
| **VMware** |Да |
| **Физический сервер** |Да |

## <a name="support-and-integration"></a>Поддержка и интеграция
Сценарии, приведенные в статье, поддерживают следующие версии SQL Server:

* SQL Server 2014 Enterprise и Standard;
* SQL Server 2012 Enterprise и Standard;
* SQL Server 2008 R2 Enterprise и Standard.

Site Recovery может интегрироваться с собственными технологиями SQL Server BCDR, перечисленными в приведенной ниже таблице, для создания решения аварийного восстановления.

| **Компонент** | **Дополнительные сведения** | **Версия SQL Server** |
| --- | --- | --- |
| **Группа доступности AlwaysOn** |Несколько отдельных экземпляров SQL Server, каждый из которых запущен в отказоустойчивом кластере с несколькими узлами.<br/><br/>Базы данных можно объединить в группы отработки отказа, которые затем можно скопировать (зеркальное отображение) на экземпляры SQL Server, благодаря чему исключается необходимость в общем хранилище.<br/><br/>Обеспечивает аварийное восстановление между основным сайтом и одним или несколькими дополнительными сайтами. Два узла можно настроить в кластере без общих ресурсов, в котором базы данных SQL Server настроены в группе доступности с синхронной репликацией и автоматической отработкой отказа. |SQL Server Enterprise 2014 и 2012 |
| **Отказоустойчивая кластеризация (AlwaysOn FCI)** |SQL Server применяет отказоустойчивую кластеризацию Windows для обеспечения высокого уровня доступности локальных рабочих нагрузок SQL Server.<br/><br/>Узлы, на которых выполняются экземпляры SQL Server с общими дисками, настроены в отказоустойчивом кластере. Если экземпляр выходит из строя, выполняется переход кластера на другой ресурс.<br/><br/>Кластер не обеспечивает защиту от сбоев или простоев в общем хранилище. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или с помощью в общих VHDX-файлов. |Выпуски SQL Server Enterprise<br/><br/>SQL Server Standard (ограничено только двумя узлами) |
| **Зеркальное отображение базы данных (в режиме высокого уровня безопасности)** |Защищает одну базу данных переносом в одну дополнительную копию. Доступно как в режиме репликации с высоким уровнем безопасности (синхронный режим), так и в режиме репликации с высоким уровнем производительности (асинхронный режим). Не требует наличия отказоустойчивого кластера. |SQL Server 2008 R2<br/><br/>Все выпуски SQL Server Enterprise |
| **Автономный SQL Server** |SQL Server и база данных находятся на одном сервере (физическом или виртуальном). Если сервер виртуальный, то кластеризация размещения используется для обеспечения высокой доступности. Без высокой доступности гостевого уровня. |Выпуск Enterprise или Standard |

## <a name="deployment-recommendations"></a>Рекомендации по развертыванию
В таблице перечислены рекомендации относительно интеграции технологий SQL Server BCDR в Site Recovery.

| **Версия** | **Выпуск** | **Развертывание** | **От локального к локальным** | **От локального к Azure** |
| --- | --- | --- | --- | --- |
| SQL Server 2014 или 2012 |Enterprise |Экземпляр отказоустойчивого кластера |Группы доступности AlwaysOn |Группы доступности AlwaysOn |
| Enterprise |Группы доступности AlwaysOn для обеспечения высокой доступности |Группы доступности AlwaysOn |Группы доступности AlwaysOn | |
| Стандарт |Экземпляр отказоустойчивого кластера (FCI) |Репликация Site Recovery с локальным зеркалом |Репликация Site Recovery с локальным зеркалом | |
| Enterprise или Standard |Автономный |Репликация Site Recovery |Репликация Site Recovery | |
| SQL Server 2008 R2 |Enterprise или Standard |Экземпляр отказоустойчивого кластера (FCI) |Репликация Site Recovery с локальным зеркалом |Репликация Site Recovery с локальным зеркалом |
| Enterprise или Standard |Автономный |Репликация Site Recovery |Репликация Site Recovery | |
| SQL Server (любая версия) |Enterprise или Standard |Экземпляр отказоустойчивого кластера — приложение DTC |Репликация Site Recovery |Не поддерживается |

## <a name="deployment-prerequisites"></a>Предварительные условия для развертывания
Ниже перечислены условия, которые необходимо выполнить перед началом работы.

* Локальное развертывание SQL Server с поддерживаемой версией SQL Server. Обычно также потребуется служба Active Directory для SQL Server.
* Необходимые условия для сценария, который требуется развернуть, представлены в статье, посвященной каждому развертыванию. Ссылки см. в статье [Что такое Site Recovery?](site-recovery-overview.md).
* Если вы хотите настроить восстановление в Azure, на виртуальных машинах SQL Server потребуется запустить средство [оценки готовности виртуальной машины Azure](http://www.microsoft.com/download/details.aspx?id=40898) , чтобы убедиться в их совместимости с Azure и Site Recovery.

## <a name="set-up-active-directory"></a>настроить Active Directory;
Для правильной работы SQL Server на дополнительном сайте восстановления потребуется настроить службу Active Directory. Существует несколько вариантов настройки:

* **для малых предприятий**— если имеется небольшое количество приложений и один контроллер домена для локального сайта и вам требуется выполнить отработку отказа всего сайта, то рекомендуем использовать репликацию Site Recovery для репликации контроллера домена в дополнительный центр обработки данных или в Azure;
* **для средних и крупных предприятий**— если имеется большое количество приложений, вы используете лесу Active Directory и вам требуется выполнить отработку отказа для каждого отдельного приложения или рабочей нагрузки, рекомендуется настроить дополнительный контроллер домена в дополнительном центре обработки данных или в Azure. Обратите внимание, что при использовании групп доступности AlwaysOn для восстановления удаленного сайта рекомендуется настроить другой дополнительный контроллер домена на дополнительном сайте или в Azure, который будет использоваться для восстановленного экземпляра SQL Server.

При выполнении инструкций в этом документе предполагается, что в дополнительном расположении доступен контроллер домена. [Узнайте больше](site-recovery-active-directory.md) о защите Active Directory с помощью Site Recovery.

## <a name="integrate-protection-with-sql-server-always-on-on-premises-to-azure"></a>Интеграция защиты с использованием SQL Server AlwaysOn (из локальной среды в Azure)
Site Recovery изначально поддерживает SQL AlwaysOn. Если вы создали группу доступности SQL и настроили виртуальную машину Azure как дополнительную, то для управления отработкой отказа в группах доступности можете использовать Site Recovery.

> [!NOTE]
> На данный момент эта функция находится на этапе предварительной версии и доступна, только если управление серверами узла Hyper-V в основном центре обработки данных осуществляется в облаках VMM и настройка VMware управляется [Сервером конфигурации](site-recovery-vmware-to-azure.md#configuration-server-or-additional-process-server-prerequisites). Сейчас эта возможность недоступна на новом портале Azure.
>
>

#### <a name="prerequisites"></a>Предварительные требования
Чтобы интегрировать SQL AlwaysOn в Site Recovery, следует выполнить некоторые условия.

* Локальный SQL Server (на автономном сервере или в отказоустойчивом кластере).
* Одна или несколько виртуальных машин Azure с установленным SQL Server
* Настроенные группы доступности SQL между локальным SQL Server и SQL Server, работающим в Azure.
* На локальном сервере SQL Server необходимо включить удаленное взаимодействие PowerShell. Сервер VMM или сервер конфигурации должен иметь возможность удаленного вызова PowerShell на SQL Server.
* На локальный сервер SQL Server в группы пользователей SQL необходимо добавить учетную запись пользователя по крайней мере со следующими разрешениями:
  * ALTER AVAILABILITY GROUP — разрешения приведены [здесь](https://msdn.microsoft.com/library/hh231018.aspx) и [здесь](https://msdn.microsoft.com/library/ff878601.aspx#Anchor_3).
  * ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ — разрешения приведены [здесь](https://msdn.microsoft.com/library/ff877956.aspx#Security).
* Для пользователя, о котором шла речь на предыдущем шаге, с помощью CSPSConfigtool.exe нужно создать учетную запись запуска от имени на сервере VMM или учетную запись на сервере конфигурации.
* Модуль SQL PS необходимо установить на серверы SQL Server, работающие локально и на виртуальных машинах Azure.
* На виртуальные машины, работающие в Azure, необходимо установить агент виртуальной машины.
* Каталогу NTAUTHORITY\System необходимо предоставить следующие разрешения на SQL Server, запущенный на виртуальных машинах в Azure:
  * ALTER AVAILABILITY GROUP — разрешения приведены [здесь](https://msdn.microsoft.com/library/hh231018.aspx) и [здесь](https://msdn.microsoft.com/library/ff878601.aspx#Anchor_3).
  * ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ — разрешения приведены  [здесь](https://msdn.microsoft.com/library/ff877956.aspx#Security).

#### <a name="step-1-add-a-sql-server"></a>Шаг 1. Добавление SQL Server
1. Щелкните **Добавить SQL** , чтобы добавить новый SQL Server.

    ![Добавить SQL](./media/site-recovery-sql/add-sql.png)
2. Выберите **Configure SQL Settings (Настройка параметров SQL)** > **Имя** и укажите понятное имя для SQL Server.
3. **SQL Server (FQDN)** укажите полное доменное имя исходного SQL Server, который нужно добавить. Если SQL Server установлен в отказоустойчивом кластере, укажите полное доменное имя кластера, а не какого-либо его узла.  
4. В поле **Экземпляр SQL Server** выберите экземпляр по умолчанию или укажите имя пользовательского экземпляра.
5. В поле **Сервер управления** выберите сервер VMM или сервер конфигурации, который зарегистрирован в хранилище Site Recovery. Site Recovery будет использовать этот сервер управления для взаимодействия с SQL Server.
6. В поле **Учетная запись запуска от имени** введите имя учетной записи запуска от имени, которая создана на указанном сервере VMM, или имя учетной записи, созданной на сервере конфигурации. Эта учетная запись будет использоваться для доступа к SQL Server и должна иметь разрешения на чтение и отработку отказа в группах доступности на компьютерах с SQL Server.

    ![Диалоговое окно "Добавление SQL"](./media/site-recovery-sql/add-sql-dialog.png)

После добавления SQL Server отобразится на вкладке **Серверы SQL Server** .

![Список серверов SQL Server](./media/site-recovery-sql/sql-server-list.png)

#### <a name="step-2-add-a-sql-availability-group"></a>Шаг 2. Добавление группы доступности SQL
1. Следующий шаг после добавления компьютера с SQL Server — добавление групп доступности в Site Recovery. Для этого разверните SQL Server, добавленный на предыдущем этапе, и выберите пункт "Добавить группу доступности SQL".

    ![Добавить SQL AG](./media/site-recovery-sql/add-sqlag.png)
2. Группу доступности SQL можно реплицировать на одну или несколько виртуальных машин в Azure. При добавлении группы доступности SQL необходимо указать имя и подписку виртуальной машины Azure, в которую Site Recovery будет выполнять отработку отказа этой группы доступности.

    ![Диалоговое окно "Добавление SQL AG"](./media/site-recovery-sql/add-sqlag-dialog.png)
3. В приведенном выше примере DB1-AG станет основной группой доступности на виртуальной машине SQLAGVM2, которая запускается при отработке отказа в подписке DevTesting2.

> [!NOTE]
> В Site Recovery можно добавлять только основные группы доступности на SQL Server, добавленном на предыдущем этапе. Если вы сделали группу доступности основной на SQL Server или после ее добавления добавили на SQL Server другие группы доступности, обновите сервер с помощью параметра "Обновить" в SQL Server.
>
>

#### <a name="step-3-create-a-recovery-plan"></a>Шаг 3. Создание плана восстановления
Следующим шагом является создание плана восстановления с использованием виртуальных машин и групп доступности.
Выберите тот же сервер VMM или сервер конфигурации, который использовали в качестве источника на шаге 1, а в качестве целевого объекта укажите Microsoft Azure.

![Создание плана восстановления](./media/site-recovery-sql/create-rp1.png)

![Создание плана восстановления](./media/site-recovery-sql/create-rp2.png)

В примере приложение Sharepoint состоит из трех виртуальных машин, серверной частью для которых служит группа доступности SQL. В данном плане восстановления мы можем выбрать как группу доступности, так и виртуальную машину, входящую в приложение.

План восстановления можно дополнительно настроить, переместив виртуальные машины в другие группы отработки отказа и изменив таким образом порядок отработки отказа. Группа доступности всегда подвергается отработке отказа в первую очередь, так как в любом приложении служит серверной частью.

![Настройка плана восстановления](./media/site-recovery-sql/customize-rp.png)

#### <a name="step-4--fail-over"></a>Шаг 4. Отработка отказа
После добавления группы доступности в план восстановления появляется доступ к различным параметрам обработки отказа.

| Отработка отказа | Дополнительные сведения |
| --- | --- |
| **Плановая отработка отказа** |Плановая отработка отказа не предполагает потери данных. Для этого сначала группа доступности SQL переводится в синхронный режим доступности, а затем активируется отработка отказа, так что эта группа доступности становится основной на виртуальной машине, указанной при добавлении этой группы доступности в Site Recovery. После завершения отработки отказа устанавливается режим доступности, который использовался перед активацией плановой отработки отказа. |
| **Незапланированная отработка отказа** |Внеплановая отработка отказа может привести к потере данных. При активации внеплановой отработки отказа группа доступности не меняет режим, но становится основной на виртуальной машине, указанной при добавлении этой группы доступности в Site Recovery. После завершения внеплановой отработки отказа и восстановления доступа к локальному серверу с SQL Server необходимо выполнить в группе доступности обратную репликацию. Обратите внимание, что это действие недоступно в плане восстановления и может быть выполнено только в группе доступности SQL на вкладке "Серверы SQL Server". |
| **Тестовая отработка отказа** |Тестирование отработки отказа для группы доступности SQL не поддерживается. При активации отработки отказа плана восстановления, содержащего группу доступности, отработка отказа этой группы доступности будет пропущена. |

Рассмотрим параметры отработки отказов.

| Параметр | Дополнительные сведения |
| --- | --- |
| **Вариант 1** |1. Выполните тестовую отработку отказа на уровне приложений и интерфейсном уровне.<br/><br/>2) Обновите уровень приложений для доступа к копии реплики в режиме только для чтения и выполните проверку приложения в режиме только для чтения. |
| **Вариант 2** |1. Создайте копию экземпляра виртуальной машины с репликой SQL Server (с помощью клона VMM типа "сеть-сеть" или функции резервного копирования Azure) и добавьте ее в тестовую сеть.<br/><br/> 2) Выполните тестовую отработку отказа с помощью плана восстановления. |

#### <a name="step-5-fail-back"></a>Шаг 5. Восстановление размещения

Если вы хотите снова сделать группу доступности основной на локальном SQL Server, активируйте плановую отработку отказа для плана восстановления и выберите направление с Microsoft Azure на локальный сервер VMM.

> [!NOTE]
> Для восстановления репликации после внеплановой отработки отказа необходимо активировать в группе доступности обратную репликацию. До выполнения этого действия репликация будет приостановлена.
>
>

### <a name="protect-machines-without-a-vmm-server-or-a-configuration-server"></a>Защита компьютеров без сервера VMM или сервера конфигурации
В средах, которые не управляются сервером VMM или сервером конфигурации, можно использовать модули Runbook службы автоматизации Azure для настройки сценариев отработки отказа в группах доступности SQL. Порядок соответствующей настройки описан ниже.

1. Создайте локальный файл сценария для отработки отказа группы доступности. В этом примере сценария указывается путь к группе доступности в реплике Azure и выполняется отработка отказа в этот экземпляр реплики. Этот сценарий будет выполняться на реплике виртуальной машины SQL Server путем его передачи с помощью расширения пользовательского сценария.

        Param(
        [string]$SQLAvailabilityGroupPath
        )
        import-module sqlps
        Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force

1. Передайте этот сценарий в большой двоичный объект в учетной записи хранения Azure. Используйте пример ниже:

        $context = New-AzureStorageContext -StorageAccountName "Account" -StorageAccountKey "Key"
        Set-AzureStorageBlobContent -Blob "AGFailover.ps1" -Container "script-container" -File "ScriptLocalFilePath" -context $context

1. Создайте модуль Runbook службы автоматизации Azure для запуска сценариев на реплике виртуальной машины SQL Server в Azure. Для этого используйте указанный ниже образец сценария. [Узнайте подробнее](site-recovery-runbook-automation.md) об использовании модулей Runbook службы автоматизации в планах восстановления.

1. При создании плана восстановления для приложения добавьте в сценарий шаг "pre-Group 1 boot", который запускает модуль Runbook службы автоматизации для отработки отказа группы доступности.


1. **Тестирование отработки отказа**: в SQL AlwaysOn нет встроенной поддержки тестирования отработки отказа. Поэтому рекомендуется делать это следующим образом.
    1. Установите [службу архивации Azure](../backup/backup-azure-vms.md) на виртуальной машине, на которой размещена реплика группы доступности в Azure. 
    1. Прежде чем активировать тестовую отработку отказа для плана восстановления, восстановите виртуальную машину из резервной копии, полученной на шаге 1.
    1. Выполните тестовую отработку отказа для плана восстановления.


> [!NOTE]
> Для приведенного ниже сценария предполагается, что группа доступности SQL размещена на классической виртуальной машине Azure, а на шаге 2 используется виртуальная машина SQLAzureVM-Test. Измените этот сценарий, указав имя восстановленной виртуальной машины.
> 
> 


     workflow SQLAvailabilityGroupFailover
     {

         param (
             [Object]$RecoveryPlanContext
         )

         $Cred = Get-AutomationPSCredential -name 'AzureCredential'

         #Connect to Azure
         $AzureAccount = Add-AzureAccount -Credential $Cred
         $AzureSubscriptionName = Get-AutomationVariable –Name ‘AzureSubscriptionName’
         Select-AzureSubscription -SubscriptionName $AzureSubscriptionName

         InLineScript
         {
          #Update the script with name of your storage account, key and blob name
          $context = New-AzureStorageContext -StorageAccountName "Account" -StorageAccountKey "Key";
          $sasuri = New-AzureStorageBlobSASToken -Container "script-container"- Blob "AGFailover.ps1" -Permission r -FullUri -Context $context;

          Write-output "failovertype " + $Using:RecoveryPlanContext.FailoverType;

          if ($Using:RecoveryPlanContext.FailoverType -eq "Test")
                {
                    Write-output "tfo"
                    
                    Write-Output "Creating ILB"
                    Add-AzureInternalLoadBalancer -InternalLoadBalancerName SQLAGILB -SubnetName Subnet-1 -ServiceName SQLAzureVM-Test -StaticVNetIPAddress #IP
                    Write-Output "ILB Created"

                    #Update the script with name of the virtual machine recovered using Azure Backup
                    Write-Output "Adding SQL AG Endpoint"
                    Get-AzureVM -ServiceName "SQLAzureVM-Test" -Name "SQLAzureVM-Test"| Add-AzureEndpoint -Name sqlag -LBSetName sqlagset -Protocol tcp -LocalPort 1433 -PublicPort 1433 -ProbePort 59999 -ProbeProtocol tcp -ProbeIntervalInSeconds 10 -InternalLoadBalancerName SQLAGILB | Update-AzureVM

                    Write-Output "Added Endpoint"
        
                    $VM = Get-AzureVM -Name "SQLAzureVM-Test" -ServiceName "SQLAzureVM-Test" 
                       
                    Write-Output "UnInstalling custom script extension"
                    Set-AzureVMCustomScriptExtension -Uninstall -ReferenceName CustomScriptExtension -VM $VM |Update-AzureVM 
                    Write-Output "Installing custom script extension"
                    Set-AzureVMExtension -ExtensionName CustomScriptExtension -VM $vm -Publisher Microsoft.Compute -Version 1.*| Update-AzureVM   
                    
                    Write-output "Starting AG Failover"
                    Set-AzureVMCustomScriptExtension -VM $VM -FileUri $sasuri -Run "AGFailover.ps1" -Argument "-Path sqlserver:\sql\sqlazureVM\default\availabilitygroups\testag"  | Update-AzureVM
                    Write-output "Completed AG Failover"
                }
          else
                {
                Write-output "pfo/ufo";
                #Get the SQL Azure Replica VM.
                #Update the script to use the name of your VM and Cloud Service
                $VM = Get-AzureVM -Name "SQLAzureVM" -ServiceName "SQLAzureReplica";     

                Write-Output "Installing custom script extension"
                #Install the Custom Script Extension on teh SQL Replica VM
                Set-AzureVMExtension -ExtensionName CustomScriptExtension -VM $VM -Publisher Microsoft.Compute -Version 1.*| Update-AzureVM;

                Write-output "Starting AG Failover";
                #Execute the SQL Failover script
                #Pass the SQL AG path as the argument.

                $AGArgs="-SQLAvailabilityGroupPath sqlserver:\sql\sqlazureVM\default\availabilitygroups\testag";

                Set-AzureVMCustomScriptExtension -VM $VM -FileUri $sasuri -Run "AGFailover.ps1" -Argument $AGArgs | Update-AzureVM;

                Write-output "Completed AG Failover";

                }

         }
     }

## <a name="integrate-protection-with-sql-alwayson-on-premises-to-on-premises"></a>Интеграция защиты с использованием SQL AlwaysOn (из локальной среды в локальную)
Если SQL Server использует группы доступности для обеспечения высокой доступности или экземпляр отказоустойчивого кластера, то на сайте восстановления так же рекомендуется использовать группы доступности. Обратите внимание, что данное руководство предназначено для приложений, не использующих распределенные транзакции.

1. [Настройте базы данных](https://msdn.microsoft.com/library/hh213078.aspx) для их добавления в группы доступности.
2. Создайте на дополнительном сайте новую виртуальную сеть.
3. Настройте VPN типа "сеть-сеть" между новой виртуальной сетью и основным сайтом.
4. Создайте виртуальную машину на сайте восстановления и установите на нее SQL Server.
5. Расширьте существующие группы доступности AlwaysOn для новой виртуальной машины SQL Server. Настройте этот экземпляр SQL Server в качестве копии асинхронной реплики.
6. Создайте прослушиватель группы доступности или обновите существующий прослушиватель, включив в него виртуальную машину асинхронной реплики.
7. Убедитесь в том, что ферма приложений настроена с помощью прослушивателя. Если настройка выполнена с использованием имени сервера базы данных, обновите его, чтобы использовать прослушиватель, чтобы вам не пришлось перенастраивать ее после отработки отказа.

Для приложений, использующих распределенные транзакции, рекомендуется использовать [репликацию Site Recovery с SAN](site-recovery-vmm-san.md) либо [репликацию VMware или физического сервера типа "сеть — сеть"](site-recovery-vmware-to-vmware.md).

### <a name="recovery-plan-considerations"></a>Рекомендации по плану восстановления
1. Добавьте этот образец сценария в библиотеку VMM на основном и дополнительном сайтах.

        Param(
        [string]$SQLAvailabilityGroupPath
        )
        import-module sqlps
        Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force
2. При создании плана восстановления для приложения добавьте шаг "pre-Group 1 boot" из сценария, который запускает сценарий для отработки отказа групп доступности.

## <a name="protect-a-standalone-sql-server"></a>Защита автономного сервера SQL Server
В этой конфигурации для защиты компьютера SQL Server рекомендуется использовать репликацию Site Recovery. Конкретные шаги зависят от того, настроен ли SQL Server в качестве виртуальной машины и физического сервера, а также от необходимости реплицировать в Azure или в дополнительный локальный сайт. Инструкции для всех сценариев развертывания приведены в статье [Обзор Site Recovery](site-recovery-overview.md).

## <a name="protect-a-sql-server-cluster-standard-or-2008-r2"></a>Защита кластера SQL Server (Standard или 2008 R2)
Для кластера под управлением выпуска SQL Server Standard или SQL Server 2008 R2 рекомендуется использовать репликацию Site Recovery для защиты SQL Server.

### <a name="on-premises-to-on-premises"></a>Из локальной среды в локальную среду
* Если приложение использует распределенные транзакции, рекомендуется использовать [репликацию Site Recovery с SAN](site-recovery-vmm-san.md) для среды Hyper-V и [репликацию VMware или физического сервера в VMware](site-recovery-vmware-to-vmware.md) для среды VMware.
* Для приложений без DTC описанный выше метод позволяет восстановить кластер как автономный сервер, используя локальное зеркало баз данных с высоким уровнем безопасности.

### <a name="on-premises-to-azure"></a>Из локальной среды в Azure
Site Recovery не поддерживает гостевой кластер при репликации в Azure. SQL Server также не предоставляет экономичное решение для аварийного восстановления для выпуска Standard. Рекомендуется защитить локальный кластер SQL Server в автономный сервер SQL Server и восстановить его в Azure.

1. Настройте дополнительный автономный экземпляр SQL Server в локальном сайте.
2. Настройте этот экземпляр в качестве зеркальной копии баз данных, которые требуется защитить. Настройте зеркальное отображение в режиме высокого уровня безопасности.
3. Настройте Site Recovery на локальном сайте в соответствии со средой ([Hyper-V](site-recovery-hyper-v-site-to-azure.md), [VMware или физический сервер](site-recovery-vmware-to-azure-classic.md)).
4. Воспользуйтесь репликацией Site Recovery для репликации нового экземпляра SQL Server в Azure. Это зеркальная копия с высоким уровнем безопасности, поэтому она будет синхронизирована с основным кластером, однако в Azure она будет реплицирована с помощью репликации Site Recovery.

На рисунке ниже иллюстрируется процесс настройки.

![Стандартный кластер](./media/site-recovery-sql/BCDRStandaloneClusterLocal.png)

### <a name="failback-considerations"></a>Рекомендации относительно восстановления размещения
В случае стандартных кластеров SQL для восстановления после внеплановой отработки отказа необходимо выполнить резервное копирование сервера SQL, восстановить его из экземпляра зеркала в исходный кластер, а затем переустановить зеркало.

## <a name="next-steps"></a>Дальнейшие действия
[Узнайте больше](site-recovery-best-practices.md) о подготовке к развертыванию Site Recovery.



<!--HONumber=Dec16_HO3-->


