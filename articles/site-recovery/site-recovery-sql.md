<properties 
	pageTitle="Аварийное восстановление с помощью SQL Server и Azure Site Recovery" 
	description="Azure Site Recovery координирует репликацию, отработку отказа и восстановление SQL Server на дополнительный локальный сайт или в Azure." 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor="tysonn"/>

<tags 
	ms.service="site-recovery" 
	ms.workload="backup-recovery" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="11/09/2015" 
	ms.author="raynew"/>


# Аварийное восстановление с помощью SQL Server и Azure Site Recovery 

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнеса и восстановления после сбоев (BCDR), управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Site Recovery поддерживает ряд механизмов репликации для обеспечения постоянной защиты, репликации и отработку отказа машин в Azure или в дополнительный центр обработки данных. Обзор всех сценариев развертывания см. в статье [Обзор Azure Site Recovery](site-recovery-overview.md).

 В этой статье описывается способ организации защиты серверной части SQL Server приложения с помощью сочетания технологий SQL Server BCDR и Site Recovery. Для развертывания сценариев, описанных в этой статье, требуется хорошее понимание функций SQL Server BCDR (отказоустойчивая кластеризация, группы доступности AlwaysOn, зеркальное отображение базы данных, доставка журналов) и Site Recovery.



## Обзор

В основе многих рабочих нагрузок используется SQL Server. Для реализации служб данных приложения, такие как SharePoint, Dynamics и SAP, используют SQL Server. Для защиты и восстановления баз данных SQL Server используются такие компоненты SQL Server для обеспечения высокой доступности и аварийного восстановления, как группы доступности SQL Server. Приложения развертывают SQL Server в следующих конфигурациях


1. Автономный сервер SQL: SQL Server и все базы данных размещаются на одной машине (физической или виртуальной). Если сервер виртуальный, то кластеризация размещения используется для обеспечения высокой доступности; на гостевом уровне высокая доступность не реализуется. 
2.	Экземпляры отказоустойчивой кластеризации сервера SQL (FCI Always ON): в этом случае 2 или несколько узлов экземпляров сервера SQL с общими дисками настраиваются в отказоустойчивом кластере Windows. Если один из экземпляров отказоустойчивых кластеров SQL откажет, кластер сможет перевести SQL на другой экземпляр. Обычно этот вариант используется для обеспечения высокой доступности на основном сайте. Он не защищает от сбоев и неполадок в слое общего хранилища. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или общих VHDX-файлов.
3.	Группы доступности SQL AlwaysOn в Azure: в этом случае два узла настраиваются в кластере без общих ресурсов, в котором базы данных SQL настроены в группе доступности с синхронной репликацией и автоматическим переходом на другой ресурс.

SQL Server Enterprise предлагает собственные технологии аварийного восстановления баз данных на удаленный сайт. По возможности для формирования плана аварийного восстановления с помощью Azure Site Recovery мы применим и интегрируем следующие технологии аварийного восстановления SQL:


1. Группа доступности SQL Always On из системы аварийного восстановления для SQL Enterprise 2012 или 2014. 
2.	Зеркальное отображение базы данных SQL в режиме высокого уровня безопасности для SQL Server Standard (любой версии) или SQL Server 2008 R2.



Site Recovery позволяет защитить сервер SQL Server, выступающий в качестве виртуальной машины Hyper-V, виртуальной машины VMware или физического сервера.

 |**Из локальной среды в локальную среду** | **Из локальной среды в Azure** 
---|---|---
**Hyper-V** | Да | Да
**VMware** | Да | Да 
**Физический сервер** | Да | Да


## Поддержка и интеграция

Данная статья относится к следующим версиям SQL Server:


- SQL Server 2014 Enterprise и Standard;
- SQL Server 2012 Enterprise и Standard;
- SQL Server 2008 R2 Enterprise и Standard.


Site Recovery может интегрироваться с собственными технологиями SQL Server BCDR, перечисленными в приведенной ниже таблице, для создания решения аварийного восстановления.

**Компонент** |**Дополнительные сведения** | **Версия SQL Server** 
---|---|---
**Группа доступности AlwaysOn** | <p>Несколько отдельных экземпляров SQL Server, каждый из которых запущен в отказоустойчивом кластере с несколькими узлами.</p> <p>Базы данных можно объединить в группы отработки отказа, которые затем можно скопировать (зеркальное отображение) на экземпляры SQL Server, благодаря чему исключается необходимость в общем хранилище.</p> <p>Обеспечивает аварийное восстановление между основным объектом и одним или несколькими дополнительными объектами. Два узла можно настроить в кластере без общих ресурсов, в котором базы данных SQL Server настроены в группе доступности с синхронной репликацией и автоматическим переходом на другой ресурс.</p> | SQL Server 2014/2012 Enterprise
**Отказоустойчивая кластеризация (AlwaysOn FCI)** | <p>SQL Server применяет отказоустойчивую кластеризацию Windows для обеспечения высокого уровня доступности локальных рабочих нагрузок SQL Server.</p><p>Узлы, на которых выполняются экземпляры SQL Server с общими дисками, настроены в отказоустойчивом кластере. Если экземпляр выходит из строя, выполняется переход кластера на другой ресурс.</p> <p>Кластер не обеспечивает защиту от сбоев или простоев в общем хранилище. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или с помощью в общих VHDX-файлов.</p> | Выпуски SQL Server Enterprise</p> <p>SQL Server Standard (ограничено только двумя узлами)
**Зеркальное отображение базы данных (в режиме высокого уровня безопасности)** | Защищает одну базу данных переносом в одну дополнительную копию. Доступно как в режиме репликации с высоким уровнем безопасности (синхронный режим), так и в режиме репликации с высоким уровнем производительности (асинхронный режим). Не требует наличия отказоустойчивого кластера. | <p>SQL Server 2008 R2</p><p>Все выпуски SQL Server Enterprise</p>
**Автономный SQL Server** | SQL Server и база данных находятся на одном сервере (физическом или виртуальном). Если сервер виртуальный, то кластеризация размещения используется для обеспечения высокой доступности. Без высокой доступности гостевого уровня. | Выпуск Enterprise или Standard




В таблице ниже перечислены рекомендации корпорации Майкрософт относительно интеграции технологий SQL Server BCDR в развертывание Site Recovery.

**Версия** |**Выпуск** | **Развертывание** | **От локального к локальным** | **От локального к Azure** 
---|---|---|---|---
SQL Server 2014 или 2012 | Enterprise | Экземпляр отказоустойчивого кластера | Группы доступности AlwaysOn | Группы доступности AlwaysOn
 | Enterprise | Группы доступности AlwaysOn для обеспечения высокой доступности | Группы доступности AlwaysOn | Группы доступности AlwaysOn
 | Стандартная | Экземпляр отказоустойчивого кластера (FCI) | Репликация Site Recovery с локальным зеркалом | Репликация Site Recovery с локальным зеркалом
 | Enterprise или Standard | Автономный | Репликация Site Recovery | Репликация Site Recovery 
SQL Server 2008 R2 | Enterprise или Standard | Экземпляр отказоустойчивого кластера (FCI) | Репликация Site Recovery с локальным зеркалом | Репликация Site Recovery с локальным зеркалом
 | Enterprise или Standard | Автономный | Репликация Site Recovery | Репликация Site Recovery
SQL Server (любая версия) | Enterprise или Standard | Экземпляр отказоустойчивого кластера — приложение DTC | Репликация Site Recovery | Не поддерживается

## Предварительные условия для развертывания

Ниже перечислены условия, которые необходимо выполнить перед началом работы.


- Локальное развертывание SQL Server с поддерживаемой версией SQL Server. Обычно также потребуется служба Active Directory для SQL Server.
- Необходимые условия для сценария, который требуется развернуть, представлены в статье, посвященной каждому развертыванию. Ссылки на них приведены в статье [Обзор Site Recovery](site-recovery-overview.md).
- Если вы хотите настроить восстановление в Azure, на виртуальных машинах SQL Server потребуется запустить средство [оценки готовности виртуальной машины Azure](http://www.microsoft.com/download/details.aspx?id=40898), чтобы убедиться в их совместимости с Azure и Site Recovery.


## Настройка защиты AD

Для правильной работы SQL Server на дополнительном сайте восстановления потребуется настроить службу Active Directory. Существует несколько вариантов настройки:

- **для малых предприятий** — если имеется небольшое количество приложений и один контроллер домена для локального сайта и вам требуется выполнить отработку отказа всего сайта, то рекомендуем использовать репликацию Site Recovery для репликации контроллера домена в дополнительный центр обработки данных или в Azure;

- **для средних и крупных предприятий** — если имеется большое количество приложений, вы используете лесу Active Directory и вам требуется выполнить отработку отказа для каждого отдельного приложения или рабочей нагрузки, рекомендуется настроить дополнительный контроллер домена в дополнительном центре обработки данных или в Azure. Обратите внимание, что при использовании групп доступности AlwaysOn для восстановления удаленного сайта рекомендуется настроить другой дополнительный контроллер домена на дополнительном сайте или в Azure, который будет использоваться для восстановленного экземпляра SQL Server.

При выполнении инструкций в этом документе предполагается, что в дополнительном расположении доступен контроллер домена. Руководство по решению AD DR см. [здесь](http://aka.ms/asr-ad).

##Настройка защиты для групп доступности SQL AlwaysOn

### Из локальной среды в Azure

Azure Site Recovery (ASR) имеет встроенную поддержку SQL AlwaysOn. Если вы создали группу доступности SQL и настроили виртуальную машину Azure как вторичную, то для управления отработкой отказа в группах доступности можете использовать ASR.

На данный момент эта функция находится на этапе предварительной версии и доступна только в том случае, если центром обработки данных управляет System Center Virtual Machine Manager (VMM).

#### Среды, управляемые сервером VMM
При переходе в хранилище ASR вы должны увидеть вкладку Серверы SQL Server на вкладке "Защищенные элементы".

![Защищенные элементы](./media/site-recovery-sql/protected-items.png)

Ниже описана процедура интеграции SQL AlwaysOn с ASR.

##### Предварительные требования
- Локальный SQL Server на автономном сервере или в отказоустойчивом кластере 
- Одна или несколько виртуальных машин Azure с установленным SQL Server
- Настроенные группы доступности SQL между локальным SQL Server и SQL Server, работающим в Azure
- На локальном SQL Server необходимо включить удаленное взаимодействие PowerShell. Сервер VMM должен иметь возможность удаленного вызова PowerShell на SQL Server
- На локальном SQL Server необходимо добавить учетную запись пользователя в группы пользователей SQL как минимум со следующими разрешениями:
	- ИЗМЕНЕНИЕ ГРУППЫ ДОСТУПНОСТИ — [ссылка 1](https://msdn.microsoft.com/ru-RU/library/hh231018.aspx), [ссылка 2](https://msdn.microsoft.com/ru-RU/library/ff878601.aspx#Anchor_3)
	- ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ — [ссылка 1](https://msdn.microsoft.com/ru-RU/library/ff877956.aspx#Security)
- На сервере VMM необходимо создать учетную запись запуска для учетной записи, добавленной на предыдущем этапе.
- Модуль SQL PS необходимо установить на серверы SQL Server, работающие локально и на виртуальных машинах Azure.
- На виртуальные машины, работающие на Azure, необходимо установить агент виртуальной машины.
- Каталогу NTAUTHORITY\\System необходимо предоставить следующие разрешения на SQL Server, работающему на виртуальных машинах в Azure:
	- ИЗМЕНЕНИЕ ГРУППЫ ДОСТУПНОСТИ — [ссылка 1](https://msdn.microsoft.com/ru-RU/library/hh231018.aspx), [ссылка 2](https://msdn.microsoft.com/ru-RU/library/ff878601.aspx#Anchor_3)
	- ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ — [ссылка 1](https://msdn.microsoft.com/ru-RU/library/ff877956.aspx#Security)

##### Добавление SQL Server

Щелкните "Добавить SQL", чтобы добавить новый SQL Server

![Добавить SQL](./media/site-recovery-sql/add-sql.png)

Укажите параметры SQL Server, VMM и учетные данные для управления SQL Server.

![Диалоговое окно "Добавление SQL"](./media/site-recovery-sql/add-sql-dialog.png)

###### Параметры
1. Имя: понятное имя, которое будет использоваться для указания на этот SQL Server.
2. SQL Server (FQDN): полное доменное имя (FQDN) исходного SQL Server, который требуется добавить. Если SQL Server установлен в отказоустойчивом кластере, укажите полное доменное имя кластера, а не какого-либо его узла. 
3. Экземпляр SQL Server: выберите экземпляра SQL по умолчанию или укажите имя пользовательского экземпляра SQL Server.
4. Сервер VMM: выберите один из серверов VMM, уже зарегистрированный в службе Azure Site Recovery (ASR). ASR будет использовать этот сервер VMM для взаимодействия с SQL Server.
5. УЧЕТНАЯ ЗАПИСЬ ЗАПУСКА: укажите имя одной из учетных записей запуска, созданной на выбранном выше сервере VMM. Эта учетная запись запуска будет использоваться для доступа к SQL Server и должна иметь разрешения на чтение и отработку отказа в группах доступности на SQL Server. 

Добавленный SQL Server появится на вкладке "Серверы SQL Server".

![Список серверов SQL Server](./media/site-recovery-sql/sql-server-list.png)

##### Добавление группы доступности SQL

Следующий шаг после добавления SQL Server — это добавление групп доступности в ASR. Для этого разверните SQL Server, добавленный на предыдущем этапе, и выберите пункт "Добавить группу доступности SQL".

![Добавить SQL AG](./media/site-recovery-sql/add-sqlag.png)

Группу доступности SQL можно реплицировать на одну или несколько виртуальных машин в Azure. При добавлении группы доступности SQL необходимо указать имя и подписку виртуальной машины Azure, на которой ASR будет выполнять отработку отказа этой группы доступности.

![Диалоговое окно "Добавление SQL AG"](./media/site-recovery-sql/add-sqlag-dialog.png)

В приведенном выше примере DB1-AG станет основной группой доступности на виртуальной машине SQLAGVM2, которая запускается при отработке отказа в подписке DevTesting2.

>[AZURE.NOTE]В AST можно добавлять только основные группы доступности на SQL Server, добавленном на предыдущем этапе. Если вы сделали группу доступности основной на SQL Server или после ее добавления добавили на SQL Server другие группы доступности, обновите сервер с помощью параметра "Обновить" в SQL Server.

#### Создание плана восстановления

Следующим шагом является создание плана восстановления с использованием виртуальных машин и групп доступности. Выберите тот же сервер VMM, который использовали в качестве источника в шаге 1, а в качестве целевого объекта укажите Microsoft Azure.

![Создание плана восстановления](./media/site-recovery-sql/create-rp1.png)

![Создание плана восстановления](./media/site-recovery-sql/create-rp2.png)

В примере приложение Sharepoint состоит из трех виртуальных машин, серверной частью для которых служит группа доступности SQL. В данном плане восстановления мы можем выбрать как группу доступности, так и виртуальную машину, входящую в приложение.

План восстановления можно дополнительно настроить, переместив виртуальные машины в другие группы отработки отказа и изменив таким образом порядок отработки отказа. Группа доступности всегда подвергается отработке отказа в первую очередь, так как в любом приложении служит серверной частью.

![Настройка плана восстановления](./media/site-recovery-sql/customize-rp.png)

#### Отработка отказа

После добавления группы доступности в план восстановления появляется доступ к различным параметрам обработки отказа.

##### Плановая отработка отказа

Плановая отработка отказа не предполагает потери данных. Для этого сначала группа доступности SQL переводится в синхронный режим доступности, а затем активируется отработка отказа, так что эта группа доступности становится основной на виртуальной машине, указанной при добавлении этой группы доступности в ASR. После завершения отработки отказа устанавливается режим доступности, который использовался перед активацией плановой отработки отказа.

##### Внеплановая отработка отказа

Внеплановая отработка отказа может привести к потере данных. При активации внеплановой отработки группа доступности не меняет режим, но становится основной на виртуальной машине, указанной при добавлении этой группы доступности в ASR. После завершения внеплановой отработки отказа и восстановления доступа к локальному серверу с SQL Server необходимо выполнить в группе доступности обратную репликацию. Обратите внимание, что это действие недоступно в плане восстановления и может быть выполнено только в группе доступности SQL на вкладке "Серверы SQL Server".

##### Тестирование отработки отказа
Тестирование отработки отказа для группы доступности SQL не поддерживается. При активации отработки отказа плана восстановления, содержащего группу доступности, отработка отказа этой группы доступности будет пропущена.

В качестве альтернативы предлагаем следующие варианты.

######Вариант 1



1. Выполните тестовую отработку отказа на уровне приложений и интерфейсном уровне.

2. Обновите уровень приложений для доступа к копии реплики в режиме только для чтения и выполните проверку приложения в режиме только для чтения.

######Вариант 2

1.	Создайте копию экземпляра виртуальной машины с репликой SQL Server (с помощью клона VMM типа "сеть-сеть" или функции резервного копирования Azure) и добавьте ее в тестовую сеть.
2.	Выполните тестовую отработку отказа с помощью плана восстановления.

##### Восстановление размещения

Если вы хотите снова сделать группу доступности основной на локальном SQL Server, активируйте плановую отработку отказа для плана восстановления и выберите направление с Microsoft Azure на локальный сервер VMM.

#### Обратная репликация

Для восстановления репликации после внеплановой отработки отказа необходимо активировать в группе доступности обратную репликацию. До выполнения этого действия репликация будет приостановлена.


### Среды, не управляемые сервером VMM

В средах, которые не управляются сервером VMM, можно использовать для настройки сценариев отработки отказа в группах доступности SQL модули Runbook службы автоматизации Azure. Порядок соответствующей настройки описан ниже.


1.	Создайте локальный файл сценария для отработки отказа группы доступности. В этом примере сценария указывается путь к группе доступности в реплике Azure и выполняется отработка отказа в этот экземпляр реплики. Этот сценарий будет выполняться на реплике виртуальной машины SQL Server путем его передачи с помощью расширения пользовательского сценария.



    	Param(
    	[string]$SQLAvailabilityGroupPath
    	)
    	import-module sqlps
    	Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force

2.	Передайте этот сценарий в большой двоичный объект в учетной записи хранения Azure. Используйте пример ниже:

    	$context = New-AzureStorageContext -StorageAccountName "Account" -StorageAccountKey "Key"
    	Set-AzureStorageBlobContent -Blob "AGFailover.ps1" -Container "script-container" -File "ScriptLocalFilePath" -context $context

3.	Создайте модуль Runbook службы автоматизации Azure для запуска сценариев на реплике виртуальной машины SQL Server в Azure. Для этого используйте указанный ниже образец сценария. [Узнайте подробнее](site-recovery-runbook-automation.md) об использовании модулей Runbook службы автоматизации в планах восстановления.

    	workflow SQLAvailabilityGroupFailover
    	{
    		param (
        		[Object]$RecoveryPlanContext
    		)

    		$Cred = Get-AutomationPSCredential -name 'AzureCredential'
	
    		#Connect to Azure
    		$AzureAccount = Add-AzureAccount -Credential $Cred
    		$AzureSubscriptionName = Get-AutomationVariable –Name ‘AzureSubscriptionName’
    		Select-AzureSubscription -SubscriptionName $AzureSubscriptionName
    
    		InLineScript
    		{
     		#Update the script with name of your storage account, key and blob name
     		$context = New-AzureStorageContext -StorageAccountName "Account" -StorageAccountKey "Key";
     		$sasuri = New-AzureStorageBlobSASToken -Container "script-container"- Blob "AGFailover.ps1" -Permission r -FullUri -Context $context;
     
     		Write-output "failovertype " + $Using:RecoveryPlanContext.FailoverType;
               
     		if ($Using:RecoveryPlanContext.FailoverType -eq "Test")
       			{
           		#Skipping TFO in this version.
           		#We will update the script in a follow-up post with TFO support
           		Write-output "tfo: Skipping SQL Failover";
       			}
     		else
       			{
           		Write-output "pfo/ufo";
           		#Get the SQL Azure Replica VM.
           		#Update the script to use the name of your VM and Cloud Service
           		$VM = Get-AzureVM -Name "SQLAzureVM" -ServiceName "SQLAzureReplica";     
       
           		Write-Output "Installing custom script extension"
           		#Install the Custom Script Extension on teh SQL Replica VM
           		Set-AzureVMExtension -ExtensionName CustomScriptExtension -VM $VM -Publisher Microsoft.Compute -Version 1.3| Update-AzureVM; 
                    
           		Write-output "Starting AG Failover";
           		#Execute the SQL Failover script
           		#Pass the SQL AG path as the argument.
       
           		$AGArgs="-SQLAvailabilityGroupPath sqlserver:\sql\sqlazureVM\default\availabilitygroups\testag";
       
           		Set-AzureVMCustomScriptExtension -VM $VM -FileUri $sasuri -Run "AGFailover.ps1" -Argument $AGArgs | Update-AzureVM;
       
           		Write-output "Completed AG Failover";

       			}
        
    		}
    	}

4.	При создании плана восстановления для приложения добавьте шаг "pre-Group 1 boot" из сценария, который запускает модуль Runbook службы автоматизации для отработки отказа групп доступности.

###Из локальной среды в локальную среду
Если SQL Server использует группы доступности для обеспечения высокой доступности или экземпляр отказоустойчивого кластера, то на сайте восстановления так же рекомендуется использовать группы доступности. Обратите внимание, что данное руководство предназначено для приложений, не использующих распределенные транзакции.


1. [Настройте базы данных](https://msdn.microsoft.com/library/hh213078.aspx) для их добавления в группы доступности.
2. Создайте на дополнительном сайте новую виртуальную сеть.
3. Настройте VPN типа "сеть-сеть" между новой виртуальной сетью и основным сайтом.
4. Создайте виртуальную машину на сайте восстановления и установите на нее SQL Server.
5. Расширьте существующие группы доступности AlwaysOn для новой виртуальной машины SQL Server. Настройте этот экземпляр SQL Server в качестве копии асинхронной реплики.
6. Создайте прослушиватель группы доступности или обновите существующий прослушиватель, включив в него виртуальную машину асинхронной реплики.
7. Убедитесь в том, что ферма приложений настроена с помощью прослушивателя. Если настройка выполнена с использованием имени сервера базы данных, обновите его, чтобы использовать прослушиватель, чтобы вам не пришлось перенастраивать ее после отработки отказа.

Для приложений, использующих распределенные транзакции, рекомендуется использовать [репликацию Site Recovery с SAN](site-recovery-vmm-san.md) или [репликацией VMWare типа "сеть-сеть"](site-recovery-vmware-to-vmware.md).

####Рекомендации по плану восстановления

1. Добавьте этот образец сценария в библиотеку VMM на основном и дополнительном сайтах.

    	Param(
    	[string]$SQLAvailabilityGroupPath
    	)
    	import-module sqlps
    	Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force

2. При создании плана восстановления для приложения добавьте шаг "pre-Group 1 boot" из сценария, который запускает сценарий для отработки отказа групп доступности.



## Настройка защиты автономного сервера SQL Server


В этой конфигурации для защиты компьютера SQL Server рекомендуется использовать репликацию Site Recovery. Конкретные шаги зависят от того, настроен ли SQL Server в качестве виртуальной машины и физического сервера, а также от необходимости реплицировать в Azure или в дополнительный локальный сайт. Инструкции для всех сценариев развертывания см. в статье [Обзор Site Recovery](site-recovery-overview.md).


## Настройка защиты кластера SQL Server (Standard или 2008 R2)

Для кластера под управлением выпуска SQL Server Standard или SQL Server 2008 R2 рекомендуется использовать репликацию Site Recovery для защиты SQL Server.

#### Из локальной среды в локальную среду

- Если приложение использует распределенные транзакции, рекомендуется использовать [репликацию Site Recovery с SAN](site-recovery-vmm-san.md) для среды Hyper-V и [репликацию VMware–VMware](site-recovery-vmware-to-vmware.md) для среды VMware.

- Для приложений без DTC описанный выше метод позволяет восстановить кластер как автономный сервер, используя локальное зеркало баз данных с высоким уровнем безопасности.

#### Из локальной среды в Azure

Site Recovery не поддерживает гостевой кластер при репликации в Azure. SQL Server также не предоставляет экономичное решение для аварийного восстановления для выпуска Standard. Рекомендуется защитить локальный кластер SQL Server в автономный сервер SQL Server и восстановить его в Azure.


1. Настройте дополнительный автономный экземпляр SQL Server в локальном сайте.
2. Настройте этот экземпляр в качестве зеркальной копии баз данных, которые требуется защитить. Настройте зеркальное отображение в режиме высокого уровня безопасности.
3.	Настройте Site Recovery на локальном сайте в соответствии со средой ([Hyper-V](site-recovery-hyper-v-site-to-azure.md) или [VMware](site-recovery-vmware-to-azure.md)).
4.	Воспользуйтесь репликацией Site Recovery для репликации нового экземпляра SQL Server в Azure. Это зеркальная копия с высоким уровнем безопасности, поэтому она будет синхронизирована с основным кластером, однако в Azure она будет реплицирована с помощью репликации Site Recovery.

На рисунке ниже иллюстрируется процесс настройки.

![Стандартный кластер](./media/site-recovery-sql/BCDRStandaloneClusterLocal.png)


### Рекомендации относительно восстановления размещения

В случае стандартных кластеров SQL для восстановления после внеплановой отработки отказа необходимо выполнить резервное копирование сервера SQL, восстановить его из экземпляра зеркала в исходный кластер, а затем переустановить зеркало.










 

<!---HONumber=Nov15_HO3-->