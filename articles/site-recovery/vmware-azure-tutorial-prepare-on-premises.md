---
title: Подготовка локальных серверов VMware для аварийного восстановления виртуальных машин VMware в Azure | Документация Майкрософт
description: Узнайте, как подготовить локальные сервера VMware для аварийного восстановления виртуальных машин VMware в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 04/08/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: f7722891af15111fd0151055c35bf24100ed79b1
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="prepare-on-premises-vmware-servers-for-disaster-recovery-to-azure"></a>Подготовка локальных серверов VMware для аварийного восстановления в Azure

В этом руководстве показано, как подготовить локальную инфраструктуру VMware к репликации виртуальных машин VMware в Azure. Из этого руководства вы узнаете, как:

> [!div class="checklist"]
> * Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
> * Подготовить учетную запись для автоматической установки службы Mobility Service на виртуальные машины VMware.
> * Проверить требования сервера VMware.
> * Проверить требования виртуальных машин VMware.

В этой серии руководств показано, как реплицировать одну виртуальную машину с помощью Azure Site Recovery. 

Это второе руководство в серии. Убедитесь, что [компоненты Azure настроены](tutorial-prepare-azure.md), как описано в предыдущем руководстве.

Если вы реплицируете несколько виртуальных машин, скачайте [инструмент "Планировщик развертывания"](https://aka.ms/asr-deployment-planner) для репликации из VMware. [Узнайте больше](site-recovery-deployment-planner.md).


## <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Site_Recovery**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

### <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

**Задача.** | **Роль/Разрешения** | **Дополнительные сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Полная репликация, отработка отказа, восстановление размещения** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

## <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для виртуальной машины. Для автоматической установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальной машине. Укажите эту учетную запись при настройке аварийного восстановления в консоли Azure.

1. Подготовьте домен или локальную учетную запись с этими разрешениями для установки на виртуальной машине.
2. Если при установке на виртуальные машины Windows не используется учетная запись домена, отключите контроль удаленного доступа пользователей на локальном компьютере.
   - В разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
3. Для установки на виртуальные машины Linux необходимо подготовить корневую учетную запись на исходном сервере Linux.


## <a name="check-vmware-requirements"></a>Проверка соответствия требованиям к VMware

Убедитесь, что серверы и виртуальные машины VMware соответствуют требованиям.

1. [Проверьте](vmware-physical-azure-support-matrix.md#on-premises-virtualization-servers) соответствие требованиям сервера VMware.
2. Если вы используете Linux, [проверьте](vmware-physical-azure-support-matrix.md#linux-file-systemsguest-storage) соответствие требованиям к файловой системе и хранилищу. 
3. Проверьте поддержку локальных [сетей](vmware-physical-azure-support-matrix.md#network) и [хранилищ](vmware-physical-azure-support-matrix.md#storage). 
4. Проверьте возможности, которые поддерживаются для [сети Azure](vmware-physical-azure-support-matrix.md#azure-vm-network-after-failover), [хранилища](vmware-physical-azure-support-matrix.md#azure-storage) и [вычислительных ресурсов](vmware-physical-azure-support-matrix.md#azure-compute) после отработки отказа.
5. Локальные виртуальные машины, которые реплицируются в Azure, должны соответствовать [требованиям к виртуальным машинам Azure](vmware-physical-azure-support-matrix.md#azure-vm-requirements).


## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

При выполнении сценария отработки отказа может потребоваться подключение к реплицируемым виртуальным машинам в Azure из локальной сети.

Чтобы подключиться к виртуальным машинам Windows с помощью RDP после отработки отказа, сделайте следующее:

1. Чтобы получить доступ к Интернету, включите RDP на локальных виртуальных машинах перед отработкой отказа. Убедитесь в том, что правила TCP и UDP добавлены для **общедоступного** профиля, а RDP разрешен в разделе **Брандмауэр Windows** > **Allowed Apps** (Разрешенные приложения) для всех профилей.
2. Для доступа через VPN типа "сеть — сеть" включите RDP на локальном компьютере. Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**.
   Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Узнайте больше](https://support.microsoft.com/kb/3031135). Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления.
3. После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Чтобы подключиться к виртуальной машине Linux с помощью SSH после отработки отказа, сделайте следующее:

1. На локальном компьютере перед отработкой отказа убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы. Убедитесь, что правила брандмауэра разрешают SSH-подключение.

2. Правила группы безопасности сети на виртуальной машине Azure, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
   [Добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md) для виртуальной машины. Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](vmware-azure-tutorial.md)
