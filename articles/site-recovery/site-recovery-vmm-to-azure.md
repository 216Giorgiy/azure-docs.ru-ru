<properties
	pageTitle="Репликация виртуальных машин Hyper-V из облачных сред VMM в Azure | Microsoft Azure"
	description="В этой статье описывается, как выполнять репликацию виртуальных машин Hyper-V на узлах Hyper-V, расположенных в облаках System Center VMM, в Azure."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="03/15/2016"
	ms.author="raynew"/>

#  Репликация виртуальных машин Hyper-V из облачных сред VMM в Azure

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## Обзор

В этой статье описывается развертывание службы Site Recovery для репликации виртуальных машин Hyper-V на серверах узла Hyper-V, расположенных в частных облаках VMM, в среду Azure.

Руководство включает перечень необходимых для реализации этого сценария компонентов, а также инструкции по настройке хранилища Site Recovery, установке поставщика Azure Site Recovery на исходном сервере VMM, регистрации сервера в хранилище, добавлению учетной записи хранения Azure, установке агента Azure Recovery Services на серверах узлов Hyper-V, настройке параметров защиты для облаков VMM, которые будут применяться ко всем защищенным виртуальным машинам, и включению защиты для этих виртуальных машин. В качестве завершения выполните отработку отказа, чтобы убедиться в том, что все работает правильно.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Архитектура

![Архитектура](./media/site-recovery-vmm-to-azure/topology.png)

- Поставщик Azure Site Recovery устанавливается на сервере VMM во время развертывания службы Site Recovery, а сервер VMM регистрируется в хранилище Site Recovery. Поставщик обменивается данными с Site Recovery для оркестрации репликации.
- Агент служб восстановления Azure устанавливается на серверах узла Hyper-V во время развертывания службы Site Recovery. Он выполняет репликацию данных в хранилище Azure.


## Предварительные требования Azure

Вам потребуется следующее (среда Azure).

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Учетная запись Azure**| Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). См. [дополнительные сведения](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на Site Recovery. 
**Служба хранилища Azure** | Для хранения реплицируемых данных потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа. <br/><br/>Необходима [учетная запись хранения для геоизбыточного хранилища (ценовая категория "Стандартный")](../storage/storage-redundancy.md#geo-redundant-storage). Она должна находиться в том же регионе, что и служба Site Recovery, и быть связана с той же подпиской. Обратите внимание, что сейчас репликация в учетные записи хранилища класса Premium не поддерживается и ее не следует использовать. Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.<br/><br/>[Прочтите статью](../storage/storage-introduction.md) о службе хранилища Azure.
**Сеть Azure** | Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище Site Recovery. 

## Предварительные требования для локальной среды

Вам потребуется следующее (локальная среда).

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**VMM** | Вам понадобится по крайней мере один сервер VMM, развернутый как отдельный физический или виртуальный сервер либо как виртуальный кластер. <br/><br/>Сервер VMM должен работать под управлением System Center 2012 R2 с последними накопительными пакетами обновления.<br/><br/>На сервере VMM должно быть настроено хотя бы одно облако.<br/><br/>Исходное облако, которое требуется защитить, должно содержать одну или несколько групп узлов VMM.<br/><br/>Чтобы получить дополнительные сведения о настройке облаков VMM, см. [пошаговое руководство по созданию частных облаков с помощью VMM в System Center 2012 с пакетом обновления 1 (SP1)](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) в блоге Кита Мейера (Keith Mayer).
**Hyper-V** | Один или несколько серверов узлов или кластеров Hyper-V в облаке VMM. Сервер узла должен содержать одну или несколько виртуальных машин. <br/><br/>Серверы Hyper-V должны работать под управлением Windows Server 2012 R2 (или более поздней версии) с ролью Hyper-V, и на них должны быть установлены последние пакеты обновлений.<br/><br/>Все серверы Hyper-V, содержащие виртуальные машины, которые необходимо защитить, должны быть расположены в облаке VMM.<br/><br/>Если Hyper-V выполняется в кластере, учтите, что брокер кластера не создается автоматически для кластера со статическим IP-адресом. Вам потребуется настроить брокер кластера вручную. См. [дополнительные сведения](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters) в записи блога Эйдена Финна (Aidan Finn).
**Защищенные компьютеры** | Виртуальные машины, которые требуется защитить, должны соответствовать [требованиям, предъявляемым средой Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).


## Предварительные требования сетевого сопоставления
В рамках защиты виртуальных машин в Azure с помощью сопоставления сетей осуществляется сопоставление сетей виртуальных машин на исходном сервере VMM и целевых сетей Azure, что обеспечивает следующие преимущества.

- Отработка отказа всех виртуальных машин выполняется в одной сети, что позволяет им подключаться друг к другу, независимо от назначенного им плана восстановления.
- При наличии сетевого шлюза в целевой сети Azure виртуальные машины могут подключиться к другим локальным виртуальным машинам.
- Если сопоставление не включено, то после отработки отказа в Azure могут подключаться друг к другу только виртуальные машины, переключающиеся на другой ресурс в рамках одного плана восстановления.

Для развертывания сетевого сопоставления требуется следующее.

- Защищаемые виртуальные машины на исходном сервере VMM должны быть подключены к сети виртуальных машин. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
- Сеть Azure, к которой могут подключаться реплицированные виртуальные машины после отработки отказа. Эту сеть вы выбираете во время отработки отказа. Сеть должна быть в том же регионе, в котором действует ваша подписка Azure Site Recovery.

Подготовка к сопоставлению сетей:

1. [Прочтите эту статью](site-recovery-network-mapping.md) о требованиях к сетевому сопоставлению.
2. Подготовьте сети виртуальных машин в VMM:

	- [Настройте логические сети](https://technet.microsoft.com/library/jj721568.aspx).
	- [Настройте сети виртуальных машин](https://technet.microsoft.com/library/jj721575.aspx).


## Шаг 1. Создание хранилища Site Recovery

1. Войдите на [Портал управления](https://portal.azure.com) с сервера VMM, который хотите зарегистрировать.
2. Щелкните **Службы данных** > **Службы восстановления** > **Хранилище Site Recovery**.
3. Выберите **Создать** > **Быстрое создание**.
4. В поле **Имя** введите понятное имя для идентификации хранилища.
5. В поле **Область** выберите географический регион для хранилища архивации. Сведения о поддерживаемых регионах см. в разделе "Регионы" страницы [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. Щелкните элемент **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-vmm-to-azure/create-vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. На главной странице служб восстановления это хранилище будет указано с состоянием **Активно**.

## Шаг 2. Создание ключа регистрации хранилища

Создайте ключ регистрации в хранилище. После загрузки поставщика Azure Site Recovery и установки его на сервер VMM этот ключ используется для регистрации сервера VMM в хранилище.

1. На странице **Службы восстановления** щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Значок быстрого запуска](./media/site-recovery-vmm-to-azure/qs-icon.png)

2. В раскрывающемся списке выберите элемент **Between an on-premises VMM site and Microsoft Azure (Между локальным сайтом VMM и Microsoft Azure)**.
3. В разделе **Prepare VMM Servers** (Подготовка серверов VMM) выберите пункт **Generate registration key** (Создать регистрационный ключ). Файл ключа создается автоматически. Срок действия ключа — пять дней с момента создания. Если вы получаете доступ к порталу Azure не с сервера VMM, вам потребуется скопировать этот файл на сервер.

	![Регистрационный ключ](./media/site-recovery-vmm-to-azure/register-key.png)

## Шаг 3. Установка поставщика Azure Site Recovery

1. На странице **Быстрый запуск** в разделе **Подготовка серверов VMM** щелкните ссылку **Скачайте поставщик Microsoft Azure Site Recovery для установки на серверы VMM**, чтобы получить последнюю версию установочного файла поставщика.
2. Запустите этот файл на исходном сервере VM. Если развертывание VMM выполняется в кластере и вы устанавливаете поставщик впервые, установите его на активном узле и завершите установку, чтобы зарегистрировать сервер VMM в хранилище. Затем установите поставщик на других узлах. Учтите, что при обновлении поставщика потребуется обновить его на всех узлах, так как все они должны работать под управлением одной версии.
3. Установщик выполняет проверку предварительных требований и запрашивает разрешение на остановку службы VMM, чтобы начать установку поставщика. Служба VMM автоматически перезапустится после завершения установки. При установке в кластере VMM будет выдан запрос на остановку роли Cluster.

	![Предварительные требования](./media/site-recovery-vmm-to-azure/prereq.png)

4. В **Центре обновления Майкрософт** вы можете настроить обновления. Если этот параметр включен, то обновления поставщика будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Центр обновления Майкрософт](./media/site-recovery-vmm-to-azure/updates.png)


5.  Для поставщика задано такое расположение установки: **<SystemDrive>\\Program Files\\Microsoft System Center 2012 R2\\Virtual Machine Manager\\bin**. Щелкните **Install** (Установить).

	![InstallLocation](./media/site-recovery-vmm-to-azure/install-location.png)

6. После установки поставщика нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

	![InstallComplete](./media/site-recovery-vmm-to-azure/install-complete.png)

7. На странице **Подключение к Интернету** укажите, как запущенный на сервере VMM поставщик подключается к Интернету. Выберите пункт **Use default system proxy settings** (Использовать настройки прокси-сервера по умолчанию), чтобы использовать настройки подключения к Интернету, по умолчанию заданные на сервере.

	![Параметры Интернета](./media/site-recovery-vmm-to-azure/proxy.png)

	- Если вы хотите использовать настраиваемый прокси-сервер, его следует настроить перед установкой поставщика. При настройке параметров прокси-сервера выполняется проверка подключения к прокси-серверу.
	- Если вы используете настраиваемый прокси-сервер или прокси-сервер по умолчанию требует выполнения проверки подлинности, вам потребуется указать сведения о прокси-сервере, включая его адрес и порт.
	- C сервера VMM должны быть доступны следующие URL-адреса и узлы Hyper-V:
		- **.hypervrecoverymanager.windowsazure.com
- **.accesscontrol.windows.net
- **.backup.windowsazure.com
- **.blob.core.windows.net
- **.store.core.windows.net
- Разрешите IP-адреса, перечисленные на странице [Microsoft Azure Datacenter IP Ranges](https://www.microsoft.com/download/details.aspx?id=41653) (Диапазоны IP-адресов центра обработки данных Microsoft Azure), и протокол HTTPS (443). Необходимо разрешить диапазоны IP-адресов региона Azure, который вы планируете использовать, и западной части США.

	- При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM. Для этого откройте рабочую область "Параметры", щелкните "Учетные записи запуска от имени", а затем измените пароль для учетной записи DRAProxyAccount. Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.

8. В поле **Регистрационный ключ** укажите, что вы скачали его с Azure Site Recovery и скопировали на сервер VMM.
9. В поле **Имя хранилища** проверьте имя хранилища, в котором будет зарегистрирован сервер. 

	![Регистрация сервера](./media/site-recovery-vmm-to-azure/credentials.png)

10. Вы можете указать расположение сертификата SSL, который создается автоматически для шифрования данных. Этот сертификат будет использован при включении шифрования данных для облака VMM во время развертывания службы Site Recovery. Данный сертификат следует хранить в безопасном месте. Его будет предложено выбрать для расшифровки данных при выполнении отработки отказа в Azure.

	![Регистрация сервера](./media/site-recovery-vmm-to-azure/encryption.png)

11. В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.

12. В поле синхронизации **Initial cloud metadata** (Первоначальные метаданные в облаке) выберите, нужно ли синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.

	![Регистрация сервера](./media/site-recovery-vmm-to-azure/friendly.png)

13. Для завершения процесса нажмите кнопку **Далее**. После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Сервер отображается на вкладке **Серверы VMM** на странице **Серверы** в хранилище.

### Установка из командной строки

Поставщик Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\\ASR.
2. Остановите службу System Center Virtual Machine Manager.
3. В командной строке запустите с повышенными правами следующие команды, чтобы извлечь установщик поставщика:

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. Установите поставщик:

		C:\ASR> setupdr.exe /i

5. Зарегистрируйте поставщик:

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>       

Используйте следующие параметры.

 - **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.  
 - **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
 - **/EncryptionEnabled**: необязательный параметр для настройки шифрования виртуальных машин в Azure (шифрование неактивных данных). Имя файла должно иметь расширение **PFX**.
 - **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
 - **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
 - **/proxyUsername**: необязательный параметр, указывающий имя пользователя прокси-сервера.
 - **/proxyPassword**: необязательный параметр, указывающий пароль прокси-сервера.  


## Шаг 4. Создание учетной записи хранения Azure

1. Если у вас нет учетной записи хранения Azure, создайте ее, щелкнув **Добавление учетной записи хранения Azure**.
2. Создайте учетную запись со включенной георепликацией. Она должна находиться в том же регионе, что и служба Azure Site Recovery, и быть связана с той же подпиской.

	![Учетная запись хранения](./media/site-recovery-vmm-to-azure/storage.png)

>[AZURE.NOTE] Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.

## Шаг 5. Установка агента служб восстановления Azure

Установите агент служб восстановления Azure на всех серверах узлов Hyper-V в облаках VMM.

1. Щелкните **Быстрый запуск** > **Загрузить и установить на узлах агент служб Azure Site Recovery**, чтобы получить последнюю версию файла установки агента.

	![Установка агента служб восстановления Azure](./media/site-recovery-vmm-to-azure/install-agent.png)

2. Запустите файл установки на каждом сервере узла Hyper-V.
3. На странице **Проверка предварительных требований** нажмите кнопку **Далее**. Все отсутствующие предварительные требования будут установлены автоматически.

	![Предварительные требования для агента служб восстановления](./media/site-recovery-vmm-to-azure/agent-prereqs.png)

4. На странице **Параметры установки** укажите расположение для установки агента, а также расположение кэша для установки метаданных резервной копии. Нажмите **Install** (Установить).
5. После завершения установки нажмите кнопку **Закрыть**, чтобы завершить работу мастера.
	
	![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure/agent-register.png)

### Установка из командной строки 

Агент служб восстановления Microsoft Azure можно также установить из командной строки с помощью следующей команды:

    marsagentinstaller.exe /q /nu
	
## Шаг 6. Настройка параметров защиты облачных систем

После регистрации сервера VMM можно настроить параметры защиты облака. Параметр **Синхронизировать облачные данные с хранилищем** был включен при установке поставщика, поэтому все облака на сервере VMM появятся на вкладке <b>Защищенные элементы</b> в хранилище.

![Опубликованное облако](./media/site-recovery-vmm-to-azure/clouds-list.png)

1. На странице быстрого запуска щелкните **Set up protection for VMM clouds** (Установить защиту для облаков VMM).
2. На вкладке **Защищенные элементы** выберите облако, которое нужно настроить, и перейдите на вкладку **Конфигурация**.
3. Для параметра **Цель** выберите значение **Azure**.
4. Для параметра **Учетная запись хранения** выберите учетную запись хранения Azure, используемую для репликации. 

	>[AZURE.NOTE] Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.

5. Задайте параметру **Encrypt stored data** (Шифрование сохраненных данных) значение **Off** (выкл.). Этот параметр определяет, что данные должны шифроваться при репликации между локальным сайтом и Azure.
6. В поле **Периодичность копирования** оставьте значение по умолчанию. Это значение указывает, как часто следует синхронизировать данные между исходным и конечным расположениями.
7. В поле **Сохранения точек восстановления для** оставьте значение по умолчанию. При использовании нулевого значения по умолчанию на сервере узла реплики хранится только последняя точка восстановления для основной виртуальной машины.
8. В поле **Периодичность создания соответствующих приложению снимков** оставьте значение по умолчанию. Это значение указывает, как часто создаются моментальные снимки. Снимки используют службу теневого копирования томов (VSS), чтобы обеспечить согласованное состояние приложение при создании моментального снимка. Если это значение задается, оно должно быть меньше количества дополнительных точек восстановления, которое было настроено.
9. В поле **Время запуска репликации** укажите, когда должна запускаться начальная репликация данных на Azure. Используется часовой пояс сервера узла Hyper-V. Рекомендуется запланировать начальную репликацию на часы наименьшей нагрузки.

	![Параметры репликации облака](./media/site-recovery-vmm-to-azure/cloud-settings.png)

После сохранения параметров создается задание, которое можно отслеживать на вкладке **Задания**. Все серверы узлов Hyper-V в исходном облаке VMM будут настроены для репликации.

После сохранения параметры облака можно изменить на вкладке **Настройка**. Чтобы изменить целевое расположение или целевое хранилище, необходимо удалить конфигурацию облака, а затем повторно его настроить. Обратите внимание, что при изменении учетной записи хранения изменение применяется только к виртуальным машинам, которые включены для защиты после изменения учетной записи хранения. Существующие виртуальные машины в новую учетную запись хранения не переносятся.

## Шаг 7. Настройка сетевого сопоставления
Прежде чем приступать к настройке сетевого сопоставления, убедитесь, что виртуальные машины на исходном сервере VMM подключены к сети виртуальных машин. Кроме того, создайте одну или несколько виртуальных сетей Azure. Учтите, что несколько сетей виртуальных машин можно сопоставить с одной сетью Azure.

1. На странице быстрого запуска щелкните **Сопоставить сети**.
2. На вкладке **Сети** в поле **Исходное расположение** выберите исходный сервер VMM. В поле **Целевое расположение** выберите Azure.
3. В списке **исходных сетей** отображаются сети виртуальных машин, связанные с сервером VMM. В списке **целевых** сетей отображаются сети Azure, связанные с подпиской.
4. Выберите исходную сеть виртуальных машин и нажмите кнопку **Сопоставить**.
5. На странице **Выберите целевую сеть** выберите целевую сеть Azure, которую вы хотите использовать.
6. Установите флажок для завершения процесса сопоставления.

	![Параметры репликации облака](./media/site-recovery-vmm-to-azure/map-networks.png)

После сохранения параметров запускается задание отслеживания хода выполнения сопоставления, за которым можно наблюдать на вкладке "Задания". Все существующие реплики виртуальных машин, соответствующие исходной сети виртуальных машин, будут подключены к целевым сетям Azure. Новые виртуальные машины, подключенные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации. Если изменить существующее сопоставление, указав новую сеть, реплики виртуальных машин будут подключаться с новыми параметрами.

Учтите, что, если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, реплика виртуальной машины будет подключена к этой целевой подсети после отработки отказа. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.

## Шаг 8. Включение защиты для виртуальных машин

После успешной настройки серверов, облаков и сетей можно включить защиту для виртуальных машин в облаке. Обратите внимание на следующее.

- Виртуальные машины должны соответствовать [требованиям, предъявляемым средой Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).
- Для обеспечения защиты должны быть заданы соответствующие свойства операционной системы и диска с операционной системой. Данные свойства можно установить при создании виртуальной машины в VMM с помощью шаблона виртуальной машины. Эти свойства также можно задать для существующих виртуальных машин на вкладках **Общие** и **Конфигурация оборудования** свойств виртуальной машины. Если установка этих свойств в VMM не была выполнена, сделать это можно на портале Azure Site Recovery.

	![Создание виртуальной машины](./media/site-recovery-vmm-to-azure/enable-new.png)

	![Изменение свойств виртуальной машины](./media/site-recovery-vmm-to-azure/enable-existing.png)


1. Чтобы включить защиту, в облаке, в котором расположена виртуальная машина, на вкладке **Виртуальные машины** щелкните **Включить защиту** > **Добавить виртуальные машины**.
2. Из списка виртуальных машин в облаке выберите те, которые хотите защитить.

	![Включение защиты виртуальной машины](./media/site-recovery-vmm-to-azure/select-vm.png)

	За ходом выполнения действия **Включение защиты**, в том числе и за первоначальной репликацией, можно наблюдать на вкладке **Задания**. После запуска задания **Завершение подготовки защиты** виртуальная машина готова к отработке отказа. После включения защиты и репликации виртуальных машин вы сможете просматривать их в Azure.


	![Задание защиты виртуальной машины](./media/site-recovery-vmm-to-azure/vm-jobs.png)

3. Проверьте свойства виртуальной машины и внесите в них необходимые изменения.

	![Проверка виртуальных машин](./media/site-recovery-vmm-to-azure/vm-properties.png)

4. На вкладке **Настройка** в свойствах виртуальной машины можно изменить следующие свойства сети.



- **Количество сетевых адаптеров на целевой виртуальной машине**. Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины. Ознакомьтесь со [спецификациями размеров виртуальных машин](../virtual-machines/virtual-machines-size-specs.md#size-tables), чтобы узнать, какое количество сетевых адаптеров поддерживается для разных размеров виртуальных машин. После изменения размера виртуальной машины и сохранения параметров при следующем открытии страницы **Настройка** количество сетевых адаптеров изменится. Количество сетевых адаптеров целевых виртуальных машин — это минимальное количество сетевых адаптеров исходной виртуальной машины, а также максимальное количество сетевых адаптеров, поддерживаемое размером выбранной виртуальной машины:

	- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
	- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
	- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер. 	

- **Сеть целевой виртуальной машины**. Сеть, к которой подключается виртуальная машина, определяется сетевым сопоставлением сети исходной виртуальной машины. Если у исходной виртуальной машины есть несколько сетевых адаптеров, а исходные сети сопоставлены с разными сетями на целевом узле, вам нужно выбрать одну из целевых сетей.
- **Подсеть для каждого из сетевых адаптеров**. Для каждого сетевого адаптера можно выбрать подсеть, к которой будет подключаться виртуальная машина при отработке отказа.
- **Целевой IP-адрес**. Если сетевой адаптер исходной виртуальной машины настроен на использование статического IP-адреса, вы можете указать IP-адрес целевой виртуальной машины. Используйте эту возможность, чтобы сохранить IP-адрес исходной виртуальной машины после отработки отказа. Если IP-адрес не указан, при отработке отказа сетевому адаптеру будет присвоен любой доступный IP-адрес. Если целевой IP-адрес указан, но он уже используется другой виртуальной машиной в Azure, произойдет сбой отработки отказа.  

	![Изменение свойств сети](./media/site-recovery-vmm-to-azure/multi-nic.png)

>[AZURE.NOTE] Виртуальные машины Linux со статическим IP-адресом не поддерживаются.

## тестирование развертывания

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины. Также можно создать план восстановления, состоящий из нескольких виртуальных машин, и запустить тестовую отработку отказа плана.

Тестовая обработка отказа имитирует механизм отработки отказа и восстановления в изолированной сети. Обратите внимание на следующее.

- При необходимости подключиться к виртуальной машине в Azure с использованием удаленного рабочего стола после отработки отказа, включите подключение удаленного рабочего стола на виртуальной машине до запуска тестирования отработки отказа.
- После отработки отказа будет использоваться общедоступный IP-адрес, чтобы подключиться к виртуальной машине в Azure с использованием удаленного рабочего стола. Если необходимо это сделать, убедитесь в отсутствии политик домена, которые не допустили бы подключение к виртуальной машине с использованием общедоступного адреса.

### Создайте план восстановления

1. На вкладке **Планы восстановления** добавьте новый план. Укажите имя и **VMM** в поле **Тип источника** и исходный сервер VMM в поле **Источник**. В качестве целевого расположения выберите Azure.

	![Создать план восстановления](./media/site-recovery-vmm-to-azure/recovery-plan1.png)

2. На странице **Выбор виртуальных машин** выберите виртуальные машины, которые нужно добавить в план восстановления. Эти виртуальные машины добавляются в группу плана восстановления по умолчанию (группа 1). Проводилось тестирование сценария с максимум 100 виртуальными машинами в одном плане восстановления.

	- Если вы хотите проверить свойства виртуальной машины до добавления ее в план, щелкните виртуальную машину на странице свойств облака, в котором она размещается. Также можно настроить свойства виртуальной машины в консоли VMM.
	- Защита включена для всех отображаемых виртуальных машин. В списке содержатся виртуальные машины, для которых включена защита и выполнена начальная репликация, и виртуальные машины, для которых включена защита и начальная репликация не завершена. Отработка отказа в рамках плана восстановления может выполняться только для виртуальных машин с выполненной начальной репликацией. 


	![Создать план восстановления](./media/site-recovery-vmm-to-azure/select-rp.png)

Созданный план восстановления появится на вкладке **Планы восстановления**. Кроме того, к плану восстановления можно добавить [модули Runbook службы автоматизации Azure](site-recovery-runbook-automation.md), чтобы автоматизировать процедуру отработки отказа.

### Запуск тестовой отработки отказа

Существует два способа запуска тестовой отработки отказа в Azure.

- **Тестовая отработка отказа без использования сети Azure**. Этот тип тестовой отработки отказа проверяет, правильно ли работает виртуальная машина в Azure. Виртуальная машина не подключается к сети Azure после отработки отказа.
- **Тестовая отработка отказа с использованием сети Azure**. Этот тип отработки отказа проверяет, работает ли вся среда репликации должным образом и подключаются ли виртуальные машины, для которых выполнена отработка отказа, к указанной целевой сети Azure. Что касается подсетей, для тестовой отработки отказа подсеть тестовой виртуальной машины будет определяться в зависимости от подсети реплики виртуальной машины. Этот режим отличается от обычной репликации, когда подсеть реплики виртуальной машины основывается на подсети исходной виртуальной машины.

Если вы хотите выполнить тестовую отработку отказа для виртуальной машины с включенной защитой в Azure без указания целевой сети Azure, никакой подготовки не требуется. Для запуска тестовой отработки отказа с целевой сетью Azure потребуется создать новую сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании новой сети в Azure). Дополнительные сведения см. в разделе [Запуск тестовой отработки отказа](site-recovery-failover.md#run-a-test-failover).


Также необходимо настроить инфраструктуру так, чтобы реплицируемая виртуальная машина работала должным образом. Допустим, виртуальная машина с контроллером домена и DNS может быть реплицирована в Azure с помощью Azure Site Recovery и создана в тестовой сети с помощью тестовой отработки отказа. Дополнительные сведения см. в разделе [Рекомендации по отработке отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).

Для запуска тестовой отработки отказа выполните следующие действия.

1. На вкладке **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.
2. На **странице подтверждения тестовой отработки отказа** выберите **Нет** или конкретную сеть Azure. Учтите, что при выборе варианта "Нет" в ходе тестовой отработки отказа будет проверяться правильность репликации виртуальной машины в Azure, но не конфигурация сети репликации.

	![Нет сети](./media/site-recovery-vmm-to-azure/test-no-network.png)

3. Если для облака включено шифрование данных, выберите в поле **Ключ шифрования** сертификат, который был выдан в ходе установки поставщика на сервере VMM при включении шифрования данных для облака.
4. На вкладке **Задания** можно отследить ход выполнения отработки отказа. Кроме того, вы можете просмотреть тестовую реплику виртуальной машины на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
5. После того как отработка отказа достигнет фазы **Полное тестирование**, нажмите **Завершить тестирование**, чтобы закончить действие. Вы можете перейти на вкладку **Задания**, чтобы отслеживать ход выполнения отработки отказа и изменение ее состояния, а также выполнять прочие необходимые действия.
6. После отработки отказа тестовая реплика виртуальной машины будет отображаться на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине. Выполните следующее:

    1. Проверьте, успешно ли выполнен запуск виртуальных машин.
    2. При необходимости подключиться к виртуальной машине в Azure с использованием удаленного рабочего стола после отработки отказа, включите подключение удаленного рабочего стола на виртуальной машине до запуска тестирования отработки отказа. Кроме того, на виртуальной машине нужно добавить конечную точку RDP. Для этого можно использовать модули [Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).
    3. После отработки отказа, если вы используете общедоступный IP-адрес для подключения к виртуальной машине в Azure с помощью удаленного рабочего стола, убедитесь, что у вас нет политик доменов, которые препятствуют подключению к виртуальной машине с помощью общедоступного адреса.

7.  После завершения тестирования выполните следующие действия:
	- Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовые виртуальные машины.
	- Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.

## Дальнейшие действия

Узнайте больше о [настройке планов восстановления](site-recovery-create-recovery-plans.md) и [отработке отказа](site-recovery-failover.md).

<!---HONumber=AcomDC_0316_2016-->