---
title: "Поддержка мультитенантности для репликации виртуальных машин VMware в Azure (программа CSP) | Документация Майкрософт"
description: "Сведения о развертывании службы Azure Site Recovery в среде с несколькими клиентами для управления репликацией, отработкой отказа и восстановлением локальных виртуальных машин VMware в Azure с помощью программы CSP на портале Azure."
services: site-recovery
documentationcenter: 
author: mayanknayar
manager: jwhit
editor: 
ms.assetid: 
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/06/2016
ms.author: manayar
translationtype: Human Translation
ms.sourcegitcommit: 3b606aa6dc3b84ed80cd3cc5452bbe1da6c79a8b
ms.openlocfilehash: ed484afc59bbf48490e3ff4389e8e28c71a5e471


---
# <a name="multi-tenant-support-in-azure-site-recovery-for-replicating-vmware-virtual-machines-to-azure-through-the-csp-program"></a>Поддержка нескольких клиентов в Azure Site Recovery для репликации виртуальных машин VMware в Azure с помощью программы CSP

В службе Azure Site Recovery реализована поддержка сред с несколькими клиентами (мультитенантность) для подписок клиентов. Эта поддержка также реализована в подписках клиентов, созданных и управляемых с помощью программы CSP. В этой статье приведены рекомендации по реализации сценариев репликации виртуальных машин VMware в Azure с поддержкой нескольких сред и управлению ими. Кроме того, здесь представлены сведения о создании подписок клиентов и управлении ими с помощью CSP.

Обратите внимание, что в этом руководстве широко используются сведения из других материалов по репликации виртуальных машин VMware в Azure. При работе с ним используйте также [эту статью](site-recovery-vmware-to-azure.md).

## <a name="multi-tenant-environments"></a>Среды с несколькими клиентами
Доступны три основные мультитенантные модели.

1.    **Поставщик общих услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, и для размещения виртуальных машин нескольких клиентов в одной инфраструктуре используются общие ресурсы (vCenter, центры обработки данных, физическое хранилище и т. д.). Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение для самостоятельного аварийного восстановления.
2.    **Поставщик выделенных услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, но для размещения виртуальных машин каждого клиента в одной инфраструктуре используются выделенные ресурсы (несколько серверов vCenter, физические хранилища и т. д.). Управление аварийным восстановлением опять-таки осуществляется партнером или клиентом самостоятельно.
3.    **Поставщик управляемых служб.** В этом случае физическая инфраструктура, в которой размещены виртуальные машины, принадлежит заказчику, а партнеры предоставляют поддержку аварийного восстановления и средства управления им.

## <a name="shared-hosting-multi-tenant-guidance"></a>Руководство по совместному размещению нескольких клиентов
В этом разделе подробно рассматривается сценарий совместного размещения. Кроме того, здесь описываются еще два сценария, которые являются разновидностями сценария совместного размещения и используют те же принципы. Разница между ними описана в конце этого раздела.

Основное требование в сценариях с несколькими клиентами заключается в изоляции разных клиентов (т. е. на одном клиенте нельзя просматривать ресурсы, размещенные на другом). В полностью управляемой партнером среде это не так важно. Однако в среде с самостоятельным обслуживанием это может играть решающую роль. В рамках этого руководства изоляция клиента обязательна.

Архитектура выглядит следующим образом:

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/shared-hosting-scenario.png)

**Рис. 1. Сценарий совместного размещения с одним сервером vCenter**

Как видно на рисунке выше, каждый заказчик будет иметь отдельный сервер управления. Это позволяет ограничить доступ клиента к виртуальным машинам определенного клиента (т. е. позволяет изолировать клиент). В сценарии репликации виртуальных машин VMware используется сервер конфигурации. Он обеспечивает управление учетными записями для обнаружения виртуальных машин и установки агентов. Те же самые принципы используются и в средах с несколькими клиентами, в которых за счет контроля доступа vCenter также применяются дополнительные ограничения обнаружения виртуальных машин.

В соответствии с требованиями к изоляции данных все конфиденциальные данные инфраструктуры (например, учетные данные для доступа) должны быть доступными из клиентов. По этой причине мы советуем оставить все компоненты сервера управления (сервер конфигурации, сервер обработки и главный целевой сервер) полностью под управлением партнера. Это относится и к серверу обработки масштабирования.

### <a name="every-cs-under-the-multi-tenant-scenario-uses-two-accounts"></a>Каждый сервер конфигурации в рамках этого сценария использует две учетные записи:

- **Учетная запись для доступа к vCenter.** Эта учетная запись используется для обнаружения виртуальных машин клиента. Ей назначены права доступа к vCenter (см. следующий раздел). Мы советуем, чтобы партнер самостоятельно вводил эти учетные данные в средстве настройки. Это позволит избежать случайных утечек данных при доступе.
- **Учетная запись для доступа к виртуальной машине.** Эта учетная запись используется для принудительной установки агента мобильности на виртуальных машинах клиента. Обычно это учетная запись домена, предоставленная клиентом для партнера или управляемая непосредственно партнером. Если клиент не предоставляет сведения партнеру напрямую, ему можно предоставить временный доступ к серверу конфигурации. Кроме того, клиент может установить агенты мобильности вручную при помощи партнера.

### <a name="requirements-for-vcenter-access-account"></a>Требования к учетной записи для доступа к vCenter

Как описано в предыдущем разделе, для настройки сервера конфигурации используется учетная запись, которой назначена определенная роль. Важно отметить, что эту роль следует назначить учетной записи, используемой для доступа к vCenter, для каждого объекта vCenter. Она не должна распространяться на дочерние объекты. Это позволяет обеспечить изоляцию клиента, так как при синхронизации доступа можно также получить доступ к другим объектам.

![permissions-without-propagation](./media/site-recovery-multi-tenant-support-vmware-using-csp/assign-permissions-without-propagation.png)

Кроме того, вы можете назначить учетную запись и роль пользователя в объекте центра обработки данных и распространить ее на дочерние объекты. В результате этой учетной записи будет назначена роль "Без доступа" для каждого объекта (например, для виртуальных машин других клиентов), к которому должен быть ограничен доступ от определенного клиента. Этот подход весьма трудоемкий. Он не обеспечивает полный контроль доступа, так как каждый созданный дочерний объект автоматически наследует права доступа родительского объекта. Поэтому мы советуем использовать первый подход.

Процедура предоставления доступа к учетной записи vCenter состоит из следующих этапов:

1.    Создайте роль путем клонирования предварительно определенной роли с доступом только для чтения и назначьте ей удобное имя (Azure_Site_Recovery в этом примере).
2.    Назначьте этой роли следующие разрешения:
 *    Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины
 *    Сеть -> Назначение сети
 *    Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины
 *    Задачи -> Создание задач, Обновление задач
 *    Виртуальная машина -> конфигурация
 *    виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware;
 *    Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации
 *    Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины
 *    виртуальная машина -> моментальные снимки -> удаление моментальных снимков.

    ![role-permissions](./media/site-recovery-multi-tenant-support-vmware-using-csp/edit-role-permissions.png)

3.    Назначьте уровень доступа к учетной записи vCenter (используемой на сервере конфигурации клиента) для разных объектов, как описано в таблице ниже.

| **Объект** | **Роль** | **Примечания.** |
| --- | --- | --- |
| vCenter | Только для чтения | Эта роль используется, только чтобы предоставить vCenter доступ для управления разными объектами. Если эту учетную запись не планируют предоставлять клиенту или использовать для любых операций управления на сервере vCenter, это разрешение можно удалить. |
| Центр обработки данных | Azure_Site_Recovery |  |
| Узел и кластер узлов | Azure_Site_Recovery | Предоставьте доступ на уровне объектов, чтобы перед отработкой отказа и после восстановления размещения виртуальные машины клиента имели доступ только к этим узлам. |
| Хранилище данных и кластер хранилища данных | Azure_Site_Recovery | То же, что и выше |
| Сеть | Azure_Site_Recovery |  |
| Сервер управления | Azure_Site_Recovery | Предоставляет доступ ко всем компонентам (сервер конфигурации, сервер обработки и главный целевой сервер), которые находятся за пределами компьютера сервера конфигурации. |
| Виртуальные машины клиента | Azure_Site_Recovery | Предоставьте эти разрешения на доступ всем новым виртуальным машинам определенного клиента. В противном случае их нельзя будет обнаружить с помощью портала Azure. |

Теперь настройка доступа для учетной записи vCenter завершена. Это минимальное требование для выполнения операций восстановления размещения. Обратите внимание, что эти разрешения на доступ также можно использовать с имеющимися политиками. Просто измените свои разрешения, добавив к ним разрешения роли из пункта 2, описанного выше.

Чтобы ограничить операции аварийного восстановления до выполнения отработки отказа (т. е отключить возможности восстановления размещения), выполните описанные выше действия, но вместо роли Azure_Site_Recovery назначьте учетной записи, используемой для доступа к vCenter, роль "Только для чтения". Этот набор разрешений позволяет выполнить репликацию и отработку отказа виртуальных машин, но не допускает восстановление размещения. Обратите внимание, что все остальное в описанном выше процессе остается без изменений. Каждое разрешение должно по-прежнему быть назначено только на уровне объектов и не распространяться на дочерние объекты. Это позволяет обеспечить изоляцию клиента и ограничить обнаружение виртуальных машин.

## <a name="other-multi-tenant-environments"></a>Другие среды с несколькими клиентами

В разделе выше подробно описан процесс настройки среды с несколькими клиентами для решения совместного размещения. Два оставшихся решения — это решения для выделенного размещения и управляемой службы. Ниже показана архитектура этих решений.

### <a name="dedicated-hosting-solution"></a>Решение для выделенного размещения

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/dedicated-hosting-scenario.png)

**Рис. 2. Сценарий выделенного размещения с несколькими серверами vCenter**

Здесь разница в архитектуре заключается в том, что инфраструктура клиента подготавливается только для этого клиента. Поставщик услуг размещения по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов, так как они изолированы благодаря отдельным серверам vCenter. Подготовка программы CSP остается без изменений.

### <a name="managed-service-solution"></a>Решение для управляемой службы

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/managed-service-scenario.png)

**Рис. 3. Сценарий для управляемой службы с несколькими серверами vCenter**

Здесь разница в архитектуре заключается в том, что каждая инфраструктура клиента также физически отделена от других клиентов. Этот сценарий обычно возникает, когда клиент владеет инфраструктурой и ему нужен поставщик решений только для управления аварийным восстановлением. Партнер по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов, так как они физически изолированы благодаря разным инфраструктурам. Подготовка программы CSP остается без изменений.


## <a name="csp-program-overview"></a>Общие сведения о программе CSP
[Программа](https://partner.microsoft.com/en-US/cloud-solution-provider) Cloud Solution Provider (CSP) позволяет улучшить взаимодействие с партнерами для предоставления всех облачных служб Майкрософт, в том числе O365, EMS и Microsoft Azure. Она предоставляет нашим партнерам возможность контролировать все отношения с клиентами и стать точкой контакта для основных отношений. С помощью CSP партнеры могут развертывать подписки Azure для клиентов и объединять их с собственными дополнительными настраиваемыми предложениями.

В случае с Azure Site Recovery партнеры могут управлять готовым решением аварийного восстановления для клиентов непосредственно через CSP или использовать эту программу для настройки среды Azure Site Recovery и предоставления клиентам возможности самостоятельно управлять параметрами аварийного восстановления. В обоих случаях партнер выступает звеном между Azure Site Recovery и конечными потребителями, а также предоставляет клиентам поддержку и услуги по выставлению счетов за использование Azure Site Recovery.

## <a name="creating-and-managing-tenant-accounts"></a>Создание учетных записей клиента и управление ими

### <a name="step-0-prerequisite-check"></a>Этап 0. Проверка предварительных требований

Предварительные требования к виртуальным машинам аналогичны приведенным в [документации](site-recovery-vmware-to-azure.md) по Azure Site Recovery. Кроме того, перед выполнением дальнейших действий по управлению клиентом с помощью CSP вам потребуется обеспечить контроль доступа. Создайте отдельный сервер управления для каждого клиента, который может взаимодействовать с виртуальными машинами клиентов и сервером vCenter партнера. Только партнер должен иметь права доступа к этому серверу.

### <a name="step-1-create-tenant-account"></a>Этап 1. Создание учетной записи клиента

1.    Через [Центр партнеров](https://partnercenter.microsoft.com/) войдите в свою учетную запись CSP. В меню панели мониторинга слева выберите параметр Customers (Клиенты).

    ![csp-dashboard](./media/site-recovery-multi-tenant-support-vmware-using-csp/csp-dashboard-display.png)

2.    На открывшейся странице нажмите кнопку Add customer (Добавить клиента).

    ![add-customer](./media/site-recovery-multi-tenant-support-vmware-using-csp/add-new-customer.png)

3.    На странице New Customer (Новый клиент) введите все сведения об учетной записи для клиента и нажмите кнопку Next:Subscriptions (Далее: подписки).

    ![fill-details](./media/site-recovery-multi-tenant-support-vmware-using-csp/customer-add-filled.png)

4.    На странице выбора подписок прокрутите вниз до подписки Microsoft Azure и добавьте ее. Другие подписки можно добавить либо сейчас, либо в любое другое время.

    ![add-subscription](./media/site-recovery-multi-tenant-support-vmware-using-csp/azure-subscription-selection.png)

5.    Продолжим. На следующей странице просмотрите все сведения, введенные для клиента, и нажмите кнопку Submit (Отправить).

    ![customer-summary](./media/site-recovery-multi-tenant-support-vmware-using-csp/customer-summary-page.png)

6.    После создания клиента откроется страница подтверждения с учетной записью и паролем по умолчанию для этой подписки. Сохраните эти данные и при необходимости измените пароль. Это можно сделать на портале Azure. Эти сведения можно предоставить клиенту без изменений. При необходимости можно создать и предоставить отдельную учетную запись.

### <a name="step-2-access-tenant-account"></a>Этап 2. Получение доступа к учетной записи клиента

1.    Доступ к подписке клиента можно получить на странице Customers (Клиенты) панели мониторинга, как описано на этапе 1. Перейдите на эту страницу и щелкните имя созданной учетной записи клиента.
2.    Откроется раздел Subscriptions (Подписки) учетной записи клиента. Здесь вы можете просмотреть имеющиеся подписки для этой учетной записи и при необходимости добавить дополнительные. Для управления операциями аварийного восстановления клиента выберите параметр All resources (Azure portal) (Все ресурсы (портал Azure)) в правой части страницы.

    ![all-resources](./media/site-recovery-multi-tenant-support-vmware-using-csp/all-resources-select.png)

3.    Нажмите кнопку All resources (Все ресурсы), чтобы получить доступ к подпискам Azure клиента. Это можно также сделать, проверив отобразившиеся параметры AAD в правом верхнем углу портала Azure.

    ![aad-admin](./media/site-recovery-multi-tenant-support-vmware-using-csp/aad-admin-display.png)

Теперь вы можете выполнять все операции Site Recovery для клиента на портале Azure и управлять операциями аварийного восстановления. Действия, описанные выше, необходимо выполнять при каждом доступе к подпискам клиента с помощью CSP для управления аварийным восстановлением.

### <a name="step-3-deploy-resources-to-tenant-subscription"></a>Этап 3. Развертывание ресурсов в подписку клиента
1.    На портале Azure создайте группу ресурсов и разверните хранилище служб восстановления для обычного процесса. Скачайте ключ регистрации хранилища.
2.    Зарегистрируйте сервер конфигурации для клиента, используя ключ регистрации хранилища.
3.    Введите учетные данные учетных записей доступа к vCenter и виртуальной машине.

    ![config-accounts](./media/site-recovery-multi-tenant-support-vmware-using-csp/config-server-account-display.png)

### <a name="step-4-register-site-recovery-infrastructure-to-recovery-services-vault"></a>Этап 4. Регистрация инфраструктуры Site Recovery в хранилище служб восстановления
1.    Откройте портал Azure и зарегистрируйте в созданном ранее хранилище сервер vCenter для сервера конфигурации, зарегистрированного на предыдущем этапе. Для этой цели используйте учетную запись для доступа к vCenter.
2.    Завершите подготовку инфраструктуры для Site Recovery.
3.    Теперь виртуальные машины подготовлены к репликации. Щелкните параметр "Репликация". В колонке выбора виртуальной машины должны отображаться только виртуальные машины клиента.

    ![tenant-vms](./media/site-recovery-multi-tenant-support-vmware-using-csp/tenant-vm-display.png)

### <a name="step-5-assign-tenant-access-to-subscription"></a>Этап 5. Назначение доступа клиента к подписке

При выполнении аварийного восстановления самостоятельно клиенту необходимо предоставить сведения об учетной записи, как упоминалось на этапе 1. Это следует сделать после того, как партнер настроит инфраструктуру аварийного восстановления. Независимо от типа аварийного восстановления (управляемое или в режиме самообслуживания) партнер должен получить доступ к подпискам клиента только через портал CSP, настроить хранилище и зарегистрировать принадлежащую ему инфраструктуру для подписок клиента.

На портале CSP партнер также может добавить нового пользователя к подписке клиента. Это можно сделать следующим образом:

1.    Перейдите на страницу подписок CSP для определенного клиента и выберите параметр Users and licenses (Пользователи и лицензии).

    ![user-licenses](./media/site-recovery-multi-tenant-support-vmware-using-csp/users-and-licences.png)

    Затем создайте пользователя, предоставив соответствующие данные и выбрав необходимые разрешения или загрузив список пользователей в виде CSV-файла.
2.    После создания пользователей вернитесь на портал Azure и в колонке "Подписки" выберите соответствующую подписку.
3.    В открывшейся колонке выберите "Управление доступом (IAM)" и щелкните "+ Добавить", чтобы добавить пользователя с соответствующим уровнем доступа. После выбора уровня доступа откроется колонка с пользователями, созданными на портале CSP.

    ![user-subscription](./media/site-recovery-multi-tenant-support-vmware-using-csp/add-user-subscription.png)

    Для большинства операций управления подойдет роль "Участник". Пользователь с этим уровнем доступа может выполнять практически все действия, кроме изменения уровня доступа (для этого требуется уровень доступа "Владелец"). При необходимости уровни доступа можно настраивать.



<!--HONumber=Feb17_HO3-->


