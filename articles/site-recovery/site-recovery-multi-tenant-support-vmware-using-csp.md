---
title: "Поддержка мультитенантности для репликации виртуальных машин VMware в Azure (программа CSP) | Документация Майкрософт"
description: "Сведения о развертывании службы Azure Site Recovery в среде с несколькими клиентами для управления репликацией, отработкой отказа и восстановлением локальных виртуальных машин VMware в Azure с помощью программы CSP на портале Azure."
services: site-recovery
documentationcenter: 
author: mayanknayar
manager: rochakm
editor: 
ms.assetid: 
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: manayar
ms.translationtype: Human Translation
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.openlocfilehash: 97edbe67c25036dc1156f0f0ca5431a617d7a004
ms.contentlocale: ru-ru
ms.lasthandoff: 07/08/2017


---
# <a name="multi-tenant-support-in-azure-site-recovery-for-replicating-vmware-virtual-machines-to-azure-through-csp"></a>Поддержка нескольких клиентов в Azure Site Recovery для репликации виртуальных машин VMware в Azure с помощью CSP

В службе Azure Site Recovery реализована поддержка сред с несколькими клиентами (мультитенантность) для подписок клиентов. Такие среды также поддерживаются для подписок клиентов, созданных и управляемых с помощью программы поставщика облачных решений Майкрософт (CSP). В этой статье приведены рекомендации по реализации сценариев репликации виртуальных машин VMware в Azure с поддержкой нескольких сред и управлению ими. Кроме того, здесь представлены сведения о создании подписок клиентов и управлении ими с помощью CSP.

В этом руководстве широко используются сведения из других материалов по репликации виртуальных машин VMware в Azure. Дополнительные сведения см. в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](site-recovery-vmware-to-azure.md).

## <a name="multi-tenant-environments"></a>Среды с несколькими клиентами
Доступны три основные мультитенантные модели.

* **Поставщик общих услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, и для размещения виртуальных машин нескольких клиентов в одной инфраструктуре используются общие ресурсы (vCenter, центры обработки данных, физическое хранилище и т. д.). Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Поставщик выделенных услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, но для размещения виртуальных машин каждого клиента в одной инфраструктуре используются выделенные ресурсы (несколько серверов vCenter, физические хранилища и т. д.). Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Поставщик управляемых служб.** В этом случае физическая инфраструктура, в которой размещены виртуальные машины, принадлежит заказчику, а партнеры предоставляют поддержку аварийного восстановления и средства управления им.

## <a name="shared-hosting-multi-tenant-guidance"></a>Руководство по совместному размещению нескольких клиентов
В этом разделе подробно рассматривается сценарий совместного размещения. Кроме того, здесь описываются еще два сценария, которые являются разновидностями сценария совместного размещения и используют те же принципы. Разница между ними описана в конце этого раздела.

Основное требование в сценариях с несколькими клиентами заключается в изоляции разных клиентов. На одном клиенте нельзя просматривать ресурсы, размещенные на другом. В управляемой партнером среде это не так важно. Однако в среде с самостоятельным обслуживанием это может играть решающую роль. В рамках этого руководства изоляция клиента обязательна.

Такая архитектура показана на схеме ниже.

![Поставщик общих услуг размещения с одним сервером vCenter](./media/site-recovery-multi-tenant-support-vmware-using-csp/shared-hosting-scenario.png)  
**Сценарий совместного размещения с одним сервером vCenter**

Как показано на предыдущей схеме, каждый клиент будет иметь отдельный сервер управления. Такая конфигурация ограничивает доступ клиента к виртуальным машинам определенного клиента и позволяет изолировать клиент. В сценарии репликации виртуальных машин VMware используется сервер конфигурации. Он обеспечивает управление учетными записями для обнаружения виртуальных машин и установки агентов. Те же самые принципы используются и в средах с несколькими клиентами, в которых за счет контроля доступа vCenter также применяются дополнительные ограничения обнаружения виртуальных машин.

В соответствии с требованиями к изоляции данных все конфиденциальные данные инфраструктуры (например, учетные данные для доступа) должны быть недоступными для клиентов. По этой причине мы советуем, чтобы все компоненты сервера управления находились полностью под управлением партнера. Ниже приведены компоненты сервера управления.
* Сервер конфигурации
* Сервер обработки
* Главный целевой сервер 

Сервер обработки масштабирования также должен управляться партнером.

### <a name="every-cs-in-the-multi-tenant-scenario-uses-two-accounts"></a>Каждый сервер конфигурации в рамках этого сценария использует две учетные записи:

- **Учетная запись для доступа к vCenter.** Эта учетная запись используется для обнаружения виртуальных машин клиента. Ей назначены права доступа к vCenter (см. следующий раздел). Мы советуем, чтобы партнер самостоятельно вводил эти учетные данные в средстве настройки во избежание случайных утечек данных при доступе.

- **Учетная запись для доступа к виртуальной машине.** Эта учетная запись используется для принудительной установки агента мобильности на виртуальных машинах клиента. Обычно это учетная запись домена, предоставленная клиентом для партнера или управляемая непосредственно партнером. Если клиент не желает предоставлять сведения партнеру напрямую, ему можно предоставить временный доступ к серверу конфигурации для ввода учетных данных. Кроме того, клиент может установить агенты мобильности вручную при помощи партнера.

### <a name="requirements-for-a-vcenter-access-account"></a>Требования к учетной записи для доступа к vCenter

Как описано в предыдущем разделе, для настройки сервера конфигурации используется учетная запись, которой назначена определенная роль. Эту роль следует назначить учетной записи, используемой для доступа к vCenter, для каждого объекта vCenter. Она не должна распространяться на дочерние объекты. Такая конфигурация обеспечивает изоляцию клиента, так как при синхронизации доступа можно получить доступ к другим объектам.

![Параметр распространения на дочерние объекты](./media/site-recovery-multi-tenant-support-vmware-using-csp/assign-permissions-without-propagation.png)

Кроме того, вы можете назначить учетную запись и роль в объекте центра обработки данных и распространить ее на дочерние объекты. Затем назначьте этой учетной записи роль *Без доступа* для каждого объекта (например, для виртуальных машин других клиентов), к которому должен быть ограничен доступ от определенного клиента. Такая конфигурация весьма сложная. Она не обеспечивает полный контроль доступа, так как каждый дочерний объект автоматически наследует права доступа родительского объекта. Поэтому рекомендуется использовать первый подход.

Процедура предоставления доступа к учетной записи vCenter состоит из следующих этапов:

1. Создайте роль путем клонирования предварительно определенной роли с доступом *Только для чтения* и назначьте ей удобное имя (Azure_Site_Recovery в этом примере).

2. Назначьте этой роли следующие разрешения:

    * **Хранилище данных**: выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины.

    * **Сеть**: назначение сети.

    * **Ресурс**: назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины.

    * **Задачи**: создание задач, обновление задач.

    * **Виртуальная машина**: 
        * настройка > все;
        * взаимодействие > ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware;
        * инвентаризация > создание на основе существующего, создание, регистрация, отмена регистрации;
        * подготовка > разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины;
        * управление моментальными снимками > удаление моментальных снимков.

    ![Диалоговое окно "Изменение ролей"](./media/site-recovery-multi-tenant-support-vmware-using-csp/edit-role-permissions.png)

3. Назначьте уровень доступа к учетной записи vCenter (используемой на сервере конфигурации клиента) для различных объектов, как описано в таблице ниже.

>| Объект | Роль | Примечания |
>| --- | --- | --- |
>| vCenter | Только для чтения | Эта роль используется, только чтобы предоставить vCenter доступ для управления разными объектами. Если эту учетную запись не планируют предоставлять клиенту или использовать для любых операций управления на сервере vCenter, это разрешение можно удалить. |
>| Центр обработки данных | Azure_Site_Recovery |  |
>| Узел и кластер узлов | Azure_Site_Recovery | Предоставляет доступ на уровне объектов, чтобы перед отработкой отказа и после восстановления размещения виртуальные машины клиента имели доступ только к этим узлам. |
>| Хранилище данных и кластер хранилища данных | Azure_Site_Recovery | То же, что и выше. |
>| Сеть | Azure_Site_Recovery |  |
>| Сервер управления | Azure_Site_Recovery | Предоставляет доступ ко всем компонентам (сервер конфигурации, сервер обработки и главный целевой сервер), которые находятся за пределами компьютера сервера конфигурации. |
>| Виртуальные машины клиента | Azure_Site_Recovery | Предоставляет эти разрешения на доступ всем новым виртуальным машинам определенного клиента. В противном случае их нельзя будет обнаружить с помощью портала Azure. |

Теперь настройка доступа для учетной записи vCenter завершена. Это минимальное требование для выполнения операций восстановления размещения. Эти разрешения на доступ также можно использовать с имеющимися политиками. Просто измените свои разрешения, добавив к ним разрешения роли из шага 2, описанного выше.

Чтобы ограничить операции аварийного восстановления до выполнения отработки отказа (т. е отключить возможности восстановления размещения), выполните описанные выше действия, но вместо роли *Azure_Site_Recovery* назначьте учетной записи, используемой для доступа к vCenter, роль *Только для чтения*. Этот набор разрешений позволяет выполнить репликацию и отработку отказа виртуальных машин, но не допускает восстановление размещения. Все остальное в описанном ранее процессе остается без изменений. Чтобы изолировать клиент и ограничить обнаружение виртуальных машин, каждое разрешение должно по-прежнему быть назначено только на уровне объектов и не распространяться на дочерние объекты.

## <a name="other-multi-tenant-environments"></a>Другие среды с несколькими клиентами

В разделе выше подробно описан процесс настройки среды с несколькими клиентами для решения совместного размещения. Два оставшихся решения — это решения для выделенного размещения и управляемой службы. В следующих разделах описывается архитектура этих решений.

### <a name="dedicated-hosting-solution"></a>Решение для выделенного размещения

Как показано на следующей схеме, разница в архитектуре решения для выделенного размещения заключается в том, что инфраструктура клиента подготавливается только для этого клиента. Поставщик услуг размещения по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов, так как они изолированы благодаря отдельным серверам vCenter. Настройка программы CSP остается без изменений.

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/dedicated-hosting-scenario.png)  
**Сценарий выделенного размещения с несколькими серверами vCenter**

### <a name="managed-service-solution"></a>Решение для управляемой службы

Как показано на следующей схеме, разница в архитектуре решения для управляемой службы заключается в том, что инфраструктура каждого клиента также физически отделена от других клиентов. Этот сценарий обычно возникает, когда клиент владеет инфраструктурой и ему нужен поставщик решений только для управления аварийным восстановлением. Так как клиенты физически изолированы благодаря разным инфраструктурам, партнер по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов. Подготовка программы CSP остается без изменений.

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/managed-service-scenario.png)  
**Сценарий для управляемой службы с несколькими серверами vCenter**

## <a name="csp-program-overview"></a>Общие сведения о программе CSP
[Программа CSP](https://partner.microsoft.com/en-US/cloud-solution-provider) позволяет улучшить взаимодействие с партнерами для предоставления всех облачных служб Майкрософт, в том числе Office 365, EMS и Microsoft Azure. С ее помощью наши партнеры могут контролировать все отношения с клиентами и стать точкой контакта для основных отношений. Также партнеры могут развертывать подписки Azure для клиентов и объединять их с собственными дополнительными настраиваемыми предложениями.

С помощью Azure Site Recovery партнеры могут управлять готовым решением аварийного восстановления для клиентов непосредственно через CSP. Или они могут использовать эту программу для настройки среды Azure Site Recovery и предоставления клиентам возможности самостоятельно управлять параметрами аварийного восстановления. В обоих случаях партнер выступает звеном между Site Recovery и конечными потребителями. Партнер также предоставляет клиентам поддержку и услуги по выставлению счетов за использование Site Recovery.

## <a name="create-and-manage-tenant-accounts"></a>Создание учетных записей клиента и управление ими

### <a name="step-0-prerequisite-check"></a>Этап 0. Проверка предварительных требований

Предварительные требования к виртуальным машинам аналогичны приведенным в [документации по Azure Site Recovery](site-recovery-vmware-to-azure.md). Кроме того, перед выполнением дальнейших действий по управлению клиентом с помощью CSP вам потребуется обеспечить контроль доступа, указанный выше. Создайте отдельный сервер управления для каждого клиента, который может взаимодействовать с виртуальными машинами клиентов и сервером vCenter партнера. Только партнер должен иметь права доступа к этому серверу.

### <a name="step-1-create-a-tenant-account"></a>Этап 1. Создание учетной записи клиента

1. Через [Центр партнеров Майкрософт](https://partnercenter.microsoft.com/) войдите в свою учетную запись CSP. 
 
2. В меню **Панель мониторинга** выберите **Клиенты**.

    ![Ссылка "Клиенты" в Центре партнеров Майкрософт](./media/site-recovery-multi-tenant-support-vmware-using-csp/csp-dashboard-display.png)

3. На открывшейся странице нажмите кнопку **Add customer** (Добавить клиента).

    ![Кнопка Add Customer (Добавить клиента)](./media/site-recovery-multi-tenant-support-vmware-using-csp/add-new-customer.png)

4. На странице **New Customer** (Новый клиент) введите все сведения об учетной записи для клиента и нажмите кнопку **Next: Subscriptions** (Далее: подписки).

    ![Страница сведений об учетной записи](./media/site-recovery-multi-tenant-support-vmware-using-csp/customer-add-filled.png)

5. На странице выбора подписок установите флажок напротив пункта **Microsoft Azure**. Вы можете добавить другие подписки сейчас или в любое другое время.

    ![флажок для выбора подписки Microsoft Azure](./media/site-recovery-multi-tenant-support-vmware-using-csp/azure-subscription-selection.png)

6. На странице**Обзор** проверьте введенные данные клиента и нажмите кнопку **Отправить**.

    ![Страница "Обзор"](./media/site-recovery-multi-tenant-support-vmware-using-csp/customer-summary-page.png)  

    После создания учетной записи клиента откроется страница подтверждения со сведениями об учетной записи и паролем по умолчанию для этой подписки. 

7. Сохраните эти данные и при необходимости измените пароль. Это можно сделать на странице входа на портале Azure.  
 
    Можно предоставить клиенту эти сведения без изменений или создать и предоставить отдельную учетную запись.

### <a name="step-2-access-the-tenant-account"></a>Этап 2. Получение доступа к учетной записи клиента

Доступ к подписке клиента можно получить с помощью панели мониторинга Центра партнеров Майкрософт, как описано в разделе "Этап 1. Создание учетной записи клиента". 

1. Перейдите на страницу **Клиенты** и щелкните имя созданной учетной записи клиента.

2. На странице **Подписки** учетной записи клиента можно просмотреть имеющиеся подписки для этой учетной записи и при необходимости добавить дополнительные. Для управления операциями аварийного восстановления клиента, выберите параметр **Все ресурсы** (портал Azure).

    ![Ссылка "Все ресурсы"](./media/site-recovery-multi-tenant-support-vmware-using-csp/all-resources-select.png)  
    
    Щелкните **Все ресурсы**, чтобы получить доступ к подпискам Azure клиента. Это можно также сделать, щелкнув ссылку Azure Active Directory в правом верхнем углу портала Azure.

    ![Ссылка Azure Active Directory](./media/site-recovery-multi-tenant-support-vmware-using-csp/aad-admin-display.png)

Теперь вы можете выполнять все операции Site Recovery для клиента на портале Azure и управлять операциями аварийного восстановления. Чтобы получить доступ к подписке клиента с помощью CSP для управления аварийным восстановлением, выполните действия, описанные выше.

### <a name="step-3-deploy-resources-to-the-tenant-subscription"></a>Этап 3. Развертывание ресурсов в подписку клиента
1. На портале Azure создайте группу ресурсов и разверните хранилище служб восстановления для обычного процесса. 
 
2. Скачайте ключ регистрации хранилища.

3. Зарегистрируйте сервер конфигурации для клиента, используя ключ регистрации хранилища.

4. Введите учетные данные учетных записей доступа к vCenter и виртуальной машине.

    ![Управление учетными записями сервера конфигурации](./media/site-recovery-multi-tenant-support-vmware-using-csp/config-server-account-display.png)

### <a name="step-4-register-site-recovery-infrastructure-to-the-recovery-services-vault"></a>Этап 4. Регистрация инфраструктуры Site Recovery в хранилище служб восстановления
1. Откройте портал Azure и зарегистрируйте в созданном ранее хранилище сервер vCenter для сервера конфигурации, зарегистрированного на этапе 3 "Развертывание ресурсов в подписку клиента". Для этой цели используйте учетную запись для доступа к vCenter.
2. Завершите подготовку инфраструктуры для Site Recovery.
3. Теперь виртуальные машины подготовлены к репликации. Щелкните параметр **Репликация** и убедитесь, что в колонке **Выбор виртуальных машин** отображаются только виртуальные машины клиента.

    ![Список виртуальных машин клиента в колонке "Выбор виртуальных машин"](./media/site-recovery-multi-tenant-support-vmware-using-csp/tenant-vm-display.png)

### <a name="step-5-assign-tenant-access-to-the-subscription"></a>Этап 5. Назначение доступа клиента к подписке

При выполнении аварийного восстановления самостоятельно клиенту необходимо предоставить сведения об учетной записи, как упоминалось на этапе 1 "Создание учетной записи клиента". Это следует сделать после того, как партнер настроит инфраструктуру аварийного восстановления. Независимо от типа аварийного восстановления (управляемое или в режиме самообслуживания) партнер должен получать доступ к подпискам клиента только через портал CSP. Также партнер должен настроить хранилище и зарегистрировать инфраструктуру для подписок клиента.

На портале CSP партнер также может добавить нового пользователя к подписке клиента. Это можно сделать следующим образом:

1. Перейдите на страницу подписок CSP для клиента и выберите параметр **Users and licenses** (Пользователи и лицензии).

    ![Страница подписок CSP для клиента](./media/site-recovery-multi-tenant-support-vmware-using-csp/users-and-licences.png)

    Затем создайте пользователя, предоставив соответствующие данные и выбрав необходимые разрешения или передав список пользователей в виде CSV-файла.

2. После создания нового пользователя вернитесь на портал Azure и в колонке **Подписки** выберите соответствующую подписку.

3. В открывшейся колонке выберите **Управление доступом (IAM)** и щелкните **Добавить**, чтобы добавить пользователя с соответствующим уровнем доступа.      
    После выбора уровня доступа откроется колонка с пользователями, созданными на портале CSP.

    ![Добавление пользователей](./media/site-recovery-multi-tenant-support-vmware-using-csp/add-user-subscription.png)

    Для большинства операций управления подойдет роль *Участник*. Пользователи с этим уровнем доступа могут выполнять практически все действия, кроме изменения уровня доступа (для этого требуется уровень доступа *Владелец*). При необходимости уровни доступа можно настраивать.

