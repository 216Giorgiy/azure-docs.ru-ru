---
title: "Репликация Hyper-V с использованием Azure Site Recovery | Документация Майкрософт"
description: "Эта статья поможет изучить технические концепции, которые позволят успешно устанавливать и настраивать службу Azure Site Recovery, а также управлять ею."
services: site-recovery
documentationcenter: 
author: Rajani-Janaki-Ram
manager: mkjain
editor: 
ms.assetid: 97916915-1379-47df-8369-12ddf022c4da
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 01/19/2017
ms.author: rajanaki
translationtype: Human Translation
ms.sourcegitcommit: 5614c39d914d5ae6fde2de9c0d9941e7b93fc10f
ms.openlocfilehash: b49771ff1e29aeb6ec582c21061085504705991b


---
# <a name="hyper-v-replication-with-azure-site-recovery"></a>Репликация Hyper-V с использованием Azure Site Recovery
Эта статья описывает технические концепции, которые помогут вам успешно настроить систему защиты в Azure для сайтов Hyper-V или сайтов диспетчера виртуальных машин (VMM) System Center с помощью Azure Site Recovery, а также управлять ее параметрами.

## <a name="setting-up-the-source-environment-for-replication-between-on-premises-and-azure"></a>Настройка среды источника для репликации между локальными средами и Azure
При настройке аварийного восстановления между локальной сетью и Azure следует скачать поставщик Azure Site Recovery и установить его на сервере VMM. Установите агент служб восстановления Azure на всех узлах Hyper-V.

![Развертывание сайта VMM для репликации между локальной средой и Azure](media/site-recovery-understanding-site-to-azure-protection/image00.png)

Настройка среды источника в инфраструктуре под управлением Hyper-V выполняется так же, как и в инфраструктуре под управлением VMM. Единственное отличие заключается в том, что поставщик и агент для узла Hyper-V устанавливаются на этом же узле. В среде VMM поставщик устанавливается на сервере VMM, а агент — на узлах Hyper-V (при использовании репликации в Azure).

## <a name="workflows"></a>Рабочие процессы
### <a name="enable-protection"></a>Включить защиту
Когда вы настроите защиту виртуальной машины на портале Azure или локально, запустится задание службы Site Recovery с именем **Включить защиту** . Его выполнение можно отслеживать на вкладке **Задания** .

![Задание "Включить защиту" в списке заданий](media/site-recovery-understanding-site-to-azure-protection/image001.PNG)

Задание **Включить защиту** проверяет соблюдение предварительных условий, а затем вызывает метод [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx) . Этот метод создает репликацию в Azure с использованием входных данных, указываемых при создании защиты.

Задание **Включить защиту** запускает начальную репликацию из локальной среды, вызывая метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) . Этот метод отправляет в Azure виртуальные диски виртуальной машины.

![Подробная информация о задании "Включить защиту"](media/site-recovery-understanding-site-to-azure-protection/IMAGE002.PNG)

### <a name="finalize-protection-on-the-virtual-machine"></a>Завершение подготовки защиты на виртуальной машине
При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx). Все виртуальные жесткие диски будут поочередно отправлены в Azure. Этот процесс занимает некоторое время в зависимости от размеров дисков и пропускной способности сети. Инструкции по оптимизации использования сети см. в статье [Как уменьшить нагрузку на сеть при защите между локальной средой и Azure](https://support.microsoft.com/kb/3056159).

После завершения начальной репликации запускается задача **Завершить подготовку защиты на виртуальной машине** , которая выполняет настройку сети и настройку после репликации. Во время начальной репликации:

* отслеживаются изменения, примененные ко всем дискам;
* используется дополнительное дисковое хранилище для моментального снимка и журналов реплики Hyper-V (HRL).

По завершении начальной репликации снимок виртуальной машины Hyper-V удаляется. Это удаление приводит к объединению изменений, выполненных на родительском диске после запуска начальной репликации.

![Задание "Завершить подготовку защиты на виртуальной машине" в списке заданий](media/site-recovery-understanding-site-to-azure-protection/image03.png)

### <a name="delta-replication"></a>Разностная репликация данных
Модуль отслеживания репликации реплики Hyper-V, который является частью системы репликации реплики Hyper-V, регистрирует в журналах реплики Hyper-V (*.hrl) все изменения, примененные к виртуальному жесткому диску. HRL-файлы размещаются в одном каталоге с дисками, к которым они относятся.

Для каждого диска, предназначенного для репликации, создается связанный HRL-файл. Эти журналы передаются в пользовательскую учетную запись хранения после завершения начальной репликации. При передаче журнала в Azure изменения на основном диске фиксируются в дополнительном журнале, который размещается в том же каталоге.

Состояние репликации виртуальной машины в ходе начальной или разностной репликации можно отслеживать в представлении виртуальной машины, как описано в разделе [Мониторинг работоспособности репликации для виртуальной машины](site-recovery-monitoring-and-troubleshooting.md#monitor-replication-health-for-virtual-machines).  

### <a name="resynchronization"></a>Повторная синхронизация
Виртуальная машина отмечается для выполнения повторной синхронизации, если произошел сбой в ходе разностной репликации, а полная начальная репликация предполагает слишком большую нагрузку на сеть или слишком долгое выполнение. Например, если размер HRL-файла достигает уровня 50 % от общего размера диска, виртуальная машина отмечается для выполнения повторной синхронизации. Повторная синхронизация минимизирует объем данных, передаваемых по сети. Для этого вычисляются контрольные суммы исходного и целевого дисков виртуальной машины, а затем отправляется только полученная разница.

После завершения повторной синхронизации возобновляется обычная разностная репликация данных. В случае сбоя сети или другого сбоя повторную синхронизацию можно возобновить.

По умолчанию повторная синхронизация автоматически назначается на нерабочее время. Чтобы выполнить повторную синхронизацию виртуальной машины вручную, выберите нужную виртуальную машину на портале и щелкните **Повторно синхронизир.**

![Повторная синхронизация вручную](media/site-recovery-understanding-site-to-azure-protection/image04.png)

Повторная синхронизация использует алгоритм фрагментации, то есть разбивает исходный и целевой файлы на блоки фиксированного размера. Для каждого фрагмента данных создаются контрольные суммы, сравнение которых позволяет определить, какие из блоков нужно передать от источника к целевому объекту.

### <a name="retry-logic"></a>Логика повторных попыток
При возникновении ошибок репликации используется встроенный алгоритм повторных попыток. Этот алгоритм предполагает работу с двумя представленными ниже категориями ошибок.

| Категория | Сценарии |
| --- | --- |
| Неустранимая ошибка |Без повторных попыток. Состояние репликации виртуальной машины отображается как **критическое**; требуется вмешательство администратора. Примеры таких ошибок:  <ul><li>Поврежденная цепочка виртуальных жестких дисков</li><li>Недопустимое состояние реплики виртуальной машины</li><li>Ошибка проверки подлинности сети</li><li>Ошибка авторизации</li><li>Не найденная виртуальная машина в случае с изолированным сервером Hyper-V</li></ul> |
| Устранимая ошибка |Повторные попытки выполняются в рамках каждого интервала репликации с использованием экспоненциального алгоритма отсрочки, то есть каждая следующая попытка выполняется с большей задержкой (1, 2, 4, 8, 10 минут). Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примеры таких ошибок:  <ul><li>Ошибка сети</li><li>Недостаточно места на диске</li><li>Нехватка памяти</li></ul> |

## <a name="hyper-v-virtual-machine-protection-and-recovery-life-cycle"></a>Защита и восстановление виртуальных машин Hyper-V: жизненный цикл
![Защита и восстановление виртуальных машин Hyper-V: жизненный цикл](media/site-recovery-understanding-site-to-azure-protection/image05.png)

## <a name="other-references"></a>Прочие ссылки
* [Мониторинг и устранение неполадок защиты виртуальных машин и физических серверов](site-recovery-monitoring-and-troubleshooting.md)
* [Служба технической поддержки Майкрософт](site-recovery-monitoring-and-troubleshooting.md#reach-out-for-microsoft-support)
* [Распространенные ошибки ASR и способы их устранения](site-recovery-monitoring-and-troubleshooting.md#common-azure-site-recovery-errors-and-their-resolutions)



<!--HONumber=Nov16_HO3-->


