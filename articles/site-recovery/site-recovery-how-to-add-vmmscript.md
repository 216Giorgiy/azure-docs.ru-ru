---
title: "Как добавить сценарии в план восстановления в Azure Site Recovery | Документация Майкрософт"
description: "Описываются необходимые компоненты для добавления нового сценария в план восстановления в VMM в Azure."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: shons
editor: 
ms.assetid: 72408c62-fcb6-4ee2-8ff5-cab1218773f2
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 12/13/2017
ms.author: ruturaj
ms.openlocfilehash: 60c6eebd9323028c63f42bd8a0996e3c0a2a1cf1
ms.sourcegitcommit: ded74961ef7d1df2ef8ffbcd13eeea0f4aaa3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2018
---
# <a name="add-vmm-scripts-to-a-recovery-plan"></a>Добавление сценариев VMM в план восстановления


В этой статье содержится информация о создании и добавлении сценариев VMM для планов восстановления в [Azure Site Recovery](site-recovery-overview.md).

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="prerequisites-of-adding-a-script-to-recovery-plan"></a>Необходимые компоненты для добавления сценарий в план восстановления

В планах восстановления можно использовать скрипты PowerShell. Чтобы они были доступны в плане восстановления, эти сценарии необходимо создать и поместить в библиотеку VMM. Ниже приведены рекомендации по созданию сценария.

* Для аккуратной обработки исключений сценарии должны включать блоки try-catch.
    - Если в скрипте возникает исключение, выполнение скрипта останавливается и задача помечается как невыполненная.
    - При возникновении ошибки оставшаяся часть скрипта не выполняется.
    - Если ошибка происходит при выполнении внеплановой отработки отказа, выполнение плана восстановления продолжается.
    - Если ошибка происходит при выполнении плановой отработки отказа, выполнение плана восстановления останавливается. В этом случае исправьте скрипт, убедитесь, что он выполняется должным образом, и повторно запустите план восстановления.
        - Команда Write-Host не работает в сценарии плана восстановления, и сценарий завершится с ошибкой. Для создания выходного файла создайте скрипт прокси, который выполняется в основном скрипте. Убедитесь, что все выходные данные перенаправляются с помощью команды ">>".
        - Если скрипт не завершается в течение 600 секунд, он будет остановлен.
        - Если от скрипта поступят любые данные в вывод STDERR, он будет считаться завершившимся с ошибкой. Эти сведения отображаются в данных о выполнении скрипта.

* Сценарии в плане восстановления выполняются в контексте учетной записи службы VMM. Эта учетная запись должна иметь разрешения на чтение для удаленной общей папки, в которой расположен скрипт. Скрипт должен успешно выполняться на уровне привилегий учетной записи службы VMM.
* Командлеты VMM предоставляются в модуле Windows PowerShell. Этот модуль устанавливается одновременно с консолью VMM. Его можно загрузить в скрипт, используя следующую команду:
   - Import-Module -Name virtualmachinemanager. [Узнайте больше](https://technet.microsoft.com/library/hh875013.aspx).
* Убедитесь в наличии хотя бы одного сервера библиотеки в вашем развертывании VMM. По умолчанию общая папка библиотеки для сервера VMM размещается на сервере VMM в локальной папке с именем MSCVMMLibrary.
    * Если ваша общая папка библиотеки находится на удаленном сервере (или расположена локально, но не совпадает с папкой MSCVMMLibrary), настройте общую папку, как описано ниже (\\\libserver2.contoso.com\share\ используется в качестве примера).
      * Откройте редактор реестра и найдите запись **HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\Azure Site Recovery\Registration**.
      * Для параметра **ScriptLibraryPath** укажите значение \\\libserver2.contoso.com\share\.. Укажите полное доменное имя. Предоставьте разрешения для расположения общей папки. Обратите внимание, что корневой узел общего ресурса. **Чтобы проверить это, откройте библиотеку на уровне корневого узла в VMM. Открывшийся путь и будет корневым путем, который необходимо использовать в переменной**.
      * Для тестирования скрипта используйте учетную запись с теми же разрешениями, которые есть у учетной записи службы VMM. Это позволит гарантировать, что локально скрипт выполняется в тех же условиях, что и в планах восстановления. На сервере VMM установите обход политики выполнения следующих образом:
        * Откройте консоль **PowerShell 64-разрядной версии Windows** с более высоким уровнем привилегий.
        * Введите: **Set-executionpolicy bypass**. [Узнайте больше](https://technet.microsoft.com/library/ee176961.aspx).

> [!IMPORTANT]
> Необходимо задать политику выполнения "Обход" только для 64-разрядной версии PowerShell. Если вы задали ее для 32-разрядной версии PowerShell, сценарии не будут выполняться.

## <a name="add-the-script-to-the-vmm-library"></a>Добавление сценария в библиотеку VMM

Если используется исходный сайт VMM, вы можете создать скрипт на сервере VMM и включить его в план восстановления.

1. Создайте новую папку в общей папке библиотеки. Например \<VMMServerName>\MSSCVMMLibrary\RPScripts. Разместите ее на исходном и целевом серверах VMM.
2. Создайте сценарий (например, RPScript) и убедитесь, что он работает должным образом
3. Поместите скрипт в папку \<VMMServerName>\MSSCVMMLibrary на исходном и целевом серверах VMM.

## <a name="add-the-script-to-a-recovery-plan"></a>Добавление сценария в план восстановления

Когда вы создадите план восстановления и добавите в группу виртуальные машины или группы репликации, в эту группу можно добавить сценарий.

1. Откройте план восстановления.
2. Щелкните любой элемент в списке **Step** (Шаг), затем выберите **Script** (Скрипт) или **Manual Action** (Ручное действие).
3. Укажите, следует ли добавить сценарий или действие до или после выбранного элемента. Используя кнопки управления **Move Up** (Переместить выше) и **Move Down** (Переместить ниже), можно изменить положение скрипта.
4. Если вы добавляете скрипт VMM, выберите **Failover to VMM script** (Отработка отказа в скрипт VMM). Для параметра **Script Path** (Путь к скрипту) укажите относительный путь к общей папке. В следующем примере для VMM это будет путь **\RPScripts\RPScript.PS1**.
5. Если вы добавляете модуль Runbook службы автоматизации Azure, укажите учетную запись службы автоматизации Azure, в которой расположен этот модуль Runbook, а затем выберите нужный скрипт модуля Runbook Azure.
6. Выполните тестовую отработку отказа по плану восстановления, чтобы убедиться в правильности работы сценария.


## <a name="next-steps"></a>Дополнительная информация

[Дополнительные сведения](site-recovery-failover.md) о выполнении отработки отказа.
