<properties
	pageTitle="Создание планов восстановления" 
	description="Служба Azure Site Recovery управляет репликацией, отработкой отказа и восстановлением виртуальных машин, размещенных на локальных серверах, с использованием Azure или дополнительного центра обработки данных." 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="10/07/2015" 
	ms.author="raynew"/>

# Создание планов восстановления

Служба Site Recovery способствует созданию надежного решения по обеспечению непрерывности бизнес-процессов и аварийного восстановления, защищающего ваши локальные физические серверы и виртуальные машины, организуя и автоматизируя репликацию и отработку отказов с перемещением в Azure или дополнительный локальный центр обработки данных. Общие сведения о сценария развертывания Site Recovery см. в статье [Обзор Site Recovery](site-recovery-overview.md).

## Об этой статье

В этой статье содержится информация о создании и настройке планов восстановления.

Если после прочтения статьи у вас возникнут какие-либо вопросы, вы можете задать их на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Обзор

Планы восстановления состоят из одной или нескольких упорядоченных групп, содержащих защищенные виртуальные машины или группы репликации (для репликации сети SAN). Отработка отказа для виртуальных машин осуществляется в соответствии с условиями групп. Для виртуальных машин в определенных группах отработка отказа выполняется одновременно. Планы восстановления делают следующее:

- Определяют группы машин, для которых отработка отказа и запуск выполняется одновременно.
- Создают зависимости между машинами за счет их объединения в группы плана восстановления. Например, если вам требуется выполнить отработку отказа для конкретного приложения и вновь запустить его, вы объедините виртуальные машины для этого приложения в одну группу плана восстановления.
- Автоматизируют и расширяют отработку отказа. Вы можете запустить тестовую, плановую или внеплановую отработку отказа в плане восстановления. Вы можете настраивать планы восстановления при помощи сценариев, службы автоматизации Azure и ручных действий.

Планы восстановления отображаются в статье **Планы восстановления** на портале Site Recovery.


## Создание планов восстановления

Способ создания плана восстановления зависит от особенностей развертывания службы Site Recovery.

- **Репликация Hyper-V (VMM)**. При репликации с сайта VMM на дополнительный локальный сайт или в Azure с помощью репликации Hyper-V вы добавляете защищенные виртуальные машины Hyper-V из облака VMM в план восстановления.
- **Репликация Hyper-V (сайт Hyper-V)**. При репликации с сайта Hyper-V (без сервера VMM) в Azure вы добавляете защищенные виртуальные машины из группы защиты в план восстановления.
- **Репликация сети SAN**. При репликации на дополнительный локальный сайт с помощью репликации сети SAN вы добавляете группу репликации, содержащую виртуальные машины, в план восстановления. Вы выбираете группу репликации, а не отдельные виртуальные машины, поскольку отработка отказа для всех виртуальных машин в группе репликации должна выполняться одновременно (в первую очередь отработка отказа выполняется на уровне хранилища).
- **Репликация VMware**. При репликации виртуальных машин VMware в Azure вы добавляете группы репликации, содержащие виртуальные машины, в план восстановления.

Создайте план восстановления следующим образом:

1. На вкладке Планы восстановления выберите Создать план восстановления. Укажите имя плана восстановления, а также исходный и целевой серверы. Исходный сервер должен содержать виртуальные машины, активированные для отработки отказа и восстановления.

	- При репликации между серверами VMM в поле **Тип источника** выберите VMM, а также укажите исходный и целевой серверы VMM. Щелкните **Hyper-V**, чтобы просмотреть облака, настроенные для использования реплики Hyper-V. 
	- При репликации между серверами VMM с помощью сети SAN в поле **Тип источника** выберите VMM, а также укажите исходный и целевой серверы VMM. Щелкните **SAN**, чтобы просмотреть облака, настроенные для репликации сети SAN.
	- При репликации из VMM в Azure в поле **Тип источника** выберите VMM. Выберите исходный сервер VMM, а в качестве целевого сервера — **Azure**.
	- При репликации с сайта Hyper-V в поле "Тип источника" выберите сайт Hyper-V. Выберите веб-сайт в качестве источника, а в качестве целевого сервера — **Azure**.
	- При репликации из VMware или с физического локального сервера в Azure, выберите сервер конфигурации в качестве источника, а в качестве целевого сервера — **Azure**

2\. В окне **Выбор виртуальных машин** выберите виртуальные машины (или группу репликации), которые требуется добавить в группу по умолчанию (группа 1) в плане восстановления.

## Настройка планов восстановления

После добавления защищенных виртуальных машин или групп репликации в группу плана восстановления по умолчанию и создания самого плана вы можете настроить его.

- **Добавление новых групп**. Вы можете добавить дополнительные группы плана восстановления. Добавляемые группы нумеруются в порядке добавления. Вы можете добавить до семи групп. Вы можете добавить дополнительные виртуальные машины или группы репликации в эти новые группы. Обратите внимание, что виртуальную машину или группу репликации можно включить только в одну группу плана восстановления.
- **Добавление сценария**. Вы можете добавить сценарии, выполняемые до или после группы плана восстановления. При добавлении сценария к группе добавляется новый набор действий. Например, для группы 1 создается набор предварительных действий с именем "Group 1: Pre-steps". Все предварительные действия будут перечислены в этом наборе. Обратите внимание, что для добавления сценария на основном веб-сайте требуется развернутый сервер VMM.
- **Добавление ручного действия**. Вы можете добавить ручные действия, выполняемые до или после группы плана восстановления. Выполнение плана восстановление приостанавливается по достижении добавленного вами ручного действия. При этом отображается диалоговое окно, требующее подтверждения выполнения ручного действия.

### Добавление сценариев в планы восстановления

Вы можете добавить сценарий в план восстановления.

При наличии исходного сайта VMM вы можете добавить сценарий на сервер VMM и включить его в план восстановления. При репликации в Azure вы можете интегрировать модули Runbook службы автоматизации Azure с планом восстановления

#### Создание сценария VMM

Перед началом работы обратите внимание на следующее:

- Создавайте сценарии с помощью Windows PowerShell.
- Командлеты VMM предоставляются в модуле Windows PowerShell. Модуль VMM Windows PowerShell устанавливается при установке консоли VMM. Модуль VMM можно загрузить в сценарий при помощи следующей команды в сценарии: Import-Module -Name virtualmachinemanager. [Дополнительные сведения](hhttps://technet.microsoft.com/library/hh875013.aspx).
- Убедитесь в наличии хотя бы одного сервера библиотеки в вашем развертывании VMM. По умолчанию общая папка библиотеки для сервера VMM находится локально на сервере VMM с именем папки MSCVMMLibrary.
- Если ваша общая папка библиотеки находится на удаленном сервере (или локальном, но без общего доступа через папку MSCVMMLibrary) настройте общую папку следующим образом (используйте \\libserver2.contoso.com\\share\\ в качестве примера):
	- Откройте редактор реестра.
	- Перейдите в HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Microsoft System Center Virtual Machine Manager Server\\DRAdapter\\Registration.
	- Измените значение ScriptLibraryPath.
	- Установите значение \\libserver2.contoso.com\\share. Укажите полное доменное имя.
	- Предоставьте разрешения для расположения общей папки.

- Сценарии в плане восстановления выполняются в контексте учетной записи службы VMM. Убедитесь, что у этой учетной записи есть разрешения на чтение удаленной общей папки, содержащей сценарий, после чего проверьте выполнение сценария на уровне привилегий учетной записи службы VMM.
- 	Обязательно проверяйте выполнение сценария через учетную запись пользователя с теми же разрешениями, что и у учетной записи службы VMM, чтобы обеспечить идентичное выполнение сценариев при автономной проверке и в планах восстановления.
- 	На сервере VMM установите обход политики выполнения следующих образом:
	- Откройте консоль 64-разрядной Windows PowerShell с повышенными привилегиями.
	- Введите: **Set-executionpolicy bypass**. [Дополнительные сведения](https://technet.microsoft.com/library/ee176961.aspx).
- Обязательно используйте блоки try-catch для аккуратной обработки исключений. При возникновении исключения в сценарии его выполнение останавливается, а задача завершается с ошибкой. При возникновении ошибки оставшаяся часть сценария не выполняется. Если это произойдет при выполнении внеплановой отработки отказа, выполнение плана восстановления продолжится. Если это произойдет при выполнении плановой отработки отказа, выполнение плана восстановления прекратится. В этом случае исправьте сценарий, убедитесь, что он выполняется должным образом, и повторно запустите план восстановления.
- Команда Write-Host не работает в сценарии плана восстановления, и сценарий завершится с ошибкой. Если вам требуется создать выходные данные, создайте сценарий прокси, выполняемый в основном сценарии, и убедитесь, что все выходные данные выводятся при помощи команды >>.
- Срок действия сценария истекает при отсутствии возврата более 600 секунд.
- Если что-либо будет записано в STDERR, сценарий считается завершившимся с ошибкой. Эти сведения отобразятся в данных о выполнении сценария.

Создайте сценарий следующим образом:

1. Создайте новую папку в общей папке библиотеки, например <VMMServerName>\\MSSCVMMLibrary\\RPScripts. Разместите ее на исходном и целевом серверах VMM.
2. Создайте сценарий (например, RPScript) и убедитесь, что он работает должным образом
3. Поместите сценарий в <VMMServerName>\\MSSCVMMLibrary на исходном и целевом серверах VMM.

#### Создание модуля Runbook службы автоматизации Azure

Вы можете расширить свой план восстановления, запустив модуль Runbook службы автоматизации Azure в рамках плана. [Подробная информация](site-recovery-runbook-automation.md).


### Добавление пользовательских параметров в план восстановления

1. Откройте план восстановления, который требуется настроить.
2. Откройте меню добавления виртуальных машин или новой группы.
3. Чтобы добавить сценарий или ручное действие, нажмите на любой элемент в списке **Step** (Шаг), после чего нажмите **Script** (Сценарий) или **Manual Action** (Ручное действие). Укажите, следует ли добавить сценарий или действие до или после выбранного элемента. Используйте кнопки управления **Move Up** (Переместить выше) и **Move Down** (Переместить ниже) для изменения положения сценария.
4. При добавлении сценария VMM выберите **Failover to VMM script** (Сценарий отработки отказа в VMM) и в поле **Script Path** (Путь к сценарию) введите относительный путь к общей папке. Например, если путь к общей папке — \<VMMServerName>\\MSSCVMMLibrary\\RPScripts, укажите путь \\RPScripts\\RPScript.PS1.
5. При добавлении модуля Runbook службы автоматизации Azure укажите **Учетную запись службы автоматизации Azure**, в которой расположен модуль Runbook, и выберите соответствующий **сценарий модуля Runbook для Azure**.
5. Выполните отработку отказа плана восстановления, чтобы убедиться в исправной работе сценария.


## Запуск отработки отказа

Вы можете выполнять различные типы отработок отказа плана восстановления, включая тестовую отработку отказа для проверки среды, а также плановую и внеплановую отработку отказа. Дополнительные сведения об отработке отказа, а также инструкции по выполнению различных типов отработок отказа см. в [этой статье](site-recovery-failover.md).


 

<!---HONumber=Oct15_HO3-->