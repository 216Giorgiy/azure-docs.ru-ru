---
title: "Создание и настройка планов восстановления для отработки отказа и восстановления в Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается создание и настройка планов восстановления в Azure Site Recovery для отработки отказа и восстановления виртуальных машин и физических серверов."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 72408c62-fcb6-4ee2-8ff5-cab1218773f2
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 01/26/2018
ms.author: raynew
ms.openlocfilehash: 9839a989246b28c1a194b8d1f0e99c1bd80ac2e5
ms.sourcegitcommit: ded74961ef7d1df2ef8ffbcd13eeea0f4aaa3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2018
---
# <a name="create-recovery-plans"></a>Создание планов восстановления


В этой статье содержится информация о создании и настройке планов восстановления в [Azure Site Recovery](site-recovery-overview.md).

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

 Созданные планы восстановления делают следующее:

* Определяют группы компьютеров, для которых отработка отказа и запуск выполняются одновременно.
* Моделируют зависимости между компьютерами, объединяя их в группы плана восстановления. Например, если отработка отказа и восстановление выполняются для конкретного приложения, все виртуальные машины этого приложения следует объединить в одну группу плана восстановления.
* Выполняют отработку отказа. Вы можете запустить тестовую, плановую или внеплановую отработку отказа в плане восстановления.

## <a name="why-use-recovery-plans"></a>Для чего используются планы восстановления?

Планы восстановления помогают спланировать систематический процесс восстановления путем создания небольших независимых модулей, которыми можно управлять. Обычно эти модули представляют приложение в среде. План восстановления не только позволяет определить последовательность, в которой запускаются виртуальные машины, но также дает возможность автоматизировать общие задачи, выполняемые во время восстановления.


**По сути, единственный способ проверить, подготовлена ли ваша среда к переносу в облако или аварийному восстановлению, — убедиться, что каждое ваше приложение является частью плана восстановления, а каждый план восстановления проверяется в Microsoft Azure путем тестирования восстановления. При такой готовности можно уверенно перенести весь центр обработки данных или выполнить его отработку отказа в Microsoft Azure.**
 
Ниже приведены три ключевых положения плана восстановления.

### <a name="model-an-application-to-capture-dependencies"></a>Моделирование приложения для отслеживания зависимостей

План восстановления — это группа виртуальных машин, обычно содержащих приложение, для которых одновременно выполняется отработка отказа. Используя конструкции плана восстановления, можно расширить эту группу для записи свойств приложения.
 
Давайте рассмотрим пример типичного трехуровневого приложения с:

* одной серверной частью SQL;
* одним ПО промежуточного слоя;
* одним внешним веб-интерфейсом.

Можно настроить план восстановления, чтобы виртуальные машины запускались в правильном порядке после отработки отказа. Сначала должна запускаться серверная часть SQL, затем — ПО промежуточного слоя, после него — внешний веб-интерфейс. Этот порядок гарантирует, что к моменту запуска последней виртуальной машины приложение будет работать. Например, когда запускается ПО промежуточного слоя, оно пытается подключиться к уровню SQL, и план восстановления гарантирует, что уровень SQL уже будет работать. Запуск интерфейсных серверов в последнюю очередь гарантирует, что пользователи не подключатся к URL-адресу приложения по ошибке, пока все компоненты не будут запущены, а приложение — готово к приему запросов. Для создания этих зависимостей можно настроить план восстановления, чтобы добавить группы. Затем следует выбрать виртуальную машину и изменить ее группу, чтобы переместить ее между группами.

![Пример плана восстановления](./media/site-recovery-create-recovery-plans/rp.png)

После завершения настройки вы можете визуализировать точные шаги восстановления. Ниже приведен порядок действий, выполненных во время отработки отказа по плану восстановления.

* Сначала выполняется шаг завершения работы, на котором осуществляется попытка отключить локальные виртуальные машины (за исключением тестовой отработки отказа, при которой основной сайт должен работать).
* Далее инициируется отработка отказа всех виртуальных машин в плане восстановления в параллельном режиме. На шаге отработки отказа с помощью реплицированных данных подготавливаются диски виртуальных машин.
* Наконец, в указанном порядке выполняются группы запуска и запускаются виртуальные машины в каждой группе: сначала в группе 1, затем в группе 2 и, наконец, в группе 3. При наличии нескольких виртуальных машин в какой-либо из групп (например, для внешнего веб-интерфейса с балансировкой нагрузки) все они загружаются параллельно.

**Упорядочивание групп гарантирует, что зависимости между различными уровнями приложения соблюдаются, а распараллеливание, когда оно применимо, улучшает RTO восстановления приложений.**

   > [!NOTE]
   > Отработка отказа компьютеров, которые входят в одну группу, будет выполняться в параллельном режиме. Отработка отказа компьютеров, которые входят в разные группы, будет выполняться в порядке указания групп. Только после выполнения отработки отказа и запуска всех компьютеров группы 1 начинается отработка отказа компьютеров группы 2

### <a name="automate-most-recovery-tasks-to-reduce-rto"></a>Автоматизация большинства задач восстановления для уменьшения RTO

Восстановление больших приложений может быть сложной задачей. Также сложно запомнить точную процедуру настройки после отработки отказа или переноса. В некоторых случаях не вы, а кто-то другой, кому нужно активировать отработку отказа, может не знать об особенностях приложения. Помнить слишком много ручных действий во время аварий сложно, и это может приводить к ошибкам. План восстановления позволяет автоматизировать обязательные действия, которые необходимо выполнить на каждом этапе, с помощью модулей runbook службы автоматизации Microsoft Azure. Используя модули runbook, можно автоматизировать общие задачи восстановления, такие как в приведенных ниже примерах. Для выполнения задач, которые невозможно автоматизировать, планы восстановления обеспечивают возможность вставить действия, выполняемые вручную.

* Задачи виртуальной машины Azure после отработки отказа. Как правило, они необходимы, чтобы подключиться к виртуальной машине, например:
    * создание общедоступного IP-адреса для виртуальной машины после отработки отказа;
    * назначение NSG для сетевого адаптера виртуальной машины, для которой выполнена отработка отказа;
    * добавление подсистемы балансировки нагрузки в группу доступности.
* Задачи в виртуальной машине после отработки отказа. Они необходимы для перенастройки приложения таким образом, чтобы оно работало в новой среде, например:
    * изменение строки подключения к базе данных в виртуальной машине;
    * изменение конфигурации или правил веб-сервера.

**Имея полный план восстановления для автоматизации задач после восстановления с помощью модулей runbook службы автоматизации, можно обеспечить отработку отказа "одним щелчком" и оптимизировать RTO.**

### <a name="test-failover-to-be-ready-for-a-disaster"></a>Тестовая отработка отказа для обеспечения готовности к аварии

План восстановления можно использовать для активации отработки отказа или тестовой отработки отказа. Всегда следует выполнить тестовую отработку отказа для приложения, прежде чем выполнять отработку отказа. Тестовая отработка отказа помогает проверить, запустится ли приложение на сайте восстановления.  Если что-то упущено, можно легко активировать очистку и повторить тестовую отработку отказа. Несколько раз выполните тестовую отработку отказа, пока не будете уверены в надежном восстановлении приложения.

![Проверка плана восстановления](./media/site-recovery-create-recovery-plans/rptest.png)

**Все приложения разные, и необходимо создать планы восстановления, подходящие для каждого из них. Кроме того, в мире динамических центров обработки данных приложения и их зависимости постоянно меняются. Тестируйте отработку отказа приложений один раз в квартал, чтобы проверять актуальность плана восстановления.**

## <a name="how-to-create-a-recovery-plan"></a>Как создать план восстановления

1. Щелкните **Планы восстановления** > **Создать план восстановления**.
   Укажите имя плана восстановления, а также исходный и целевой серверы. Исходное расположение должно содержать виртуальные машины, на которых настроены отработка отказа и восстановление. Выберите источник и цель в соответствии с виртуальными машинами, которые должны быть частью плана восстановления. 

   |Сценарий                   |Источник               |Цель           |
   |---------------------------|---------------------|-----------------|
   |Из Azure в Azure             |Регион Azure         |Регион Azure     |
   |Из VMware в Azure            |Сервер конфигурации |Таблицы Azure            |
   |VMM в Azure               |Понятное имя VMM    |Таблицы Azure            |
   |С сайта Hyper-V в Azure      |Имя сайта Hyper-V    |Таблицы Azure            |
   |Физические компьютеры в Azure |Сервер конфигурации |Таблицы Azure            |
   |Из VMM в VMM                 |Понятное имя VMM    |Понятное имя VMM|

   > [!NOTE]
   > План восстановления может содержать виртуальные машины с одинаковыми источником и целью. Виртуальные машины VMware и VMM не могут входить в один и тот же план восстановления. Однако виртуальные машины VMware и физические компьютеры можно добавить в один план, так как источником для них является сервер конфигурации.

2. В окне **Выбор виртуальных машин** укажите виртуальные машины (или группу репликации), которые хотите добавить в группу по умолчанию (Group 1) в плане восстановления. Для выбора будут доступны только виртуальные машины, которые защищены в источнике (выбранном в плане восстановления) и в цели (выбранной в плане восстановления).

## <a name="how-to-customize-and-extend-recovery-plans"></a>Как настроить и расширить планы восстановления

Можно настроить и расширить планы восстановления, перейдя в колонку ресурса плана восстановления Site Recovery и щелкнув вкладку "Настройка".

Вы можете настраивать и расширять планы восстановления.

- **Добавление новых групп**. Кроме группы по умолчанию, в план восстановления можно добавить до семи дополнительных групп, а затем добавлять в них виртуальные машины или группы репликации. Новые группы нумеруются в порядке добавления. Каждую виртуальную машину или группу репликации можно включить только в одну группу плана восстановления.
- **Добавление ручного действия**. Вы можете добавить ручные действия, выполняемые до или после группы плана восстановления. При выполнении план восстановления он останавливается в той точке, куда вы добавили выполняемое вручную действие. При этом появляется диалоговое окно с предложением подтвердить, что это действие выполнено вручную.
- **Добавление скрипта**. Вы можете добавить скрипты, выполняемые до или после группы плана восстановления. Каждый новый скрипт добавляет к группе новый набор действий. Например, для группы с именем "Group 1" создается набор предварительных действий с именем "Group 1: Pre-steps". Все предварительные действия перечислены в этом наборе. Чтобы добавить скрипт, на основном сайте должен быть развернут сервер VMM. [Узнайте больше](site-recovery-how-to-add-vmmscript.md).
- **Добавление модулей Runbook Azure**.Чтобы расширить план восстановления, вы можете применить модули Runbook Azure. Они позволяют автоматизировать задачи или выполнять пошаговое восстановление. [Узнайте больше](site-recovery-runbook-automation.md).


## <a name="how-to-add-a-script-runbook-or-manual-action-to-a-plan"></a>Как добавить в план сценарий, runbook или ручное действие

Когда вы создадите план восстановления и добавите в группу по умолчанию виртуальные машины или группы репликации, в эту группу можно добавить сценарий или ручное действие.

1. Откройте план восстановления.
2. Щелкните любой элемент в списке **Step** (Шаг), затем выберите **Script** (Скрипт) или **Manual Action** (Ручное действие).
3. Укажите, следует ли добавить сценарий или действие до или после выбранного элемента. Используя кнопки управления **Move Up** (Переместить выше) и **Move Down** (Переместить ниже), можно изменить положение сценария.
4. Если вы добавляете скрипт VMM, выберите **Failover to VMM script** (Отработка отказа в скрипт VMM). Для параметра **Script Path** (Путь к скрипту) укажите относительный путь к общей папке. В следующем примере для VMM это будет путь **\RPScripts\RPScript.PS1**.
5. Если вы добавляете модуль Runbook службы автоматизации Azure, укажите учетную запись службы автоматизации Azure, в которой расположен этот модуль Runbook, а затем выберите нужный скрипт модуля Runbook Azure.
6. Выполните отработку отказа по плану восстановления, чтобы убедиться в правильности работы сценария.

Параметры сценария или runbook доступны только в приведенных ниже сценариях отработки отказа или восстановления размещения. Ручное действие доступно для отработки отказа и восстановления размещения.


|Сценарий               |Отработка отказа |Восстановление размещения |
|-----------------------|---------|---------|
|Из Azure в Azure         |Модули Runbook |Модуль Runbook  |
|Из VMware в Azure        |Модули Runbook |Нет данных       | 
|VMM в Azure           |Модули Runbook |Скрипт   |
|С сайта Hyper-V в Azure  |Модули Runbook |Нет данных       |
|Из VMM в VMM             |Скрипт   |Скрипт   |


## <a name="next-steps"></a>Дополнительная информация

[Дополнительные сведения](site-recovery-failover.md) о выполнении отработки отказа.

Просмотрите это видео, чтобы узнать, как работает план восстановления.

> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/One-click-failover-of-a-2-tier-WordPress-application-using-Azure-Site-Recovery/player]
