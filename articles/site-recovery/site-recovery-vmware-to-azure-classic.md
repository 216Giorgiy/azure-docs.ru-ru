---
title: "Репликация виртуальных машин VMware и физических серверов в Azure на классическом портале | Документация Майкрософт"
description: "В этой статье описывается, как развернуть Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware и физических серверов Windows и Linux в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: a9022c1f-43c1-4d38-841f-52540025fb46
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/05/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: site-recovery-vmware-to-azure
ms.translationtype: Human Translation
ms.sourcegitcommit: 2db2ba16c06f49fd851581a1088df21f5a87a911
ms.openlocfilehash: 88c0e4d02f13d3dcc8824ed1cba8fecd3c5cfa77
ms.contentlocale: ru-ru
ms.lasthandoff: 05/09/2017


---

# <a name="replicate-vmware-virtual-machines-and-physical-servers-to-azure-with-azure-site-recovery"></a>Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmware-to-azure.md)
> * [Классический портал](site-recovery-vmware-to-azure-classic.md)
> * [Классический портал (прежняя версия)](site-recovery-vmware-to-azure-classic-legacy.md)
>
>

Служба Azure Site Recovery помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR), управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## <a name="overview"></a>Обзор
В этой статье описывается, как:

* **Репликация в Azure виртуальных машин VMware.** Разверните службу Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware в службе хранилища Azure.
* **Репликация в Azure физических серверов.** Разверните службу Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных физических серверов Windows и Linux в Azure.

> [!NOTE]
> В этой статье рассматривается репликация в Azure. Если вы хотите выполнить репликацию виртуальных машин VMware или физических серверов Windows и Linux во вторичный центр обработки данных, см. статью [Репликация локальных виртуальных машин VMware или физических серверов на вторичный сайт с помощью классического портала Azure](site-recovery-vmware-to-vmware.md).
>
>

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="enhanced-deployment"></a>Расширенное развертывание
Эта статья содержит инструкции для расширенного развертывания на классическом портале Azure. Для всех новых развертываний мы рекомендуем использовать именно эту версию. Если развертывание выполнено с использованием устаревшей версии, мы рекомендуем перейти к новой версии. Дополнительные сведения о миграции см. в разделе [Переход на расширенное развертывание](site-recovery-vmware-to-azure-classic-legacy.md#migrate-to-the-enhanced-deployment).

Расширенное развертывание — это крупное обновление. Ниже приведена сводка усовершенствований.

* **Отсутствие виртуальных машин инфраструктуры в Azure.**Репликация данных выполняется непосредственно в учетную запись хранения Azure. Кроме того, теперь для репликации и отработки отказа не нужно настраивать виртуальные машины инфраструктуры (сервер конфигурации, главный целевой сервер и т. п.), как в устаревшей модели развертывания.  
* **Единая установка**. Единая установка обеспечивает простоту настройки и масштабируемость локальных компонентов.
* **Безопасное развертывание.** Весь трафик шифруется, а данные управления репликацией отправляются через порт HTTPS 443.
* **Точки восстановления.** Поддержка точек восстановления после сбоя и точек восстановления, согласованных с приложением, для сред Windows и Linux, а также поддержка согласованных конфигураций с одной и несколькими виртуальными машинами.
* **Тестовая отработка отказа.** Поддержка тестовой отработки отказа в Azure, которая не прерывает рабочие процессы, не влияет на рабочую среду и на ход выполнения репликации.
* **Внеплановая отработка отказа.** Поддержка внеплановой отработки отказа в Azure с возможностью предварительного автоматического отключения виртуальных машин.
* **Восстановления размещения**. Встроенное восстановление размещения с репликацией только изменений на локальный сайт.
* **vSphere 6.0.** Ограниченная поддержка развертываний VMware vSphere 6.0.

## <a name="how-does-site-recovery-help-protect-virtual-machines-and-physical-servers"></a>Как служба Site Recovery позволяет защитить виртуальные машины и физические серверы?
* Администраторы VMware могут настроить удаленные системы для защиты Azure от корпоративных рабочих нагрузок и приложений, выполняемых на виртуальных машинах VMware. Администраторы серверов могут выполнить репликацию физических локальных серверов Windows и Linux в Azure.
* Консоль Azure Site Recovery обеспечивает настройку процессов репликации, отработки отказа и восстановления и управления ими в одном месте.
* При репликации виртуальных машин VMware, которыми управляет сервер vCenter, служба Site Recovery может автоматически обнаруживать их. Служба Site Recovery способна обнаруживать виртуальные машины, размещенные на узле ESXi.
* Если вы выполняете простую отработку отказа из локальной инфраструктуры в Azure, Azure Site Recovery позволяет восстанавливать размещение из Azure на локальные серверы виртуальных машин VMware.
* Вы можете настроить планы восстановления, в которых группируются рабочие нагрузки приложений, размещенные на разных уровнях и на нескольких компьютерах. При отработке отказа по этим планам Site Recovery поддерживает согласованность нескольких виртуальных машин. Это означает, что при восстановлении компьютеров с одинаковыми рабочими нагрузками все данные на них сохранятся в согласованном состоянии.

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы
### <a name="windows-64-bit-only"></a>Windows (только 64-разрядная)
* Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздняя версия.
* Windows Server 2012
* Windows Server 2012 R2

### <a name="linux-64-bit-only"></a>Linux (только 64-разрядная версия)
* Red Hat Enterprise Linux: 6.7, 7.1 и 7.2;
* CentOS 6.5, 6.6, 6.7, 7.0, 7.1 и 7.2;
* Oracle Enterprise Linux 6.4 или 6.5 с ядром, совместимым с Red Hat, или с ядром Unbreakable Enterprise Kernel Release 3 (UEK3);
* SUSE Linux Enterprise Server 11 SP3

## <a name="scenario-architecture"></a>Архитектура сценария
Компоненты сценария:

* **Локальный сервер управления**. На сервере управления запущены следующие компоненты Site Recovery:
  * **Сервер конфигурации** координирует обмен данными и управляет процессами репликации и восстановления данных.
  * **Сервер обработки** выступает в качестве шлюза репликации. Он получает данные с защищенных исходных компьютеров, оптимизирует их с применением кэширования, сжатия и шифрования, а затем отправляет данные репликации в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.
  * **Главный целевой сервер**— обрабатывает данные репликации при восстановлении размещения с переносом из Azure.
    Кроме того, вы можете масштабировать развертывание, развернув сервер управления, который выполняет только роль сервера обработки.
* **Служба Mobility Service**. Этот компонент развертывается на каждом компьютере (виртуальной машине VMware или физическом сервере), для которого требуется выполнить репликацию в Azure. Она фиксирует операции записи данных на компьютере и перенаправляет их на сервер обработки.
* **Azure**. Для выполнения репликации и отработки отказа не нужно создавать виртуальные машины Azure. Служба Site Recovery выполняет управление данными, а репликация данных выполняется непосредственно в службу хранилища Azure. Реплицированные виртуальные машины Azure развертываются автоматически только при отработке отказа в Azure. Однако если требуется выполнить отработку отказа из Azure на локальный сайт, должна быть настроена виртуальная машина Azure, выполняющая роль сервера обработки.

На приведенном ниже рисунке авторства Генри Робалино (Henry Robalino) показано взаимодействие этих компонентов.

![Архитектура компонентов](./media/site-recovery-vmware-to-azure/v2a-architecture-henry.png)

## <a name="capacity-planning"></a>Планирование загрузки
При планировании ресурсов следует учесть перечисленные ниже моменты.

* **Исходная среда.** Планирование загрузки или требования к инфраструктуре VMware и исходному компьютеру.
* **Сервер управления.** Планирование локальных серверов управления, на которых выполняются компоненты Site Recovery.
* **Пропускная способность сети из исходной среды в целевую.** Планирование пропускной способности сети, необходимой для репликации между исходной средой и Azure.

### <a name="source-environment-considerations"></a>Рекомендации для исходной среды
* **Максимальный объем ежедневных изменений.** Защищенный компьютер может использовать только один сервер обработки. Один сервер обработки поддерживает изменения в объеме не более 2 ТБ в день. Таким образом, 2 ТБ — это максимально допустимый объем ежедневных изменений данных на защищенном компьютере.
* **Максимальная пропускная способность.** Реплицированный компьютер может принадлежать только к одной учетной записи хранения Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Рекомендуется не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если исходный компьютер содержит 5 дисков, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (по 8 КБ), то для него соблюдается ограничение Azure в 500 операций ввода-вывода в секунду на один диск. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для источника на 20 000.

### <a name="management-server-considerations"></a>Рекомендации для сервера управления
На сервере управления выполняются компоненты Site Recovery, отвечающие за оптимизацию и репликацию данных, а также управление ими. Он должен иметь достаточную мощность, чтобы обрабатывать весь объем ежедневно изменяемых данных во всех рабочих нагрузках, выполняющихся на защищенных компьютерах. Также ему нужна достаточная пропускная способность для поддержки непрерывной репликации данных в службу хранилища Azure. В частности:

* Сервер обработки получает данные репликации с защищенных компьютеров и оптимизирует их с использованием кэширования, сжатия и шифрования перед отправкой в Azure. Для выполнения этих задач сервер управления должен располагать достаточными ресурсами.
* Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, рекомендуется установить отдельный диск кэша объемом 600 ГБ и более. При развертывании вы можете настроить кэш на любом диске, на котором есть свободное пространство объемом не менее 5 ГБ (но мы рекомендуем использовать не менее 600 ГБ).
* Рекомендуем разместить сервер управления в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.

В следующей таблице приведены рекомендации по размерам сервера управления.

| **ЦП сервера управления** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры** |
| --- | --- | --- | --- | --- |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) |16 ГБ |300 ГБ |500 ГБ или менее |Разверните сервер управления с использованием этих параметров для репликации не более 100 компьютеров. |
| 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) |18 ГБ |600 ГБ |От 500 ГБ до 1 ТБ |Разверните сервер управления с такими параметрами, чтобы реплицировать 100–150 компьютеров. |
| 16 виртуальных ЦП (2 сокета * 8 ядер с частотой 2,5 ГГц) |32 ГБ |1 TБ |От 1 ТБ до 2 ТБ |Разверните сервер управления с такими параметрами, чтобы реплицировать 150–200 компьютеров. |
| Разверните другой сервер обработки | | |Более 2 ТБ |Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ. |

Описание

* Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
* Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с 10 000 об./мин в конфигурации RAID 10.

### <a name="network-bandwidth-from-source-to-target"></a>Пропускная способность сети из исходной среды в целевую
Вычислите пропускную способность, требуемую для начальной репликации и разностной репликации, с помощью [планировщика ресурсов](site-recovery-capacity-planner.md).

#### <a name="throttling-bandwidth-used-for-replication"></a>Регулирование пропускной способности, используемой для репликации
Трафик VMware, реплицируемый в Azure, проходит через определенный сервер обработки. Вот как можно регулировать пропускную способность, доступную для репликации с помощью службы Site Recovery, на этом сервере:

1. На главном сервере управления или на сервере управления, на котором выполняются дополнительные подготовленные серверы обработки, откройте оснастку MMC для службы архивации Microsoft Azure. По умолчанию на рабочем столе создается ярлык для службы архивации Microsoft Azure. Его также можно найти в каталоге C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.

    ![Настройка регулирования пропускной способности](./media/site-recovery-vmware-to-azure-classic/throttle1.png)
3. На вкладке **Регулирование** укажите допустимую пропускную способность и расписание для репликации Site Recovery.

    ![Регулирование пропускной способности для репликации](./media/site-recovery-vmware-to-azure-classic/throttle2.png)

Также регулирование можно настроить с помощью PowerShell. Ниже приведен пример:

    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth (512*1024) -NonWorkHourBandwidth (2048*1024)

#### <a name="maximizing-bandwidth-usage"></a>Максимальное использование пропускной способности
Чтобы увеличить пропускную способность, используемую службой Azure Site Recovery для репликации, следует изменить раздел реестра.

Этот раздел устанавливает количество потоков, которые используются при репликации для каждого диска:

    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\UploadThreadsPerVM

 В сети с избыточной подготовкой следует изменить значения по умолчанию для этого раздела реестра. Поддерживается не более 32 потоков.  

Дополнительные сведения о подробном планировании ресурсов см. в статье [Планирование производительности для защиты виртуальных машин и физических серверов в Azure Site Recovery](site-recovery-capacity-planner.md).

### <a name="additional-process-servers"></a>Дополнительные серверы обработки
Если вам нужно защитить более 200 компьютеров или объем ежедневно изменяемых данных превышает 2 ТБ, для обработки такой нагрузки можно добавить дополнительные серверы. Для развертывания можно выполнить следующее.

* Увеличить число серверов управления. Например, с помощью двух серверов управления можно защитить до 400 компьютеров.
* Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера управления (или вместе с ним).

В этой таблице описан следующий сценарий.

* Настраивается исходный сервер управления, который будет использоваться только в качестве сервера конфигурации.
* Настраивается дополнительный сервер обработки.
* Настраиваются защищенные виртуальные машины для использования дополнительного сервера обработки.
* Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

| **Исходный сервер управления**<br/><br/>(сервер конфигурации) | **Дополнительный сервер обработки** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры** |
| --- | --- | --- | --- | --- |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) и 16 ГБ ОЗУ |4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц) и 8 ГБ ОЗУ |300 ГБ |250 ГБ или менее |Можно реплицировать до 85 компьютеров. |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) и 16 ГБ ОЗУ |8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) и 12 ГБ ОЗУ |600 ГБ |От 250 ГБ до 1 ТБ |Можно реплицировать от 85 до 150 компьютеров. |
| 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) и 18 ГБ ОЗУ |12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) и 24 ГБ ОЗУ |1 TБ |От 1 ТБ до 2 ТБ |Можно реплицировать от 150 до 225 компьютеров. |

Способ масштабирования серверов зависит от выбранной модели масштабирования — вертикальной или горизонтальной. При вертикальном масштабировании развертываются несколько мощных серверов управления и обработки, а при горизонтальном — увеличивается количество серверов с меньшим объемом ресурсов. Например, для защиты 220 компьютеров можно выполнить одну из следующих процедур:

* Настройте исходный сервер управления с 12 виртуальными ЦП и 18 ГБ ОЗУ. Добавьте дополнительный сервер обработки с 12 виртуальными ЦП и 24 ГБ ОЗУ. Настройте защищенные виртуальные машины так, чтобы они использовали только дополнительный сервер обработки.
* Настройте два сервера управления (2 x 8 виртуальных ЦП и 16 ГБ ОЗУ) и два дополнительных сервера обработки (1 x 8 виртуальных ЦП и 1 x 4 виртуальных ЦП, которых будет достаточно для поддержки 220 (135 + 85) компьютеров). Настройте защищенные компьютеры так, чтобы они использовали только дополнительные серверы обработки.

Чтобы настроить дополнительный сервер обработки, выполните инструкции из раздела [Развертывание дополнительных серверов обработки](#deploy-additional-process-servers).

## <a name="before-you-start-deployment"></a>Перед началом развертывания
В следующих таблицах приведены предварительные требования для развертывания описанного сценария.

### <a name="azure-prerequisites"></a>Предварительные требования Azure
| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Учетная запись Azure** |Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/) . Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). Дополнительные сведения о ценах на службу Site Recovery см. [здесь](https://azure.microsoft.com/pricing/details/site-recovery/). |
| **Служба хранилища Azure** |Для хранения реплицируемых данных потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа. <br/><br/>Необходима [учетная запись хранения для геоизбыточного хранилища уровня "Стандартный"](../storage/storage-redundancy.md#geo-redundant-storage). Она должна находиться в том же регионе, что и служба Site Recovery, и должна быть связана с той же подпиской. Сейчас репликация в учетные записи хранения класса Premium не поддерживается и не рекомендуется.<br/><br/>Также мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов. Дополнительную информацию см. в статье [Введение в хранилище Microsoft Azure](../storage/storage-introduction.md).<br/><br/> |
| **Сеть Azure** |Вам нужна виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище Site Recovery.<br/><br/>Для восстановления размещения в Azure после отработки отказа вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом. |

### <a name="on-premises-prerequisites"></a>Предварительные требования для локальной среды
| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Сервер управления** |Необходимо установить сервер Windows 2012 R2, выполняющийся на виртуальной машине или физическом сервере. На этом сервере управления устанавливаются все локальные компоненты Site Recovery.<br/><br/> Рекомендуется развернуть сервер как высокодоступную виртуальную машину VMware. Восстановление размещения на локальном сайте с переносом из Azure всегда будет выполняться на виртуальные машины VMware независимо от того, для чего выполняется отработка отказа — для виртуальных машин или физических серверов. Если сервер управления не настроен в качестве виртуальной машины VMware, необходимо настроить отдельный главный целевой сервер в роли виртуальной машины VMware, на которую будет поступать трафик при восстановлении размещения.<br/><br/>Сервер не должен быть контроллером домена.<br/><br/>Сервер должен иметь статический IP-адрес.<br/><br/>Длина имени узла сервера не должна превышать 15 символов.<br/><br/>Можно использовать только операционную систему на английском языке.<br/><br/>Сервер управления должен иметь доступ к Интернету.<br/><br/>Необходимо настроить исходящий доступ с сервера следующим образом: временный доступ к порту HTTP 80 на период установки компонентов Site Recovery (для загрузки MySQL); постоянный исходящий доступ к порту HTTPS 443 для управления репликацией; постоянный исходящий доступ к порту HTTPS 9443 для трафика репликации (этот порт можно изменить).<br/><br/> Убедитесь, что с сервера управления можно получить доступ к таким URL-адресам: <br/>- \*.hypervrecoverymanager.windowsazure.com<br/>- \*.accesscontrol.windows.net<br/>- \*.backup.windowsazure.com<br/>- \*.blob.core.windows.net<br/>- \*.store.core.windows.net<br/>- https://www.msftncsi.com/ncsi.txt<br/>- [ https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi](https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi " https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi")<br/><br/>При использовании на сервере правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure. Необходимо разрешить [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) и порт HTTPS (443). Также следует поместить в список разрешений IP-адреса для региона Azure, в котором размещается подписка, и для региона "Западная часть США". Для скачивания MySQL используется URL-адрес [https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi](https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi " https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi"). |
| **Узел VMware vCenter или ESXi** |Вам требуется один или несколько гипервизоров VMware vSphere ESX или ESXi, управляющих виртуальными машинами VMware, на которых установлен гипервизор ESX или ESXi версии 6.0, 5.5 или 5.1 с последними обновлениями.<br/><br/> Для управления узлами ESXi мы рекомендуем развернуть сервер VMware vCenter. На нем нужно установить vCenter версии 6.0 или 5.5 с последними обновлениями.<br/><br/>Обратите внимание, что Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища. Поддержка Site Recovery предоставляется только для компонентов, доступных в версии 5.5. |
| **Защищенные компьютеры** |**Таблицы Azure**<br/><br/>Компьютеры, которые требуется защитить, должны соответствовать [предварительным требованиям Azure](site-recovery-prereq.md) для создания виртуальных машин Azure.<br><br/>Если вы хотите подключаться к виртуальным машинам Azure после отработки отказа, необходимо разрешить подключения к удаленному рабочему столу в локальном брандмауэре.<br/><br/>Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ). Если у вас есть диски объемом более 1 ТБ, попробуйте использовать репликацию базы данных — например, с помощью SQL Server AlwaysOn или Oracle Data Guard.<br/><br/>Требуется не меньше 2 ГБ свободного места на диске для установки компонентов.<br/><br/>Гостевые кластеры общих дисков не поддерживаются. При наличии кластеризованного развертывания можно использовать репликацию базы данных — например, с помощью SQL Server AlwaysOn или Oracle Data Guard.<br/><br/>Загрузка с интерфейсами UEFI или EFI не поддерживается.<br/><br/>Имена компьютеров должны содержать от 1 до 63 символов (буквы, цифры и дефисы). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. Настроив защиту для компьютера, можно изменить его имя Azure.<br/><br/>**Виртуальные машины VMware**<br/><br>Необходимо установить VMware vSphere PowerCLI 6.0. на сервере управления (сервер конфигурации).<br/><br/>На виртуальных машинах VMware, которые нужно защитить, должны быть установлены и запущены средства VMware.<br/><br/>Если исходная виртуальная машина использует объединение сетевых карт, то после отработки отказа в Azure оно преобразуется в единую сетевую карту.<br/><br/>Если у защищенных виртуальных машин есть диск iSCSI, Site Recovery преобразует диск iSCSI защищенной виртуальной машины в VHD-файл при отработке отказа виртуальной машины в Azure. Если виртуальная машина Azure может получить доступ к целевому объекту iSCSI, она подключится к нему и обнаружит два диска — VHD на виртуальной машине Azure и исходный диск iSCSI. В этом случае необходимо отключить целевой объект iSCSI, который отображается на виртуальной машине Azure, для которой выполнена отработка отказа.<br/><br/>Дополнительные сведения о разрешениях пользователя VMware, которые нужны для Site Recovery, см. в разделе [Разрешения VMware для доступа к vCenter](#vmware-permissions-for-vcenter-access).<br/><br/> **Компьютеры под управлением Windows Server (на виртуальной машине VMware или физическом сервере)**<br/><br/>Сервер должен работать под управлением поддерживаемой 64-разрядной операционной системы: Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии.<br/><br/>Операционная система должна быть установлена на диске C. Диск операционной системы должен представлять собой базовый диск Windows. (Для установки ОС нельзя использовать динамический диск Windows.)<br/><br/>Для компьютеров Windows Server 2008 R2 должна быть установлена платформа .NET Framework 3.5.1.<br/><br/>Для принудительной установки службы Mobility Service на серверах Windows необходимо предоставить учетную запись администратора (с правами локального администратора на компьютере Windows). Если указанная учетная запись не является учетной записью домена, вам потребуется отключить контроль доступа удаленных пользователей на локальном компьютере. Дополнительные сведения см. в разделе [Принудительная установка службы Mobility Service](#install-the-mobility-service-with-push-installation).<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения Site Recovery повторно использует тот же диск RDM, если доступны исходная виртуальная машина и диск RDM. Если они недоступны, при восстановлении размещения служба Site Recovery создаст для каждого диска новый VMDK-файл.<br/><br/>**Компьютеры Linux**<br/><br/>Вам потребуется поддерживаемая 64-разрядная операционная система: Red Hat Enterprise Linux 6.7; CentOS 6.5, 6.6 или 6.7; Oracle Enterprise Linux 6.4 или 6.5 с ядром, совместимым с Red Hat, или ядром Unbreakable Enterprise Kernel Release 3 (UEK3); SUSE Linux Enterprise Server 11 SP3.<br/><br/>Файлы /etc/hosts на защищаемых компьютерах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров. <br/><br/>Чтобы иметь возможность подключаться к виртуальным машинам Azure под управлением Linux после отработки отказа с помощью клиента SSH, настройте для службы Secure Shell автоматический запуск при загрузке системы на защищенном компьютере, и создайте правила брандмауэра, разрешающие SSH-подключение к нему.<br/><br/>Защиту можно включить только для компьютеров под управлением Linux со следующими типами хранилищ: файловые системы (EXT3, ETX4, ReiserFS, XFS); многопутевой модуль сопоставления устройств и программного обеспечения (multipath); диспетчер томов (LVM2). Физические серверы с хранилищем контроллера HP CCISS не поддерживаются. Файловая система ReiserFS поддерживается только в SUSE Linux Enterprise Server 11 с пакетом обновления 3 (SP3).<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения для компьютеров Linux служба Site Recovery не использует диск RDM повторно. Вместо этого она создает новый VMDK-файл для каждого диска RDM. |

Только для виртуальных машин Linux — убедитесь, что параметр disk.enableUUID в конфигурации виртуальной машины в VMWare имеет значение true. Если этого параметра нет, добавьте его. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK. Если не указать этот параметр, при восстановлении размещения все данные будут загружены заново, даже если виртуальная машина доступна в локальной среде. Этот параметр позволяет передавать только небольшие изменения при восстановлении размещения.

## <a name="step-1-create-a-vault"></a>Шаг 1. Создание хранилища
1. Войдите на [портал Azure](https://manage.windowsazure.com/).
2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.
3. Щелкните **Создать** > **Быстрое создание**.
4. В поле **Имя**введите понятное имя для идентификации хранилища.
5. В поле **Область**выберите географический регион для хранилища архивации. Список поддерживаемых регионов указан на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. Щелкните элемент **Создать хранилище**.
    ![Создать хранилище](./media/site-recovery-vmware-to-azure-classic/quick-start-create-vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. На главной странице **служб восстановления** это хранилище будет иметь состояние **Активно**.

## <a name="step-2-set-up-an-azure-network"></a>Шаг 2. Настройка сети Azure
Настройте сеть Azure, чтобы виртуальные машины Azure были подключены к сети после отработки отказа и восстановление размещения на локальном сайте выполнялось должным образом.

1. На портале Azure щелкните **Создать виртуальную сеть** и укажите сетевое имя, диапазон IP-адресов и имя подсети.
2. Если требуется восстановление размещения, добавьте к сети подключение VPN или ExpressRoute. Это можно сделать даже после отработки отказа.

Дополнительные сведения см. в статье [о виртуальных сетях Azure](../virtual-network/virtual-networks-overview.md).

> [!NOTE]
> [Миграция сетей](../azure-resource-manager/resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.
>
>

## <a name="step-3-install-the-vmware-components"></a>Шаг 3. Установка компонентов VMware
Если нужно выполнить репликацию виртуальных машин VMware, выполните на сервере управления следующие действия.

1. [Скачайте](https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=PCLI600R1) и установите VMware vSphere PowerCLI 6.0.
2. Перезапустите сервер.

## <a name="step-4-download-a-vault-registration-key"></a>Шаг 4. Скачивание регистрационного ключа хранилища
1. С сервера управления откройте консоль Site Recovery в Azure. На странице **служб восстановления** щелкните хранилище, чтобы открыть страницу **быстрого запуска**. Также страницу **быстрого запуска** можно открыть в любой момент, щелкнув соответствующий значок.

    ![Значок быстрого запуска](./media/site-recovery-vmware-to-azure-classic/quick-start-icon.png)
2. На странице **Быстрый запуск** щелкните **Prepare Target Resources** (Подготовка целевых ресурсов)  >  **Скачать регистрационный ключ**. Файл регистрации создается автоматически. Ключ действителен в течение пяти дней после создания.

## <a name="step-5-install-the-management-server"></a>Шаг 5. Установка сервера управления
> [!TIP]
> Убедитесь, что с сервера управления можно получить доступ к таким URL-адресам:
>
> * *.hypervrecoverymanager.windowsazure.com
> * *.accesscontrol.windows.net
> * *.backup.windowsazure.com
> * *.blob.core.windows.net
> * *.store.core.windows.net
> * https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi
> * https://www.msftncsi.com/ncsi.txt
>
>



>[!VIDEO https://channel9.msdn.com/Blogs/Azure/Enhanced-VMware-to-Azure-Setup-Registration/player]



1. На странице **Быстрый запуск** скачайте файл единой установки на сервер.
2. Запустите файл установки, чтобы начать установку в мастере **единой установки Site Recovery**.
3. На странице **Перед началом работы** выберите **Установить сервер конфигурации и сервер обработки**.

   ![Перед началом работы](./media/site-recovery-vmware-to-azure-classic/combined-wiz1.png)
4. В окне **Лицензия на программное обеспечение стороннего поставщика** щелкните **Принимаю**, чтобы скачать и установить MySQL.

    ![Стороннее программное обеспечение](./media/site-recovery-vmware-to-azure-classic/combined-wiz105.PNG)
5. На странице **Регистрация** нажмите кнопку "Обзор" и выберите регистрационный ключ, скачанный из хранилища.

    ![Регистрация](./media/site-recovery-vmware-to-azure-classic/combined-wiz3.png)
6. На странице **Internet Settings** (Параметры Интернета) укажите параметры для подключения поставщика, который будет выполняться на сервере конфигурации, к Azure Site Recovery через Интернет.

   * Чтобы подключаться с помощью прокси-сервера, который уже настроен на компьютере, выберите **Connect with existing proxy settings**(Подключение с параметрами существующего прокси-сервера).
   * Чтобы поставщик подключался напрямую, выберите **Connect directly without a proxy** (Прямое подключение без прокси-сервера).
   * Если для существующего прокси-сервера требуется проверка подлинности или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера).
     * При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
     * Если используется прокси-сервер, вы уже разрешили использовать следующие URL-адреса:
       * *.hypervrecoverymanager.windowsazure.com    
       * *.accesscontrol.windows.net
       * *.backup.windowsazure.com
       * *.blob.core.windows.net
       * *.store.core.windows.net

    ![Брандмауэр](./media/site-recovery-vmware-to-azure-classic/combined-wiz4.png)

1. В окне **Проверка необходимых компонентов** программа установки проверяет возможность установки.

    ![Предварительные требования](./media/site-recovery-vmware-to-azure-classic/combined-wiz5.png)

     Если появится предупреждение о **проверке глобальной синхронизации времени**, убедитесь, что время системных часов (параметры **даты и времени**) соответствует часовому поясу.

     ![Проблема синхронизации времени](./media/site-recovery-vmware-to-azure-classic/time-sync-issue.png)

1. На странице **MySQL Configuration** (Конфигурация MySQL) создайте учетные данные для входа в экземпляр сервера MySQL, который будет установлен.

    ![MySQL](./media/site-recovery-vmware-to-azure-classic/combined-wiz6.png)
2. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. Если нужно, программа установки проверяет, установлен ли компонент PowerCLI 6.0.

    ![MySQL](./media/site-recovery-vmware-to-azure-classic/combined-wiz7.png)
3. На странице **Расположение установки** выберите место для установки двоичных файлов и хранения кэша. Вы можете выбрать любой диск, на котором есть свободный объем не менее 5 ГБ, но мы рекомендуем использовать для кэша диск с доступным объемом не менее 600 ГБ.

   ![Расположение установки](./media/site-recovery-vmware-to-azure-classic/combined-wiz8.png)
4. На странице **Выбор сети** укажите прослушиватель (сетевой адаптер и порт SSL), через который сервер конфигурации будет отправлять и получать данные репликации. Можно изменить порт по умолчанию (9443). Помимо этого порта веб-сервер, который координирует операции репликации, будет использовать порт 443. Не следует использовать порт 443 для приема трафика репликации.

    ![Выбор сети](./media/site-recovery-vmware-to-azure-classic/combined-wiz9.png)



1. Просмотрите информацию на странице **Сводка** и нажмите кнопку **Установить**. Когда установка завершится, будет создана парольная фраза. Она потребуется при включении репликации, поэтому ее следует скопировать и сохранить в безопасном месте.

   ![Сводка](./media/site-recovery-vmware-to-azure-classic/combined-wiz10.png)


> [!WARNING]
> Необходимо настроить прокси агента служб восстановления Microsoft Azure.
> После завершения установки запустите оболочку служб восстановления Microsoft Azure из меню "Пуск" Windows. В открывшемся командном окне выполните следующий набор команд, чтобы настроить параметры прокси-сервера.
>
>
    $pwd = ConvertTo-SecureString -String ProxyUserPassword
    Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumb – ProxyUserName domain\username -ProxyPassword $pwd
    net stop obengine
    net start obengine
>


### <a name="run-setup-from-the-command-line"></a>Запуск установки из командной строки
Единый мастер можно также запустить из командной строки. Вот как это можно сделать:

    UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]

Описание

* /ServerMode. (Обязательный параметр.) Указывает, какие серверы следует устанавливать: сервер конфигурации и обработки или только сервер обработки (используется для установки дополнительных серверов обработки). Входные значения: CS, PS.
* InstallDrive. (Обязательный параметр.) Указывает папку для установки компонентов.
* /MySQLCredFilePath. (Обязательный параметр.) Указывает путь к файлу, в котором хранятся учетные данные сервера MySQL. Получите шаблон, чтобы создать его.
* /VaultCredFilePath. (Обязательный параметр.) Расположение файла с учетными данными хранилища.
* /EnvType. (Обязательный параметр.) Тип установки. Значения: VMware, NonVMware.
* /PSIP и /CSIP. (Обязательный параметр.) IP-адреса сервера обработки и сервера конфигурации.
* /PassphraseFilePath. (Обязательный параметр.) Расположение файла с парольной фразой.
* /ByPassProxy. необязательный параметр. Указывает, что сервер управления подключается к Azure без использования прокси-сервера.
* /ProxySettingsFilePath. необязательный параметр. Указывает параметры пользовательского прокси-сервера. По умолчанию это прокси-сервер с обязательной проверкой подлинности. Также можно настроить пользовательский прокси-сервер.

## <a name="step-6-set-up-credentials-for-the-vcenter-server"></a>Шаг 6. Настройка учетных данных для сервера vCenter
> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Enhanced-VMware-to-Azure-Discovery/player]
>
>

Сервер обработки может автоматически обнаруживать виртуальные машины VMware, которыми управляет сервер vCenter. Для этого службе Site Recovery требуется учетная запись и учетные данные, с помощью которых можно получить доступ к серверу vCenter. Они не нужны, если репликация применяется только для физических серверов.

Чтобы настроить учетную запись и учетные данные, сделайте следующее.

1. На сервере vCenter создайте роль **Azure_Site_Recovery** на уровне vCenter с [требуемыми разрешениями](#vmware-permissions-for-vcenter-access).
2. Назначьте роль **Azure_Site_Recovery** пользователю vCenter.

   > [!NOTE]
   > Используя учетную запись vCenter с ролью только для чтения, можно выполнять отработку отказа без выключения исходных защищенных компьютеров. Если их работу следует завершать, то потребуется роль Azure_Site_Recovery. Если нужно только перенести виртуальные машины из VMware в Azure без последующего восстановления размещения, достаточно роли только для чтения.
   >
   >
3. Чтобы добавить учетную запись, откройте средство **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
4. На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.

    ![Добавление учетной записи](./media/site-recovery-vmware-to-azure-classic/credentials1.png)
5. В окне **Сведения об учетной записи** добавьте учетные данные, которые можно использовать для доступа к серверу vCenter. Обратите внимание, что имя учетной записи может отобразиться на портале более чем через 15 минут. Чтобы выполнить обновление немедленно, на вкладке **Серверы конфигурации** нажмите кнопку **Обновить**.

    ![Сведения](./media/site-recovery-vmware-to-azure-classic/credentials2.png)

## <a name="step-7-add-vcenter-servers-and-esxi-hosts"></a>Шаг 7. Добавление серверов vCenter и узлов ESXi
Если выполняется репликация виртуальных машин VMware, необходимо добавить сервер vCenter (или узел ESXi).

1. На вкладке **Серверы** > **Серверы конфигурации** щелкните **Добавить сервер vCenter**.

    ![vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter1.png)
2. Добавьте дополнительные сведения о сервере vCenter или узле ESXi, имя учетной записи, указанной на предыдущем шаге для доступа к серверу vCenter, и сервер обработки, который будет использоваться для обнаружения виртуальных машин VMware, управляемых этим сервером vCenter. Сервер vCenter или узел ESXi должны находиться в той же сети, что и сервер, на котором установлен сервер обработки.

   > [!NOTE]
   > Если вы добавляете сервер vCenter или узел ESXi, используя учетную запись без прав администратора на сервере vCenter или сервере узла, отдельно предоставьте для учетных записей vCenter или ESXi привилегии центра обработки данных, хранилища данных, папки, Jost, сети, ресурса, виртуальной машины и распределенного коммутатора vSphere. Для сервера vCenter должны быть активированы привилегии представлений хранилища.
   >
   >

    ![Добавление сервера vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter2.png)
3. Когда обнаружение завершится, сервер vCenter будет указан на вкладке **Серверы конфигурации**.

    ![vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter3.png)

## <a name="step-8-create-a-protection-group"></a>Шаг 8. Создание группы защиты
> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Enhanced-VMware-to-Azure-Protection/player]
>
>

Группы защиты — это логические группы виртуальных машин или физических серверов, для которых используются одинаковые параметры защиты. Параметры, установленные для группы защиты, будут применяться ко всем виртуальным и физическим машинам, добавленным в эту группу.

1. Откройте вкладку **Защищенные элементы** > **Группа защиты** и щелкните значок для добавления группы защиты.

    ![Создание группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups1.png)
2. На странице **Задать настройки группы защиты** укажите имя для группы. В раскрывающемся списке **From** (Откуда) выберите сервер конфигурации, на котором требуется создать группу. Для параметра **Target** (Куда) выберите значение Microsoft Azure.

    ![Параметры группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups2.png)
3. На странице **Задайте настройки репликации** настройте параметры репликации, которые будут использоваться для всех компьютеров в этой группе.

    ![Репликация группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups3.png)

   * **Согласование с несколькими виртуальными машинами.** Если включен этот параметр, для компьютеров в группе защиты создаются общие точки восстановления, согласованные с приложениями. Этот параметр особенно важен, если на всех компьютерах в группе защиты выполняется одна и та же рабочая нагрузка. Все компьютеры будут восстановлены до одной точки данных. Этот параметр доступен при репликации виртуальных машин VMware или физических серверов Windows или Linux.
   * **Пороговое значение RPO**. Задает целевую точку восстановления (RPO). Если при использовании непрерывной защиты данных для репликации будет превышено пороговое значение RPO, создаются оповещения.
   * **Период хранения точки восстановления**. Определяет период хранения. Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
   * **Периодичность моментальных снимков с согласованием приложений.** Указывает, насколько часто будут создаваться точки восстановления, содержащие моментальные снимки с согласованным состоянием приложений.

Если щелкнуть значок с галочкой, создается группа защиты с указанным именем. Кроме того, создается вторая группа защиты с именем *имя-группы-защиты*-Failback. Эта группа защиты используется при восстановлении размещения на локальном сайте после отработки отказа с переносом в Azure. Создание групп защиты можно отслеживать на странице **Защищенные элементы** .

## <a name="step-9-install-the-mobility-service"></a>Шаг 9. Установка службы Mobility Service
При включении защиты для виртуальных машин и физических серверов нужно прежде всего установить службу Mobility Service. Это можно сделать двумя способами.

* Автоматическая принудительная установка службы на каждом компьютере с сервера обработки. При добавлении в группу защиты компьютеров, на которых уже выполняется допустимая версия службы Mobility Service, принудительная установка не выполняется. Для службы можно использовать автоматическую принудительную установку с помощью корпоративных средств, таких как WSUS или System Center Configuration Manager. Перед этим убедитесь, что сервер управления настроен.
* Установите службу вручную на каждом компьютере, который необходимо защитить. Перед этим убедитесь, что сервер управления настроен.

### <a name="install-the-mobility-service-with-push-installation"></a>Принудительная установка службы Mobility Service
Когда вы добавляете компьютеры в группу защиты, сервер обработки автоматически выполняет принудительную установку службы Mobility Service на каждый из этих компьютеров.

#### <a name="prepare-for-automatic-push-on-windows-machines"></a>Подготовка к принудительной установке на компьютерах Windows
Ниже описан процесс подготовки компьютеров Windows для автоматической установки службы Mobility Service с помощью сервера обработки.

1. Создайте учетную запись, с помощью которой сервер обработки сможет получить доступ к компьютеру. Ей следует назначить права администратора (локального администратора или администратора домена). Эти учетные данные используются только для принудительной установки службы Mobility Service.

   > [!NOTE]
   > Если учетная запись домена не используется, на локальном компьютере нужно отключить контроль удаленного доступа пользователей. Для этого в разделе реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System добавьте запись DWORD "LocalAccountTokenFilterPolicy" и задайте для нее значение 1. Чтобы добавить запись в реестр из интерфейса командной строки, откройте командную строку или PowerShell и введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**.
   >
   >
2. На компьютере, который необходимо защитить, в брандмауэре Windows выберите **Разрешить запуск программы или компонента через брандмауэр Windows** и установите флажки **Общий доступ к файлам и принтерам** и **Инструментарий управления Windows**. Для компьютеров, входящих в домен, политику брандмауэра, можно настроить с помощью объекта групповой политики.

   ![Параметры брандмауэра](./media/site-recovery-vmware-to-azure-classic/mobility1.png)
3. Добавьте созданную учетную запись:

   * Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
   * На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
   * Добавьте созданную учетную запись. Теперь нужно будет указать эти учетные данные при добавлении компьютера в группу защиты.

#### <a name="prepare-for-automatic-push-on-linux-servers"></a>Подготовка к принудительной установке на серверах Linux
1. Компьютер Linux, который необходимо защитить, должен соответствовать всем [предварительным требованиям для локальной среды](#on-premises-prerequisites). Убедитесь, что между компьютером, который нужно защитить, и сервером управления, на котором выполняется сервер обработки, существует сетевое подключение.
2. Создайте учетную запись, с помощью которой сервер обработки сможет получить доступ к компьютеру. Учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux. Эти учетные данные используются только для принудительной установки службы Mobility Service.

   * Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
   * На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
   * Добавьте созданную учетную запись. Теперь нужно будет указать эти учетные данные при добавлении компьютера в группу защиты.
3. Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.
4. Установите на защищаемом компьютере последние версии пакетов openssh, openssh-server и openssl.
5. Убедитесь, что служба SSH включена и работает через порт 22.
6. Включите подсистему SFTP и проверку подлинности с помощью пароля в файле sshd_config следующим образом:

   * Выполните вход в качестве привилегированного пользователя.
   * В файле /etc/ssh/sshd_config найдите строку, начинающуюся с PasswordAuthentication.
   * Раскомментируйте ее и измените значение с **no** на **yes**.
   * Найдите строку, которая начинается с **Subsystem** , и раскомментируйте ее.

     ![Переопределение значения по умолчанию для Linux, определяющего отсутствие подсистем](./media/site-recovery-vmware-to-azure-classic/mobility2.png)

### <a name="install-the-mobility-service-manually"></a>Установка службы Mobility Service вручную
Установщики находятся в каталоге C:\Program Files (x86)\Microsoft Azure Site Recovery\home\svsystems\pushinstallsvc\repository.

| Исходная операционная система | Файл установки службы Mobility Service |
| --- | --- |
| Windows Server (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_Windows_* release.exe |
| CentOS 6.4, 6.5, 6.6 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_RHEL6-64_*release.tar.gz |
| SUSE Linux Enterprise Server 11 SP3 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_SLES11-SP3-64_*release.tar.gz |
| Oracle Enterprise Linux 6.4, 6.5 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_OL6-64_*release.tar.gz |

#### <a name="install-the-mobility-service-manually-on-a-windows-server"></a>Установка службы Mobility Service вручную на сервере Windows
1. Скачайте и запустите соответствующий установщик.
2. На странице **Перед началом работы** выберите **Служба мобильности**.

    ![Установка службы Mobility Service](./media/site-recovery-vmware-to-azure-classic/mobility3.png)
3. На странице **Сведения о сервере конфигурации** укажите IP-адрес сервера управления и парольную фразу, созданную при установке компонентов сервера управления. Чтобы получить эту парольную фразу, на сервере управления выполните команду **<SiteRecoveryInstallationFolder>\home\sysystems\bin\genpassphrase.exe –n**.

    ![Служба Mobility Service](./media/site-recovery-vmware-to-azure-classic/mobility6.png)
4. На странице **Расположение установки** оставьте расположение по умолчанию и нажмите кнопку **Далее**, чтобы начать установку.
5. На странице **Ход установки** проследите за ходом установки и перезапустите компьютер, когда появится соответствующий запрос.

Установку также можно выполнить вручную, введя в командной строке следующий текст:

    UnifiedAgent.exe [/Role <Agent/MasterTarget>] [/InstallLocation <Installation Directory>] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>] [/LogFilePath <Log File Path>]

В предыдущей команде используются следующие параметры:

* /Role. (Обязательный параметр.) Указывает, следует ли устанавливать службу Mobility Service.
* /InstallLocation. (Обязательный параметр.) Указывает место установки службы.
* /PassphraseFilePath. (Обязательный параметр.) Указывает парольную фразу сервера конфигурации.
* /LogFilePath. (Обязательный параметр.) Указывает расположение файла установки журнала.

#### <a name="uninstall-the-mobility-service-manually"></a>Установка Mobility Service вручную
Удалить Mobility Service можно с помощью командной строки или пункта **Удалить или изменить программу** в панели управления.

Чтобы удалить службу Mobility Service, выполните приведенную ниже команду в командной строке.

    MsiExec.exe /qn /x {275197FC-14FD-4560-A5EB-38217F80CBD1}

#### <a name="change-the-ip-address-of-the-management-server"></a>Изменение IP-адреса сервера управления
После запуска мастера можно изменить IP-адрес сервера управления следующим образом:

1. Откройте файл hostconfig.exe (расположенный на рабочем столе).
2. На вкладке **Глобальные** измените IP-адрес сервера управления.

   > [!NOTE]
   > Не изменяйте остальные параметры. Для обмена данными с сервером управления оставьте порт 443, также не снимайте флажок **Использовать HTTPS**. Не изменяйте парольную фразу.
   >
   >

    ![IP-адрес сервера управления](./media/site-recovery-vmware-to-azure-classic/host-config.png)

#### <a name="install-the-mobility-service-manually-on-a-linux-server"></a>Установка службы Mobility Service вручную на сервере Linux
1. Скопируйте соответствующий TAR-архив на компьютер Linux, который нужно защитить. Таблица в разделе [Установка службы Mobility Service вручную](#install-the-mobility-service-manually) поможет определить, какой TAR-архив следует использовать.
2. Откройте программу оболочки и извлеките содержимое сжатого TAR-файла архива в формате ZIP по локальному пути, выполнив команду `tar -xvzf Microsoft-ASR_UA_8.5.0.0*`.
3. Создайте файл с именем passphrase.txt в локальном каталоге, в который извлечено содержимое TAR-архива. Для этого скопируйте парольную фразу из файла C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase, расположенного на сервере управления, и сохраните ее в файле passphrase.txt, выполнив в оболочке команду *`echo <passphrase> >passphrase.txt`*.
4. Установите службу Mobility Service, выполнив в командной строке следующую команду: *`sudo ./install -t both -a host -R Agent -d /usr/local/ASR -i <IP address> -p <port> -s y -c https -P passphrase.txt`*
5. Укажите внутренний IP-адрес сервера управления и убедитесь, что выбран порт 443.

#### <a name="install-the-mobility-service-from-the-command-line"></a>Установка службы Mobility Service из командной строки

Скопируйте парольную фразу из файла C:\Program Files (x86)\InMage Systems\private\connection, расположенного на сервере управления, и сохраните ее там же в файле passphrase.txt. Затем выполните следующие команды: В нашем примере для сервера управления используется IP-адрес 104.40.75.37 и порт HTTPS 443:

Установка на рабочем сервере

    ./install -t both -a host -R Agent -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

Установка на главном целевом сервере:

    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt


## <a name="step-10-enable-protection-for-a-machine"></a>Шаг 10. Включение защиты для компьютера
Чтобы включить защиту, добавьте виртуальные машины и физические серверы в группу защиты. Если вы защищаете виртуальные машины VMware, заранее учтите следующие аспекты.

* Виртуальные машины VMware обнаруживаются каждые 15 минут, а для их отображения на портале Site Recovery после обнаружения может потребоваться более 15 минут.
* Изменениям среды на виртуальной машине (таким как установка средств VMware) также может потребоваться более 15 минут на обновление в Site Recovery.
* Время последнего обнаружения для виртуальных машин VMware можно узнать на вкладке **Серверы конфигурации** в поле **Последнее обнаружение** для сервера vCenter или узла ESXi.
* Если вы добавляете сервер vCenter или узел ESXi в уже созданную группу защиты, то порталу Azure Site Recovery может потребоваться более 15 минут для обновления, чтобы виртуальные машины отобразились в диалоговом окне **Add machines to a protection group** (Добавление компьютеров в группу защиты).
* Если вы хотите немедленно продолжить работу и добавить компьютеры в группу защиты, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.

Кроме того, сделайте следующее:

* При разработке групп защиты рекомендуется, чтобы они зеркалировали рабочие нагрузки. Например, добавляйте в одну группу компьютеры, выполняющее одно приложение.
* При добавлении компьютеров в группу защиты сервер обработки автоматически принудительно устанавливает службу Mobility Service, если она не установлена. Для этого нужно подготовить механизм принудительной установки, как описано в предыдущем шаге.

### <a name="add-machines-to-a-protection-group"></a>Добавление компьютеров в группу защиты

1. Перейдите к разделу **Защищенные элементы** > **Группа защиты** > **Компьютеры** > **Добавить компьютеры**.
2. Если вы защищаете виртуальные машины VMware, в окне **Выбор виртуальных машин** выберите сервер vCenter, управляющий виртуальными машинами (или узел EXSi, на котором они выполняются), а затем выберите нужные компьютеры.

    ![Включение защиты для виртуальных машин](./media/site-recovery-vmware-to-azure-classic/enable-protection2.png)
3. Если вы защищаете физические серверы, в окне **Выбор виртуальных машин** откройте мастер **Добавление физических компьютеров** и укажите IP-адрес и понятное имя. После этого выберите семейство операционной системы.

   ![Включение защиты для физических серверов](./media/site-recovery-vmware-to-azure-classic/enable-protection1.png)
4. На странице **Specify Target Resources** (Указание целевых ресурсов) выберите учетную запись хранения для репликации, а также укажите, следует ли использовать эти параметры для всех рабочих нагрузок. Учетные записи хранилища класса Premium сейчас не поддерживаются.

   > [!NOTE]
   > Также мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.                           
   > [Перенос учетных записей хранения](../azure-resource-manager/resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для учетных записей хранения, используемых для развертывания Site Recovery.
   >
   >

    ![Настройка параметров целевого объекта](./media/site-recovery-vmware-to-azure-classic/enable-protection3.png)
5. На странице **Указание учетных записей** выберите учетную запись, которую вы [настроили](#install-the-mobility-service-with-push-installation) для автоматической установки службы Mobility Service.

    ![Указание учетных записей](./media/site-recovery-vmware-to-azure-classic/enable-protection4.png)
6. Установите флажок, чтобы завершить добавление компьютеров в группу защиты и запустить начальную репликацию для каждого компьютера.

   > [!NOTE]
   > Когда вы подготовите принудительную установку, служба Mobility Service будет автоматически установлена на добавляемые в группу защиты компьютеры, на которых она еще не установлена. После установки службы задание защиты запускается и завершается ошибкой. После этого сбоя следует вручную перезапустить каждый компьютер, на который была установлена служба Mobility Service. После перезапуска будет снова запущено задание защиты и начнется начальная репликация.
   >
   >

Ход выполнения можно отслеживать на странице **Задания** .

![Отслеживание выполнения на странице "Задания"](./media/site-recovery-vmware-to-azure-classic/enable-protection5.png)

Состояние защиты можно отслеживать в разделе **Защищенные элементы** > *имя_группы_защиты* > **Виртуальные машины**. Когда завершится начальная репликация и синхронизация данных, состояние компьютера изменится на **Защищен**.

![Отслеживание состояния в разделе "Защищенные элементы"](./media/site-recovery-vmware-to-azure-classic/enable-protection6.png)

## <a name="step-11-set-protected-machine-properties"></a>Шаг 11. Настройка свойств защищенного компьютера
1. После того как компьютер получит состояние **Защищен**, можно приступать к настройке свойств отработки отказа. В разделе сведений о группе защиты выберите нужный компьютер и откройте вкладку **Настройка**.
2. Site Recovery автоматически предлагает свойства для виртуальной машины Azure и обнаруживает параметры локальной сети.

    ![Задание свойств виртуальной машины](./media/site-recovery-vmware-to-azure-classic/vm-properties1.png)
3. Здесь можно изменить перечисленные ниже параметры.

   * **Имя виртуальной машины Azure**. Это имя, которое будет назначено компьютеру в Azure после отработки отказа. Оно должно соответствовать требованиям Azure.
   * **Размер виртуальной машины Azure.** Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины. Дополнительные сведения о размерах и адаптерах см. в [таблицах размеров](../virtual-machines/linux/sizes.md). Обратите внимание на следующее.

     * Если вы измените размер виртуальной машины и сохраните параметры, количество сетевых адаптеров изменится при следующем открытии вкладки **Настройка**. Минимальное количество сетевых адаптеров на целевых виртуальных машинах соответствует минимальному количеству сетевых адаптеров на исходной виртуальной машине. Максимальное число сетевых адаптеров определяется размером виртуальной машины.
       * Если число сетевых адаптеров на исходном компьютере меньше числа адаптеров, разрешенного для размера целевой машины, или равно ему, то количество адаптеров на целевой машине будет таким же.
       * Если число адаптеров на исходной виртуальной машине превышает допустимое количество для размера целевой виртуальной машины, то для нее будет установлено максимально разрешенное количество для заданного размера.
        Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, на целевой машине будет только один адаптер.
     * Если на виртуальной машины несколько сетевых адаптеров, все они должны быть подключены к одной сети Azure.
   * **Сеть Azure**. Нужно указать сеть Azure, к которой подключатся виртуальные машины Azure после отработки отказа. Если этого не сделать, виртуальные машины Azure не подключатся ни к какой сети. Кроме того, сеть Azure нужно указать, если вы намерены выполнять восстановление размещения из Azure на локальный сайт. При восстановлении размещения требуется установить VPN-подключение между сетью Azure и локальной сетью.
   * **IP-адрес и подсеть Azure.** Для каждого сетевого адаптера выберите подсеть, к которой должна подключиться виртуальная машина Azure. Обратите внимание: если для сетевого адаптера на исходном компьютере настроено использование статического IP-адреса, вы можете указать IP-адрес для виртуальной машины Azure. Если вы не укажете статический IP-адрес, будет выделен любой доступный IP-адрес. Если указан конечный IP-адрес, который уже используется другой виртуальной машиной в Azure, произойдет сбой отработки отказа. Если для сетевого адаптера на исходном компьютере настроено использование DHCP, в качестве параметра для Azure будет использоваться DHCP.      

## <a name="step-12-create-a-recovery-plan-and-run-a-failover"></a>Шаг 12. Создание плана восстановления и выполнение отработки отказа
> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Enhanced-VMware-to-Azure-Failover/player]
>
>

Отработку отказа можно выполнить для одного компьютера или сразу для нескольких виртуальных машин, на которых выполняется одна и та же задача или рабочая нагрузка. Чтобы выполнить отработку отказа для нескольких компьютеров одновременно, следует добавить их в план восстановления.

Чтобы создать план восстановления, сделайте следующее.

1. На странице **Планы восстановления** щелкните **Add Recovery Plan** (Добавить план восстановления). Укажите сведения о плане и выберите в качестве цели **Azure** .

 ![Настройка плана восстановления](./media/site-recovery-vmware-to-azure-classic/recovery-plan1.png)
2. В окне **Выбор виртуальных машин** выберите группу защиты, а затем выберите компьютеры этой группы, которые вы намерены добавить в план восстановления.

 ![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/recovery-plan2.png)

Можно настроить план, создав группы и указав порядок выполнения отработки отказа для виртуальных машин в плане восстановления. Кроме того, можно добавить сценарии и запросы для выполняемых вручную действий. Скрипты можно создавать вручную или с помощью [модулей Runbook службы автоматизации Azure](site-recovery-runbook-automation.md). Дополнительные сведения о настройке планов восстановления см. в статье [Создание планов восстановления](site-recovery-create-recovery-plans.md).

## <a name="run-a-failover"></a>Запуск отработки отказа
Перед выполнением отработки отказа проверьте следующее.

* Убедитесь, что сервер управления работает и доступен. В противном случае произойдет сбой отработки отказа.
* Если это внеплановая отработка отказа, учтите вот что.

  * По возможности перед выполнением внеплановой отработки отказа следует выключить основные машины. В этом случае исходные и реплицированные компьютеры не будут работать одновременно. Если выполняется репликация виртуальных машин VMware, то при внеплановой отработке отказа можно указать, что служба Site Recovery должна попытаться выключить исходные компьютеры. Успешность такой попытки будет зависеть от состояния основного сайта. Если вы реплицируете физические серверы, Site Recovery не предоставляет такой возможности.
  * Внеплановая отработка отказа прекращает репликацию данных с основных компьютеров. Таким образом, никакие изменения, внесенные в данные после начала внеплановой отработки отказа, передаваться не будут.
  * Если вам нужна возможность подключаться к реплике виртуальной машины, развернутой в Azure после отработки отказа, включите подключение удаленного рабочего стола на исходном компьютере до запуска отработки отказа. Также следует разрешить в брандмауэре подключение по протоколу удаленного рабочего стола (RDP). Кроме того, потребуется разрешить RDP-подключение для общедоступной конечной точки виртуальной машины Azure после отработки отказа. Соблюдайте эти [рекомендации](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx), чтобы обеспечить работу протокола RDP после отработки отказа.

> [!NOTE]
> Для оптимальной производительности при отработке отказа в Azure убедитесь, что на защищенном компьютере установлен агент Azure. Он помогает быстрее загружать компьютер и диагностировать проблемы. Агент Azure доступен для платформ [Linux](https://github.com/Azure/WALinuxAgent) и [Windows](http://go.microsoft.com/fwlink/?LinkID=394789).
>
>

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
Запустите тестовую отработку отказа, чтобы имитировать процессы отработки отказа и восстановления в изолированной сети. Этот процесс не воздействует на рабочую среду и сохраняет штатный режим обычной репликации. Тестовая отработка отказа запускается в исходной среде одним из следующих методов.

* **Без указания сети Azure.** Если тестовая отработка отказа выполняется без сети, то она проверит запуск и правильное отображение в Azure виртуальных машин. Эти виртуальные машины не подключаются к сети Azure после отработки отказа.
* **С указанием сети Azure**. С таким типом отработки отказа проверяется, работает ли вся среда репликации должным образом и подключаются ли виртуальные машины к указанной сети.

Чтобы запустить тестовую отработку отказа, выполните следующие действия.

1. На странице **Планы восстановления** выберите нужный план и щелкните **Тестовая отработка отказа**.

 ![Выбор плана](./media/site-recovery-vmware-to-azure-classic/test-failover1.png)
2. На странице **Подтвердить тестовую отработку отказа** выберите параметр **Нет**, если для тестовой отработки отказа не нужно использовать сеть Azure, или выберите сеть, к которой подключатся тестируемые виртуальные машины после отработки отказа. Щелкните значок галочки, чтобы начать отработку отказа.

 ![Сделайте выбор](./media/site-recovery-vmware-to-azure-classic/test-failover2.png)
3. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания** .

 ![Отслеживание хода выполнения](./media/site-recovery-vmware-to-azure-classic/test-failover3.png)
4. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в области **Виртуальные машины**. Если вам нужно открыть RDP-подключение к виртуальной машине Azure, на конечной точке виртуальной машины нужно открыть порт 3389.
5. Когда операция отработки отказа дойдет до этапа **Завершено**, щелкните **Завершить тестирование**. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа.
6. Выберите пункт **Тестовая отработка отказа завершена** , чтобы автоматически очистить тестовую среду. После этого для операции тестовой отработки отказа отобразится состояние **Завершено**. Любые элементы или виртуальные машины, автоматически созданные во время тестовой отработки отказа, удаляются. Если отработка отказа выполняется более двух недель, она завершается принудительно.

### <a name="run-an-unplanned-failover"></a>Запуск незапланированной отработки отказа
Внеплановая отработка отказа инициируется в Azure. Ее можно выполнить, даже если основной сайт недоступен.

1. На странице **Планы восстановления** выберите план и последовательно щелкните **Отработка отказа** > **Внеплановая отработка отказа**.

 ![Выбор плана](./media/site-recovery-vmware-to-azure-classic/unplanned-failover1.png)
2. Если вы выполняете репликацию виртуальных машин VMware, можно попытаться выключить локальные виртуальные машины. Процесс отработки отказа применит для этого все возможные методы, но продолжит работу независимо от успешности этого этапа. Если эта операция не завершится успешно, сведения об ошибке появятся на вкладке **Задания** в области **Unplanned Failover Jobs** (Задания внеплановой отработки отказа).

 ![Команда для выключения локальных виртуальных машин](./media/site-recovery-vmware-to-azure-classic/unplanned-failover2.png)

 > [!NOTE]
 > При репликации физических серверов эта возможность недоступна. В этом случае виртуальные машины нужно выключить вручную, если это возможно.
 >
 >

3. На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (в Azure) и выберите точку восстановления, из которой следует выполнять отработку отказа. Если при настройке свойств репликации вы указали согласованность нескольких виртуальных машин, восстановление можно выполнить до последней точки восстановления, согласованной с последней версией приложения или с состоянием на момент сбоя. Можно также установить переключатель **Custom recovery point** (Пользовательская точка восстановления), чтобы выполнить восстановление до более ранней точки во времени. Щелкните значок галочки, чтобы начать отработку отказа.

 ![Проверка направления отработки отказа](./media/site-recovery-vmware-to-azure-classic/unplanned-failover3.png)
4. Дождитесь, пока завершится задание внеплановой отработки отказа. Следить за ходом отработки отказа можно на вкладке **Задания** . План восстановления продолжает выполняться, даже если во время внеплановой отработки отказа происходят ошибки. Кроме того, реплика виртуальной машины Azure отображается на портале Azure в области **Виртуальные машины**.

### <a name="connect-to-replicated-azure-virtual-machines-after-failover"></a>Подключение к реплицированным виртуальным машинам Azure после отработки отказа
Для подключения к реплицированным виртуальным машинам в Azure после отработки отказа, потребуется следующее:

- подключение к удаленному рабочему столу, активированное на основном компьютере;
- разрешение трафика RDP в брандмауэре Windows на основном компьютере;
- включение RDP в общедоступную конечную точку для виртуальной машины Azure.

Дополнительные сведения о настройке см. в статье [Troubleshooting remote desktop connection after failover using ASR](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx) (Устранение неполадок подключения к удаленному рабочему столу после отработки отказа с помощью ASR).

## <a name="deploy-additional-process-servers"></a>Развертывание дополнительных серверов обработки
Если вы решите включить в развертывание более 200 исходных компьютеров, или объем ежедневно изменяемых данных превысит 2 ТБ, для обработки такого объема трафика потребуются дополнительные серверы обработки. Чтобы настроить дополнительный сервер обработки, проверьте требования в разделе [Дополнительные серверы обработки](#additional-process-servers) и следуйте приведенным ниже инструкциям. После настройки сервера можно настроить исходные компьютеры для его использования.

### <a name="set-up-an-additional-process-server"></a>Настройка дополнительного сервера обработки
Ниже описан процесс настройки дополнительного сервера обработки.

* Запустите единый мастер, чтобы настроить сервер управления таким образом, чтобы он использовался только в качестве сервера обработки.
* Если нужно, чтобы репликацией данных управлял только новый сервер обработки, необходимо перенести на него защищенные компьютеры.

### <a name="install-the-process-server"></a>Установка сервера обработки
1. На странице **быстрого запуска** скачайте файл единой установки для установки компонента Site Recovery. Запустите программу установки.
2. На странице **Перед началом работы** выберите **Add additional process servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).

 ![Добавление сервера обработки](./media/site-recovery-vmware-to-azure-classic/add-ps1.png)
3. Завершите работу мастера так же, как и при [настройке](#step-5-install-the-management-server) первого сервера управления.
4. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес исходного сервера управления, на котором установлен сервер конфигурации, и введите парольную фразу. Если у вас нет этой парольной фразы, ее можно получить, выполнив команду **<SiteRecoveryInstallationFolder>\home\sysystems\bin\genpassphrase.exe –n** на исходном сервере управления.

 ![Сведения о сервере конфигурации](./media/site-recovery-vmware-to-azure-classic/add-ps2.png)

### <a name="migrate-machines-to-use-the-new-process-server"></a>Перенос компьютеров для использования нового сервера обработки
1. Последовательно выберите **Серверы конфигурации** > **Сервер** > *имя исходного сервера управления* > **Сведения о сервере**.

 ![Сведения о сервере](./media/site-recovery-vmware-to-azure-classic/update-process-server1.png)
2. В списке **Серверы обработки** щелкните элемент **Изменить сервер обработки** рядом с тем сервером, который требуется изменить.

 ![Обновление сервера обработки](./media/site-recovery-vmware-to-azure-classic/update-process-server2.png)
3. Последовательно выберите **Изменить сервер обработки**, **Целевой сервер обработки** и укажите новый сервер управления. Затем выберите виртуальные машины, которые будет обрабатывать новый сервер обработки. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Щелкните значок галочки, чтобы начать репликацию на новом сервере обработки.

 ![Изменение сервера обработки](./media/site-recovery-vmware-to-azure-classic/update-process-server3.png)

## <a name="vmware-permissions-for-vcenter-access"></a>Разрешения VMware для доступа к vCenter
Сервер обработки может автоматически обнаруживать виртуальные машины на сервере vCenter. Для автоматического обнаружения необходимо определить роль (Azure_Site_Recovery) на уровне vCenter, чтобы предоставить службе Site Recovery доступ к серверу vCenter. Если вам нужно только перенести компьютеры VMware в Azure и не требуется восстанавливать размещение из Azure, вам достаточно роли только для чтения. Настройте разрешения, как описано в разделе [Шаг 6. Настройка учетных данных для сервера vCenter](#step-6-set-up-credentials-for-the-vcenter-server). В следующей таблице представлены общие сведения о необходимых разрешениях ролей.

| **Роль** | **Дополнительные сведения** | **Разрешения** |
| --- | --- | --- |
| Роль Azure_Site_Recovery |Обнаружение виртуальной машины VMware |Назначьте серверу vCenter такие права:<br/><br/>Хранилище данных: выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/>Сеть: назначение сети<br/><br/>Ресурс: назначение виртуальной машины пулу ресурсов, миграция остановленной виртуальной машины, миграция работающей виртуальной машины<br/><br/>Задачи: создание задач, обновление задач<br/><br/>Виртуальная машина > настройка<br/><br/>Виртуальная машина > взаимодействие > ответ на вопрос, подключение устройства, настройка компакт-диска, настройка гибкого диска, отключение, включение, установка средств VMware<br/><br/>Виртуальная машина > инвентаризация > создание, регистрация, отмена регистрации<br/><br/>Виртуальная машина > подготовка > разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/>Виртуальная машина > моментальные снимки > удаление моментальных снимков |
| Роль пользователя vCenter |Обнаружение виртуальной машины VMware, отработка отказа без выключения исходной виртуальной машины |Назначьте серверу vCenter такие права:<br/><br/>Объект центра обработки данных > распространение на дочерний объект, роль только для чтения (Read-only) <br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных. Если нужно ограничить доступ, назначьте дочерним объектам (узлы ESX, хранилища данных, виртуальные машины и сети) роль **Нет доступа** с параметром **Propagate to child** (Распространить на дочерний объект). |
| Роль пользователя vCenter |Отработка отказа и восстановление размещения |Назначьте серверу vCenter такие права:<br/><br/>Объект центра обработки данных — Распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.  Если нужно ограничить доступ, назначьте дочерним объектам (узлы ESX, хранилища данных, виртуальные машины и сети) роль **Нет доступа** с параметром **Propagate to child** (Распространить на дочерний объект). |

## <a name="third-party-software-notices-and-information"></a>Уведомления и сведения о стороннем программном обеспечении
<!--Do Not Translate or Localize-->

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).  Microsoft is the not original author of the Third Party Code.  The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only.  This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.  

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.

## <a name="next-steps"></a>Дальнейшие действия
Из этой статьи [о восстановлении размещения](site-recovery-failback-azure-to-vmware-classic.md) вы узнаете, как перенести компьютеры, для которых выполнена отработка отказа в Azure, обратно в локальную среду.

