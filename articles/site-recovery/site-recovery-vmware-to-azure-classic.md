<properties
	pageTitle="Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery | Microsoft Azure"
	description="В этой статье описывается, как развернуть Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware и физических серверов Windows и Linux в Azure."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="03/15/2016"
	ms.author="raynew"/>

# Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-vmware-to-azure.md)
- [Классический портал](site-recovery-vmware-to-azure-classic.md)
- [Классический портал (прежняя версия)](site-recovery-vmware-to-azure-classic-legacy.md)


Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## Обзор

В этой статье описывается, как:

- **Репликация виртуальных машин VMware**. Разверните службу Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware в службе хранилища Azure.
- **Репликация физических серверов в Azure**. Разверните службу Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных физических серверов Windows и Linux в Azure.

>[AZURE.NOTE] В этой статье рассматривается репликация в Azure. Если нужно выполнить репликацию виртуальных машин VMware или физических серверов Windows и Linux в дополнительный центр обработки данных, следуйте инструкциям в [этой статье](site-recovery-vmware-to-vmware.md).

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Расширенное развертывание

Эта статья содержит указания для расширенного развертывания на классическом портале Azure. Для всех новых развертываний рекомендуется использовать эту версию. Если развертывание выполнено с использованием устаревшей версии, рекомендуется перейти к новой версии. См. [дополнительные сведения](site-recovery-vmware-to-azure-classic-legacy.md##migrate-to-the-enhanced-deployment) о переходе.

Расширенное развертывание — это крупное обновление. Ниже приведена сводка усовершенствований.

- **Отсутствие виртуальных машин инфраструктуры в Azure.** Репликация данных выполняется непосредственно в учетную запись хранения Azure. Кроме того, для репликации и отработки отказа не нужно устанавливать какие-либо виртуальные машины инфраструктуры (сервер конфигурации, главный целевой сервер), как в устаревшей модели развертывания.  
- **Единая установка**. Одна установка обеспечивает простоту настройки и масштабируемость локальных компонентов.
- **Безопасное развертывание**. Весь трафик зашифрован, а данные управления репликацией отправляются через порт HTTPS 443.
- **Точки восстановления**. Поддержка точек восстановления после сбоя и точек восстановления, согласованных с приложением, для сред Windows и Linux и поддержка согласованных конфигураций с одной и несколькими виртуальными машинами.
- **Тестовая отработка отказа**. Поддержка тестовой отработки отказа в Azure, которая не прерывает рабочие процессы, не влияет на рабочую среду и ход выполнения репликации.
- **Внеплановая отработка отказа**. Поддержка внеплановой отработки отказа в Azure с возможностью предварительного автоматического выключения виртуальных машин.
- **Восстановления размещения**. Встроенное восстановление размещения с репликацией только изменений на локальный сайт.
- **vSphere 6.0**. Ограниченная поддержка развертываний VMware vSphere 6.0.


## Как служба Site Recovery позволяет защитить виртуальные машины и физические серверы?


- Администраторы VMware могут настроить удаленную защиту корпоративных рабочих нагрузок и приложений на виртуальных машинах VMware в Azure. Администраторы серверов могут выполнить репликацию физических локальных серверов Windows и Linux в Azure.
- Консоль Azure Site Recovery обеспечивает настройку процессов репликации, отработки отказа и восстановления и управления ими в одном месте.
- При репликации виртуальных машин VMware, которыми управляет сервер vCenter, служба Site Recovery может автоматически обнаруживать их. Если виртуальные машины находятся на узле ESXi, служба Site Recovery обнаруживает их там.
- Azure Site Recovery позволяет выполнять простую отработку отказа из локальной инфраструктуры в Azure и восстановление размещения (восстановление) с переносом из Azure на серверы виртуальных машин VMware на локальном сайте.
- С помощью этой службы можно настраивать планы восстановления, в которых группируются рабочие нагрузки приложений, размещенные на уровнях в нескольких компьютерах. Для них можно выполнить отработку отказа. Site Recovery реализует согласованность нескольких виртуальных машин, обеспечивающую совместное восстановление компьютеров с одинаковыми рабочими нагрузками до согласованной точки данных.

## Архитектура сценария

Компоненты сценария:

- **Локальный сервер управления**. На сервере управления выполняются такие компоненты Site Recovery:
	- **Сервер конфигурации** — координирует обмен данными и управляет процессами репликации и восстановления данных.
	- **Сервер обработки** — выступает в качестве шлюза репликации. Он получает данные с защищенных исходных компьютеров, оптимизирует их путем кэширования, сжатия и шифрования и отправляет данные репликации в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.
	- **Главный целевой сервер** — обрабатывает данные репликации при восстановлении размещения с переносом из Azure. Кроме того, чтобы выполнить масштабирование развертывания, можно развернуть сервер управления, который выполняет роль только сервера обработки.
- **Служба Mobility Service**. Этот компонент развертывается на каждом компьютере (виртуальной машине VMware или физическом сервере), для которого требуется выполнить репликацию в Azure. Она фиксирует операции записи данных на компьютере и перенаправляет их на сервер обработки.
- **Azure**. Для выполнения репликации и отработки отказа не нужно создавать виртуальные машины Azure. Служба Site Recovery выполняет управление данными, а репликация данных выполняется непосредственно в службу хранилища Azure. Реплицированные виртуальные машины Azure развертываются автоматически только при отработке отказа в Azure. Тем не менее если требуется выполнить отработку отказа с Azure на локальный сайт, понадобится настроить виртуальную машину Azure таким образом, чтобы она выполняла роль сервера обработки.


На схеме показано взаимодействие этих компонентов.

![архитектура](./media/site-recovery-vmware-to-azure-classic/architecture.png)

## Планирование загрузки

При планировании ресурсов следует учесть перечисленные ниже моменты.

- **Исходная среда**. Планирование ресурсов или требования к инфраструктуре и исходному компьютеру VMware.
- **Сервер управления**. Планирование для локальных серверов управления, на которых выполняются компоненты Site Recovery.
- **Пропускная способность сети из исходной среды в целевую**. Планирование пропускной способности сети, необходимой для репликации между исходной средой и Azure.

### Рекомендации для исходной среды

- **Максимальный объем ежедневно изменяемых данных**. Защищенный компьютер может использовать только один сервер обработки, а объем ежедневно изменяемых данных на одном сервере обработки может составлять не более 2 ТБ. В связи с этим 2 ТБ — максимальный объем ежедневно изменяемых данных, поддерживаемый защищенным компьютером.
- **Максимальная пропускная способность**. Реплицированный компьютер может принадлежать к одной учетной записи хранения в Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Рекомендуется не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если есть исходный компьютер с 5 дисками, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером 8 КБ), этот показатель не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для источника на 20 000.


### Рекомендации для сервера управления

На сервере управления выполняются компоненты Site Recovery, отвечающие за оптимизацию и репликацию данных, а также управление ими. Он должен поддерживать объем ежедневно изменяемых данных во всех рабочих нагрузках, выполняющихся на защищенных компьютерах, и обладать пропускной способностью, достаточной для обеспечения непрерывной репликации данных в службу хранилища Azure. В частности:

- Сервер обработки получает данные репликации с защищенных компьютеров и оптимизирует их путем кэширования, сжатия и шифрования перед отправкой в Azure. Для выполнения этих задач сервер управления должен располагать достаточными ресурсами.
- Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, рекомендуется установить отдельный диск кэша объемом 600 ГБ и более. При развертывании можно настроить кэш на любом диске объемом не менее 5 ГБ. Но рекомендуется настраивать не менее 600 ГБ.
- Рекомендуется разместить сервер управления в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.

В следующей таблице приведены рекомендации по размерам для сервера управления.

**ЦП сервера управления** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) | 16 ГБ | 300 ГБ | 500 ГБ или менее | Разверните сервер управления с использованием этих параметров для репликации не более 100 компьютеров.
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) | 18 ГБ | 600 ГБ | От 500 ГБ до 1 ТБ | Разверните сервер управления с использованием этих параметров для репликации 100–150 компьютеров.
16 виртуальных ЦП (2 сокета * 8 ядер с частотой 2,5 ГГц) | 32 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Разверните сервер управления с использованием этих параметров для репликации 150–200 компьютеров.
Разверните другой сервер обработки | | | Более 2 ТБ | Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ.

Описание

- Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
- Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

### Пропускная способность сети из исходной среды в целевую
Вычислите пропускную способность, требуемую для начальной репликации и разностной репликации, с помощью [планировщика ресурсов](site-recovery-capacity-planner.md).

#### Регулирование пропускной способности, используемой для репликации

Трафик VMware, реплицируемый в Azure, проходит через определенный сервер обработки. Вот как можно регулировать пропускную способность, доступную для репликации с помощью службы Site Recovery, на этом сервере:

1. На главном сервере управления или на сервере управления, на котором выполняются дополнительные подготовленные серверы обработки, откройте оснастку MMC для службы архивации Microsoft Azure. По умолчанию для службы архивации Microsoft Azure создается ярлык на рабочем столе. Кроме того, ее можно найти в папке C:\\Program Files\\Microsoft Azure Recovery Services Agent\\bin\\wabadmin.
2. В оснастке щелкните **Изменить свойства**.

	![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure-classic/throttle1.png)

3. На вкладке **Регулирование** укажите пропускную способность, которую можно использовать для репликации с помощью Site Recovery и соответствующего планирования.

	![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure-classic/throttle2.png)

При необходимости можно также установить регулирование с помощью PowerShell. Ниже приведен пример:

    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth (512*1024) -NonWorkHourBandwidth (2048*1024)

#### Максимальное использование пропускной способности
Чтобы увеличить пропускную способность, используемую для репликации службой Azure Site Recovery, необходимо изменить раздел реестра.

Этот раздел управляет количеством потоков на диск репликации, которые используются при репликации.

    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\UploadThreadsPerVM

 В сети с значительным избыточным резервом для этого раздела реестра необходимо изменить значения по умолчанию. Поддерживается не более 32 потоков.


См. [дополнительные сведения](site-recovery-capacity-planner.md) о подробном планировании ресурсов.

### Дополнительные серверы обработки

Если необходимо защитить более 200 компьютеров или объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки можно добавить дополнительные серверы. Для масштабирования можно выполнить следующее.

- Увеличить число серверов управления. Например, с помощью двух серверов управления можно защитить до 400 компьютеров.
- Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера управления (или вместе с ним).

В этой таблице описан следующий сценарий.

- Настраивается исходный сервер управления, который будет использоваться только в качестве сервера конфигурации.
- Настраивается дополнительный сервер обработки.
- Настраиваются защищенные виртуальные машины для использования дополнительного сервера обработки.
- Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

**Исходный сервер управления**<br/><br/> (сервер конфигурации) | **Дополнительный сервер обработки**| **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 16 ГБ | 4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц), память объемом 8 ГБ | 300 ГБ | 250 ГБ или менее | Можно выполнить репликацию до 85 компьютеров.
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 16 ГБ | 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 12 ГБ | 600 ГБ | От 250 ГБ до 1 ТБ | Можно выполнить репликацию 85–150 компьютеров.
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), память объемом 18 ГБ | 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), память объемом 24 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Можно выполнить репликацию 150–225 компьютеров.


Способ масштабирования серверов будет зависеть от параметров модели увеличения масштаба и развертывания. Вы можете увеличить масштаб, развернув несколько современных серверов управления и обработки, или выполнить развертывание, развернув несколько серверов с меньшим объемом ресурсов. Например, чтобы защитить 220 компьютеров, можно выполнить одно из следующих указаний:

- Настройте исходный сервер управления с 12 виртуальными ЦП и памятью объемом 18 ГБ, дополнительный сервер обработки с 12 виртуальными ЦП и памятью объемом 24 ГБ и защищенные компьютеры для использования только дополнительного сервера обработки.
- Кроме того, можно настроить два сервера управления (8 виртуальных ЦП, 16 ГБ ОЗУ в каждом), два дополнительных сервера обработки (8 виртуальных ЦП в одном и 4 виртуальных ЦП в другом для обработки 220 (135 + 85) компьютеров) и защищенные компьютеры для использования только дополнительных серверов обработки.


[Выполните эти инструкции](#deploy-additional-process-servers), чтобы настроить дополнительный сервер обработки.

## Перед началом развертывания

В таблицах приведены предварительные требования для развертывания в этом случае.


### Предварительные требования Azure

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Учетная запись Azure**| Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). См. [дополнительные сведения](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery.
**Служба хранилища Azure** | Для хранения реплицируемых данных потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа. <br/><br/> Необходима [учетная запись хранения для геоизбыточного хранилища класса Standard](../storage/storage-redundancy.md#geo-redundant-storage). Она должна находиться в том же регионе, что и служба Site Recovery, и быть связана с той же подпиской. Обратите внимание, что репликация для учетных записей хранения для хранилища класса Premium в настоящее время не поддерживается и не должна использоваться. <br/><br/> Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов. [Узнайте больше ](../storage/storage-introduction.md) о хранилище Azure. <br/><br/>
**Сеть Azure** | Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна находиться в том же регионе, что и хранилище Site Recovery. <br/><br/> Обратите внимание: чтобы выполнить восстановление размещения после отработки отказа в Azure, потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.


### Предварительные требования для локальной среды

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Сервер управления** | Необходимо установить сервер Windows 2012 R2, выполняющийся на виртуальной машине или физическом сервере. На этот сервер управления устанавливаются все локальные компоненты Site Recovery. <br/><br/> Рекомендуется развернуть сервер как высокодоступную виртуальную машину VMware. Восстановление размещения на локальном сайте с переносом из Azure всегда будет выполняться на виртуальные машины VMware независимо от того, для чего выполняется отработка отказа — для виртуальных машин или физических серверов. Если вы не настроите сервер управления в качестве виртуальной машины VMware, то для получения трафика восстановления размещения потребуется отдельный главный целевой сервер в роли виртуальной машины VMware.<br/><br/>Сервер не должен быть контроллером домена.<br/><br/>Серверу должен быть назначен статический IP-адрес.<br/><br/>Имя узла сервера должно содержать не более 15 символов.<br/><br/>Для операционной системы нужно настроить только английский язык.<br/><br/>Серверу управления требуется доступ к Интернету.<br/><br/>Необходимо настроить исходящий доступ с сервера следующим образом: временный доступ через порт HTTP 80 на время установки компонентов Site Recovery (для скачивания MySQL); постоянный исходящий доступ через порт HTTPS 443 для управления репликацией и постоянный исходящий доступ через порт HTTPS 9443 для трафика репликации (этот порт можно изменить).<br/><br/>Убедитесь, что с сервера управления можно получить доступ к следующим URL-адресам: <br/>- *.hypervrecoverymanager.windowsazure.com<br/>- *.accesscontrol.windows.net<br/>- *.backup.windowsazure.com<br/>- *.blob.core.windows.net<br/>- *.store.core.windows.net<br/>-https://www.msftncsi.com/ncsi.txt<br/>- [ https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi](https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi "https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi")<br/><br/>При использовании на сервере правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают взаимодействие с Azure. Необходимо разрешить [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) и протокол HTTPS (433). Требуется поместить IP-адреса для региона Azure подписки и для региона "Запад США" в белый список. Для скачивания MySQL используется URL-адрес [https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi](https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi "https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi").
**Узел VMware vCenter/ESXi** | Требуется одна или несколько низкоуровневых оболочек VMware vSphere ESX или ESXi, управляющих виртуальными машинами VMware, на которых установлена низкоуровневая оболочка ESX или ESXi версии 6.0, 5.5 или 5.1 с последними обновлениями.<br/><br/> Для управления узлами ESXi рекомендуется развернуть сервер VMware vCenter. На нем нужно установить vCenter версии 6.0 или 5.5 с последними обновлениями.<br/><br/>Обратите внимание, что Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища. Поддержка Site Recovery предоставляется только для компонентов, доступных в версии 5.5.
**Защищенные компьютеры** | **AZURE**<br/><br/>. Компьютеры, которые необходимо защитить, должны отвечать [предварительным требованиям Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements) для создания виртуальных машин Azure.<br><br/>Если нужно подключаться к виртуальным машинам Azure после отработки отказа, следует разрешить подключения к удаленному рабочему столу в локальном брандмауэре.<br/><br/>Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ). При наличии дисков объемом более 1 ТБ можно использовать репликацию базы данных, например с помощью SQL Server AlwaysOn или Oracle Data Guard.<br/><br/>Гостевые кластеры общего диска не поддерживаются. При кластерном развертывании можно использовать репликацию базы данных, например SQL Server AlwaysOn или Oracle Data Guard.<br/><br/>Загрузка с использованием интерфейса UEFI или EFI не поддерживается.<br/><br/>Имена компьютеров должны содержать от 1 до 63 символов (можно использовать буквы, цифры и дефисы). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. После настройки защиты компьютера можно изменить имя Azure.<br/><br/>**Виртуальные машины VMware**<br/><br>Потребуется установить VMware vSphere PowerCLI 6.0 на сервере управления (на сервере конфигурации).<br/><br/>На виртуальных машинах VMware, которые нужно защитить, следует установить и запустить средства VMware.<br/><br/>Если на исходной виртуальной машине есть объединение сетевых карт, то после отработки отказа в Azure оно преобразуется в одну сетевую карту.<br/><br/>Если на защищенных виртуальных машинах установлен диск iSCSI, то при отработке отказа виртуальной машины в Azure служба Site Recovery преобразует его в VHD-файл. Если виртуальная машина Azure может получить доступ к целевому объекту iSCSI, она подключится к нему и обнаружит два диска — VHD на виртуальной машине Azure и исходный диск iSCSI. В этом случае необходимо отключить целевой объект iSCSI, отображающийся в виртуальной машине Azure, для которой выполнена отработка отказа.<br/><br/>См. [дополнительные сведения](#vmware-permissions-for-vcenter-access) о разрешениях пользователей VMware, необходимых для Site Recovery.<br/><br/> **КОМПЬЮТЕРЫ WINDOWS SERVER (на виртуальной машине VMware или физическом сервере)**<br/><br/>На сервере должна быть установлена поддерживаемая 64-разрядная операционная система: Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с пакетом обновления 1 (или более поздней версии).<br/><br/>Операционную систему нужно установить на диске C:\\. В качестве диска операционной системы следует использовать базовый диск Windows (не следует устанавливать ОС на динамическом диске Windows).<br/><br/>Для компьютеров под управлением Windows Server 2008 R2 следует установить .NET Framework 3.5.1.<br/><br/>Для принудительной установки службы Mobility Service на серверах Windows необходимо указать учетную запись администратора (локальный администратор на компьютере Windows). Если предоставленная учетная запись не является учетной записью домена, вам потребуется отключить контроль доступа удаленных пользователей на локальном компьютере. См. [дополнительные сведения](#install-the-mobility-service-with-push-installation).<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения Site Recovery повторно использует диск RDM, если исходная виртуальная машина и диск RDM доступны. Если они недоступны, при восстановлении размещения Site Recovery создаст новый VMDK-файл для каждого диска.<br/><br/>**КОМПЬЮТЕРЫ LINUX**<br/><br/>Потребуется поддерживаемая 64-разрядная операционная система: Red Hat Enterprise Linux 6.7, Centos 6.5, 6.6, 6.7, Oracle Enterprise Linux 6.4, 6.5 с ядром, совместимым с Red Hat, или Unbreakable Enterprise Kernel Release 3 (UEK3), SUSE Linux Enterprise Server 11 с пакетом обновления SP3.<br/><br/>Файлы /etc/hosts на защищенных компьютерах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров. <br/><br/>Чтобы иметь возможность подключаться к виртуальным машинам Azure под управлением Linux после отработки отказа с помощью клиента SSH, убедитесь, что на защищенном компьютере настроен автоматический запуск службы SSH при загрузке системы и что правила брандмауэра разрешают SSH-подключение к этой службе.<br/><br/>Защиту можно включить только для компьютеров Linux со следующими характеристиками хранилища: файловая система EXT3, ETX4, ReiserFS или XFS, многомаршрутный модуль сопоставления программного обеспечения на устройстве (multipath), диспетчер томов LVM2. Физические серверы с хранилищем контроллера HP CCISS не поддерживаются. Файловая система ReiserFS поддерживается только на сервере SUSE Linux Enterprise Server 11 с пакетом обновления SP3.<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения для компьютеров Linux служба Site Recovery не использует диск RDM повторно. Вместо этого она создает новый VMDK-файл для каждого соответствующего диска RDM.

Только для виртуальных машин Linux — убедитесь, что параметр disk.enableUUID в конфигурации виртуальной машины в VMWare установлен в true. Если этого параметра нет, добавьте его. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK. Также обратите внимание, что если не указать этот параметр, то при восстановлении после сбоя будет произведена полная загрузка, даже если виртуальная машина доступна в локальной среде. Указание этого параметра гарантирует, что при восстановлении после сбоя будут переданы только небольшие изменения.

## Шаг 1. Создание хранилища

1. Выполните вход на [Портал управления](https://manage.windowsazure.com/).
2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.
3. Выберите **Создать** > **Быстрое создание**.
4. В поле **Имя** введите понятное имя для идентификации хранилища.
5. В поле **Область** выберите географический регион для хранилища архивации. Чтобы проверить поддерживаемые регионы, см. географическую доступность в разделе [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/) (Информация о ценах на Azure Site Recovery).
6. Щелкните **Создать хранилище**. ![Новое хранилище](./media/site-recovery-vmware-to-azure-classic/quick-start-create-vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. Хранилище будет указано как **Активное** на главной странице **Службы восстановления**.

## Шаг 2. Настройка сети Azure

Настройте сеть Azure, чтобы виртуальные машины Azure были подключены к сети после отработки отказа и восстановление размещения на локальном сайте выполнялось должным образом.

1. На портале Azure щелкните **Создать виртуальную сеть** и укажите имя сети. диапазон IP-адресов и имя подсети.
2. Для восстановления размещения потребуется добавить к сети подключение VPN или ExpressRoute. Это можно сделать даже после отработки отказа.

См. [дополнительные сведения](../virtual-network/virtual-networks-overview.md) о сетях Azure.

## Шаг 3. Установка компонентов VMware

Если нужно выполнить репликацию виртуальных машин VMware, установите на сервере управления компоненты VMware, как указано ниже.

1. [Скачайте](https://developercenter.vmware.com/tool/vsphere_powercli/6.0) и установите VMware vSphere PowerCLI 6.0.
2. Перезапустите сервер.


## Шаг 4. Скачивание регистрационного ключа хранилища

1. На сервере управления откройте консоль Site Recovery в Azure. На странице **Службы восстановления** щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Значок быстрого запуска](./media/site-recovery-vmware-to-azure-classic/quick-start-icon.png)

2. На странице **Быстрый запуск** последовательно щелкните **Prepare Target Resources** (Подготовка целевых ресурсов) > **Скачать регистрационный ключ**. Файл регистрации создается автоматически. Ключ действителен в течение пяти дней после создания.


## Шаг 5. Установка сервера управления
> [AZURE.TIP] Убедитесь, что с сервера управления можно получить доступ к таким URL-адресам:
>
- **.hypervrecoverymanager.windowsazure.com
- **.accesscontrol.windows.net
- **.backup.windowsazure.com
- **.blob.core.windows.net
- **.store.core.windows.net
- https://dev.mysql.com/get/archives/mysql-5.5/mysql-5.5.37-win32.msi
- https://www.msftncsi.com/ncsi.txt




[AZURE.VIDEO enhanced-vmware-to-azure-setup-registration]

1. На странице **Быстрый запуск** скачайте файл единой установки на сервер.
2. Запустите файл установки, чтобы начать установку в мастере единой установки Site Recovery.
3. На странице **Перед началом работы** установите переключатель **Install the configuration server and process server** (Установка сервера конфигурации и сервера обработки). В зависимости от размера развертывания позже могут потребоваться дополнительные серверы обработки. Но они не нужны при первой установке этого развертывания.

	![Перед началом работы](./media/site-recovery-vmware-to-azure-classic/combined-wiz1.png)

4. В окне **Установка программного обеспечения сторонних поставщиков** щелкните **Принимаю**, чтобы скачать и установить MySQL.

	![Стороннее программное обеспечение](./media/site-recovery-vmware-to-azure-classic/combined-wiz2.png)

5. На странице **Параметры браузера** укажите параметры, с которыми установленный на сервере поставщик будет подключаться к Azure Site Recovery через Интернет.

	- Чтобы поставщик подключался напрямую, установите переключатель **Connect directly without a proxy** (Прямое подключение без прокси-сервера).
	- Чтобы подключаться с помощью прокси-сервера, который уже настроен на компьютере, установите переключатель **Connect with existing proxy settings** (Подключение с параметрами существующего прокси-сервера).
	- Если для существующего прокси-сервера требуется проверка подлинности или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера).
	- При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
	- При использовании прокси-сервера должен поддерживаться доступ к следующим URL-адресам:

	![Брандмауэр](./media/site-recovery-vmware-to-azure-classic/combined-wiz3.png)

7. На странице **Проверка предварительных требований** программа установки выполняет проверку предварительных требований на сервере.

	![Предварительные требования](./media/site-recovery-vmware-to-azure-classic/combined-wiz4.png)

>[AZURE.WARNING] Если при проверке предварительных требований для **синхронизации с мировым временем** появится предупреждение, убедитесь, что системное время и время часового пояса совпадают.

![TimeSyncIssue](./media/site-recovery-vmware-to-azure-classic/time-sync-issue.png)

8. На странице **Конфигурация MySQL** создайте учетные данные для входа в экземпляр сервера MySQL. Можно указать такие специальные символы: "\_", "!", "@", "$", "\", "%".

	![MySQL](./media/site-recovery-vmware-to-azure-classic/combined-wiz5.png)

9. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. Если нужно, программа установки проверяет, установлен ли компонент PowerCLI 6.0.

	![MySQL](./media/site-recovery-vmware-to-azure-classic/combined-wiz6.png)

10. На странице **Расположение установки** выберите место для установки двоичных файлов и хранения кэша. Рекомендуется, чтобы на диске кэша было не менее 600 ГБ свободного места.

	![Расположение установки](./media/site-recovery-vmware-to-azure-classic/combined-wiz7.png)

11. На странице **Выбор сети** укажите прослушиватель (сетевой адаптер и порт SSL), через который сервер будет отправлять и получать данные репликации. Можно изменить порт по умолчанию (9443). Помимо него, на сервере будет открыт порт 443 для отправки и получения данных об оркестрации репликации. Не следует использовать порт 443 для данных репликации.


	![Выбор сети](./media/site-recovery-vmware-to-azure-classic/combined-wiz8.png)

12. На странице **Регистрация** найдите и выберите регистрационный ключ, скачанный из хранилища.

	![Регистрация](./media/site-recovery-vmware-to-azure-classic/combined-wiz9.png)

13.  Просмотрите информацию на странице **Сводка**.

	![Сводка](./media/site-recovery-vmware-to-azure-classic/combined-wiz10.png)
>[AZURE.WARNING] Необходимо настроить прокси агента служб восстановления Microsoft Azure. После завершения установки запустите приложение с именем "Оболочка служб восстановления Microsoft Azure" из меню "Пуск" Windows. В открывшемся командном окне выполните следующий набор команд, чтобы настроить параметры прокси-сервера.
>
	$pwd = ConvertTo-SecureString -String ProxyUserPassword Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumb – ProxyUserName domain\\username -ProxyPassword $pwd net stop obengine net start obengine



### Запуск установки из командной строки

Единый мастер можно также запустить из командной строки. Вот как это можно сделать:

    UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]

Описание

- /ServerMode. (Обязательный параметр.) Указывает, какие серверы следует устанавливать: сервер конфигурации и обработки или только сервер обработки (используется для установки дополнительных серверов обработки). Входные значения: CS, PS.
- InstallDrive. (Обязательный параметр.) Указывает папку для установки компонентов.
- /MySQLCredFilePath. (Обязательный параметр.) Указывает путь к файлу, в котором хранятся учетные данные сервера MySQL. Получите шаблон, чтобы создать его.
- /VaultCredFilePath. (Обязательный параметр.) Расположение файла с учетными данными хранилища.
- /EnvType. (Обязательный параметр.) Тип установки. Значения: VMware, NonVMware.
- /PSIP и /CSIP. (Обязательный параметр.) IP-адреса сервера обработки и сервера конфигурации.
- /PassphraseFilePath. (Обязательный параметр.) Расположение файла с парольной фразой.
- /ByPassProxy. необязательный параметр. Указывает, что сервер управления подключается к Azure без использования прокси-сервера.
- /ProxySettingsFilePath. необязательный параметр. Указывает параметры пользовательского прокси-сервера (прокси-сервер по умолчанию на сервере, который требует проверки подлинности, или пользовательский прокси-сервер).




## Шаг 6. Настройка учетных данных для сервера vCenter

> [AZURE.VIDEO enhanced-vmware-to-azure-discovery]

Сервер обработки может автоматически обнаруживать виртуальные машины VMware, которыми управляет сервер vCenter. Для этого службе Site Recovery нужны учетная запись и учетные данные, с помощью которых можно получить доступ к серверу vCenter. Они не нужны при репликации только физических серверов.

Это можно сделать указанным ниже образом.

1. На сервере vCenter создайте роль (**Azure\_Site\_Recovery**) на уровне vCenter с [требуемыми разрешениями](#vmware-permissions-for-vcenter-access).
2. Назначьте роль **Azure\_Site\_Recovery** пользователю vCenter.

	>[AZURE.NOTE] Используя учетную запись vCenter с ролью только для чтения, можно выполнять отработку отказа без выключения исходных защищенных компьютеров. Если их следует выключить, нужна роль Azure\_Site\_Recovery. Обратите внимание, что если нужно только перенести виртуальные машины из VMware в Azure и не нужно выполнять восстановление размещения, роли только для чтения достаточно.

3. Чтобы добавить учетную запись, откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
2. На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.

	![Добавление учетной записи](./media/site-recovery-vmware-to-azure-classic/credentials1.png)

3. В окне **Сведения об учетной записи** добавьте учетные данные, которые можно использовать для доступа к серверу vCenter. Обратите внимание, что имя учетной записи может отобразиться на портале более, чем через 15 минут. Чтобы выполнить обновление немедленно, на вкладке **Серверы конфигурации** нажмите кнопку "Обновить".

	![Сведения](./media/site-recovery-vmware-to-azure-classic/credentials2.png)

## Шаг 7. Добавление серверов vCenter и узлов ESXi

При репликации виртуальных машин VMware необходимо добавить сервер vCenter (или узел ESXi).

1. Последовательно выберите вкладки **Серверы** и **Серверы конфигурации**, выберите сервер конфигурации и щелкните **Добавить vCenter Server**.

	![vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter1.png)

2. Добавьте дополнительные сведения о сервере vCenter или узле ESXi, имя учетной записи, указанной для доступа к серверу vCenter на предыдущем шаге, и сервер обработки, который будет использоваться для обнаружения виртуальных машин VMware, управляемых сервером vCenter. Обратите внимание, что сервер vCenter или узел ESXi должен находиться в той же сети, что и сервер, на котором установлен сервер обработки.

	>[AZURE.NOTE] При добавлении сервера vCenter или узла ESXi с учетной записью без прав администратора на сервере vCenter или сервере узла убедитесь, что для учетных записей vCenter или ESXi активированы права центра обработки данных, хранилища данных, папки, Jost, сети, ресурса, виртуальной машины и распределенного коммутатора vSphere. Кроме того, для сервера vCenter должны быть активированы права представлений хранилища.

	![vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter2.png)

3. Когда обнаружение завершится, сервер vCenter будет указан на вкладке **Серверы конфигурации**.

	![vCenter](./media/site-recovery-vmware-to-azure-classic/add-vcenter3.png)


## Шаг 8. Создание группы защиты

> [AZURE.VIDEO enhanced-vmware-to-azure-protection]


Группы защиты — это логические группы виртуальных машин или физических серверов, которые требуется защитить, используя те же параметры защиты. Параметры, установленные для группы защиты, будут применяться ко всем виртуальным или физическим машинам, добавленным в группу.

1. Откройте вкладку **Защищенные элементы** > **Группа защиты** и щелкните ссылку для добавления группы защиты.

	![Создание группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups1.png)

2. На странице **Задать настройки группы защиты** введите имя для группы и в поле **Из** выберите сервер конфигурации, на котором требуется создать группу. В поле **Цель** укажите Azure.

	![Параметры группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups2.png)

3. На странице **Укажите параметры репликации** настройте параметры репликации, которые будут использоваться для всех компьютеров в группе.

	![Репликация группы защиты](./media/site-recovery-vmware-to-azure-classic/protection-groups3.png)

	- **Согласование с несколькими виртуальными машинами**. При включении этого параметра для компьютеров в группе защиты создаются общие точки восстановления, соответствующие приложениям. Этот параметр имеет самое большое значение, когда на всех компьютерах в группе защиты выполняется одна и та же рабочая нагрузка. Все компьютеры будут восстановлены до одной точки данных. Этот параметр доступен при репликации виртуальных машин VMware или физических серверов Windows или Linux.
	- **Пороговое значение RPO**. Задает целевую точку восстановления (RPO). При превышении значением непрерывной репликации защиты данных заданного порогового значения RPO будут создаваться оповещения.
	- **Хранение точки восстановления**. Определяет период хранения. Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
	- **Периодичность моментальных снимков с согласованием приложений**. Указывает, насколько часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями.

Если щелкнуть значок с галочкой, будет создана группа защиты с указанным именем. Кроме того, создается вторая группа защиты с именем protection-group-name-Failback. Эта группа защиты используется при восстановлении размещения на локальном сайте после отработки отказа с переносом в Azure. Создание групп защиты можно отслеживать на странице **Защищенные элементы**.

## Шаг 9. Установка службы Mobility Service

При включении защиты для виртуальных машин и физических серверов нужно прежде всего установить службу Mobility Service. Это можно сделать двумя способами.

- Автоматическая принудительная установка службы на каждом компьютере с сервера обработки. Обратите внимание, что при добавлении в группу защиты компьютеров, на которых уже выполняется соответствующая версия службы Mobility Service, принудительная установка не выполняется.
- Автоматическая принудительная установка службы с помощью корпоративных средств, таких как WSUS или System Center Configuration Manager. Перед этим убедитесь, что сервер управления настроен.
- Установка вручную на каждом компьютере, который необходимо защитить. Перед этим убедитесь, что сервер управления настроен.


### Принудительная установка службы Mobility Service

При добавлении компьютеров в группу защиты служба Mobility автоматически принудительно устанавливается на каждый компьютер сервером обработки.


#### Подготовка к принудительной установке на компьютерах Windows

Ниже описан процесс подготовки компьютеров Windows для автоматической установки службы Mobility Service сервером обработки.

1.  Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Ей следует назначить права администратора (локального администратора или администратора домена). Учтите, что эти учетные данные используются только для принудительной установки службы Mobility Service.

	>[AZURE.NOTE] Если учетная запись домена не используется, на локальном компьютере потребуется отключить контроль удаленного доступа пользователей. Для этого в разделе реестра HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System добавьте запись LocalAccountTokenFilterPolicy DWORD и задайте для нее значение 1. Чтобы добавить запись в реестр из интерфейса командной строки, откройте командную строку или PowerShell и введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**.

2.  На компьютере, который необходимо защитить, в брандмауэре Windows выберите **Allow an app or feature through Firewall** (Разрешение обмена данными с приложением или компонентом в брандмауэре) и установите флажки **Общий доступ к файлам и принтерам** и **Инструментарий управления Windows**. Для компьютеров, принадлежащих домену, можно настроить политику брандмауэра с помощью объекта групповой политики.

	![Параметры брандмауэра](./media/site-recovery-vmware-to-azure-classic/mobility1.png)

2. Добавьте созданную учетную запись:

	- Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
	- На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
	- Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении компьютера в группу защиты.


#### Подготовка к принудительной установке на серверах Linux

1.	Убедитесь, что компьютер Linux, который необходимо защитить, соответствует всем [предварительным требованиям для локальной среды](#on-premises-prerequisites). Убедитесь, что между компьютером, который нужно защитить, и сервером управления, на котором выполняется сервер обработки, установлено сетевое подключение.

2.	Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux. Учтите, что эти учетные данные используются только для принудительной установки службы Mobility Service.

	- Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
	- На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
	- Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении компьютера в группу защиты.

3.	Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.
4.	Установите последние пакеты openssh, openssh-server, openssl на защищаемом компьютере.
5.	Убедитесь, что служба SSH включена и работает через порт 22.
6.	Включите подсистему SFTP и проверку подлинности с помощью пароля в файле sshd\_config следующим образом:

	- Выполните вход в качестве привилегированного пользователя.
	- В файле /etc/ssh/sshd\_config найдите строку, которая начинается с PasswordAuthentication.
	- Раскомментируйте ее и измените значение с **no** на **yes**.
	- Найдите строку, которая начинается с **Subsystem**, и раскомментируйте ее.

		![Linux](./media/site-recovery-vmware-to-azure-classic/mobility2.png)


### Установка службы Mobility Service вручную

Установщики находятся в каталоге C:\\Program Files (x86)\\Microsoft Azure Site Recovery\\home\\svsystems\\pushinstallsvc\\repository.

Исходная операционная система | Файл установки службы Mobility Service
--- | ---
Windows Server (только 64-разрядная версия) | Microsoft-ASR\_UA\_9.*.0.0\_Windows\_* release.exe
CentOS 6.4, 6.5, 6.6 (только 64-разрядная версия) | Microsoft-ASR\_UA\_9.*.0.0\_RHEL6-64\_*release.tar.gz SUSE Linux Enterprise Server 11 SP3 (только 64-разрядная версия) | Microsoft-ASR\_UA\_9.*.0.0\_SLES11-SP3-64\_*release.tar.gz
Oracle Enterprise Linux 6.4, 6.5 (только 64-разрядная версия) | Microsoft-ASR\_UA\_9.*.0.0\_OL6-64\_*release.tar.gz


#### Установка вручную на сервер Windows


1. Скачайте и запустите соответствующий установщик.
2. На странице **Перед началом работы** установите переключатель **Install Mobility service** (Установка Mobility Service).

	![Служба Mobility Service](./media/site-recovery-vmware-to-azure-classic/mobility3.png)

3. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес сервера управления и парольную фразу, созданную при установке компонентов сервера управления. Ее можно получить, выполнив команду **<SiteRecoveryInstallationFolder>\\home\\sysystems\\bin\\genpassphrase.exe –n** на сервере управления.

	![Служба Mobility Service](./media/site-recovery-vmware-to-azure-classic/mobility6.png)

4. На странице **Расположение установки** оставьте расположение по умолчанию и нажмите кнопку **Далее**, чтобы начать установку.
5. На странице **Ход установки** проследите за ходом установки и при появлении соответствующего запроса перезапустите компьютер.

Кроме того, установку можно выполнить из командной строки:

UnifiedAgent.exe [/Role <агент или главный целевой сервер>] [/InstallLocation <каталог установки>] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <путь к файлу с парольной фразой>] [/LogFilePath <Log File Path>]

Описание

- /Role. (Обязательный параметр.) Указывает, следует ли устанавливать службу Mobility Service.
- /InstallLocation. (Обязательный параметр.) Указывает место установки службы.
- /PassphraseFilePath. (Обязательный параметр.) Указывает парольную фразу сервера конфигурации.
- /LogFilePath. (Обязательный параметр.) Указывает расположение файлов установки журнала.

#### Изменение IP-адреса сервера управления

После запуска мастера можно изменить IP-адрес сервера управления следующим образом:

1. Откройте файл hostconfig.exe (расположенный на рабочем столе).
2. На вкладке **Глобальные** можно изменить IP-адрес сервера управления.

	>[AZURE.NOTE] Нужно изменить только IP-адрес сервера управления. Для обмена данными с сервером управления должен быть указан порт 443, а также не нужно снимать флажок "Использовать HTTPS". Парольную фразу изменять не нужно.

	![IP-адрес сервера управления](./media/site-recovery-vmware-to-azure-classic/host-config.png)

#### Установка вручную на сервер Linux

1. Скопируйте соответствующий TAR-архив согласно приведенной выше таблице на компьютер Linux, который нужно защитить.
2. Откройте программу оболочки и извлеките в локальный каталог содержимое TAR-архива, выполнив команду `tar -xvzf Microsoft-ASR_UA_8.5.0.0*`.
3. Создайте файл passphrase.txt в локальном каталоге, в который извлечено содержимое TAR-архива. Для этого скопируйте парольную фразу из файла C:\\ProgramData\\Microsoft Azure Site Recovery\\private\\connection.passphrase на сервере управления и сохраните ее в файле passphrase.txt, выполнив в оболочке команду *`echo <passphrase> >passphrase.txt`*.
4. Установите службу Mobility Service, выполнив команду *`sudo ./install -t both -a host -R Agent -d /usr/local/ASR -i <IP address> -p <port> -s y -c https -P passphrase.txt`*.
5. Укажите внутренний IP-адрес сервера управления и убедитесь, что выбран порт 443.

**Кроме того, установку можно выполнить из командной строки**:

1. Скопируйте парольную фразу из файла C:\\Program Files (x86)\\InMage Systems\\private\\connection на сервере управления и сохраните ее там же как файл passphrase.txt. Затем выполните следующие команды. В нашем примере используется IP-адрес сервера управления 104.40.75.37 и порт HTTPS 443:

Установка на рабочем сервере

    ./install -t both -a host -R Agent -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

Установка на главном целевом сервере:


    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt


## Шаг 10. Включение защиты для компьютера

Чтобы включить защиту, добавьте виртуальные машины и физические серверы в группу защиты. Перед началом работы обратите внимание на следующее при защите виртуальных машин VMware.

- Виртуальные машины VMware обнаруживаются каждые 15 минут, и для их отображения на портале Site Recovery после обнаружения может потребоваться более 15 минут.
- Изменениям среды на виртуальной машине (таким как установка средств VMware) также может потребоваться более 15 минут на обновление в Site Recovery.
- Время последнего обнаружения для виртуальных машин VMware можно узнать на вкладке **Серверы конфигурации** в поле **Последний контакт в** свойств сервера vCenter или узла ESXi.
- Если группа защиты уже создана и после этого добавляется сервер vCenter или узел ESXi, порталу Azure Site Recovery может потребоваться более 15 минут для обновления и отображения виртуальных машин в диалоговом окне **Add machines to a protection group** (Добавление компьютеров в группу защиты).
- Если вы хотите немедленно продолжить работу и добавить компьютеры в группу защиты, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и нажмите кнопку **Обновить**.

Обратите внимание также на следующее.

- При разработке групп защиты рекомендуется, чтобы они зеркалировали рабочие нагрузки. Например, добавляйте компьютеры с определенными приложениями в одну группу.
- При добавлении компьютеров в группу защиты сервер обработки автоматически принудительно устанавливает службу Mobility Service, если она не установлена. Обратите внимание, что для этого нужно подготовить соответствующий механизм, как описано на предыдущем шаге.


Добавление компьютеров в группу защиты

1. Последовательно выберите **Защищенные элементы** > **Группа защиты** > **Компьютеры** > Добавить компьютеры.
2. Если вы защищаете виртуальные машины VMware, в окне **Выбор виртуальных машин** выберите сервер vCenter, управляющий виртуальными машинами (или узел EXSi, на котором они выполняются), и компьютеры.

	![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection2.png)

3.  Если вы защищаете физические серверы, то в окне **Выбор виртуальных машин** в мастере **Добавление физических компьютеров** укажите IP-адрес и понятное имя. После этого выберите семейство операционной системы.

	![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection1.png)

4. На странице **Specify Target Resources** (Указание целевых ресурсов) выберите учетную запись хранения для репликации, а также укажите, следует ли использовать эти параметры для всех рабочих нагрузок. Обратите внимание, что учетные записи хранилища класса Premium в настоящее время не поддерживаются.

	>[AZURE.NOTE] Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.

	![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection3.png)

5. На странице **Указание учетных записей** выберите учетную запись, [настроенную](#install-the-mobility-service-with-push-installation) для использования при автоматической установке службы Mobility Service.

	![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection4.png)

6. Установите флажок, чтобы завершить добавление компьютеров в группу защиты и запустить начальную репликацию для каждого компьютера.

	>[AZURE.NOTE] После подготовки принудительной установки служба Mobility Service автоматически устанавливается на компьютеры, на которых она не установлена, при их добавлении в группу защиты. После установки службы запустится задание защиты, которое завершится ошибкой. После сбоя необходимо перезапустить вручную каждый компьютер, на котором установлена служба Mobility Service. После перезапуска задание защиты будет запущено снова и будет выполнена начальная репликация.

Ход выполнения можно отслеживать на странице **Задания**.

![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection5.png)

Кроме того, состояние защиты можно отслеживать, выбрав **Защищенные элементы** > <protection group name> > **Виртуальные машины**. После завершения начальной репликации и синхронизации данных состояние компьютера изменится на **Защищенный**.

![Включить защиту](./media/site-recovery-vmware-to-azure-classic/enable-protection6.png)


## Шаг 11. Настройка свойств защищенного компьютера

1. После того как компьютерам будет назначено состояние **Защищено**, можно приступить к настройке свойств отработки отказа. В разделе сведений группы защиты выберите компьютер и откройте вкладку **Настройка**.
2. Site Recovery автоматически предлагает свойства для виртуальной машины Azure и обнаруживает параметры локальной сети.

	![Задание свойств виртуальной машины](./media/site-recovery-vmware-to-azure-classic/vm-properties1.png)

3. Ниже приведены параметры, которые можно изменить.

	-  **Azure VM name** (Имя виртуальной машины Azure). Это имя, которое будет назначено компьютеру в Azure после отработки отказа. Оно должно соответствовать требованиям Azure.

	-  **Azure VM size** (Размер виртуальной машины Azure). Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины. См. [дополнительные сведения](../virtual-machines/virtual-machines-linux-sizes.md/#size-tables) о размерах и адаптерах. Обратите внимание на следующее:

		- После изменения размера виртуальной машины и сохранения параметров при следующем открытии вкладки **Настройка** количество сетевых адаптеров изменится. Количество сетевых адаптеров целевой виртуальной машины равно меньшему из числа сетевых адаптеров исходной виртуальной машины и максимального числа сетевых адаптеров, поддерживаемых размером выбранной виртуальной машины.
			- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
			- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
			- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.
		- Если у виртуальной машины несколько сетевых адаптеров, то все адаптеры должны быть подключены к одной сети Azure.
	- **Azure network** (Сеть Azure). Нужно указать сеть Azure, к которой подключатся виртуальные машины Azure после отработки отказа. Если не сделать этого, виртуальные машины Azure не подключатся ни к какой сети. Кроме того, следует указать сеть Azure, если необходимо выполнить восстановление размещения с переносом из Azure на локальный сайт. При восстановлении размещения требуется установить VPN-подключение между сетью Azure и локальной сетью.
	- **Azure IP address/subnet** (IP-адрес и подсеть Azure). Для каждого сетевого адаптера необходимо выбрать подсеть, к которой должна подключиться виртуальная машина Azure. Обратите внимание на следующее:
		- Если для сетевого адаптера на исходном компьютере настроено использование статического IP-адреса, можно указать его для виртуальной машины Azure. Если не указать статический IP-адрес, будет выделен любой доступный IP-адрес. Если указан конечный IP-адрес, но он уже используется другой виртуальной машиной в Azure, произойдет сбой отработки отказа. Если для сетевого адаптера на исходном компьютере настроено использование DHCP, в качестве параметра для Azure следует указать DHCP.

## Шаг 12. Создание плана восстановления и выполнение отработки отказа

> [AZURE.VIDEO enhanced-vmware-to-azure-failover]

Можно выполнить отработку отказа для одного компьютера или для нескольких виртуальных машин, на которых выполняется одна и та же задача или рабочая нагрузка. Чтобы выполнить отработку отказа для нескольких компьютеров одновременно, следует добавить их в план восстановления.

### Создайте план восстановления

1. На странице **Планы восстановления** щелкните **Add Recovery Plan** (Добавить план восстановления) и добавьте план восстановления. Укажите сведения о плане и выберите в качестве цели **Azure**.

	![Настройка плана восстановления](./media/site-recovery-vmware-to-azure-classic/recovery-plan1.png)

2. В окне **Выбор виртуальных машин** выберите группу защиты, а затем компьютеры в группе для добавления в план восстановления.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/recovery-plan2.png)

Можно настроить план, создав группы и указав порядок выполнения отработки отказа для виртуальных машин в плане восстановления. Кроме того, можно добавить сценарии и запросы для выполняемых вручную действий. Скрипты можно создавать вручную или с помощью [модулей Runbook службы автоматизации Azure](site-recovery-runbook-automation.md). См. [дополнительные сведения](site-recovery-create-recovery-plans.md) о настройке планов восстановления.

## Запуск отработки отказа

Перед выполнением отработки отказа обратите внимание на сведения ниже.


- Убедитесь, что сервер управления работает и доступен. В противном случае произойдет сбой отработки отказа.
- При выполнении внеплановой отработки отказа учтите следующее:

	- По возможности перед выполнением внеплановой отработки отказа следует выключить основные компьютеры. В этом случае исходные и реплицированные компьютеры не будут работать одновременно. При репликации виртуальных машин VMware можно указать, что служба Site Recovery должна использовать все доступные способы для выключения исходных компьютеров при выполнении внеплановой отработки отказа. В зависимости от состояния основного сайта это может сработать или не сработать. При репликации физических серверов в службе Site Recovery такая возможность отсутствует.
	- При выполнении внеплановой отработки отказа репликация данных с основных компьютеров прекращается. Поэтому после начала внеплановой отработки отказа все изменения в данных не будут передаваться.

- Если нужно подключиться к реплицированной виртуальной машине в Azure после отработки отказа, включите подключение удаленного рабочего стола на исходном компьютере и разрешите подключение по протоколу удаленного рабочего стола (RDP) в брандмауэре перед отработкой отказа. Кроме того, потребуется разрешить RDP-подключение для общедоступной конечной точки виртуальной машины Azure после отработки отказа. Выполните следующие [рекомендации](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx), чтобы обеспечить работу RDP после отработки отказа.

>[AZURE.NOTE] Для оптимальной производительности при отработке отказа в Azure необходимо, чтобы агент Azure был установлен на защищенном компьютере. Это ускоряет загрузку и помогает диагностировать неполадки. Агент Linux можно скачать [здесь](https://github.com/Azure/WALinuxAgent), а агент Windows — [здесь](http://go.microsoft.com/fwlink/?LinkID=394789).

### Запуск тестовой отработки отказа

Запустите тестовую отработку отказа, чтобы имитировать процесс отработки отказа и восстановления в изолированной сети, не воздействуя на рабочую среду. При этом обычная репликация будет выполняться в обычном режиме. Тестовая отработка отказа запускается в исходной среде. Ее можно выполнить двумя способами.

- **Без указания сети Azure**. Если тестовая отработка отказа выполняется без сети, для виртуальных машин будет запущена проверка правильности их запуска и отображения в Azure. Виртуальные машины не подключатся к сети Azure после отработки отказа.
- **С указанием сети Azure**. При этом типе отработки отказа проверяется, правильно ли создается вся среда репликации и подключаются ли виртуальные машины к указанной сети.


1. На странице **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/test-failover1.png)

2. На странице **Подтвердить тестовую отработку отказа** выберите **Нет**, если для тестовой отработки отказа не нужно использовать сеть Azure, или выберите сеть, к которой подключатся тестируемые виртуальные машины после отработки отказа. Щелкните значок галочки, чтобы начать отработку отказа.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/test-failover2.png)

3. Ход отработки отказа можно отслеживать на вкладке **Задания**.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/test-failover3.png)

4. После завершения отработки отказа реплицированный компьютер Azure также появится на портале Azure в области **Виртуальные машины**. Если требуется инициировать RDP-подключение к виртуальной машине Azure, необходимо открыть порт 3389 на конечной точке виртуальной машины.

5. Когда операция отработки отказа дойдет до этапа завершения тестирования, щелкните "Завершить тестирование". В разделе "Примечания" можно записать и сохранить наблюдения касательно тестовой отработки отказа.

6. Выберите пункт **Тестовая отработка отказа завершена**, чтобы автоматически очистить тестовую среду. После этого для операции тестовой отработки отказа отобразится состояние **Завершено**. Любые элементы или виртуальные машины, автоматически созданные во время тестовой отработки отказа, удаляются. Обратите внимание, если отработка отказа выполняется более двух недель, она завершается принудительно.



### Запуск незапланированной отработки отказа

Внеплановая отработка отказа инициируется в Azure. Ее можно выполнить, даже если основной сайт недоступен.


1. На странице **Планы восстановления** выберите план и последовательно щелкните **Отработка отказа** > **Внеплановая отработка отказа**.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/unplanned-failover1.png)

2. При репликации виртуальных машин VMware можно выбрать выключение локальных виртуальных машин. Это лучший вариант. В этом случае отработка отказа продолжится, несмотря на то, сработает это или нет. Если эта операция не завершится успешно, сведения об ошибке появятся на вкладке **Задания** в области **Unplanned Failover Jobs** (Задания внеплановой отработки отказа).

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/unplanned-failover2.png)

	>[AZURE.NOTE] При репликации физических серверов эта возможность недоступна. По возможности локальные виртуальные машины нужно выключить вручную.

3. На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (в Azure) и выберите точку восстановления, из которой следует выполнять отработку отказа. Если при настройке свойств репликации указана согласованность нескольких виртуальных машин, можно выполнить восстановление до последней точки восстановления приложения или отказоустойчивой точки восстановления. Также можно установить переключатель **Настройте точку восстановления**, чтобы выполнить восстановление до более ранней точки во времени. Щелкните значок галочки, чтобы начать отработку отказа.

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure-classic/unplanned-failover3.png)

3. Дождитесь завершения задания внеплановой отработки отказа. Следить за ходом отработки отказа можно на вкладке **Задания**. Обратите внимание, что даже при возникновении ошибок во время внеплановой отработки отказа план восстановления полностью выполнится. Реплицированный компьютер Azure также появится на портале Azure в области "Виртуальные машины".

### Подключение к реплицированным виртуальным машинам Azure после отработки отказа

Для подключения к реплицированным виртуальным машинам в Azure после отработки отказа потребуется следующее:

1. Следует включить подключение к удаленному рабочему столу на основном компьютере.
2. Следует разрешить RDP в брандмауэре Windows на основном компьютере.
3. После отработки отказа необходимо добавить RDP для общедоступной конечной точки виртуальной машины Azure.

См. [дополнительные сведения](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx) о настройке соответствующих параметров.


## Развертывание дополнительных серверов обработки

Если нужно выполнить масштабирование развертывания до более чем 200 исходных компьютеров или объем ежедневно изменяемых данных превышает 2 ТБ, для обработки объема трафика потребуются дополнительные серверы обработки. Чтобы настроить дополнительный сервер обработки, проверьте требования в разделе [Дополнительные серверы обработки](#additional-process-servers) и следуйте приведенным там инструкциям. После настройки сервера можно настроить исходные компьютеры для его использования.

### Настройка дополнительного сервера обработки

Вот как можно настроить дополнительный сервер обработки:

- Запустите единый мастер, чтобы настроить сервер управления таким образом, чтобы он использовался только в качестве сервера обработки.
- Если нужно, чтобы репликацией данных управлял только новый сервер обработки, необходимо перенести защищенные компьютеры.

### Установка сервера обработки

1. На странице быстрого запуска скачайте файл единой установки для установки компонента Site Recovery. Запустите программу установки.
2. На странице **Перед началом работы** установите переключатель **Add additional process servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure-classic/add-ps1.png)

3. Завершите работу мастера так же, как и при [настройке](#step-5-install-the-management-server) первого сервера управления.
4. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес исходного сервера управления, на котором установлен сервер конфигурации, и парольную фразу. Чтобы получить парольную фразу, на исходном сервере управления выполните команду **<SiteRecoveryInstallationFolder>\\home\\sysystems\\bin\\genpassphrase.exe –n**.

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure-classic/add-ps2.png)

### Перенос компьютеров для использования нового сервера обработки

1. Последовательно щелкните **Серверы конфигурации** > **Сервер** > имя исходного сервера управления > **Сведения о сервере**.

	![Обновление сервера обработки](./media/site-recovery-vmware-to-azure-classic/update-process-server1.png)

2. В списке **Серверы обработки** щелкните элемент **Change Process Server** (Изменить сервер обработки) рядом с тем сервером, который требуется изменить.

	![Обновление сервера обработки](./media/site-recovery-vmware-to-azure-classic/update-process-server2.png)

3. На странице **Изменить сервер обработки** в поле **Целевой сервер обработки** выберите новый сервер управления, а затем виртуальные машины, которые будут обрабатываться на нем. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Щелкните значок галочки, чтобы начать репликацию на новом сервере обработки.

	![Обновление сервера обработки](./media/site-recovery-vmware-to-azure-classic/update-process-server3.png)




## Разрешения VMware для доступа к vCenter

Сервер обработки может автоматически обнаруживать виртуальные машины на сервере vCenter. Для автоматического обнаружения необходимо определить роль (Azure\_Site\_Recovery) на уровне vCenter, чтобы предоставить службе Site Recovery доступ к серверу vCenter. Обратите внимание, что если нужно лишь перенести компьютеры VMware в Azure и не нужно выполнять восстановление размещения с переносом из Azure, роли только для чтения достаточно. Разрешения следует настроить согласно инструкциям в разделе [Шаг 6. Настройка учетных данных для сервера vCenter](#step-6-set-up-credentials-for-the-vcenter-server). В следующей таблице представлены разрешения ролей.

**Роль** | **Дополнительные сведения** | **Разрешения**
--- | --- | ---
Роль Azure\_Site\_Recovery | Обнаружение виртуальной машины VMware |Назначьте серверу vCenter такие права:<br/><br/>хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файла, обновление файлов виртуальной машины;<br/><br/>сеть -> назначение сети;<br/><br/>ресурсы -> назначение виртуальной машины пулу ресурсов, перенос отключенной виртуальной машины, перенос включенной виртуальной машины;<br/><br/>задачи -> создание задачи, обновление задачи;<br/><br/>виртуальная машина -> конфигурация;<br/><br/>виртуальная машина -> взаимодействие -> ответ на вопрос, подключение к устройству, настройка компакт-диска, настройка гибкого диска, выключение, включение, установка средств VMware;<br/><br/>виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации;<br/><br/>виртуальная машина -> подготовка -> разрешение скачивания на виртуальной машине, разрешение отправки файлов виртуальной машины;<br/><br/>виртуальная машина -> моментальные снимки -> удаление моментальных снимков.
Роль пользователя vCenter | Обнаружение виртуальной машины VMware, отработка отказа без выключения исходной виртуальной машины | Назначьте серверу vCenter такие права:<br/><br/>объект центра обработки данных -> распространение на дочерний объект, роль только для чтения. <br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных. Если нужно ограничить доступ, назначьте дочерним объектам (узлы ESX, хранилища данных, виртуальные машины и сети) роль **Нет доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
Роль пользователя vCenter | Отработка отказа и восстановление размещения | Назначьте серверу vCenter такие права:<br/><br/>объект центра обработки данных -> распространение на дочерний объект, роль Azure\_Site\_Recovery. <br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных. Если нужно ограничить доступ, назначьте дочерним объектам (узлы ESX, хранилища данных, виртуальные машины и сети) роль **Нет доступа** с параметром **Propagate to child object** (Распространить на дочерний объект). 



## Уведомления и сведения о стороннем программном обеспечении

Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”). Microsoft is the not original author of the Third Party Code. The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only. This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.

## Дальнейшие действия

[Ознакомьтесь с дополнительными сведениями о восстановлении размещения](site-recovery-failback-azure-to-vmware-classic.md) и о том, как перенести запущенные в Azure компьютеры, для которых выполнена отработка отказа, обратно в локальную среду.

<!---HONumber=AcomDC_0525_2016-->