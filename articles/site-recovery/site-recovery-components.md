<properties
	pageTitle="Как работает служба Site Recovery | Microsoft Azure"
	description="В этой статье описана общая архитектура службы Site Recovery"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="03/27/2016"
	ms.author="raynew"/>

# Как работает служба Azure Site Recovery?

Прочтите эту статью, чтобы ознакомиться с базовой архитектурой службы Azure Site Recovery и ее компонентами.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR), которая определяет, как приложения, рабочие нагрузки и данные могут оставаться доступными при запланированных и незапланированных простоях и как можно быстрее возвращаться к нормальному режиму работы.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или на дополнительный сайт. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода на дополнительный сайт. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него.

Site Recovery можно развернуть для оркестрации репликации в нескольких сценариях.

- **Репликация виртуальных машин VMware**. Вы можете реплицировать локальные виртуальные машины VMware в [Azure](site-recovery-vmware-to-azure-classic.md) или [дополнительный центр обработки данных](site-recovery-vmware-to-vmware.md).
- **Репликация физических серверов**. Физические компьютеры под управлением Windows и Linux можно реплицировать в [Azure](site-recovery-vmware-to-azure-classic.md) или [дополнительный центр обработки данных](site-recovery-vmware-to-vmware.md).
- **Репликация виртуальных машин Hyper-V, управление которыми выполняется с помощью облачных сред System Center VMM**. Локальные виртуальные машины Hyper-V в облачных средах VMM можно реплицировать в [Azure](site-recovery-vmm-to-azure.md) или [дополнительный центр обработки данных.](site-recovery-vmm-to-vmm.md). 
- **Репликация виртуальных машин Hyper-V (без VMM)**. Виртуальные машины Hyper-V, которые не управляются с помощью VMM, можно реплицировать в [Azure](site-recovery-hyper-v-site-to-azure.md).
- **Перенос виртуальных машин**. С помощью службы Site Recovery [виртуальные машины IaaS Azure можно переносить](site-recovery-migrate-azure-to-azure.md) из одного региона в другой, а [экземпляры AWS Windows](site-recovery-migrate-aws-to-azure.md) — на виртуальные машины IaaS Azure. В настоящее время поддерживается только миграция. Это означает, что вы можете выполнить отработку отказа этих виртуальных машин, но не можете восстановить их размещение.

При помощи Site Recovery можно реплицировать большинство приложений, работающих на этих виртуальных машинах и физических серверах. Полный перечень поддерживаемых приложений см. в статье [Какие рабочие нагрузки можно защитить с помощью службы Azure Site Recovery?](site-recovery-workload.md)

## Репликация локальных виртуальных машин VMware и физических серверов в Azure

В настоящее время доступны две различные архитектуры для репликации виртуальных машин VMware или физических серверов Windows и Linux в Azure.

- [Устаревшая архитектура](site-recovery-vmware-to-azure-classic-legacy.md). Эту архитектуру нельзя использовать для новых развертываний. 
- [Расширенная архитектура](site-recovery-vmware-to-azure-classic.md). Это новейшая архитектура, которую следует использовать для всех новых развертываний. Если вы уже развернули сценарий с помощью устаревшей архитектуры, [ознакомьтесь со сведениями о переходе](site-recovery-vmware-to-azure-classic-legacy.md#migrate-to-the-enhanced-deployment) на расширенное развертывание.

В сценарии расширенного развертывания необходимо настроить локальный сервер управления со всеми компонентами Site Recovery. На каждый компьютер, который требуется защитить, нужно автоматически или вручную установить службу Mobility Service. После начальной репликации служба Mobility Service на компьютере отправляет данные дельта-репликации на сервер обработки, который оптимизирует их перед отправкой в хранилище Azure.

![Расширенная архитектура](./media/site-recovery-components/arch-enhanced.png) ![Расширенная архитектура](./media/site-recovery-components/arch-enhanced2.png)

### Локальная система
Вам потребуются следующие компоненты (локальная среда).

- **Сервер управления**. Вам потребуется компьютер Windows Server 2012 R2 в качестве сервера управления. На этом сервере вы установите все компоненты Site Recovery с помощью одного файла установщика.

	- **Сервер конфигурации**. Используется для управления обмена данными между локальной средой и облаком Azure, а также репликацией и восстановлением данных.
	- **Сервер обработки**. Используется в качестве шлюза репликации. Сервер обработки получает данные репликации с защищенных исходных компьютеров, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware. По мере увеличения масштаба развертывания вы можете добавлять дополнительные выделенные серверы для обработки растущего объема данных репликации.
	- **Главный целевой сервер**. Обрабатывает данные репликации во время восстановления размещения из Azure. 
- **Узлы VMware ESX/ESXi и сервер vCenter**. Вам понадобится один или несколько серверов узлов ESX/ESXi, на которых работают виртуальные машины VMware. Для управления этими узлами рекомендуется развернуть сервер vCenter. **Примечание.** **Даже если вы реплицируете физические серверы, их размещение нужно восстанавливать на виртуальной машине VMware**. Если вы реплицируете физический сервер, после отработки отказа в Azur он будет работать как виртуальная машина Azure. После восстановления его размещения в локальной среде он будет работать как виртуальная машина VMware. 
	
- **Виртуальные машины и физические серверы**. На каждой машине, которую нужно реплицировать в Azure, необходимо установить службу Mobility Service. Она фиксирует операции записи данных на компьютере и перенаправляет их на сервер обработки. Этот компонент можно установить вручную или автоматически. Автоматическую установку выполняет сервер обработки, когда вы включаете репликацию для конкретной машины.

### Таблицы Azure

Вам понадобятся следующие компоненты инфраструктуры Azure: 1) **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure. 2) **Служба хранилища Azure**. Вам потребуется учетная запись хранения Azure для хранения реплицируемых данных. Реплицированные данные хранятся в службе хранилища Azure, и при отработке отказа развертываются виртуальные машины Azure. 3) **Сеть Azure **. Во время отработки отказа вам нужно подключить виртуальную сеть Azure, в которой развертываются виртуальные машины Azure.
	
	
### Восстановление размещения

Восстановление размещения в локальной среде всегда выполняется на виртуальные машины VMware, даже если отрабатывается отказ физического сервера. Вам потребуется следующее.

- **Временный сервер обработки в Azure**. Если вы хотите восстановить размещение из Azure после отработки отказа, необходимо настроить виртуальную машину Azure в качестве сервера обработки, который будет обрабатывать репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение**. Для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный локальный главный целевой сервер**. Локальный главный целевой сервер обрабатывает восстановление размещения. Главный целевой сервер устанавливается по умолчанию на сервер управления, но если восстанавливается размещение больших объемов трафика, настройте для этой цели отдельный локальный главный целевой сервер. 

![Расширенное восстановление размещения](./media/site-recovery-components/enhanced-failback.png)

Требования к расширенному развертыванию см. [здесь](site-recovery-vmware-to-azure-classic.md#before-you-start-deployment). Сведения об отработке отказа для расширенного развертывания см. [здесь](site-recovery-failback-azure-to-vmware-classic.md).




## Репликация виртуальных машин Hyper-V из облачных сред VMM в Azure

Чтобы развернуть этот сценарий, во время развертывания службы Site Recovery установите на сервер VMM поставщик Azure Site Recovery. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Во время развертывания Site Recovery на сервере узла Hyper-V устанавливается агент служб восстановления Azure. Данные между ним и хранилищем Azure реплицируются через защищенный канал (HTTPS, порт 443). Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

- В локальной сети: 
	- **Сервер VMM**. По крайней мере один сервер VMM с одним настроенным частным облаком VMM. Сервер должен работать под управлением System Center 2012 R2 и иметь доступ к Интернету. Чтобы виртуальные машины Azure оставались подключенными к сети после отработки отказа, необходимо настроить сетевое сопоставление. Для этого исходная виртуальная машина должна быть подключена к сети виртуальных машин VMM. Сеть виртуальных машин должна быть связана с логической сетью, которая сопоставлена с облаком.
	- **Сервер Hyper-V**. Как минимум один сервер узла Hyper-V, размещенный в облаке VMM. Узлы Hyper-V должны работать под управлением Windows Server 2012 R2.
	- **Защищенные компьютеры**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
- Azure.
	- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
	- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа.
	- **Сеть Azure**. Чтобы настроить сетевое сопоставление виртуальных машин Azure, благодаря которому они останутся подключенными к сети после отработки отказа, необходимо настроить сеть Azure.

	![VMM в Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

Точные требования к развертыванию см. [здесь](site-recovery-vmm-to-azure.md#before-you-start).

## Репликация физических серверов или виртуальных машин VMware в дополнительный ЦОД

Чтобы реплицировать виртуальные машины VMware или физические серверы Windows или Linux на дополнительный сайт, загрузите компонент InMage Scout, включенный в подписку Azure Site Recovery. Настройте серверы компонентов для каждого сайта (сервер конфигурации, сервер обработки, главный целевой сервер) и установите унифицированный агент на компьютеры, которые требуется реплицировать. После начальной репликации агент на каждом компьютере отправляет данные дельта-репликации на сервер обработки. Сервер обработки оптимизирует эти данные и передает их на главный целевой сервер на дополнительном сайте. Сервер конфигурации управляет процессом репликации.

![VMware в VMware](./media/site-recovery-components/vmware-to-vmware.png)

### На основном локальном сайте

- **Сервер обработки**. Настройте компонент сервера обработки на основном сайте для кэширования, сжатия и оптимизации данных. Кроме того, он обеспечивает принудительную установку единого агента на компьютеры, которые необходимо защитить. 
- **VMware ESX/ESXi и сервер vCenter**. Для защиты виртуальных машин VMware нужен гипервизор VMware EXS/ESXi и иногда сервер VMware vCenter, управляющий гипервизорами.
- **Виртуальные машины и физические серверы**. Для защиты виртуальных машин VMware или физических серверов Windows и Linux на них нужно установить единый агент. Единый агент также устанавливается на машину, выступающую в качестве главного целевого сервера. Агент обеспечивает обмен данными между всеми компонентами. 
	
### На дополнительном локальном сайте
 
- **Сервер конфигурации**. Сервер конфигурации — первый компонент, устанавливаемый на дополнительный сайт. Он отвечает за управление, настройку и мониторинг развертывания с помощью веб-сайта управления или консоли vContinuum. В развертывании используется только один сервер конфигурации, который должен быть установлен на компьютере под управлением Windows Server 2012 R2.
- **Сервер vContinuum**. Устанавливается в том же расположении (дополнительный сайт), что и сервер конфигурации. Он предоставляет консоль для мониторинга защищенной среды и управления ею. При установке по умолчанию сервер vContinuum является первым главным целевым сервером с установленным единым агентом.
- **Главный целевой сервер**. На главном целевом сервере хранятся реплицированные данные. Он получает данные с сервера обработки, создает реплицированный компьютер на дополнительном сайте и хранит точки хранения данных. Необходимое количество главных целевых серверов зависит от количества защищаемых компьютеров. Если нужно переключиться на основной сайт, вам также понадобится главный целевой сервер. 

### Таблицы Azure

Разверните этот сценарий с помощью InMage Scout. Для этого вам потребуется подписка Azure. Создайте хранилище Site Recovery, затем загрузите InMage Scout и установите последние обновления, чтобы настроить развертывание.


## Репликация виртуальных машин Hyper-V в Azure (без использования VMM)

Чтобы реплицировать в Azure виртуальные машины Hyper-V, которые не управляются в облачных средах VMM, во время развертывания службы Site Recovery установите на узел Hyper-V поставщик Azure Site Recovery и агент служб восстановления Azure. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Агент обрабатывает данные репликации через защищенный канал (HTTPS, порт 443). Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

![С сайта Hyper-V в Azure](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)

### Локальная система

- **Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V. Узлы Hyper-V должны работать под управлением Windows Server 2012 R2.
- **Защищенные компьютеры**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
### Таблицы Azure

- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа.

Требования к развертыванию см. [здесь](site-recovery-hyper-v-site-to-azure.md#before-you-start).


## Репликация виртуальных машин Hyper-V из облачных сред VMM в Azure

Чтобы развернуть этот сценарий, во время развертывания службы Site Recovery установите на сервер VMM поставщик Azure Site Recovery, а на узле Hyper-V — агент служб восстановления Azure. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Агент обрабатывает данные репликации через защищенный канал (HTTPS, порт 443). Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные (неактивные) данные в службе хранилища Azure также шифруются.

![VMM в Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

### Локальная система

- **Сервер VMM**. По крайней мере один сервер VMM с одним настроенным частным облаком VMM. Сервер должен работать под управлением System Center 2012 R2 и иметь доступ к Интернету. Чтобы виртуальные машины Azure оставались подключенными к сети после отработки отказа, необходимо настроить сетевое сопоставление. Для этого нужно подключить исходные виртуальные машины к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
- **Сервер Hyper-V**. Как минимум один сервер узла Hyper-V, размещенный в облаке VMM. Узлы Hyper-V должны работать под управлением Windows Server 2012 R2.
- **Защищенные компьютеры**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
### Таблицы Azure

- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа.
- **Сеть Azure**. Чтобы виртуальные машины Azure оставались подключенными к сети после отработки отказа, необходимо настроить сетевое сопоставление. Для этого потребуется сеть Azure.

Требования к развертыванию см. [здесь](site-recovery-vmm-to-azure.md#before-you-start).

## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных

Чтобы развернуть этот сценарий, во время развертывания службы Site Recovery установите на сервер VMM поставщик Azure Site Recovery. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Данные реплицируются между основным и дополнительным серверами узлов Hyper-V через локальную или VPN-сеть или по протоколу Kerberos или с использованием проверки подлинности на основе сертификата. Обмен данными между поставщиком и серверами узла Hyper-V осуществляется по защищенным и зашифрованным каналам.

![Из локальной среды в локальную среду](./media/site-recovery-components/arch-onprem-onprem.png)

### Локальная система

- **Сервер VMM**. Рекомендуется разместить один сервер VMM на основном сайте, а второй — на дополнительном. На каждом сервере должно быть установлено по крайней мере одно частное облако VMM. На сервере должно быть запущено как минимум решение System Center 2012 с пакетом обновления 1 (SP1) с последними обновлениями. Кроме того, сервер должен быть подключен к Интернету. В каждом облаке необходимо настроить профиль возможностей Hyper-V.
- **Сервер Hyper-V**. Серверы узлов Hyper-V должны быть размещены в основном и дополнительном облаках VMM. Серверы узлов должны быть подключены к Интернету и работать под управлением Windows Server 2012 с последними обновлениями (или более поздней версии этой ОС).
- **Защищенные компьютеры**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
### Таблицы Azure

Вам потребуется подписка Azure.

Требования к развертыванию см. [здесь](site-recovery-vmm-to-vmm.md#before-you-start).


## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных с применением репликации сети SAN

В этом сценарии во время развертывания службы Site Recovery установите на серверы VMM поставщик Azure Site Recovery. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Данные реплицируются между основным и дополнительным массивами хранения с помощью синхронной репликации сети SAN.

![Репликация сети SAN](./media/site-recovery-components/arch-onprem-onprem-san.png)

### Локальная система

- **Массив SAN**. [Поддерживаемый массив SAN](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx) под управлением основного сервера VMM. SAN использует сетевую инфраструктуру совместно с другим массивом SAN в дополнительном ЦОД.
- **Сервер VMM**. Рекомендуется разместить один сервер VMM на основном сайте, а второй — на дополнительном. На каждом сервере должно быть установлено по крайней мере одно частное облако VMM. На сервере должно быть запущено как минимум решение System Center 2012 с пакетом обновления 1 (SP1) с последними обновлениями. Кроме того, сервер должен быть подключен к Интернету. В каждом облаке необходимо настроить профиль возможностей Hyper-V.
- **Сервер Hyper-V**. Серверы узлов Hyper-V, размещенные в основном и дополнительном облаках VMM. Серверы узлов должны быть подключены к Интернету и работать под управлением Windows Server 2012 с последними обновлениями (или более поздней версии этой ОС).
- **Защищенные компьютеры**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
### Таблицы Azure

Вам потребуется подписка Azure.

Требования к развертыванию см. [здесь](site-recovery-vmm-san.md#before-you-start).


## Жизненный цикл защиты Hyper-V

Ниже описан рабочий процесс защиты, репликации и отработки отказа виртуальных машин Hyper-V.

1. **Включение защиты**. Выполняется настройка хранилища Site Recovery, настройка параметров репликации для облака VMM или сайта Hyper-V и включается защита виртуальных машин. Инициируется задание **Включение защиты**, ход выполнения которого можно отслеживать на вкладке **Задания**. При выполнении задания проверяется, соответствует ли компьютер необходимым требованиям, а затем вызывается метод [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию в Azure с помощью настраиваемых пользователем параметров. Кроме того, при выполнении задания **Включение защиты** вызывается метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) для инициализации полной репликации виртуальной машины.
2. **Начальная репликация**. Создается моментальный снимок виртуальной машины, и виртуальные жесткие диски реплицируются по одному, пока все они не будут скопированы в Azure или дополнительный центр обработки данных. Время выполнения этой процедуры зависит от размера виртуальной машины, пропускной способности сети, а также способа начальной репликации. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище. Обратите внимание, что при выполнении начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска. После завершения начальной репликации моментальный снимок виртуальной машины удаляется, а изменения, произошедшие с дельта-диском, в журнале синхронизируются и объединяются.
3. **Завершение подготовки к защите**. После завершения начальной репликации задание **Завершение подготовки к защите** настраивает сеть и другие не связанные с репликацией параметры. После этого виртуальная машина защищена. При репликации в Azure может потребоваться настроить параметры виртуальной машины для обеспечения готовности к отработке отказа. На этом этапе можно выполнить тестовую отработку отказа, чтобы убедиться, что все работает правильно.
4. **Репликация**. После начальной репликации начинается синхронизация изменений в соответствии с параметрами репликации. 
	- **Сбой репликации**. Если происходит сбой дельта-репликации и для полной репликации необходима высокая пропускная способность или требуется много времени, выполняется повторная синхронизация. Например, если HRL-файлы занимают 50 % места на диске, виртуальная машина помечается для повторной синхронизации. Повторная синхронизация минимизирует объем передаваемых данных. Для этого вычисляются контрольные суммы исходной и целевой виртуальной машины, а затем отправляется только полученная разница. После завершения повторной синхронизации возобновляется дельта-репликация. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Повторную синхронизацию виртуальной машины можно выполнить вручную.
	- **Ошибка репликации**. При возникновении ошибки репликации используется встроенный алгоритм повторных попыток. Если произошла неустранимая ошибка, например ошибка проверки подлинности или авторизации, или реплицируемый компьютер находится в недопустимом состоянии, повторная попытка не выполняется. Если произошла устранимая ошибка, например ошибка в сети, нехватка свободного места на диске или объема памяти, происходит повторная попытка. После каждой повторной попытки интервал между повторными попытками увеличивается (через 1, 2, 4 минуты, 8, 10 минут и затем через 30 минут).
4. **Плановые и внеплановые отработки отказа**. Плановые и внеплановые отработки отказа выполняются по мере необходимости. Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины. После создания реплицированные виртуальные машины переходят в состояние ожидания фиксации. Чтобы завершить отработку отказа, необходимо зафиксировать изменения на этих виртуальных машинах. Если выполняется репликация с использованием сети SAN, фиксация выполняется автоматически. После запуска основного сайта может произойти восстановление размещения. Если репликация выполнялась в Azure, обратная репликация выполняется автоматически. Иначе ее нужно будет запустить вручную.
 

![рабочий процесс](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## Дальнейшие действия

[Подготовка к развертыванию](site-recovery-best-practices.md)

<!---HONumber=AcomDC_0330_2016-->