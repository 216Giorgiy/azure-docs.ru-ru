<properties
	pageTitle="Как работает служба Site Recovery | Microsoft Azure"
	description="В этой статье описана общая архитектура службы Site Recovery"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="12/07/2015"
	ms.author="raynew"/>

# Как работает служба Azure Site Recovery?

## Об этой статье

В этой статье описываются базовая архитектура службы Site Recovery и ее компоненты. Если после прочтения статьи у вас возникнут какие-либо вопросы, вы можете задать их на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR), которая определяет, как приложения, рабочие нагрузки и данные могут оставаться доступными при запланированных и незапланированных простоях и как можно быстрее возвращаться к нормальному режиму работы. Большая часть стратегии BCDR будет сосредоточена на решениях, обеспечивающих защиту и восстановление бизнес-данных, а также непрерывность доступа к рабочим нагрузкам в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода на дополнительный сайт. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него.

Службу Site Recovery можно использовать в ряде сценариев. Она обеспечивает защиту нескольких рабочих нагрузок.

- **Защита виртуальных машин VMware**. Локальные виртуальные машины VMware можно защитить, реплицируя их в Azure или дополнительный центр обработки данных. **Защита виртуальных машин Hyper-V**. Локальные виртуальные машины Hyper-V можно защитить, реплицируя их в облако (Azure) или дополнительный центр обработки данных.  
- **Защита физических серверов**. Физические компьютеры под управлением Windows или Linux можно защитить, реплицируя их в Azure или дополнительный центр обработки данных.
- **Перенос виртуальных машин**. С помощью службы Site Recovery можно переносить виртуальные машины IaaS Azure между регионами или экземпляры AWS Windows на виртуальные машины IaaS Azure.

Полную сводку поддерживаемых развертываний см. разделах [Что такое Azure Site Recovery?](site-recovery-overview.md) и [Какие рабочие нагрузки можно защитить с помощью Azure Site Recovery?](site-recovery-workload.md)

## Репликация между локальным физическим сервером или виртуальной машиной VMware и Azure

Если нужно защитить виртуальные машины VMware или физические компьютеры Windows или Linux путем их репликации в Azure, вам потребуется следующее.

**Местоположение.** | **Необходимые элементы** 
--- | --- 
 Локальная система | **Сервер обработки**. Он оптимизирует данные защищенных виртуальных машин VMware или физических компьютеров Windows и Linux перед их отправкой в Azure. Он также обеспечивает принудительную установку компонента службы Mobility Service на защищенный компьютер и выполняет автоматическое обнаружение виртуальных машин VMware. <br/><br/> **Сервер VMware vCenter**. При защите виртуальных машин VMware требуется сервер VMware vCenter, который управляет низкоуровневыми оболочками vSphere.<br/><br/> **Сервер ESX**. При защите виртуальных машин VMware требуется сервер ESX/ESXi версии 5.1 или 5.5 с последними обновлениями.<br/><br/> **Компьютеры**. При защите VMware на виртуальных машинах VMware должны быть установлены и работать инструменты VMware. При защите физических компьютеров на них должна быть установлена поддерживаемая операционная система Windows или Linux. [Здесь](site-recovery-vmware-to-azure.md/#before-you-start) приведены сведения о поддерживаемых версиях ОС. <br/><br/> **Служба Mobility Service**. Устанавливается на компьютерах, которые необходимо защитить, для сбора изменений и их передачи на сервер обработки. <br/><br/>Компоненты сторонних производителей. Это развертывание зависит от некоторых [компонентов сторонних производителей](http://download.microsoft.com/download/C/D/7/CD79E327-BF5A-4026-8FF4-9EB990F9CEE2/Third-Party_Notices.txt).
Таблицы Azure | **Сервер конфигурации**. Виртуальная машина Standard A3 Azure, которая координирует взаимодействие между защищенными компьютерами, сервером обработки и главными целевыми серверами в Azure. Он настраивает репликацию и координирует процессы восстановления при сбое. <br/><br/>**Главный целевой сервер**. Виртуальная машина Azure, на которой хранятся реплицированные данные защищенных компьютеров. Данные размещаются на подключенных виртуальных жестких дисках, созданных в хранилище BLOB-объектов в учетной записи хранения Azure. Резервный главный целевой сервер выполняется локально для обеспечения возможности переключения между виртуальными машинами Azure и виртуальными машинами VMware. <br/><br/> **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery). <br/><br/> **Виртуальная сеть**. Сеть Azure, в которой находятся сервер конфигурации и главные целевые серверы, для которых настроены та же подписка и тот же регион, что и для службы Site Recovery. <br/><br/> **Служба хранилища Azure**. Учетная запись хранения Azure для хранения реплицируемых данных. Следует использовать учетную запись геоизбыточного хранилища класса Standard или Premium, для которой настроен тот же регион, что и для подписки Site Recovery.


В этом случае виртуальные машины сервера конфигурации и главного целевого сервера подключаются через VPN-подключение к внутренним портам сети Azure (с использованием Azure ExpressRoute или VPN типа "сеть — сеть") или через безопасное подключение к Интернету к сопоставленным общедоступным конечным точкам в облачной службе Azure.

Служба Mobility Service на защищаемых компьютерах отправляет данные репликации на сервер обработки, а метаданные репликации — на сервер конфигурации. Сервер обработки обменивается с сервером конфигурации данными об управлении. Он отправляет данные репликации, а также оптимизирует и отправляет реплицированные данные главному целевому серверу.

## Репликация виртуальных машин Hyper-V в Azure (с помощью VMM)

Если виртуальные машины расположены на узле Hyper-V, которым управляет облако System Center VMM, для их репликации в Azure понадобится следующее.

**Местоположение.** | **Необходимые элементы** 
--- | --- 
Локальная система | **Сервер VMM**. По крайней мере один сервер VMM с одним настроенным частным облаком VMM. На каждом сервере VMM устанавливается поставщик Azure Site Recovery.<br/><br/>**Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V, расположенный в облаке VMM. На каждом сервере Hyper-V устанавливается агент служб восстановления Майкрософт. <br/><br/> **Виртуальные машины**. По крайней мере одна виртуальная машина на сервере Hyper-V. На виртуальной машине ничего не устанавливается.
Таблицы Azure | **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery). <br/><br/>**Учетная запись хранения**. Учетная запись хранения Azure, для которой настроена та же подписка, что и для службы Site Recovery. Реплицированные компьютеры хранятся в службе хранилища Azure. 

В этом случае поставщик на сервере VMM координирует репликацию с помощью службы Site Recovery и управляет ею через Интернет. Данные реплицируются между агентом служб восстановления, выполняющимся на локальном сервере Hyper-V, и службой хранилища Azure через порт HTTPS 443. Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

![Из локального VMM в Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

## Репликация виртуальных машин Hyper-V в Azure (без использования VMM)

Если виртуальными машинами не управляет сервер System Center VMM, для их репликации в Azure понадобится следующее.

**Местоположение.** | **Необходимые элементы**
--- | --- 
 Локальная система | **Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V. На каждом сервере Hyper-V устанавливаются поставщик Azure Site Recovery и агент служб восстановления Майкрософт. <br/><br/>**Виртуальные машины**. По крайней мере одна виртуальная машина на сервере Hyper-V. На виртуальной машине ничего не устанавливается.
Таблицы Azure | **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery). <br/><br/>**Учетная запись хранения**. Учетная запись хранения Azure, для которой настроена та же подписка, что и для службы Site Recovery. Реплицированные компьютеры хранятся в службе хранилища Azure.

В этом случае поставщик на сервере Hyper-V координирует репликацию с помощью службы Site Recovery и управляет ею через Интернет. Данные реплицируются между агентом служб восстановления, выполняющимся на локальном сервере Hyper-V, и службой хранилища Azure через порт HTTPS 443. Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

![Из локального VMM в Azure](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)



## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных

Если нужно защитить виртуальные машины Hyper-V, реплицируя их в дополнительный центр обработки данных, потребуется следующее. Обратите внимание, что это можно сделать, только если сервером узла Hyper-V управляет облако System Center VMM.

**Местоположение.** | **Необходимые элементы** 
--- | --- 
 Локальная система | **Сервер VMM**. Сервер VMM на основном сайте и на дополнительном сайте. На каждом сервере VMM устанавливается поставщик Azure Site Recovery.<br/><br/>**Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V, расположенный в облаке VMM, на основном и дополнительном сайтах. На серверах Hyper-V ничего не устанавливается. <br/><br/> **Виртуальные машины**. По крайней мере одна виртуальная машина на сервере Hyper-V. На виртуальной машине ничего не устанавливается.
Таблицы Azure | **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery). 

В этом случае поставщик на сервере VMM координирует репликацию с помощью службы Site Recovery и управляет ею через Интернет. Данные реплицируются между основным и дополнительным серверами узлов Hyper-V через Интернет по протоколу Kerberos или с использованием проверки подлинности на основе сертификата. Обмен данными между поставщиком и серверами узла Hyper-V осуществляется по защищенным и зашифрованным каналам.

![Из локальной среды в локальную среду](./media/site-recovery-components/arch-onprem-onprem.png)

## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных с применением репликации сети SAN

Если виртуальные машины расположены на узле Hyper-V, которым управляет облако System Center VMM, и используется хранилище SAN, для репликации в два центра обработки данных понадобится следующее.

**Местоположение.** | **Необходимые элементы** 
--- | --- 
 Основной центр обработки данных | **Массив SAN**. [Поддерживаемый массив SAN](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx) под управлением основного сервера VMM. Сеть SAN и другой массив SAN на дополнительном сайте совместно используют сетевую инфраструктуру. <br/><br/> **Сервер VMM**. По крайней мере один сервер VMM с одним или несколькими облаками VMM и настроенными группами репликации. На каждом сервере VMM устанавливается поставщик Azure Site Recovery. <br/><br/> **Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V с виртуальными машинами, входящими в группу репликации. На сервере узла Hyper-V ничего не устанавливается.<br/><br/> **Виртуальные машины**. По крайней мере одна виртуальная машина на сервере узла Hyper-V. На виртуальной машине ничего не устанавливается. 
Второстепенный центр обработки данных | **Массив SAN**. [Поддерживаемый массив SAN](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx) под управлением дополнительного сервера VMM. <br/><br/>**Сервер VMM**. По крайней мере один сервер VMM с одним или несколькими облаками VMM.<br/><br/> **Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V. 
Таблицы Azure | **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery).

В этом случае поставщик на сервере VMM координирует репликацию с помощью службы Site Recovery и управляет ею через Интернет. Данные реплицируются между основным и дополнительным массивами хранения с помощью синхронной репликации сети SAN.

![Из локальной среды в локальную среду](./media/site-recovery-components/arch-onprem-onprem-san.png)



## Жизненный цикл защиты Hyper-V

Ниже описан рабочий процесс защиты, репликации и отработки отказа виртуальных машин Hyper-V.

1. **Включение защиты**. Выполняется настройка хранилища Site Recovery, настройка параметров репликации для облака VMM или сайта Hyper-V и включается защита виртуальных машин. Инициируется задание **Включение защиты**, ход выполнения которого можно отслеживать на вкладке **Задания**. При выполнении задания проверяется, соответствует ли компьютер необходимым требованиям, а затем вызывается метод [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию в Azure с помощью настраиваемых пользователем параметров. Кроме того, при выполнении задания **Включение защиты** вызывается метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) для инициализации полной репликации виртуальной машины.
2. **Начальная репликация**. Создается моментальный снимок виртуальной машины, и виртуальные жесткие диски реплицируются по одному, пока все они не будут скопированы в Azure или дополнительный центр обработки данных. Время выполнения этой процедуры зависит от размера и пропускной способности сети, а также выбранного способа начальной репликации. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище. Обратите внимание, что при выполнении начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска. После завершения начальной репликации моментальный снимок виртуальной машины удаляется, а изменения, произошедшие с дельта-диском, в журнале синхронизируются и объединяются.
3. **Завершение подготовки к защите**. После завершения начальной репликации выполняется задание **Завершение подготовки к защите**, в ходе которого настраивается сеть и другие параметры, настраиваемые после репликации. Теперь виртуальная машина защищена. При репликации в Azure может потребоваться настроить параметры виртуальной машины для обеспечения готовности к отработке отказа. На этом этапе можно выполнить тестовую отработку отказа, чтобы проверить, что все работает должным образом.
4. **Репликация**. После начальной репликации происходит разностная синхронизированная репликация в соответствии с параметрами и способом репликации. 
	- **Сбой репликации**.При сбое разностной репликации данных и если при полной репликации используется высокая пропускная способность или она выполняется долго происходит повторная синхронизация. Например, если HRL-файлы занимают 50 % места на диске, виртуальная машина помечается для повторной синхронизации. Повторная синхронизация минимизирует объем передаваемых данных. Для этого вычисляются контрольные суммы исходной и целевой виртуальной машины, а затем отправляется только полученная разница. После завершения повторной синхронизации возобновляется разностная репликация данных. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Повторную синхронизацию виртуальной машины можно выполнить вручную.
	- **Ошибка репликации**. При возникновении ошибки репликации используется встроенный алгоритм повторных попыток. Если произошла неустранимая ошибка, например ошибка проверки подлинности или авторизации, или реплицируемый компьютер находится в недопустимом состоянии, повторная попытка не выполняется. Если произошла устранимая ошибка, например ошибка в сети, нехватка свободного места на диске или объема памяти, происходит повторная попытка. После каждой повторной попытки интервал между повторными попытками увеличивается (через каждые 1, 2, 4, 8, 10 и затем 30 минут).
4. **Плановые и внеплановые отработки отказа**. Плановые и внеплановые отработки отказа выполняются по мере необходимости. Во избежание потери данных при выполнении плановой отработки отказа исходные виртуальные машины выключаются. После создания реплицированные виртуальные машины находятся в состоянии ожидания фиксации. Необходимо выполнить фиксацию для них, чтобы завершить отработку отказа. Если выполняется репликация с использованием сети SAN, фиксация выполняется автоматически. После запуска основного сайта может произойти восстановление размещения. Если репликация выполнялась в Azure, обратная репликация выполняется автоматически. В противном случае ее нужно запускать вручную.
 

![рабочий процесс](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## Репликация виртуальных машин VMware и физических серверов в Azure

Виртуальные машины VMware и физические серверы (Windows или Linux) можно реплицировать в Azure через VPN-подключение типа "сеть — сеть" или через Интернет.

### Репликация через VPN-подключение типа "сеть — сеть" (или ExpressRoute) в Azure

![Из виртуальной машины VMware или с физического компьютера в Azure через Интернет](./media/site-recovery-components/arch-onprem-azure-vmware-vpn.png)

#### Репликация через Интернет

![Из виртуальной машины VMware или с физического компьютера в Azure через Интернет](./media/site-recovery-components/arch-onprem-azure-vmware-internet.png)

## Репликации между локальными физическими серверами или виртуальными машинами VMware в основных или дополнительных центрах обработки данных

Если нужно защитить виртуальные машины VMware или физические компьютеры Windows или Linux путем их репликации в два локальных центра обработки данных, потребуется следующее.

**Местоположение.** | **Необходимые элементы** 
--- | --- 
 Основной локальный центр обработки данных | **Сервер обработки**. Настройте компонент сервера обработки на основном сайте для кэширования, сжатия и оптимизации данных. Кроме того, он обеспечивает принудительную установку единого агента на компьютеры, которые необходимо защитить. <br/><br/> **Защита VMware**. При защите виртуальных машин VMware понадобится низкоуровневая оболочка VMware EXS/ESXi или сервер VMware vCenter, управляющий несколькими низкоуровневыми оболочками.<br/><br/> **Защита физического сервера**. При защите физических компьютеров на них должна быть установлена ОС Windows или Linux. <br/><br/> **Единый агент**. Устанавливается на компьютерах, которые необходимо защитить, и на компьютере, который выполняет роль главного целевого сервера. Он обеспечивает связь между всеми компонентами InMage.
Дополнительный локальный центр обработки данных | **Сервер конфигурации**. Сервер конфигурации — первый компонент, устанавливаемый на дополнительный сайт. Он отвечает за управление, настройку и мониторинг развертывания с помощью веб-сайта управления или консоли vContinuum. Сервер конфигурации также обладает механизмом принудительного удаленного развертывания единого агента. В развертывании устанавливается только один сервер конфигурации. Его следует установить на компьютере под управлением Windows Server 2012 R2. <br/><br/> **Сервер vContinuum**. Устанавливается в том же расположении (для дополнительного сайта), что и сервер конфигурации. Он предоставляет консоль для мониторинга защищенной среды и управления ею. При установке по умолчанию сервер vContinuum является первым главным целевым сервером с установленным единым агентом. <br/><br/> **Главный целевой сервер**. Главный целевой сервер содержит реплицированные данные. Он получает данные с сервера обработки, создает реплицированный компьютер на дополнительном сайте и хранит точки хранения данных. Необходимое количество главных целевых серверов зависит от количества защищаемых компьютеров. Если нужно переключиться на основной сайт, вам также понадобится главный целевой сервер. 
Таблицы Azure | **Хранилище Site Recovery**. По крайней мере одно хранилище Azure Site Recovery (для которого настроена подписка на службу Site Recovery). Для настройки развертывания после создания хранилища скачайте InMage Scout. Нужно также установить последнее обновление для всех серверов компонентов InMage.


В этом случае единый агент, выполняющийся на защищаемом компьютере, отправляет сведения об изменениях разностной репликации на сервер обработки. Сервер обработки оптимизирует эти данные и передает их главному целевому серверу на дополнительном сайте. Сервер конфигурации управляет процессом репликации.




## Дальнейшие действия

[Подготовка к развертыванию](site-recovery-best-practices.md).

<!---HONumber=AcomDC_0128_2016-->