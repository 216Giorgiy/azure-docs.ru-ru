---
title: "Как работает Site Recovery? | Документация Майкрософт"
description: "В этой статье описана общая архитектура службы Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 03/14/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: a087df444c5c88ee1dbcf8eb18abf883549a9024
ms.openlocfilehash: 4674985363bc1267449e018ab15a53757a8fd32d
ms.lasthandoff: 03/15/2017


---
# <a name="how-does-azure-site-recovery-work"></a>Как работает служба Azure Site Recovery?

Эта статья содержит сведения о базовой архитектуре службы [Azure Site Recovery](site-recovery-overview.md) и ее компонентах.

Комментарии можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="replicate-to-azure"></a>Репликация в Azure

В Azure вы можете реплицировать следующее:

- **VMware.** Локальные виртуальные машины VMware, запущенные на [поддерживаемом узле](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers). Вы можете реплицировать виртуальные машины VMware, выполняемые в [поддерживаемых операционных системах](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions).
- **Hyper-V.** Локальные виртуальные машины Hyper-V, запущенные на [поддерживаемых узлах](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers).
- **Физические компьютеры.** Локальные физические серверы под управлением Windows или Linux в [поддерживаемых операционных системах](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).

## <a name="vmware-to-azure"></a>VMware — Azure

Для репликации виртуальных машин VMware в Azure вам потребуется следующее.

Область | Компонент | Сведения
--- | --- | ---
**Таблицы Azure** | В Azure требуется учетная запись Azure, учетная запись хранения Azure и сеть Azure. | Учетные записи хранения и сети могут быть учетными записями Resource Manager или классическими.<br/><br/>  Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер конфигурации** | На одном сервере управления (виртуальная машина VMware) выполняются все локальные компоненты, а именно: сервер конфигурации, сервер обработки, главный целевой сервер. | Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
 **Сервер обработки**  | По умолчанию устанавливается на сервере конфигурации. | Выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Сервер обработки также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.<br/><br/> По мере увеличения масштаба развертывания вы можете добавлять дополнительные выделенные серверы для обработки растущего объема данных репликации.
 **Главный целевой сервер** | По умолчанию устанавливается на локальном сервере конфигурации. | Обрабатывает данные репликации при восстановлении размещения с переносом из Azure.<br/><br/> Если объемы трафика восстановления размещения высоки, можно развернуть отдельный главный целевой сервер.
**Серверы VMware** | Виртуальные машины VMware размещаются на серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | Добавьте серверы VMware в хранилище служб восстановления.<br/><br/> I
**Реплицируемые компьютеры** | Служба Mobility Service будет установлена на каждой виртуальной машине VMware, которую нужно реплицировать. Ее можно установить вручную или с помощью принудительной установки с сервера обработки.

**Рис. 1. Компоненты VMware, реплицируемые в Azure**

![Компоненты](./media/site-recovery-components/arch-enhanced.png)

### <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить развертывание, включая компоненты Azure, и хранилище служб восстановления. В хранилище необходимо указать источник и целевой объект репликации, настроить сервер конфигурации, добавить серверы VMware, создать политику репликации, развернуть службу Mobility Service, включить репликацию и запустить тестовую отработку отказа.
2.  Компьютеры начинают репликацию в соответствии с политикой репликации, а репликация первоначальной копии данных выполняется в службу хранилища Azure.
4. Репликация разностных изменений в Azure начинается после завершения начальной репликации. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
    - Реплицируемые компьютеры обмениваются данными с сервером конфигурации через порт HTTPS 443 для входящих подключений для управления репликацией.
    - Реплицируемые компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно настроить).
    - Сервер конфигурации выполняет оркестрацию управления репликацией с Azure через порт HTTPS 443 для исходящих подключений.
    - Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет их в службу хранилища Azure через порт 443 для исходящих подключений.
    - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа. Это полезно, если на компьютерах выполняется одна и та же рабочая нагрузка и они должны быть согласованы.
5. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#public-peering) Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.

**Рис. 2. Репликация VMware в Azure**

![Расширенная архитектура](./media/site-recovery-components/v2a-architecture-henry.png)

### <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения

1. Убедившись, что тестовая отработка отказа работает правильно, при необходимости выполните незапланированную отработку отказа в Azure. Плановая отработка отказа не поддерживается.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md), чтобы выполнить отработку отказа нескольких виртуальных машин.
3. При отработке отказа в Azure создаются виртуальные машины реплик. Фиксация отработки отказа выполняется для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
4. Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения. Вы настраиваете инфраструктуру восстановления размещения, запускаете репликацию компьютера с дополнительного сайта на основной и выполняете внеплановую отработку отказа с дополнительного сайта. После того, как это восстановление размещения будет зафиксировано, данные переместятся обратно в локальное расположение, и вам понадобится включить репликацию в Azure снова. [Дополнительные сведения](site-recovery-failback-azure-to-vmware.md)

Есть ряд требований к восстановлению размещения.


- **Временный сервер обработки в Azure.** Если вы хотите восстановить размещение из Azure после отработки отказа, необходимо настроить виртуальную машину Azure в качестве сервера обработки, который будет обрабатывать репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение.** Для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный локальный главный целевой сервер.** Локальный главный целевой сервер обрабатывает восстановление размещения. Главный целевой сервер устанавливается по умолчанию на сервер управления, но если восстанавливается размещение больших объемов трафика, настройте для этой цели отдельный локальный главный целевой сервер.
- **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Она создается автоматически во время создания политики репликации.

**Рис. 3. Восстановление размещения виртуальных машин или физических компьютеров VMware**

![Восстановление размещения](./media/site-recovery-components/enhanced-failback.png)

## <a name="physical-to-azure"></a>Физическое расположение — Azure

При репликации физических локальных серверов в Azure используются те же компоненты и процессы, что и при репликации [VMware в Azure](#vmware-replication-to-azure), но обратите внимание на следующие отличия:

- вместо виртуальной машины VMware для сервера конфигурации можно использовать физический сервер;
- для восстановления размещения требуется локальная инфраструктура VMware. Восстанавливать размещение на физический сервер невозможно.

## <a name="hyper-v-to-azure"></a>Hyper-V в Azure

Для репликации виртуальных машин Hyper-V в Azure вам потребуется следующее.

**Область** | **Компонент** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | В Azure вам требуется учетная запись Microsoft Azure, учетная запись хранения Azure и сеть Azure. | Учетные записи хранения и сети могут быть учетными записями Resource Manager или классическими.<br/><br/> Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта.<br/><br/> При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер VMM** | Узлы Hyper-V, расположенные в облаках VMM | Если управление узлами Hyper-V осуществляется в облаках VMM, сервер VMM необходимо зарегистрировать в хранилище служб восстановления.<br/><br/> Установите поставщик Site Recovery на сервере VMM, чтобы управлять репликацией с помощью Azure.<br/><br/> Необходимо настроить логические сети и сети виртуальных машин для настройки сетевого сопоставления. Сеть виртуальных машин должна быть связана с логической сетью, которая сопоставлена с облаком.
**Узел Hyper-V** | Серверы Hyper-V можно развернуть с помощью сервера VMM или без него. | Если сервера VMM нет, поставщик Site Recovery устанавливается на узле, чтобы управлять репликацией с помощью Site Recovery через Интернет. При наличии сервера VMM поставщик устанавливается не на узле, а на нем.<br/><br/> Агент служб восстановления устанавливается на узле для выполнения репликации данных.<br/><br/> Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.
**Виртуальные машины Hyper-V** | На сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина. | На виртуальных машинах не нужно ничего устанавливать явным образом.


### <a name="replication-process"></a>Процесс репликации

1. Вы настраиваете компоненты Azure. Перед развертыванием Site Recovery мы рекомендуем настроить учетные записи хранения и сети.
2. Необходимо создать хранилище служб репликации для Site Recovery и настроить параметры хранилища. В частности, необходимо сделать следующее.
    - Исходные и целевые параметры. Если вы не управляете узлами Hyper-V в облаке VMM, для целевого объекта необходимо создать контейнер сайта Hyper-V и добавить к нему узлы Hyper-V. Если управление узлами Hyper-V осуществляется в VMM, источником является облако VMM, а целевым объектом — Azure.
    - Установка поставщика Azure Site Recovery и агента служб восстановления Microsoft Azure. При наличии VMM поставщик будет установлен в нем, а агент — на каждом узле Hyper-V. При отсутствии VMM поставщик и агент будут установлены на каждом узле.
    - Создайте политику репликации для сайта Hyper-V или облака VMM. Политика применяется ко всем виртуальным машинам, расположенным на узлах на сайте или в облаке.
    - Включите репликацию для виртуальных машин Hyper-V. Начальная репликация выполняется в соответствии с параметрами политики репликации.
4. Отслеживаются изменения данных. Репликация разностных изменений в Azure начинается после завершения начальной репликации. Отслеживаемые изменения для элемента хранятся в HRL-файле.
5. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

### <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

1. Вы можете запустить плановую или внеплановую [отработку отказа](site-recovery-failover.md) с локальных виртуальных машин Hyper-V в Azure. Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md) для координации отработки отказа нескольких компьютеров.
4. После запуска отработки отказа в Azure должны отобразиться созданные виртуальные машины реплик. При необходимости виртуальной машине можно назначить общедоступный IP-адрес.
5. Затем необходимо зафиксировать отработку отказа для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
6. Когда основной локальный сайт снова станет доступным, вы сможете выполнить [восстановление размещения](site-recovery-failback-from-azure-to-hyper-v.md). Запустите плановую отработку отказа из Azure на основной сайт. Для плановой отработки отказа можно выбрать восстановление размещения на ту же самую виртуальную машину или в другое расположение и синхронизировать изменения между Azure и локальным расположением, чтобы предотвратить потерю данных. Если виртуальные машины создаются локально, необходимо зафиксировать отработку отказа.

**Рис. 4. Репликация с сайта Hyper-V в Azure**

![Компоненты](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)

**Рис. 5. Репликация Hyper-V из облаков VMM в Azure**

![Компоненты](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)


## <a name="replicate-to-a-secondary-site"></a>Репликация на вторичный сайт

На дополнительный сайт можно реплицировать следующее:

- **VMware.** Локальные виртуальные машины VMware, запущенные на [поддерживаемом узле](site-recovery-support-matrix-to-sec-site.md#on-premises-servers). Вы можете реплицировать виртуальные машины VMware, выполняемые в [поддерживаемых операционных системах](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions).
- **Физические компьютеры.** Локальные физические серверы под управлением Windows или Linux в [поддерживаемых операционных системах](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions).
- **Hyper-V.** Локальные виртуальные машины Hyper-V, запущенные на [поддерживаемых узлах](site-recovery-support-matrix-to-sec-site.md#on-premises-servers), управление которыми происходит в облаках VMM. [Поддерживаемые узлы](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).


## <a name="vmwarephysical-to-a-secondary-site"></a>VMware или физический компьютер на дополнительный сайт

Репликация виртуальных машин VMware или физических серверов на дополнительный сайт осуществляется с помощью InMage Scout.

### <a name="components"></a>Компоненты

**Область** | **Компонент** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | InMage Scout. | Для использования InMage Scout необходимо иметь подписку Azure.<br/><br/> Создайте хранилище служб восстановления, затем скачайте InMage Scout и установите последние обновления, чтобы настроить развертывание.
**Сервер обработки** | Расположен на основном сайте | Разверните сервер обработки, который будет выполнять кэширование, сжатие и оптимизацию данных.<br/><br/> Кроме того, он обеспечивает принудительную установку единого агента на компьютеры, которые необходимо защитить.
**Сервер конфигурации** | Расположен на дополнительном сайте | Сервер конфигурации отвечает за управление, настройку и мониторинг развертывания с помощью веб-сайта управления или консоли vContinuum.
**Сервер vContinuum** | необязательный параметр. Устанавливается в том же расположении, что и сервер конфигурации. | Он предоставляет консоль для мониторинга защищенной среды и управления ею.
**Главный целевой сервер** | Расположен на дополнительном сайте | На главном целевом сервере хранятся реплицированные данные. Он получает данные с сервера обработки, создает реплицированный компьютер на дополнительном сайте и хранит точки хранения данных.<br/><br/> Необходимое количество главных целевых серверов зависит от количества защищаемых компьютеров.<br/><br/> Если нужно переключиться на основной сайт, вам также понадобится главный целевой сервер. Единый агент устанавливается на этом сервере.
**VMware ESX/ESXi и сервер vCenter** |  Виртуальные машины размещаются на узлах ESX/ESXi. Управление узлами осуществляется с помощью сервера vCenter | Для репликации виртуальных машин VMware требуется инфраструктура VMware.
**Виртуальные машины или физические серверы** |  Единый агент устанавливается на виртуальных машинах VMware и физических серверах, репликацию которых необходимо выполнить. | Агент обеспечивает обмен данными между всеми компонентами.


### <a name="replication-process"></a>Процесс репликации

1. Настройте серверы компонентов для каждого сайта (сервер конфигурации, сервер обработки, главный целевой сервер) и установите унифицированный агент на компьютеры, которые требуется реплицировать.
2. После начальной репликации агент на каждом компьютере отправляет сведения об изменениях дельта-репликации на сервер обработки.
3. Сервер обработки оптимизирует эти данные и передает их на главный целевой сервер на дополнительном сайте. Сервер конфигурации управляет процессом репликации.

**Рис. 6. Репликация VMware в VMware**

![VMware в VMware](./media/site-recovery-components/vmware-to-vmware.png)



## <a name="hyper-v-to-a-secondary-site"></a>Hyper-V на дополнительный сайт

Для репликации виртуальных машин Hyper-V на дополнительный сайт вам потребуется следующее.


**Область** | **Компонент** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | Вам потребуется учетная запись Microsoft Azure. |
**Сервер VMM** | Мы рекомендуем сервер VMM на основном и дополнительном сайтах. | Каждый сервер VMM должен быть подключен к Интернету.<br/><br/> На каждом сервере должно быть по крайней мере одно частное облако VMM с настроенным профилем возможностей Hyper-V.<br/><br/> Установите поставщик Azure Site Recovery на сервере VMM. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Обмен данными между поставщиком и Azure осуществляется по защищенным и зашифрованным каналам.
**Сервер Hyper-V** |  Понадобится один или несколько серверов узлов Hyper-V в основном и дополнительном облаках VMM.<br/><br/> Серверы должны быть подключены к Интернету.<br/><br/> Данные реплицируются между основным и дополнительным серверами узлов Hyper-V через локальную сеть или VPN-подключение с использованием проверки подлинности Kerberos или на основе сертификатов.  
**Виртуальные машины Hyper-V** | Расположен на сервере исходного узла Hyper-V. | На исходном сервере узла должна быть установлена как минимум одна виртуальная машина, которую необходимо реплицировать.

### <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить учетную запись Azure.
2. Необходимо создать хранилище служб репликации для Site Recovery и настроить параметры хранилища. В частности, необходимо сделать следующее.

    - Настроить источник и целевой объект репликации (основной и дополнительный сайты).
    - Установка поставщика Azure Site Recovery и агента служб восстановления Microsoft Azure. Поставщик устанавливается на серверах VMM, а агент — на каждом узле Hyper-V.
    - Создайте политику репликации для исходного облака VMM. Политика применяется ко всем виртуальным машинам, расположенным на узлах в облаке.
    - Включите репликацию для виртуальных машин Hyper-V. Начальная репликация выполняется в соответствии с параметрами политики репликации.
4. Отслеживаются изменения данных. Репликация разностных изменений в Azure начинается после завершения начальной репликации. Отслеживаемые изменения для элемента хранятся в HRL-файле.
5. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

**Рис. 7. Репликация VMM в VMM**

![Из локальной среды в локальную среду](./media/site-recovery-components/arch-onprem-onprem.png)

### <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения

1. Вы можете запустить плановую или внеплановую [отработку отказа](site-recovery-failover.md) между локальными сайтами. Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md) для координации отработки отказа нескольких компьютеров.
4. Если вы выполнили внеплановую отработку отказа с переносом на дополнительный сайт, то после этого компьютеры в дополнительном расположении не будут защищены и для них не будет выполняться репликация. Если вы выполнили плановую отработку отказа, то после этого компьютеры в дополнительном расположении будут защищены.
5. Затем необходимо зафиксировать отработку отказа для получения доступа к рабочей нагрузке из виртуальной машины реплики.
6. Когда основной сайт снова станет доступным, необходимо запустить обратную репликацию, чтобы она выполнялась с дополнительного сайта на основной. При обратной репликации виртуальные машины будут переведены в защищенное состояние, но при этом активным расположением по-прежнему останется дополнительный центр обработки данных.
7. Чтобы сделать активным расположением основной сайт, необходимо запустить плановую отработку отказа с переносом из дополнительного расположения в основное, а затем выполнить еще одну обратную репликацию.


## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о рабочем процессе репликации Hyper-V см. [здесь](site-recovery-hyper-v-azure-architecture.md).
- [Проверьте, соблюдены ли предварительные требования](site-recovery-prereq.md)

