<properties
	pageTitle="Как работает служба Site Recovery | Microsoft Azure"
	description="В этой статье описана общая архитектура службы Site Recovery"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="02/16/2016"
	ms.author="raynew"/>

# Как работает служба Azure Site Recovery?

В этой статье описываются базовая архитектура службы Site Recovery и ее компоненты. Если после прочтения статьи у вас возникнут какие-либо вопросы, вы можете задать их на [форуме, посвященном службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR), которая определяет, как приложения, рабочие нагрузки и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как организация сможет максимально быстро восстановить нормальный режим работы. Стратегия BCDR сосредоточена на решениях, обеспечивающих защиту и восстановление бизнес-данных, а также постоянную доступность рабочих нагрузок в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода на дополнительный сайт. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него.

Службу Site Recovery можно использовать в ряде сценариев. Она обеспечивает защиту нескольких рабочих нагрузок.

- **Защита виртуальных машин VMware**. Вы можете защитить локальные виртуальные машины VMware, реплицировав их в [Azure](site-recovery-vmware-to-azure-classic.md) или [дополнительный центр обработки данных (ЦОД)](site-recovery-vmware-to-vmware.md).
- **Защита виртуальных машин Hyper-V**. Локальные виртуальные машины Hyper-V в облачных средах VMM можно защитить путем их репликации в [Azure](site-recovery-vmm-to-azure.md) или [дополнительный ЦОД](site-recovery-vmm-to-vmm.md). В [Azure](site-recovery-hyper-v-site-to-azure.md) можно реплицировать виртуальные машины Hyper-V, которые не управляются VMM.
- **Защита физических серверов с помощью Azure**. Физические компьютеры под управлением Windows и Linux можно реплицировать в [Azure](site-recovery-vmware-to-azure-classic.md) или [дополнительный ЦОД](site-recovery-vmware-to-vmware.md).
- **Перенос виртуальных машин**. С помощью службы Site Recovery [виртуальные машины IaaS Azure можно переносить](site-recovery-migrate-azure-to-azure.md) из одного региона в другой, а [экземпляры AWS Windows](site-recovery-migrate-aws-to-azure.md) — на виртуальные машины IaaS Azure.

При помощи Site Recovery можно реплицировать большинство приложений, работающих на этих виртуальных машинах и физических серверах. Полный перечень поддерживаемых приложений см. в статье [Какие рабочие нагрузки можно защитить с помощью службы Azure Site Recovery?](site-recovery-workload.md)


## Репликация локальных виртуальных машин VMware и физических серверов в Azure

Если нужно защитить виртуальные машины VMware или физические компьютеры Windows или Linux путем их репликации в Azure, вам потребуется следующее.

В настоящее время для этого варианта репликации доступно две архитектуры.

- **Устаревшая архитектура**. Эта архитектура не должна использоваться для новых развертываний. 
- **Расширенная архитектура**. Это новейшее решение, которое следует использовать для всех новых развертываний. [Устаревшую архитектуру](site-recovery-vmware-to-azure-classic-legacy.md#migrate-to-the-enhanced-deployment) можно перевести на это решение.

Ниже представлена схема архитектуры для расширенного развертывания

![Расширенная архитектура](./media/site-recovery-components/arch-enhanced.png)

- **Локальная инфраструктура**. При развертывании расширенной архитектуры вам не нужно развертывать инфраструктурные виртуальные машины в Azure. Кроме того, в этом случае весь трафик шифруется и все данные, связанные с управлением репликацией, отправляются через защищенный канал (HTTPS, порт 443). Для локальной инфраструктуры вам потребуется следующее.

	- **Сервер управления**. Один сервер управления, на котором работают все компоненты Site Recovery, а именно:

		- **Сервер конфигурации**. Используется для управления соединением между локальной средой и облаком Azure, а также процессами репликации и восстановления данных.
		- **Сервер обработки**. Выступает в качестве шлюза репликации. Он получает данные с защищенных исходных компьютеров, оптимизирует их путем кэширования, сжатия и шифрования и отправляет данные репликации в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware. По мере увеличения масштабов развертывания вы можете добавлять дополнительные выделенные серверы исключительно для обработки больших объемов трафика репликации.
		- **Главный целевой сервер**. Обрабатывает данные репликации при восстановлении размещения из Azure. 

	- **Узел VMware ESX/ESXi и сервер vCenter**. Один или несколько серверов узлов ESX/ESXi, на которых установлены виртуальные машины VMware. Для управления этими узлами рекомендуется установить сервер vCenter. Обратите внимание, что среда VMware нужна даже при защите физических серверов. Она используется для восстановления размещения из Azure в локальной среде.
	
	- **Защищенные машины**. На каждой машине, которую нужно реплицировать в Azure, необходимо установить компонент Mobility Service. Она фиксирует операции записи данных на компьютере и перенаправляет их на сервер обработки. Этот компонент можно установить вручную или автоматически. Автоматическую установку выполняет сервер обработки, когда вы активируете защиту для конкретной машины.

- **Azure**. Для инфраструктуры Azure вам потребуется следующее.
	- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
	- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа. 
	- **Сеть Azure**. Вам потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Кроме того, нужно будет настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальной средой.

	![Расширенная архитектура](./media/site-recovery-components/arch-enhanced2.png)

Точные требования к развертыванию см. [здесь](site-recovery-vmware-to-azure-classic.md#before-you-start-deployment).

### Архитектура восстановления размещения

- Восстановление размещения из Azure должно выполняться на виртуальные машины VMware. В настоящее время восстанавливать размещение на физический сервер нельзя.
- Для восстановления размещения требуется VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальной сетью.
- Для восстановления размещения необходим сервер обработки в Azure. После восстановления его можно удалить.
- В локальной сети требуется главный целевой сервер. При локальной настройке главный целевой сервер по умолчанию устанавливается на сервер управления. Но при наличии больших объемов трафика для восстановления размещения рекомендуется в локальной сети настроить отдельный главный целевой сервер.

![Расширенное восстановление размещения](./media/site-recovery-components/enhanced-failback.png)

Дополнительные сведения о восстановлении размещения см. [здесь](site-recovery-failback-azure-to-vmware-classic.md).

### Устаревшая архитектура

Устаревшая архитектура предполагает наличие локальных серверов конфигурации и обработки, узлов VMware ESX/ESXi и сервера vCenter. Кроме того, на машинах, которые необходимо защитить, должна быть установлена служба Mobility Service. В Azure сервер конфигурации и главный целевой сервер устанавливаются на виртуальные машины. Вам также потребуется подписка Azure, учетная запись хранения и виртуальная сеть.



## Репликация виртуальных машин Hyper-V из облачных сред VMM в Azure

Если виртуальные машины расположены на узле Hyper-V, которым управляет облако System Center VMM, для их репликации в Azure понадобится следующее.

- В локальной сети: 
	- **Сервер VMM**. Как минимум один сервер VMM с как минимум одним частным облаком VMM. Сервер должен работать под управлением System Center 2012 R2. Сервер VMM должен быть подключен к Интернету. Чтобы виртуальные машины Azure оставались подключенными к сети после отработки отказа, необходимо настроить сетевое сопоставление. Для этого нужно подключить исходные виртуальные машины к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
	- **Сервер Hyper-V**. Как минимум один сервер узла Hyper-V, размещенный в облаке VMM. Узлы Hyper-V должны работать под управлением Windows Server 2012 R2.
	- **Защищенные машины**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
- Azure.
	- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
	- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа.
	- **Сеть Azure**. Чтобы виртуальные машины Azure оставались подключенными к сети после отработки отказа, необходимо настроить сетевое сопоставление. Для этого потребуется настроить сеть Azure.

	![VMM в Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

В этой ситуации на сервер VMM во время развертывания службы Site Recovery устанавливается поставщик Azure Site Recovery. Он координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Во время развертывания Site Recovery на сервере узла Hyper-V устанавливается агент служб восстановления Azure. Данные между ним и хранилищем Azure реплицируются через защищенный канал (HTTPS, порт 443). Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

Точные требования к развертыванию см. [здесь](site-recovery-vmm-to-azure.md#before-you-start).

## Репликация виртуальных машин Hyper-V в Azure (без использования VMM)

Если виртуальными машинами не управляет сервер System Center VMM, для их репликации в Azure понадобится следующее.

- В локальной сети: 
	- **Сервер Hyper-V**. По крайней мере один сервер узла Hyper-V. Узлы Hyper-V должны работать под управлением Windows Server 2012 R2.
	- **Защищенные машины**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
- Azure.
	- **Учетная запись Azure**. Вам потребуется учетная запись Microsoft Azure.
	- **Служба хранилища Azure**. Для хранения реплицированных данных вам потребуется учетная запись хранения Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа.

	![С сайта Hyper-V в Azure](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)

В этой ситуации на сервер VMM во время развертывания службы Site Recovery устанавливаются поставщик Azure Site Recovery и агент служб восстановления Azure. Поставщик координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Агент обрабатывает данные репликации через защищенный канал (HTTPS, порт 443). Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.

Точные требования к развертыванию см. [здесь](site-recovery-hyper-v-site-to-azure.md#before-you-start).

## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных

Если нужно защитить виртуальные машины Hyper-V, реплицируя их в дополнительный центр обработки данных, потребуется следующее. Обратите внимание, что это можно сделать, только если сервером узла Hyper-V управляет облако System Center VMM.

- **В локальной сети:** 
	- **Серверы VMM**. Мы рекомендуем использовать один сервер VMM в основном ЦОД и один — в дополнительном. В каждом ЦОД должно быть как минимум одно частное облако VMM. Сервер должен быть подключен к Интернету и работать под управлением System Center 2012 SP1 с последними обновлениями (или более новой версии этой ОС). В каждом облаке необходимо настроить профиль возможностей Hyper-V.
	- **Сервер Hyper-V**. Серверы узлов Hyper-V, размещенные в основном и дополнительном облаках VMM. Серверы узлов должны быть подключены к Интернету и работать под управлением Windows Server 2012 с последними обновлениями (или более поздней версии этой ОС).
	- **Защищенные машины**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
- **В Azure**: необходима подписка Azure.

	![Из локальной среды в локальную среду](./media/site-recovery-components/arch-onprem-onprem.png)

В этой ситуации во время развертывания службы Site Recovery на сервер VMM устанавливается поставщик Azure Site Recovery. Он координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Данные реплицируются между основным и дополнительным серверами узлов Hyper-V через локальную или VPN-сеть или по протоколу Kerberos или с использованием проверки подлинности на основе сертификата. Обмен данными между поставщиком и серверами узла Hyper-V осуществляется по защищенным и зашифрованным каналам.

Точные требования к развертыванию см. [здесь](site-recovery-vmm-to-vmm.md#before-you-start).



## Репликация виртуальных машин Hyper-V в дополнительный центр обработки данных с применением репликации сети SAN

Если виртуальные машины расположены на узле Hyper-V, которым управляет облако System Center VMM, и используется хранилище SAN, для репликации в два центра обработки данных понадобится следующее.

- **В локальной сети:** 
	- **Массив SAN**. [Поддерживаемый массив SAN](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx) под управлением основного сервера VMM. SAN использует сетевую инфраструктуру совместно с другим массивом SAN в дополнительном ЦОД.
	- **Серверы VMM**. Мы рекомендуем использовать один сервер VMM в основном ЦОД и один — в дополнительном. В каждом ЦОД должно быть как минимум одно частное облако VMM. Сервер должен быть подключен к Интернету и работать под управлением System Center 2012 SP1 с последними обновлениями (или более новой версии этой ОС). В каждом облаке необходимо настроить профиль возможностей Hyper-V.
	- **Сервер Hyper-V**. Серверы узлов Hyper-V, размещенные в основном и дополнительном облаках VMM. Серверы узлов должны быть подключены к Интернету и работать под управлением Windows Server 2012 с последними обновлениями (или более поздней версии этой ОС).
	- **Защищенные машины**. На исходном сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина, которую необходимо защитить.
	
- **В Azure**: необходима подписка Azure.

	![Репликация сети SAN](./media/site-recovery-components/arch-onprem-onprem-san.png)

В этой ситуации во время развертывания службы Site Recovery на сервер VMM устанавливается поставщик Azure Site Recovery. Он координирует процессы репликации и управляет ими через Интернет с помощью службы Site Recovery. Данные реплицируются между основным и дополнительным массивами хранения с помощью синхронной репликации сети SAN.

Точные требования к развертыванию см. [здесь](site-recovery-vmm-san.md#before-you-start).


## Репликация физических серверов или виртуальных машин VMware в дополнительный ЦОД

Если нужно защитить виртуальные машины VMware или физические компьютеры Windows или Linux путем их репликации в два локальных центра обработки данных, потребуется следующее.

- **В основном локальном ЦОД:** 
	- **Сервер обработки**. Настройте компонент сервера обработки на основном сайте для кэширования, сжатия и оптимизации данных. Кроме того, он обеспечивает принудительную установку единого агента на компьютеры, которые необходимо защитить.
	- **VMware ESX/ESXi и сервер vCenter**. Для защиты виртуальных машин VMware нужен гипервизор VMware EXS/ESXi или сервер VMware vCenter, управляющий несколькими гипервизорами.
	- Защищенные машины. Для защиты виртуальных машин VMware или физических серверов Windows и Linux потребуется установить единый агент. Единый агент также устанавливается на машину, выступающую в качестве главного целевого сервера. Он обеспечивает связь между всеми компонентами InMage.
	
- **В дополнительном локальном ЦОД:**
	- **Сервер конфигурации**. Сервер конфигурации — первый компонент, устанавливаемый на дополнительный сайт. Он отвечает за управление, настройку и мониторинг развертывания с помощью веб-сайта управления или консоли vContinuum. Сервер конфигурации также обладает механизмом принудительного удаленного развертывания единого агента. В развертывании используется только один сервер конфигурации, который должен быть установлен на компьютере под управлением Windows Server 2012 R2.
	- **Сервер vContinuum**. Устанавливается в том же расположении (дополнительный ЦОД), что и сервер конфигурации. Он предоставляет консоль для мониторинга защищенной среды и управления ею. При установке по умолчанию сервер vContinuum является первым главным целевым сервером с установленным единым агентом.
	- **Главный целевой сервер**. На главном целевом сервере хранятся реплицированные данные. Он получает данные с сервера обработки, создает реплицированный компьютер на дополнительном сайте и хранит точки хранения данных. Необходимое количество главных целевых серверов зависит от количества защищаемых компьютеров. Если нужно переключиться на основной сайт, вам также понадобится главный целевой сервер. 

- **В Azure**: необходима подписка Azure. Для настройки развертывания после создания хранилища Site Recovery скачайте InMage Scout. Нужно также установить последнее обновление для всех серверов компонентов InMage.


	![VMware в VMware](./media/site-recovery-components/vmware-to-vmware.png)

В этом случае единый агент, выполняющийся на защищаемом компьютере, отправляет сведения об изменениях разностной репликации на сервер обработки. Сервер обработки оптимизирует эти данные и передает их главному целевому серверу на дополнительном сайте. Сервер конфигурации управляет процессом репликации.


## Жизненный цикл защиты Hyper-V

Ниже описан рабочий процесс защиты, репликации и отработки отказа виртуальных машин Hyper-V.

1. **Включение защиты**. Выполняется настройка хранилища Site Recovery, настройка параметров репликации для облака VMM или сайта Hyper-V и включается защита виртуальных машин. Инициируется задание **Включение защиты**, ход выполнения которого можно отслеживать на вкладке **Задания**. При выполнении задания проверяется, соответствует ли компьютер необходимым требованиям, а затем вызывается метод [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию в Azure с помощью настраиваемых пользователем параметров. Кроме того, при выполнении задания **Включение защиты** вызывается метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) для инициализации полной репликации виртуальной машины.
2. **Начальная репликация**. Создается моментальный снимок виртуальной машины, и виртуальные жесткие диски реплицируются по одному, пока все они не будут скопированы в Azure или дополнительный центр обработки данных. Время выполнения этой процедуры зависит от размера и пропускной способности сети, а также выбранного способа начальной репликации. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище. Обратите внимание, что при выполнении начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска. После завершения начальной репликации моментальный снимок виртуальной машины удаляется, а изменения, произошедшие с дельта-диском, в журнале синхронизируются и объединяются.
3. **Завершение подготовки к защите**. После завершения начальной репликации выполняется задание **Завершение подготовки к защите**, в ходе которого настраивается сеть и другие параметры, настраиваемые после репликации. Теперь виртуальная машина защищена. При репликации в Azure может потребоваться настроить параметры виртуальной машины для обеспечения готовности к отработке отказа. На этом этапе можно выполнить тестовую отработку отказа, чтобы проверить, что все работает должным образом.
4. **Репликация**. После начальной репликации происходит разностная синхронизированная репликация в соответствии с параметрами и способом репликации. 
	- **Сбой репликации**.При сбое разностной репликации данных и если при полной репликации используется высокая пропускная способность или она выполняется долго происходит повторная синхронизация. Например, если HRL-файлы занимают 50 % места на диске, виртуальная машина помечается для повторной синхронизации. Повторная синхронизация минимизирует объем передаваемых данных. Для этого вычисляются контрольные суммы исходной и целевой виртуальной машины, а затем отправляется только полученная разница. После завершения повторной синхронизации возобновляется разностная репликация данных. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Повторную синхронизацию виртуальной машины можно выполнить вручную.
	- **Ошибка репликации**. При возникновении ошибки репликации используется встроенный алгоритм повторных попыток. Если произошла неустранимая ошибка, например ошибка проверки подлинности или авторизации, или реплицируемый компьютер находится в недопустимом состоянии, повторная попытка не выполняется. Если произошла устранимая ошибка, например ошибка в сети, нехватка свободного места на диске или объема памяти, происходит повторная попытка. После каждой повторной попытки интервал между повторными попытками увеличивается (через каждые 1, 2, 4, 8, 10 и затем 30 минут).
4. **Плановые и внеплановые отработки отказа**. Плановые и внеплановые отработки отказа выполняются по мере необходимости. Во избежание потери данных при выполнении плановой отработки отказа исходные виртуальные машины выключаются. После создания реплицированные виртуальные машины находятся в состоянии ожидания фиксации. Необходимо выполнить фиксацию для них, чтобы завершить отработку отказа. Если выполняется репликация с использованием сети SAN, фиксация выполняется автоматически. После запуска основного сайта может произойти восстановление размещения. Если репликация выполнялась в Azure, обратная репликация выполняется автоматически. В противном случае ее нужно запускать вручную.
 

![рабочий процесс](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## Дальнейшие действия

[Подготовка к развертыванию](site-recovery-best-practices.md).

<!---HONumber=AcomDC_0218_2016-->