---
title: "Тестовая отработка отказа (из облака VMM в облако VMM) в Site Recovery (Azure) | Документация Майкрософт"
description: "Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Узнайте о функции отработки отказа с выполнением переноса в Azure или в дополнительный центр обработки данных."
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: pratshar
ms.translationtype: Human Translation
ms.sourcegitcommit: 6b1a5b2879a7b98ec4ad3e8ebbc9e95c0740d89f
ms.openlocfilehash: 3aaa005319b1ce2a10cd913c63b31860d31b797e
ms.contentlocale: ru-ru
ms.lasthandoff: 02/23/2017


---
# <a name="test-failover-vmm-to-vmm-in-site-recovery"></a>Тестовая отработка отказа (из облака VMM в облако VMM) в Site Recovery
> [!div class="op_single_selector"]
> * [Тестовая отработка отказа в Azure](./site-recovery-test-failover-to-azure.md)
> * [Тестовая отработка отказа (между VMM)](./site-recovery-test-failover-vmm-to-vmm.md)


В данной статье содержатся сведения и инструкции по тестовой отработке отказа или тренировке аварийного восстановления виртуальных машин и физических серверов, защищенных с помощью Site Recovery, с использованием локального сайта под управлением VMM в качестве сайта восстановления.

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Тестовая отработка отказа выполняется для проверки стратегии репликации или анализа работы системы аварийного восстановления без потери данных или простоя. Выполнение тестовой отработки отказа никак не влияет на текущую репликацию или рабочую среду. Тестовую отработку отказа можно выполнить на виртуальной машине или в [плане восстановления](site-recovery-create-recovery-plans.md). При запуске тестовой отработки отказа необходимо указать сеть, к которой будут подключаться виртуальные машины. После запуска ход выполнения тестовой отработки отказа можно отслеживать на вкладке **Задания**.  


## <a name="preparing-infrastructure-for-test-failover"></a>Подготовка инфраструктуры для тестовой отработки отказа
* Если необходимо запустить тестовую отработку отказа, используя имеющуюся сеть, подготовьте Active Directory, DHCP и DNS в этой сети.
* Если необходимо запустить тестовую отработку отказа, используя функцию автоматического создания сетей виртуальных машин, то перед этим в плане восстановления, который вы собираетесь использовать для тестовой отработки отказа, добавьте выполняющийся вручную этап перед группой Group-1, а затем — ресурсы инфраструктуры в автоматически созданную сеть.

### <a name="things-to-note"></a>Примечания
* При репликации на дополнительный сайт необязательно, чтобы тип сети, используемой реплицированной машиной, соответствовал типу логической сети, используемой для тестовой отработки отказа, но при этом некоторые сочетания типов могут не работать. Если реплика использует DHCP и изоляцию на основе виртуальной локальной сети, то необязательно, чтобы у сети виртуальной машины для реплики был пул статических IP-адресов. Таким образом, не удастся использовать технологию виртуализации сети Windows для тестовой отработки отказа, так как не будет доступно ни одного пула адресов. Кроме того, тестовая отработка отказа не будет работать, если сеть реплики не изолирована и тестовая сеть представляет собой виртуализацию сети Windows. Это вызвано тем, что у неизолированной сети нет подсетей, необходимых для создания сети по технологии виртуализации сети Windows.
* Способ, которым реплицированные виртуальные машины подключаются к сопоставленным сетям виртуальных машин после отработки отказа, зависит от того, как сеть виртуальной машины настроена в консоли VMM.
  * **Сеть виртуальных машин настроена без изоляции или с изоляцией виртуальной локальной сети**. Если для сети виртуальных машин определен DHCP, то реплицированная виртуальная машина будет подключена к соответствующей виртуальной локальной сети с использованием параметров, указанных для сайта сети в сопоставленной логической сети. Виртуальная машина получит свой IP-адрес от доступного DHCP-сервера. Вам не потребуется пул статических IP-адресов, определенный для целевой сети виртуальных машин. Если для сети виртуальных машин используется пул статических IP-адресов, то реплицированная виртуальная машина будет подключена к идентификатору виртуальной локальной сети с помощью параметров, указанных для сайта сети в сопоставленной логической сети. Виртуальная машина получит свой IP-адрес из пула, определенного для сети виртуальных машин. Если пул статических IP-адресов не определен в целевой сети виртуальных машин, произойдет сбой выделения IP-адресов. Следует создать пул IP-адресов и на исходном, и на целевом серверах VMM, которые вы собираетесь использовать для защиты и восстановления.
  * **Сеть виртуальных машин с виртуализацией сети Windows**. Если сеть виртуальных машин настроена с помощью этого параметра, то следует определить пул статических IP-адресов для целевой сети виртуальных машин независимо от того, настроено ли в исходной сети виртуальных машин использование DHCP или пула статических IP-адресов. Если вы определили DHCP, целевой сервер VMM будет выступать в качестве DHCP-сервера и предоставлять IP-адрес из пула, определенного для целевой сети виртуальных машин. Если исходный сервер настроен так, чтобы использовать пул статических IP-адресов, то целевой VMM-сервер будет выделять IP-адрес из пула. Если пул статических IP-адресов не определен, то в обоих случаях выделение IP-адреса завершится ошибкой.


### <a name="prepare-dhcp"></a>Подготовка DHCP
Если виртуальные машины, участвующие в тестовой отработке отказа, используют DHCP, необходимо создать тестовый DHCP-сервер в изолированной сети, созданной для тестовой отработки отказа.

### <a name="prepare-active-directory"></a>Подготовка Active Directory
Чтобы выполнить тестовую отработку отказа для тестирования приложения, потребуется копия рабочей среды Active Directory в тестовой среде. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#test-failover-considerations).

### <a name="prepare-dns"></a>Подготовка DNS
Подготовьте DNS-сервер для тестовой отработки отказа указанным ниже образом.

* **DHCP**. Если виртуальные машины используют DHCP, необходимо обновить IP-адрес тестового DNS-сервера на тестовом DHCP-сервере. Если используется сеть с технологией виртуализации сети Windows, VMM-сервер будет выступать в роли DHCP-сервера. Следовательно, IP-адрес DNS-сервера должен обновляться в сети тестовой отработки отказа. В этом случае виртуальные машины будут регистрироваться на соответствующем DNS-сервере.
* **Статический адрес**. Если виртуальные машины используют статические IP-адреса, следует обновить IP-адрес тестового DNS-сервера в сети тестовой отработки отказа. Вам может потребоваться обновить DNS, указав IP-адреса тестовых виртуальных машин. Для этого можно использовать указанный ниже пример сценария.

        Param(
        [string]$Zone,
        [string]$name,
        [string]$IP
        )
        $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
        $newrecord = $record.clone()
        $newrecord.RecordData[0].IPv4Address  =  $IP
        Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord



## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
В этой процедуре описывается, как запустить тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины или физического сервера.

![Тестирование отработки отказа](./media/site-recovery-test-failover-vmm-to-vmm/TestFailover.png)

1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Последовательно выберите пункты **Тип отработки отказа** > **Test Тип отработки отказа**.
1. В колонке **Тестовая отработка отказа** укажите, каким способом виртуальные машины должны подключаться к сетям после тестовой отработки отказа. Дополнительные сведения см. в разделе [Параметры сети в Site Recovery](#network-options-in-site-recovery).
1. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания** .
1. После отработки отказа проверьте, успешно ли запущены виртуальные машины.
1. Когда все будет готово, нажмите кнопку **Cleanup test failover** (Очистить тестовую отработку отказа) в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин и сетей, созданных при тестовой отработке отказа.


## <a name="network-options-in-site-recovery"></a>Параметры сети в Site Recovery

При запуске тестовой отработки отказа вам будет предложено выбрать параметры сети для тестовых реплицированных машин. Вы можете выбрать один из нескольких вариантов.  

| **Вариант тестовой отработки отказа** | **Описание** | **Проверки, выполняемые при отработке отказа** | **Дополнительные сведения** |
| --- | --- | --- | --- |
| **Отработка отказа с выполнением переноса на вторичный сайт VMM без использования сети** |Не нужно выбирать сеть виртуальных машин. |При отработке отказа выполняется проверка того, созданы ли тестовые машины.<br/><br/>Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она не добавляется в облако, в котором находится реплика виртуальной машины. |<p>Машина, для которой выполняется отработка отказа, не подключается ни к какой сети.<br/><br/>Машину можно будет подключить к сети виртуальных машин после ее создания |
| **Отработка отказа с выполнением переноса на вторичный сайт VMM с использованием сети** |Необходимо выбрать существующую сеть виртуальных машин. |При отработке отказа выполняется проверка того, созданы ли виртуальные машины. |Тестовая виртуальная машина будет создана на том же узле, на котором имеется реплицированная виртуальная машина. Она не добавляется в облако, в котором находится реплика виртуальной машины.<br/><br/>Создайте сеть виртуальных машин, которая будет изолирована от вашей рабочей сети<br/><br/>Если вы используете сеть на основе виртуальной локальной сети, то рекомендуется создать в VMM отдельную логическую сеть (которая не будет применяться в рабочих целях). Эта логическая сеть используется для создания сетей виртуальных машин для тестовой отработки отказа.<br/><br/>Логическая сеть должна быть связана по крайней мере с одним сетевым адаптером всех серверов Hyper-V, на которых размещаются виртуальные машины.<br/><br/>Сайты сети, добавляемые в виртуальную логическую сеть, должны быть изолированы.<br/><br/>При использовании логической сети на базе виртуализации сети Windows Azure Site Recovery автоматически создает изолированные сети виртуальных машин. |
| **Отработка отказа с выполнением переноса на вторичный сайт VMM с созданием сети** |На основе параметра, заданного вами для **логической сети** , и связанных с ним сайтов сети будет автоматически создана временная тестовая сеть. |При отработке отказа выполняется проверка того, созданы ли виртуальные машины. |Используйте этот параметр, если план восстановления использует несколько сетей виртуальных машин. При выборе этого варианта для сетей на базе технологии виртуализации сети Windows можно автоматически создавать сети виртуальных машин с теми же параметрами (подсети и пулы IP-адресов), что и параметры сети реплицированной виртуальной машины. Такие сети виртуальных машин автоматически очищаются после завершения тестовой отработки отказа.</p><p>Тестовая виртуальная машина будет создана на том же узле, на котором имеется реплицированная виртуальная машина. Она не добавляется в облако, в котором находится реплика виртуальной машины. |

> [!TIP]
> IP-адрес, выделенный виртуальной машине при тестовой отработки отказа, должен совпадать с IP-адресом, который она бы получила при выполнении плановой или внеплановой отработки отказа (если этот IP-адрес доступен в сети тестовой отработки отказа). Если такой IP-адрес недоступен в сети тестовой отработки отказа, виртуальная машина получит другой IP-адрес, доступный в сети тестовой отработки отказа.
>
>


## <a name="test-failover-to-a-production-network-on-recovery-site"></a>Тестовая отработка отказа в рабочую сеть на сайте восстановления
При выполнении тестовой отработки отказа рекомендуется выбрать сеть, которая отличается от рабочей сети сайта восстановления, указанной в разделе параметров **Сетевое сопоставление**. Но если вы действительно хотите проверить сквозное сетевое подключение на виртуальной машине, для которой выполнена отработка отказа, то обратите внимание на следующие моменты:

1. При выполнении тестовой отработки отказа убедитесь, что работа основной виртуальной машины была завершена. Если этого не сделать, то в одной сети будут одновременно работать две виртуальные машины с одинаковыми идентификаторами, а это может привести к нежелательным последствиям.
1. Любые изменения, внесенные на виртуальных машинах тестовой отработки отказа, будут потеряны при выполнении очистки этих машин. Эти изменения не будут реплицироваться обратно на основную виртуальную машину.
1. Такой способ тестирования приводит к простою рабочего приложения. Необходимо попросить пользователей не использовать приложение во время тренировки аварийного восстановления.  


## <a name="next-steps"></a>Дальнейшие действия
После успешной тестовой отработки отказа можно попробовать выполнить [отработку отказа](site-recovery-failover.md).

