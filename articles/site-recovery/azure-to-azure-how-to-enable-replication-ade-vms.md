---
title: Настройка репликации для виртуальных машин с поддержкой шифрования дисков Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить репликацию для виртуальных машин с поддержкой шифрования дисков Azure между регионами Azure с помощью Site Recovery.
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 11/27/2018
ms.author: sutalasi
ms.openlocfilehash: f9abc6d79bd821ef612e9e7648b1b5af98bb5cf6
ms.sourcegitcommit: 75fef8147209a1dcdc7573c4a6a90f0151a12e17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2019
ms.locfileid: "56456237"
---
# <a name="replicate-azure-disk-encryption-ade-enabled-virtual-machines-to-another-azure-region"></a>Репликация виртуальных машин с поддержкой шифрования дисков Azure в другой регион Azure

В этой статье описывается, как включить репликацию виртуальных машин с поддержкой шифрования дисков Azure между регионами Azure.

>[!NOTE]
>Azure Site Recovery в настоящее время поддерживает только виртуальные машины Azure под управлением ОС Windows, в которых [включено шифрование с помощью приложения Azure AD](https://aka.ms/ade-aad-app).
>

## <a name="required-user-permissions"></a>Необходимые разрешения пользователя
Для работы с Azure Site Recovery необходимо, чтобы у пользователя было разрешение на создание хранилища ключей в целевом регионе и копирование ключей в этот регион.

Чтобы включить репликацию виртуальных машин с поддержкой шифрования дисков Azure на портале, у пользователя должны быть перечисленные ниже разрешения.
- Разрешения по отношению к хранилищу ключей:
    - list
    - Создание
    - Получить

-   Разрешения по отношению к секретам хранилища ключей:
    - список
    - Создание
    - Получить

- Разрешения по отношению к ключам в хранилище ключей (требуется только в том случае, если виртуальные машины используют ключ шифрования ключа для шифрования ключей шифрования дисков):
    - список
    - Получить
    - Создание
    - шифрование;
    - расшифровка;

Чтобы управлять разрешениями, перейдите к ресурсу хранилища ключей на портале и добавьте необходимые разрешения пользователю. Например, в приведенном ниже пошаговом руководстве показано, как добавить разрешение для хранилища ключей ContosoWeb2Keyvault, которое находится в исходном регионе.


-  Перейдите к меню "Домашняя страница"> "Хранилища ключей"> ContosoWeb2KeyVault> "Политики доступа".

![Разрешения хранилища ключей](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)



- Как видите, разрешение отсутствует. Поэтому добавьте вышеупомянутое разрешение, нажав "Добавить новое", а также пользователя и другие разрешения.

![Разрешения хранилища ключей](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

Если у пользователя, который включает аварийное восстановление, нет необходимых разрешений для копирования ключей, то сценарий ниже можно предоставить администратору безопасности с соответствующими разрешениями для копирования секретов и ключей шифрования в целевой регион.

См. дополнительные сведения об устранении неполадок, связанных с разрешениями, в [этой статье](#trusted-root-certificates-error-code-151066).
>[!NOTE]
>Чтобы включить репликацию виртуальной машины с включенным шифрованием дисков Azure на портале, требуется хотя бы разрешения на перечисление по отношению к хранилищам ключей, секретам и ключам.
>

## <a name="copy-ade-keys-to-dr-region-using-powershell-script"></a>Копирование ключей шифрования дисков Azure в регион аварийного восстановления с помощью сценария PowerShell

1. В окне браузера откройте код необработанного сценария CopyKeys, щелкнув [эту ссылку](https://aka.ms/ade-asr-copy-keys-code).
2. Скопируйте сценарий в файл и назовите его Copy-keys.ps1.
2. Откройте приложение Windows PowerShell и перейдите в расположение папки, где находится файл.
3. Запустите файл Copy-keys.ps1.
4. Укажите учетные данные для входа в Azure.
5. Выберите **подписку Azure**, к которой относятся виртуальные машины.
6. Дождитесь загрузки групп ресурсов, а затем выберите **группу ресурсов** виртуальных машин.
7. Выберите виртуальные машины из отображаемого списка. В списке отображаются только виртуальные машины с включенным шифрованием дисков Azure.
8. Выберите **целевое расположение**.
9. **Хранилища ключей для шифрования дисков**. По умолчанию Azure Site Recovery создает хранилище ключей в целевом регионе с именем, содержащим суффикс asr, используя ключи шифрования дисков исходной виртуальной машины. Если хранилище ключей, создаваемое Azure Site Recovery, уже существует, оно будет использовано повторно. При необходимости в списке можно выбрать другое хранилище ключей.
10. **Хранилища ключей для шифрования ключей**. По умолчанию Azure Site Recovery создает хранилище ключей в целевом регионе с именем, содержащим суффикс asr, используя ключи шифрования ключа исходной виртуальной машины. Если хранилище ключей, создаваемое Azure Site Recovery, уже существует, оно будет использовано повторно. При необходимости в списке можно выбрать другое хранилище ключей.

## <a name="enable-replication"></a>Включение репликации

Предполагается, что основной регион Azure — это "Восточная Азия", а дополнительный — "Юго-Восточная Азия".

1. В хранилище щелкните **+Replicate** (+Репликация).
2. Обратите внимание на следующие поля:
    - **Источник**. Источник происхождения виртуальных машин, в нашем примере это **Azure**.
    - **Расположение источника**. Регион Azure, в котором вы хотите защитить свои виртуальные машины. В этом примере исходным расположением является "Восточная Азия".
    - **Модель развертывания**. Модель развертывания Azure для исходных компьютеров.
    - **Исходная подписка**. Подписка, к которой принадлежат исходные виртуальные машины. Это может быть любая подписка в одном клиенте Azure Active Directory, где существует хранилище служб восстановления.
    - **Группа ресурсов**. Группа ресурсов, к которой принадлежат исходные виртуальные машины. Для защиты на следующем шаге будут перечислены все виртуальные машины в выбранной группе ресурсов.

3. В разделе **Виртуальные машины > Выбор виртуальных машин** выберите все виртуальные машины, которые нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Затем нажмите кнопку **ОК**.

4. В разделе **Параметры** можно при необходимости настроить параметры целевого веб-сайта:

    - **Целевое расположение**. Расположение, в которое будут реплицированы данные исходных виртуальных машин. В зависимости от расположения выбранной машины Site Recovery предоставит список подходящих целевых регионов. Мы рекомендуем сохранить такое же целевое расположение, что и расположение хранилищ служб восстановления.
    - **Целевая подписка**. Целевая подписка, которая используется для аварийного восстановления. По умолчанию целевая подписка будет совпадать с исходной подпиской.
    - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины. По умолчанию Azure Site Recovery создаст группу ресурсов в целевом регионе с суффиксом "asr". Если группа ресурсов, создаваемая Azure Site Recovery, уже существует, она будет использована повторно. Можно также настроить ее, как показано в следующем разделе. Целевая группа ресурсов может располагаться в любом регионе Azure, за исключением того, в котором размещены исходные виртуальные машины.
    - **Целевая виртуальная сеть**. По умолчанию Site Recovery создает в целевом регионе виртуальную сеть с суффиксом asr. Она будет сопоставлена с исходной сетью и будет использоваться для защиты в будущем. [Узнайте больше](site-recovery-network-mapping-azure-to-azure.md) о сетевом сопоставлении.
    - **Целевые учетные записи хранения (если исходная виртуальная машина не использует управляемые диски)**. По умолчанию Site Recovery создает целевую учетную запись хранения, копируя конфигурацию хранилища с исходной виртуальной машины. В случае, если учетная запись хранения уже существует, она используется повторно.
    - **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)**. Служба Site Recovery создает управляемые диски реплики в целевом регионе, которые отражают управляемые диски исходной виртуальной машины с тем же типом хранилища (класса "Стандартный" или "Премиум"), что и на управляемом диске исходной виртуальной машины.
    - **Учетные записи хранения кэша**. Для Site Recovery в исходном регионе должна существовать дополнительная учетная запись хранения, называемая учетной записью хранения кэша. Все изменения, происходящие на исходных виртуальных машинах, отслеживаются и отправляются учетной записи хранения кэша перед репликацией в целевое расположение.
    - **Группа доступности**. По умолчанию Azure Site Recovery создаст группу доступности в целевом регионе, добавив к ее имени суффикс asr. Если группа доступности, создаваемая Azure Site Recovery, уже существует, она будет использована повторно.
    - **Хранилища ключей для шифрования дисков**. По умолчанию Azure Site Recovery создает хранилище ключей в целевом регионе с именем, содержащим суффикс asr, используя ключи шифрования дисков исходной виртуальной машины. Если хранилище ключей, создаваемое Azure Site Recovery, уже существует, оно будет использовано повторно.
    - **Хранилища ключей для шифрования ключей**. По умолчанию Azure Site Recovery создает хранилище ключей в целевом регионе с именем, содержащим суффикс asr, используя ключи шифрования ключа исходной виртуальной машины. Если хранилище ключей, создаваемое Azure Site Recovery, уже существует, оно будет использовано повторно.
    - **Политика репликации**. Определяет параметры для журнала хранения точки восстановления и периодичность создания моментальных снимков, совместимых на уровне приложений. По умолчанию Azure Site Recovery создает политику репликации с параметрами по умолчанию "24 часа" для хранения точки восстановления и "60 минут" — для периодичности создания моментальных снимков с согласованием приложений.



## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Можно изменить целевые параметры по умолчанию, используемые Site Recovery.


1. Нажмите кнопку **Настройка** рядом с пунктом "Целевая подписка", чтобы изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступных в одном клиенте Azure Active Directory (AAD).

2. Чтобы изменить указанные ниже параметры по умолчанию, щелкните **Настройка** рядом с заголовком "Resource group, Network and Availability sets" (Группа ресурсов, сеть и группы доступности):
    - **Целевая группа ресурсов**. Выберите группу ресурсов из списка групп ресурсов в целевом расположении подписки.
    - **Target Virtual Network** (Целевая виртуальная сеть). Выберите сеть из списка всех виртуальных сетей в целевой локации.
    - **Группа доступности**. Здесь можно добавить параметры группы доступности для виртуальной машины, если она является частью группы доступности исходного региона.
    - **Target Storage accounts** (Целевые учетные записи хранения). Выберите учетную запись хранения, которую нужно использовать.


2. Щелкните **Настройка** рядом с пунктом "Параметры шифрования" для изменения указанных ниже параметров по умолчанию:
    - В поле **Целевое хранилище ключей шифрования дисков** выберите целевое хранилище ключей шифрования дисков из списка всех хранилищ ключей в целевом расположении подписки.
  - В поле **Целевое хранилище ключей шифрования ключей** выберите целевое хранилище ключей шифрования ключей из списка всех хранилищ ключей в целевом расположении подписки.

3. Щелкните **Create target resource** (Создать целевой ресурс) > **Включить репликацию**.
4. После включения репликации виртуальных машин можно проверить их состояние работоспособности в разделе **Реплицированные элементы**.

>[!NOTE]
>Во время начальной репликации обновление состояния может занять некоторое время (без видимого прогресса). Щелкните **Обновить**, чтобы получить последние сведения о состоянии задания.
>

## <a name="update-target-vm-encryption-settings"></a>Обновление параметров шифрования целевой виртуальной машины
В приведенных ниже сценариях необходимо обновить параметры шифрования целевой виртуальной машины.
  - Вы включили репликацию Site Recovery на виртуальной машине, а позже шифрование дисков Azure на исходной виртуальной машине.
  - Вы включили репликацию Site Recovery на виртуальной машине, а затем изменили ключ шифрования диска или ключ шифрования ключа на исходной виртуальной машине.

Вы можете использовать [сценарий](#copy-ade-keys-to-dr-region-using-powershell-script), чтобы копировать ключи шифрования в целевой регион, а затем обновить целевые параметры шифрования в разделе **Хранилище служб восстановления -> реплицированный элемент -> Свойства -> Вычисления и сеть**.

![update-ade-settings](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a name="trusted-root-certificates-error-code-151066"></a>Устранение неполадок, связанных с разрешениями хранилища ключей, во время репликации виртуальной машины Azure-Azure.

**Причина 1**. Возможно, вы выбрали уже созданное хранилище ключей из целевого региона без необходимых разрешений.
Если хранилище ключей выбрано в целевом регионе, а не создано в Azure Site Recovery, убедитесь, что для хранилища ключей назначены необходимые разрешения, как описано выше.</br>
*Пример*. Пользователь пытается реплицировать виртуальную машину с хранилищем ключей в исходном регионе, например ContososourceKeyvault.
У пользователя есть все разрешения для работы с хранилищем ключей исходного региона, но во время настройки защиты он выбрал уже созданное хранилище ключей ContosotargetKeyvault. Для этого хранилища не назначены разрешения, и из системы защиты поступает сообщение об ошибке.</br>
**Как исправить:** Перейдите к меню "Домашняя страница"> "Хранилища ключей"> ContososourceKeyvault> "Политики доступа" и добавьте разрешения, как показано выше. 

**Причина 2.** Возможно, вы выбрали уже созданное хранилище ключей из целевого региона без разрешений на шифрование и расшифровку.
Если хранилище ключей выбрано в целевом регионе, а не создано в Azure Site Recovery, убедитесь, что у пользователя есть разрешения на шифрование и расшифровку (если ключ также шифруется в исходном регионе).</br>
*Пример*. Пользователь пытается реплицировать виртуальную машину с хранилищем ключей в исходном регионе, например ContososourceKeyvault.
У пользователя есть все разрешения для работы с хранилищем ключей исходного региона, но во время настройки защиты он выбрал уже созданное хранилище ключей ContosotargetKeyvault. Для этого хранилища не назначены разрешения на шифрование и расшифровку.</br>
**Как исправить:** Перейдите к меню "Домашняя страница"> "Хранилища ключей"> ContososourceKeyvault> "Политики доступа" и добавьте разрешения в разделе "Разрешения ключей"> "Операции шифрования".

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о выполнении тестовой отработки отказа см. в [этой статье](site-recovery-test-failover-to-azure.md).
