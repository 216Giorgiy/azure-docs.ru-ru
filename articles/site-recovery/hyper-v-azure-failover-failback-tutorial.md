---
title: Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в Azure, с помощью Site Recovery | Документация Майкрософт
description: Сведения об отработке отказа виртуальных машин Hyper-V в Azure и восстановлении размещения на локальном сайте с помощью Azure Site Recovery
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 03/8/2018
ms.author: raynew
ms.openlocfilehash: 7863feb29fbb04f643aa3b7e1984209f44cdbe9a
ms.sourcegitcommit: 8c3267c34fc46c681ea476fee87f5fb0bf858f9e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2018
ms.locfileid: "29852903"
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-azure"></a>Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в Azure

В этом руководстве содержатся сведения об отработке отказа виртуальных машин Hyper-V в Azure. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Проверка соответствия свойств виртуальной машины Hyper-V требованиям Azure
> * Выполнение отработки отказа в Azure
> * Повторное включение защиты виртуальных машин Azure на локальном сайте
> * Восстановление размещения из Azure в локальную среду
> * Повторное включение защиты локальных виртуальных машин для запуска повторной репликации в Azure

Это пятый учебник в серии. В этом учебнике предполагается, что вы уже выполнили задачи в предыдущих учебниках.

1. [Подготовка Azure](tutorial-prepare-azure.md)
2. [Подготовка локальной среды VMware](tutorial-prepare-on-premises-hyper-v.md).
3. Настройка аварийного восстановления [виртуальных машин Hyper-V](tutorial-hyper-v-to-azure.md) или [виртуальных машин Hyper-V, управляемых в облаках VMM System Center](tutorial-hyper-v-vmm-to-azure.md).
4. [Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)

## <a name="prepare-for-failover-and-failback"></a>Подготовка к отработке отказа и восстановлению размещения

Убедитесь, что на виртуальной машине нет моментальных снимков и что во время повторного включения защиты локальная виртуальная машина отключена. Это позволяет обеспечить согласованность данных во время репликации. Не включайте виртуальную машину после завершения повторного включения защиты. 

Отработка отказа и восстановление размещения происходит в четыре этапа.

1. **Отработка отказа с переходом в Azure.** Отработка отказа с переносом компьютеров с локального сайта в Azure.
2. **Повторное включение защиты виртуальных машин Azure.** Повторно включите защиту виртуальных машин, чтобы начать их репликацию на виртуальные машины Hyper-V, запущенные на локальном сайте.
3. **Отработка отказа на локальный сайт.** Выполните отработку отказа из Azure на локальный сайт (если эта возможность доступна).
4. **Повторное включение защиты локальных виртуальных машин.** После восстановления размещения данных повторно включите защиту локальных виртуальных машин, чтобы начать их репликацию в Azure.

## <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](hyper-v-azure-support-matrix.md#replicated-vms).

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

2. В области **Реплицированный элемент** просмотрите данные о виртуальной машине, в том числе состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.
     - В разделе **Вычисления и сеть** можно изменить параметры виртуальной машины и сети, в том числе сеть и подсеть, в которой будет находиться виртуальная машина Azure после отработки отказа, а также присвоенный ей IP-адрес. Восстановление размещения управляемых дисков из Azure на
   виртуальную машину Hyper-V не поддерживается.
    - В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.

## <a name="fail-over-to-azure"></a>Отработка отказа с переходом в Azure

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **последнюю** точку восстановления. 
3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается завершить работу исходных виртуальных машин перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.
4. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> **Не отменяйте выполняющуюся отработку отказа**. Перед запуском отработки отказа останавливается репликация виртуальной машины. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.

## <a name="reprotect-azure-vms"></a>Повторное включение защиты виртуальных машин Azure

1. В разделе **AzureVMVault** > **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину, отработка отказа которой проводилась, и выберите **Защитить повторно**.
2. Убедитесь, что в качестве направления защиты выбрано **Из Azure на локальный компьютер**.
3. Во время повторного включения защиты локальная виртуальная машина отключается, что обеспечивает согласованность данных. Не включайте ее после завершения повторного включения защиты.
4. После повторного включения защиты на виртуальной машине запускается репликация из Azure на локальный сайт.



## <a name="fail-over-from-azure-and-reprotect-the-on-premises-vm"></a>Отработка отказа из Azure и повторное включение защиты локальной виртуальной машины

Выполните отработку отказа из Azure на локальный сайт и начните репликацию виртуальных машин с локального сайта в Azure.

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Плановая отработка отказа**.
2. В разделе **Подтвердить плановую отработку отказа** проверьте направление отработки отказа (из Azure) и выберите исходное и целевое расположение.
3. Выберите **Синхронизация данных до отработки отказа (синхронизация только изменений)**. Этот параметр сокращает время простоя виртуальной машины, так как синхронизация выполняется без выключения виртуальной машины.
4. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
5. Когда вы будете готовы завершить работу виртуальных машин Azure после изначальной синхронизации данных, выберите **Задания**, имя задания плановой отработки отказа и **Завершение отработки отказа**. Эта команда завершит работу виртуальной машины Azure, передаст последние изменения в локальную среду и выполнит запуск локальной виртуальной машины.
6. Войдите в локальную виртуальную машину, чтобы проверить, доступна ли она, как и ожидалось.
7. Теперь локальная виртуальная машина находится в состоянии **ожидания фиксации**. Нажмите кнопку **Зафиксировать**. Эта команда удаляет виртуальные машины Azure и их диски, а также подготавливает локальную виртуальную машину к обратной репликации.
Чтобы запустить репликацию локальной виртуальной машины в Azure, включите **обратную репликацию**. Это запускает репликацию изменений, произошедших с момента выключения виртуальной машины Azure.  
