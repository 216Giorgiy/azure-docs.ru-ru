---
title: "Добавление модулей Runbook службы автоматизации Azure в планы восстановления | Документация Майкрософт"
description: "В этой статье описывается, как Azure Site Recovery позволяет расширить планы восстановления с помощью службы автоматизации Azure для выполнения сложных задач во время восстановления в Azure."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: ecece14d-5f92-4596-bbaf-5204addb95c2
ms.service: site-recovery
ms.devlang: powershell
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: required
ms.date: 10/23/2016
ms.author: ruturajd@microsoft.com
translationtype: Human Translation
ms.sourcegitcommit: 5614c39d914d5ae6fde2de9c0d9941e7b93fc10f
ms.openlocfilehash: 9f9a71cd7c6688dfd42dcb7ce52847f2016daf58


---
# <a name="add-azure-automation-runbooks-to-recovery-plans"></a>Добавление модулей Runbook службы автоматизации Azure в планы восстановления
В этом руководстве описывается, как Azure Site Recovery интегрируется со службой автоматизации Azure для обеспечения расширяемости для планов восстановления. Планы восстановления позволяют управлять восстановлением виртуальных машин, защищенных с помощью Azure Site Recovery, как для репликации в дополнительное облако, так и для репликации в сценарии Azure. Они также помогают реализовать **точное**, **воспроизводимое** и **автоматическое** восстановление. Если выполняется отработка отказа с переносом виртуальных машин в Azure, интеграция со службой автоматизации Azure позволяет расширить планы восстановления и предоставляет возможность выполнять Runbook, а это, в свою очередь, позволяет значительно облегчить выполнение задач автоматизации.

Если вы еще не знакомы со службой автоматизации Azure, зарегистрируйтесь [здесь](https://azure.microsoft.com/services/automation/) и скачайте примеры сценариев [здесь](https://azure.microsoft.com/documentation/scripts/). Дополнительные сведения об [Azure Site Recovery](https://azure.microsoft.com/services/site-recovery/) и о том, как управлять восстановлением в Azure с помощью планов восстановления, см. [здесь](https://azure.microsoft.com/blog/?p=166264).

В данном руководстве мы рассмотрим то, как можно интегрировать модули Runbook службы автоматизации Azure в планы восстановления. Мы автоматизируем выполнение простых задач, которые ранее требовалось выполнять вручную, и узнаем, как преобразовать процесс восстановления, включающий несколько этапов, в действие восстановления одним щелчком мыши. Также мы рассмотрим порядок устранения ошибок, возникающих при выполнении простого сценария.

## <a name="customize-the-recovery-plan"></a>Настройка плана восстановления
1. Начнем с открытия колонки ресурсов плана восстановления. Как вы видите, в план восстановления добавлено две виртуальные машины для восстановления.

    ![](media/site-recovery-runbook-automation-new/essentials-rp.PNG)
- - -
1. Чтобы добавить модуль Runbook, нажмите кнопку "Настроить". Откроется колонка настройки плана восстановления.

    ![](media/site-recovery-runbook-automation-new/customize-rp.PNG)


1. Щелкните правой кнопкой мыши начальную группу 1 и выберите "Добавить завершающее действие".
2. Щелкните, чтобы выбрать сценарий в новой колонке.
3. Назовите этот сценарий "Hello, World".
4. Выберите имя учетной записи службы автоматизации Azure. Это учетная запись службы автоматизации Azure. Обратите внимание, что эта учетная запись может находиться в любой географии Azure, но должна быть в той же подписке, что и как хранилище Site Recovery.
5. Выберите Runbook из учетной записи службы автоматизации. Это сценарий, который будет запущен во время выполнения плана восстановления после восстановления первой группы.

    ![](media/site-recovery-runbook-automation-new/update-rp.PNG)
6. Нажмите кнопку "ОК", чтобы сохранить этот сценарий. Он будет добавлен в группу завершающих действий "Группа 1: запуск".

    ![](media/site-recovery-runbook-automation-new/addedscript-rp.PNG)


## <a name="salient-points-of-adding-a-script"></a>Ключевые моменты, связанные с добавлением сценария
1. Можно щелкнуть сценарий правой кнопкой мыши и выбрать "Удалить шаг" или "Изменить скрипт".
2. Сценарий можно запустить в Azure во время отработки отказа из локальной среды в Azure. Кроме того, он может быть запущен в Azure как первичный сценарий перед завершением работы во время восстановления размещения из Azure в локальную среду.
3. При запуске сценарий будет внедрять контекст плана восстановления.

Ниже приведен пример того, как выглядит переменная контекста.

        {"RecoveryPlanName":"hrweb-recovery",

        "FailoverType":"Test",

        "FailoverDirection":"PrimaryToSecondary",

        "GroupId":"1",

        "VmMap":{"7a1069c6-c1d6-49c5-8c5d-33bfce8dd183":

                {"CloudServiceName":"pod02hrweb-Chicago-test",

                "RoleName":"Fabrikam-Hrweb-frontend-test"}

                }

        }


В таблице ниже указаны имя и описание для каждой переменной в контексте.

| **Имя переменной** | **Описание** |
| --- | --- |
| RecoveryPlanName |Имя выполняемого плана. Позволяет предпринять действия на основе имени, используя тот же скрипт |
| FailoverType |Указывает, является ли выполнение тестовым, запланированным или незапланированным. |
| FailoverDirection |Указывает, производится ли восстановление в первичное или вторичное расположение |
| GroupID |Определяет номер группы в плане восстановления при выполнении плана |
| VmMap |Это массив всех виртуальных машин в группе. |
| Ключ VMMap |Уникальный ключ (GUID) для каждой виртуальной машины. Это то же самое, что и VMM ID виртуальной машины, там, где это применимо. |
| RoleName |Имя виртуальной машины Azure, для которой выполняется восстановление |
| CloudServiceName |Имя облачной службы Azure, под которой создана виртуальная машина. |
| CloudServiceName (в модели развертывания с помощью Resource Manager) |Имя группы ресурсов Azure, в которой создана виртуальная машина. |

## <a name="using-complex-variables-per-recovery-plan"></a>Использование сложных переменные в плане восстановления
В некоторых случаях для работы Runbook требуется больше информации, чем содержит RecoveryPlanContext. Не существует первоклассного механизма передачи параметра в Runbook. Тем не менее, если вы хотите использовать один и тот же сценарий в нескольких планах восстановления, то можете указать переменную контекста плана восстановления RecoveryPlanName и применить приведенную ниже экспериментальную методику, чтобы использовать сложную переменную службы автоматизации Azure в Runbook. В приведенном ниже примере показано, как создать три разных сложных переменных ресурса и использовать их в Runbook в зависимости от имени плана восстановления.

Предположим, вы хотите использовать 3 дополнительных параметра в Runbook. Закодируем их в формат JSON: {"Var1":"testautomation","Var2":"Unplanned","Var3":"PrimaryToSecondary"}.

Используйте [сложную переменную AA](../automation/automation-variables.md#variable-types), чтобы создать новый ресурс службы автоматизации.
Присвойте этой переменной имя <RecoveryPlanName>-params.
Для создания [сложной переменной](https://msdn.microsoft.com/library/dn913767.aspx?f=255&MSPPError=-2147217396) можно использовать приведенные здесь справочные данные.

Для разных планов восстановления присвойте переменной следующие имена:

1. recoveryPlanName1>-params
2. recoveryPlanName2>-params
3. recoveryPlanName3>-params

Теперь в сценарии укажите ссылки на переменные params следующим образом.

1. Получите имя плана восстановления из переменной $rpname = $Recoveryplancontext.
2. Получите ресурс $paramValue = "$($rpname)-params".
3. Используйте это в качестве сложной переменной для плана восстановления, добавив вызов AzureAutomationVariable [-AutomationAccountName] <String> -Name $paramValue.

Например, чтобы получить сложную переменную или параметр для плана восстановления SharepointApp, создайте сложную переменную службы автоматизации Azure с именем SharepointApp-params.

Используйте ее в плане восстановления, извлекая эту переменную из ресурса с помощью инструкции Get-AzureAutomationVariable [-AutomationAccountName] <String> [-Name] $paramValue. [Здесь приведены более подробные справочные материалы](https://msdn.microsoft.com/library/dn913772.aspx).

Таким образом, храня в ресурсах сложную переменную, зависящую от плана, один и тот же сценарий можно использовать для разных планов восстановления.

## <a name="sample-scripts"></a>Примеры сценариев
Коллекцию сценариев, которые можно непосредственно импортировать в учетную запись службы автоматизации, можно найти в [репозитории сценариев OMS Кристиана Ниса (Kristian Nese)](https://github.com/krnese/AzureDeploy/tree/master/OMS/MSOMS/Solutions/asrautomation).

Приведенный сценарий представляет собой шаблон Azure Resource Manager, который развернет все приведенные ниже сценарии.

* Группа безопасности сети (NSG)

Runbook NSG назначит общедоступные IP-адреса для каждой виртуальной машины в плане восстановления и подключит их виртуальные сетевые адаптеры к группе безопасности сети, что обеспечит связь по умолчанию.

* PublicIP

Runbook PublicIP назначит общедоступные IP-адреса для каждой виртуальной машины в плане восстановления. Доступ к виртуальным машинам и приложениям будет зависеть от параметров брандмауэра в каждом госте.

* CustomScript

Runbook CustomScript назначит общедоступные IP-адреса для каждой виртуальной машины в плане восстановления и установит расширение пользовательских сценариев, которое извлечет сценарий, указанный в ссылке, во время развертывания шаблона.

* NSGwithCustomScript

Runbook NSGwithCustomScript назначит общедоступные IP-адреса для каждой виртуальной машины в плане восстановления, установит пользовательский сценарий с помощью расширения и подключит виртуальные сетевые адаптеры к группе безопасности сети, чтобы обеспечить входящие и исходящие подключения по умолчанию для удаленного доступа.

## <a name="additional-resources"></a>Дополнительные ресурсы
[Учетная запись запуска от имени службы автоматизации Azure](../automation/automation-sec-configure-azure-runas-account.md)

[Обзор службы автоматизации Azure](http://msdn.microsoft.com/library/azure/dn643629.aspx "Обзор службы автоматизации Azure")

[Примеры сценариев службы автоматизации Azure](http://gallery.technet.microsoft.com/scriptcenter/site/search?f\[0\].Type=User&f\[0\].Value=SC%20Automation%20Product%20Team&f\[0\].Text=SC%20Automation%20Product%20Team "Примеры сценариев службы автоматизации Azure")



<!--HONumber=Nov16_HO3-->


