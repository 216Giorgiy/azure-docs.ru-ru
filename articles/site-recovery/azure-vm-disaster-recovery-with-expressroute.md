---
title: Использование ExpressRoute с аварийным восстановлением виртуальных машин Azure | Документация Майкрософт
description: В этой статье описывается, как использовать Azure ExpressRoute и Azure Site Recovery для аварийного восстановления виртуальных машин Azure
services: site-recovery
documentationcenter: ''
author: mayanknayar
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: manayar
ms.openlocfilehash: 73514b524f554affb9730ba63ccd608491497af2
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2018
ms.locfileid: "37920476"
---
# <a name="using-expressroute-with-azure-virtual-machine-disaster-recovery"></a>Использование ExpressRoute с аварийным восстановлением виртуальных машин Azure

Microsoft Azure ExpressRoute позволяет переносить локальные сети в облако Microsoft по частному подключению, которое обеспечивается поставщиком услуг подключения. В этой статье описывается, как использовать ExpressRoute совместно с Site Recovery для аварийного восстановления виртуальных машин Azure.

## <a name="prerequisites"></a>предварительным требованиям

Перед началом работы убедитесь, что вы хорошо понимаете следующие концепции:
-   [каналы](../expressroute/expressroute-circuit-peerings.md) ExpressRoute;
-   [домены маршрутизации](../expressroute/expressroute-circuit-peerings.md#expressroute-routing-domains) ExpressRoute;
-   [архитектура репликации](azure-to-azure-architecture.md) виртуальных машин Azure;
-   [настройка репликации](azure-to-azure-tutorial-enable-replication.md) для виртуальных машин Azure;
-   [отработка отказа](azure-to-azure-tutorial-failover-failback.md) для виртуальных машин Azure.

## <a name="expressroute-and-azure-virtual-machine-replication"></a>ExpressRoute для репликации виртуальных машин Azure

Если виртуальные машины Azure защищены в Site Recovery, данные репликации отправляются в учетную запись хранения Azure или на реплику управляемого диска в целевом регионе Azure, в зависимости от того, используют ли защищенные виртуальные машины Azure [управляемые диски Azure](../virtual-machines/windows/managed-disks-overview.md). Конечные точки репликации являются открытыми, но трафик репликации для виртуальных машин Azure по умолчанию не выходит в Интернет, независимо от того, в каком исходном регионе Azure создана виртуальная сеть.

Так как данные репликации никогда не покидают платформу Azure, для аварийного восстановления виртуальной машины Azure не требуется ExpressRoute. После отработки отказа виртуальных машин в целевой регион Azure вы можете обращаться к ним через [частный пиринг](../expressroute/expressroute-circuit-peerings.md#azure-private-peering).

## <a name="replicating-azure-deployments"></a>Репликация развертываний Azure

В предыдущей [статье](site-recovery-retain-ip-azure-vm-failover.md#on-premises-to-azure-connectivity) описана простая схема, в которой одна виртуальная сеть Azure подключена к локальному клиентскому центру обработки данных через ExpressRoute. В стандартных корпоративных развертываниях рабочие нагрузки распределяются по нескольким виртуальным сетям Azure, а центральный концентратор поддерживает все внешние подключения, в том числе к Интернету и локальным развертываниям.

В этом примере описывается звездообразная топология, которая часто используется для корпоративных развертываний.
-   Развертывание выполняется в регионе Azure **Восточная Азия**, а в локальном центре обработки данных создается подключение ExpressRoute через партнерский пограничный сервер в Гонконге.
-   Приложения развертываются в двух периферийных виртуальных сетях: **Source VNet1** с диапазоном адресов 10.1.0.0/24 и **Source VNet2** с диапазоном адресов 10.2.0.0/24.
-   Виртуальная сеть концентратора с именем **Source Hub VNet** и диапазоном адресов 10.10.10.0/24 выступает в роли привратника. Весь обмен данными между подсетями происходит через концентратор.
-   Виртуальная сеть концентратора имеет две подсети: **подсеть NVA** с диапазоном адресов 10.10.10.0/25 и **подсеть шлюза** с диапазоном адресов 10.10.10.128/25.
-   В **подсети NVA** развернут виртуальный сетевой модуль с IP-адресом 10.10.10.10.
-   В **подсети шлюза** есть шлюз ExpressRoute с настроенным подключением ExpressRoute, по которому данные передаются в локальный центр обработки данных через домен маршрутизации с частным пирингом.
-   Каждая периферийная виртуальная сеть подключена к виртуальной сети концентратора, а вся маршрутизация в этой сетевой топологии осуществляется через таблицы маршрутов Azure (UDR). Весь исходящий трафик из одной виртуальной сети к другой или к локальному центру обработки данных направляется через виртуальный сетевой модуль.

![Подключение ExpressRoute между локальной средой и Azure до отработки отказа](./media/azure-vm-disaster-recovery-with-expressroute/site-recovery-with-expressroute-before-failover.png)

### <a name="hub-and-spoke-peering"></a>Пиринг от периферийной сети к концентратору

Пиринг от периферийной сети к концентратору настроен следующим образом:
-   Allow virtual network address (Диапазон адресов виртуальной сети): включено.
-   Разрешить перенаправленный трафик: включено.
-   Разрешить транзит шлюзов: отключено.
-   Использовать удаленные шлюзы: включено.

 ![Конфигурация пиринга от периферийной сети к концентратору](./media/azure-vm-disaster-recovery-with-expressroute/spoke-to-hub-peering-configuration.png)

Пиринг от концентратора к периферийной сети настроен следующим образом.
-   Allow virtual network address (Диапазон адресов виртуальной сети): включено.
-   Разрешить перенаправленный трафик: включено.
-   Разрешить транзит шлюзов: включено.
-   Allow virtual network address (Использовать удаленные шлюзы): отключено.

 ![Конфигурация пиринга от концентратора к периферийной сети](./media/azure-vm-disaster-recovery-with-expressroute/hub-to-spoke-peering-configuration.png)

### <a name="enabling-replication-for-the-deployment"></a>Включение репликации для развертывания

В описанной выше конфигурации прежде всего [настройте аварийное восстановление](azure-to-azure-tutorial-enable-replication.md) с помощью Site Recovery для каждой виртуальной машины. Site Recovery позволяет создавать в целевом регионе реплики виртуальных сетей (включая настройки подсетей и шлюзов) и настраивать сопоставления между исходными и целевыми виртуальными сетями. Вы также можете заранее создать сети и подсети в целевой среде и использовать их для репликации.

Site Recovery не реплицирует таблицы маршрутов, шлюзы виртуальной сети, подключения через шлюз виртуальной сети, пиринг виртуальной сети и другие сетевые ресурсы или подключения. Эти и другие ресурсы, не учитываемые в [процессе репликации](azure-to-azure-architecture.md#replication-process), нужно отдельно создать до или во время отработки отказа, а затем подключить к соответствующим ресурсам. Azure Site Recovery поддерживает мощные [планы восстановления](site-recovery-create-recovery-plans.md), которые позволяют автоматизировать создание и подключение дополнительных ресурсов с помощью скриптов автоматизации.

По умолчанию трафик репликации никогда не покидает платформу Azure. В развертывании с виртуальным сетевым модулем обычно определяется маршрут по умолчанию (0.0.0.0/0), который передает на виртуальный сетевой модуль весь направленный в Интернет исходящий трафик. В таком случае к устройству может применяться регулирование, если весь трафик репликации проходит через виртуальный сетевой модуль. Это справедливо и для маршрутов по умолчанию, которые направляют весь трафик виртуальных машин Azure к локальным развертываниям. Мы рекомендуем [создать в виртуальной сети конечную точку сетевой службы](azure-to-azure-about-networking.md#create-network-service-endpoint-for-storage) для хранилища, чтобы трафик репликации не покидал границ Azure.

## <a name="failover-models-with-expressroute"></a>Варианты отработки отказа с ExpressRoute

Когда для виртуальных машин Azure выполняется отработка отказа в другой регион, существующие подключения ExpressRoute к исходной виртуальной сети не переносятся автоматически в целевую виртуальную сеть в регионе восстановления. Требуется создать новое подключение ExpressRoute к целевой виртуальной сети.

Репликацию виртуальных машин Azure можно выполнить в любой регион Azure, входящий в тот же географический кластер, как описано [здесь](azure-to-azure-support-matrix.md#region-support). Если выбранный целевой регион Azure относится к другому геополитическому региону, вам потребуется ExpressRoute уровня "Премиум" для создания одного канала ExpressRoute между целевым и исходным регионами. Дополнительные сведения см. в разделе [Регионы Azure с расположениями ExpressRoute в пределах геополитических регионов](../expressroute/expressroute-locations.md#azure-regions-to-expressroute-locations-within-a-geopolitical-region) и на странице [цен на ExpressRoute](https://azure.microsoft.com/pricing/details/expressroute/).

### <a name="two-expressroute-circuits-in-two-different-expressroute-peering-locations"></a>Два канала ExpressRoute в двух разных расположениях пиринга ExpressRoute
-   Такая конфигурация полезна, если вам нужна защита от сбоя основного канала ExpressRoute и крупномасштабных региональных аварий, которые могут нарушить работу расположений пиринга ExpressRoute и основного канала ExpressRoute.
-   Обычно в качестве основного используется канал, подключенный к рабочей среде, а дополнительный канал с меньшей пропускной способностью настраивается как резервный. Пропускную способность резервного канала можно динамически увеличить при аварии, которая потребуется переложить на него функции основного канала.
-   В такой конфигурации вы можете создавать подключения от вторичного канала ExpressRoute к целевой виртуальной сети после отработки отказа либо настроить и подготовить их заранее для аварийного объявления, чтобы уменьшить общую длительность восстановления. Если соединения с виртуальными сетями в основном и целевом регионах существуют одновременно, не забудьте настроить локальную маршрутизацию так, чтобы дополнительный канал применялся только после отработки отказа.
-   Исходная и целевая виртуальные сети для виртуальных машин, защищенных с помощью Site Recovery, могут иметь при отработке отказа одинаковые или разные IP-адреса, в зависимости от ваших требований к системе. В обоих вариантах есть возможность установить дополнительные подключения до отработки отказа.

### <a name="two-expressroute-circuits-in-the-same-expressroute-peering-location"></a>Два канала ExpressRoute в одном расположении пиринга ExpressRoute
-   Такая конфигурация защитит вашу сеть от сбоя основного канала ExpressRoute, но бесполезна в случае крупномасштабных региональных аварий, которые могут нарушить работу расположений пиринга ExpressRoute. В случае такой аварии могут быть затронуты оба канала.
-   Остальные условия по IP-адресам и подключениям здесь такие же, как и для описанного выше варианта. Вы можете иметь несколько одновременных подключений от локального центра обработки данных: основной канал для связи с исходной виртуальной сетью и дополнительный канал для связи с целевой виртуальной сетью. Если соединения с виртуальными сетями в основном и целевом регионах существуют одновременно, не забудьте настроить локальную маршрутизацию так, чтобы дополнительный канал применялся только после отработки отказа.
-   Вы не можете подключить к одной виртуальной сети два канала, созданных в одном расположении пиринга.

### <a name="single-expressroute-circuit"></a>Один канал ExpressRoute
-   Такая конфигурация не защищает от крупномасштабных региональных аварий, которые могут нарушить работу расположения пиринга ExpressRoute.
-   С одним каналом ExpressRoute нет возможности одновременно подключить исходную и целевую виртуальные сети, если вы настроили для них одинаковый диапазон IP-адресов.
-   Если в целевом регионе применяется основной диапазон IP-адресов, подключение к нему можно создавать только после того, как будет отключено подключение к источнику. Такую логику переключения можно реализовать в скриптах плана восстановления.
-   Если региональный сбой приведет к недоступности основного региона, операция отключения завершится неудачей. Такой сбой может помешать созданию подключения к целевому региону, в котором настроен основной диапазон IP-адресов.
-   Если подключение к целевому региону будет успешно создано, а после этого восстановится подключение к основному региону, попытка одновременного подключения к двум одинаковым адресным пространствам может привести к потере пакетов. Чтобы предотвратить такие потери, необходимо мгновенно разорвать подключение к основному региону. Когда для виртуальных машин будет восстановлено размещение в основной регион, можно возобновить основное подключение, но только после отключения дополнительного подключения.
-   Если в целевой виртуальной сети настроен другой диапазон адресов, можно безопасно подключить один канал ExpressRoute одновременно к исходной и целевой виртуальным сетям.

## <a name="recovering-azure-deployments"></a>Восстановление развертываний Azure
Давайте рассмотрим модель отработки отказа с двумя разными каналами ExpressRoute в двух разных расположениях пиринга и сохранением частных IP-адресов для защищенных виртуальных машин Azure. В этом примере настроен целевой регион восстановления Azure "Юго-Восточная Азия", а дополнительный канал ExpressRoute подключается через партнерский пограничный сервер в Сингапуре.

Чтобы автоматизировать такое развертывание, помимо репликации виртуальных машин и виртуальных сетей нужно создавать другие важные ресурсы сети и подключения. Для описанной выше звездообразной топологии сети следует выполнить следующие дополнительные шаги во время или после [отработки отказа](azure-to-azure-tutorial-failover-failback.md):
1.  Создайте шлюз Azure ExpressRoute в виртуальной сети концентратора в целевом регионе. Шлюз ExpressRoute нужен для того, чтобы подключить целевую виртуальную сеть концентратора к каналу ExpressRoute.
2.  Создайте подключение виртуальной сети концентратора в целевом регионе к целевому каналу ExpressRoute.
3.  Настройте пиринг виртуальных сетей между виртуальной сетью концентратора и периферийными виртуальными сетями в целевом регионе. Для пиринга в целевом регионе укажите такие же параметры, как и в исходном регионе.
4.  Настройте определяемые пользователем маршруты в виртуальной сети концентратора и в обоих периферийных виртуальных сетях. Если используются те же IP-адреса, то для определяемых пользователем маршрутов в целевом регионе укажите такие же параметры, как и в исходном регионе. Если в целевом регионе IP-адреса отличаются, необходимо соответствующим образом скорректировать определяемые пользователем маршруты.

Описанные выше шаги можно реализовать в скриптах [плана восстановления](site-recovery-create-recovery-plans.md). Если ваше приложение имеет высокие требования к наличию подключений и времени восстановления, указанные выше шаги можно выполнять перед началом отработки отказа.

После восстановления виртуальных машин и выполнения других действий для подключения, среда восстановления будет выглядеть следующим образом: ![Схема после отработки отказа локальной среды в Azure с использованием ExpressRoute](./media/azure-vm-disaster-recovery-with-expressroute/site-recovery-with-expressroute-after-failover.png)

[Здесь](site-recovery-retain-ip-azure-vm-failover.md#on-premises-to-azure-connectivity) описан простой пример топологии для аварийного восстановления виртуальной машины Azure с одним каналом ExpressRoute и одинаковыми IP-адресами на целевой и исходной виртуальных машинах.

## <a name="recovery-time-objective-rto-considerations"></a>Рекомендации относительно целевого времени восстановления (RTO)
Чтобы сократить общее время восстановления для вашего развертывания, мы рекомендуем заранее подготовить и развернуть в целевом регионе дополнительные [сетевые компоненты](azure-vm-disaster-recovery-with-expressroute.md#enabling-replication-for-the-deployment), например шлюзы виртуальных сетей. Непродолжительный простой приводит к развертыванию дополнительных ресурсов, а это может повлиять на общее время восстановления, если эти факторы плохо учтены при планировании.

Мы рекомендуем регулярно выполнять для защищенных развертываний [упражнения по аварийному восстановлению](azure-to-azure-tutorial-dr-drill.md). Такое комплексное испытание позволяет проверить стратегию репликации без потери данных, без простоев и других влияний на рабочую среду. Также комплексное испытание поможет избежать непредвиденных проблем с конфигурацией, которые могут существенно увеличить время восстановления. Мы рекомендуем использовать для тестовой отработки отказа отдельную сеть виртуальных машин Azure вместо сети по умолчанию, настроенной для репликации.

Если вы используете один канал ExpressRoute, желательно настроить отдельное пространство IP-адресов для целевой виртуальной сети, чтобы избежать проблем с порядком создания подключений при региональных авариях. Если нет никакой возможности использовать разные IP-адреса, тестовую отработку отказа при комплексном испытании по аварийному восстановлению следует выполнять на отдельной тестовой сети с другим пространством IP-адресов, так как вы не сможете подключить к одному каналу ExpressRoute две виртуальные сети с перекрывающимися диапазонами адресов.

## <a name="next-steps"></a>Дополнительная информация
- Дополнительные сведения о [каналах ExpressRoute](../expressroute/expressroute-circuit-peerings.md).
- Дополнительные сведения о [доменах маршрутизации ExpressRoute](../expressroute/expressroute-circuit-peerings.md#expressroute-routing-domains).
- Дополнительные сведения о [расположениях ExpressRoute](../expressroute/expressroute-locations.md).
- См. сведения в статье [Создание плана восстановления с помощью Site Recovery](site-recovery-create-recovery-plans.md).
