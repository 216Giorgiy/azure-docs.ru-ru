<properties
	pageTitle="Отработка отказа в Site Recovery | Microsoft Azure" 
	description="Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Узнайте о функции отработки отказа с выполнением переноса в Azure или в дополнительный центр обработки данных." 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="02/22/2016" 
	ms.author="raynew"/>

# Отработка отказа в Site Recovery

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

## Обзор

В данной статье содержатся сведения и инструкции по восстановлению (отработке отказа и восстановлению размещения) виртуальных машин и физических серверов, защищенных с помощью Site Recovery.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Типы отработки отказа

После включения защиты для виртуальных машин и физических серверов и их репликации можно (при необходимости) выполнить отработку отказа. Site Recovery поддерживает несколько типов отработки отказа.

**Тип отработки отказа** | **Область применения** | **Дополнительные сведения** | **Описание процесса**
---|---|---|---
**Тестовая отработка отказа** | Проверка стратегии репликации или анализа работы системы аварийного восстановления. | Не приводит к потерям данных и простоям.<br/><br/>Не оказывает влияния на репликацию.<br/><br/>Не оказывает влияния на рабочую среду. | Запустите операцию отработки отказа.<br/><br/>Укажите, как тестовые компьютеры должны быть подключены к сетям после отработки отказа.<br/><br/>Отслеживайте ход выполнения на вкладке **Задания**. Тестовые машины будут создаваться и запускаться в дополнительном расположении.<br/><br/>Azure: подключение к машине на портале Azure.<br/><br/>Дополнительный сайт: доступ к машине на одном и том же узле и в одном и том же облаке.<br/><br/>Полное тестирование и автоматическая очистка параметров тестовой отработки отказа.
**Плановая отработка отказа** | Обеспечение соответствия требованиям.<br/><br/>Плановое обслуживание.<br/><br/>Отработка отказа для обеспечения непрерывного выполнения рабочих нагрузок во время прогнозируемых неблагоприятных обстоятельств, например при плановых отключениях питания или экстремальных погодных условиях.<br/><br/>Восстановление размещения после отработки отказа с переносом из основного расположения в дополнительное. | Не приводит к потерям данных.<br/><br/>Время простоя определяется только временем завершения работы виртуальной машины в основном расположении и временем ее запуска в дополнительном расположении.<br/>Виртуальные машины, рассматриваемые как целевые, после отработки отказа становятся исходными машинами. | Запустите операцию отработки отказа.<br/><br/>Отслеживайте ход выполнения на вкладке **Задания**. Работа исходных виртуальных машин будет завершена.<br/><br/>Реплицированные машины будут запущены в дополнительном расположении.<br/><br/>Azure: подключение к реплицированной машине на портале Azure.<br/><br/>Дополнительное расположение: доступ к машине на том же узле и в том же облаке.<br/><br/>Фиксация отработки отказа.
**Незапланированная отработка отказа** | Такая обработка отказа необходима, когда основной сайт становится недоступным из-за неожиданного инцидента, например из-за сбоя питания или атаки вирусов.<br/><br/>Вы можете выполнять незапланированную отработку отказа, даже если основной сайт недоступен. | Количество потерянных данных зависит от того, как часто выполняется репликация.<br/><br/>Данные будут актуальны на момент последней синхронизации. | Запустите операцию отработки отказа.<br/><br/>Отслеживайте ход выполнения на вкладке **Задания**. При необходимости можно завершить работу виртуальных машин и синхронизировать последнюю версию данных.<br/><br/>Реплицированные машины будут запущены в дополнительном расположении.<br/><br/>Azure: подключение к реплицированной машине на портале Azure.<br/><br/>Дополнительный сайт получает доступ к машине на том же узле и в том же облаке.<br/><br/>Фиксация отработки отказа.


То, какие типы отработки отказа поддерживаются, зависит от использованного вами сценария развертывания.

**Направление отработки отказа** | **Тестовая отработка отказа** | **Плановая отработка отказа** | **Незапланированная отработка отказа**
---|---|---|---
C основного сайта VMM на дополнительный сайт VMM | Поддерживаются | Поддерживаются | Поддерживаются 
C дополнительного сайта VMM на основной сайт VMM | Поддерживаются | Поддерживаются | Поддерживаются
Из облака в облако (один сервер VMM) | Поддерживаются | Поддерживаются | Поддерживаются
С сайта VMM в Azure | Поддерживаются | Поддерживаются | Поддерживаются 
Из Azure на сайт VMM | Не поддерживается | Поддерживаются | Не поддерживается 
С сайта Hyper-V в Azure | Поддерживаются | Поддерживаются | Поддерживаются
Из Azure на сайт Hyper-V | Не поддерживается | Поддерживаются | Не поддерживается
С сайта VMware в Azure | Поддерживается (расширенный сценарий)<br/><br/>Не поддерживается (сценарий предыдущей версии) |В этом сценарии используется непрерывная репликация, поэтому нет отличий между плановой и незапланированной отработкой отказа. Выберите пункт **Отработка отказа**. | Нет данных
С физического сервера в Azure | Не поддерживается | В этом сценарии используется непрерывная репликация, поэтому нет отличий между плановой и незапланированной отработкой отказа. Выберите пункт **Отработка отказа**. | Нет данных

## Отработка отказа и восстановление размещения

Отработку отказа для виртуальных машин можно выполнять с переносом на дополнительный локальный сайт или в Azure (в зависимости от развертывания). При отработке отказа машины с выполнением ее переноса в Azure будет создана виртуальная машина Azure. Вы можете выполнить отработку отказа для одной виртуальной машины или физического сервера или же запустить план восстановления. В планах восстановления предусмотрены одна или несколько упорядоченных групп, содержащих защищенные виртуальные машины или физические серверы. Планы используются для оркестрации отработки отказа нескольких машин согласно параметрам группы, в которой находятся эти машины. Дополнительные сведения о планах восстановления см. [здесь](site-recovery-create-recovery-plans.md).

После того как отработка отказа будет завершена, а ваши машины начнут работать в дополнительном расположении, обратите внимание на указанные ниже сведения.

- Если вы выполнили отработку отказа с переносом в Azure, то после этой операции машины не будут защищены и для них не будет выполняться репликация в основное или дополнительное расположение. В Azure виртуальные машины хранятся в геореплицированном хранилище, которое обеспечивает отказоустойчивость, но не выполняет функции репликации.
- Если вы выполнили незапланированную отработку отказа с переносом на дополнительный сайт, то после этого машины в дополнительном расположении не будут защищены и для них не будет выполняться репликация.
- Если вы выполнили плановую отработку отказа с переносом на дополнительный сайт, то после этого машины в дополнительном расположении будут защищены.
 

### Восстановление размещения с выполнением переноса с дополнительного сайта

Для восстановления размещения с выполнением переноса из дополнительного сайта на основной используется тот же процесс, что и для отработки отказа с переносом из основного расположения в дополнительное. После фиксации и завершения отработки отказа с переносом из основного центра обработки данных в дополнительный можно начать обратную репликацию (когда основной сайт снова станет доступным). При обратной репликации будет запущена репликация между дополнительным и основным сайтами. Она выполняется путем синхронизации изменений данных. При обратной репликации виртуальные машины будут переведены в защищенное состояние, но при этом активным расположением по-прежнему останется дополнительный центр обработки данных. Чтобы сделать активным расположением основной сайт, необходимо запустить плановую отработку отказа с переносом из дополнительного расположения в основное, а затем выполнить еще одну обратную репликацию.

### Восстановление размещения с выполнением переноса из Azure

Если вы выполнили отработку отказа с переносом в Azure, ваши виртуальные машины будут защищены функциями обеспечения устойчивости Azure. Чтобы сделать исходный основной сайт активным расположением, запустите плановую отработку отказа. Если исходный сайт недоступен, можно восстановить размещение в исходном или альтернативном расположении. Чтобы еще раз начать репликацию после восстановления размещения в основном расположении, необходимо запустить обратную репликацию.

### Рекомендации по отработке отказа

- **IP-адрес после отработки отказа**. По умолчанию машина, созданная в результате отработки отказа, и исходная машина будут иметь разные IP-адреса. Если необходимо, чтобы IP-адрес машины не изменился, выполните указанные ниже действия. 
	- **Для дополнительного сайта**. Сведения о том, как при отработке отказа с выполнением переноса на дополнительный сайт сохранить IP-адрес неизменным, см. в [этой статье](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx). Обратите внимание, что для сохранения общедоступного IP-адреса неизменным необходимо, чтобы ваш поставщик услуг Интернета поддерживал такую возможность.
	- **Для Azure**. В случае переноса в Azure при отработке отказа можно указать необходимый IP-адрес на вкладке **Настройка** в разделе свойств виртуальной машины. Невозможно сохранить общедоступный IP-адрес после отработки отказа с переносом в Azure. Вы можете сохранить адресные пространства, не оговоренные в документе RFC 1918 и использующиеся в качестве внутренних адресов.
- **Частичная отработка отказа**. Если необходимо выполнить отработку отказа только для части сайта, обратите внимание на указанные ниже сведения. 
	- **Для дополнительного сайта**. Если при отработке отказа только часть основного сайта переносится на дополнительный сайт и вы хотите подключиться обратно к основному сайту, используйте VPN типа "сеть-сеть". С его помощью можно подключать приложения, для которых выполнена отработка отказа и которые размещены на дополнительном сайте, к компонентам инфраструктуры, работающим на основном сайте. При отработке отказа для всей подсети можно сохранить IP-адрес виртуальной машины. При отработке отказа для части подсети не удастся сохранить IP-адрес виртуальной машины, так как невозможно разделить подсети между сайтами.
	- **Для Azure**. Если при отработке отказа только часть сайта переносится в Azure и вы хотите подключиться обратно к основному сайту, используйте VPN типа "сеть-сеть". С его помощью можно подключить приложение, для которого выполнена отработка отказа и которое размещено в Azure, к компонентам инфраструктуры, работающим на основном сайте. Обратите внимание, что при отработке отказа для всей подсети можно сохранить IP-адрес виртуальной машины. При отработке отказа для части подсети не удастся сохранить IP-адрес виртуальной машины, так как невозможно разделить подсети между сайтами.
 
- **Буква диска**. Если необходимо после отработки отказа сохранить буквы дисков на виртуальных машинах, можно **включить** политику SAN для виртуальной машины. Диски виртуальных машин станут доступны автоматически. [Подробная информация](https://technet.microsoft.com/library/gg252636.aspx).
- **Маршрутизация клиентских запросов**. После отработки отказа Site Recovery работает совместно с диспетчером трафика Azure, чтобы выполнять маршрутизацию клиентских запросов к вашему приложению.




## Запуск тестовой отработки отказа

При запуске тестовой отработки отказа вам будет предложено выбрать параметры сети для тестовых реплицированных машин. Вы можете выбрать один из нескольких вариантов.

**Вариант тестовой отработки отказа** | **Описание** | **Проверки, выполняемые при отработке отказа** | **Дополнительные сведения**
---|---|---|---
**Отработка отказа с выполнением переноса в Azure без использования сети** | Не нужно выбирать целевую сеть Azure. | При отработке отказа выполняется проверка, правильно ли тестовая виртуальная машина запускается в Azure. | Все тестовые виртуальные машины, входящие в план восстановления, будут добавлены в одну облачную службу и смогут подключаться друг к другу.<br/><br/>После отработки отказа машины не будут подключены к сети Azure.<br/><br/>Пользователи смогут подключаться к тестовым машинам с помощью общедоступного IP-адреса.
**Отработка отказа с выполнением переноса в Azure с использованием сети** | Необходимо выбрать целевую сеть Azure. | При отработке отказа выполняется проверка, подключены ли тестовые виртуальные машины к сети. | Создайте сеть Azure, изолированную от вашей рабочей сети Azure, и настройте инфраструктуру так, чтобы реплицированная виртуальная машина могла правильно работать.<br/><br/>В основе подсети тестовой виртуальной машины лежит подсеть, к которой виртуальная машина, для которой выполнена отработка отказа, должна подключаться при плановой или незапланированной отработке отказа.
**Отработка отказа с выполнением переноса на вторичный сайт VMM без использования сети** | Не нужно выбирать сеть виртуальных машин. | При отработке отказа выполняется проверка того, созданы ли тестовые машины.<br/><br/>Тестовая виртуальная машина будет создана на том же узле, на котором находится реплицированная виртуальная машина. Она не добавляется в облако, в котором находится реплика виртуальной машины. | <p>Машина, для которой выполнена отработка отказа, не будет подключена ни к одной из сетей.<br/><br/>После создания машины ее можно подключить к сети виртуальных машин.
**Отработка отказа с выполнением переноса на вторичный сайт VMM с использованием сети** | Необходимо выбрать существующую сеть виртуальных машин. | При отработке отказа выполняется проверка того, созданы ли виртуальные машины. | Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она не будет добавлена в облако, в котором расположена реплицированная виртуальная машина.<br/><br/>Создайте сеть виртуальных машин, которая будет изолирована от вашей рабочей сети.<br/><br/>Если вы используете сеть на основе виртуальной локальной сети, то мы рекомендуем вам создать в VMM отдельную логическую сеть (которая не будет использоваться в рабочих целях). Эта логическая сеть используется для создания сетей виртуальных машин, предназначенных для выполнения тестовых отработок отказа.<br/><br/>Логическая сеть должна быть сопоставлена хотя бы с одним из сетевых адаптеров серверов Hyper-V, в которых размещаются виртуальные машины.<br/><br/>В логических виртуальных локальных сетях сайты сети, добавляемые к логической сети, должны быть изолированы.<br/><br/>Если вы используете логическую сеть на основе технологии виртуализации сети Windows, Azure Site Recovery автоматически создаст изолированные сети виртуальных машин.
**Отработка отказа с выполнением переноса на вторичный сайт VMM с созданием сети** | На основе параметра, заданного вами для **логической сети**, и связанных с ним сайтов сети будет автоматически создана временная тестовая сеть. | При отработке отказа выполняется проверка того, созданы ли виртуальные машины. | Используйте этот параметр, если план восстановления использует несколько сетей виртуальных машин. При выборе этого варианта для сетей на базе технологии виртуализации сети Windows можно автоматически создавать сети виртуальных машин с теми же параметрами (подсети и пулы IP-адресов), что и параметры сети реплицированной виртуальной машины. Такие сети виртуальных машин автоматически очищаются после завершения тестовой отработки отказа.</p><p>Тестовая виртуальная машина будет создана на том же узле, на котором имеется реплицированная виртуальная машина. Она не добавляется в облако, в котором находится реплика виртуальной машины.

>[AZURE.NOTE] IP-адрес, выделенный виртуальной машине при тестовой отработки отказа, должен совпадать с IP-адресом, который она бы получила при выполнении плановой или внеплановой отработки отказа (если этот IP-адрес доступен в сети тестовой отработки отказа). Если такой IP-адрес недоступен в сети тестовой отработки отказа, виртуальная машина получит другой IP-адрес, доступный в сети тестовой отработки отказа.



### Запуск тестовой отработки отказа с переносом из локальной среды в Azure

В этой процедуре описывается, как запустить тестовую отработку отказа для плана восстановления. Кроме того, на вкладке **Виртуальные машины** можно запустить отработку отказа для одной машины.

1. В разделе **Планы восстановления** выберите пункт с *именем плана восстановления*. Последовательно выберите пункты **Отработка отказа** и **Тестовая отработка отказа**.
2. На странице **Подтверждение тестовой отработки отказа** укажите, каким способом реплицированные машины будут подключаться к сети Azure после отработки отказа.
3. Если при отработке отказа с выполнением переноса в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика вы включили функцию шифрования данных. 
4. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания**. Кроме того, вы можете просмотреть тестовую реплицированную машину на портале Azure.
5. Чтобы получить доступ к реплицированным машинам на портале Azure с локального сайта, подключитесь к необходимой виртуальной машине с помощью протокола удаленного рабочего стола. При этом необходимо, чтобы для виртуальной машины в конечной точке был открыт порт 3389.
5. Когда операция отработки отказа дойдет до этапа **завершения тестирования**, нажмите кнопку **Завершить тестирование**.
5. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа.
8. Выберите пункт **Тестовая отработка отказа завершена**, чтобы автоматически очистить тестовую среду. После этого операция тестовой отработки отказа отобразит состояние **Завершено**.

> [AZURE.NOTE] Если отработка отказа выполняется более двух недель, она будет завершена принудительно. Все элементы или виртуальные машины, автоматически созданные во время тестовой отработки отказа, будут удалены.
  

### Запуск тестовой отработки отказа для перехода с основного локального сайта на дополнительный локальный сайт

Для запуска тестовой отработки отказа вам потребуется выполнить несколько действий, в том числе создать копию контроллера домена, а затем поместить тестовые DHCP-сервер и DNS-сервер в тестовую среду. Это можно сделать несколькими способами.

- Если необходимо запустить тестовую отработку отказа, используя имеющуюся сеть, подготовьте Active Directory, DHCP и DNS в этой сети.
- Если необходимо запустить тестовую отработку отказа, используя функцию автоматического создания сетей виртуальных машин, то перед этим в плане восстановления, который вы собираетесь использовать для тестовой отработки отказа, добавьте выполняющийся вручную этап перед группой Group-1, а затем — ресурсы инфраструктуры в автоматически созданную сеть.

#### Примечания

- При репликации на дополнительный сайт необязательно, чтобы тип сети, используемой реплицированной машиной, соответствовал типу логической сети, используемой для тестовой отработки отказа, но при этом некоторые сочетания типов могут не работать. Если реплика использует DHCP и изоляцию на основе виртуальной локальной сети, то необязательно, чтобы у сети виртуальной машины для реплики был пул статических IP-адресов. Таким образом, не удастся использовать технологию виртуализации сети Windows для тестовой отработки отказа, так как не будет доступно ни одного пула адресов. Кроме того, тестовая отработка отказа не будет работать, если сеть реплики не изолирована и тестовая сеть представляет собой виртуализацию сети Windows. Это вызвано тем, что у неизолированной сети нет подсетей, необходимых для создания сети по технологии виртуализации сети Windows.
- Способ, которым реплицированные виртуальные машины подключаются к сопоставленным сетям виртуальных машин после отработки отказа, зависит от того, как сеть виртуальной машины настроена в консоли VMM.
	- **Сеть виртуальной машины настроена без изоляции или с изоляцией виртуальной локальной сети**. Если для сети виртуальной машины определен DHCP, то реплицированная виртуальная машина будет подключена к идентификатору виртуальной локальной сети с использованием параметров, указанных для сайта сети в сопоставленной логической сети. Виртуальная машина получит свой IP-адрес от доступного DHCP-сервера. Вам не потребуется пул статических IP-адресов, определенный для целевой сети виртуальных машин. Если для сети виртуальных машин используется пул статических IP-адресов, то реплицированная виртуальная машина будет подключена к идентификатору виртуальной локальной сети с помощью параметров, указанных для сайта сети в сопоставленной логической сети. Виртуальная машина получит свой IP-адрес из пула, определенного для сети виртуальных машин. Если пул статических IP-адресов не определен в целевой сети виртуальных машин, произойдет сбой выделения IP-адресов. Следует создать пул IP-адресов и на исходном, и на целевом серверах VMM, которые вы собираетесь использовать для защиты и восстановления.
	- **Сеть виртуальных машин с виртуализацией сети Windows**. Если сеть виртуальных машин настроена с помощью этого параметра, то следует определить пул статических IP-адресов для целевой сети виртуальных машин независимо от того, как настроена исходная сеть виртуальных машин: использовать DHCP или пул статических IP-адресов. Если вы определили DHCP, целевой сервер VMM будет выступать в качестве DHCP-сервера и предоставлять IP-адрес из пула, определенного для целевой сети виртуальных машин. Если исходный сервер настроен так, чтобы использовать пул статических IP-адресов, то целевой VMM-сервер будет выделять IP-адрес из пула. Если пул статических IP-адресов не определен, то в обоих случаях выделение IP-адреса завершится ошибкой.

#### Запуск теста

В этой процедуре описывается, как запустить тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины или физического сервера.

1. В разделе **Планы восстановления** выберите пункт с *именем плана восстановления*. Последовательно выберите пункты **Отработка отказа** и **Тестовая отработка отказа**.
2. На странице **Подтверждение тестовой отработки отказа** укажите, каким способом виртуальные машины должны подключаться к сетям после тестовой отработки отказа.
3. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания**. Когда операция отработки отказа достигнет этапа **Завершение тестирования**, нажмите кнопку **Завершить тестирование**, чтобы завершить тестовую отработку отказа.
4. Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
4. После отработки отказа проверьте, успешно ли запущены виртуальные машины.
5. После проверки успешного запуска виртуальных машин выполните тестовую отработку отказа для очистки изолированной среды. Если выбран параметр автоматического создания сетей виртуальных машин, то при очистке будут удалены все тестовые виртуальные машины и тестовые сети.

> [AZURE.NOTE] Если отработка отказа выполняется более двух недель, она будет завершена принудительно. Все элементы или виртуальные машины, автоматически созданные во время тестовой отработки отказа, будут удалены.


#### Подготовка DHCP

Если виртуальные машины, участвующие в тестовой отработке отказа, используют DHCP, необходимо создать тестовый DHCP-сервер в изолированной сети, созданной для тестовой отработки отказа.


### Подготовка Active Directory
Чтобы выполнить тестовую отработку отказа для тестирования приложения, потребуется копия рабочей среды Active Directory в тестовой среде. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).


### Подготовка DNS

Подготовьте DNS-сервер для тестовой отработки отказа указанным ниже образом.

- **DHCP**. Если виртуальные машины используют DHCP, необходимо обновить IP-адрес тестового DNS-сервера на тестовом DHCP-сервере. Если используется сеть с технологией виртуализации сети Windows, VMM-сервер будет выступать в роли DHCP-сервера. Следовательно, IP-адрес DNS-сервера должен обновляться в сети тестовой отработки отказа. В этом случае виртуальные машины будут регистрироваться на соответствующем DNS-сервере.
- **Статический адрес**. Если виртуальные машины используют статические IP-адреса, следует обновить IP-адрес тестового DNS-сервера в сети тестовой отработки отказа. Вам может потребоваться обновить DNS, указав IP-адреса тестовых виртуальных машин. Для этого можно использовать указанный ниже пример сценария. 

	    Param(
	    [string]$Zone,
	    [string]$name,
	    [string]$IP
	    )
	    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
	    $newrecord = $record.clone()
	    $newrecord.RecordData[0].IPv4Address  =  $IP
	    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord



## Запуск плановой отработки отказа (перенос из основного расположения в дополнительное)

 В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.

1. Перед началом работы убедитесь, что все виртуальные машины, для которых необходимо выполнить отработку отказа, завершили первоначальную репликацию.
2. В разделе **Планы восстановления** выберите пункт с *именем плана восстановления*. Последовательно выберите пункты **Отработка отказа** и **Плановая отработка отказа**. 
3. На странице **Подтвердить плановую отработку отказа** выберите исходное и целевое расположения. Запомните направление отработки отказа.

	- Если предыдущие отработки отказа выполнены правильно и все серверы виртуальных машин размещены в исходном или целевом расположении, то сведения о направлении отработки отказа понадобятся исключительно в информационных целях. 
	- Если виртуальные машины активны как в исходном, так и в целевом расположениях, появится кнопка **Изменить направление**. С помощью этой кнопки можно изменить и указать направление, в котором должна выполняться отработка отказа.

5. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
6. Когда начнется плановая отработка отказа, прежде всего необходимо завершить работу виртуальных машин, чтобы предотвратить потерю данных. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. Если при отработке отказа возникнет ошибка (либо на виртуальной машине, либо в сценарии, который включен в план восстановления), плановая отработка отказа в рамках плана восстановления будет остановлена. Вы сможете запустить отработку отказа еще раз.
8. После создания реплицированных виртуальных машин они находятся в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать**. 
9. По завершении репликации виртуальные машины будут запущены в дополнительном расположении. 

## Запуск незапланированной отработки отказа

В этой процедуре рассказывается, как запустить незапланированную тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины или физического сервера.

1. В разделе **Планы восстановления** выберите пункт с *именем плана восстановления*. Последовательно выберите пункты **Отработка отказа** и **Незапланированная отработка отказа**. 
3. На странице **Подтвердить внеплановую отработку отказа** выберите исходное и целевое расположения. Запомните направление отработки отказа.

	- Если предыдущие отработки отказа выполнены правильно и все серверы виртуальных машин размещены в исходном или целевом расположении, то сведения о направлении отработки отказа понадобятся исключительно в информационных целях. 
	- Если виртуальные машины активны как в исходном, так и в целевом расположениях, появится кнопка **Изменить направление**. С помощью этой кнопки можно изменить и указать направление, в котором должна выполняться отработка отказа.

4. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
5. Установите флажок **Завершать работу виртуальных машин и синхронизировать последние данные**. Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных. Если вы не установите этот флажок или попытка выполнить указанные выше действия окажется неудачной, то отработка отказа будет выполнена на основе последней доступной точки восстановления для виртуальной машины.
6. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. Обратите внимание, что даже в случае возникновения ошибок во время незапланированной отработки отказа план восстановления будет выполнен до его полного завершения.
7. После отработки отказа виртуальные машины будут находиться в состоянии **ожидании фиксации**. Для фиксации отработки отказа выберите команду **Зафиксировать**.
8. Если репликация настроена так, что в процессе ее выполнения используются несколько точек восстановления, то в разделе "Изменение точки восстановления" можно настроить соответствующие параметры так, чтобы выбиралась не последняя точка восстановления (используемая по умолчанию). После фиксации дополнительные точки восстановления будут удалены.
9. Когда репликация завершится, виртуальные машины будут запущены в дополнительном расположении. Тем не менее, они не защищены и не будут реплицироваться. Когда основной сайт и вся инфраструктура, на которой он основан, снова станут доступными, выберите пункт **Обратная репликация**, чтобы начать обратную репликацию. Это гарантирует, что все данные будут реплицированы обратно на основной сайт и что виртуальная машина снова будет готова для отработки отказа. При обратной репликации после незапланированной отработки отказа передаются дополнительные служебные данные. При передаче будет использоваться метод, который настроен для изначальной репликации для облака.

## Восстановление размещения в основном расположении (перенос из дополнительного)

 После отработки отказа с переносом из основного расположения в дополнительное реплицированные виртуальные машины не будут защищены службой Site Recovery, а дополнительное расположение будет играть роль основного. Выполните указанные ниже процедуры, чтобы восстановить размещение на исходном основном сайте. В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.

1. В разделе **Планы восстановления** выберите пункт с *именем плана восстановления*. Последовательно выберите пункты **Отработка отказа** и **Плановая отработка отказа**.
2. На странице **Подтвердить плановую отработку отказа** выберите исходное и целевое расположения. Запомните направление отработки отказа. Если отработка отказа с переносом из основного расположения выполнена правильно и все виртуальные машины находятся в дополнительном расположении, то эти данные будут носить исключительно информационный характер.
3. Если вы восстанавливаете размещение, выполняя перенос из Azure, выберите необходимые параметры в разделе **Синхронизация данных**.

	- **Синхронизация данных до отработки отказа**. Этот параметр сводит к минимуму время простоя для виртуальных машин, так как при его использовании синхронизация выполняется без завершения работы виртуальных машин. Он выполняет следующие действия:
		- Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
		- Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
	
	> [AZURE.NOTE] Рекомендуется использовать этот параметр, если вы некоторое время (месяц или больше) использовали Azure. Этот параметр выполняет синхронизацию, не завершая работу виртуальных машин. Он не выполняет повторную синхронизацию, но осуществляет полное восстановление размещения. Этот параметр не вычисляет никаких контрольных сумм.

	- **Синхронизировать данные только во время отработки отказа**. Используйте этот параметр, если вы использовали Azure в течение небольшого периода времени. Если выбрать этот параметр, то операция будет выполняться быстрее, так как будет осуществляться повторная синхронизация, а не полное восстановление размещения. Параметр выполняет быстрое вычисление контрольной суммы и загружает только измененные блоки.

5. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
5. По умолчанию используется последняя точка восстановления, но в разделе **Изменение точки восстановления** можно указать другую точку восстановления. 
6. Установите этот флажок, чтобы начать восстановление размещения. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. 
7. Если вы выбрали параметр, при котором синхронизация данных выполняется до отработки отказа, то когда завершится начальная синхронизация данных и вы будете готовы завершить работу виртуальных машин в Azure, последовательно выберите пункты **Задания** и <planned failover job name> **Полная отработка отказа**. Эта команда завершит работу машины Azure, передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.
8. После этого вы сможете выполнить вход в виртуальную машину, чтобы проверить ее доступность. 
9. Виртуальная машина будет находиться в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать**.
10. Теперь для восстановления размещения выберите пункт **Обратная репликация**, чтобы включить защиту виртуальной машины на основном сайте.



## Восстановление расположения в альтернативном расположении

Если вы развернули защиту между [сайтом Hyper-V и Azure](site-recovery-hyper-v-site-to-azure.md), то можно восстановить размещение, выполнив перенос из Azure в альтернативное локальное расположение. Это удобно, если необходимо настроить новое оборудование в локальной системе. Вот как это сделать.

1. При настройке нового оборудования установите на сервере Windows Server 2012 R2 и роль Hyper-V.
2. Создайте коммутатор виртуальной сети с тем же именем, что и на исходном сервере.
3. Последовательно выберите пункты **Защищенные элементы**, **Группа защиты**, <ProtectionGroupName> и <VirtualMachineName>, для которой необходимо выполнить восстановление размещения, а затем выберите пункт **Плановая отработка отказа**.
4. В разделе **Подтверждение плановой отработки отказа** выберите команду **Создать локальную виртуальную машину, если ее не существует**. 
5. В разделе **Имя узла** выберите новый сервер узла Hyper-V, на котором требуется разместить виртуальную машину.
6. В разделе "Синхронизация данных" мы рекомендуем выбрать параметр **Синхронизировать данные до отработки отказа**. Это сведет к минимуму простой виртуальных машин, так как синхронизация будет выполнена без завершения их работы. Он выполняет следующие действия:

	- Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
	- Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
	
7. Установите этот флажок, чтобы начать отработку отказа (восстановление размещения).
8. Когда завершится начальная синхронизация и вы будете готовы завершить работу виртуальной машины в Azure, последовательно выберите пункты **Задания**, <planned failover job> и **Завершить отработку отказа**. Эта команда завершит работу машины Azure и передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.
9. Вы можете выполнить вход в локальную виртуальную машину, чтобы проверить, что все работает правильно. Затем нажмите кнопку **Зафиксировать**, чтобы завершить отработку отказа.
10. Выберите пункт **Обратная репликация**, чтобы включить защиту локальной виртуальной машины.

 

<!---HONumber=AcomDC_0224_2016-->