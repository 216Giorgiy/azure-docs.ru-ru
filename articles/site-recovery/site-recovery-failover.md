---
title: "Отработка отказа в Site Recovery | Документация Майкрософт"
description: "Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Узнайте о функции отработки отказа с выполнением переноса в Azure или в дополнительный центр обработки данных."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 1/04/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: b70d2d709d0940964c4220b798207adaf3551d36
ms.openlocfilehash: d31e987e636b178b5aa05722ff08707a6e53c3cf


---
# <a name="failover-in-site-recovery"></a>Отработка отказа в Site Recovery
Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

## <a name="overview"></a>Обзор
В данной статье содержатся сведения и инструкции по восстановлению (отработке отказа и восстановлению размещения) виртуальных машин и физических серверов, защищенных с помощью Site Recovery.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="types-of-failover"></a>Типы отработки отказа
После включения защиты для виртуальных машин и физических серверов и их репликации можно (при необходимости) выполнить отработку отказа. Site Recovery поддерживает несколько типов отработки отказа.

| **Тип отработки отказа** | **Область применения** | **Дополнительные сведения** | **Описание процесса** |
| --- | --- | --- | --- |
| **Тестовая отработка отказа** |Проверка стратегии репликации или анализа работы системы аварийного восстановления. |Не приводит к потерям данных и простоям.<br/><br/>Не влияет на репликацию<br/><br/>Не оказывает влияния на рабочую среду. |Запустите операцию отработки отказа.<br/><br/>Укажите, каким образом тестовые машины будут подключаться к сети после отработки отказа<br/><br/>Отслеживайте ход выполнения на вкладке **Задания** . Тестовые машины будут создаваться и запускаться в дополнительном расположении.<br/><br/>Azure: подключитесь к виртуальной машине на портале Azure<br/><br/>Дополнительный сайт: доступ к машине на том же узле и в том же облаке<br/><br/>Полное тестирование и автоматическая очистка параметров тестовой отработки отказа. |
| **Плановая отработка отказа** |Обеспечение соответствия требованиям.<br/><br/>Плановое техническое обслуживание<br/><br/>Отработка отказа с переносом данных для сохранения рабочих нагрузок при известных сбоях, таких как ожидаемое отключение электропитания или неблагоприятные погодные условия<br/><br/>Восстановление размещения после отработки отказа с переносом из основного расположения в дополнительное. |Без потери данных<br/><br/>Простой возникает только на время, необходимое для завершения работы виртуальной машины в основном расположении и ее переноса в дополнительное расположение.<br/><br/>Влиянию подвергаются виртуальные машины, так как целевые машины после отработки отказа становятся исходными. |Запустите операцию отработки отказа.<br/><br/>Отслеживайте ход выполнения на вкладке **Задания** . Исходные машины выключаются<br/><br/>Реплицированные машины запускаются в дополнительном расположении<br/><br/>Azure: подключитесь к реплицированной машине на портале Azure<br/><br/>Дополнительный сайт: доступ к машине на том же узле и в том же облаке<br/><br/>Применение отработки отказа |
| **Незапланированная отработка отказа** |Такая обработка отказа необходима, когда основной сайт становится недоступным из-за неожиданного происшествия, например из-за сбоя питания или атаки вирусов <br/><br/> Вы можете выполнять незапланированную отработку отказа, даже если основной сайт недоступен. |Потеря данных зависит от настройки частоты репликации<br/><br/>Будут использоваться данные последней синхронизации |Запустите операцию отработки отказа.<br/><br/>Отслеживайте ход выполнения на вкладке **Задания** . Можно попробовать завершить работу виртуальных машин и синхронизировать последние данные<br/><br/>Реплицированные машины запускаются в дополнительном расположении<br/><br/>Azure: подключитесь к реплицированной машине на портале Azure<br/><br/>Дополнительный сайт: доступ к машине на том же узле и в том же облаке<br/><br/>Применение отработки отказа |

То, какие типы отработки отказа поддерживаются, зависит от использованного вами сценария развертывания.

| **Направление отработки отказа** | **Тестовая отработка отказа** | **Плановая отработка отказа** | **Незапланированная отработка отказа** |
| --- | --- | --- | --- |
| C основного сайта VMM на дополнительный сайт VMM |Поддерживаются |Поддерживаются |Поддерживаются |
| C дополнительного сайта VMM на основной сайт VMM |Поддерживаются |Поддерживаются |Поддерживаются |
| Из облака в облако (один сервер VMM) |Поддерживаются |Поддерживаются |Поддерживаются |
| С сайта VMM в Azure |Поддерживаются |Поддерживаются |Поддерживаются |
| Из Azure на сайт VMM |Не поддерживается |Поддерживаются |Не поддерживается |
| С сайта Hyper-V в Azure |Поддерживаются |Поддерживаются |Поддерживаются |
| Из Azure на сайт Hyper-V |Не поддерживается |Поддерживаются |Не поддерживается |
| С сайта VMware в Azure |Поддерживается (расширенный сценарий) <br/><br/> Не поддерживается (устаревший сценарий) |Не поддерживается |Поддерживаются |
| С физического сервера в Azure |Поддерживается (расширенный сценарий) <br/><br/> Не поддерживается (устаревший сценарий) |Не поддерживается |Поддерживаются |

## <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения
Отработку отказа для виртуальных машин можно выполнять с переносом на дополнительный локальный сайт или в Azure (в зависимости от развертывания). При отработке отказа машины с выполнением ее переноса в Azure будет создана виртуальная машина Azure. Вы можете выполнить отработку отказа для одной виртуальной машины или физического сервера или же запустить план восстановления. В планах восстановления предусмотрены одна или несколько упорядоченных групп, содержащих защищенные виртуальные машины или физические серверы. Планы используются для оркестрации отработки отказа нескольких машин согласно параметрам группы, в которой находятся эти машины. Дополнительные сведения о планах восстановления см. [здесь](site-recovery-create-recovery-plans.md).

После того как отработка отказа будет завершена, а ваши машины начнут работать в дополнительном расположении, обратите внимание на указанные ниже сведения.

* Если вы выполнили отработку отказа с переносом в Azure, то после этой операции машины не будут защищены и для них не будет выполняться репликация в основное или дополнительное расположение. В Azure виртуальные машины хранятся в геореплицированном хранилище, которое обеспечивает отказоустойчивость, но не выполняет функции репликации.
* Если вы выполнили незапланированную отработку отказа с переносом на дополнительный сайт, то после этого машины в дополнительном расположении не будут защищены и для них не будет выполняться репликация.
* Если вы выполнили плановую отработку отказа с переносом на дополнительный сайт, то после этого машины в дополнительном расположении будут защищены.

### <a name="failback-from-secondary-site"></a>Восстановление размещения с выполнением переноса с дополнительного сайта
Для восстановления размещения с выполнением переноса из дополнительного сайта на основной используется тот же процесс, что и для отработки отказа с переносом из основного расположения в дополнительное. После фиксации и завершения отработки отказа с переносом из основного центра обработки данных в дополнительный можно начать обратную репликацию (когда основной сайт снова станет доступным). При обратной репликации будет запущена репликация между дополнительным и основным сайтами. Она выполняется путем синхронизации изменений данных. При обратной репликации виртуальные машины будут переведены в защищенное состояние, но при этом активным расположением по-прежнему останется дополнительный центр обработки данных. Чтобы сделать активным расположением основной сайт, необходимо запустить плановую отработку отказа с переносом из дополнительного расположения в основное, а затем выполнить еще одну обратную репликацию.

### <a name="failback-from-azure"></a>Восстановление размещения с выполнением переноса из Azure
Если вы выполнили отработку отказа с переносом в Azure, ваши виртуальные машины будут защищены функциями обеспечения устойчивости Azure. Чтобы сделать исходный основной сайт активным расположением, запустите плановую отработку отказа. Если исходный сайт недоступен, можно восстановить размещение в исходном или альтернативном расположении. Чтобы еще раз начать репликацию после восстановления размещения в основном расположении, необходимо запустить обратную репликацию.

### <a name="failover-considerations"></a>Рекомендации по отработке отказа
* **IP-адрес после отработки отказа**. По умолчанию машина, созданная в результате отработки отказа, и исходная машина будут иметь разные IP-адреса. Если необходимо, чтобы IP-адрес машины не изменился, выполните указанные ниже действия.
  * **Для дополнительного сайта**. Сведения о том, как при отработке отказа с выполнением переноса на дополнительный сайт сохранить IP-адрес неизменным, см. в [этой статье](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx). Обратите внимание, что для сохранения общедоступного IP-адреса неизменным необходимо, чтобы ваш поставщик услуг Интернета поддерживал такую возможность.
  * **Для Azure**. В случае переноса в Azure при отработке отказа можно указать необходимый IP-адрес на вкладке **Настройка** в разделе свойств виртуальной машины. Невозможно сохранить общедоступный IP-адрес после отработки отказа с переносом в Azure. Вы можете сохранить адресные пространства, не оговоренные в документе RFC 1918 и использующиеся в качестве внутренних адресов.
* **Частичная отработка отказа**. Если необходимо выполнить отработку отказа только для части сайта, обратите внимание на указанные ниже сведения.

  * **Для дополнительного сайта**. Если при отработке отказа на дополнительный сайт переносится только часть основного сайта и вы хотите подключиться обратно к основному сайту, используйте VPN-подключение типа "сеть — сеть". С его помощью можно подключать приложения, для которых выполнена отработка отказа и которые размещены на дополнительном сайте, к компонентам инфраструктуры, работающим на основном сайте. При отработке отказа для всей подсети можно сохранить IP-адрес виртуальной машины. При отработке отказа для части подсети не удастся сохранить IP-адрес виртуальной машины, так как невозможно разделить подсети между сайтами.
  * **Для Azure**. Если при отработке отказа в Azure переносится только часть сайта и вы хотите подключиться обратно к основному сайту, используйте VPN-подключение типа "сеть — сеть". С его помощью можно подключить приложение, для которого выполнена отработка отказа и которое размещено в Azure, к компонентам инфраструктуры, работающим на основном сайте. Обратите внимание, что при отработке отказа для всей подсети можно сохранить IP-адрес виртуальной машины. При отработке отказа для части подсети не удастся сохранить IP-адрес виртуальной машины, так как невозможно разделить подсети между сайтами.
* **Буква диска**. Если после отработки отказа необходимо сохранить буквы дисков на виртуальных машинах, можно **включить** политику SAN для виртуальной машины. Диски виртуальных машин станут доступны автоматически. [Дополнительные сведения](https://technet.microsoft.com/library/gg252636.aspx).
* **Маршрутизация клиентских запросов**. После отработки отказа Site Recovery организует маршрутизацию клиентских запросов к вашему приложению вместе с диспетчером трафика Azure.

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
Сведения о выполнении тестовой отработки отказа в Azure см. в [этой статье](site-recovery-test-failover-to-azure.md). Сведения о выполнении тестовой отработки отказа на другой локальный сайт под управлением сервера VMM см. в [этой статье](site-recovery-test-failover-vmm-to-vmm.md).  

## <a name="run-a-planned-failover-primary-to-secondary"></a>Запуск плановой отработки отказа (перенос из основного расположения в дополнительное)
 В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.

1. Перед началом работы убедитесь, что все виртуальные машины, для которых необходимо выполнить отработку отказа, завершили первоначальную репликацию.
2. Выберите **Планы восстановления** > *имя_плана_восстановления*. Последовательно выберите пункты **Тип отработки отказа** > **Planned Тип отработки отказа**.
3. На странице **Подтвердить плановую отработку отказа **выберите исходное и целевое расположения. Запомните направление отработки отказа.

   * Если предыдущие отработки отказа выполнены правильно и все серверы виртуальных машин размещены в исходном или целевом расположении, то сведения о направлении отработки отказа понадобятся исключительно в информационных целях.
   * Если виртуальные машины активны как в исходном, так и в целевом расположениях, появится кнопка **Изменить направление** . С помощью этой кнопки можно изменить и указать направление, в котором должна выполняться отработка отказа.
4. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
5. Когда начнется плановая отработка отказа, прежде всего необходимо завершить работу виртуальных машин, чтобы предотвратить потерю данных. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. Если при отработке отказа возникнет ошибка (либо на виртуальной машине, либо в сценарии, который включен в план восстановления), плановая отработка отказа в рамках плана восстановления будет остановлена. Вы сможете запустить отработку отказа еще раз.
6. После создания реплицированных виртуальных машин они находятся в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать** .
7. По завершении репликации виртуальные машины будут запущены в дополнительном расположении.

## <a name="run-an-unplanned-failover"></a>Запуск незапланированной отработки отказа
В этой процедуре рассказывается, как запустить незапланированную тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины или физического сервера.

1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Последовательно выберите пункты **Тип отработки отказа** > **Unplanned Тип отработки отказа**.
2. На странице **Подтвердить внеплановую отработку отказа **выберите исходное и целевое расположения. Запомните направление отработки отказа.

   * Если предыдущие отработки отказа выполнены правильно и все серверы виртуальных машин размещены в исходном или целевом расположении, то сведения о направлении отработки отказа понадобятся исключительно в информационных целях.
   * Если виртуальные машины активны как в исходном, так и в целевом расположениях, появится кнопка **Изменить направление** . С помощью этой кнопки можно изменить и указать направление, в котором должна выполняться отработка отказа.
3. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
4. Установите флажок **Завершать работу виртуальных машин и синхронизировать последние данные**. Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных. Если вы не установите этот флажок или попытка выполнить указанные выше действия окажется неудачной, то отработка отказа будет выполнена на основе последней доступной точки восстановления для виртуальной машины.
5. На вкладке **Задания** можно следить за ходом выполнения отработки отказа. Обратите внимание, что даже в случае возникновения ошибок во время незапланированной отработки отказа план восстановления будет выполнен до его полного завершения.
6. После отработки отказа виртуальные машины будут находиться в состоянии **ожидании фиксации** . Для фиксации отработки отказа выберите команду **Зафиксировать** .
7. Если репликация настроена так, что в процессе ее выполнения используются несколько точек восстановления, то в разделе "Изменение точки восстановления" можно настроить соответствующие параметры так, чтобы выбиралась не последняя точка восстановления (используемая по умолчанию). После фиксации дополнительные точки восстановления будут удалены.
8. Когда репликация завершится, виртуальные машины будут запущены в дополнительном расположении. Тем не менее, они не защищены и не будут реплицироваться. Когда основной сайт и вся инфраструктура, на которой он основан, снова станут доступными, выберите пункт **Обратная репликация** , чтобы начать обратную репликацию. Это гарантирует, что все данные будут реплицированы обратно на основной сайт и что виртуальная машина снова будет готова для отработки отказа. При обратной репликации после незапланированной отработки отказа передаются дополнительные служебные данные. При передаче будет использоваться метод, который настроен для изначальной репликации для облака.

## <a name="failback-from-secondary-to-primary"></a>Восстановление размещения в основном расположении (перенос из дополнительного)
 После отработки отказа с переносом из основного расположения в дополнительное реплицированные виртуальные машины не будут защищены службой Site Recovery, а дополнительное расположение будет играть роль основного. Выполните указанные ниже процедуры, чтобы восстановить размещение на исходном основном сайте. В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.

1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Последовательно выберите пункты **Тип отработки отказа** > **Planned Тип отработки отказа**.
2. На странице **Подтвердить плановую отработку отказа **выберите исходное и целевое расположения. Запомните направление отработки отказа. Если отработка отказа с переносом из основного расположения выполнена правильно и все виртуальные машины находятся в дополнительном расположении, то эти данные будут носить исключительно информационный характер.
3. Если вы восстанавливаете размещение, выполняя перенос из Azure, выберите необходимые параметры в разделе **Синхронизация данных**.

   * **Синхронизация данных до отработки отказа (синхронизация только изменений)**. Этот параметр сводит к минимуму время простоя виртуальных машин, так как при его использовании синхронизация выполняется без завершения их работы. Он выполняет следующие действия:
     * Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
     * Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.

    - **Синхронизация данных только во время отработки отказа (полное скачивание)**. Укажите этот параметр, если использовали Azure в течение длительного времени. Этот параметр обеспечивает более быстрое выполнение, так как мы ожидаем, что была изменена большая часть диска и не хотим тратить время на вычисление контрольной суммы. Выполняется скачивание диска. Это также удобно, если локальная виртуальная машина была удалена.

    > [!NOTE] 
    > Рекомендуется использовать этот параметр, если вы использовали Azure какое-то время (месяц или дольше) или локальная виртуальная машина была удалена. Этот параметр не задает вычисление каких-либо контрольных сумм.
    >
    >


1. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
2. По умолчанию используется последняя точка восстановления, но в разделе **Изменение точки восстановления** можно указать другую точку восстановления.
3. Установите этот флажок, чтобы начать восстановление размещения.  На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
4. Если вы выбрали параметр, при котором синхронизация данных выполняется до отработки отказа, то когда завершится начальная синхронизация данных и вы будете готовы завершить работу виртуальных машин в Azure, выберите **Задания** > <planned failover job name> **Полная отработка отказа**. Эта команда завершит работу машины Azure, передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.
5. После этого вы сможете выполнить вход в виртуальную машину, чтобы проверить ее доступность.
6. Виртуальная машина будет находиться в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать** .
7. Теперь для восстановления размещения выберите пункт **Обратная репликация** , чтобы включить защиту виртуальной машины на основном сайте.

## <a name="failback-to-an-alternate-location"></a>Восстановление расположения в альтернативном расположении
Если вы развернули защиту между [сайтом Hyper-V и Azure](site-recovery-hyper-v-site-to-azure.md) , то можно восстановить размещение, выполнив перенос из Azure в альтернативное локальное расположение. Это удобно, если необходимо настроить новое оборудование в локальной системе. Вот как это сделать.

1. При настройке нового оборудования установите на сервере Windows Server 2012 R2 и роль Hyper-V.
2. Создайте коммутатор виртуальной сети с тем же именем, что и на исходном сервере.
3. Выберите группу **Защищенные элементы** -> **Группа защиты** -> <ProtectionGroupName> -> <VirtualMachineName>, для которой необходимо выполнить восстановление размещения, а затем выберите пункт **Плановая отработка отказа**.
4. При необходимости в разделе **Подтвердить плановую отработку отказа** select **Создать локальную виртуальную машину, если ее не существует**.
5. В разделе **Имя узла** выберите новый сервер узла Hyper-V, на котором требуется разместить виртуальную машину.
6. В разделе "Синхронизация данных" рекомендуется выбрать параметр **Синхронизировать данные до отработки отказа**. Это сведет к минимуму простой виртуальных машин, так как синхронизация будет выполнена без завершения их работы. Он выполняет следующие действия:

   * Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
   * Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
7. Установите этот флажок, чтобы начать отработку отказа (восстановление размещения).
8. Когда завершится начальная синхронизация и вы будете готовы завершить работу виртуальной машины в Azure, выберите **Задания** > <planned failover job> > **Полная отработка отказа**. Эта команда завершит работу машины Azure и передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.
9. Вы можете выполнить вход в локальную виртуальную машину, чтобы проверить, что все работает правильно. Затем нажмите кнопку **Зафиксировать** , чтобы завершить отработку отказа.
10. Выберите пункт **Обратная репликация** , чтобы включить защиту локальной виртуальной машины.

    > [!NOTE]
    > Если отменить задание восстановления размещения на этапе синхронизации данных, локальная виртуальная машина будет в поврежденном состоянии. Причина этого в том, что при синхронизации данных последние данные с дисков виртуальной машины Azure копируются на локальные диски данных, и пока синхронизация не завершится, диски данных могут находиться в несогласованном состоянии. И если отменить синхронизацию данных и попытаться загрузить локальную виртуальную машину, она может не загрузиться. Повторно активируйте отработку отказа, чтобы завершить синхронизацию данных.
    >
    >



<!--HONumber=Jan17_HO2-->


