---
title: Настройка исходного окружения и сервера конфигурации для аварийного восстановления виртуальных машин VMware в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье объясняется, как настроить локальное окружение и сервер конфигурации для аварийного восстановления виртуальных машин VMware в Azure с помощью Azure Site Recovery.
services: site-recovery
author: Rajeswari-Mamilla
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 10/29/2018
ms.author: ramamill
ms.openlocfilehash: e09e93ef85449c51e35b8da7ad93ee7088a0e7b4
ms.sourcegitcommit: 6b7c8b44361e87d18dba8af2da306666c41b9396
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2018
ms.locfileid: "51566318"
---
# <a name="set-up-the-source-environment-and-configuration-server"></a>Настройка исходной среды и сервера конфигурации

В этой статье объясняется, как настроить исходное локальное окружение для аварийного восстановления виртуальных машин VMware в Azure с помощью [Azure Site Recovery](site-recovery-overview.md). В статье также описано, как выбрать локальный компьютер в качестве сервера конфигурации Azure Site Recovery и настроить автоматическое обнаружение локальных виртуальных машин. 

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать работу, нужно обеспечить следующее.

- Создайте план системы аварийного восстановления с использованием [Планировщика развертывания Azure Site Recovery](site-recovery-deployment-planner.md). Этот Планировщик гарантирует, что у вас будет достаточно ресурсов и пропускной способности для аварийного восстановления, а также обеспечит наличие целевой точки восстановления (RPO) для вашей организации.
- [Настройте ресурсы Azure](tutorial-prepare-azure.md) на [портале Azure](http://portal.azure.com).
- [Настройте локальные ресурсы VMware](vmware-azure-tutorial-prepare-on-premises.md), в том числе выделенную учетную запись для автоматического обнаружения локальных виртуальных машин VMware.
- Вы можете [изучить часто задаваемые вопросы](vmware-azure-common-questions.md#configuration-server) о развертывании сервера конфигурации и управлении им.


## <a name="choose-protection-goals"></a>Настройка целей защиты

1. В колонке **Хранилища служб восстановления** выберите имя хранилища. 
2. В разделе **Приступая к работе** выберите Site Recovery. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Are your machines virtualized** (Ваши компьютеры виртуализированы?) выберите **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere). Нажмите кнопку **ОК**.

## <a name="about-the-configuration-server"></a>Сведения о сервере конфигурации

Локальный сервер конфигурации развертывается при настройке аварийного восстановления виртуальных машин VMware в Azure.

- Сервер конфигурации используется для управления обменом данными между локальной средой VMware и Azure. Он также управляет репликацией данных.
- Сервер конфигурации развертывается в качестве виртуальной машины VMware.
- Site Recovery предоставляет для скачивания с портала Azure шаблон OVA, который вы можете импортировать в vCenter Server для настройки виртуальной машины сервера конфигурации.
- См. дополнительные сведения о [компонентах и процессах сервера конфигурации](vmware-azure-architecture.md).


>[!NOTE]
Не используйте эту статью, если вы развертываете сервер конфигурации для аварийного восстановления локальных физических компьютеров в Azure. Реализация этого сценария описана [здесь](physical-azure-set-up-source.md).


## <a name="before-you-deploy-the-configuration-server"></a>Действия перед развертыванием сервера конфигурации

Если вы устанавливаете сервер конфигурации в качестве виртуальной машины VMware с помощью шаблона OVA, для созданной виртуальной машины будут сразу установлены все обязательные компоненты. Эти условия и компоненты описаны в следующих статьях.

- См. дополнительные сведения о [требованиях к оборудованию, программному обеспечению и характеристикам для сервера конфигурации](vmware-azure-configuration-server-requirements.md).
- Если выполняется репликация виртуальных машин VMware, изучите [рекомендации планирования емкости](site-recovery-plan-capacity-vmware.md) и запустите инструмент [Планировщик ресурсов Azure Site Recovery](site-recovery-deployment-planner.md) для репликации VMWare.
- В шаблон OVA включена лицензия для ознакомления с Windows со сроком действия 180 дней. По истечении этого времени необходимо активировать Windows, указав действительную лицензию. 
- Шаблон OVA позволяет быстро настроить сервер конфигурации в качестве виртуальной машины VMware. Если по какой-либо причине вы хотите настроить виртуальную машину VMware без использования шаблона, изучите [предварительные требования и инструкции по установке вручную](physical-azure-set-up-source.md).
- Учетная запись Azure должна иметь разрешения на создание приложений Azure AD.


>[!IMPORTANT]
Развертывание сервера конфигурации должно соответствовать описанию в этой статье. Копирование и клонирование существующего сервера конфигурации не поддерживается.

### <a name="set-up-azure-account-permissions"></a>Настройка разрешений для учетной записи Azure

Администратор клиента и глобальный администратор могут назначить учетной записи разрешения на создание приложений Azure AD или присвоить ей роль разработчика приложений (которая уже имеет нужные разрешения).


Администратор клиента и глобальный администратор могут предоставить разрешения, выполнив следующие действия:

1. В Azure AD глобальному администратору или администратору клиента нужно перейти в раздел **Azure Active Directory** > **Пользователи** > **Параметры пользователей**.
2. Затем для параметра **Регистрация приложений** нужно выбрать вариант **Да**.

 > [!NOTE]
 > Это значение по умолчанию, которое разрешает выполнять регистрацию. [Узнайте больше](https://docs.microsoft.com/azure/active-directory/develop/active-directory-how-applications-are-added#who-has-permission-to-add-applications-to-my-azure-ad-instance).

Также этот администратор может назначить учетной записи роль. [Узнайте больше](https://docs.microsoft.comazure/active-directory/fundamentals/active-directory-users-assign-role-azure-portal).

 


## <a name="download-the-ova-template"></a>Скачивание шаблона OVA

1. В хранилище выберите **Prepare Infrastructure** (Подготовка инфраструктуры)  > **Source** (Источник).
2. В колонке **Подготовка источника** выберите **+ Сервер конфигурации**.
3. В колонке **Add Server** (Добавление сервера) в поле **Server type** (Тип сервера) должно быть указано **Configuration server for VMware** (Сервер конфигурации для VMware).
4. Скачайте шаблон Open Virtualization Application (OVA) для сервера конфигурации.

  > [!TIP]
>Вы можете также скачать последнюю версию шаблона для сервера конфигурации из [Центра загрузки Майкрософт](https://aka.ms/asrconfigurationserver).


## <a name="import-the-ova-template-in-vmware"></a>Импорт шаблона OVA в VMware

1. Войдите на сервер VMware vCenter или узел vSphere ESXi с помощью клиента VMWare vSphere.
2. В меню **Файл** (File) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить мастер развертывания шаблона OVF.

     ![Шаблон OVF](./media/vmware-azure-deploy-configuration-server/vcenter-wizard.png)

3. Укажите расположение скачанного шаблона OVF в разделе **Select source** (Выбор источника).
4. В разделе **Review details** (Просмотр сведений) выберите **Next** (Далее).
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** (Выбор хранилища), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки) в области **Select virtual disk format** (Выбор формата виртуального диска).
7. На остальных страницах мастера примите значение параметров по умолчанию.
8. Чтобы настроить виртуальную машину с параметрами по умолчанию, на странице **Ready to complete** (Готово к завершению) выберите **Power on after deployment** > **Finish** (Включить после развертывания > Готово).
9. По умолчанию виртуальная машина развертывается с одним сетевым адаптером. Если вам нужен дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** (Включить после развертывания) и щелкните **Finish** (Готово). После этого выполните следующую процедуру.

## <a name="add-an-adapter-to-the-configuration-server"></a>Добавление сетевого адаптера на сервер конфигурации

Если вы хотите добавить дополнительный сетевой адаптер к серверу конфигурации, добавьте его до регистрации сервера в хранилище. Возможность добавления дополнительных адаптеров не поддерживается после регистрации.

1. В списке клиента vSphere щелкните виртуальную машину правой кнопкой мыши и выберите **Edit Settings** (Изменить параметры).
2. В разделе **Hardware** (Оборудование) выберите **Add** > **Ethernet Adapter** (Добавить > Адаптер Ethernet). Затем нажмите кнопку **Далее**.
3. Выберите тип адаптера и сеть.
4. Чтобы подключить виртуальный сетевой адаптер на включенной виртуальной машине, выберите **Connect at power on** (Подключиться, когда включено). Затем выберите **Next** > **Finish** > **OK** (Далее > Готово > ОК).

## <a name="register-the-configuration-server"></a>Регистрация сервера конфигурации 
Включите виртуальную машину и зарегистрируйте сервер конфигурации в хранилище Site Recovery.

1. Из консоли клиента VMWare vSphere включите виртуальную машину.
2. Виртуальная машина загрузится в среду установки Windows Server 2016. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите в виртуальную машину от имени администратора.



## <a name="set-up-the-configuration-server"></a>Настройка сервера конфигурации

В ходе развертывания установите MySQL на виртуальной машине для сервера конфигурации. Это можно сделать несколькими способами.

- Разрешите Site Recovery скачать и установить MySQL. Если вы хотите использовать этот вариант, дополнительные действия до настройки сервера конфигурации не требуются.
- Скачайте и установите MySQL вручную. В этом варианте перед настройкой сервера конфигурации следует скачать установщик MySQL и поместить его в папку **C:\Temp\ASRSetup**. Теперь установите MySQL. 
- Скачайте установщик вручную и разрешите Site Recovery его установить. В этом варианте перед настройкой сервера конфигурации следует скачать установщик MySQL и поместить его в папку **C:\Temp\ASRSetup**.


1. При первом входе на виртуальную машину будет запущено средство конфигурации Azure Site Recovery.
2. Укажите имя, которое использовалось при регистрации сервера конфигурации в хранилище Site Recovery. Затем нажмите кнопку **Далее**.
3. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure. Учтите, что учетная запись должна иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.
4. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
5. Снова войдите в систему. Через несколько секунд автоматически запустится мастер управления сервером конфигурации.
6. В мастере выберите действие **Настройка подключения**.
7. Выберите тот сетевой адаптер, который используется сервером обработки (он по умолчанию запускается на сервере конфигурации) для получения трафика репликации от виртуальных машин.
8. Затем нажмите кнопку **Save** (Сохранить). Учтите, что параметры хранилища невозможно изменить после регистрации сервера конфигурации. 
9. В разделе **Select Recovery Services vault** (Выбор хранилища служб восстановления) войдите в Microsoft Azure, выберите свою подписку Azure и соответствующие группу и хранилище. 
10. На экране **Установка программного обеспечения стороннего производителя** выполните установку MySQL.
     - Если скачивание и установку MySQL вы доверили Site Recovery, щелкните**Скачать и установить**. Дождитесь окончания установки и продолжите работу с мастером.
     - Если вы уже скачали MySQL и разрешаете Site Recovery выполнить установку, щелкните **Скачать и установить**. Дождитесь завершения установки и продолжите работу с мастером.
     - Если вы уже скачали и установили MySQL вручную, щелкните **Скачать и установить**. Приложение отобразит сообщение **Уже установлено**. Продолжите работу с мастером.
11. Прежде чем вы продолжите, установщик проверит предварительные требования в разделе **Проверка конфигурации модуля**. 
12. В разделе **Настройка сервера vCenter Server и vSphere ESXi** укажите полное доменное имя или IP-адрес сервера vCenter или узла vSphere, на которых расположены виртуальные машины для репликации. Укажите порт, который прослушивает сервер, и понятное имя для сервера VMware в хранилище.
13. Укажите учетные данные, которые будут использоваться сервером конфигурации для подключения к серверу VMware и автоматического обнаружения доступных для репликации виртуальных машин VMware. Выберите **Добавить** >  **Продолжить**. Учетные данные будут сохранены на локальном компьютере.
14. В разделе **Настройка учетных данных виртуальной машины** укажите учетные данные, которые Site Recovery будет использовать для автоматической установки Mobility Service при включении репликации для виртуальной машины.
    - Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать.
    - Для Linux предоставьте сведения для учетной записи root.
15. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации.
16. После завершения регистрации откройте портал Azure и убедитесь, что сервер конфигурации и сервер VMware указаны на странице **Хранилище служб восстановления** > **Управление** > **Инфраструктура Site Recovery** > **Серверы конфигурации**.


## <a name="exclude-antivirus-on-the-configuration-server"></a>Настройка исключений для антивирусной программы на сервере конфигурации

Если на виртуальной машине для сервера конфигурации выполняется антивирусная программа, добавьте следующие папки в список исключений. Это необходимо для правильного выполнения репликации и подключения. 

- C:\Program Files\Microsoft Azure Recovery Services Agent
- C:\Program Files\Microsoft Azure Site Recovery Provider.
- C:\Program Files\Microsoft Azure Site Recovery Configuration Manager.
- C:\Program Files\Microsoft Azure Site Recovery Error Collection Tool.
- C:\thirdparty.
- C:\Temp.
- C:\strawberry.
- C:\ProgramData\MySQL.
- C:\Program Files (x86)\MySQL.
- C:\ProgramData\ASR.
- C:\ProgramData\Microsoft Azure Site Recovery.
- C:\ProgramData\ASRLogs.
- C:\ProgramData\ASRSetupLogs.
- C:\ProgramData\LogUploadServiceLogs.
- C:\inetpub.
- Каталог установки Site Recovery. Например, это может быть E:\Program Files (x86) \Microsoft Azure Site Recovery.


## <a name="next-steps"></a>Дополнительная информация
- Если возникли проблемы, просмотрите [часто задаваемые вопросы](vmware-azure-common-questions.md#configuration server) и [рекомендации по устранению неполадок](vmware-azure-troubleshoot-configuration-server.md) для сервера конфигурации.
- Теперь переходите к [настройке целевой среды](./vmware-azure-set-up-target.md) в Azure.
