---
title: "Как установить главный целевой сервер Linux для отработки отказа из Azure в локальную среду | Документация Майкрософт"
description: "Для повторного включения защиты виртуальной машины Linux необходим главный целевой сервер Linux. Узнайте, как его установить."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: c4fb25880584add0832464d9049dc6c78059c48b
ms.openlocfilehash: 8ac18526e6781f189444233a191aa1d6c5b863ff
ms.lasthandoff: 02/22/2017


---
# <a name="how-to-install-linux-master-target-server"></a>Как установить главный целевой сервер Linux
После отработки отказа виртуальных машин вы можете выполнить для них восстановление размещения обратно в локальную среду. Для восстановления размещения следует перевести виртуальную машину в защищенное состояние, настроив для нее отработку отказа из Azure в локальную среду. Для этого понадобится главный целевой сервер, который будет получать трафик в локальной среде. Если защита включается для виртуальной машины Windows, вам потребуется главный целевой сервер Windows. Для включения защиты виртуальной машины Linux необходим главный целевой сервер Linux. Описанные ниже действия помогут вам создать и установить главный целевой сервер Linux.

## <a name="overview"></a>Обзор
Эта статья содержит сведения и инструкции по установке главного целевого сервера Linux.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="pre-requisites"></a>Предварительные требования

* Чтобы правильно выбрать узел для развертывания главного целевого сервера, определите метод восстановления размещения:&1;) в существующую виртуальную машину в локальной среде;&2;) в новую виртуальную машину (в случае удаления локальной виртуальной машины). 
    * Если выбрана существующая виртуальная машина, узел главного целевого сервера должен иметь доступ к ее хранилищам данных.
    * Если виртуальная машина в локальной среде не существует, на узле, на котором размещен главный целевой сервер, создается новая виртуальная машина для восстановления размещения. Для установки главного целевого сервера можно выбрать любой узел ESXi.
* Главный целевой сервер должен находиться в сети, позволяющей ему взаимодействовать с сервером обработки и сервером конфигурации.
* Версия главного целевого сервера должна быть не выше, чем версия на сервере конфигурации и сервере обработки. (Например, если на сервере конфигурации используется версия 9.4, то главный целевой сервер может использовать версию 9.4 или 9.3, но не 9.5.)
* Главным целевым сервером может быть только виртуальная машина VMware, а не физический компьютер.


## <a name="steps-to-deploy-the-master-target-server"></a>Инструкции по развертыванию главного целевого сервера

### <a name="install-centos-66-minimal"></a>Установка CentOS 6.6 с минимальным набором возможностей

Выполните действия, приведенные ниже, чтобы установить 64-разрядную версию операционной системы CentOS 6.6.

1. Среди приведенных ниже ссылок выберите ближайшее зеркало для скачивания ISO-файла 64-разрядной версии CentOS 6.6 с минимальным набором возможностей.

    <http://archive.kernel.org/centos-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://mirror.symnds.com/distributions/CentOS-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://bay.uchicago.edu/centos-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://mirror.nsc.liu.se/centos-store/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    Оставьте диск с ISO-файлом 64-разрядной версии CentOS 6.6 с минимальным набором возможностей в DVD-дисководе и перезапустите систему.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image1.png)

2. Выберите **Skip** (Пропустить), чтобы пропустить тестирование носителя.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image2.png)

3. Теперь вы увидите экран приветствия программы установки. Нажмите кнопку **Next** (Далее).

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image3.png)

4. Выберите **English** (Английский) в качестве предпочтительного языка и нажмите кнопку **Next** (Далее), чтобы продолжить.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image4.png)

5. Выберите раскладку клавиатуры **US English** (Английский (США)). Нажмите кнопку **Next** (Далее), чтобы продолжить установку.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image5.png)

6. Выберите тип устройств для установки. Выберите **Basic storage Devices** (Основные устройства хранилища). Нажмите кнопку **Next** (Далее), чтобы продолжить установку.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image6.png)

7. Появится предупреждение о том, что будут удалены существующие данные на жестком диске. Убедитесь, что жесткий диск не содержит важные данные, и щелкните **Yes, discard any data** (Да, удалить все данные).

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image7.png)

8. Введите имя узла для сервера в текстовом поле **Hostname** (Имя узла). Щелкните **Configure Network** (Настройка сети), затем в окне **Network Connection** (Сетевое подключение) выберите сетевой интерфейс. Нажмите кнопку **Edit** (Изменить), чтобы настроить параметры IPv4.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image8.png)

9. Дальше отобразится окно **Editing System eth0** (Изменение системного интерфейса eth0). Установите флажок **Connect automatically** (Подключаться автоматически). На вкладке "IPv4 Settings" (Параметры IPv4) выберите метод **Manual** (Ручной) и нажмите кнопку **Add** (Добавить). Укажите статический IP-адрес, маску подсети, шлюз и DNS-сервер. Нажмите кнопку **Apply** (Применить), чтобы сохранить настройки.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image9.png)

10. Выберите часовой пояс в поле со списком и нажмите кнопку **Next** (Далее), чтобы продолжить.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image10.png)

11. Введите значение **Root password** (Пароль привилегированного пользователя) и подтвердите его. Нажмите кнопку **Next** (Далее), чтобы продолжить.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image11.png)

12. Для параметра "Mode of Partition" (Режим создания разделов) выберите значение **Create Custom Layout** (Создать пользовательский макет) и нажмите кнопку **Next** (Далее).

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image12.png)

13. Выберите раздел **Free** (Свободный) и нажмите кнопку **Create** (Создать), чтобы создать разделы **/**, **/var/crash** и **/home** с типом файловой системы **ext4**. Создайте **раздел подкачки** с файловой системой типа **swap**. При выделении размера раздела следуйте формуле выделяемого размера, как указано в следующей таблице.

    > [!NOTE]
    > В системе главного целевого сервера Linux не следует использовать тип LVM для корня файловой системы и дисковых пространств хранения. По умолчанию главный целевой сервер под управлением ОС Linux настроен так, чтобы не обнаруживать разделы и диски LVM.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image13.png)

14. После создания раздела нажмите кнопку **Next** (Далее).

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image14.png)

15. Если будут обнаружены уже установленные устройства, появится предложение отформатировать их. Нажмите кнопку **Format** (Форматировать), чтобы отформатировать диск с использованием последней таблицы разделов.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image15.png)

16. Щелкните **Write change to disk** (Записать изменения на диск), чтобы применить изменения разделов к диску.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image16.png)

17. Установите флажок **Install boot loader** (Установить загрузчик) и нажмите кнопку **Next** (Далее), чтобы установить загрузчик в корневой раздел.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image17.png)


18. Начнется процесс установки. Вы можете наблюдать за ходом установки.

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image18.png)

19. После успешного завершения установки вы увидите приведенный ниже экран. Нажмите кнопку **Reboot** (Перезагрузить).

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image19.png)


### <a name="post-installation-steps"></a>Действия после установки
Теперь мы подготовим компьютер для роли главного целевого сервера.

Чтобы получить идентификаторы SCSI для всех жестких дисков SCSI в виртуальной машине под управлением ОС Linux, необходимо присвоить параметру disk.EnableUUID значение TRUE.

Чтобы включить этот параметр, выполните указанные ниже действия.

а. Завершите работу виртуальной машины.

b. Щелкните правой кнопкой мыши запись виртуальной машины в левой панели и выберите **Edit Settings** (Изменить параметры).

c. Откройте вкладку **Параметры** .

г) Последовательно выберите **Advanced (Дополнительно) &gt; General item** (Общий элемент) слева, а затем щелкните **Configuration Parameters** (Параметры конфигурации) справа.

![](./media/site-recovery-how-to-install-linux-master-target/media/image20.png)

Когда виртуальная машина работает, кнопка "Параметры конфигурации" неактивна. Чтобы она стала активной, завершите работу компьютера.

д. Посмотрите, есть ли строка с параметром **disk.EnableUUID**.

Е. Если такая строка существует и имеет значение False, замените его на True (значения True и False можно вводить в любом регистре).

g. Если значение существует и имеет значение True, щелкните "Отмена".
    
h. Если такой строки нет, нажмите кнопку **Добавить строку**.

i. Введите имя столбца disk.EnableUUID и задайте для этого параметра значение True.

   * Если такая строка существует и параметр имеет значение False, замените его на True (значения True и False можно вводить в любом регистре).

   * Если строка существует и параметр имеет значение True, нажмите кнопку "Отмена" и после загрузки операционной системы на виртуальной машине проверьте в ней команду SCSI.

Е. Если такой строки нет, нажмите кнопку **Add Row** (Добавить строку).

  В столбце "Имя" добавьте параметр disk.EnableUUID.

  Присвойте этому параметру значение TRUE.



![](./media/site-recovery-how-to-install-linux-master-target/media/image21.png)

#### <a name="download-and-install-the-additional-packages"></a>Скачивание и установка дополнительных пакетов

> [!NOTE]
> Перед скачиванием и установкой дополнительных пакетов убедитесь, что система подключена к Интернету, иначе вам придется вручную искать и устанавливать RPM для этих пакетов.

```
yum install -y xfsprogs perl lsscsi rsync wget kexec-tools
```

Эта команда скачает 15 перечисленных ниже пакетов из репозитория CentOS 6.6 и установит их. Если нет доступа к Интернету, скачайте следующие RPM.


bc-1.06.95-1.el6.x86\_64.rpm

busybox-1.15.1-20.el6.x86\_64.rpm

elfutils-libs-0.158-3.2.el6.x86\_64.rpm

kexec-tools-2.0.0-280.el6.x86\_64.rpm

lsscsi-0.23-2.el6.x86\_64.rpm

lzo-2.03-3.1.el6\_5.1.x86\_64.rpm

perl-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-Module-Pluggable-3.90-136.el6\_6.1.x86\_64.rpm

perl-Pod-Escapes-1.04-136.el6\_6.1.x86\_64.rpm

perl-Pod-Simple-3.13-136.el6\_6.1.x86\_64.rpm

perl-libs-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-version-0.77-136.el6\_6.1.x86\_64.rpm

rsync-3.0.6-12.el6.x86\_64.rpm

snappy-1.1.0-1.el6.x86\_64.rpm

wget-1.12-5.el6\_6.1.x86\_64.rpm


#### <a name="install-additional-packages-for-specific-operating-systems"></a>Установка дополнительных пакетов для определенных операционных систем

> [!NOTE]
> Если в исходной защищенной виртуальной машине для корневого или загрузочного устройства используется файловая система Reiser или XFS, вам необходимо скачать указанные ниже дополнительные пакеты и установить их на главный целевой сервер Linux, прежде чем настраивать защиту.
 

***ReiserFS (если используется Suse11SP3, хотя ReiserFS не является файловой системой по умолчанию в Suse&11; SP3)***

```
cd /usr/local

wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm>

wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm>

rpm -ivh kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm
reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm
```

***XFS (RHEL, начиная с CentOS 7)***.

```
cd /usr/local

wget
<http://archive.kernel.org/centos-vault/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_64.rpm>

rpm -ivh xfsprogs-3.1.1-16.el6.x86\_64.rpm

yum install device-mapper-multipath 
```
Это необходимо для добавления пакетов Multipath на главный целевой сервер.

### <a name="get-the-installer-for-setup"></a>Получение установщика для установки

Если у главного целевого сервера есть доступ к Интернету, вы можете скачать установщик, как описано ниже. В противном случае скопируйте установщик с сервера обработки и запустите его.

#### <a name="download-the-mt-installation-packages"></a>Скачивание пакетов установки главного целевого сервера

Скачайте последние установочные файлы главного целевого сервера Linux отсюда: [https://aka.ms/latestlinuxmobsvc](https://aka.ms/latestlinuxmobsvc).

Чтобы скачать их из Linux, введите следующую команду. 

```
wget https://aka.ms/latestlinuxmobsvc -O latestlinuxmobsvc.tar.gz
```

Обязательно скачайте и распакуйте установщик только в свой домашний каталог. Если распаковать его в /usr/local, то установка завершится ошибкой.


#### <a name="access-the-installer-from-the-process-server"></a>Доступ к программе установки с сервера обработки

Зайдите на сервер обработки и перейдите к каталогу C:\Program Files (x86)\Microsoft Azure Site Recovery\home\svsystems\pushinstallsvc\repository.

Скопируйте нужный файл установщика с сервера обработки и сохраните его с именем latestlinuxmobsvc.tar.gz в домашнем каталоге.


### <a name="apply-custom-configuration-changes"></a>Применение изменений настраиваемой конфигурации

Чтобы применить изменения настраиваемой конфигурации, выполните указанные ниже действия.


1. Запустите указанную ниже команду, чтобы распаковать двоичный файл.
    ```
    tar -zxvf latestlinuxmobsvc.tar.gz
    ```

    ![](./media/site-recovery-how-to-install-linux-master-target/image16.png)
    
2. Выполните указанную ниже команду, чтобы предоставить необходимое разрешение.
    ```
    chmod 755 ./ApplyCustomChanges.sh
    ```

3. Выполните указанную ниже команду, чтобы запустить необходимый сценарий.
    ```
    ./ApplyCustomChanges.sh
    ```
> [!NOTE]
> Этот скрипт следует выполнять на сервере только один раз. Завершите работу сервера. Добавьте на сервер диск, как описано ниже, а затем перезагрузите сервер.

### <a name="add-retention-disk-to-linux-mt-vm"></a>Добавление диска хранения на виртуальную машину главного целевого сервера Linux 

Выполните действия, приведенные ниже, чтобы создать диск хранения.

1. Присоединить новый диск объемом **1 ТБ** к виртуальной машине Linux MT и **загрузите** виртуальную машину.

2. Выполните команду **multipath -ll**, чтобы знать идентификатор Multipath диска хранения.

    ```
    multipath -ll
    ```

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image22.png)

3. Отформатируйте диск и создайте на нем файловую систему. 
    
    ```
    mkfs.ext4 /dev/mapper/<Retention disk's multipath id>
    ```
    ![](./media/site-recovery-how-to-install-linux-master-target/media/image23.png)

4. После создания файловой системы подключите диск хранения.
    ```
    mkdir /mnt/retention
    mount /dev/mapper/<Retention disk's multipath id> /mnt/retention
    ```

    ![](./media/site-recovery-how-to-install-linux-master-target/media/image24.png)

5. Наконец, создайте запись fstab, чтобы диск хранения автоматически подключался при каждой загрузке.
    ```
    vi /etc/fstab 
    ```
    Нажмите клавишу [INSERT], чтобы изменить содержимое файла. Создайте новую строку и вставьте в нее следующий текст. Замените идентификатор многопутевого диска тем идентификатором, который выделен в предыдущей команде.

    **/dev/mapper/<Retention disks multipath id> /mnt/retention ext4 rw 0 0**

    Нажмите клавишу [ESC] и введите ":wq", чтобы сохранить файл и закрыть окно редактора.

### <a name="install-master-target"></a>Установка главного целевого сервера

> [!NOTE]
> Версия главного целевого сервера должна быть не выше, чем версия на сервере обработки и сервере конфигурации. Если версия главного целевого сервера выше, то включить защиту удастся, однако репликация завершится ошибкой.
 

> [!NOTE]
> Перед установкой главного целевого сервера убедитесь, что файл /etc/hosts на виртуальной машине содержит записи, которые сопоставляют локальное имя узла с IP-адресами, связанными со всеми сетевых адаптерами.
 
1. Скопируйте парольную фразу из файла **C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase**, размещенного на сервере конфигурации. Затем сохраните ее в файле passphrase.txt в том же каталоге, выполнив следующую команду.

    ```
    echo <passphrase> >passphrase.txt
    ```
    Пример: echo itUx70I47uxDuUVY >passphrase.txt

2. Запишите IP-адрес сервера конфигурации. Он понадобится нам на следующем шаге.

3. Выполните следующую команду, чтобы установить главный целевой сервер и зарегистрировать его на сервере конфигурации.
    
    ```
    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i <Configuration Server IP Address> -p 443 -s y -c https -P passphrase.txt
    ```

    Пример команды: ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

    Дождитесь, пока завершится выполнение скрипта. Если регистрация главного целевого сервера пройдет успешно, вы увидите его на портале, в списке на странице инфраструктуры Site Recovery.

#### <a name="installing-master-target-using-interactive-install"></a>Установка главного целевого сервера с помощью интерактивного процесса

1. Выполните указанную ниже команду, чтобы установить главный целевой сервер. Выберите роль агента "Master Target" (Главный целевой сервер).

    ```
    ./install
    ```

2. Подтвердите расположение по умолчанию для установки, нажав клавишу ВВОД.
    
    ![](./media/site-recovery-how-to-install-linux-master-target/image17.png)
    

3. Выберите глобальные параметры для настройки.

    ![](./media/site-recovery-how-to-install-linux-master-target/image18.png)
    
4. Укажите IP-адреса сервера конфигурации.

5. Укажите порт 443 для сервера конфигурации.
    
    ![](./media/site-recovery-how-to-install-linux-master-target/image19.png)
    
6. Скопируйте парольную фразу из файла C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase на сервере конфигурации, затем вставьте ее в соответствующее поле. Это поле останется пустым даже после вставки текста.

7. Выберите пункт меню [Выход].

8. Дождитесь завершения установки и регистрации.

### <a name="install-vmware-tools-on-the-master-target-server"></a>Установка инструментов VMware на главном целевом сервере

На главном целевом сервере нужно установить инструменты VMware, чтобы он мог обнаруживать хранилища данных. Если они не установлены, то на экране повторного включения защиты не будут отображены хранилища данных. После установки средств VMware выполните перезагрузку.

## <a name="next-steps"></a>Дальнейшие действия
Когда завершится установка и регистрация главного целевого сервера, он появится в разделе главных целевых серверов на странице инфраструктуры Site Recovery, — там же, где представлены сведения о сервере настройки.

Теперь можно настроить [обратную защиту](site-recovery-how-to-reprotect.md) и выполнить восстановления размещения.

## <a name="common-issues"></a>Распространенные проблемы

* Убедитесь, что Storage vMotion не используется для компонентов системы управления, например для главного целевого сервера. Если вы переместите главный целевой сервер после успешной настройки обратной защиты, VMDK не сможет успешно отсоединиться, и восстановление размещения завершится ошибкой.
* На главном целевом сервере нельзя использовать моментальные снимки для виртуальной машины. Если существуют моментальные снимки, восстановление размещения завершится ошибкой.
* В некоторых пользовательских конфигурациях сетевые адаптеры отключаются на время загрузки. В такой ситуации агент главного целевого сервера не сможет выполнить инициализацию. Убедитесь, что правильно заданы следующие свойства.
    * Проверьте следующие два свойства в файлах сетевых адаптеров (/etc/sysconfig/network-scripts/ifcfg-eth*):
        * BOOTPROTO=dhcp 
        * ONBOOT=yes


