---
title: "Как установить главный целевой сервер Linux для отработки отказа из Azure в локальную среду | Документация Майкрософт"
description: "Для повторного включения защиты виртуальной машины Linux необходим главный целевой сервер Linux. Узнайте, как его установить."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: 5cce99eff6ed75636399153a846654f56fb64a68
ms.openlocfilehash: c75a3a2477f113f17aab7a3e1969f15a4ec88a02
ms.lasthandoff: 03/31/2017


---
# <a name="how-to-install-a-linux-master-target-server"></a>Как установить главный целевой сервер Linux
После отработки отказа виртуальных машин для них можно восстановить размещение на локальном сайте. Для восстановления размещения из Azure на локальном сайте необходимо повторно включить защиту виртуальной машины. Для этого понадобится локальный главный целевой сервер, который будет получать трафик. Если защита включается для виртуальной машины Windows, вам потребуется главный целевой сервер Windows. Для виртуальной машины Linux необходим главный целевой сервер Linux. В следующих разделах этой статьи описано, как создать и установить главный целевой сервер Linux.

## <a name="overview"></a>Обзор
Эта статья содержит сведения и инструкции по установке главного целевого сервера Linux.

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="prerequisites"></a>Предварительные требования

* Чтобы правильно выбрать узел для развертывания главного целевого сервера, определите метод восстановления размещения: 1) в существующую виртуальную машину в локальной среде; 2) в новую виртуальную машину (в случае удаления локальной виртуальной машины).
    * Если выбрана существующая виртуальная машина, узел главного целевого сервера должен иметь доступ к ее хранилищам данных.
    * Если локальная виртуальная машина не существует, на том же узле, где размещен главный целевой сервер, создается восстанавливаемая виртуальная машина. Для установки главного целевого сервера можно выбрать любой узел ESXi.
* Главный целевой сервер должен находиться в сети, позволяющей ему взаимодействовать с сервером обработки и сервером конфигурации.
* Версия главного целевого сервера должна соответствовать версии сервера обработки и сервера конфигурации или быть более ранней. Например, если версия сервера конфигурации — 9.4, версия главного целевого сервера может быть 9.4 или 9.3, но не 9.5.
* Главным целевым сервером может быть только виртуальная машина VMware, а не физический сервер.
* Рекомендации по размеру главного целевого объекта
    * ОЗУ: 6 ГБ или больше.
    * Размер диска ОС: 50 ГБ или больше (для установки CentOS6.6).
    * Дополнительное пространство для диска хранения: 1 ТБ.
    * Ядра ЦП: 4 ядра или больше.




## <a name="steps-to-deploy-the-master-target-server"></a>Инструкции по развертыванию главного целевого сервера

### <a name="install-centos-66-minimal"></a>Установка CentOS 6.6 с минимальным набором возможностей

Для установки 64-разрядной операционной системы CentOS 6.6 сделайте следующее:

1. Среди приведенных ниже ссылок выберите ближайшее зеркало для скачивания ISO-файла 64-разрядной версии CentOS 6.6 с минимальным набором возможностей.

    <http://archive.kernel.org/centos-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://mirror.symnds.com/distributions/CentOS-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://bay.uchicago.edu/centos-vault/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    <http://mirror.nsc.liu.se/centos-store/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso>

    Оставьте диск с ISO-файлом 64-разрядной версии CentOS 6.6 с минимальным набором возможностей в DVD-дисководе и перезапустите систему.

    ![Диалоговое окно CentoOS 6.6 с приветствием](./media/site-recovery-how-to-install-linux-master-target/media/image1.png)

2. Щелкните **Skip** (Пропустить), чтобы пропустить тестирование носителя.

    ![Выбор Skip (Пропустить) для пропуска тестирования носителя](./media/site-recovery-how-to-install-linux-master-target/media/image2.png)

3. На экране приветствия программы установки нажмите кнопку **Next** (Далее).

    ![Кнопка Next (Далее) на экране приветствия программы установки](./media/site-recovery-how-to-install-linux-master-target/media/image3.png)

4. Выберите **Русский** в качестве предпочтительного языка и нажмите кнопку **Next** (Далее).

    ![Выбор языка](./media/site-recovery-how-to-install-linux-master-target/media/image4.png)

5. Выберите раскладку клавиатуры **Russian (Русский)**, а затем нажмите кнопку **Next** (Далее).

    ![Выбор раскладки клавиатуры "Русский"](./media/site-recovery-how-to-install-linux-master-target/media/image5.png)

6. Установите переключатель **Стандартный накопители**, а затем нажмите кнопку **Далее**.

    ![Выбор устройства хранения](./media/site-recovery-how-to-install-linux-master-target/media/image6.png)

7. Появится предупреждение о том, что будут удалены имеющиеся данные на жестком диске. Убедитесь, что жесткий диск не содержит важных данных, и щелкните **Да, удалить все данные**.

    ![Предупреждение об удалении данных в случае продолжения](./media/site-recovery-how-to-install-linux-master-target/media/image7.png)

8. Введите имя узла для сервера в **соответствующем поле**, а затем щелкните **Настроить сеть**. В диалоговом окне **Сетевые соединения** выберите сетевой интерфейс и нажмите кнопку **Изменить**, чтобы настроить параметры IPV4.

    ![Выбор имени узла и настройка IPV4](./media/site-recovery-how-to-install-linux-master-target/media/image8.png)

9. В диалоговом окне **Изменение System eth0** установите флажок **Подключаться автоматически**. На вкладке **Параметры IPv4** выберите **метод** **Вручную** и нажмите кнопку **Добавить**. Укажите **статический IP-адрес**, **маску подсети**, **шлюз** и **DNS-сервер**. Нажмите кнопку **Apply** (Применить), чтобы сохранить настройки.

    ![Параметры конфигурации сети](./media/site-recovery-how-to-install-linux-master-target/media/image9.png)

10. Выберите часовой пояс и нажмите кнопку **Далее**.

    ![Выбор часового пояса](./media/site-recovery-how-to-install-linux-master-target/media/image10.png)

11. Введите значение **Пароль root** и подтвердите его. Нажмите кнопку **Далее**.

    ![Добавление пароля](./media/site-recovery-how-to-install-linux-master-target/media/image11.png)

12. Выберите **Создать собственное разбиение**, а затем нажмите кнопку **Далее**.

    ![Выбор типа установки](./media/site-recovery-how-to-install-linux-master-target/media/image12.png)

13. Выберите раздел **Свободный** и нажмите кнопку **Создать**, чтобы создать разделы **/**, **/var/crash** и **/home** с типом файловой системы **ext4**. Создайте **раздел подкачки** с файловой системой типа **swap**. При выделении размера раздела следуйте формуле выделяемого размера, как указано в следующей таблице.

    > [!NOTE]
    > На главном целевом сервере Linux не следует использовать диспетчер логических томов (LVM) для корня файловой системы или дисковых пространств хранения. По умолчанию главный целевой сервер Linux настроен так, чтобы не обнаруживать разделы и диски LVM.

    ![Таблица с именами и размерами разделов, а также типами файловых систем](./media/site-recovery-how-to-install-linux-master-target/media/image13.png)

14. После создания раздела нажмите кнопку **Далее**.

    ![Диалоговое окно со сведениями о выбранных значениях для разделов](./media/site-recovery-how-to-install-linux-master-target/media/image14.png)

15. Если будут обнаружены уже установленные устройства, появится предложение отформатировать их. Нажмите кнопку **Форматировать**, чтобы отформатировать диск с использованием последней таблицы разделов.

    ![Кнопка "Форматировать" для форматирования диска](./media/site-recovery-how-to-install-linux-master-target/media/image15.png)

16. Щелкните **Сохранить изменения на диск**, чтобы применить изменения разделов к диску.

    ![Выбор "Сохранить изменения на диск"](./media/site-recovery-how-to-install-linux-master-target/media/image16.png)

17. Установите флажок **Установить загрузчик** и нажмите кнопку **Далее**, чтобы установить загрузчик в корневой раздел.

    ![Установка загрузчика в корневом разделе](./media/site-recovery-how-to-install-linux-master-target/media/image17.png)


18. Начнется процесс установки. Ход выполнения можно отслеживать.

    ![Диалоговое окно со сведениями о ходе установки](./media/site-recovery-how-to-install-linux-master-target/media/image18.png)

19. После успешного завершения установки вы увидите приведенный ниже экран. Нажмите кнопку **Перезагрузка**.

    ![Экран успешной установки](./media/site-recovery-how-to-install-linux-master-target/media/image19.png)


### <a name="post-installation-steps"></a>Действия после установки
Теперь подготовьте компьютер для роли главного целевого сервера.

Чтобы получить идентификатор для каждого жесткого диска SCSI в виртуальной машине Linux, необходимо присвоить параметру **disk.EnableUUID значение TRUE**.

Для этого сделайте следующее:

1. Завершите работу виртуальной машины.

2. Щелкните правой кнопкой мыши запись виртуальной машины в области слева, а затем выберите **Изменить параметры**.

3. Откройте вкладку **Параметры** .

4. В области слева выберите **Дополнительно &gt; Общие**, а затем нажмите кнопку **Параметры конфигурации** справа.

    ![Вкладка "Параметры"](./media/site-recovery-how-to-install-linux-master-target/media/image20.png)

    Когда виртуальная машина работает, кнопка **Параметры конфигурации** неактивна. Чтобы она стала активной, завершите работу виртуальной машины.

5. Посмотрите, есть ли строка с параметром **disk.EnableUUID**.

    - Если такая строка существует и имеет значение **False**, замените его на **True** (значения True и False можно вводить в любом регистре).

    - Если строка существует и имеет значение **True**, щелкните **Отмена**.

    - Если такой строки нет, нажмите кнопку **Добавить строку**.

    - Введите **имя** столбца **disk.EnableUUID** и задайте для этого параметра значение **True**.

    ![Проверка наличия параметра disk.EnableUUID](./media/site-recovery-how-to-install-linux-master-target/media/image21.png)

#### <a name="download-and-install-additional-packages"></a>Скачивание и установка дополнительных пакетов

> [!NOTE]
> Убедитесь, что система подключена к Интернету, чтобы скачать и установить дополнительные пакеты. Без подключения к Интернету вам придется вручную искать и устанавливать пакеты RPM.

```
yum install -y xfsprogs perl lsscsi rsync wget kexec-tools
```

Предыдущая команда скачает 15 перечисленных ниже пакетов из репозитория CentOS 6.6 и установит их. Если нет доступа к Интернету, скачайте следующие пакеты RPM:


bc-1.06.95-1.el6.x86\_64.rpm

busybox-1.15.1-20.el6.x86\_64.rpm

elfutils-libs-0.158-3.2.el6.x86\_64.rpm

kexec-tools-2.0.0-280.el6.x86\_64.rpm

lsscsi-0.23-2.el6.x86\_64.rpm

lzo-2.03-3.1.el6\_5.1.x86\_64.rpm

perl-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-Module-Pluggable-3.90-136.el6\_6.1.x86\_64.rpm

perl-Pod-Escapes-1.04-136.el6\_6.1.x86\_64.rpm

perl-Pod-Simple-3.13-136.el6\_6.1.x86\_64.rpm

perl-libs-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-version-0.77-136.el6\_6.1.x86\_64.rpm

rsync-3.0.6-12.el6.x86\_64.rpm

snappy-1.1.0-1.el6.x86\_64.rpm

wget-1.12-5.el6\_6.1.x86\_64.rpm


#### <a name="install-additional-packages-for-specific-operating-systems"></a>Установка дополнительных пакетов для определенных операционных систем

> [!NOTE]
> Если в исходной защищенной виртуальной машине для корневого или загрузочного устройства используется файловая система ReiserFS или XFS, вам необходимо скачать указанные ниже дополнительные пакеты и установить их на главный целевой сервер Linux, прежде чем настраивать защиту.


***ReiserFS (если используется Suse11SP3, ReiserFS не является файловой системой по умолчанию в Suse 11 SP3)***

```
cd /usr/local

wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm>

wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm>

rpm -ivh kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm
reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm
```

***XFS (RHEL, начиная с CentOS 7)***

```
cd /usr/local

wget
<http://archive.kernel.org/centos-vault/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_64.rpm>

rpm -ivh xfsprogs-3.1.1-16.el6.x86\_64.rpm

yum install device-mapper-multipath
```
Требуется для добавления пакетов Multipath на главный целевой сервер.

### <a name="get-the-installer-for-setup"></a>Получение установщика для установки

Если на главном целевом сервере есть доступ к Интернету, вы можете скачать установщик, как описано ниже. В противном случае скопируйте установщик с сервера обработки и установите его.

#### <a name="download-the-master-target-installation-packages"></a>Скачивание пакетов установки главного целевого сервера

[Скачайте последние установочные файлы главного целевого сервера Linux](https://aka.ms/latestlinuxmobsvc).

Чтобы скачать их из Linux, введите следующую команду:

```
wget https://aka.ms/latestlinuxmobsvc -O latestlinuxmobsvc.tar.gz
```

Обязательно скачайте и распакуйте установщик в свой домашний каталог. Если распаковать его в /usr/local, то установка завершится ошибкой.


#### <a name="access-the-installer-from-the-process-server"></a>Доступ к программе установки с сервера обработки

1. Зайдите на сервер обработки и перейдите к каталогу C:\Program Files (x86)\Microsoft Azure Site Recovery\home\svsystems\pushinstallsvc\repository.

2. Скопируйте нужный файл установщика с сервера обработки и сохраните его с именем latestlinuxmobsvc.tar.gz в домашнем каталоге.


### <a name="apply-custom-configuration-changes"></a>Применение изменений настраиваемой конфигурации

Чтобы применить изменения настраиваемой конфигурации, сделайте следующее:


1. Выполните следующую команду, чтобы распаковать двоичный файл.
    ```
    tar -zxvf latestlinuxmobsvc.tar.gz
    ```
    ![Снимок экрана выполняемой команды](./media/site-recovery-how-to-install-linux-master-target/image16.png)

2. Выполните следующую команду, чтобы предоставить необходимое разрешение.
    ```
    chmod 755 ./ApplyCustomChanges.sh
    ```

3. Выполните следующую команду, чтобы запустить скрипт.
    ```
    ./ApplyCustomChanges.sh
    ```
> [!NOTE]
> Этот сценарий необходимо выполнить на сервере только один раз. Завершите работу сервера. Добавьте на сервер диск, как описано ниже, а затем перезагрузите сервер.

### <a name="add-a-retention-disk-to-the-linux-master-target-virtual-machine"></a>Добавление диска хранения на виртуальную машину главного целевого сервера Linux

Чтобы создать диск хранения, сделайте следующее:

1. Присоедините новый диск объемом **1 ТБ** к виртуальной машине главного целевого сервера Linux и **загрузите** виртуальную машину.

2. Выполните команду **multipath -ll**, чтобы узнать об идентификаторе Multipath диска хранения.

    ```
    multipath -ll
    ```

    ![Идентификатор Multipath диска хранения](./media/site-recovery-how-to-install-linux-master-target/media/image22.png)

3. Отформатируйте диск и создайте на нем файловую систему.

    ```
    mkfs.ext4 /dev/mapper/<Retention disk's multipath id>
    ```
    ![Создание файловой системы на диске](./media/site-recovery-how-to-install-linux-master-target/media/image23.png)

4. После создания файловой системы подключите диск хранения.
    ```
    mkdir /mnt/retention
    mount /dev/mapper/<Retention disk's multipath id> /mnt/retention
    ```

    ![Подключение диска хранения](./media/site-recovery-how-to-install-linux-master-target/media/image24.png)

5. Создайте запись **fstab**, чтобы диск хранения автоматически подключался при каждой загрузке.
    ```
    vi /etc/fstab
    ```
    Нажмите клавишу **INSERT**, чтобы изменить содержимое файла. Создайте строку и вставьте приведенный ниже текст. Замените идентификатор многопутевого диска тем идентификатором, который выделен в предыдущей команде.

    **/dev/mapper/<Retention disks multipath id> /mnt/retention ext4 rw 0 0**

    Нажмите клавишу **ESC** и введите **:wq**, чтобы сохранить файл и закрыть окно редактора.

### <a name="install-the-master-target"></a>Установка главного целевого сервера

> [!IMPORTANT]
> Версия главного целевого сервера должна соответствовать версии сервера обработки и сервера конфигурации или быть более ранней. Если это условие не соблюдено, то включить защиту удастся, однако репликация завершится ошибкой.


> [!NOTE]
> Перед установкой главного целевого сервера убедитесь, что файл /etc/hosts на виртуальной машине содержит записи, которые сопоставляют локальное имя узла с IP-адресами, связанными со всеми сетевыми адаптерами.

1. Скопируйте парольную фразу из файла C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase, размещенного на сервере конфигурации. Затем сохраните ее в файле passphrase.txt в том же каталоге, выполнив следующую команду.

    ```
    echo <passphrase> >passphrase.txt
    ```
    Пример: echo itUx70I47uxDuUVY >passphrase.txt

2. Запишите IP-адрес сервера конфигурации. Он понадобится нам на следующем шаге.

3. Выполните следующую команду, чтобы установить главный целевой сервер и зарегистрировать его на сервере конфигурации.

    ```
    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i <Configuration Server IP Address> -p 443 -s y -c https -P passphrase.txt
    ```

    Пример команды: ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

    Дождитесь завершения скрипта. Если регистрация главного целевого сервера пройдет успешно, вы увидите его на портале, в списке на странице инфраструктуры Site Recovery.

#### <a name="install-the-master-target-by-using-interactive-install"></a>Установка главного целевого сервера с помощью интерактивного процесса

1. Выполните следующую команду для установки главного целевого сервера. Выберите роль агента **Master Target** (Главный целевой сервер).

    ```
    ./install
    ```

2. Подтвердите расположение по умолчанию для установки, нажав клавишу **ВВОД**.

    ![Выбор расположения по умолчанию для установки главного целевого сервера](./media/site-recovery-how-to-install-linux-master-target/image17.png)


3. Выберите **глобальные** параметры для настройки.

    ![Настройка глобальных параметров](./media/site-recovery-how-to-install-linux-master-target/image18.png)

4. Укажите IP-адреса сервера конфигурации.

5. Укажите порт 443 для сервера конфигурации.

    ![Указание IP-адреса и порта для сервера конфигурации](./media/site-recovery-how-to-install-linux-master-target/image19.png)

6. Скопируйте парольную фразу из файла C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase на сервере конфигурации, затем вставьте ее в **соответствующее** поле. Поле будет пустым, даже после вставки текста.

7. Выберите пункт меню **Quit** (Выход).

8. Дождитесь завершения установки и регистрации.

### <a name="install-vmware-tools-on-the-master-target-server"></a>Установка инструментов VMware на главном целевом сервере

На главном целевом сервере нужно установить средства VMware, чтобы он мог обнаруживать хранилища данных. Если они не установлены, то на экране повторного включения защиты не будут отображены хранилища данных. После установки средств VMware выполните перезагрузку.

## <a name="next-steps"></a>Дальнейшие действия
Когда завершится установка и регистрация главного целевого сервера, он появится в разделе **главных целевых серверов** на странице **инфраструктуры Site Recovery** — там же, где представлены сведения о сервере конфигурации.

Теперь можно настроить [повторную защиту](site-recovery-how-to-reprotect.md) и выполнить восстановление размещения.

## <a name="common-issues"></a>Распространенные проблемы

* Убедитесь, что Storage vMotion не используется для компонентов системы управления, например для главного целевого сервера. Если вы переместите главный целевой сервер после успешного повторного включения защиты, диски виртуальной машины (VMDK) не удастся отсоединить, и восстановление размещения завершится ошибкой.
* На главном целевом сервере нельзя использовать моментальные снимки для виртуальной машины. Если существуют моментальные снимки, восстановление размещения завершится ошибкой.
* В некоторых пользовательских конфигурациях сетевые интерфейсы отключаются на время запуска. В такой ситуации агент главного целевого сервера не сможет выполнить инициализацию. Убедитесь, что правильно заданы следующие свойства. Проверьте эти свойства в файлах сетевых адаптеров (/etc/sysconfig/network-scripts/ifcfg-eth*.).
        * BOOTPROTO=dhcp * ONBOOT=yes

