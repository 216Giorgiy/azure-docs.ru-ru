---
title: "Репликация физических серверов в Azure | Документация Майкрософт"
description: "В этой статье описывается, как развернуть Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление физических серверов Windows и Linux в Azure с использованием портала Azure"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/17/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: 3396818cd177330b7123f3a346b1591a4bcb1e4e
ms.openlocfilehash: c9994e4e826bc35e1de439684ed5877db91fa069
ms.lasthandoff: 02/22/2017


---
# <a name="replicate-physical-machines-to-azure-with-azure-site-recovery-using-the-azure-portal"></a>Репликация физических компьютеров в Azure с помощью службы Azure Site Recovery и портала Azure


Вас приветствует служба Azure Site Recovery.

Site Recovery — это служба Azure, которая помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR). Она координирует репликацию локальных физических серверов и виртуальных машин в облако (Azure) или дополнительный центр обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Дополнительные сведения см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

Эта статья описывает репликацию в Azure физических серверов Windows или Linux с использованием службы Azure Site Recovery и портала Azure.

Если после прочтения этой статьи у вас появятся комментарии, вы можете оставить их внизу в разделе Disqus. Вы можете задать любые вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="steps"></a>Действия

Необходимо сделать следующее:

1. Выполните предварительные требования и ознакомьтесь с ограничениями.
2. Настройте сеть и учетные записи хранения Azure.
3. Подготовьте локальный компьютер, который необходимо развернуть в качестве сервера конфигурации.
4. Создайте хранилище служб восстановления, которое содержит параметры конфигурации и управляет репликацией.
5. Укажите источник, целевой объект и параметры репликации.
6. Разверните службу мобильности на виртуальных машинах, которые необходимо реплицировать.
7. Включите репликацию для виртуальных машин.
7. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

## <a name="prerequisites"></a>Предварительные требования

**Необходимая поддержка** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** | Ознакомьтесь с [требованиями Azure](site-recovery-prereq.md#azure-requirements).
**Локальный сервер конфигурации** | Вам потребуется локальный компьютер под управлением Windows Server 2012 R2 или более поздней версии. Настройте этот сервер при развертывании Site Recovery.<br/><br/> По умолчанию сервер обработки и главный целевой сервер также устанавливаются на эту виртуальную машину. При увеличении масштаба вам может понадобиться отдельный сервер обработки. К нему выдвигаются те же требования, что и к серверу конфигурации.<br/><br/> Узнайте больше об этих компонентах [здесь](site-recovery-set-up-vmware-to-azure.md#configuration-server-minimum-requirements).
**Локальные виртуальные машины** | Виртуальные машины, которые необходимо реплицировать, должны работать под управлением [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions) и соответствовать [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
**URL-адреса** | Серверу конфигурации требуется доступ к следующим URL-адресам:<br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/></br> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).<br/></br> Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).<br/><br/> Разрешите доступ к URL-адресу http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi для скачивания MySQL.
**Служба Mobility Service** | Должна быть установлена на каждой реплицированной виртуальной машине.


## <a name="site-recovery-in-the-azure-portal"></a>Служба Site Recovery на портале Azure
В Azure предлагаются две разные [модели развертывания](../azure-resource-manager/resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager и классическая модель. Кроме того, Azure предоставляет два портала: классический портал Azure и портал Azure.

В этой статье описывается развертывание на портале Azure, то есть более функциональный и более простой вариант. Классический портал можно использовать для поддержания существующих хранилищ. Новые хранилища с помощью классического портала создавать нельзя.


## <a name="set-up-azure"></a>Настройка Azure

1. [Настройте сеть Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md).
    - Виртуальные машины Azure будут размещаться в этой сети при создании после отработки отказа.
    - Сеть можно настроить с помощью [Resource Manager](../resource-manager-deployment-model.md) или классической модели.

2. Настройте [учетную запись хранения Azure](../storage/storage-create-storage-account.md#create-a-storage-account) для реплицированных данных.
    - Учетная запись может быть класса Standard или [Premium](../storage/storage-premium-storage.md).
    - Учетную запись можно настроить с помощью Resource Manager или классической модели.

## <a name="prepare-the-configuration-server"></a>Подготовить сервер конфигурации

1. Установите на локальный сервер Windows Server 2012 R2 или более поздней версии.
2. Убедитесь, что виртуальная машина имеет доступ к URL-адресам, перечисленным в разделе [Предварительные требования](#prerequisites).

**Подготовка учетной записи для принудительной установки службы мобильности.** Если требуется принудительно установить службу мобильности на виртуальные машины, необходимо использовать учетную запись, которая может использоваться сервером обработки для доступа к виртуальной машине. Эта учетная запись предназначена только для принудительной установки. Вы можете использовать доменную или локальную учетную запись.

  - Для Windows, если учетная запись домена не используется, на локальном компьютере потребуется отключить контроль удаленного доступа пользователей. Для этого в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись **LocalAccountTokenFilterPolicy** DWORD и задайте для нее значение 1.
    - Если требуется добавить запись в реестр Windows из командной строки, введите:   ``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``
  - Для Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux.

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]

## <a name="select-the-protection-goal"></a>Выбор целевого объекта защиты

Выберите целевые объекты и место для репликации.

1. Щелкните **Хранилища служб восстановления** > хранилище.
2. В меню ресурсов щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goal-physical.PNG)
3. На странице **Цель защиты** выберите **To Azure** (В Azure), а затем — **Без виртуализации или иное**.


## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Настройте сервер конфигурации, зарегистрируйте его в хранилище и найдите виртуальные машины.

1. Щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Источник**.
2. Если у вас нет сервера конфигурации, щелкните **+Configuration server** (+Сервер конфигурации).

    ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source1.png)
3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
4. Скачайте файл единой установки Site Recovery.
5. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение пяти дней после создания.

   ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source2.png)
6. Убедитесь, что системные часы на виртуальной машине сервера конфигурации синхронизированы с [сервером времени](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/get-started/windows-time-service/windows-time-service), а затем запустите программу единой установки, чтобы установить сервер конфигурации, сервер обработки и главный целевой сервер.

## <a name="run-site-recovery-unified-setup"></a>Выполнение единой установки Site Recovery

Перед началом работы:

- Убедитесь в том, что время на виртуальной машине соответствует времени местного часового пояса. Значения времени должны совпадать. Если системные часы отстают или спешат в пределах 15 минут, установка может завершиться ошибкой.
- На виртуальной машине сервера конфигурации запустите программу установки от имени локального администратора.
- Включите на компьютере протокол TLS 1.0.

Затем запустите на сервере конфигурации установочный файл программы единой установки.


[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]

> [!NOTE]
> Сервер конфигурации можно установить с помощью командной строки. См. дополнительные сведения об [установке сервера конфигурации с помощью средств командной строки](http://aka.ms/installconfigsrv).

## <a name="set-up-the-target"></a>Настройка цели

Перед настройкой целевой среды убедитесь, что у вас есть [учетная запись хранения Azure и сеть](#set-up-azure).

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите, какая целевая модель развертывания используется: классическая или Resource Manager.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Цель](./media/site-recovery-vmware-to-azure/gs-target.png)
4. Если вы еще не создали учетную запись хранения или сеть, щелкните **+Storage account** (+Учетная запись хранения) или **+Network** (+Сеть), чтобы создать учетную запись Resource Manager или сеть.

## <a name="set-up-replication-settings"></a>Настройка параметров репликации

1. Чтобы создать новую политику репликации, щелкните **Site Recovery infrastructure** (Инфраструктура Site Recovery) > **Политики репликации** > **+Replication Policy** (+Политика репликации).
2. На странице **Создать политику репликации** укажите имя политики.
3. В поле **Пороговое значение RPO**укажите предельное значение целевой точки восстановления (RPO). Это значение указывает, как часто создаются точки восстановления данных. Если непрерывная репликация превышает это значение, выдаются оповещения.
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов, а для хранилища класса Standard — до 72 часов.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений**укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений. Нажмите кнопку **ОК** , чтобы создать политику.

    ![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication2.png)
8. Созданная политика автоматически сопоставляется с облаком сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.  


## <a name="plan-capacity"></a>Планирование ресурсов

1. Теперь вся базовая инфраструктура готова и можно начать планирование ресурсов, чтобы выяснить, нужны ли дополнительные ресурсы. [Подробнее](site-recovery-plan-capacity-vmware.md).
2. После планирования ресурсов в поле **Вы выполнили планирование ресурсов?** выберите **Да**.

   ![Планирование загрузки](./media/site-recovery-vmware-to-azure/gs-capacity-planning.png)


## <a name="prepare-vms-for-replication"></a>Подготовка виртуальных машин к репликации

На все компьютеры, которые требуется реплицировать, необходимо установить службу мобильности. Службу мобильности можно установить несколькими способами.

1. Установить принудительно через сервер обработки. Чтобы использовать этот метод, необходимо подготовить виртуальные машины.
2. Установить с помощью средства развертывания, например System Center Configuration Manager, или с помощью DSC службы автоматизации Azure.
3.  Установить вручную.

[Дополнительные сведения](site-recovery-vmware-to-azure-install-mob-svc.md)


## <a name="enable-replication"></a>Включение репликации

Перед началом работы:

- При добавлении или изменении виртуальных машин может понадобиться около 15 минут или больше, чтобы изменения вступили в силу и отобразились на портале.
- Последнее время обнаружения виртуальных машин можно узнать, выбрав **Серверы конфигурации** > **Последний контакт в**.
- Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.
* Если виртуальная машина уже подготовлена для принудительной установки, сервер обработки автоматически устанавливает на него службу мобильности при включении репликации.


### <a name="exclude-disks-from-replication"></a>Исключение дисков из репликации

По умолчанию реплицируются все диски на виртуальной машине. Диски можно исключить из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb SQL Server).

### <a name="replicate-vms"></a>Репликация виртуальных машин

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**.
2. В поле **Источник** выберите "Локальный".
3. В поле **Исходное расположение** выберите имя нужного сервера конфигурации.
4. В поле **Тип компьютера** выберите параметр **Физические компьютеры**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. В поле **Сервер обработки** выберите сервер обработки. Если ни один дополнительный сервер обработки еще не создан, это будет сервер конфигурации. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-physical-to-azure/chooseVM.png)

6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.

7. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных. Если вы не хотите использовать настроенную учетную запись, можно создать новую.

8. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если вы не хотите использовать существующую сеть, можно создать новую.

    ![Включение репликации](./media/site-recovery-physical-to-azure/targetsettings.png)
9. В поле **Физические компьютеры** щелкните "+", введите **имя** и **IP-адрес**, а затем выберите тип операционной системы компьютера, который нужно реплицировать.
  ![Включение репликации](./media/site-recovery-physical-to-azure/machineselect.png) Необходимо подождать несколько минут, прежде чем компьютер будет обнаружен и появится в списке.

10. В поле **Свойства** > **Настройка свойств**и выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
11. По умолчанию будут реплицироваться все диски. Щелкните **Все диски** , а затем снимите флажки напротив дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства виртуальных машин.

    ![Включение репликации](./media/site-recovery-physical-to-azure/configprop.png)
11. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации. Если изменить политику, изменения будут применяться к реплицированным и новым виртуальным машинам.
12. Включите параметр **Согласование с несколькими виртуальными машинами** , если хотите объединить компьютеры в группу репликации, и укажите имя этой группы. Нажмите кнопку **ОК**. Обратите внимание на следующее.

    * Компьютеры в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные точки восстановления после отработки отказа.
    * Виртуальные машины и физические серверы рекомендуется объединять для того, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно.
    ![Включение репликации](./media/site-recovery-physical-to-azure/policy.png)

13. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

Если настроена принудительная установка, после включения репликации устанавливается служба мобильности. После того как служба мобильности будет принудительно установлена на виртуальной машине, задание защиты запустится и завершится сбоем. После сбоя каждый компьютер необходимо будет перезапустить вручную. После этого задание защиты будет запущено снова и будет выполнена начальная репликация.


### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Рекомендуется проверить свойства виртуальной машины и внести необходимые изменения.

1. Щелкните **Реплицированные элементы** и выберите компьютер. В колонке **Основные компоненты** отображается информация о параметрах и состоянии компьютеров.
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.
3. В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с [требованиями Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) .
4. Измените сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure.

   - Вы можете задать целевой IP-адрес.

    - Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP.
    - Если задать адрес, недоступный при отработке отказа, произойдет сбой.
    - Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.

   - Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины.

     - Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     - Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использоваться максимальный размер целевой машины.
     - Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
   - Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети.
   - Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером *по умолчанию* для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.
5. На странице **Диски** отображаются сведения об операционной системе виртуальной машины и дисках данных, которые будут реплицироваться.

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Когда настройка будет завершена, запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.


1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину, а затем — значок **Добавить тестовую отработку отказа**.

    ![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/TestFailover.png)

1. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).  

1. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое открывается щелчком по виртуальной машине, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Параметры** > **Задания** > **Задания Site Recovery**.

1. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.

1. Если вы заранее [подготовились к подключению после отработки отказа](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover), то сможете подключиться к виртуальной машине Azure.

1. Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.

См. дополнительные сведения о [тестовой отработке отказа в Azure](site-recovery-test-failover-to-azure.md).

## <a name="next-steps"></a>Дальнейшие действия

Как только вы настроите и запустите репликацию, в случае возникновения сбоя будет выполняться отработка отказа в Azure. При этом виртуальные машины Azure создаются на основе реплицированных данных. Затем вы сможете получать доступ к рабочим нагрузкам и приложениям в Azure, пока ваше исходное расположение не вернется в нормальный режим работы.

- [Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа и способах их выполнения.
- Ознакомьтесь со сведениями в [этом разделе](site-recovery-migrate-to-azure.md#migrate-on-premises-vms-and-physical-servers), если вам нужно перенести виртуальные машины без репликации и восстановления размещения.
- При репликации физических компьютеров восстановить размещение возможно только в среде VMware. См. сведения о восстановлении размещения [здесь](site-recovery-failback-azure-to-vmware.md).

## <a name="third-party-software-notices-and-information"></a>Уведомления и сведения о стороннем программном обеспечении
Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).  Microsoft is the not original author of the Third Party Code.  The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only.  This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.  

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.

