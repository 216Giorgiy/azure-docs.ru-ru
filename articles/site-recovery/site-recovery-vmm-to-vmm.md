<properties
	pageTitle="Репликация виртуальных машин Hyper-V из облаков VMM на вторичный сайт VMM с помощью портала Azure | Microsoft Azure"
	description="Описывается, как развернуть Azure Site Recovery, чтобы управлять репликацией, отработкой отказа и восстановлением виртуальных машин Hyper-V, запущенных в облаках VMM, на вторичный сайт VMM с помощью портала Azure."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/26/2016"
	ms.author="raynew"/>

# Репликация виртуальных машин Hyper-V из облаков VMM на вторичный сайт VMM | Microsoft Azure

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-vmm-to-vmm.md)
- [Классический портал](site-recovery-vmm-to-vmm-classic.md)

Вас приветствует служба Azure Site Recovery! Эта статья поможет вам выполнить репликацию локальных виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM), на вторичный сайт. В этой статье описывается, как настроить репликацию с помощью Azure Site Recovery на портале Azure.

> [AZURE.NOTE] В Azure предлагаются две [модели развертывания](../resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager (ARM) и классическая модель. Кроме того, Azure предоставляет два портала — классический портал Azure, поддерживающий классическую модель развертывания, и портал Azure, поддерживающий обе модели развертывания.


Azure Site Recovery на портале Azure обеспечивает множество новых возможностей:

- На портале Azure служба архивации Azure и службы Azure Site Recovery объединены в одном хранилище служб восстановления. Таким образом, вы можете настроить непрерывность бизнес-процессов и аварийное восстановление и управлять этими функциями из одного места. Единая панель мониторинга позволяет отслеживать операции между локальными сайтами и общедоступным облаком Azure и управлять ими.
- Теперь у пользователей с подписками Azure, которые подготовлены к работе в рамках программы для поставщиков облачных решений, появилась возможность управлять операциями Site Recovery на портале Azure.


Если после прочтения этой статьи у вас появятся комментарии, вы можете оставить их внизу в разделе обсуждений. Вы можете задать любые вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления, которая определяет, как приложения, рабочие нагрузки и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как можно максимально быстро восстановить нормальный режим работы. Эта стратегия должна обеспечивать защиту и восстановление бизнес-данных, а также постоянную доступность рабочих нагрузок в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Дополнительные сведения см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

Эта статья содержит все сведения, необходимые для репликации локальных виртуальных машин Hyper-V из облаков VMM на вторичный сайт VMM. Здесь приведены обзор архитектуры и сведения о планировании, а также рассмотрены этапы развертывания для настройки локальных серверов, параметров репликации и планирования загрузки. После настройки инфраструктуры можно включить репликацию на компьютерах, которые требуется защитить, и проверить работоспособность отработки отказа.

## Преимущества для предприятий

- Site Recovery обеспечивает защиту корпоративных рабочих нагрузок и приложений, запущенных на виртуальных машинах Hyper-V, реплицируя их на сервер-получатель Hyper-V.
- Портал служб восстановления предоставляет единое расположение для настройки, мониторинга и контроля репликации, отработки отказа и восстановления.
- Вы можете легко выполнять отработки отказа из первичной локальной инфраструктуры на вторичный сайт и восстанавливать размещение с вторичного сайта на первичный.
- Можно настроить планы восстановления для нескольких компьютеров, чтобы обеспечить отработку отказа рабочих нагрузок многоуровневого приложения.

## Архитектура сценария

Ниже приведены компоненты, участвующие в сценарии:

- **Первичный сайт**. На первичном сайте выполняется один или несколько серверов узла Hyper-V, на которых работают виртуальные машины, которые требуется реплицировать. Эти первичные серверы узла расположены в частном облаке VMM.
- **Вторичный сайт**. На вторичном сайте размещен один или несколько серверов узла Hyper-V, на которых работают целевые виртуальные машины. На них будут реплицированы первичные виртуальные машины. Эти серверы узла расположены в частном облаке VMM. Облако может находиться на первичном сервере (если имеется только один сервер VMM) или на вторичном сервере VMM.
- **Поставщик**. При развертывании Site Recovery на серверы VMM устанавливается поставщик Azure Site Recovery и эти серверы регистрируются в хранилище служб восстановления. Поставщик, запущенный на сервере VMM, обменивается данными со службой Site Recovery через порт HTTPS 443 для управления репликацией. Осуществляется репликация данных между первичным и вторичным серверами узла Hyper-V. Реплицированные данные остаются на локальных сайтах и в локальных сетях и не отправляются в Azure. Узнайте больше о [конфиденциальности](#privacy-information-for-site-recovery).

![Топология E2E](./media/site-recovery-vmm-to-vmm/architecture.png)

### Обзор конфиденциальности данных

В следующей таблице приведена сводка по хранению данных в этом сценарии.
****
Действие | **Дополнительные сведения** | **Собранные данные** | **Использование** | **Обязательный** 
--- | --- | --- | --- | ---
**Регистрация** | Вы регистрируете сервер VMM в хранилище служб восстановления. Если позже вы захотите отменить регистрацию сервера, это можно будет сделать, удалив сведения о сервере с портала Azure. | После регистрации сервера VMM служба Site Recovery собирает, обрабатывает и передает метаданные о сервере VMM и имена облаков VMM, обнаруженные службой Site Recovery. | Эти данные используются для идентификации соответствующего сервера VMM и обмена данными с ним, а также для настройки параметров соответствующих облаков VMM. | Это обязательная функция. Если вы не хотите отправлять эти сведения в службу Site Recovery, не следует ее использовать. 
**Включение репликации** | Поставщик Azure Site Recovery, установленный на сервере VMM, является каналом для взаимодействия со службой Site Recovery. Поставщик представляет собой библиотеку DLL, размещаемую в процессе VMM. После установки поставщика в консоли администратора VMM включается функция "Datacenter Recovery". Новые и существующие виртуальные машины могут включить эту функцию, чтобы задействовать защитить себя. | Если это свойство задано, поставщик отправляет имя и идентификатор виртуальной машины в службу Site Recovery. Репликация обеспечивается репликой Hyper-V Windows Server 2012 или Windows Server 2012 R2. Данные виртуальной машины реплицируются с одного узла Hyper-V на другой (как правило, он находится в другом центре обработки данных "восстановления"). | Служба Site Recovery использует метаданные для заполнения сведений о виртуальной машине на портале Azure. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения, не включайте защиту Site Recovery для виртуальных машин. Имейте ввиду, что все данные, отправляемые поставщиком в службу Site Recovery, передаются по протоколу HTTPS.
**План восстановления** | Планы восстановления помогают создать план оркестрации для центра обработки данных восстановления. Можно определить порядок запуска виртуальных машин или группы виртуальных машин на сайте восстановления. Кроме того, можно указать выполняемые автоматизированные сценарии или ручные действия во время восстановления для каждой виртуальной машины. Отработка отказа обычно активируется на уровне плана восстановления, чтобы восстановление было координированным. | Служба Site Recovery собирает, обрабатывает и передает метаданные плана восстановления, включая метаданные виртуальных машин, метаданные всех автоматизированных сценариев и заметки о выполняемых вручную действиях. | Эти метаданные используется для создания плана восстановления на портале Azure. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не создавайте планы восстановления.
**Сетевое сопоставление** | Эта функция позволяет сопоставить сведения о сети между первичным центром обработки данных и центром обработки данных восстановления. При восстановлении виртуальных машин на сайте восстановления сетевое сопоставление помогает установить сетевое подключение. | Служба Site Recovery собирает, обрабатывает и передает метаданные логических сетей для каждого сайта (первичного и центра обработки данных). | Эти метаданные используется для задания параметров сети, чтобы можно было сопоставить сведения о сети. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не используйте сетевое сопоставление.
**Отработка отказа (запланированная, незапланированная и тестовая)** | При отработке отказа виртуальные машины переходят из одного центра обработки данных в другой. Действие отработки отказа активируется вручную на портале Azure. | Поставщик на сервере VMM получает уведомление о событии отработки отказа от службы Site Recovery и выполняет действие отработки отказа на узле Hyper-V с помощью интерфейсов VMM. Фактически выполняется отработка отказа виртуальной машины с одного узла Hyper-V на другой. Для ее обработки используется реплика Hyper-V Windows Server 2012 или Windows Server 2012 R2. После отработки отказа поставщик на сервере VMM центра обработки данных восстановления отправляет сведения об успешном выполнении в службу Site Recovery. | Служба Site Recovery использует полученную информацию для заполнения состояния действия отработки отказа на портале Azure. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не используйте отработку отказа.


## Предварительные требования Azure

Для развертывания этого сценария вам потребуются следующие компоненты среды Azure.

**Предварительные требования** | **Дополнительные сведения** 
--- | ---
**Таблицы Azure**| Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [Узнайте больше](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. 


## Предварительные требования для локальной среды

Вот что потребуется на первичных и вторичных локальных сайтах для развертывания этого сценария.

**Предварительные требования** | **Дополнительные сведения** 
--- | ---
**VMM** | Рекомендуется развернуть по серверу VMM на первичном и вторичном сайтах.<br/><br/> Вы можете также [выполнять репликацию между облаками на одном сервере VMM](site-recovery-single-vmm.md). Для этого вам потребуется, чтобы на сервере VMM было настроено по крайней мере два облака.<br/><br/> На серверах VMM должен выполняться как минимум System Center 2012 с пакетом обновления 1 (SP1) с последними обновлениями.<br/><br/> Для каждого сервера VMM должно быть настроено одно или несколько облаков, и для каждого облака должен быть задан профиль загрузки Hyper-V. <br/><br/>Облака должны содержать одну или несколько групп узлов VMM.<br/><br/>Дополнительные сведения о настройке облаков VMM см. в разделах [Настройка структуры облака VMM](https://msdn.microsoft.com/library/azure/dn469075.aspx#BKMK_Fabric) и [Пошаговое руководство. Создание частных облаков с помощью VMM в System Center 2012 с пакетом обновления 1](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx).<br/><br/> Серверам VMM нужен доступ к Интернету. 
**Hyper-V** | Серверы Hyper-V должны работать под управлением Windows Server 2012 (или более поздних версий) с ролью Hyper-V и установленными последними обновлениями.<br/><br/> Сервер Hyper-V должен содержать одну или несколько виртуальных машин.<br/><br/> Серверы узлов Hyper-V должны быть размещены в первичном и вторичном облаках VMM.<br/><br/> Если Hyper-V выполняется в кластере на основе Windows Server 2012 R2, то необходимо установить [обновление 2961977](https://support.microsoft.com/kb/2961977)<br/><br/>. Если Hyper-V выполняется в кластере на основе Windows Server 2012, имейте ввиду, что брокер кластера не создается автоматически, если в кластере используются статические IP-адреса. Вам потребуется настроить брокер кластера вручную. [Подробная информация](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx).
**Поставщик** | Во время развертывания службы Site Recovery установите на серверы VMM поставщик Azure Site Recovery. Поставщик обменивается данными со службой Site Recovery через порт HTTPS 443 для управления репликацией. Репликация данных осуществляется между первичным и вторичным серверами Hyper-V через локальную сеть или VPN-подключение.<br/><br/> Поставщику, запущенному на сервере VMM, нужен доступ к следующим URL-адресам: *.hypervrecoverymanager.windowsazure.com; *.accesscontrol.windows.net; *.backup.windowsazure.com; *.blob.core.windows.net; *.store.core.windows.net.<br/><br/> Кроме того, разрешите в брандмауэре обмен данными между серверами VMM и [диапазонами IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653), а также разрешите использовать протокол HTTPS (443).

## Подготовка к развертыванию

Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Подготовить сервер VMM](#prepare-the-vmm-server) к развертыванию Site Recovery.
2. [Выполнить подготовку к сетевому сопоставлению](#prepare-for-network-mapping). Настройте сети, чтобы можно было настроить сетевое сопоставление.

### Подготовка сервера VMM

Убедитесь, что сервер VMM соответствует [предварительным требованиям](#on-premises-prerequisites) и имеет доступ к указанным URL-адресам.


### Подготовка к сопоставлению сетей

При сетевом сопоставлении сопоставляются сети виртуальных машин VMM первичного и вторичного серверов VMM. Вот для чего это делается:

- Оптимальное размещение виртуальных машин реплик на вторичных узлах Hyper-V после отработки отказа.
- Подключение виртуальных машин реплик к соответствующим сетям виртуальных машин.
- Если не настроить сетевое сопоставление, виртуальные машины реплик не будут подключены к каким-либо сетям после отработки отказа.
- Вот что понадобится, если вы хотите настроить сетевое сопоставление во время развертывания службы Site Recovery.

	- Виртуальные машины на сервере узла Hyper-V должны быть подключены к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
	- Проверьте, настроена соответствующая сеть виртуальной машины для вторичного облака, которое будет использоваться для восстановления. Эта сеть виртуальной машины должна быть связана с логической сетью, которая связана с вторичным облаком.

- [Узнайте больше](site-recovery-network-mapping.md) о принципе действия сетевого сопоставления.

## Подготовка к развертыванию с одним сервером VMM

При наличии только одного сервера VMM виртуальные машины на узлах Hyper-V в облаке VMM можно реплицировать в [Azure](site-recovery-vmm-to-azure.md) или во вторичное облако VMM. Мы рекомендуем первый вариант, так как репликация между облаками затруднительна, но если это необходимо, то вот что потребуется сделать.

1. **Настройте VMM на виртуальной машине Hyper-V**. При этом рекомендуется разместить экземпляр SQL Server, используемый VMM, на той же виртуальной машине. Это экономит время, так как требуется создать только одну виртуальную машину. Если вы хотите использовать удаленный экземпляр SQL Server, то в случае сбоя вам потребуется восстановить этот экземпляр перед восстановлением VMM.
2. **На каждом сервере VMM должно быть настроено по крайней мере два облака**. Одно облако будет содержать виртуальные машины, которые требуется реплицировать, а другое облако будет использоваться в качестве дополнительного расположения. Облако, содержащее виртуальные машины, которые необходимо защитить, должно соответствовать [предварительным требованиям](#on-premises-prerequisites).
3. Настройте Site Recovery, как описано в этой статье. Создайте и зарегистрируйте сервер VMM в хранилище, настройте политику репликации и включите репликацию. Следует указать, что начальная репликация осуществляется по сети.
4. После настройки сетевого сопоставления будет сопоставлена сеть виртуальной машины для первичного облака и сеть виртуальной машины для вторичного облака.
5. В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины. Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.
6. В случае создания планов восстановления для отработки отказа укажите один и тот же сервер VMM в качестве исходного и целевого.
7. Отработка отказа и восстановление выполняются следующим образом.

	- Выполните отработку отказа для реплики виртуальной машины VMM вручную на дополнительный сайт, используя диспетчер Hyper-V с плановой отработкой отказа.
	- Выполните отработку отказа виртуальных машин.
	- После восстановления первичной виртуальной машины VMM войдите на портал Azure, перейдите к хранилищу служб восстановления и выполните незапланированную отработку отказа для виртуальных машин с вторичного сайта на первичный сайт.
	- После завершения незапланированной отработки все ресурсы снова будут доступны на основном сайте.


### Создание хранилища служб восстановления

1. Войдите на [портал Azure](https://portal.azure.com).
2. Последовательно выберите **Создать** > **Управление** > **Службы восстановления**. Кроме того, можно щелкнуть **Обзор** > **Хранилища служб восстановления** > **Добавить**.

	![Новое хранилище](./media/site-recovery-vmm-to-vmm/new-vault3.png)

3. В поле **Имя** укажите понятное имя для идентификации хранилища. Если у вас есть несколько подписок, выберите одну из них.
4. [Создайте группу ресурсов](../resource-group-template-deploy-portal.md) или выберите уже имеющуюся и укажите регион Azure. В него будут реплицированы данные компьютеров. Чтобы проверить поддерживаемые регионы, см. географическую доступность в разделе [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/) (Информация о ценах на Azure Site Recovery).
4. Если нужно быстро получить доступ к хранилищу на панели мониторинга, щелкните **Закрепить на панели мониторинга** > **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-vmm-to-vmm/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.




## Приступая к работе

В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание как можно быстрее. Перед развертыванием проверяется соответствие предварительным требованиям. Кроме того, вы получаете указания для выполнения этапов развертывания в правильной последовательности.

Приступая к работе, необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Кроме того, требуется настроить локальные серверы, создать политики репликации и выполнить планирование загрузки. После настройки инфраструктуры включается репликация виртуальных машин. Можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.

## Шаг 1. Выбор цели для защиты

Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище и щелкните **Параметры**.
2. Выбрав **Параметры** > **Приступая к работе**, щелкните **Site Recovery** > **Step 1: Prepare Infrastructure** (Шаг 1. Подготовка инфраструктуры) > **Protection goal** (Цель защиты).
3. На странице **Protection goal** (Цель защиты) выберите **To recovery site** (На сайт восстановления) и **Yes, with Hyper-V** (Да, с помощью Hyper-V).
4. В соответствующем раскрывающемся списке выберите **Да**, чтобы указать, что вы используете VMM для управления узлами Hyper-V, и выберите **Да**, если используется вторичный сервер VMM. Если вы развертываете репликацию между облаками на одном сервере VMM, щелкните **Нет**. Нажмите кнопку **ОК**.

	![Выбор цели](./media/site-recovery-vmm-to-vmm/choose-goals.png)


## Шаг 2. Настройка исходной среды

Установите поставщик Azure Site Recovery на серверах VMM и зарегистрируйте их в хранилище.

1. Щелкните **Step 2: Prepare Infrastructure** (Шаг 1. Подготовка инфраструктуры) > **Источник**.

	![Настройка источника](./media/site-recovery-vmm-to-vmm/goals-source.png)

2. На странице **Prepare source** (Подготовка источника) щелкните **+ VMM**, чтобы добавить сервер VMM.

	![Настройка источника](./media/site-recovery-vmm-to-vmm/set-source1.png)

2. В колонке **Добавление сервера** убедитесь, что **сервер System Center VMM** появился в разделе **Тип сервера** и что он соответствует [предварительным требованиям и требованиям к URL-адресам](#on-premises-prerequisites).
4. Скачайте файл установки поставщика Azure Site Recovery.
5. Скачайте ключ регистрации. Он потребуется при запуске программы установки. Ключ действителен в течение 5 дней после создания.

	![Настройка источника](./media/site-recovery-vmm-to-vmm/set-source3.png)

6. Установите поставщик Azure Site Recovery на сервере VMM.

> [AZURE.NOTE] Не нужно ничего явно устанавливать на серверах узла Hyper-V.


### Настройка поставщика Azure Site Recovery

1. Запустите файл установки поставщика на каждом сервере VMM. Если развертывание VMM выполняется в кластере и вы устанавливаете поставщик впервые, установите его на активном узле и завершите установку, чтобы зарегистрировать сервер VMM в хранилище. Затем установите поставщик на других узлах. Узлы кластера должны использовать одинаковую версию поставщика.
2. Программа установки выполняет несколько проверок соответствия предварительным требованиям и запрашивает разрешение на остановку службы VMM. Служба VMM автоматически перезапустится после завершения установки. При установке в кластере VMM будет выдан запрос на остановку роли Cluster.

2.  На странице **Центр обновления Майкрософт** можно включить обновления, чтобы обновления поставщика устанавливались в соответствии с политикой Центра обновления Майкрософт.
3. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.

	![Расположение установки](./media/site-recovery-vmm-to-vmm/provider-location.png)

3. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

	![Расположение установки](./media/site-recovery-vmm-to-vmm/provider-register.png)

4. На странице **Параметры прокси-сервера** укажите, как запущенный на сервере VMM поставщик будет подключаться к Site Recovery через Интернет.

	- Чтобы поставщик подключался напрямую, установите переключатель **Connect directly without a proxy** (Прямое подключение без прокси-сервера).
	- - Чтобы подключаться с помощью прокси-сервера, который уже настроен на сервере, установите переключатель **Connect with existing proxy settings** (Подключение с параметрами имеющегося прокси-сервера).
	- Если для имеющегося прокси-сервера требуется проверка подлинности или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера).
	- При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
	- Если используется прокси-сервер, скорее всего, вы уже разрешили использовать URL-адреса, описанные в разделе [предварительных требований](#provider-and-agent-prerequisites).
	- При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM. В области **Параметры** разверните элементы **Безопасность** > **Учетные записи запуска от имени**, а затем измените пароль для учетной записи DRAProxyAccount. Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.

	![Интернет](./media/site-recovery-vmm-to-vmm/provider3.png)

4. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа. Укажите подписку Azure и имя хранилища.

	![Регистрация сервера](./media/site-recovery-vmm-to-vmm/provider-key2.png)

5. На странице **Регистрация** > **Расположение для сохранения сертификата** нажмите кнопку **Далее**. Сертификат для шифрования не важен в данном сценарии. Он используется только при репликации в службу хранилища Azure.

8. В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
9. Включите **синхронизацию метаданных в облаке**, если нужно синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM. Для завершения процесса нажмите кнопку **Далее**.

	![Регистрация сервера](./media/site-recovery-vmm-to-vmm/provider-sync.png)

10. Начнется процедура регистрации. После ее завершения сервер VMM появится в колонке **Параметры** > **Серверы** в хранилище.
11. После появления сервера в консоли Site Recovery на странице **Источник** > **Prepare source** (Подготовка источника) выберите сервер VMM и облако, в котором расположен узел Hyper-V. Нажмите кнопку **ОК**.

#### Установка из командной строки

Поставщик Azure Site Recovery можно установить с помощью командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\\ASR.
2. Остановите службу System Center Virtual Machine Manager.
3. В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. Выполните следующую команду для установки поставщика.

    	C:\ASR> setupdr.exe /i

5. Затем выполните следующие команды для регистрации сервера в хранилище:

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>     

Используются следующие параметры:

 - **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.
 - **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
 - **/EncryptionEnabled**: необязательный параметр, который используется только при репликации из VMM в Azure.
 - **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
 - **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
 - **/proxyusername**: необязательный параметр, указывающий имя пользователя прокси-сервера (если прокси-сервер требует выполнения проверки подлинности).
 - **/proxypassword**: необязательный параметр, который указывает пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует выполнения проверки подлинности).

## Шаг 3. Настройка целевой среды

Выберите целевой сервер VMM и облако.

1. Щелкните **Prepare infrastructure** (Подготовка инфраструктуры) > **Целевой объект** и выберите требуемый целевой сервер VMM.
2.	Отобразятся облака на сервере, которые синхронизируются с использованием Site Recovery. Выберите целевое облако.

	![Цель](./media/site-recovery-vmm-to-vmm/target-vmm.png)

## Этап 4. Настройка параметров репликации

1. Чтобы создать политику репликации, последовательно выберите **Prepare infrastructure** (Подготовка инфраструктуры) > **Параметры репликации** > **+Create and associate** (+Создание и сопоставление).

	![Сеть](./media/site-recovery-vmm-to-vmm/gs-replication.png)

2. На странице **Create and associate policy** (Политика создания и сопоставления) укажите имя политики. Исходным и целевым типами должен быть **Hyper-V**.
3. В раскрывающемся списке **Версия узла Hyper-V** выберите, какая операционная система выполняется на узле.

	> [AZURE.NOTE] Облако VMM может содержать узлы Hyper-V под управлением разных версий Windows Server (поддерживаемых), но политика репликации применяется к узлам с одинаковой операционной системой. Если у вас есть узлы с несколькими операционными системами, создайте отдельные политики репликации.

4. Используя раскрывающиеся списки **Тип проверки подлинности** и **Порт для проверки подлинности**, укажите, как аутентифицируется трафик между первичными серверами узла Hyper-V и серверами узла восстановления Hyper-V. Выберите **Сертификат**, если только не используете настроенную рабочую среду Kerberos. Azure Site Recovery автоматически настроит сертификаты для аутентификации HTTPS. Не нужно ничего делать вручную. По умолчанию порт 8083 и 8084 (для сертификатов) будет открыт в брандмауэре Windows на серверах узлов Hyper-V. Если выбрать **Kerberos**, то для взаимной аутентификации серверов узла будет использоваться билет Kerberos. Обратите внимание, что этот параметр используется только при запуске серверов узлов Hyper-V в Windows Server 2012 R2.
3. В раскрывающемся списке **Частота копирования** выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
6. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, насколько часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями (от 1 до 12 часов). Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.
7. В разделе **Сжатие данных при передаче** укажите, требуется ли сжимать передаваемые реплицируемые данные.
8. Выберите для параметра **Удалить виртуальную машину реплики** значение "Да", чтобы указать, что при отключении защиты для исходной виртуальной машины виртуальную машину реплики нужно удалить. Если включить этот параметр, то при отключении защиты для исходной виртуальной машины она удаляется из консоли Site Recovery, параметры Site Recovery для VMM удаляются из консоли VMM, также удаляется реплика.
3. В случае репликации по сети укажите в разделе **Метод начальной репликации**, следует ли запустить начальную репликацию или запланировать ее. Чтобы сэкономить пропускную способность сети, вы можете запланировать ее вне периодов максимальной нагрузки. Нажмите кнопку **ОК**.

	![Политика репликации](./media/site-recovery-vmm-to-vmm/gs-replication2.png)

6. При создании политики она автоматически сопоставляется с облаком VMM. В разделе **Политика репликации** щелкните **ОК**. С этой политикой репликации можно сопоставить дополнительные облака VMM (и виртуальные машины, содержащиеся в них). Для этого последовательно выберите **Параметры** > **Репликация** > имя политики > **Associate VMM Cloud** (Сопоставить облако VMM).

	![Политика репликации](./media/site-recovery-vmm-to-vmm/policy-associate.png)

### Подготовка к начальной репликации в автономном режиме

Можно выполнить репликацию в автономном режиме для начальной копии данных. К ней можно подготовиться следующим образом.

- На исходном сервере потребуется задать расположение пути, по которому будет выполняться экспорт данных. Назначьте уровень "Полный доступ" для службы NTFS и разрешения "Общий доступ" для службы VMM для пути экспорта. На исходном сервере потребуется задать расположение пути, по которому будет выполняться импорт данных. Назначьте те же разрешения для этого пути импорта.
- Если путь импорта или экспорта используется совместно, назначьте учетной записи службы VMM на удаленном компьютере с общей папкой членство в группах "Администратор", "Опытный пользователь", "Оператор печати" или "Оператор сервера".
- Если вы используете любые учетные записи запуска от имени для добавления узлов, назначьте в VMM для учетных записей запуска от имени разрешения на чтение и запись для путей импорта и экспорта.
- Общие папки импорта и экспорта нельзя размещать на компьютерах, используемых в качестве серверов узлов Hyper-V, так как конфигурация замыкания на себя не поддерживается Hyper-V.
- В Active Directory для каждого сервера узла Hyper-V, содержащего защищаемые виртуальные машины, включите и настройте ограниченное делегирование для настройки отношений доверия с удаленными компьютерами, на которых размещаются пути экспорта и импорта, следующим образом.
	1. На контроллере домена откройте средство **Пользователи и компьютеры Active Directory**.
	2. В дереве консоли щелкните **Имя\_домена** > **Компьютеры**.
	3. Щелкните имя сервера узла Hyper-V правой кнопкой мыши и выберите пункт **Свойства**.
	4. На вкладке **Делегирование** установите флажок **Trust this computer for delegation to specified services only** (Доверять компьютеру делегирование указанных служб).
	5. Установите флажок **Использовать любой протокол проверки подлинности**.
	6. Щелкните **Добавить** > **Пользователи и компьютеры**.
	7. Введите имя компьютера, на котором размещается путь экспорта, и нажмите кнопку **ОК**. В списке доступных служб, нажав и удерживая клавишу CTRL, щелкните **CIFS** и нажмите кнопку **ОК**. Повторите процедуру для имени компьютера, на котором размещается путь импорта. При необходимости повторите процедуру для дополнительных серверов узлов Hyper-V.


### Настройка сетевого сопоставления

Настройте сетевое сопоставление между исходной и целевой сетями.

- [Прочтите](#prepare-for-network-mapping) краткий обзор о сетевом сопоставлении. Дополнительно [прочитайте](site-recovery-network-mapping.md) более подробное пояснение.
- Проверьте, подключены ли виртуальные машины на серверах VMM к сети виртуальной машины.

Настройте сопоставление следующим образом:

1. Выберите **Параметры** > **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Сетевое сопоставление** > **Сетевые сопоставления** и щелкните **+Network Mapping** (+Сетевое сопоставление).

	![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping1.png)

2. На вкладке **Добавление сетевого сопоставления** выберите исходный и целевой серверы VMM. Будут получены сети виртуальных машин, связанные с серверами VMM.
3. В разделе **Исходная сеть** в списке сетей виртуальных машин, связанных с первичным сервером VMM, выберите нужную сеть.
6. В разделе **Целевая сеть** выберите сеть, которую вы хотите использовать на вторичном сервере VMM. Нажмите кнопку **ОК**.

	![Сетевое сопоставление](./media/site-recovery-vmm-to-vmm/network-mapping2.png)

Когда начинается сопоставление сетей, происходит следующее:

- Все существующие виртуальные машины реплик, соответствующие исходной сети виртуальной машины, будут подключены к целевой сети виртуальной машины.
- Новые виртуальные машины, подключенные к исходной сети виртуальной машины, будут подключены к целевой сопоставленной сети после репликации.
- Если изменить существующее сопоставление, указав новую сеть, реплики виртуальных машин будут подключаться с новыми параметрами.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины будет подключена к этой целевой подсети после отработки отказа. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.

## Шаг 5. Планирование ресурсов

Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

Site Recovery предоставляет планировщик ресурсов на основе Excel, который поможет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

- Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
- Оцените частоту ежедневных изменений (обновлений) реплицированной разницы данных. Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057).

1.	Щелкните ссылку **Скачать**, чтобы скачать это средство, и запустите его. Сведения о планировщике ресурсов см. в [этой статье](site-recovery-capacity-planner.md).
2.	После этого выберите **Да** в поле **Have you run the Capacity Planner?** (Вы запустили планировщик ресурсов?).

	![Планирование загрузки](./media/site-recovery-vmm-to-azure/gs-capacity-planning.png)

### Управление пропускной способностью

После сбора данных дельта-репликации в режиме реального времени с помощью реплики Hyper-V планировщика ресурсов планировщик ресурсов на основе Excel помогает рассчитать пропускную способность, необходимую для репликации (начальную и изменение). Для управления пропускной способностью, используемой для репликации, можно настроить политику NetQoS с помощью групповой политики или Windows PowerShell. Это можно сделать несколькими способами.

**PowerShell** | **Дополнительные сведения**
--- | ---
**New -NetQosPolicy "QoS to destination subnet"** | Регулирование трафика, передаваемого от узла Hyper-V под управлением Windows Server 2012 R2 во вторичную подсеть. Используйте, если первичная и вторичная подсети отличаются.
**New -NetQosPolicy "QoS to destination port"** | Регулирование трафика, передаваемого от узла Hyper-V под управлением Windows Server 2012 R2 в порт назначения.
**New -NetQosPolicy "Throttle traffic from VMM"** | Регулирование трафика от vmms.exe. Таким образом будет регулироваться трафик Hyper-V и трафик динамической миграции. Для уточнения можно сопоставить IP-протоколы и порты.

Можно использовать параметры веса пропускной способности или ограничить трафик битами для вторичных подсетей. Если вы используете кластер, это нужно будет сделать на всех узлах кластера. Дополнительные сведения см. в разделах:


- Блог Томаса Маурера (Thomas Maurer) о [регулировании трафика реплик Hyper-V](http://www.thomasmaurer.ch/2013/12/throttling-hyper-v-replica-traffic/).
- Дополнительные сведения о [командлете New-NetQosPolicy](https://technet.microsoft.com/library/hh967468.aspx).


## Шаг 6. Включение репликации 

Включите репликацию следующим образом:

1. Последовательно выберите **Step 2: Replicate application** (Шаг 2. Репликация приложения) > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+Реплицировать) в хранилище, чтобы включить репликацию для дополнительных компьютеров.

	![Включение репликации](./media/site-recovery-vmm-to-vmm/enable-replication1.png)

2. В колонке **Источник** выберите сервер VMM и облако, в котором размещены узлы Hyper-V, которые вы хотите реплицировать. Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-vmm-to-vmm/enable-replication2.png)

3. В колонке **Целевой объект** проверьте вторичный сервер VMM и облако.
4. На странице **Виртуальные машины** в списке выберите виртуальные машины, которые необходимо защитить.

	![Включение защиты виртуальной машины](./media/site-recovery-vmm-to-vmm/enable-replication5.png)

Ход выполнения задания **включения защиты** можно отслеживать на странице заданий ("Параметры" > **Задания** > **Site Recovery jobs** (Задания Site Recovery)). После запуска задания **финализации защиты** виртуальная машина готова к отработке отказа.


>[AZURE.NOTE] Защиту для виртуальных машин также можно включить в консоли VMM. На панели инструментов на вкладке **Azure Site Recovery** в свойствах виртуальной машины щелкните **Включить защиту**.

После включения репликации можно просмотреть свойства виртуальной машины, щелкнув **Параметры** > **Реплицированные элементы** и выбрав имя виртуальной машины. На панели мониторинга **Основное** можно просмотреть информацию о политике репликации для виртуальной машины и ее состоянии. Щелкните **Свойства** для получения дополнительных сведений.

### Размещение существующих виртуальных машин

При наличии виртуальных машин в VMM, которые реплицируются с помощью реплики Hyper-V, их потребуется разместить для защиты Azure Site Recovery следующим образом.

1. Убедитесь, что сервер Hyper-V, на котором размещаются существующие виртуальные машины, расположен в первичном облаке, а сервер Hyper-V, на котором размещается виртуальная машина реплики, расположен во вторичном облаке.
2. Убедитесь, что для первичного облака VMM настроена политика репликации.
2. Включите защиту для первичной виртуальной машины. Azure Site Recovery и VMM обеспечат обнаружение узла и виртуальной машины одной и той же реплики, а Azure Site Recovery повторно использует и установит репликацию, используя указанные параметры.


## Шаг 7. Тестирование развертывания

Чтобы протестировать развертывание, можно выполнить тестовую отработку отказа для одной виртуальной машины или создать план восстановления, содержащий один или несколько виртуальных машин.

### Подготовка к отработке отказа

- Для полного тестирования развертывания требуется, чтобы инфраструктура для реплицируемого компьютера работала должным образом. Если нужно протестировать Active Directory и DNS, можно создать виртуальную машину в качестве контроллера домена с помощью DNS и реплицировать ее в Azure с помощью службы Azure Site Recovery. См. дополнительные сведения в статье с [рекомендациями по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).
- В этой статье описывается, как выполнить тестовую отработку отказа без подключения к сети. При таком сценарии будет проверена отработка отказа виртуальной машины, но не будут проверены ее параметры сети. [Узнайте больше](site-recovery-failover.md#run-a-test-failover) о других параметрах.
- Если нужно выполнить внеплановую отработку отказа вместо тестовой, обратите внимание на следующее:

	- По возможности перед выполнением внеплановой отработки отказа следует выключить основные компьютеры. В этом случае исходные и реплицированные компьютеры не будут работать одновременно.
	- При выполнении внеплановой отработки отказа репликация данных с основных компьютеров прекращается. Поэтому после начала внеплановой отработки отказа все изменения в данных не будут передаваться. Кроме того, при выполнении внеплановой отработки отказа в рамках плана восстановления она завершится даже в случае ошибки.




### Запуск тестовой отработки отказа

1. Чтобы выполнить отработку отказа для одной виртуальной машины, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину и **+Test Failover** (+Тестовая отработка отказа).

	![Тестовая отработка отказа](./media/site-recovery-vmm-to-vmm/test-failover.png)

2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите пункт **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти указания](site-recovery-create-recovery-plans.md).
2. В окне **Тестовая отработка отказа** щелкните **Нет**. Так вы проверите, должным ли образом работает ли отработка отказа виртуальной машины, но реплицированная виртуальная машины не будет подключена к сети.

	![Тестовая отработка отказа](./media/site-recovery-vmm-to-vmm/test-failover1.png)

3. Нажмите кнопку **ОК**, чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа**, выбрав **Параметры** > **Задания** > **Site Recovery jobs** (Задания Site Recovery).
4. После того, как задание отработки отказа достигнет фазы **Полное тестирование**, сделайте следующее:

	-  Просмотрите виртуальную машину реплики на вторичном облаке VMM.
	-  Щелкните **Complete the test** (Завершить проверку), чтобы завершить тестовую отработку отказа.
	-  Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.

5. Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она добавляется в то же облако, в котором находится реплика виртуальной машины.
6. Убедившись, что виртуальные машины успешно запускаются, щелкните **Тестовая отработка отказа завершена**. На этом этапе любые элементы, автоматически созданные Site Recovery во время тестовой отработки отказа, удаляются.

	> [AZURE.NOTE] Если отработка отказа выполняется более двух недель, она завершается принудительно.



### Указание в DNS нового IP-адреса виртуальной машины реплики

После отработки отказа у виртуальной машины реплики может быть IP-адрес не как у первичной виртуальной машины.

- Виртуальные машины обновят используемый DNS-сервер после запуска.
- Можно также вручную обновить DNS следующим образом.

#### Получение IP-адреса

Запустите пример скрипта для получения IP-адреса.

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

#### Обновление DNS

Запустите пример скрипта для обновления DNS, указав IP-адрес, полученный с помощью предыдущего примера скрипта.

		string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

## Дальнейшие действия

Настроив и запустив развертывание, прочитайте [дополнительные сведения](site-recovery-failover.md) о различных типах обработки отказа.

<!---HONumber=AcomDC_0720_2016-->