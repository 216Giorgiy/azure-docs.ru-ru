---
title: "Восстановление размещения из Azure в Hyper-V | Документация Майкрософт"
description: "После отработки отказа виртуальных машин в Azure можно инициировать восстановление размещения, чтобы вернуть их в локальную среду. Узнайте, как выполнить восстановление размещения."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: bedb59414ed328fe2fcca2b09f3360a98c98ff60
ms.openlocfilehash: b4bdd27db343bfb4a0e47c432f726ff454f7f55a
ms.lasthandoff: 02/23/2017


---
# <a name="failback-from-azure-to-on-premises"></a>Восстановление размещения из Azure в локальную среду
В этой статье описывается, как восстановить размещение виртуальных машин Azure на локальном сайте с переносом из Azure. Когда вы будете готовы к восстановлению размещения виртуальных машин VMware или физических серверов Windows и Linux, для которых была выполнена отработка отказа с локального сайта в Azure, следуйте инструкциям, изложенным в этом [руководстве](site-recovery-vmware-to-azure-classic.md).

## <a name="overview-of-failback"></a>Общие сведения о восстановлении размещения
Восстановление размещения на локальный сайт после отработки отказа с переносом в Azure происходит в несколько этапов.

1. [Повторно включите защиту](site-recovery-how-to-reprotect.md) виртуальных машин Azure, чтобы начать их репликацию в виртуальные машины VMware, запущенные на локальном сайте. Для этого необходимо также: 
    1. Настройте главный целевой сервер: сервер Windows для виртуальных машин Windows и [сервер Linux](site-recovery-how-to-install-linux-master-target.md) для виртуальных машин Linux
    2. Настройте [сервер обработки](site-recovery-vmware-setup-azure-ps-resource-manager.md).
    3. Затем [повторно включите защиту](site-recovery-how-to-reprotect.md).
5. После репликации виртуальных машин Azure на локальный сайт выполните отработку отказа с переносом из Azure в локальную среду.
  
После восстановления размещения данных повторно включите защиту локальных виртуальных машин, на которые выполнено восстановление размещения, чтобы начать их репликацию в Azure.

Ниже представлено видео с коротким обзором.
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

### <a name="failback-to-the-original-or-alternate-location"></a>Восстановление размещения в исходном или дополнительном расположении
    
При отработке отказа виртуальной машины VMware восстановление размещения можно выполнить на той же исходной виртуальной машине, если она по-прежнему доступна локально. В этом случае будет выполнена репликация только изменившихся данных. Этот сценарий называется восстановлением в исходном расположении. Если локальная виртуальная машина не существует, восстановление выполняется в другое расположение.

#### <a name="original-location-recovery"></a>Восстановление в исходное расположение

Для восстановления размещения на исходной виртуальной машине должны быть выполнены следующие условия.
* Если виртуальной машиной управляет сервер vCenter, то узел ESX главного целевого сервера должен иметь доступ к хранилищу данных виртуальных машин.
* Если виртуальная машина находится на узле ESX, но не управляется с помощью vCenter, жесткий диск виртуальной машины должен находиться в хранилище данных, доступном узлу главного целевого сервера.
* Если виртуальная машина находится на узле ESX и не использует vCenter, прежде чем повторно включить защиту, следует выполнить обнаружение узла ESX главного целевого сервера. Это применимо, если выполняется восстановление размещения и для физических серверов.
* Вы можете выполнить восстановление размещения на диски vSAN или RDM, если они существуют и подключены к локальной виртуальной машине.

#### <a name="alternate-location-recovery"></a>Восстановление в другое расположение
Если локальная виртуальная машина не существует на момент повторного включения защиты виртуальной машины, это называется восстановлением в альтернативном расположении. В этом случае рабочий процесс повторной защиты воссоздает локальную виртуальную машину. Это также приведет к скачиванию всех данных.

* Если восстановление размещения выполняется в альтернативном расположении, то виртуальная машина будет восстановлена на том же узле ESX, на котором размещен главный целевой сервер. Для создания диска будет использовано хранилище данных, выбранное при повторном включении защиты виртуальной машины.
* Восстановление размещения возможно только в хранилище данных VMFS. При наличии vSAN или RDM повторно включить защиту и восстановить размещение не удастся.
* При повторном включении защиты выполняется одна первоначальная передача большого объема данных, за которой следует передача изменившихся данных. Это обусловлено тем, что виртуальная машина не существует в локальной среде и обратно должен реплицироваться полный набор данных. Такое повторное включение защиты также занимает больше времени, чем восстановление в исходном расположении.
* Восстановление размещения нельзя выполнить на диски vSAN или RDM. В хранилище данных VMFS можно создавать только диски VMDK.

Если выполнена отработка отказа физического компьютера в Azure, то восстановить его размещение можно только в качестве виртуальной машины VMware (т. н. рабочий процесс P2A2V). Эта последовательность относится к восстановлению в альтернативном расположении.

* Если защищенный компьютер под управлением Windows Server 2008 R2 SP1 выполнил отработку отказа в Azure, он не будет восстановлен в исходном расположении;
* Убедитесь, что у вас есть хотя бы один главный целевой сервер и необходимые узлы ESX/ESXi, на которых необходимо восстановить размещение после сбоя.

## <a name="have-you-completed-reprotection"></a>Вы включили повторно защиту?
Прежде чем продолжить, включите повторно защиту, чтобы запустить репликацию виртуальных машин и чтобы вы могли инициировать отработку отказа обратно в локальную среду.
См. статью о [повторном включении защиты из Azure в локальную среду](site-recovery-how-to-reprotect.md).

## <a name="pre-requisites"></a>Предварительные требования
 
* При восстановлении размещения сервер конфигурации должен быть в локальной среде. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации, в противном случае восстановление не будет успешным. Таким образом, необходимо обеспечить регулярное плановое резервное копирование сервера. В случае аварии потребуется восстановить сервер с тем же IP-адресом, чтобы обеспечить работу восстановления размещения.
* На главном целевом сервере не должно быть моментальных снимков перед запуском восстановления размещения.

## <a name="steps-to-failback"></a>Инструкции по восстановлению размещения

Прежде чем начать восстановление размещения, **убедитесь, что вы выполнили повторное включение защиты виртуальных машин**. Виртуальные машины должны быть работоспособными и защищенными. Чтобы повторно включить защиту виртуальных машин, узнайте больше о[повторном включении защиты](site-recovery-how-to-reprotect.md).

1. На странице реплицированных элементов выберите виртуальную машину, щелкните ее правой кнопкой мыши и выберите **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (из Azure) и выберите точку восстановления, до которой будет выполняться отработка отказа (последняя или связанная с последним запущенным приложением). Точка с согласованием приложений будет следовать за последней точкой во времени, что приведет к потере некоторых данных.
3. Во время отработки отказа Site Recovery завершит работу виртуальных машин Azure. Если восстановление размещения выполнено правильно, вы можете убедиться, что работа виртуальных машин Azure завершена.

### <a name="to-what-recovery-point-can-i-failback-the-vms-to"></a>До какой точки можно восстановить размещение виртуальных машин?

Вы можете выполнить восстановление размещения виртуальной машины или план восстановления двумя способами.

Если выбрать последнюю обработанную точку во времени, для всех виртуальных машин будет выполнена отработка отказа до последней доступной точки во времени. Если в плане восстановления есть группа репликации, для каждой виртуальной машины в группе будет выполнена отработка отказа до ее собственной последней точки во времени.

Нельзя восстановить размещение виртуальной машины, если у нее нет хотя бы одной точки восстановления. Нельзя восстановить размещение плана восстановления, если каждая из его виртуальных машин не содержит хотя бы одну точку восстановления.

> [!NOTE]
> Последняя точка восстановления является согласованной точкой восстановления после сбоя.

Если выбрать согласованную точку восстановления приложения, восстановление размещения одной виртуальной машины будет выполнено до последней доступной согласованной точки в приложении. Если выполняется план восстановления для группы репликации, восстановление будет выполнено до общей доступной точки восстановления.
Обратите внимание, что согласованные точки восстановления приложения могут быть позднее по времени. Из-за этого может произойти потеря данных.

## <a name="next-steps"></a>Дальнейшие действия

Когда восстановление размещения будет завершено, вам нужно будет восстановить виртуальную машину, чтобы обеспечить фиксацию виртуальных машин, восстановленных в Azure.

### <a name="commit"></a>Фиксация
Чтобы удалить из Azure виртуальную машину, для которой выполнена отработка отказа, необходимо выполнить фиксацию.
Щелкните защищенный элемент правой кнопкой мыши и выберите "Применить". Будет запущено задание, которое удалит из Azure виртуальные машины, для которых была выполнена отработка отказа.

### <a name="reprotect-from-on-premises-to-azure"></a>Повторное включение защиты из локальной среды в Azure

После завершения фиксации виртуальные машины будут возвращены на локальный сайт, но не будут защищены. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее:

1. В разделе "Хранилище" > "Настройка" > "Реплицированные элементы" выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**.
2. Укажите сервер обработки, который необходимо использовать для отправки данных обратно в Azure.
3. Нажмите кнопку "ОК", чтобы запустить восстановление защиты.

> [!NOTE]
> После загрузки виртуальной машины в локальной среде для повторной регистрации агента на сервере конфигурации потребуется некоторое время (не более 15 минут). Если включить повторную защиту в течение этого времени, произойдет сбой, и на экране отобразится сообщение о том, что агент не установлен. Подождите несколько минут, а затем включите повторную защиту еще раз.

Когда защита будет повторно включена, виртуальная машина снова начнет реплицироваться в Azure, и вы сможете выполнять отработку отказа.

## <a name="common-issues"></a>Распространенные проблемы
* Убедитесь, что vCenter находится в подключенном состоянии перед восстановлением размещения, иначе вы не сможете отключить диски и подключить их обратно к виртуальной машине.


