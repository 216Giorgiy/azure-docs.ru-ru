---
title: Архитектура репликации из VMware в Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин VMware из локальной среды в Azure с помощью Azure Site Recovery.
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 06/20/2018
ms.author: raynew
ms.openlocfilehash: 61c283c178936c98a9a18509c1b46035e48f8f24
ms.sourcegitcommit: d8ffb4a8cef3c6df8ab049a4540fc5e0fa7476ba
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2018
ms.locfileid: "36285276"
---
# <a name="vmware-to-azure-replication-architecture"></a>Архитектура репликации из VMware в Azure

В этой статье описаны архитектура и процессы, используемые при репликации, отработке отказа и восстановлении виртуальных машин VMware между локальным сайтом VMware и Azure с помощью [Azure Site Recovery](site-recovery-overview.md).


## <a name="architectural-components"></a>Компоненты архитектуры

Таблица и рисунок ниже позволяют получить общее представление о компонентах, используемых для репликации VMware в Azure.

**Компонент** | **Требование** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | An Azure subscription, Azure Storage account, and Azure network. | Реплицированные данные из локальных ВМ хранятся в учетной записи хранения. Виртуальные машины Azure создаются с использованием реплицированных данных при запуске отработки отказа из локальной среды в Azure. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Компьютер сервера конфигурации** | Отдельный локальный компьютер. Мы рекомендуем использовать виртуальную машину VMware, которую можно развернуть с помощью скачанного шаблона в формате OVF.<br/><br/> На этой машине выполняются все локальные компоненты Site Recovery, включая сервер конфигурации, сервер обработки и главный целевой сервер. | **Сервер конфигурации** используется для управления обменом данными между локальной средой и Azure, а также репликацией данных.<br/><br/> **Сервер обработки** по умолчанию устанавливается на сервере конфигурации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service Azure Site Recovery на виртуальные машины, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных компьютеров. По мере увеличения масштаба развертывания вы можете добавлять дополнительные отдельные серверы для обработки растущего объема данных репликации.<br/><br/> **Главный целевой сервер** по умолчанию устанавливается на сервере конфигурации. Он обрабатывает данные репликации при восстановлении размещения из Azure. Для крупных развертываний вы можете добавить отдельный главный целевой сервер для восстановления размещения.
**Серверы VMware** | Виртуальные машины VMware размещаются на локальных серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | При развертывании Site Recovery добавьте серверы VMware в хранилище служб восстановления.
**Реплицируемые компьютеры** | Служба Mobility Service устанавливается на каждой реплицируемой виртуальной машине VMware. | Рекомендуем разрешить автоматическую установку с сервера обработки. Кроме того, вы можете установить службу вручную или использовать средство автоматического развертывания, такое как System Center Configuration Manager.

**Архитектура: VMware — Azure**

![Компоненты](./media/vmware-azure-architecture/arch-enhanced.png)

## <a name="configuration-steps"></a>Этапы настройки

Ниже приведены общие действия по настройке VMware для аварийного восстановления или миграции Azure.

1. **Настройка компонентов Azure**. Требуется учетная запись Azure с соответствующими разрешениями, учетная запись хранения Azure, виртуальная сеть Azure и хранилище служб восстановления. [Узнайте больше](tutorial-prepare-azure.md).
2. **Настройка локальной среды**. Сюда входит настройка учетной записи на сервере VMware для того, чтобы служба Site Recovery могла автоматически обнаруживать виртуальные машины для репликации, а также настройка учетной записи, которая может использоваться для установки компонента службы Mobility Service на виртуальных машинах, которые требуется реплицировать, и проверка соответствия серверов и виртуальных машин VMware предварительным требованиям. Также при необходимости можно подготовить подключение к этим виртуальным машинам Azure после отработки отказа. Site Recovery реплицирует данные виртуальных машин в учетную запись хранения Azure и создает виртуальные машины Azure с помощью этих данных при выполнении отработки отказа в Azure. [Узнайте больше](vmware-azure-tutorial-prepare-on-premises.md).
3. **Настройка репликации**. Можно выбрать цель для репликации. Исходную среду репликации можно настроить с помощью настройки отдельной локальной виртуальной машины VMware (сервера конфигурации), на которой выполняются все требуемые локальные компоненты Site Recovery. После настройки сервер конфигурации следует зарегистрировать в хранилище служб восстановления. Затем следует выбрать целевые параметры. [Узнайте больше](vmware-azure-tutorial.md).
4. **Создание политики репликации**. Следует создать политику репликации, указывающую, как должна осуществляться репликация. 
    - **RPO threshold** (Пороговое значение RPO). Этот параметр мониторинга указывает, что, если репликация не была выполнена в течение указанного времени, то отправляется оповещение (и, при необходимости, сообщение электронной почты). Например, если задать пороговое значение RPO, равно 30 минутам, и какая-либо проблема мешала выполнить репликацию в течение 30 минут, то будет создано событие. Этот параметр не влияет на репликацию. Репликация осуществляется непрерывно, и точки восстановления создаются каждые несколько минут.
    - **Retention** (Хранение). Срок хранения точек восстановления определяет, как долго они должны храниться в Azure. Можно указать значение в диапазоне от 0 до 24 часов для хранилища уровня "Премиум" или до 72 часов для хранилища уровня "Стандартный". Если задано значение больше нуля, вы можете выполнить отработку отказа до последней точки восстановления или до какой-либо хранимой точки. По истечении периода хранения точки восстановления удаляются.
    - **Crash-consistent snapshots** (Отказоустойчивые моментальные снимки). По умолчанию Site Recovery принимает отказоустойчивые моментальные снимки и создает точки восстановления с ними каждые несколько минут. Точка восстановления является отказоустойчивой, если все взаимосвязанные компоненты данных записаны в согласованном порядке, в котором они были на момент создания точки восстановления. Чтобы лучше понять это, представьте состояние данных на жестком диске компьютера после отключения питания или аналогичного события. Отказоустойчивой точки восстановления обычно достаточно, если ваше приложение позволяет восстанавливать данные после сбоя, избегая их несогласованности.
    - **App-consistent snapshots** (Согласованные с приложениями моментальные снимки). Если это значение не равно нулю, служба Mobility Service, запущенная на виртуальной машине, пытается создавать согласованные с файловой системой моментальные снимки и точки восстановления. Первый моментальный снимок создается после завершения начальной репликации. После этого моментальные снимки создаются с указанной частотой. Точка восстановления является согласованной с приложениями, если помимо согласованного порядка записи выполняемые приложения завершили все свои операции и освободили свои буферы на диск (т. е. приложения были заморожены). Согласованные с приложениями точки восстановления рекомендуется использовать для приложений баз данных, например SQL, Oracle и Exchange. Если достаточно использовать отказоустойчивый моментальный снимок, этому параметру можно присвоить значение 0.  
    - **Multi-VM consistency** (Согласованность нескольких виртуальных машин). При необходимости можно создать группу репликации. Затем при включении репликации вы можете объединить виртуальные машины в эту группу. Виртуальные машины в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные с приложениями точки восстановления после отработки отказа. Этот параметр следует использовать осторожно, так как он может повлиять на производительность рабочей нагрузки, ведь моментальные снимки должны создаваться для нескольких компьютеров. Используйте его, только если на виртуальных машинах выполняется одинаковая рабочая нагрузка и требуется согласование, и данные на виртуальных машинах обновляются с одинаковой частотой. В группу можно добавить до 8 виртуальных машин. 
5. **Включение репликации виртуальных машин**. Наконец, следует включить репликацию локальных виртуальных машин VMware. Если вы создали учетную запись для установки службы Mobility Service и указали, что службе Site Recovery необходимо выполнить принудительную установку, то служба Mobility Service будет установлена на каждую виртуальную машину, для которой включена репликация. [Узнайте больше](vmware-azure-tutorial.md#enable-replication). Если вы создали группу репликации, чтобы обеспечить согласованность нескольких виртуальных машин, то можете добавить виртуальные машины в эту группу.
6. **Тестирование отработки отказа**. После настройки всех компонентов можно выполнить тестовую отработку отказа, чтобы проверить, выполняется ли отработка отказа виртуальных машин в Azure должным образом. [Узнайте больше](tutorial-dr-drill-azure.md).
7. **Отработка отказа**. Если вы просто переносите виртуальные машины в Azure, то можете для этого выполнить отработку отказа. Если вы настраиваете аварийное восстановление, то, если требуется, можете выполнить полную отработку отказа. Чтобы выполнить полное аварийное восстановление после отработки отказа в Azure, можно выполнить восстановление размещения на свой локальный сайт, как только он станет доступным. [Узнайте больше](vmware-azure-tutorial-failover-failback.md).

## <a name="replication-process"></a>Процесс репликации

1. При включении репликации для виртуальной машины начинается ее репликация в соответствии с политикой репликации. 
2. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#azure-public-peering) Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.
3. Начальная копия данных виртуальной машины реплицируется в службу хранилища Azure.
4. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
5. Обмен данными происходит следующим образом.

    - Виртуальные машины обмениваются данными с локальным сервером конфигурации через HTTPS-порт 443 для входящих подключений, чтобы управлять репликацией.
    - Сервер конфигурации выполняет оркестрацию репликации в Azure через HTTPS-порт 443 для исходящих подключений.
    - Виртуальные машины отправляют данные репликации на сервер обработки (запущенный на компьютере сервера конфигурации) через HTTPS-порт 9443 для входящих подключений. Этот порт можно изменить.
    - Сервер обработки получает данные репликации, оптимизирует и шифрует их, а затем отправляет в службу хранилища Azure через порт 443 для исходящих подключений.


**Процедура репликации VMware в Azure**

![Процесс репликации](./media/vmware-azure-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

Настроив репликацию и выполнив отработку аварийного восстановления (тестовую отработку отказа), чтобы проверить правильность работы всех компонентов, вы можете запускать отработку отказа и восстановление размещения по мере необходимости.

1. Можно выполнять отработку отказа отдельных компьютеров или создать планы восстановления, чтобы выполнять отработку отказа сразу нескольких виртуальных машин. План восстановления имеет следующие преимущества перед отработкой отказа отельных компьютеров:
    - Можно моделировать зависимости приложений, включив все виртуальные машины для приложения в один план восстановления.
    - Можно добавить сценарии, модули runbook Azure и паузу для действий, выполняемых вручную.
2. После активации начальной отработки отказа выполняется ее фиксация для получения доступа к рабочей нагрузке из виртуальной машины Azure.
3. Когда основной локальный сайт снова станет доступным, можно будет подготовить среду к восстановлению размещения. Для восстановления размещения следует настроить инфраструктуру восстановления размещения, включая следующее:

    * **Временный сервер обработки в Azure.** Чтобы восстановить размещение из Azure, настройте виртуальную машину Azure как сервер обработки. Это позволит выполнять репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
    * **VPN-подключение.** Для восстановления размещения нужно настроить VPN-подключение (или ExpressRoute) между сетью Azure и локальным сайтом.
    * **Отдельный главный целевой сервер.** По умолчанию главный целевой сервер, установленный вместе с сервером конфигурации на локальной виртуальной машине VMware, обрабатывает восстановление размещения. Чтобы восстановить размещение больших объемов трафика,отдельно настройте локальный главный целевой сервер.
    * **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Эта политика была создана автоматически при создании политики репликации из локальной среды в Azure.
4. После готовности всех компонентов восстановление размещения выполняется в три этапа:

    - Этап 1. Повторно включите защиту виртуальных машин Azure, чтобы обеспечить их репликацию из Azure в локальные виртуальные машины VMware.
    -  Этап 2. Запустите отработку отказа на локальном сайте.
    - Этап 3. После восстановления размещения рабочих нагрузок повторно включите репликацию для локальных виртуальных машин.
    
 
**Восстановление размещения VMware с переносом из Azure**

![Восстановление размещения](./media/vmware-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>Дополнительная информация

Ознакомьтесь с [этим учебником](vmware-azure-tutorial.md), чтобы включить репликацию из VMware в Azure.
