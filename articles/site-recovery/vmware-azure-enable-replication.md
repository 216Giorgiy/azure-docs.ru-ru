---
title: Включение репликации виртуальных машин VMware для аварийного восстановления в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье рассказывается о том, как включить репликацию виртуальных машин VMware для аварийного восстановления в Azure с помощью Azure Site Recovery.
author: mayurigupta13
ms.service: site-recovery
ms.date: 1/29/2019
ms.topic: conceptual
ms.author: mayg
ms.openlocfilehash: 51086b894de7a02ec78302323512c7766dc9f4fb
ms.sourcegitcommit: 95822822bfe8da01ffb061fe229fbcc3ef7c2c19
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2019
ms.locfileid: "55226339"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Включение репликации в Azure для виртуальных машин VMware


В этой статье описано, как включить репликацию локальных виртуальных машин VMware в Azure.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы:

1.  [Настроили локальную исходную среду](vmware-azure-set-up-source.md).
2.  [Настроили целевую среду в Azure](vmware-azure-set-up-target.md).


## <a name="before-you-start"></a>Перед началом работы
При репликации виртуальных машин VMware:

* Учетная запись пользователя Azure должна содержать определенные [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) для включения репликации новой виртуальной машины в Azure.
* Виртуальные машины VMware обнаруживаются каждые 15 минут. Может пройти 15 минут или более, прежде чем они будут обнаружены и отображены на портале Azure. Обнаружение может также занять 15 минут или более при добавлении нового сервера vCenter или узла vSphere.
* Изменения среды на виртуальной машине (например, установка средств VMware) также могут отобразиться на портале через 15 и более минут.
* Время последнего обнаружения виртуальных машин VMware можно узнать на странице **Серверы конфигурации** в поле **Последний контакт в** для сервера vCenter или узла vSphere.
* Чтобы добавить компьютеры для репликации, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и нажмите кнопку **Обновить**.
* Если компьютер уже подготовлен, когда вы включаете репликацию, то сервер обработки автоматически устанавливает на него службу Mobility Service.


## <a name="enable-replication"></a>Включение репликации

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.
2. На странице **Источник** щелкните **Источник** и выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины** или **Физические компьютеры**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел. Этот параметр не учитывается при репликации физических компьютеров.
5. Выберите сервер обработки, который имеет то же имя, что и сервер конфигурации (если вы не создали других серверов обработки). Нажмите кнопку **ОК**.

    ![Включение источника репликации](./media/vmware-azure-enable-replication/enable-replication2.png)

6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure для виртуальных машин после отработки отказа.

7. Выберите учетную запись службы хранения Azure, которую вы хотите использовать для репликации данных. 

    > [!NOTE]

    >   * Можно выбрать учетную запись хранения класса Standard или Premium. Если вы выберете учетную запись класса Premium, потребуется указать дополнительную учетную запись хранения класса Standard для журналов текущей репликации. Учетные записи должны находиться в том же регионе, что и хранилище служб восстановления.
    >   * Если вам нужна другая учетная запись хранения, [создайте ее](../storage/common/storage-create-storage-account.md). Чтобы создать учетную запись хранения используя диспетчер ресурсов, щелкните **Создать**. 

8. Выберите сеть и подсеть Azure, к которой будут подключаться развернутые виртуальные машины Azure после отработки отказа. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым компьютерам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если у вас нет сети, ее необходимо [создать](#set-up-an-azure-network). Чтобы создать сеть, используя диспетчер ресурсов, щелкните **Создать**. Выберите подсеть, если это применимо, затем нажмите кнопку **ОК**.

    ![Включение параметров целевого объекта репликации](./media/vmware-azure-enable-replication/enable-rep3.png)
9. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**. Если определенная виртуальная машина не отображается или ее нельзя выбрать, см. раздел [Исходный компьютер отсутствует в списке на портале Azure](https://aka.ms/doc-plugin-VM-not-showing) для устранения проблемы.

    ![Включение в репликацию выбранных виртуальных машин](./media/vmware-azure-enable-replication/enable-replication5.png)
10. В поле **Свойства** > **Настройка свойств** выберите учетную запись, используемую сервером обработки для автоматической установки службы Mobility Service на компьютере.  
11. По умолчанию будут реплицироваться все диски. Чтобы исключить диски из репликации, щелкните **Все диски**, а затем снимите флажки напротив дисков, которые не нужно реплицировать.  Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства. Дополнительные сведения об исключении дисков см.в [этой статье](vmware-azure-exclude-disk.md).

    ![Включение параметров политики репликации](./media/vmware-azure-enable-replication/enable-replication6.png)

12. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации. Параметры политики репликации можно изменить, последовательно выбрав **Параметры** > **Политики репликации** > имя политики > **Изменить параметры**. Изменения, примененные к политике, будут применены к репликации и новым компьютерам.
13. Включите параметр **Multi-VM consistency** (Согласованность нескольких виртуальных машин), если хотите объединить компьютеры в группу репликации. Укажите имя группы и нажмите кнопку **ОК**. 

    > [!NOTE]

    >    * Компьютеры в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные точки восстановления после отработки отказа.
    >    * Объедините виртуальные машины и физические сервера, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки. Используйте ее, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно.

    ![Включение репликации](./media/vmware-azure-enable-replication/enable-replication7.png)
14. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.



## <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Далее нужно проверить свойства исходного компьютера. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure после отработки отказа](vmware-physical-azure-support-matrix.md#replicated-machines).

1. Щелкните **Параметры** >  > **Реплицированные элементы**, а затем выберите нужный компьютер. На странице **Основные компоненты** отображается информация о параметрах и состоянии компьютера.
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.
3. Приведенные далее свойства виртуальной машины можно изменить в разделах **Вычисления и сеть** > **Свойства вычислений**.
* Имя виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure.
* Размер или тип целевой виртуальной машины. Размер виртуальной машины по умолчанию устанавливается на основе размера исходной виртуальной машины. Основываясь на времени, требуемом перед отработкой отказа, можете выбрать другой размер виртуальной машины. Обратите внимание, что размер диска виртуальной машины основывается на размере начального диска и может быть изменен только после отработки отказа. Дополнительные сведения о размерах дисков и операциях ввода-вывода в секунду в ценовой категории [Стандартный](../virtual-machines/windows/disks-standard-ssd.md#scalability-and-performance-targets) и [Премиум](../virtual-machines/windows/premium-storage.md#scalability-and-performance-targets).

    ![Свойства вычислений и сети](./media/vmware-azure-enable-replication/vmproperties.png)

*  Группа ресурсов. Вы можете выбрать [группу ресурсов](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-resource-groups-guidelines), из которой компьютер будет получен для отработки отказа. Этот параметр можно изменить в любое время перед отработкой отказа. Если после отработки отказа переместить компьютер в другую группу ресурсов, параметры защиты для этого компьютера будут нарушены.
* Группа доступности. Кроме того, можно выбрать [группу доступности](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-availability-sets-guidelines), если компьютер должен стать элементом отработки отказа. При выборе группы доступности учитывайте следующее:

    * Отображаются только группы доступности, принадлежащие к указанной группе ресурсов.  
    * Компьютеры в разных виртуальных сетях не могут входить в одну группу доступности.
    * В одну группу доступности могут входить только виртуальные машины одинакового размера.
4. Кроме того, можно просмотреть и добавить сведения о целевой сети, подсети и целевом IP-адресе, назначенном виртуальной машине Azure.
5. На странице **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине для репликации.

### <a name="configure-networks-and-ip-addresses"></a>Настройка сетей и IP-адресов

- Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Если целевой IP-адрес доступен в сети тестовой отработки отказа, его можно использовать для тестовой отработки отказа.
- Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:
    - Если число сетевых адаптеров на исходном компьютере меньше или равно числу адаптеров, разрешенному для целевого компьютера, то на целевом и исходном компьютерах число адаптеров одинаковое.
    - Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, используется максимальный размер целевой машины.
    Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходном компьютере два адаптера, но целевой размер поддерживает только один, то на целевом компьютере будет работать только один адаптер.
    - Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети. В виртуальной машине Azure сетевой адаптер, который отобразится первым в списке, становится сетевым адаптером *по умолчанию*.

### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

Клиенты Microsoft Software Assurance могут использовать программу преимуществ гибридного использования Azure, чтобы сэкономить на стоимости лицензирования компьютеров Windows Server, которые переносятся в Azure, или использовать Azure для аварийного восстановления. Если вы имеете право использовать преимущество гибридного использования Azure, вы можете назначить его виртуальной машине, которую создает служба Azure Site Recovery в Azure в случае отработки отказа. Для этого:
- Перейдите в раздел свойств "Вычисления и сеть" реплицируемой виртуальной машины.
- Ответьте на вопрос, есть ли у вас лицензия Windows Server, дающая право на участие в программе преимуществ гибридного использования Azure.
- Установите флажок, чтобы подтвердить наличие соответствующей лицензии Windows Server с программой Software Assurance, которую можно использовать для применения преимуществ гибридного использования Azure на компьютере, который будет создан при отработке отказа.
- Сохраните настройки для реплицируемого компьютера.

См. дополнительные сведения о программе [преимуществ гибридного использования Azure](https://aka.ms/azure-hybrid-benefit-pricing).

## <a name="common-issues"></a>Распространенные проблемы

* Размер каждого диска не должен превышать 4 ТБ.
* Диск операционной системы представляет собой базовый, а не динамический диск.
* У виртуальных машин с поддержкой 2/UEFI операционная система должна быть из семейства Windows, а размер загрузочного диска не должен превышать 300 ГБ.

## <a name="next-steps"></a>Дополнительная информация

После того как защита будет установлена и компьютер окажется в защищенном состоянии, можно запустить пробную [отработку отказа](site-recovery-failover.md), чтобы определить, появится ли ваше приложение в Azure.

* Чтобы отключить репликацию, см. сведения в статье [Удаление серверов и отключение защиты](site-recovery-manage-registration-and-protection.md).
* Дополнительные сведения см. в статье [Настройка аварийного восстановления виртуальных машин VMware в Azure с помощью PowerShell](vmware-azure-disaster-recovery-powershell.md).
