<properties
	pageTitle="Руководство по ASR для Active Directory | Microsoft Azure" 
	description="В этой статье подробно описано, как создать решение по аварийному восстановлению для AD с помощью службы Azure Site Recovery и выполнять плановые, внеплановые и тестовые отработки отказов с помощью быстрого плана восстановления, а также указаны поддерживаемые конфигурации и предварительные требования." 
	services="site-recovery" 
	documentationCenter="" 
	authors="prateek9us" 
	manager="abhiag" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="10/12/2015" 
	ms.author="pratshar"/>

#Автоматизированное решение аварийного восстановления для Active Directory и DNS с использованием ASR


Правильная работа всех корпоративных приложений, таких как SharePoint, Dynamics AX и SAP зависят от AD и инфраструктуры DNS. При создании решения аварийного восстановления для таких приложений важно защитить и выполнить восстановление AD в случае сбоя до того, как с проблемами столкнутся другие компоненты приложения.

Служба Azure Site Recovery обеспечивает аварийное восстановление, управляя процессами репликации, отработки отказа и восстановления виртуальных машин. Azure Site Recovery поддерживает ряд технологий репликации, которые обеспечивают систематическое создание реплик, защиту и полную отработку отказов виртуальных машин и приложений в общедоступных и закрытых облаках, а также в облаках хостера.

С Azure Site Recovery можно создать полностью автоматизированный план аварийного восстановления для вашей AD. Отработку отказа можно запустить из любого места в течение нескольких секунд после сбоя и восстановить таким образом работоспособность AD за считанные минуты. Если AD используется в нескольких приложениях, например в SharePoint и SAP на основном сайте, и вы решили выполнять отработку отказа для всего сайта, можно сначала выполнить отработку отказа для AD с использованием ASR, а затем выполнить отработку отказа для других приложений с помощью планов восстановления для этих приложений.

В этой статье подробно описано, как создать решение по аварийному восстановлению для AD и выполнять плановые, внеплановые и тестовые отработки отказов с помощью быстрого плана восстановления, а также указаны поддерживаемые конфигурации и предварительные требования. Предполагается, что аудитория уже знакома с AD и службой Azure Site Recovery. Рекомендуются два варианты защиты AD, выбор которых зависит от сложности локальной среды клиента.

####Вариант 1

Если в среде небольшое количество приложений и один контроллер домена, а весь сайт будет подвергнут отработке отказа одновременно, рекомендуем создать реплику виртуальной машины с контроллером домена на дополнительном сайте с помощью ASR (возможна репликация как с сайта на сайт, так и с сайта в Azure). Реплицированную виртуальную машину можно также использовать для отработки отказа.

####Вариант 2
Если в среде много приложений и несколько контроллеров доменов, а приложения будут подвергаться отработке отказа небольшими группами, рекомендуем в дополнение к включению репликации ASR на виртуальной машине с контроллером домена (которая будет использоваться для отработки отказа) настроить также дополнительный контроллер домена на сайте аварийного восстановления (можно использовать вспомогательный локальный сайт или Azure).

>[AZURE.NOTE]При отработке отказа репликацию ASR для контроллера домена необходимо настраивать, даже если выбран второй вариант. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа](#considerations-for-test-failover).


В следующих разделах объясняется, как включить защиту на контроллере домена в ASR и настроить контроллер домена в Azure.


##Предварительные требования

Реализация аварийного восстановления для AD требует выполнения следующих условий:

- локальное развертывание Active Directory и DNS-сервера;
- хранилище служб Azure Site Recovery создано в подписке Microsoft Azure. 
- Если в качестве сайта аварийного восстановления используется Azure, запустите средство оценки готовности виртуальных машин Azure на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery.


##Включение защиты для контроллера домена (DNS) с помощью ASR


###Защита виртуальной машины
Включите защиту для виртуальной машины контроллера домена (DNS) в ASR. Настройте конфигурацию службы Azure Site Recovery в зависимости от того, развернута ли виртуальная машина на Hyper-V или на VMware. Рекомендуемая частота сбоев — 15 минут.

###Настройка параметров сети виртуальных машин
- Для виртуальной машины контроллера домена (DNS) настройте параметры сети в ASR таким образом, чтобы после отработки отказа эта машина подключалась к правильной сети. 
- Например, если в качестве сайта аварийного восстановления используется Azure, выберите виртуальную машину в разделе "Облако VVM" или "Группа защиты" и настройте параметры сети, как показано ниже на снимке экрана.
- 
![Параметры сети виртуальных машин](./media/site-recovery-active-directory/VM-Network-Settings.png)

##Включение защиты для AD c помощью репликации AD
###Репликация с сайта на сайт

Создайте контроллер домена на вспомогательном сайте (сайте аварийного восстановления), причем, присваивая серверу роль контроллера домена, укажите имя того же домена, который используется для основного сайта. Для настройки параметров для связанных объектов, к которым добавляются сайты, можно использовать оснастку "Сайты и службы Active Directory". Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами. Дополнительные сведения см. в статье [Расписание репликации между сайтами](https://technet.microsoft.com/ru-RU/library/cc731862.aspx).

###Репликация с сайта в Azure
Выполните указанные ниже действия, чтобы создать [контроллер домена в виртуальной сети Azure](../virtual-network/virtual-networks-install-replica-active-directory-domain-controller.md). Присваивая серверу роль контроллера домена, укажите имя того же домена, который используется для основного сайта.

После этого следует [изменить конфигурацию DNS-сервера для виртуальной сети](../virtual-network/virtual-networks-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), указав DNS-сервер в Azure.
  
![Сеть Azure](./media/site-recovery-active-directory/azure-network.png)

##Рекомендации по отработке отказа
Отработка отказа проводится в сети, изолированной от рабочей сети, чтобы не мешать выполнению рабочей нагрузки. Для работы большинства приложений требуется также контроллер домена и DNS-сервер. Таким образом, прежде чем подвергать приложение отработке отказа, необходимо создать в изолированной сети контроллер домена, который будет использоваться при отработке отказа. Самый простой способ это сделать — включить защиту на виртуальной машине контроллера домена (DNS) с помощью ASR и перед активацией отработки плана восстановления соответствующего приложения активировать отработку отказа виртуальной машины с контроллером домена. Ниже приводится пошаговая инструкция по проведению отработки отказа.

1. Включите защиту на виртуальной машине контроллера домена (DNS) точно так же, как для любой другой виртуальной машины.
2. Создайте изолированную сеть. Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети. Рекомендуем использовать для этой сети такой же диапазон IP-адресов, как у вашей рабочей сети. Не включайте для этой сети подключение между сайтами.
3. Укажите IP-адрес DNS-сервера в сети, созданной на предыдущем этапе, в качестве IP-адреса, который будет присвоен виртуальной машине DNS-сервера. Если в качестве сайта аварийного восстановления используется Azure, можете указать для параметра "Целевой IP-адрес" в свойствах виртуальной машины IP-адрес виртуальной машины, которая будет использоваться для отработки отказа. Если сайт аварийного восстановления находится на локальном компьютере и используется DHCP, [настройте DNS и DHCP для отработки отказа](site-recovery-failover.md#prepare-dhcp), следуя приведенным в этой статье инструкциям. 

>[AZURE.NOTE]IP-адрес, присвоенный виртуальной машине для отработки отказа, должен совпадать с IP-адресом, который она бы получила при выполнении плановой или внеплановой отработки отказа, если этот IP-адрес доступен в сети отработки отказа. Если такой IP-адрес недоступен в сети отработки отказа, виртуальная машина получит другой IP-адрес, доступный в сети отработки отказа.

4. Перейдите на виртуальную машину контроллера домена и проведите отработку отказа контроллера в изолированной сети. 
5. Проведите отработку отказа плана восстановления для приложения.
6. По завершении теста отметьте задачи отработки отказа виртуальной машины контроллера домена и плана восстановления на вкладке заданий в ASR как выполненные. 

###DNS не находится на виртуальной машине с контроллером домена 
Если DNS не находится на виртуальной машине с контроллером домена, необходимо создать DNS для отработки отказа. Если DMS и контроллер домена находятся на одной виртуальной машине, этот раздел можно пропустить. Можно использовать новый DNS-сервер и создать все необходимые зоны. Например, если используется домен Active Directory contoso.com, можно создать зону с именем contoso.com. Записи, соответствующие Active Directory, необходимо обновить в DNS. Это можно сделать указанным ниже образом.

- До включения любой другой виртуальной машины в план восстановления убедитесь, что настроены указанные ниже параметры.
	- Необходимо назвать зону именем корня леса.
	- Зона должна иметь файловую поддержку.
	- Для зоны должна быть включена возможность установки безопасных и небезопасных обновлений.
	- Сопоставитель виртуальной машины контроллера домена должен указывать на IP-адрес виртуальной машины DNS.
- Выполните в каталоге виртуальной машины контроллера домена следующую команду: nltest /dsregdns

- **Добавление зоны**. Используя приведенный ниже пример сценария, добавьте зону на DNS-сервер, разрешите небезопасные обновления и добавьте запись для нее в DNS.

	    dnscmd /zoneadd contoso.com  /Primary 
	    dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1 
	    dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM> 
	    dnscmd /config contoso.com /allowupdate 1


##Сводка
С Azure Site Recovery можно создать полностью автоматизированный план аварийного восстановления для вашей AD. Отработку отказа можно запустить из любого места в течение нескольких секунд после сбоя и восстановить таким образом работоспособность AD за считанные минуты. Если AD используется в нескольких приложениях, например в SharePoint и SAP на основном сайте, и вы решили выполнять отработку отказа для всего сайта, можно сначала выполнить отработку отказа для AD с использованием ASR, а затем выполнить отработку отказа для других приложений с помощью планов восстановления для этих приложений.


Дополнительные сведения о защите рабочей нагрузки с помощью ASR см. в [руководстве по рабочим нагрузкам Site Recovery](../site-recovery/site-recovery-workload.md).

<!---HONumber=Oct15_HO3-->