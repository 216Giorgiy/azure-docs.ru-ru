<properties
	pageTitle="Защита Active Directory и DNS с Azure Site Recovery | Microsoft Azure"
	description="В этой статье описывается, как реализовать решение аварийного восстановления для Active Directory с помощью Azure Site Recovery."
	services="site-recovery"
	documentationCenter=""
	authors="prateek9us"
	manager="abhiag"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="05/10/2016"
	ms.author="pratshar"/>

# Защита Active Directory и DNS с Azure Site Recovery

Правильная работа корпоративных приложений, таких как SharePoint, Dynamics AX и SAP зависит от Active Directory и инфраструктуры DNS. При создании решения аварийного восстановления для приложений важно помнить, что необходимо защищать и восстанавливать работу Active Directory и DNS раньше других компонентов приложения, чтобы гарантировать сохранение работоспособности при возникновении аварии.

Site Recovery — это служба Azure, которая обеспечивает аварийное восстановление, управляя процессами репликации, отработки отказа и восстановления виртуальных машин. Site Recovery поддерживает ряд сценариев репликации для надежной защиты и плавной отработки отказа виртуальных машин и приложений в общедоступные и закрытые облака, а также в облака хостера.

С помощью Site Recovery можно создать полностью автоматизированный план аварийного восстановления для Active Directory. При прерывании работы отработку отказа можно запустить из любого места в течение нескольких секунд и таким образом восстановить работоспособность Active Directory за считанные минуты. Если на основном сайте вы развернули Active Directory для нескольких приложений (таких как SharePoint и SAP) и хотите, чтобы отработка отказа включала весь сайт, вы можете сначала выполнить отработку отказа Active Directory с помощью Site Recovery, а затем отработку отказа других приложений с помощью связанных с приложениями планов восстановления.

В этой статье описано создание решения аварийного восстановления для Active Directory и выполнение плановых, внеплановых и тестовых отработок отказов с помощью быстрого плана восстановления, а также указаны поддерживаемые конфигурации и предварительные требования. Перед началом работы необходимо ознакомиться с Active Directory и Azure Site Recovery.

Существует два рекомендуемых варианта в зависимости от сложности среды.

### Вариант 1

Если имеется небольшое количество приложений и один контроллер домена и вам требуется выполнить отработку отказа всего сайта, рекомендуем использовать Site Recovery для репликации контроллера домена на вторичный сайт (независимо от того, выполняется ли отработка отказа в Azure или на вторичный сайт). Реплицированную виртуальную машину также можно использовать для тестовой отработки отказа.

### Вариант 2

Если в вашей среде много приложений и несколько контроллеров доменов или если вы планируете выполнять отработку отказа для нескольких приложений одновременно, рекомендуем в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также настроить дополнительный контроллер домена на целевом сайте (сайте Azure или вторичном локальном центре обработки данных).

>[AZURE.NOTE] Даже если вы реализуете вариант 2, для выполнения тестовой отработки отказа по-прежнему необходимо выполнить репликацию контроллера домена с помощью Site Recovery. Дополнительные сведения можно найти в статье [Рекомендации по тестированию отработки отказа](#considerations-for-test-failover).


В следующих разделах объясняется, как включить защиту для контроллера домена в Site Recovery и настроить контроллер домена в Azure.


## Предварительные требования

- Локально развернутые Active Directory и DNS-сервер.
- Хранилище служб Azure Site Recovery в подписке Microsoft Azure.
- При выполнении репликации в Azure запустите средство оценки готовности виртуальных машин Azure на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery.


## Включение защиты с помощью Site Recovery


### Защита виртуальной машины

Включите защиту виртуальной машины с контроллером домена или DNS в Site Recovery. Настройте параметры Site Recovery на основе типа виртуальной машины (Hyper-V или VMware). Мы рекомендуем использовать частоту репликации в 15 минут для устойчивости к сбоям.

###Настройка сетевых параметров виртуальной машины

Для виртуальной машины с контроллером домена или DNS настройте сетевые параметры в Site Recovery таким образом, чтобы после отработки отказа виртуальная машина подключалась к правильной сети. Например, если выполняется репликация виртуальных машин Hyper-V в Azure, выберите виртуальную машину в облаке VMM или в группе защиты и настройте параметры сети, как показано ниже.

![Параметры сети виртуальных машин](./media/site-recovery-active-directory/VM-Network-Settings.png)

## Защита Active Directory с помощью репликации Active Directory

### Защита "сайт-сайт"

Создайте контроллер домена на вторичном сайте и укажите то же имя домена, которое используется на основном сайте, при повышении роли сервера до роли контроллера домена. Для настройки параметров объекта связи сайтов, в который добавляются сайты, можно использовать оснастку **Active Directory — сайты и службы**. Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами. Дополнительные сведения см. в статье [Планирование репликации между сайтами](https://technet.microsoft.com/library/cc731862.aspx).

###Защита "сайт-Azure"

Выполните инструкции по [созданию контроллера домена в виртуальной сети Azure](../active-directory/active-directory-install-replica-active-directory-domain-controller.md). При повышении роли сервера до роли контроллера домена укажите то же имя домена, которое используется на основном сайте.

Затем [измените конфигурацию DNS-сервера для виртуальной сети](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), так чтобы использовался сервер DNS в Azure.

![Сеть Azure](./media/site-recovery-active-directory/azure-network.png)

## Рекомендации по тестированию отработки отказа

Тестовая отработка отказа проводится в сети, изолированной от рабочей сети, чтобы не мешать выполнению рабочих нагрузок.

Для работы большинства приложений также требуется наличие контроллера домена и DNS-сервера, поэтому перед тем, как произойдет сбой приложения, необходимо создать контроллер домена в изолированной сети, используемой для тестовой отработки отказа. Самый простой способ сделать это — включить защиту на виртуальной машине с контроллером домена или DNS с помощью Site Recovery и запустить тестовую отработку отказа этой виртуальной машины перед запуском тестовой отработки отказа плана восстановления приложения. Вот как это сделать:

1. Включите защиту виртуальной машины с контроллером домена или DNS в Site Recovery.
2. Создайте изолированную сеть. Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети. Рекомендуем использовать для этой сети такой же диапазон IP-адресов, как у вашей рабочей сети. Не включайте для этой сети подключение между сайтами.
3. В качестве IP-адреса DNS в созданной сети укажите IP-адрес, который должна получить виртуальная машина с DNS. Если выполняется репликация в Azure, можете указать для параметра **Целевой IP-адрес** в свойствах виртуальной машины IP-адрес виртуальной машины, которая будет использоваться для отработки отказа. Если выполняется репликация на другой локальный сайт и вы используете DHCP, следуйте инструкциям по [настройке DNS и DHCP для тестовой отработки отказа](site-recovery-failover.md#prepare-dhcp).

>[AZURE.NOTE] IP-адрес, выделенный виртуальной машине для тестовой отработки отказа, должен совпадать с IP-адресом, который она бы получила при выполнении плановой или внеплановой отработки отказа, если этот IP-адрес доступен в сети тестовой отработки отказа. Если это не так, виртуальная машина получит другой IP-адрес, доступный в сети тестовой отработки отказа.

4. На виртуальной машине контроллера домена запустите тестовую отработку отказа в изолированной сети.
5. Запустите тестовую отработку отказа для плана восстановления приложения.
6. По завершении теста отметьте задачи отработки отказа виртуальной машины контроллера домена и плана восстановления на вкладке **Задания** в Site Recovery как выполненные.

### Контроллер домена и DNS на разных компьютерах

Если DNS не находится на одной и той же виртуальной машине с контроллером домена, необходимо создать виртуальную машину DNS для отработки отказа. Если они находятся на одной виртуальной машине, этот раздел можно пропустить.

Можно использовать новый DNS-сервер и создать все необходимые зоны. Например, если используется домен Active Directory contoso.com, можно создать зону DNS с именем contoso.com. Записи DNS, соответствующие Active Directory, необходимо обновить следующим образом:

1. До включения любой другой виртуальной машины в план восстановления убедитесь, что настроены указанные ниже параметры:

	- Необходимо назвать зону именем корня леса.
	- Зона должна иметь файловую поддержку.
	- Для зоны должна быть включена возможность установки безопасных и небезопасных обновлений.
	- Сопоставитель виртуальной машины контроллера домена должен указывать на IP-адрес виртуальной машины DNS.

2. Выполните в каталоге виртуальной машины контроллера домена следующую команду:

	`nltest /dsregdns`

3. Добавьте зону на DNS-сервер, разрешите небезопасные обновления и добавьте запись для этой зоны в DNS:

	    dnscmd /zoneadd contoso.com  /Primary
	    dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1
	    dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>
	    dnscmd /config contoso.com /allowupdate 1


## Дальнейшие действия

Для получения дополнительных сведений о защите корпоративных приложений с Azure Site Recovery прочтите статью [Какие рабочие нагрузки можно защитить?](../site-recovery/site-recovery-workload.md).

<!---HONumber=AcomDC_0511_2016-->