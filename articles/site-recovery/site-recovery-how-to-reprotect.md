---
title: "Как повторно включить защиту из Azure в локальную среду | Документация Майкрософт"
description: "После отработки отказа виртуальных машин в Azure можно инициировать восстановление размещения, чтобы вернуть их в локальную среду. Узнайте, как повторно включить защиту перед восстановление размещения."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: cfe4957191ad5716f1086a1a332faf6a52406770
ms.openlocfilehash: f2da9c4b02f0bb8a93347c05be358516f39e2df0
ms.lasthandoff: 03/09/2017


---
# <a name="reprotect-from-azure-to-on-premises"></a>Повторное включение защиты: Azure — локальная среда

## <a name="overview"></a>Обзор
В этой статье описывается, как повторно включить защиту виртуальных машин Azure на локальном сайте с переносом из Azure. Когда вы будете готовы к восстановлению размещения виртуальных машин VMware или физических серверов Windows и Linux, для которых была выполнена отработка отказа из локального сайта в Azure, следуйте инструкциям, изложенным в этом [руководстве](site-recovery-failover.md).

После того, как повторное включение защиты будет завершено и начнется репликация защищенных виртуальных машин, можно будет запустить восстановление размещения виртуальных машин, чтобы вернуть их в локальную среду.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Ниже представлено видео с коротким обзором.
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

См. дополнительные сведения о полном процессе восстановления размещения.

## <a name="pre-requisites"></a>Предварительные требования
Ниже приведено несколько предварительных шагов, которые необходимо выполнить или рассмотреть при подготовке к повторному включению защиты.

* Если виртуальные машины, для которых необходимо выполнить восстановление размещения, управляются с помощью сервера vCenter, необходимо убедиться в наличии требуемых разрешений для обнаружения виртуальных машин на серверах vCenter. [Подробная информация](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).
* Если на локальной виртуальной машине есть моментальные снимки, произойдет сбой повторного включения защиты. Их можно удалить, прежде чем продолжить повторное включение защиты.
* Прежде чем выполнить восстановление размещения, потребуется создать несколько дополнительных компонентов.
  * **Создайте сервер обработки**. Сервер обработки используется для получения данных из защищенных виртуальных машин в Azure и отправки этих данных в локальную среду. Для этого между сервером обработки и защищенной виртуальной машиной требуется сеть с низкой задержкой. Поэтому сервер обработки может находиться в локальной среде (если вы используете подключение ExpressRoute) или в Azure, если используется подключение VPN.
  * **Создайте главный целевой сервер**. Этот сервер получает данные восстановления размещения. На сервере управления, созданном локально, главный целевой сервер установлен по умолчанию. Но в зависимости от объема трафика восстановления размещения для него может потребоваться создать отдельный главный целевой сервер.
        * [Для виртуальной машины Linux нужен главный целевой сервер Linux](site-recovery-how-to-install-linux-master-target.md).
        * Для виртуальной машины Windows нужен главный целевой сервер под управлением Windows. Вы можете повторно использовать локальные сервер обработки и главный целевой сервер.
* При восстановлении размещения сервер конфигурации должен быть в локальной среде. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации, в противном случае восстановление не будет успешным. Таким образом, необходимо обеспечить регулярное плановое резервное копирование сервера. В случае аварии потребуется восстановить сервер с тем же IP-адресом, чтобы обеспечить работу восстановления размещения.
* В конфигурации главной целевой виртуальной машины в VMware установите для параметра disk.enableUUID значение true. Если этого параметра нет, добавьте его. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK.
* **Виртуальные машины на главном целевом сервере нельзя перенести в другое хранилище**. Из-за этого восстановление размещения может завершиться сбоем. Виртуальная машина не будет восстановлена, так как для нее не будет доступных дисков.
* Необходимо добавить новый диск на главный целевой сервер. Этот диск называется диском хранения. Добавьте новый диск и отформатируйте его.
* Другие предварительные требования для главного целевого сервера см. в разделе [Что нужно проверить в главном целевом сервере перед повторным включением защиты](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-master-target).


### <a name="why-do-i-need-a-s2s-vpn-or-an-expressroute-to-replicate-data-back-to-on-premises"></a>Зачем нужно подключение VPN типа "сеть — сеть" или ExpressRoute для репликации данных в локальную среду
Если репликация из локальной среды в Azure может осуществляться через Интернет или канал ExpressRoute с общедоступным пирингом, при повторном включении защиты и восстановления размещения для репликации данных необходимо настроить VPN типа "сеть — сеть". **Вам понадобится сеть, через которую виртуальные машины в Azure, перенесенные при отработке отказа, смогут связываться (проверять связь) с локальным сервером конфигурации**. Вы можете также развернуть сервер обработки в этой сети Azure. Он тоже должен иметь возможность взаимодействовать с локальным сервером конфигурации.

### <a name="when-should-i-install-a-process-server-in-azure"></a>Когда следует установить сервер обработки в Azure


Виртуальные машины Azure, для которых нужно повторно включить защиту, отправляют данные репликации на сервер обработки. Сеть должна быть настроена таким образом, что сервер обработки был доступен виртуальной машине Azure.

Сервер обработки можно развернуть в Azure или задействовать существующий сервер обработки, который использовался во время отработки отказа. Важно учитывать задержку при отправке данных из виртуальных машин Azure на сервер обработки.

* Если настроен канал ExpressRoute, то для отправки данных можно использовать локальный сервер обработки. Это разумно, так как задержка между сервером обработки и виртуальной машиной будет низкой.

    ![Схема архитектуры для ExpressRoute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)



* Однако если имеется только VPN типа "сеть — сеть", то рекомендуется развернуть сервер обработки в Azure.

    ![Схема архитектуры для VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)


Помните, что репликация будет осуществляться только через VPN типа "сеть — сеть" или частный пиринг сети ExpressRoute. Убедитесь, что этот сетевой канал обеспечивает достаточную пропускную способность.

См. дополнительные сведения об установке [сервера обработки в Azure](site-recovery-vmware-setup-azure-ps-resource-manager.md).

### <a name="what-are-the-different-ports-to-be-open-on-different-components-so-that-reprotect-can-work"></a>Какие порты должны быть открыты на разных компонентах для корректной работы повторной защиты

![Отработка отказа и восстановление размещения во всех портах](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

### <a name="which-master-target-server-to-use-for-reprotect"></a>Какой главный целевой сервер необходимо использовать для повторного включения защиты
Главный целевой сервер нужен в локальной среде для получения данных от сервера обработки и их записи в VMDK-файл локальной виртуальной машины. Если вы защищаете виртуальные машины Windows, то нужен главный целевой сервер Windows, и в этом случае вы можете повторно использовать локальные сервер обработки и главный целевой сервер <!-- !todo component -->. Для виртуальных машин Linux необходимо настроить дополнительный главный целевой сервер Linux в локальной среде.


Перейдите по ссылкам ниже, чтобы ознакомиться с пошаговыми инструкциями по установке главного целевого сервера.

* [Как установить главный целевой сервер Windows](site-recovery-vmware-to-azure.md#run-site-recovery-unified-setup)
* [Как установить главный целевой сервер Linux](site-recovery-how-to-install-linux-master-target.md)


#### <a name="common-things-to-check-after-completing-installation-of-master-target"></a>Что нужно проверить после установки главного целевого сервера

* Если виртуальная машина размещена локально на сервере vCenter, то главному целевому серверу требуется доступ к VMDK-файлу этой локальной виртуальной машины. Это необходимо для записи реплицированных данных на диски виртуальной машины. Для этого необходимо убедиться, что **хранилище данных локальной виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись**.

* Если виртуальная машина не размещена локально на сервере vCenter, то во время повторного включения защиты потребуется создать новую виртуальную машину. Она будет создана на узле ESX, на котором создан главный целевой сервер. Поэтому внимательно выбирайте узел ESX, чтобы виртуальная машина для восстановления размещения была создана на нужном узле.

* **Виртуальные машины на главном целевом сервере нельзя перенести в другое хранилище**. Из-за этого восстановление размещения может завершиться сбоем. Виртуальная машина не будет восстановлена, так как для нее не будет доступных дисков.

* На существующий главный целевой сервер под управлением Windows необходимо добавить новый диск. Этот диск называется диском хранения. Добавьте новый диск и отформатируйте его. Диск хранения используется для остановки точек при репликации виртуальной машины в локальную среду. Ниже перечислены некоторые критерии диска хранения, без которых он не будет отображаться для главного целевого сервера.

   * Том не должен использоваться ни для какой иной цели (как конечный пункт репликации и т. д.).

   * Том не должен быть заблокирован.

   * Том не должен быть томом кэша. (В томе не должна присутствовать установка главного целевого сервера. Том выборочной установки сервера обработки и главного целевого сервера не может использоваться как том хранения. В данном случае в качестве тома для установки сервера обработки и главного целевого сервера используется том кэша главного целевого сервера.)

   * Том не должен иметь тип файловой системы FAT или FAT32.

   * Емкость тома не должна быть нулевой.

   * Том хранения по умолчанию для Windows — это том R.

   * Том хранения по умолчанию для Linux — /mnt/retention.

* Для виртуальной машины Linux, для которой выполнена отработка отказа, нужен главный целевой сервер Linux. Для виртуальной машины Windows, для которой выполнена отработка отказа, нужен главный целевой сервер Windows.

* Установите инструменты VMware на главном целевом сервере. Без них не удастся обнаружить хранилища данных на узле ESXi главного целевого сервера.

* Включите параметр disk.EnableUUID = True на виртуальной машине главного целевого сервера с помощью свойств vCenter. <!-- !todo Needs link. -->

* К главному целевому серверу должно быть подключено по крайней мере одно хранилище данных VMFS. Если такового нет, информация о хранилище данных на странице повторного включения защиты отображаться не будет, и вы не сможете продолжить работу.

* На дисках главного целевого сервера не должно быть моментальных снимков. В противном случае произойдет сбой повторного включения защиты или восстановления размещения.

* На главном целевом сервере не может быть паравиртуальный контроллер SCSI. Может быть только логический контроллер LSI. Если логического контроллера LSI нет, произойдет сбой повторного включения защиты.

<!--
### Failback policy
To replicate back to on-premises, you will need a failback policy. This policy get automatically created when you create a forward direction policy. Note that

1. This policy gets auto associated with the configuration server during creation.
2. This policy is not editable.
3. The set values of the policy are (RPO Threshold = 15 Mins, Recovery Point Retention = 24 Hours, App Consistency Snapshot Frequency = 60 Mins)
   ![](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

-->

## <a name="steps-to-reprotect"></a>Инструкции по повторному включению защиты

Перед повторным включением защиты убедитесь, что вы установили [сервер обработки](site-recovery-vmware-setup-azure-ps-resource-manager.md) в Azure, а также [главный целевой сервер Linux](site-recovery-how-to-install-linux-master-target.md) или Windows в локальной среде.

> [!NOTE]
> После загрузки виртуальной машины в Azure для повторной регистрации агента на сервере конфигурации потребуется некоторое время (не более 15 минут). Если включить повторную защиту в течение этого времени, произойдет сбой, и на экране отобразится сообщение о том, что агент не установлен. Подождите несколько минут, а затем включите повторную защиту еще раз.



1. В разделе "Хранилище" > "Реплицированные элементы" выберите виртуальную машину, на которой проводилась отработка отказа, щелкните ее правой кнопкой мыши и выберите **Защитить повторно**. Это также можно сделать, щелкнув машину и выбрав повторную защиту с помощью кнопок управления.
2. В колонке будет уже выбрано направление защиты "Azure в локальную среду".
3. В полях **Главный целевой сервер** и **Сервер обработки** выберите локальный главный целевой сервер и сервер обработки.
4. Выберите **хранилище данных** , для которого нужно восстановить диски локальной среды. Этот параметр используется при удалении локальной виртуальной машины и появлении необходимости в создании дисков. Хотя этот параметр не учитывается, если диски уже существуют, его значение необходимо указать.
5. Выберите диск хранения.
6. Политика восстановления размещения будет выбрана автоматически.
7. После нажатия кнопки **ОК** для повторного включения защиты задание начинает репликацию виртуальной машины из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания** .

Если необходимо выполнить восстановление в альтернативном расположении (если локальная виртуальная машина удалена), выберите диск хранения и хранилище данных, настроенные для главного целевого сервера. При восстановлении расположения на локальном сайте виртуальные машины VMware в плане защиты восстановления размещения будут использовать то же хранилище данных, что и главный целевой сервер, и на сервере vCenter будет создана новая виртуальная машина.
Если вы хотите восстановить виртуальную машину Azure в существующую локальную виртуальную машину, то ее локальные хранилища данных должны быть подключены с доступом на чтение и запись к узлу ESXi главного целевого сервера.
    ![](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

Защиту можно также включить повторно на уровне плана восстановления. Если у вас есть группа репликации, ее защиту можно восстановить только с помощью плана восстановления. При этом для каждой защищаемой машины необходимо будет указать перечисленные выше значения.

> [!NOTE]
> Защита группы репликации должна быть восстановлена с использованием того же главного целевого сервера. При выборе другого главного целевого сервера для него нельзя будет выбрать другую общую временную точку.


После успешного повторного включения защиты виртуальная машина перейдет в защищенное состояние.

## <a name="next-steps"></a>Дальнейшие действия

После того, как виртуальная машина перейдет в защищенное состояние, можно инициировать восстановление размещения. При этом будет завершена работа виртуальной машины в Azure и загружена виртуальная машина в локальной среде. Поэтому в работе приложения будет незначительный простой. Поэтому выберите для восстановления размещения период, когда простой приложения допустим.

[Инструкции по запуску восстановления размещения виртуальной машины](site-recovery-how-to-failback-azure-to-vmware.md#steps-to-failback)

## <a name="common-issues"></a>Распространенные проблемы

* Если виртуальные машины созданы при помощи шаблона, перед включением защиты необходимо убедиться, что диски каждой виртуальной машины имеют уникальный UUID. При возникновении конфликта UUID локальной виртуальной машины и главного целевого сервера (так как оба компонента созданы на основе одного шаблона) произойдет сбой повторного включения защиты. В таком случае нужно развернуть другой главный целевой сервер, при создании которого не использовался этот шаблон.
* Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция завершится успешно и отработка отказа будет работать. Во время повторного включения защиты происходит сбой отработки отказа, так как невозможно обнаружить хранилища данных. Признаком этой ситуации является отсутствие списка хранилищ данных при повторном включении защиты. Для устранения этой проблемы можно обновить учетные данные vCenter, указав учетную запись с соответствующими разрешениями, и повторить задание. Дополнительные сведения см. в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).
* При восстановлении размещения виртуальной машины Linux и ее последующем запуске в локальной среде вы видите, что с этой виртуальной машины удален пакет диспетчера сети. Это вызвано тем, что при восстановлении виртуальной машины в Azure пакет диспетчера сети удаляется.
* Если для виртуальной машины Linux со статическим IP-адресом выполняется отработка отказа в Azure, IP-адрес предоставляется через DHCP. При восстановлении размещения в локальной среде виртуальная машина также будет получать IP-адрес с помощью DHCP. Вручную войдите на виртуальную машину и снова настройте статический IP-адрес, если это необходимо. Виртуальная машина Windows может получать IP-адрес повторно.
* Если вы используете бесплатный выпуск ESXi версии 5.5 или низкоуровневой оболочки vSphere версии 6, то отработка отказа будет выполнена успешно, но восстановление размещения после сбоя выполнено не будет. Чтобы включить восстановления размещения, необходимо выполнить обновление до любой из версий с ознакомительной лицензией.
* Если сервер конфигурации недоступен с сервера обработки, проверьте подключение к серверу конфигурации по протоколу Telnet через порт 443. Можно также проверить связь между сервером конфигурации и виртуальной машиной сервера обработки. Сервер обработки должен также отвечать на пульс, когда он подключен к серверу конфигурации.
* Если вы пытаетесь восстановить размещения на альтернативный сервер vCenter, убедитесь, что новый сервер vCenter обнаружен, как и главный целевой сервер. Характерный симптом: хранилища недоступны и отсутствуют в диалоговом окне **Повторная защита**.
* Размещение компьютера Windows Server&2008; R2 SP1, который защищен как физический локальный компьютер, не может быть восстановлено из Azure в локальную среду.

