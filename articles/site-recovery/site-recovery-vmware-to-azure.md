<properties
	pageTitle="Настройка защиты между локальными виртуальными машинами VMWare или физическими серверами и Azure" 
	description="Описывает, как Azure Site Recovery координирует репликацию, отработку отказа и восстановление локальных виртуальных машин VMware или физических серверов Windows/Linux в Azure." 
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/09/2015"
	ms.author="raynew"/>

# Настройка защиты между локальными виртуальными машинами VMWare или физическими серверами и Azure

В этой статье описывается развертывание Site Recovery в следующих целях.

- **Защита виртуальных машин VMware** — координируйте репликацию, отработку отказа и восстановление локальных виртуальных машин VMware в Azure.
- **Защита физических серверов** — координируйте репликацию, отработку отказа и восстановление локальных физических серверов Windows и Linux в Azure с помощью службы Azure Site Recovery.

Статья содержит общие сведения и предварительные требования к развертыванию, а также указания по настройке. В конце статьи ваши виртуальные машины VMware или физические серверы будут реплицироваться в Azure. Если у вас возникают проблемы, задайте свои вопросы на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Что собой представляет служба Azure Site Recovery?

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления (BCDR), управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Узнайте больше о службе [Azure Site Recovery](site-recovery-overview.md).

## Как она защищает локальные ресурсы?

Служба Site Recovery помогает защитить локальные ресурсы благодаря оркестрации, упрощению репликации, отработки отказа и восстановления размещения в ряде [сценариев развертывания](site-recovery-overview.md). Как вам может помочь Site Recovery, если требуется защитить локальные виртуальные машины VMware либо физические серверы Windows или Linux.

- Позволяет пользователям VMware реплицировать виртуальные машины в Azure.
- Позволяет реплицировать физические локальные серверы в Azure.
- Предоставляет единое расположение для настройки репликации, отработки отказа и восстановления, а также для управления ими.
- Предоставляет простую отработку отказа из локальной инфраструктуры в Azure и восстановление размещения (восстановление) из Azure в локальную среду.
- Внедряет планы восстановления для обеспечения простой отработки отказа рабочих нагрузок, которые размещены по уровням на нескольких компьютерах.
- Реализует согласованность нескольких виртуальных машин, обеспечивающую совместное восстановление виртуальных машин и физических серверов с определенными рабочими нагрузками до согласованной точки данных.
- Поддерживает репликацию данных через Интернет, VPN-подключение типа «сеть — сеть» или Azure ExpressRoute.
- Обеспечивает автоматическое обнаружение виртуальных машин VMWare.


## Что необходимо?

На этой схеме приведены компоненты развертывания.

![Новое хранилище](./media/site-recovery-vmware-to-azure/ASRVMWare_Arch.png)

Вам потребуется следующее.

**Компонент** | **Развертывание** | **Дополнительные сведения**
--- | --- | ---
**Сервер конфигурации** | <p>Развертывается в виртуальной машине Azure A3 в той же подписке Azure, в которой находится Site Recovery.</p> <p>Настройка осуществляется на портале Site Recovery.</p> | Этот сервер координирует взаимодействие между защищенными компьютерами, сервером обработки и главными целевыми серверами в Azure. Он настраивает репликацию и координирует восстановление в Azure при возникновении отработки отказа.
**Главный целевой сервер** | <p>Развертывается, как виртуальная машина Azure — в виде сервера Windows, основанного на образе коллекции Windows Server 2012 R2 (для защиты компьютеров Windows) или сервера Linux, основанного на образе коллекции OpenLogic CentOS 6.6 (для защиты компьютеров Linux).</p> <p>Доступны два варианта размера — Standard A4 и Standard D14.<p><p>Этот сервер подключается к той же сети Azure, что и сервер конфигурации.</p><p>Настройка осуществляется на портале Site Recovery.</p> | <p>Содержит данные репликации с защищенных виртуальных машин. Данные размещаются на подключенных виртуальных жестких дисках, созданных в хранилище больших двоичных объектов в учетной записи хранения Azure.</p>   
**Сервер обработки** | <p>Развертывается в виде виртуального или физического сервера под управлением Windows Server 2012 R2.</p> <p>Рекомендуется разместить его в той же сети и сегменте локальной сети, что и защищаемые компьютеры, однако он может выполняться в другой сети при наличии у защищаемых компьютеров доступа к этой сети третьего уровня.<p>Выполняется его настройка и регистрация на сервере конфигурации.</p> | <p>Защищенные компьютеры отправляют данные репликации на локальный сервер обработки. Он включает дисковый кэш для кэширования получаемых данных репликации. Он выполняет ряд действий с этими данными.</p><p>Он оптимизирует данные перед отправкой на главный целевой сервер в Azure, осуществляя кэширование, сжатие и шифрование .</p><p>Он обеспечивает принудительную установку службы Mobility Service.</p><p>Он выполняет автоматическое обнаружение виртуальных машин VMware.</p>
**Локальные компьютеры** | Локальные виртуальные машины, выполняющиеся в низкоуровневой оболочке VMWare, либо физические серверы под управлением Windows или Linux. | Необходимо настроить параметры репликации, применяемые для виртуальных машин и серверов. Отработку отказа можно выполнять как для отдельного компьютера, так и (что происходит чаще) в рамках плана восстановления, содержащего несколько виртуальных машин, которые выполняют отработку отказа совместно.
**Служба Mobility Service** | <p>Устанавливается на каждой виртуальной машине или каждом физическом сервере, которые необходимо защитить.</p><p>Ее можно установить вручную или принудительно и автоматически с помощью сервера обработки. | Служба создает моментальный снимок VSS данных на каждом защищенном компьютере и перемещает его на сервер обработки, который в свою очередь реплицирует его на главный целевой сервер.
**Хранилище Azure Site Recovery** | Настройка осуществляется после подписки на службу Site Recovery. | Серверы регистрируются в хранилище Site Recovery. Это хранилище координирует и организует репликацию данных, отработку отказа и восстановление между локальным сайтом и Azure.
**Механизм репликации** | <p>**Через Интернет** — передача и репликация данных с защищенных локальных серверов и из Azure по защищенному каналу связи SSL/TLS через общедоступное интернет-подключение. Этот вариант используется по умолчанию.</p><p>**VPN или ExpressRoute — передача и репликация данных между локальными серверами и Azure через VPN-подключение. Вам потребуется настроить VPN типа «сеть — сеть» или подключение [ExpressRoute](../expressroute-introduction.md) между локальным сайтом и сетью Azure.</p><p>Можно будет выбрать способ репликации во время развертывания службы Site Recovery. После настройки этот механизм нельзя будет изменить без снижения уровня защиты уже защищенных серверов.| <p>Обратите внимание, что ни один из вариантов не требует открытия входящих сетевых портов на защищенных компьютерах. Все сетевое взаимодействие инициируется локальным сайтом.</p> 

Дополнительные сведения о компонентах Site Recovery, поставщиках и агентах см. в разделе [Компоненты Site Recovery](site-recovery-components.md).

## Планирование загрузки

Основные аспекты для рассмотрения

- **Исходная среда** — параметры и требования для инфраструктуры VMware и исходных компьютеров.
- **Серверы компонентов** — сервер обработки, сервер конфигурации и главный целевой сервер. 

### Рекомендации для исходной среды

- **Максимальный размер диска** — текущий максимальный размер диска, который можно подключить к виртуальной машине, составляет 1 ТБ. Таким образом, максимальный размер исходного диска, который можно реплицировать, также ограничен 1 ТБ.
- **Максимальный размер на источник** — максимальный размер одного исходного компьютера составляет 31 ТБ (с 31 диском) и с экземпляром D14, подготовленным для главного целевого сервера. 
- **Число источников на каждый главный целевой сервер** — несколько исходных компьютеров можно защитить с помощью одного главного целевого сервера. Однако невозможно обеспечить защиту одного исходного компьютера на нескольких главных целевых серверах, так как при репликации дисков виртуальный жесткий диск, отражающий размер диска, создается в хранилище больших двоичных объектов Azure и подключается к главному целевому серверу как диск данных.  
- **Максимальная частота ежедневного изменения на источник** — при определении рекомендуемой частоты изменения на источник следует учитывать три фактора. Для конечного назначения следует учитывать, что для каждой операции в источнике на конечном диске необходимы две операции ввода-вывода. Это вызвано тем, что чтение старых данных и запись новых данных произойдут на конечном диске. 
	- **Частота ежедневного изменения, поддерживаемая сервером обработки** — исходный компьютер не может охватывать несколько серверов обработки. Один сервер обработки может поддерживать частоту ежедневного изменения до 1 ТБ. Поэтому 1 ТБ является максимальной величиной обновления, поддерживаемой исходным компьютером. 
	- **Максимальная пропускная способность, поддерживаемая конечным диском** — максимальное обновление на исходный диск не может превышать 144 ГБ/день (при размере блока записи 8 КБ). Сведения о пропускной способности и операциях ввода-вывода целевого объекта см. в таблице в разделе о главном целевом сервере. Это число необходимо разделить на два, так как каждая операция ввода-вывода в источнике создает 2 операции ввода-вывода на конечном диске. 
	- **Максимальная пропускная способность, поддерживаемая учетной записью хранения** — источник не может охватывать несколько учетных записей хранения. Учитывая, что учетная запись хранения принимает не более 20 000 запросов в секунду и что каждая операция ввода-вывода в источнике создает 2 операции ввода-вывода на главном целевом сервере, рекомендуется поддерживать число операций ввода-вывода для источника на уровне 10 000. 

### Рекомендации для серверов компонентов

В таблице 1 перечислены размеры виртуальных машин для сервера конфигурации и главного целевого сервера.

**Компонент** | **Развернутые экземпляры Azure** | **Ядра** | **Память** | **Макс. дисков** | **Размер диска**
--- | --- | --- | --- | --- | ---
Сервер конфигурации | Standard A3 | 4 | 7 ГБ | 8 | 1023 ГБ
Главный целевой сервер | Standard A4 | 8 | 14 ГБ | 16 | 1023 ГБ
 | Standard D14 | 16 | 112 ГБ | 32 | 1023 ГБ

**Таблица 1**

#### Рекомендации для сервера обработки

Обычно размер сервера обработки зависит от частоты ежедневных изменений для всех защищенных рабочих нагрузок. К наиболее важным рекомендациям относятся следующие.

-	Для выполнения таких задач, как встроенное сжатие и шифрование, требуется достаточный объем вычислений.
-	Сервер обработки использует дисковый кэш. Убедитесь, что размер кэша и пропускная способность диска соответствуют рекомендациям, чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя. 
-	Обеспечьте достаточную пропускную способность, чтобы сервер обработки мог передать данные на главный целевой сервер для предоставления непрерывной защиты данных. 

В таблице 2 приведена сводка рекомендаций по серверу обработки.

**Частота изменения данных** | **ЦП** | **Память** | **Размер диска кэша**| **Пропускная способность диска кэша** | **Пропускная способность для входящих/исходящих данных**
--- | --- | --- | --- | --- | ---
< 300 ГБ | 4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц) | 4 ГБ | 600 ГБ | От 7 до 10 МБ в секунду | 30 Мбит/с/21 Мбит/с
От 300 до 600 ГБ | 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) | 6 ГБ | 600 ГБ | От 11 до 15 МБ в секунду | 60 Мбит/с/42 Мбит/с
От 600 ГБ до 1 ТБ | 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) | 8 ГБ | 600 ГБ | От 16 до 20 МБ в секунду | 100 Мбит/с/70 Мбит/с
> 1 ТБ | Разверните другой сервер обработки | | | | 

**Таблица 2**

Описание

- Входящие — это пропускная способность скачивания (интрасеть между источником и сервером обработки).
- Исходящие данные — это пропускная способность передачи (интрасеть между сервером обработки и главным целевым сервером). В значениях для исходящих данных подразумевается среднее сжатие на сервере обработки в размере 30 %.
- В качестве диска кэша для всех внутренних серверов рекомендуется использовать отдельный диск операционной системы размером не менее 128 ГБ.
- Для тестирования пропускной способности диска кэша использовалось следующее хранилище: 8 дисков SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

#### Рекомендации по серверу конфигурации

Каждый сервер конфигурации может поддерживать до 100 исходных компьютеров с 3–4 томами. При превышении этих значений рекомендуется развернуть другой сервер конфигурации. Свойства виртуальной машины по умолчанию для сервера конфигурации см. в таблице 1.

#### Рекомендации по главному целевому серверу и учетной записи хранения

Хранилище для каждого главного целевого сервера состоит из диска ОС, тома сохранения и дисков данных. На диске хранения находится журнал изменений диска за период окна сохранения, определенного на портале Site Recovery. Свойства виртуальной машины для главного целевого сервера см. в таблице 1. В таблице 3 показано, как используются диски A4.

**Экземпляр** | **Диск ОС** | **Сохранение** | **Диски данных**
--- | --- | --- | ---
 | | **Сохранение** | **Диски данных**
Standard A4 | 1 диск (1 * 1023 ГБ) | 1 диск (1 * 1023 ГБ) | 15 дисков (15 * 1023 ГБ)
Standard D14 | 1 диск (1 * 1023 ГБ) | 1 диск (1 * 1023 ГБ) | 31 диск (15 * 1023 ГБ)

**Таблица 3**

Планирование емкости для главного целевого сервера зависит от следующих факторов.

- Производительность и ограничения хранилища Azure
	- 500 операций ввода-вывода в секунду на диск
	- 20 000 запросов на учетную запись хранения
	- Учитывая эти показатели, оптимальной является ситуация, когда учетная запись хранения поддерживает 40 дисков, каждый из которых обрабатывает 500 операций ввода-вывода. 
-	Частота ежедневного изменения 
-	Хранилище тома сохранения.

Обратите внимание на следующее.

- Один источник не может охватывать несколько учетных записей хранения. Это относится к диску данных, который переходит в учетные записи хранения, выбранные при настройке защиты. Диски ОС и сохранения обычно переходят в автоматически развернутую учетную запись хранения.
- Требуемый том хранилища сохранения зависит от частоты ежедневных изменений и числа дней сохранения. Требуемое место сохранения для каждого главного целевого сервера равно всему обновлению из источника за день, умноженному на число дней сохранения. 
- Каждый главный целевой сервер имеет только один том сохранения. Том сохранения совместно используется дисками, подключенными к главному целевому серверу. Например:
	- Если имеется исходный компьютер с 5 дисками, каждый из которых создает 120 операций ввода-вывода в секунду (размером 8 КБ) в источнике, в результате получается 240 операций ввода-вывода на диск (2 операции на конечном диске для одной операции ввода-вывода источника). Число 240 операций ввода-вывода в секунду удовлетворяет пределу по числу операций ввода-вывода на диск в Azure, равному 500.
	- На томе сохранения это превращается в 120 * 5 = 600 операций ввода-вывода в секунду, что может стать узким местом. В таком сценарии хорошей стратегией будет добавление дополнительных дисков для тома сохранения и использование его в виде чередующейся конфигурации RAID. Это увеличит производительность, поскольку операции ввода-вывода распределяются по нескольким дискам. Число добавляемых дисков для тома сохранения определяется следующим образом.
		- Общее число операций ввода-вывода в секунду из исходной среды/500.
		- Общее число обновлений в день из исходной среды (без сжатия)/287 ГБ. 287 ГБ — это максимальная пропускная способность, поддерживаемая конечным диском в день. Эта метрика зависит размера блока записи с коэффициентом 8 КБ, поскольку в данном случае 8 КБ является предполагаемым размером блока записи. Например, если размер блока записи равен 4 КБ, пропускная способность будет составлять 287/2. А если размер блока записи равен 16 КБ, пропускная способность будет составлять 287*2.
- Число необходимых учетных записей хранения = общее число операций ввода-вывода для источника/10 000.


## Перед началом работы

**Компонент** | **Требования** | **Дополнительные сведения**
--- | --- | --- 
**Учетная запись Azure** | Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](pricing/free-trial/).
**Служба хранилища Azure** | <p>Для хранения реплицируемых данных потребуется учетная запись хранения Azure.</p><p>Для учетной записи необходимо включить георепликацию.</p><p>Она должна находиться в том же регионе, что и служба Azure Site Recovery, и быть связана с той же подпиской.</p><p>Для получения дополнительных сведений см. раздел [Знакомство со службой хранилища Microsoft Azure](../storage/storage-introduction.md)</p>.
**Виртуальная сеть Azure** | Вам потребуется виртуальная сеть Azure, в которой будут развернуты сервер конфигурации и главный целевой сервер. Ее регион и подписка должны совпадать с регионом и подпиской хранилища Azure Site Recovery.
**Ресурсы Azure** | Убедитесь в наличии достаточного количества ресурсов Azure для развертывания всех компонентов. Дополнительные сведения см. в разделе [Ограничения подписки Azure](../azure-subscription-service-limits.md).
**Виртуальные машины Azure** | <p>Виртуальные машины, которые требуется защитить, должны отвечать [предварительным требованиям Azure](site-recovery-best-practices.md).</p><p>**Число дисков.** Один защищенный сервер может поддерживать максимум 31 диск.</p><p>**Размеры дисков.** Емкость одного диска не должна превышать 1023 ГБ.</p><p>**Кластеризация.** Кластеризованные серверы не поддерживаются.</p><p>**Загрузка.** Загрузка UEFI (Unified Extensible Firmware Interface) или EFI (Extensible Firmware Interface) не поддерживается.</p><p>**Тома.** Тома с шифрованием Bitlocker не поддерживаются.</p><p> **Имена серверов**. Имена должны содержать от 1 до 63 символов (букв, цифр и дефисов). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. После настройки защиты для компьютера можно изменить его имя Azure.</p>
**Сервер конфигурации** | <p>Для сервера конфигурации в вашей подписке будет создана виртуальная машина типа Standard A3, основанная на образе коллекции Windows Server 2012 R2 Azure Site Recovery. Она создается как первый экземпляр в новой облачной службе с зарезервированным общедоступным IP-адресом.</p><p>Путь установки должен включать только символы латинского алфавита.</p>
**Главный целевой сервер** | <p>Виртуальная машина Azure, Standard A4 или D14.</p><p>Путь установки должен включать только символы латинского алфавита. Например, для главного целевого сервера под управлением Linux путь должен иметь следующий вид: **/usr/local/ASR**.</p></p>
**Сервер обработки** | <p>Сервер обработки можно развернуть на физическом компьютере или виртуальной машине под управлением Windows Server 2012 R2 с последними обновлениями. Установите на диске C:/.</p><p>Сервер рекомендуется размещать в той же сети и подсети, что и защищаемые компьютеры.</p><p>Установите VMware vSphere CLI 5.5.0 на сервере обработки. Компонент VMware vSphere CLI необходим на сервере обработки для обнаружения виртуальных машин под управлением сервера vCenter или виртуальных машин, работающих на узле ESXi.</p><p>Путь установки должен включать только символы латинского алфавита.</p>
**VMware** | <p>Сервер VMWare vCenter для управления низкоуровневыми оболочками VMware vSphere. Он должен работать под управлением vCenter 5.1 или 5.5 с последними обновлениями.</p><p>Одна или несколько низкоуровневых оболочек, содержащих защищаемые виртуальные машины VMWare. Низкоуровневая оболочка должна запустить ESX/ESXi версии 5.1 и 5.5 с последними обновлениями.</p><p>На виртуальных машинах VMWare должны быть установлены и запущены средства VMware.</p>
**Компьютеры Windows** | <p>На защищенных физических серверах или виртуальных машинах VMWare под управлением Windows должны соблюдаться определенные требования.</p><p>Поддерживаемая 64-разрядная операционная система: **Windows Server 2012 R2**, **Windows Server 2012** или **Windows Server 2008 R2 хотя бы с пакетом обновления 1 (SP1)**.</p><p>Имена узлов, точек подключения, устройств и системного каталога Windows (например, C:\Windows) должны состоять только из букв латинского алфавита.</p><p>Операционная система должна устанавливаться на диске C:\.</p><p>Поддерживаются только базовые диски. Динамические диски не поддерживаются.</p><p><Firewall rules on protected machines should allow them to reach the configuration and master target servers in Azure.p><p>Необходимо предоставить учетную запись администратора (на компьютере с ОС Windows это должен быть локальный администратор) для принудительной установки службы Mobility Service на серверах Windows. Если предоставленная учетная запись не является учетной записью домена, вам потребуется отключить контроль доступа удаленных пользователей на локальном компьютере. Для этого в разделе реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System добавьте запись LocalAccountTokenFilterPolicy DWORD и задайте для нее значение 1. Чтобы добавить запись в реестр из интерфейса командной строки, откройте cmd или powershell и введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**. [Ознакомьтесь с дополнительными материалами](https://msdn.microsoft.com/library/aa826699.aspx) о контроле доступа.</p><p>Если после отработки отказа требуется подключаться к виртуальным машинам Windows в Azure с помощью функции удаленного рабочего стола, убедитесь, что эта функция включена для локального компьютера. Если подключение выполняется не через VPN, правила брандмауэра должны разрешать подключения удаленного рабочего стола через Интернет.</p>
**Компьютеры Linux** | <p> Поддерживаемая 64-разрядная операционная система: **Centos 6.4, 6.5, 6.6**; **Oracle Enterprise Linux 6.4, 6.5 с ядром, совместимым с Red Hat, или с ядром Unbreakable Enterprise Kernel Release 3 (UEK3)**, **SUSE Linux Enterprise Server 11 SP3**.</p><p>Правила брандмауэра на защищенных компьютерах должны позволять им получать доступ к серверу конфигурации и главным целевым серверам в Azure.</p><p>Файлы /etc/hosts на защищаемых компьютерах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров. </p><p>Чтобы иметь возможность подключаться к виртуальным машинам Azure под управлением Linux после отработки отказа с помощью клиента SSH, убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы и правила брандмауэра разрешают SSH-подключение к виртуальной машине.</p><p>Имена узлов, точки подключения, имена устройств и системные пути и имена файлов Linux (например, /etc/; /usr) должны быть только на английском языке.</p><p>Защиту можно включить для локальных компьютеров со следующими характеристиками хранилища. Файловая система: EXT3, ETX4, ReiserFS, XFS/многомаршрутное подключение устройств (multipath)/диспетчер томов: LVM2. Физические серверы с хранилищем контроллера HP CCISS не поддерживаются.</p>
**Сторонние** | Правильное функционирование некоторых компонентов развертывания в этом сценарии зависит от стороннего программного обеспечения. Полный список такого ПО см. в разделе [Уведомления и сведения о стороннем программном обеспечении](#third-party).

## Развертывание

Шаги развертывания показаны на рисунке.

![Шаги по развертыванию](./media/site-recovery-vmware-to-azure/VMWare2AzureSteps.png)



## Шаг 1. Создание хранилища

1. Выполните вход на [Портал управления](https://portal.azure.com).


2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.


3. Выберите **Создать** > **Быстрое создание**.

4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Область** выберите географический регион для хранилища архивации. Чтобы проверить поддерживаемые регионы, см. географическую доступность в разделе [Azure Site Recovery Pricing Details](pricing/details/site-recovery/) (Информация о ценах на Azure Site Recovery).

6. Щелкните элемент **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-vmware-to-azure/ASRVMWare_CreateVault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. Хранилище будет указано как **Активное** на главной странице **Службы восстановления**.

## Шаг 2. Развертывание сервера конфигурации

### Настройка параметров сервера

1. На странице **Службы восстановления** щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Значок быстрого запуска](./media/site-recovery-vmware-to-azure/ASRVMWare_QuickStartIcon.png)

2. В раскрывающемся списке выберите элемент **Между локальным узлом с VMware/физическими серверами и Azure**.
3. В разделе **Подготовка целевых ресурсов (Azure)** щелкните пункт **Развертывание сервера конфигурации**.

	![Развертывание сервера конфигурации](./media/site-recovery-vmware-to-azure/ASRVMWare_DeployCS2.png)

4. В окне **Сведения о новом сервере конфигурации** укажите следующее.

	- Имя для сервера конфигурации и учетные данные для подключения к нему.
	- Выберите сеть Azure, в которой будет размещаться сервер. 
	- Укажите внутренний IP-адрес и подсеть, которые будут назначены серверу. Обратите внимание, что первые четыре IP-адреса в любой подсети зарезервированы для внутреннего использования Azure. Используйте любой другой доступный IP-адрес.
	
	![Развертывание сервера конфигурации](./media/site-recovery-vmware-to-azure/ASRVMware_CSDetails2.png)

5. При нажатии кнопки **ОК** для сервера конфигурации в вашей подписке будет создана виртуальная машина типа Standard A3, основанная на образе коллекции Windows Server 2012 R2 Azure Site Recovery. Она создается как первый экземпляр в новой облачной службе с зарезервированным общедоступным IP-адресом. Ход выполнения можно отслеживать на вкладке **Задания**.

	![Отслеживание хода выполнения](./media/site-recovery-vmware-to-azure/ASRVMWare_MonitorConfigServer.png)

6.  После развертывания сервера конфигурации запишите назначенный ему общедоступный IP-адрес, который отображается на странице **Виртуальные машины** портала Azure. Затем на вкладке **Конечные точки** запишите общий порт HTTPS, сопоставленный с частным портом 443. Эти сведения потребуются вам в дальнейшем при регистрации главного целевого сервера и сервера обработки в сервере конфигурации. Сервер конфигурации развертывается с этими конечными точками:

	- HTTPS: общий порт используется для координации передачи данных между серверами компонентов и Azure через Интернет. Частный порт 443 используется для координации передачи данных между серверами компонентов и Azure через VPN.
	- Пользовательский: общий порт используется для взаимодействия со средством восстановления размещения через
	- Интернет. Частный порт 9443 используется для взаимодействия со средством восстановления размещения через VPN.
	- PowerShell: частный порт 5986.
	- Удаленный рабочий стол: частный порт 3389.
	
	![Конечные точки виртуальной машины](./media/site-recovery-vmware-to-azure/ASRVMWare_VMEndpoints.png)

    >[AZURE.WARNING]Не удаляйте и не изменяйте номер общего или частного порта для любой из конечных точек, созданных во время развертывания сервера конфигурации.

Сервер конфигурации развертывается в автоматически созданной облачной службе Azure с зарезервированным IP-адресом. Зарезервированный адрес необходим для того, чтобы убедиться, что IP-адрес облачной службы сервера конфигурации не меняется между перезагрузками виртуальных машин (включая сервер конфигурации) в облачной службе. После вывода сервера конфигурации из эксплуатации необходимо вручную отменить резервирование такого общедоступного IP-адреса, в противном случае он останется зарезервированным. Существует ограничение по умолчанию в размере 20 зарезервированных общедоступных IP-адресов на подписку. [Ознакомьтесь с дополнительными сведениями](../virtual-network/virtual-networks-reserved-private-ip.md) о зарезервированных IP-адресах.

### Регистрация сервера конфигурации в хранилище

1. На странице **Быстрый запуск** щелкните **Подготовка целевых ресурсов** > **Скачайте регистрационный ключ**. Файл ключа создается автоматически. Ключ действителен в течение пяти дней после создания. Скопируйте его на сервер конфигурации.
2. В окне **Виртуальные машины** выберите сервер конфигурации из списка виртуальных машин. Откройте вкладку **Панель мониторинга** и щелкните **Подключение**. **Откройте** скачанный RDP-файл для входа на сервер конфигурации с помощью удаленного рабочего стола. При первом входе в систему автоматически запускается мастер установки сервера конфигурации Azure Site Recovery.

	![Регистрация](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationSplashscreen.png)

3. В окне **Third-Party Software Installation** (Установка программного обеспечения сторонних поставщиков) щелкните **Принимаю** для скачивания и установки MySQL.

	![Установка MySQL](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationMySQLEULA.png)

4. В окне **MySQL Server Details** (Сведения о сервере MySQL) создайте учетные данные для входа в этот экземпляр сервера MySQL.

	![Учетные данные MySQL](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationMySQLPWD.png)

5. В окне **Select Network Configuration** (Выбор конфигурации сети) выберите **VPN mode** (Режим VPN), если сервер конфигурации подключен к виртуальной сети Azure, которая подключается к вашей локальной сети через VPN типа «сеть — сеть».

	![Регистрация VPN](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationVPN.png)

6. В окне **Internet Settings** (Параметры Интернета) укажите, как сервер конфигурации будет подключаться к Интернету. Обратите внимание на следующее.

	- Если вы хотите использовать настраиваемый прокси-сервер, его следует настроить перед установкой поставщика.
	- При нажатии кнопки **Далее** будет выполнен тест для проверки подключения прокси-сервера.
	- Если вы используете настраиваемый прокси-сервер или прокси-сервер по умолчанию требует выполнения проверки подлинности, вам потребуется указать сведения о прокси-сервере, включая его адрес, порт и учетные данные.
	- Следующие URL-адреса должны быть доступны через прокси-сервер.
		- *.hypervrecoverymanager.windowsazure.com - *.accesscontrol.windows.net - *.backup.windowsazure.com - *.blob.core.windows.net - *.store.core.windows.net - При наличии правил брандмауэра на основе IP-адресов убедитесь, что они разрешают подключение с сервера конфигурации к IP-адресам, описанным в статье [Диапазоны IP-адресов центра обработки данных Azure](https://msdn.microsoft.com/ru-ru/library/azure/dn175718.aspx), и по протоколу HTTPS (443). Необходимо разрешить диапазоны IP-адресов утвержденного списка для региона Azure, который вы планируете использовать, и для Запада США.

	![Регистрация прокси-сервера](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationProxy.png)

7. В окне **Provider Error Message Localization Settings** (Параметры локализации сообщений об ошибках поставщика) укажите, на каком языке должны отображаться сообщения об ошибках.

	![Регистрации сообщения об ошибке](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationLocale.png)

7. В окне **Azure Site Recovery Registration** (Регистрация Azure Site Recovery) найдите и выберите файл ключа, скопированный на сервер.

	![Регистрация файла ключа](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationVault.png)

4. На странице завершения работы мастера выберите следующие параметры.

	- Выберите **Launch Account Management Dialog** (Открытие диалогового окна управления учетными записями), чтобы указать, что после завершения работы мастера следует открыть диалоговое окно «Управление учетными записями».
	- Выберите **Create a desktop icon for Cspsconfigtool** (Создание значка на рабочем столе для Cspsconfigtool), чтобы добавить ярлык рабочего стола на сервере конфигурации, позволяющий открывать диалоговое окно **Управление учетными записями** в любое время без необходимости повторного запуска мастера.

	![Выполнение регистрации](./media/site-recovery-vmware-to-azure/ASRVMWare_RegistrationFinal.png)

5. Нажмите кнопку **Готово** для завершения работы мастера. Создается парольная фраза. Скопируйте ее в надежное место. Она потребуется для прохождения проверки подлинности и регистрации сервера обработки и главного целевого сервера в сервере конфигурации. Кроме того, она используется для обеспечения целостности канала при обмене данными с сервером конфигурации. Парольную фразу можно создать повторно, однако при этом потребуется заново регистрировать главный целевой сервер и сервер обработки с помощью новой парольной фразы.

	![Парольная фраза](./media/site-recovery-vmware-to-azure/passphrase.png)

После регистрации сервер конфигурации будет добавлен на страницу **Серверы конфигурации** в хранилище.

### Настройка учетных записей и управление ими

Во время развертывания компонент Site Recovery запрашивает учетные данные для следующих действий.

- При регистрации сервера vCenter для автоматизации обнаружения виртуальных машин.
- При добавлении защищаемых компьютеров, чтобы компонент Site Recovery мог установить на них службу Mobility Service.

После регистрации сервера конфигурации можно открыть диалоговое окно **Управление учетными записями** для добавления учетных записей которые должны использоваться для этих действий, и управления ими. Для этого существует два способа.

- Откройте ярлык, который был создан для этого диалогового окна на последней странице программы настройки сервера конфигурации (cspsconfigtool).
- Откройте диалоговое окно в конце работы программы настройки сервера конфигурации.

1. В окне **Управление учетными записями** щелкните **Добавить учетную запись**. Можно также изменить или удалить существующие учетные записи.

	![Управление учетными записями](./media/site-recovery-vmware-to-azure/ASRVMWare_ManageAccount.png)

2. В окне **Сведения об учетной записи** укажите имя учетной записи для использования в Azure и учетные данные (имя пользователя и домен).

	![Управление учетными записями](./media/site-recovery-vmware-to-azure/ASRVMWare_AccountDetails.png)

### Подключение к серверу конфигурации 

Существует два способа подключения к серверу конфигурации.

- Через VPN типа «сеть — сеть» или подключение ExpressRoute
- Через Интернет 

Обратите внимание на следующее.

- Интернет-подключение использует конечные точки виртуальных машин в сочетании с общедоступным виртуальным IP-адресом сервера.
- VPN-подключение использует внутренний IP-адрес сервера в сочетании с частными портами конечной точки.
- Решение о том, следует ли подключать (данные об элементах управления и репликации) с локальных серверов к различным выполняемым в Azure серверам компонентов (сервер конфигурации, главный целевой сервер) через VPN-подключение или через Интернет, принимается один раз. Впоследствии этот параметр уже нельзя изменить. Если его необходимо изменить, потребуется повторно развернуть сценарий и снова защитить свои компьютеры.  


## Шаг 3. Развертывание главного целевого сервера

1. В окне **Подготовка целевых ресурсов (Azure)** щелкните **Развернуть главный целевой сервер**.
2. Укажите сведения о главном целевом сервере и учетные данные. Сервер будет развернут в той же сети Azure, что и сервер конфигурации, на котором вы его регистрируете. После завершения процедуры будет создана виртуальная машина Azure с образом коллекции Windows или Linux.

	![Параметры целевого сервера](./media/site-recovery-vmware-to-azure/ASRVMWare_TSDetails.png)

Обратите внимание, что первые четыре IP-адреса в любой подсети зарезервированы для внутреннего использования Azure. Укажите любой другой доступный IP-адрес.

3. Виртуальная машина главного целевого сервера Windows создается со следующими конечными точками.

	- Пользовательский: общий порт используется сервером обработки для отправки данных репликации через Интернет. Частный порт 9443 используется сервером обработки для отправки данных репликации на главный целевой сервер через VPN.
	- Пользовательский1: общий порт используется сервером обработки для отправки метаданных элементов управления через Интернет. Частный порт 9080 используется сервером обработки для отправки метаданных элементов управления на главный целевой сервер через VPN.
	- PowerShell: частный порт 5986.
	- Удаленный рабочий стол: частный порт 3389.

4. Виртуальная машина главного целевого сервера Linux создается со следующими конечными точками.

	- Пользовательский: общий порт используется сервером обработки для отправки данных репликации через Интернет. Частный порт 9443 используется сервером обработки для отправки данных репликации на главный целевой сервер через VPN.
	- Пользовательский1: общий порт используется сервером обработки для отправки метаданных элементов управления через Интернет. Частный порт 9080 используется сервером обработки для отправки данных о элементах управления на главный целевой сервер через VPN-подключение.
	- SSH: частный порт 22

    >[AZURE.WARNING]Не удаляйте и не изменяйте номер общего или частного порта для любой из конечных точек, созданных во время развертывания главного целевого сервера.

5. На странице **Виртуальные машины** дождитесь запуска виртуальной машины.

	- При настройке сервера Windows запишите сведения об удаленном рабочем столе.
	- При настройке сервера Linux и подключении через VPN запишите внутренний IP-адрес виртуальной машины. При подключении через Интернет запишите общедоступный IP-адрес.

6.  Войдите в систему сервера, чтобы завершить установку и зарегистрировать его на сервере конфигурации.
7.  На сервере под управлением Windows

	1. Запустите подключение удаленного рабочего стола к виртуальной машине. При первом входе в систему в окне PowerShell запустится сценарий. Не закрывайте окно. После выполнения сценария автоматически откроется окно средства настройки агента узла (Host Agent Config) для регистрации сервера.
	2. В средстве **Host Agent Config** укажите внутренний IP-адрес сервера конфигурации и порт 443. Можно использовать внутренний адрес и частный порт 443, даже если подключение выполняется не в режиме VPN, так как виртуальная машина присоединена к той же сети Azure, что и сервер конфигурации. Оставьте параметр **Использовать HTTPS** включенным. Введите парольную фразу для сервера конфигурации, записанную ранее. Нажмите кнопку **ОК**, чтобы зарегистрировать сервер. Примечание. Параметры преобразования сетевых адресов (NAT) на странице можно игнорировать. Они не используются.
	3. Если по оценкам устройству сохранения требуется более 1 ТБ, необходимо настроить том сохранения (R:) с помощью виртуального диска и [дисковых пространств](http://blogs.technet.com/b/askpfeplat/archive/2013/10/21/storage-spaces-how-to-configure-storage-tiers-with-windows-server-2012-r2.aspx).
	
	![Главный целевой сервер Windows](./media/site-recovery-vmware-to-azure/ASRVMWare_TSRegister.png)

8. На сервере под управлением Linux
	1. В окне **Подготовка целевых ресурсов (Azure)** щелкните **Скачать и установить дополнительное программное обеспечение (только для основного целевого сервера Linux)**, чтобы скачать пакет главного целевого сервера Linux. Скопируйте загруженный TAR-файл в виртуальную машину с помощью клиента SFTP. Можно также войти на развернутый главный целевой сервер Linux и использовать *wget http://go.microsoft.com/fwlink/?LinkID=529757&clcid=0x409* для скачивания файла. 2. Войдите в систему сервера, используя клиент SSH. Примечание. Если подключение к сети Azure выполняется через VPN, используйте внутренний IP-адрес. В противном случае используйте внешний IP-адрес и общедоступную конечную точку SSH.
	3. Извлеките файлы из пакета gzip установщика, выполнив команду: **tar –xvzf Microsoft-ASR_UA_8.2.0.0_RHEL6-64*** ![Главный целевой сервер Linux](./media/site-recovery-vmware-to-azure/ASRVMWare_TSLinuxTar.png)
	4. Перейдите в каталог, в который вы извлекли содержимое TAR-файла.
	5. Скопируйте парольную фразу сервера конфигурации в локальный файл с помощью команды **echo *`<passphrase>`* >passphrase.txt**.
	6. Выполните команду "**sudo ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i *`<Configuration server internal IP address>`* -p 443 -s y -c https -P passphrase.txt**".

	![Регистрация целевого сервера](./media/site-recovery-vmware-to-azure/Linux-MT-install.png)

9. Подождите несколько минут (10–15), а затем на странице **Серверы** > **Серверы конфигурации** убедитесь, что главный целевой сервер указан на вкладке **Сведения о сервере** как зарегистрированный. Если не удалось зарегистрировать сервер под управлением Linux, снова запустите средство настройки узла из каталога /usr/local/ASR/Vx/bin/hostconfigcli. Вам потребуется настроить разрешения доступа, запустив chmod с правами привилегированного пользователя.

	![Проверка целевого сервера](./media/site-recovery-vmware-to-azure/ASRVMWare_TSList.png)

>[AZURE.NOTE]Обратите внимание на то, что после регистрации может потребоваться до 15 минут для того, чтобы главный целевой сервер появился в разделе сервера конфигурации. Для немедленного обновления сведений обновите сервер конфигурации, нажав кнопку «Обновить» в нижней части страницы серверов конфигурации.

## Шаг 4. Развертывание локального сервера обработки

>[AZURE.NOTE]Рекомендуется настроить статический IP-адрес на сервере обработки, чтобы он гарантированно сохранял состояние между перезагрузками.

1. На странице быстрого запуска щелкните **Install Process Server on-premises** (Локальная установка сервера обработки) > **Download and install the process server** (Скачать и установить сервер обработки).

	![Установка сервера обработки](./media/site-recovery-vmware-to-azure/ASRVMWare_PSDeploy.png)

2. Скопируйте загруженный ZIP-файл на сервер, на котором вы собираетесь установить сервер обработки. ZIP-файл содержит два файла установки:

	- Microsoft-ASR_CX_TP_8.3.0.0_Windows*
	- Microsoft-ASR_CX_8.3.0.0_Windows*

3. Распакуйте архив и скопируйте установочные файлы в папку на сервере.
4. Запустите файл установки **Microsoft-ASR_CX_TP_8.3.0.0_Windows*** и выполните инструкции. При этом будут установлены сторонние компоненты, необходимые для развертывания.
5. Затем запустите файл **Microsoft-ASR_CX_8.3.0.0_Windows***.
6. На странице **Server Mode** (Режим сервера) выберите **Process Server** (Сервер обработки).

	![Режим выбора сервера](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerSelection.png)

7. На странице **Сведения о среде** выполните следующие действия.


	- Если вы хотите защитить виртуальные машины VMware, выберите **Да**.
	- Если вы хотите защитить только физические серверы и устанавливать VMware vCLI на сервере обработки не требуется, щелкните **Нет** и продолжите работу.
		
	![Регистрация сервера конфигурации](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerVirtualPhysical.png)

8. При установке VMware vCLI обратите внимание на следующее.

	- **Поддерживается только VMware vSphere CLI 5.5.0**. Сервер обработки не работает с другими версиями или обновлениями vSphere CLI.
	- Скачайте vSphere CLI 5.5.0 [здесь.](https://my.vmware.com/web/vmware/details?downloadGroup=VCLI550&productId=352)
	- Если вы установили vSphere CLI непосредственно перед началом установки сервера обработки и программа установки не обнаруживает ее, подождите до пяти минут, прежде чем повторить попытку установки. Это обеспечит правильную инициализацию всех переменных среды, необходимых для обнаружения vSphere CLI.

8.	В окне **NIC Selection for Process Server** (Выбор сетевой карты для сервера обработки) выберите сетевой адаптер, который сервер обработки должен использовать.

	![Выбор адаптера](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerNICSelection.png)

9.	В окне **Configuration Server Details** (Сведения о сервере конфигурации) выполните следующие действия.

	- При подключении по VPN укажите внутренний IP-адрес сервера конфигурации и порт 443. В противном случае укажите общедоступный виртуальный IP-адрес и сопоставленную общедоступную конечную точку HTTP.
	- Введите парольную фразу сервера конфигурации.
	- Снимите флажок **Verify Mobility service software signature** (Проверять подпись программного обеспечения службы Mobility), если вы хотите отключить проверку при использовании автоматической принудительной установки службы. Проверка подписи требует наличия подключения к Интернету с сервера обработки.
	- Нажмите кнопку **Далее**.

	![Регистрация сервера конфигурации](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerConfigServer.png)


11. В окне **Select Installation Drive** (Выбор установочного диска) выберите диск кэша. Серверу обработки требуется диск кэша хотя бы с 600 ГБ свободного пространства. Нажмите **Install** (Установить).

	![Регистрация сервера конфигурации](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerCacheConfig.png)

12. Для завершения установки может потребоваться перезапустить сервер. Проверьте отображение и успешность регистрации сервера обработки в хранилище, выбрав пункты **Сервер конфигурации** > **Сведения о сервере**.

>[AZURE.NOTE]После регистрации может потребоваться до 15 минут для того, чтобы сервер обработки появился в разделе сервера конфигурации. Для немедленного обновления сведений обновите сервер конфигурации, нажав кнопку «Обновить» в нижней части страницы сервера конфигурации.
 
![Проверка сервера обработки](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerRegister.png)

Если вы не отключили проверку подписи для службы Mobility Service при регистрации сервера обработки, это можно сделать позднее следующим образом.

1. Войдите в систему сервера обработки с правами администратора и откройте файл C:\pushinstallsvc\pushinstaller.conf для редактирования. В разделе **[PushInstaller.transport]** добавьте следующую строку: **SignatureVerificationChecks="0"**. Сохраните и закройте файл.
2. Перезапустите службу InMage PushInstall.


## Шаг 5. Установка последних обновлений

Прежде чем продолжить, убедитесь, что установлены последние обновления. Не забудьте, что обновления нужно устанавливать в следующем порядке.

1. Сервер конфигурации
2. Сервер обработки
3. Главный целевой сервер

Обновления можно получить на **панели мониторинга **Site Recovery. Для установки Linux извлеките файлы из сжатого программой gzip установщика и выполните команду "sudo ./install" для установки обновления

При использовании виртуальных машин или физических серверов, на которых уже установлена служба Mobility Service, обновления для этой службы можно получить следующим образом.

- Загрузить обновления для службы можно и следующим образом.
	- [Windows Server (только 64-разрядная версия)](http://download.microsoft.com/download/7/C/7/7C70CA53-2D8E-4FE0-BD85-8F7A7A8FA163/Microsoft-ASR_UA_8.3.0.0_Windows_GA_03Jul2015_release.exe)
	- [CentOS 6.4,6.5,6.6 (только 64-разрядная версия)](http://download.microsoft.com/download/B/4/5/B45D1C8A-C287-4339-B60A-70F2C7EB6CFE/Microsoft-ASR_UA_8.3.0.0_RHEL6-64_GA_03Jul2015_release.tar.gz)
	- [Oracle Enterprise Linux 6.4,6.5 (только 64-разрядная версия)](http://download.microsoft.com/download/9/4/8/948A2D75-FC47-4DED-B2D7-DA4E28B9E339/Microsoft-ASR_UA_8.3.0.0_OL6-64_GA_03Jul2015_release.tar.gz)
	- [SUSE Linux Enterprise Server SP3 (только 64-разрядная версия)](http://download.microsoft.com/download/6/A/2/6A22BFCD-E978-41C5-957E-DACEBD43B353/Microsoft-ASR_UA_8.3.0.0_SLES11-SP3-64_GA_03Jul2015_release.tar.gz)
- Кроме того, после обновления сервера обработки можно получить обновленную версию службы Mobility Service из папки C:\pushinstallsvc\repository на сервере обработки.


## Шаг 6. Добавление серверов vCenter или ESXi узлов

1. На вкладке **Серверы** > **Серверы конфигурации** выберите сервер конфигурации и щелкните **Добавить сервер v-Center**, чтобы добавить сервер vCenter или узел ESXi.

	![Выбор сервера vCenter](./media/site-recovery-vmware-to-azure/ASRVMWare_AddVCenter.png)

2. Укажите сведения для сервера vCenter или узла ESXi и выберите сервер обработки, который будет использоваться для его обнаружения.

	- Если сервер vCenter не работает через порт 443 по умолчанию, укажите номер порта, через который работает сервер vCenter.
	- Сервер обработки должен быть в той же подсети, что и сервер vCenter/узел ESXi, и на нем должен быть установлен VMware vSphere CLI 5.5.0.

	![Параметры сервера vCenter](./media/site-recovery-vmware-to-azure/ASRVMWare_AddVCenter4.png)


3. После завершения обнаружения сервер vCenter будет указан в разделе сведений о сервере конфигурации.

	![Параметры сервера vCenter](./media/site-recovery-vmware-to-azure/ASRVMWare_AddVCenter2.png)

4. Если для добавления сервера vCenter или ESXi узла используется учетная запись без прав администратора, она должна иметь следующие права.

	- Для учетных записей vCenter должны быть включены привилегии центра обработки данных, хранилища данных, папки, узла, сети, ресурса, представлений хранилища, виртуальной машины и распределенного коммутатора vSphere.
	- Для учетных записей узла ESXi должны быть включены привилегии центра обработки данных, хранилища данных, папки, узла, сети, ресурса, виртуальной машины и распределенного коммутатора vSphere.



## Шаг 7. Создание группы защиты

1. Откройте вкладку **Защищенные элементы** > **Группа защиты** и щелкните, чтобы добавить группу защиты.

	![Создание группы защиты](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG1.png)

2. На странице **Задать настройки группы защиты** укажите имя для группы и выберите сервер конфигурации, на котором требуется создать группу.

	![Параметры группы защиты](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG2.png)

3. На странице **Задайте настройки репликации** настройте параметры репликации, которые будут использоваться для всех компьютеров в группе.

	![Репликация группы защиты](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG3.png)

4. Параметры
	- **Согласование с несколькими виртуальными машинами**. При включении этого параметра создаются общие точки восстановления, соответствующие приложениям, для компьютеров в группе защиты. Этот параметр имеет самое большое значение, когда на всех компьютерах в группе защиты выполняется одна и та же рабочая нагрузка. Все компьютеры будут восстановлены до одной точки данных. Доступно только для серверов Windows.
	- **Пороговое значение RPO**. При превышении значением RPO непрерывной репликации защиты данных заданного порогового значения RPO будут выдаваться оповещения.
	- **Хранение точки восстановления**: задает окно сохранения. Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
	- **Периодичность моментальных снимков с согласованием приложений**. Указывает, насколько часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями.

Создание групп защиты можно отслеживать на странице **Защищенные элементы**.

## Шаг 8. Настройка компьютеров, которые необходимо защитить

Необходимо установить службу Mobility Service на виртуальных машинах и физических серверах, которые требуется защитить. Это можно сделать двумя способами.

- Автоматическая принудительная установка службы на каждом компьютере с сервера обработки.
- Установка службы вручную. 

### Автоматическая установка службы Mobility Service

При добавлении компьютеров в группу защиты служба Mobility автоматически принудительно устанавливается на каждый компьютер сервером обработки.

**Автоматическая принудительная установка службы Mobility Service на серверах Windows:**

1. Установите последние обновления для сервера обработки, как описано в подразделе [Шаг 5. Установка последних обновлений] (#последние обновления), и убедитесь в том, что сервер обработки доступен. 
2. Убедитесь в наличии сетевого подключения между исходным компьютером и сервером обработки, а также в доступности исходного компьютера с сервера обработки.  
3. Настройте в брандмауэре Windows разрешение **Общий доступ к файлам и принтерам** и **Инструментарий управления Windows**. В группе параметров брандмауэра Windows выберите параметр «Разрешение взаимодействия с приложением или компонентом в брандмауэре Windows» и выберите приложения, как показано на рисунке ниже. Для компьютеров, принадлежащих домену, можно настроить политику брандмауэра с помощью объекта групповой политики.

	![Параметры брандмауэра](./media/site-recovery-vmware-to-azure/ASRVMWare_PushInstallFirewall.png)

4. Учетная запись, используемая для принудительной установки, должна входить в группу «Администраторы» на защищаемом компьютере. Эти учетные данные используются только для принудительной установки службы Mobility Service и указываются при добавлении компьютера в группу защиты.
5. Если предоставленная учетная запись не является учетной записью домена, вам потребуется отключить контроль доступа удаленных пользователей на локальном компьютере. Для этого в разделе реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System добавьте запись LocalAccountTokenFilterPolicy DWORD и задайте для нее значение 1. Чтобы добавить запись в реестр из интерфейса командной строки, откройте cmd или powershell и введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**. 

**Автоматическая принудительная установка службы Mobility Service на серверах Linux**

1. Установите последние обновления для сервера обработки, как описано в подразделе [Шаг 5. Установка последних обновлений] (#последние обновления), и убедитесь в том, что сервер обработки доступен.
2. Убедитесь в наличии сетевого подключения между исходным компьютером и сервером обработки, а также в доступности исходного компьютера с сервера обработки.  
3. Убедитесь, что учетная запись принадлежит привилегированному пользователю на исходном сервере Linux.
4. Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых карт.
5. Установите последние пакеты openssh, openssh-server, openssl на защищаемом компьютере.
6. Убедитесь, что служба SSH включена и работает через порт 22. 
7. Включите подсистему SFTP и проверку подлинности с помощью пароля в файле sshd_config следующим образом: 

	- а) выполните вход в качестве привилегированного пользователя;
	- б) в файле /etc/ssh/sshd_config найдите строку, которая начинается с **PasswordAuthentication**;
	- в) раскомментируйте строку и измените значение с no на yes;

		![Мобильность Linux](./media/site-recovery-vmware-to-azure/ASRVMWare_LinuxPushMobility1.png)

	- г) найдите строку, которая начинается с Subsystem, и раскомментируйте ее.
	
		![Принудительная мобильность Linux](./media/site-recovery-vmware-to-azure/ASRVMWare_LinuxPushMobility2.png)

8. Убедитесь, что поддерживается вариант исходного компьютера Linux.
 
### Установка службы Mobility Service вручную

Пакеты программного обеспечения, используемые для установки службы Mobility Service, находятся в каталоге C:\pushinstallsvc\repository сервера обработки. Войдите на сервер обработки и скопируйте соответствующий установочный пакет на исходный компьютер, руководствуясь приведенной ниже таблицей.

| Исходная операционная система | Пакет службы Mobility Service на сервере обработки |
|---------------------------------------------------	|------------------------------------------------------------------------------------------------------	|
| Windows Server (только 64-разрядная версия) | `C:\pushinstallsvc\repository\Microsoft-ASR_UA_8.3.0.0_Windows_GA_03Jul2015_release.exe` |
| CentOS 6.4, 6.5, 6.6 (только 64-разрядная версия) | `C:\pushinstallsvc\repository\Microsoft-ASR_UA_8.3.0.0_RHEL6-64_GA_03Jul2015_Release.tar.gz` |
| SUSE Linux Enterprise Server 11 SP3 (только 64-разрядная версия) | `C:\pushinstallsvc\repository\Microsoft-ASR_UA_8.3.0.0_SLES11-SP3-64_GA_03Jul2015_Release.tar.gz`|
| Oracle Enterprise Linux 6.4, 6.5 (только 64-разрядная версия) | `C:\pushinstallsvc\repository\Microsoft-ASR_UA_8.3.0.0_OL6-64_GA_03Jul2015_Release.tar.gz` |


**Чтобы вручную установить службу Mobility Service на сервере Windows**, выполните следующие действия.

1. Скопируйте пакет **Microsoft-ASR_UA_8.2.0.0_Windows_PREVIEW_20Mar2015_Release.exe** с из каталога сервера обработки, указанного в приведенной выше таблице, на исходный компьютер.
2. Установите службу Mobility Service, запустив исполняемый файл на исходном компьютере.
3. Следуйте инструкциям установщика.
4. Выберите **Служба Mobility Service** в качестве роли и нажмите кнопку **Далее**.
	
	![Установка службы Mobility Service](./media/site-recovery-vmware-to-azure/ASRVMWare_MobilityServiceInstall1.png)

5. Оставьте в качестве пути установки каталог установки по умолчанию и нажмите кнопку **Установить**.
6. В средстве **Host Agent Config** укажите IP-адрес и порт HTTPS сервера конфигурации.

	- При подключении через Интернет укажите порт общедоступный виртуальный IP-адрес и общедоступную конечную точку в качестве порта HTTPS.
	- При подключении через VPN укажите внутренний IP-адрес и порт 443. Оставьте флажок **Использовать HTTPS** установленным.

	![Установка службы Mobility Service](./media/site-recovery-vmware-to-azure/ASRVMWare_MobilityServiceInstall2.png)

7. Укажите парольную фразу сервера конфигурации и нажмите кнопку **ОК**, чтобы зарегистрировать службу Mobility Service для сервера конфигурации.

**Чтобы выполнить запуск из командной строки:**

1. Скопируйте парольную фразу из CX в файл «C:\connection.passphrase» на сервере и выполните данную команду. В нашем примере CX имеет значение 104.40.75.37, а порт HTTPS имеет значение 62519:

    `C:\Microsoft-ASR_UA_8.2.0.0_Windows_PREVIEW_20Mar2015_Release.exe" -ip 104.40.75.37 -port 62519 -mode UA /LOG="C:\stdout.txt" /DIR="C:\Program Files (x86)\Microsoft Azure Site Recovery" /VERYSILENT  /SUPPRESSMSGBOXES /norestart  -usesysvolumes  /CommunicationMode https /PassphrasePath "C:\connection.passphrase"`

**Установка службы Mobility Service вручную на сервере Linux**

1. Скопируйте соответствующий TAR-архив, согласно приведенной выше таблице, с сервера обработки на исходный компьютер.
2. Откройте программу оболочки и извлеките TAR-архив в формате ZIP по локальному пути, выполнив `tar -xvzf Microsoft-ASR_UA_8.2.0.0*`.
3. Создайте файл passphrase.txt в локальном каталоге, куда вы извлекли содержимое TAR-архива, введя *`echo <passphrase> >passphrase.txt`* из оболочки.
4. Установите службу Mobility Service, введя *`sudo ./install -t both -a host -R Agent -d /usr/local/ASR -i <IP address> -p <port> -s y -c https -P passphrase.txt`*.
5. Укажите IP-адрес и порт:

	- при подключении к серверу конфигурации через Интернет, укажите конфигурации общедоступный виртуальный IP-адрес сервера и общедоступную конечную точку HTTPS в полях `<IP address>` и `<port>`;
	- при подключении через VPN укажите внутренний IP-адрес и порт 443.

**Чтобы выполнить запуск из командной строки:**

1. Скопируйте парольную фразу из CX в файл passphrase.txt на сервере и выполните данную команду. В нашем примере CX имеет значение 104.40.75.37, а порт HTTPS имеет значение 62519:

Установка на рабочем сервере

    ./install -t both -a host -R Agent -d /usr/local/ASR -i 104.40.75.37 -p 62519 -s y -c https -P passphrase.txt
 
Установка на целевом сервере


    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 62519 -s y -c https -P passphrase.txt

>[AZURE.NOTE]При добавлении в группу защиты компьютеров, на которых уже выполняется соответствующая версия службы Mobility Service, принудительная установка пропускается.


## Шаг 9. Включение защиты

Чтобы включить защиту, добавьте виртуальные машины и физические серверы в группу защиты. Перед началом работы обратите внимание на следующее.

- Виртуальные машины обнаруживаются каждые 15 минут, и для их отображения в Azure Site Recovery после обнаружения может потребоваться до 15 минут.
- Изменениям среды на виртуальной машине (таким как установка средств VMware) также может потребоваться до 15 минут на обновление в Site Recovery.
- Последнее время обнаружения можно узнать в поле **Последний контакт в** для сервера vCenter/узла ESXi на странице **Серверы конфигурации**.
- Если вы уже создали группу защиты и после этого добавляете сервер vCenter или узел ESXi, порталу Azure Site Recovery требуется пятнадцать минут для обновления и для отображения виртуальных машин в диалоговом окне **Добавление компьютеров в группу защиты**.
- Если вы хотите немедленно продолжить работу и добавить компьютеры в группу защиты, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и нажмите кнопку **Обновить**.
- При добавлении виртуальных машин или физических компьютеров в группу защиты сервер обработки автоматически выполняет принудительную установку службы Mobility Service на исходном сервере, если она еще не установлена.
- Для правильной работы механизма принудительной установки необходимо настроить защищенные компьютеры, как описано в предыдущем шаге.

Добавьте компьютеры следующим образом.

1. **Защищенные элементы** > **Группа защиты** > вкладка **Компьютеры**. Щелкните **Добавить компьютеры**. Рекомендуется настроить отражение группами защиты рабочих нагрузок, чтобы добавлять компьютеры, на которых выполняется определенное приложение, в одну группу.
2. Если в окне **Выбор виртуальных машин** вы защищаете физические серверы, то укажите в мастере **Добавление физических компьютеров** IP-адрес и понятное имя. После этого выберите семейство операционной системы.

	![Добавление сервера V-Center](./media/site-recovery-vmware-to-azure/ASRVMWare_PhysicalProtect.png)

3. Если в окне **Выбор виртуальных машин** вы защищаете виртуальные машины VMware, выберите сервер vCenter, управляющий виртуальными машинами (или узел EXSi, на котором они выполняются), и выберите компьютеры.

	![Добавление сервера V-Center](./media/site-recovery-vmware-to-azure/ASRVMWare_SelectVMs.png)

4. В окне **Указание целевых ресурсов** выберите главные целевые серверы и хранилище для репликации, а также укажите, следует ли использовать эти параметры для всех виртуальных машин.

	![Сервер vCenter](./media/site-recovery-vmware-to-azure/ASRVMWare_MachinesResources.png)

4. В окне **Specify Accounts** (Указание учетных записей) выберите учетную запись, которую необходимо использовать для установки службы Mobility Service на защищенных компьютерах. Для автоматической установки службы Mobility Service необходимы учетные данные учетной записи. Если вы не можете выбрать учетную запись, выполните настройку, как описано в шаге 2. Обратите внимание, что эта учетная запись недоступна для Azure. Для сервера Windows учетная запись должна иметь права администратора на исходном сервере. Для Linux учетная запись должна иметь права привилегированного пользователя.

	![Учетные данные Linux](./media/site-recovery-vmware-to-azure/ASRVMWare_VMMobilityInstall.png)

5. Установите флажок, чтобы завершить добавление компьютеров в группу защиты и запустить начальную репликацию для каждого компьютера. Ход выполнения можно отслеживать на странице **Задания**.

	![Добавление сервера V-Center](./media/site-recovery-vmware-to-azure/ASRVMWare_PGJobs2.png)

5. Кроме того, можно отслеживать состояние защиты, щелкнув **Защищенные элементы**, выбрав имя группы защиты и щелкнув **Виртуальные машины**. После завершения начальной репликации и синхронизации данных компьютеров для них будет отображаться состояние **Защищено**.

	![Задания виртуальных машин](./media/site-recovery-vmware-to-azure/ASRVMWare_PGJobs.png)


### Настройка свойств защищенных машин

1. После того как компьютерам будет назначено состояние **Защищено**, можно приступить к настройке свойств отработки отказа. В разделе сведений группы защиты выберите компьютер и откройте вкладку **Настройка**.
2. Можно изменить имя, которое будет назначено компьютеру в Azure после отработки отказа, и размер виртуальной машины Azure. Кроме того, вы можете выбрать сеть Azure, к которой будет подключаться компьютер после отработки отказа.

	![Задание свойств виртуальной машины](./media/site-recovery-vmware-to-azure/ASRVMWare_VMProperties.png)

Обратите внимание на следующее.

- Имя компьютера Azure должно соответствовать требованиям Azure.
- По умолчанию реплицированные виртуальные машины в Azure не подключаются к сети Azure. Если требуется обеспечить обмен данными для реплицированных виртуальных машин, настройте для них одну сеть Azure.
- Если изменить размер тома в виртуальной машине VMware или на физическом сервере, они переходят в критическое состояние. Если нужно изменить этот размер, выполните следующие действия:

	- а) измените параметр размера;
	- б) на вкладке **Виртуальные машины** выберите виртуальную машину и нажмите **Удалить**;
	- в) в окне **Удаление виртуальной машины** выберите параметр **Disable protection (use for recovery drill and volume resize)** (Отключить защиту (используется для детализации при восстановлении и изменения размера тома)); Этот параметр отключает защиту, но сохраняет точки восстановления в Azure.

		![Задание свойств виртуальной машины](./media/site-recovery-vmware-to-azure/ASRVMWare_RemoveVM.png)

	- г) снова включите защиту для виртуальной машины. При повторном включении защиты данные для тома с измененным размером будут переданы в Azure.

	

## Шаг 10. Запуск отработки отказа

В настоящее время для защищенных виртуальных машин VMware и физических серверов можно выполнять только незапланированные отработки отказа. Обратите внимание на следующее.



- Прежде чем начать отработку отказа, убедитесь, что серверы конфигурации и главные целевые серверы запущены и работоспособны. В противном случае произойдет сбой отработки отказа.
- В рамках незапланированной отработки отказа работа исходных компьютеров не завершается. Выполнение незапланированной отработки отказа останавливает репликацию данных для защищенных серверов. Вам потребуется удалить компьютеры из группы защиты и добавить их заново, чтобы снова обеспечить их защиту после завершения незапланированной отработки отказа.
- Если вы хотите выполнить отработку отказа без потери данных, перед ее началом убедитесь, что виртуальные машины основного сайта отключены.

1. Перейдите на страницу **Планы восстановления** и добавьте план восстановления. Укажите сведения о плане и выберите в качестве цели **Azure**.

	![Настройка плана восстановления](./media/site-recovery-vmware-to-azure/ASRVMWare_RP1.png)

2. На странице **Выбор виртуальных машин** выберите группу защиты, а затем выберите компьютеры в группе для добавления в план восстановления. Дополнительные сведения о планах восстановления см. [здесь](site-recovery-create-recovery-plans.md).

	![Добавить виртуальные машины](./media/site-recovery-vmware-to-azure/ASRVMWare_RP2.png)

3. При необходимости можно настроить план, создав группы и указав порядок выполнения отработки отказа для виртуальных машин в плане восстановления. Кроме того, можно добавить запросы для выполняемых вручную действий и сценариев. Скрипты восстановления в Azure можно добавить с помощью [модулей Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).

4. На странице **Планы восстановления** выберите план и нажмите кнопку **Внеплановая отработка отказа**.
5. В окне **Подтвердить обработку отказа** проверьте направление отработки отказа (в Azure) и выберите точку восстановления, до которой будет выполняться отработка отказа.
6. Дождитесь завершения выполнения задания отработки отказа, а затем убедитесь, что отработка отказа была выполнена правильно и реплицированные виртуальные машины успешно запускаются в Azure.




## Шаг 11. Восстановление размещения компьютеров, для которых была выполнена отработка отказа, из Azure

[Узнайте подробнее](site-recovery-failback-azure-to-vmware.md) о том, как перенести запущенные в Azure компьютеры, для которых была выполнена отработка отказа, обратно в локальную среду.


## Управление серверами обработки

Сервер обработки отправляет данные репликации на главный целевой сервер в Azure и обнаруживает новые виртуальные машины VMware, добавленные на сервер vCenter. В следующих случаях может потребоваться изменить сервер обработки в развертывании.

- Если текущий сервер обработки выходит из строя.
- Если цель точки восстановления (RPO) возрастает до недопустимого для вашей организации уровня.

При необходимости можно переместить репликацию некоторых или всех локальных виртуальных машин VMware и физических серверов на другой сервер обработки. Например:

- **Сбой** — если сервер обработки неисправен или недоступен, репликацию защищенного компьютера можно переместить на другой сервер обработки. Метаданные исходного компьютера и компьютера-реплики перемещаются на новый сервер обработки, и выполняется повторная синхронизация данных. Новый сервер обработки автоматически подключится к серверу vCenter для выполнения автоматического обнаружения. Вы можете отслеживать состояние серверов обработки на панели мониторинга Site Recovery.
- **Балансировка нагрузки для корректировки RPO** — для улучшения балансировки нагрузки можно выбрать другой сервер обработки на портале Site Recovery и переместить на него репликацию одного или нескольких компьютеров для ручной балансировки нагрузки. В этом случае метаданные выбранного исходного компьютера и компьютера-реплики перемещаются на новый сервер обработки. Исходный сервер обработки остается подключенным к серверу vCenter. 

### Мониторинг сервера обработки

Если сервер обработки находится в критическом состоянии, на панели мониторинга Site Recovery отображается предупреждение о состоянии. Щелкните состояние, чтобы открыть вкладку «События», а затем перейдите к конкретным заданиям на вкладке «Задания».

### Изменение сервера обработки, используемого для репликации

1. Кроме того, на портале Azure можно щелкнуть **Виртуальные машины** > *сервер_конфигурации* > **Сведения о сервере**.
2. В списке **Серверы обработки** щелкните элемент **Change Process Server** (Изменить сервер обработки) рядом с тем сервером, который требуется изменить.
3. В диалоговом окне **Change Process Server** (Изменить сервер обработки) выберите новый сервер в списке **Target Process Server** (Целевой сервер обработки), а затем выберите виртуальные машины, которые требуется реплицировать на новый сервер. Щелкните значок сведений рядом с именем сервера, чтобы получить сведения о нем, включая свободное пространство и объем использованной памяти. Чтобы помочь вам принять решение о загрузке, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки.
4. Установите флажок, чтобы начать репликацию на новом сервере обработки При удалении всех виртуальных машин с сервера обработки, находившегося в критическом состоянии, он больше не должен выводить критическое предупреждение на панели мониторинга.


## Уведомления и сведения о стороннем программном обеспечении

Не подлежит переводу и локализации

Программное обеспечение и встроенное ПО, выполняющееся в продуктах или службах Майкрософт, основано на или включает материалы из проектов, перечисленных ниже (собирательно — «сторонний код»). Корпорация Майкрософт не является автором стороннего кода. Исходные уведомления об авторских правах и лицензии, в рамках которых корпорация Майкрософт получила такой сторонний код, приведены ниже.

Сведения в разделе А относятся к компонентам стороннего кода из проектов, перечисленных ниже. Такие лицензии и сведения приводятся только в информационных целях. Этот сторонний код предоставляется вам в рамках повторной лицензии Майкрософт согласно условиям лицензирования программного обеспечения Майкрософт для продуктов или служб Майкрософт.

Сведения в разделе B относятся к компонентам стороннего кода, предоставляемым вам корпорацией Майкрософт в рамках первоначальной лицензии.

Полный файл можно найти в [Центре загрузки Майкрософт](http://go.microsoft.com/fwlink/?LinkId=530254). Корпорация Майкрософт оставляет за собой все права, не предоставленные явно в настоящем документе, косвенно, в силу конклюдентных действий или иным образом.

<!---HONumber=July15_HO4-->