---
title: "Репликация виртуальных машин VMware в Azure | Документация Майкрософт"
description: "В этой статье кратко описаны шаги для репликации рабочих нагрузок, запущенных на виртуальных машинах VMware, в хранилище Azure"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: dab98aa5-9c41-4475-b7dc-2e07ab1cfd18
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/12/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: 1429bf0d06843da4743bd299e65ed2e818be199d
ms.openlocfilehash: c2e21eefff3ce501ee5fc4003f60df25c4d7665d
ms.lasthandoff: 03/22/2017


---
# <a name="replicate-vmware-virtual-machines-to-azure-with-site-recovery"></a>Репликация виртуальных машин VMware в Azure с помощью Site Recovery

> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmware-to-azure.md)
> * [Классическая модель Azure](site-recovery-vmware-to-azure-classic.md)


В этой статье описано, как выполнить репликацию локальных виртуальных машин VMware в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md) на портале Azure.

Если ваша цель — миграция виртуальных машин VMware в Azure (только отработка отказа), изучите дополнительные сведения из [этой статьи](site-recovery-migrate-to-azure.md).

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="deployment-steps"></a>Шаги по развертыванию

Необходимо сделать следующее:

1. Выполните предварительные требования и ознакомьтесь с ограничениями.
2. Настройте сеть и учетные записи хранения Azure.
3. Подготовьте локальный компьютер, который необходимо развернуть в качестве сервера конфигурации.
4. Подготовьте учетные записи VMware, которые будут использоваться для автоматического обнаружения виртуальных машин и при необходимости для принудительной установки службы мобильности.
4. Создайте хранилище служб восстановления, которое содержит параметры конфигурации и управляет репликацией.
5. Укажите источник, целевой объект и параметры репликации.
6. Разверните службу мобильности на виртуальных машинах, которые необходимо реплицировать.
7. Включите репликацию для виртуальных машин.
7. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

## <a name="prerequisites"></a>Предварительные требования

**Необходимая поддержка** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** | Ознакомьтесь с [требованиями Azure](site-recovery-prereq.md#azure-requirements).
**Локальный сервер конфигурации** | Вам потребуется виртуальная машина VMware под управлением Windows Server 2012 R2 или более поздней версии. Настройте этот сервер при развертывании Site Recovery.<br/><br/> По умолчанию сервер обработки и главный целевой сервер также устанавливаются на эту виртуальную машину. При увеличении масштаба вам может понадобиться отдельный сервер обработки. К нему выдвигаются те же требования, что и к серверу конфигурации.<br/><br/> Узнайте больше об этих компонентах [здесь](site-recovery-set-up-vmware-to-azure.md#configuration-server-minimum-requirements).
**Локальные серверы VMware** | Один или несколько серверов VMware vSphere (версии 6.0, 5.5 или 5.1 с последними обновлениями). Серверы должны находиться в той же сети, где расположен сервер конфигурации (или отдельный сервер обработки).<br/><br/> Желательно использовать сервер vCenter для управления узлами (версии 6.0 или 5.5 с последними обновлениями). При развертывании версии 6.0 поддерживаются только функции, доступные в версии 5.5.
**Локальные виртуальные машины** | Виртуальные машины, которые необходимо реплицировать, должны работать под управлением [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions) и соответствовать [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements). На виртуальных машинах должны быть запущены средства VMware.
**URL-адреса** | Серверу конфигурации требуется доступ к следующим URL-адресам.<br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/></br> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).<br/></br> Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).<br/><br/> Разрешите доступ к URL-адресу http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi для скачивания MySQL.
**Служба Mobility Service** | Должна быть установлена на каждой реплицированной виртуальной машине.




## <a name="limitations"></a>Ограничения

**Ограничения** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** | Учетные записи хранилища и сети должны находиться в том же регионе, что и хранилище.<br/><br/> При использовании учетной записи хранилища класса Premium для хранения журналов репликации также понадобится учетная запись хранилища класса Standard.<br/><br/> Нельзя выполнить репликацию в учетные записи класса Premium в регионах "Центральная Индия" и "Южная Индия".
**Локальный сервер конфигурации** | Тип адаптера виртуальной машины VMware должен быть VMXNET3. В обратном случае [установите это обновление](https://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&docType=kc&externalId=2110245&sliceId=1&docTypeID=DT_KB_1_1&dialogID=26228401&stateId=1).<br/><br/> Должен быть установлен vSphere PowerCLI 6.0.<br/><br> Компьютер не должен быть контроллером домена. Компьютеру должен быть присвоен статический IP-адрес.<br/><br/> Имя узла должно содержать 15 знаков или меньше, а операционная система должна быть на английском языке.
**VMware** | В vCenter 6.0 поддерживаются только функции версии 5.5. Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища.
**Виртуальные машины** | Проверьте [ограничения виртуальной машины Azure](site-recovery-prereq.md#azure-requirements).<br/><br/> Нельзя реплицировать виртуальные машины с зашифрованными дисками или дисками с типом загрузки UEFI или EFI.<br/><br> Кластеры общих дисков не поддерживаются. Если исходная виртуальная машина содержит объединение сетевых адаптеров, то после отработки отказа оно преобразуется в единый сетевой адаптер.<br/><br/> При использовании диска iSCSI на виртуальной машине после отработки отказа Site Recovery преобразует его в VHD-файл. Если виртуальная машина Azure может получить доступ к целевому объекту iSCSI, она подключится к нему и будет использовать и этот диск, и диск VHD. В таком случае отключите целевой объект iSCSI.<br/><br/> Если вы хотите поддерживать согласованность нескольких виртуальных машин, благодаря чему виртуальные машины с одинаковой рабочей нагрузкой могут совместно восстанавливаться до согласованной точки данных, откройте порт 20004 на виртуальной машине.<br/><br/> Windows необходимо установить на диск C. Диск операционной системы должен быть базовым, а не динамическим. Диск данных может быть динамическим.<br/><br/> Файлы Linux /etc/hosts на виртуальных машинах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров. Имена узлов, точки подключения, имена устройств и системные пути и имена файлов (/etc, /usr) должны быть только на английском языке.<br/><br/> Поддерживаются определенные типы [хранилищ Linux](site-recovery-support-matrix-to-azure.md#support-for-storage).<br/><br/>Создайте или задайте в параметрах виртуальной машины **disk.enableUUID=true**. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK и гарантирует, что во время восстановления размещения на локальный компьютер будут переноситься только разностные изменения без полной репликации.

## <a name="set-up-azure"></a>Настройка Azure

1. [Настройте сеть Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md).
    - Виртуальные машины Azure будут размещаться в этой сети при создании после отработки отказа.
    - Сеть можно настроить с помощью [Resource Manager](../resource-manager-deployment-model.md) или классической модели.

2. Настройте [учетную запись хранения Azure](../storage/storage-create-storage-account.md#create-a-storage-account) для реплицированных данных.
    - Учетная запись может быть класса Standard или [Premium](../storage/storage-premium-storage.md).
    - Учетную запись можно настроить с помощью Resource Manager или классической модели.

3. [Подготовьте учетную запись](#prepare-for-automatic-discovery-and-push-installation) на сервере vCenter или узлах vSphere, чтобы служба Site Recovery могла автоматически обнаруживать виртуальные машины VMware.

## <a name="prepare-the-configuration-server"></a>Подготовить сервер конфигурации

1. Установите на виртуальной машине VMware Windows Server 2012 R2 или более поздней версии.
2. Убедитесь, что виртуальная машина имеет доступ к URL-адресам, перечисленным в разделе [Предварительные требования](#prerequisites).
3. Установите сервер [VMware vSphere PowerCLI 6.0](https://developercenter.vmware.com/tool/vsphere_powercli/6.0).


## <a name="prepare-for-automatic-discovery-and-push-installation"></a>Подготовка к автоматическому обнаружению и принудительной установке

- **Подготовка учетной записи к автоматическому обнаружению.** Сервер обработки Site Recovery обнаруживает виртуальные машины автоматически. Для этого Site Recovery необходимы учетные данные, которые предоставляют доступ к серверам vCenter и узлам vSphere ESXi.

    1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter с этими [разрешениями](#vmware-account-permissions). Присвойте ей имя, например **Azure_Site_Recovery**.
    2. Создайте пользователя на узле vSphere или на сервере vCenter и назначьте ему роль. Укажите эту учетную запись пользователя во время развертывания Site Recovery.

- **Подготовка учетной записи для принудительной установки службы мобильности.** Если требуется принудительно установить службу мобильности на виртуальные машины, необходимо использовать учетную запись, которая может использоваться сервером обработки для доступа к виртуальной машине. Эта учетная запись предназначена только для принудительной установки. Можно использовать доменную или локальную учетную запись.

    - Для Windows, если учетная запись домена не используется, на локальном компьютере потребуется отключить контроль удаленного доступа пользователей. Для этого в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись **LocalAccountTokenFilterPolicy** DWORD и задайте для нее значение 1.
    - Если требуется добавить запись в реестр Windows из командной строки, введите:   ``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``
    - Для Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]

## <a name="select-the-protection-goal"></a>Выбор целевого объекта защиты

Выберите целевые объекты и место для репликации.

1. Щелкните **Хранилища служб восстановления** > хранилище.
2. В меню ресурсов щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals.png)
3. На странице **Цель защиты** выберите **В Azure** > **Да, с использованием низкоуровневой оболочки VMware vSphere**.

    ![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals2.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Настройте сервер конфигурации, зарегистрируйте его в хранилище и найдите виртуальные машины.

1. Щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Источник**.
2. Если у вас нет сервера конфигурации, щелкните **+Configuration server** (+ Сервер конфигурации).

    ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source1.png)
3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
4. Скачайте файл единой установки Site Recovery.
5. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение пяти дней после создания.

   ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source2.png)


## <a name="run-site-recovery-unified-setup"></a>Выполнение единой установки Site Recovery

Прежде чем начать, выполните приведенные ниже действия, после чего запустите программу единой установки, чтобы установить сервер конфигурации, сервер обработки и главный целевой сервер.
    - Посмотрите краткий видеообзор:

        > [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video1-Source-Infrastructure-Setup/player]

    - Убедитесь, что на виртуальной машине сервера конфигурации системные часы синхронизированы с [сервером времени](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/get-started/windows-time-service/windows-time-service). Значения времени должны совпадать. Если системные часы отстают или спешат в пределах 15 минут, установка может завершиться ошибкой.
    - На виртуальной машине сервера конфигурации запустите программу установки от имени локального администратора.
    - Включите на компьютере протокол TLS 1.0.


[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]

> [!NOTE]
> Сервер конфигурации можно также установить [с помощью командной строки](http://aka.ms/installconfigsrv).



### <a name="add-the-account-for-automatic-discovery"></a>Добавление учетной записи, используемой для автоматического обнаружения

[!INCLUDE [site-recovery-add-vcenter-account](../../includes/site-recovery-add-vcenter-account.md)]

### <a name="connect-to-vmware-servers"></a>Подключение к серверам VMware

Подключитесь к узлам vSphere ESXi или серверам vCenter для обнаружения виртуальных машин VMware.

- При добавлении сервера vCenter или узлов vSphere с помощью учетной записи без прав администратора на сервере ей должны быть назначены следующие привилегии:
    - привилегии центра обработки данных, хранилища данных, папки, узла, сети, ресурса, виртуальной машины и распределенного коммутатора vSphere;
    - для сервера vCenter требуются разрешения на использование представлений хранилища.
- После добавления серверов VMware может пройти более 15 минут, прежде чем они будут обнаружены и отображены на портале.
Чтобы служба Azure Site Recovery могла обнаруживать виртуальные машины, запущенные в локальной среде, сервер VMware vCenter Server или узлы vSphere ESXi необходимо подключить к этой службе.

Нажмите кнопку **+vCenter** (+ vCenter Server), чтобы начать установку подключения сервера VMware vCenter Server или узла vSphere ESXi.

[!INCLUDE [site-recovery-add-vcenter](../../includes/site-recovery-add-vcenter.md)]

Site Recovery подключается к серверам VMware, используя указанные вами параметры, и обнаруживает виртуальные машины.

## <a name="set-up-the-target"></a>Настройка цели

Перед настройкой целевой среды убедитесь, что у вас есть [учетная запись хранения Azure и сеть](#set-up-azure).

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите, какая целевая модель развертывания используется: классическая или Resource Manager.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Цель](./media/site-recovery-vmware-to-azure/gs-target.png)
4. Если вы еще не создали учетную запись хранения или сеть, щелкните **+Учетная запись хранения** или **+Сеть**, чтобы создать учетную запись Resource Manager или сеть.

## <a name="set-up-replication-settings"></a>Настройка параметров репликации

Перед началом посмотрите краткий видеообзор:
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video2-vCenter-Server-Discovery-and-Replication-Policy/player]

1. Чтобы создать новую политику репликации, щелкните **Инфраструктура Site Recovery** > **Политики репликации** > **+Политика репликации**.
2. На странице **Создать политику репликации** укажите имя политики.
3. В поле **Пороговое значение RPO**укажите предельное значение целевой точки восстановления (RPO). Это значение указывает, как часто создаются точки восстановления данных. Если непрерывная репликация превышает это значение, выдаются оповещения.
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов, а для хранилище класса Standard — до 72 часов.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений**укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений. Нажмите кнопку **ОК** , чтобы создать политику.

    ![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication2.png)
8. Созданная политика автоматически сопоставляется с облаком сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.  



## <a name="plan-capacity"></a>Планирование ресурсов

1. Теперь вся базовая инфраструктура готова и можно начать планирование ресурсов, чтобы выяснить, нужны ли дополнительные ресурсы. [Подробнее](site-recovery-plan-capacity-vmware.md).
2. После планирования ресурсов в поле **Вы выполнили планирование ресурсов?** выберите **Да**.

   ![Планирование загрузки](./media/site-recovery-vmware-to-azure/gs-capacity-planning.png)


## <a name="prepare-vms-for-replication"></a>Подготовка виртуальных машин к репликации

Служба Mobility Service должна быть установлена на всех виртуальных машинах VMware, которые нужно реплицировать. Службу мобильности можно установить несколькими способами.

1. Установить принудительно через сервер обработки. Чтобы использовать этот метод, необходимо подготовить виртуальные машины.
2. Установить с помощью средства развертывания, например System Center Configuration Manager, или с помощью DSC службы автоматизации Azure.
3.  Установить вручную.

[Дополнительные сведения](site-recovery-vmware-to-azure-install-mob-svc.md)


## <a name="enable-replication"></a>Включение репликации

Перед началом работы:

- При добавлении или изменении виртуальных машин может понадобиться около 15 минут или больше, чтобы изменения вступили в силу и отобразились на портале.
- Последнее время обнаружения виртуальных машин можно узнать, выбрав **Серверы конфигурации** > **Последний контакт в**.
- Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.
* Если виртуальная машина уже подготовлена для принудительной установки, сервер обработки автоматически устанавливает на него службу мобильности при включении репликации.


### <a name="exclude-disks-from-replication"></a>Исключение дисков из репликации

По умолчанию реплицируются все диски на виртуальной машине. Диски можно исключить из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb SQL Server).

### <a name="replicate-vms"></a>Репликация виртуальных машин

Прежде чем начать, посмотрите краткий видеообзор:

>[!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video3-Protect-VMware-Virtual-Machines/player]

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. Выберите сервер обработки. Если ни один дополнительный сервер обработки еще не создан, это будет сервер конфигурации. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication2.png)

6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.


7. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных. Если вы не хотите использовать настроенную учетную запись, можно создать новую.

8. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если вы не хотите использовать существующую сеть, можно создать новую.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-rep3.png)
9. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication5.png)
10. В поле **Свойства** > **Настройка свойств**и выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
11. По умолчанию будут реплицироваться все диски. Щелкните **Все диски** , а затем снимите флажки напротив дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства виртуальных машин.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication6.png)
11. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации. Если изменить политику, изменения будут применяться к реплицированным и новым виртуальным машинам.
12. Включите параметр **Согласование с несколькими виртуальными машинами** , если хотите объединить компьютеры в группу репликации, и укажите имя этой группы. Нажмите кнопку **ОК**. Обратите внимание на следующее.

    * Компьютеры в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные точки восстановления после отработки отказа.
    * Виртуальные машины и физические серверы рекомендуется объединять для того, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication7.png)
13. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

Если настроена принудительная установка, после включения репликации устанавливается служба мобильности. После того как служба мобильности будет принудительно установлена на виртуальной машине, задание защиты запустится и завершится сбоем. После сбоя каждый компьютер необходимо будет перезапустить вручную. После этого задание защиты будет запущено снова и будет выполнена начальная репликация.



### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Рекомендуется проверить свойства виртуальной машины и внести необходимые изменения.

1. Щелкните **Реплицированные элементы** и выберите компьютер. В колонке **Основные компоненты** отображается информация о параметрах и состоянии компьютеров.
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.
3. В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с [требованиями Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) .
4. Измените сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure.

   - Вы можете задать целевой IP-адрес.

    - Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP.
    - Если задать адрес, недоступный при отработке отказа, произойдет сбой.
    - Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.

   - Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины.

     - Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     - Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использоваться максимальный размер целевой машины.
     - Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
   - Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети.
   - Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером *по умолчанию* для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.
5. На странице **Диски** отображаются сведения об операционной системе виртуальной машины и дисках данных, которые будут реплицироваться.

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа


Когда настройка будет завершена, запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов. Перед началом посмотрите краткий видеообзор:
>[!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video4-Recovery-Plan-DR-Drill-and-Failover/player]


1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину, а затем — значок **Добавить тестовую отработку отказа**.

    ![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/TestFailover.png)

1. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).  

1. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое открывается щелчком по виртуальной машине, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Параметры** > **Задания** > **Задания Site Recovery**.

1. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.

1. Если вы заранее [подготовились к подключению после отработки отказа](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover), то сможете подключиться к виртуальной машине Azure.

1. Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.

[Узнайте больше](site-recovery-test-failover-to-azure.md) о выполнении тестовой отработки отказа.


## <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

Службе Site Recovery нужен доступ к учетным записям VMware для отработки отказа и восстановления размещения, а также для автоматического обнаружения виртуальных машин на сервере обработки.

- **Перенос** — если требуется только перенос виртуальных машин VMware в Azure (без восстановление размещения), можно использовать учетную запись VMware с ролью только для чтения. Такая роль позволяет выполнять отработку отказа только без выключения исходных защищенных компьютеров. Это не является обязательным для переноса.
- **Репликация и восстановление** — если вы хотите развернуть полную репликацию (репликация, отработка отказа, восстановление размещения), учетная запись должна иметь возможность выполнять такие операции, как создание и удаление дисков, включение виртуальных машин и т. д.
- **Автоматическое обнаружение** — требуется по крайней мере учетная запись только для чтения.


**Задача.** | **Требуемая учетная запись или роль** | **Разрешения** | **Дополнительные сведения**
--- | --- | --- | ---
**Сервер обработки автоматически обнаруживает виртуальные машины VMware** | Потребуется по крайней мере пользователь только для чтения | Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Тип отработки отказа** | Потребуется по крайней мере пользователь только для чтения | Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).<br/><br/> Это полезно для сценария переноса, но не подходит для полной репликации, отработки отказа и восстановления размещения.
**Отработка отказа и восстановление размещения** | Мы рекомендуем создать роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначить эту роль пользователю или группе VMware. | Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).


## <a name="next-steps"></a>Дальнейшие действия

Как только вы настроите и запустите репликацию, в случае возникновении сбоя будет выполняться отработка отказа в Azure. При этом виртуальные машины Azure создаются на основе реплицированных данных. Затем вы сможете получать доступ к рабочим нагрузкам и приложениям в Azure, пока ваше исходное расположение не вернется в нормальный режим работы.

- [Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа и способах их выполнения.
- См. сведения в [этом разделе](site-recovery-migrate-to-azure.md#migrate-on-premises-vms-and-physical-servers), если вам нужно перенести виртуальные машины без репликации и восстановления размещения.
- [См. сведения в этой статье](site-recovery-failback-azure-to-vmware.md), если вам нужно выполнить восстановление размещения и репликацию виртуальных машин Azure на основном локальном сайте.

## <a name="third-party-software-notices-and-information"></a>Уведомления и сведения о стороннем программном обеспечении
Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).  Microsoft is the not original author of the Third Party Code.  The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only.  This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.  

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.

