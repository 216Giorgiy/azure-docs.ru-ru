---
title: "Репликация в Azure виртуальных машин VMware и физических серверов с использованием службы Azure Site Recovery и портала Azure | Документация Майкрософт"
description: "В этой статье описывается, как развернуть Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware и физических серверов Windows и Linux в Azure с использованием портала Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: dab98aa5-9c41-4475-b7dc-2e07ab1cfd18
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/23/2016
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: 1268d29b0d9c4368f62918758836a73c757c0c8d
ms.openlocfilehash: 20ffa261ef17847a665e7c83defeb19e9029fb63


---
# <a name="replicate-vmware-virtual-machines-and-physical-machines-to-azure-with-azure-site-recovery-using-the-azure-portal"></a>Репликация виртуальных машин VMware и физических компьютеров в Azure с помощью службы Azure Site Recovery и портала Azure

> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmware-to-azure.md)
> * [Классическая модель Azure](site-recovery-vmware-to-azure-classic.md)



Вас приветствует служба Azure Site Recovery.

Site Recovery — это служба Azure, которая помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR). Она координирует репликацию локальных физических серверов и виртуальных машин в облако (Azure) или дополнительный центр обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Дополнительные сведения см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

Эта статья описывает репликацию в Azure локальных виртуальных машин VMware и физических серверов Windows или Linux с использованием службы Azure Site Recovery и портала Azure.

Если после прочтения этой статьи у вас появятся комментарии, вы можете оставить их внизу в разделе Disqus. Вы можете задать любые вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="quick-summary"></a>Краткая сводка
Для полного развертывания мы настоятельно рекомендуем соблюдать шаги, описанные в этой статье. Но если у вас мало времени, предлагаем воспользоваться этим кратким обзором.

| **Область** | **Дополнительные сведения** |
| --- | --- |
| **Сценарий развертывания** |Репликация в Azure виртуальных машин VMware или физических серверов с помощью портала Azure |
| **Требования к локальной среде** |Локальный компьютер, на котором работают сервер конфигурации, сервер обработки и главный целевой сервер.<br/><br/> Серверу конфигурации нужно подключение к Интернету и доступ к определенным URL-адресам (напрямую или через прокси-сервер). [Полные сведения.](#configuration-server-or-additional-process-server-prerequisites) |
| **Требования Azure** |Учетная запись Azure<br/><br/> Хранилище служб восстановления <br/><br/> Учетная запись хранения LRS или GRS в регионе хранилища.<br/><br/> Учетная запись хранения класса Premium или Standard<br/><br/> Виртуальная машина Azure в регионе хранилища. [Полные сведения.](#azure-prerequisites) |
| **Ограничения для Azure** |При использовании учетной записи GRS для входа в систему требуется другая учетная запись LRS.<br/><br/> Учетные записи хранения, созданные на портале Azure, нельзя перемещать из одной группы ресурсов в другую.<br/><br/> Репликация в учетные записи хранения класса Premium в центральной и южной Индии в настоящее время не поддерживается. |
| **Репликация Windows** |64-разрядная ОС Windows на виртуальных машинах VMware или физических серверах:<br/><br/> Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более новая версия. [Полные сведения.](#replicated-machine-prerequisites) |
| **Репликация Linux** |Linux на виртуальных машинах VMware или физических серверах:<br/><br/>Red Hat Enterprise Linux 6.7, 7.1, 7.2.<br/><br/> CentOS 6.5, 6.6, 6.7, 7.0, 7.1, 7.2.<br/><br/> Oracle Enterprise Linux 6.4 или 6.5 с ядром, совместимым с Red Hat, или с ядром Unbreakable Enterprise Kernel Release 3 (UEK3).<br/><br/> SUSE Linux Enterprise Server 11 SP3. [Полные сведения.](#replicated-machine-prerequisites) |
| **Агент** |Агент службы мобильности, установленный на каждом реплицируемом компьютере.<br/><br/> Его можно установить вручную или принудительно через сервер обработки. [Полные сведения.](#install-the-mobility-service) |
| **Требования к репликации** |Реплицируемые компьютеры должны соответствовать [предварительным требованиям Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).<br/><br/> Нельзя выполнять репликацию виртуальных машин с зашифрованными дисками.<br/><br/> Гостевые кластеры общих дисков не поддерживаются.<br/><br/> Можно исключить из репликации отдельные базовые диски, но не диски операционной системы и не динамические диски.<br/><br/> На компьютерах Windows операционная система должна размещаться на диске C, который не должен быть динамическим. [Подробная информация](#replicated-machine-prerequisites). |
| **Требования к VMware** | Один или несколько серверов VMware vSphere (версии 6.0, 5.5 или 5.1 с последними обновлениями). Мы рекомендуем размещать их в той же сети, в которой находится сервер конфигурации (или сервер обработки, если вы разместили его на отдельном компьютере).<br/><br/> Желательно использовать сервер vCenter для управления узлами vSphere (версии 6.0 или 5.5 с последними обновлениями). |
| **Ограничения VMware** |Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища. Поддержка предоставляется только для компонентов, доступных в версии 5.5. |
| **Шаги по развертыванию** | **1)** Подготовьте службы Azure (подписки, хранилище, сеть) -> **2)** Подготовьте локальные системы (сервер конфигурации, учетная запись VMware) -> **3)**Создайте хранилище служб восстановления -> **4)** Настройте сервер конфигурации -> **5)** Настройте параметры репликации -> **6)** Подготовьте к развертыванию агент службы мобильности -> **7)** Включите репликацию -> **8)** Проверьте выполнение репликации и отработки отказа. |
| **Восстановление размещения** | Отработка отказа всегда выполняется на VMware, даже если реплицируются физические серверы.<br/><br/> Между Azure и первичным сайтом нужно настроить подключение VPN или Express Route.<br/><br/> Потребуется временный сервер обработки, настроенный как виртуальная машина Azure. Его можно создать, когда вы будете готовы к восстановлению размещения, и удалить после завершения процесса. |

## <a name="site-recovery-in-the-azure-portal"></a>Служба Site Recovery на портале Azure
В Azure предлагаются две разные [модели развертывания](../azure-resource-manager/resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager и классическая модель. Кроме того, Azure предоставляет два портала: классический портал Azure и портал Azure.

В этой статье описывается развертывание на портале Azure, то есть более функциональный и более простой вариант. Классический портал можно использовать для поддержания существующих хранилищ. Новые хранилища с помощью классического портала создавать нельзя. 


## <a name="site-recovery-in-your-business"></a>Преимущества службы Site Recovery для бизнеса
Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления, которая определяет, как приложения и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как можно максимально быстро восстановить нормальный режим работы. Преимущества службы Site Recovery:

* она обеспечивает удаленную защиту корпоративных рабочих нагрузок, запущенных на виртуальных машинах VMware и физических серверах;
* предоставляет единое расположение для настройки, мониторинга репликации и управления ею, а также для отработки отказа и восстановления;
* автоматически обнаруживает виртуальные машины VMware, добавление в узлы vSphere;
* простая отработка отказа из локальной инфраструктуры в Azure и восстановление размещения из Azure на серверы виртуальных машин VMware в локальном расположении;
* возможность синхронизированной репликации и отработки отказа для рабочих нагрузок приложения, распределенных между несколькими компьютерами. Можно объединить в планах восстановления сразу несколько компьютеров, чтобы отработка отказа выполнялась для всей рабочей нагрузки многоуровневого приложения.

## <a name="scenario-architecture"></a>Архитектура сценария
Ниже приведены компоненты, участвующие в сценарии:

- **Сервер конфигурации** — локальный компьютер, который координирует обмен данными и управляет процессами репликации и восстановления данных. На этом компьютере запускается файл единой установки, который устанавливает сервер конфигурации и дополнительные компоненты.
 - **Сервер обработки**— выступает в качестве шлюза репликации. Он получает данные репликации с защищенных исходных компьютеров, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware. Сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные автономные серверы обработки.
 - **Главный целевой сервер**— обрабатывает данные репликации при восстановлении размещения с переносом из Azure.
- **Служба Mobility**. Этот компонент развертывается на каждом компьютере (виртуальной машине VMware или физическом сервере), для которого требуется выполнить репликацию в Azure. Она фиксирует операции записи данных, выполняемые на компьютере, и передает их на сервер обработки.
- **Azure**. Для выполнения репликации и отработки отказа в Azure не нужно создавать виртуальные машины Azure.  Но вам нужны подписка Azure, учетная запись хранения Azure для хранения реплицированных данных и виртуальная сеть Azure, к которой будут подключены созданные виртуальные машины Azure в процессе отработки отказа. Учетная запись хранения и сеть должны располагаться в том же регионе, что и хранилище служб восстановления.
- **Восстановление размещения**. Для восстановления размещения требуется несколько компонентов.
 - Временный сервер обработки. В качестве временного сервера обработки будет выступать виртуальная машина Azure. После восстановления размещения ее можно будет удалить.
 - VPN. Потребуется подключение VPN или Azure ExpressRoute между локальным узлом и сетью Azure, в которой размещаются виртуальные машины Azure.
 - Главный целевой сервер. Если трафик восстановления размещения слишком велик, в локальном размещении потребуется настроить выделенный главный целевой сервер. При небольшом трафике можно использовать главный целевой сервер, который выполняется на сервере конфигурации.

На рисунке показано взаимодействие этих компонентов.

![архитектура](./media/site-recovery-vmware-to-azure/v2a-architecture-henry.png)

**Рисунок 1. Виртуальные машины VMware или физические компьютеры в Azure**

## <a name="azure-prerequisites"></a>Предварительные требования Azure
Для выполнения этого сценария вам потребуются следующие компоненты среды Azure.

| **Компонент** | **Требование** |
| --- | --- |
| **Учетная запись Azure** |Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/) . Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. |
| **Служба хранилища Azure** |Реплицированные данные хранятся в службе хранилища Azure, а при отработке отказа создаются виртуальные машины Azure. <br/><br/>Для хранения данных потребуется учетная запись хранения класса Standard или Premium, размещенная в том же регионе, что и хранилище служб восстановления.<br/><br/>Подойдет учетная запись хранения LRS или GRS. Рекомендуется использовать учетную запись хранения GRS, чтобы обеспечить устойчивость данных в случае отключения электричества в регионе или при отсутствии возможности восстановления основного региона. [Подробнее](../storage/storage-redundancy.md).<br/><br/> [Хранилище класса Premium](../storage/storage-premium-storage.md) обычно используется для виртуальных машин, которым постоянно требуется высокая производительность ввода-вывода и малая задержка для размещения интенсивных рабочих нагрузок ввода-вывода.<br/><br/> Если для хранения реплицированных данных вы будете использовать учетную запись хранения класса Premium, потребуется дополнительная учетная запись хранения класса Standard для хранения журналов репликации, в которые записываются текущие изменения локальных данных.<br/><br/> **Ограничение**: учетные записи хранения, созданные на портале Azure, нельзя перемещать из одной группы ресурсов в другую.<br/><br/> **Ограничение**: репликация в учетные записи хранения класса Premium в центральной и южной Индии в настоящее время не поддерживается.<br/><br/> См. [дополнительные сведения о службе хранилища Azure](../storage/storage-introduction.md). |
| **Сеть Azure** |Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище служб восстановления. |
| **Восстановление размещения с выполнением переноса из Azure** |Вам потребуется временный сервер обработки, настроенный как виртуальная машина Azure. Его можно создать, когда вы будете готовы к восстановлению размещения, и удалить после завершения процесса.<br/><br/> Для восстановления размещения необходимо настроить подключение VPN или Azure ExpressRoute между сетью Azure и локальным размещением. |

## <a name="configuration-server-or-additional-process-server-prerequisites"></a>Технические условия для сервера конфигурации и дополнительного сервера обработки
В качестве сервера конфигурации используется локальный компьютер.

> [!NOTE]
> Если нагрузка достаточно высока, чтобы потребовался отдельный сервер обработки, технические условия для дополнительного сервера обработки будут такими же, как и для сервера конфигурации.
>

| **Компонент** | **Требование** |
| --- | --- |
| **Сервер конфигурации** |Локальный физический компьютер или локальная виртуальная машина под управлением Windows Server 2012 R2. На этом компьютере или виртуальной машине устанавливаются все локальные компоненты Site Recovery.<br/><br/>Для репликации виртуальной машины VMware рекомендуется развернуть сервер как высокодоступную виртуальную машину VMware. Если реплицируются физические компьютеры, то можно использовать физический сервер.<br/><br/> Восстановление размещения из Azure всегда выполняется на виртуальные машины VMware, даже если реплицируются физические серверы. Если сервер конфигурации не развернут на виртуальной машине VMware, необходимо настроить такую виртуальную машину в роли главного целевого сервера, на который будет поступать трафик при восстановлении размещения.<br/><br/>Если сервер представляет собой виртуальную машину VMware, необходимо выбрать тип сетевого адаптера VMXNET3. Если вы используете другой тип сетевого адаптера, установите [обновление VMware](https://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&docType=kc&externalId=2110245&sliceId=1&docTypeID=DT_KB_1_1&dialogID=26228401&stateId=1) на сервер vSphere 5.5.<br/><br/>Сервер должен иметь статический IP-адрес.<br/><br/>Сервер не должен быть контроллером домена.<br/><br/>Длина имени узла сервера не должна превышать 15 символов.<br/><br/>Можно использовать только операционную систему на английском языке.<br/><br/> Установите сервер VMware vSphere PowerCLI 6.0. server.<br/><br/>Серверу конфигурации требуется доступ к Интернету. Исходящий доступ необходимо настроить следующим образом:<br/><br/>Временный доступ к порту HTTP 80 во время установки компонентов Site Recovery (для скачивания MySQL)<br/><br/>Текущий исходящий доступ к порту HTTPS 443 для управления репликацией<br/><br/>Текущий исходящий доступ к порту HTTPS 9443 для трафика репликации (этот порт можно изменить)<br/><br/>Серверу потребуется также доступ к следующим URL-адресам, чтобы он мог подключаться к Azure: ``*.accesscontrol.windows.net``<br/><br/> ``*.backup.windowsazure.com``<br/><br/> ``*.hypervrecoverymanager.windowsazure.com``<br/><br/> ``*.store.core.windows.net``<br/><br/> ``*.blob.core.windows.net``<br/><br/> ``https://www.msftncsi.com/ncsi.txt``<br/><br/> ``time.windows.com``<br/><br/> ``time.nist.gov``<br/><br/> При использовании на сервере правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/><br/> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) по протоколу HTTPS (порт 443).<br/><br/>Необходимо разрешить диапазоны IP-адресов для региона Azure в вашей подписке и для региона "Западная часть США".<br/><br/>Разрешите доступ на этот URL-адрес для загрузки MySQL: ``http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi`` |

## <a name="vmware-vcentervsphere-host-prerequisites"></a>Предварительные требования узлов VMware vCenter и vSphere
| **Компонент** | **Требования** |
| --- | --- |
| **vSphere** | Вам потребуется одна или несколько низкоуровневых оболочек VMware vSphere.<br/><br/>Низкоуровневые оболочки должны работать под управлением vSphere версии 6.0, 5.5 или 5.1 со всеми последними обновлениями.<br/><br/>Мы рекомендуем размещать узлы vSphere и серверы vCenter в той же сети, в которой находится сервер обработки (или в сети, в которой находится сервер конфигурации, если вы не настроили выделенный сервер обработки). |
| **vCenter** | Для управления узлами vSphere рекомендуется развернуть сервер VMware vCenter. На нем нужно установить vCenter версии 6.0 или 5.5 с последними обновлениями.<br/><br/>**Ограничение**: Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища. Поддержка Site Recovery предоставляется только для компонентов, доступных в версии 5.5. |

## <a name="replicated-machine-prerequisites"></a>Предварительные требования для защищенных компьютеров
| **Компонент** | **Требования** |
| --- | --- |
| **Локальные виртуальные машины VMware** | На реплицируемых виртуальных машинах должны быть установлены и запущены средства VMware.<br/><br/> Виртуальные машины должны отвечать [предварительным требованиям Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements) для создания виртуальных машин.<br/><br/>Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ). <br/><br/>Требуется не меньше 2 ГБ свободного места на диске для установки компонентов.<br/><br/>**Ограничение**: защита виртуальных машин с зашифрованными дисками не поддерживается.<br/><br/>**Ограничение**: гостевые кластеры общих дисков не поддерживаются.<br/><br/>На локальном брандмауэре виртуальной машины должен быть открыт **порт 20004**, если вы хотите поддерживать согласованность между виртуальными машинами.<br/><br/>Виртуальные машины с загрузкой UEFI (Unified Extensible Firmware Interface) или EFI (Extensible Firmware Interface) не поддерживаются.<br/><br/>Имена компьютеров должны содержать от 1 до 63 символов (буквы, цифры и дефисы). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. После включения репликации для виртуальной машины можно изменить имя Azure.<br/><br/>Если исходная виртуальная машина содержит объединение сетевых адаптеров, то после отработки отказа в Azure оно преобразуется в единый сетевой адаптер.<br/><br/>Если защищенная виртуальная машина имеет диск iSCSI, то при отработке отказа виртуальной машины в Azure служба Site Recovery преобразует этот диск iSCSI в VHD-файл. Если виртуальная машина Azure может получить доступ к целевому объекту iSCSI, она подключится к нему и будет использовать два одинаковых диска: VHD на виртуальной машине Azure и исходный диск iSCSI. В этом случае следует отключить целевой объект iSCSI, который отображается на виртуальной машине Azure. |
| **Компьютеры Windows (физические компьютеры или виртуальные машины VMware)** | Компьютер должен работать под управлением поддерживаемой 64-разрядной операционной системы: Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с пакетом обновления 1 (SP1) (как минимум).<br/><br/> Операционная система должна устанавливаться на диске C:\. Диск операционной системы должен представлять собой базовый, а не динамический диск Windows. Диск данных может быть динамическим.<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения Site Recovery повторно использует диск RDM, если исходная виртуальная машина и диск RDM доступны. В противном случае при восстановлении размещения служба Site Recovery создаст для каждого диска новый файл VMDK. |
| **Компьютеры Linux** (физические компьютеры или виртуальные машины VMware) | Потребуется поддерживаемая 64-разрядная ОС: Red Hat Enterprise Linux 6.7, 7.1, 7.2; Centos 6.5, 6.6, 6.7, 7.0, 7.1, 7.2; Oracle Enterprise Linux 6.4, 6.5 с ядром, совместимым с Red Hat, или ядром Unbreakable Enterprise Kernel Release 3 (UEK3), SUSE Linux Enterprise Server 11 SP3.<br/><br/>Файлы /etc/hosts на защищаемых компьютерах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.<br/><br/>Чтобы иметь возможность подключаться к виртуальным машинам Azure под управлением Linux после отработки отказа с помощью клиента SSH, убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы и правила брандмауэра разрешают SSH-подключение к виртуальной машине.<br/><br/>Имена узлов, точки подключения, имена устройств и системные пути и имена файлов Linux (например, /etc/; /usr) должны быть только на английском языке.<br/><br/>Защиту можно включить для компьютеров под управлением Linux со следующими типами хранилищ: файловые системы (EXT3, ETX4, ReiserFS, XFS); многомаршрутное подключение устройств (multipath); менеджер томов (LVM2). Физические серверы с хранилищем контроллера HP CCISS не поддерживаются. Файловая система ReiserFS поддерживается только в SUSE Linux Enterprise Server 11 с пакетом обновления 3 (SP3).<br/><br/>Site Recovery поддерживает виртуальные машины с дисками RDM.  При восстановлении размещения для компьютеров Linux служба Site Recovery не использует диск RDM повторно. Вместо этого она создает новый VMDK-файл для каждого соответствующего диска RDM.<br/><br/>Установите параметр disk.enableUUID в конфигурации виртуальной машины в VMWare в значение true. Создайте запись, если она не существует. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK. Добавление этого параметра также гарантирует, что во время восстановления размещения на локальный компьютер будут переноситься только разностные изменения без полной репликации. |
| **Mobility Service** | **Windows**: для автоматической установки службы мобильности на виртуальные машины под управлением Windows необходимо указать учетную запись администратора (локального администратора на компьютере Windows), чтобы сервер обработки мог выполнить принудительную установку.<br/><br/>**Linux**: для автоматической установки службы Mobility Service на виртуальные машины под управлением Linux необходимо создать учетную запись администратора, которую сервер обработки сможет использовать для выполнения принудительной установки.<br/><br/> По умолчанию реплицируются все диски на компьютере. Чтобы [исключить диск из репликации](#exclude-disks-from-replication), службу Mobility Service необходимо установить на компьютер вручную до включения репликации.<br/> |

## <a name="prepare-for-deployment"></a>Подготовка к развертыванию
Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Настроить сеть](#set-up-an-azure-network) , в которой будут размещаться виртуальные машины Azure, созданные в результате отработки отказа. Кроме того, для восстановления размещения вам потребуется настроить подключение VPN или Azure ExpressRoute между сетью Azure и локальным размещением.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить учетную запись](#prepare-an-account-for-automatic-discovery) на сервере vCenter или узлах vSphere, чтобы служба Site Recovery могла автоматически обнаруживать добавленные виртуальные машины VMware.
4. [Подготовить сервер конфигурации](#prepare-the-configuration-server), чтобы он мог получить доступ к необходимым URL-адресам и установить vSphere PowerCLI 6.0.

### <a name="set-up-an-azure-network"></a>Настроить сеть Azure
* Сеть должна располагаться в том же регионе Azure, в котором будет развернуто хранилище служб восстановления.
* В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для сети Azure необходимо настроить [режим Resource Manager](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
* Для восстановления размещения из Azure на локальный узел VMware потребуется VPN-подключение (или подключение Azure ExpressRoute) между сетью Azure, в которой размещены реплицированные виртуальные машины Azure, и локальной сетью, в которой находится сервер конфигурации.
* [Ознакомьтесь с дополнительными сведениями](../vpn-gateway/vpn-gateway-site-to-site-create.md) о моделях развертывания, поддерживаемых для VPN-подключений типа "сеть — сеть", а также узнайте, [как установить подключение](../vpn-gateway/vpn-gateway-site-to-site-create.md#CreateVNet).
* Вы можете также настроить подключение [Azure ExpressRoute](../expressroute/expressroute-introduction.md). [Узнайте больше](../expressroute/expressroute-howto-vnet-portal-classic.md) о настройке сети Azure с подключением ExpressRoute.

> [!NOTE]
> [Миграция сетей](../azure-resource-manager/resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.
>
>

### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure
* Для хранения данных, реплицированных в Azure, понадобится учетная запись хранения Azure класса Standard или Premium. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления. В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для настройки учетной записи следует применить [режим Resource Manager](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
* Если для реплицированных данных используется учетная запись класса Premium, понадобится настроить дополнительную стандартную учетную запись для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.  

> [!NOTE]
> [Перенос учетных записей хранения](../azure-resource-manager/resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для учетных записей хранения, используемых для развертывания Site Recovery.
>
>

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения
Сервер обработки Site Recovery может автоматически обнаруживать виртуальные машины WMware на узлах vSphere или на сервере vCenter, который управляет узлами. Для этого службе Site Recovery требуются учетные данные Site Recovery, обеспечивающие доступ к серверу VMware. Они не нужны при репликации только физических компьютеров.

1. Чтобы использовать выделенную учетную запись для автоматического обнаружения, создайте роль (например, Azure_Site_Recovery) на уровне vCenter с [необходимыми разрешениями](#vmware-account-permissions).
2. Создайте нового пользователя на узле vSphere или на сервере vCenter и назначьте роль пользователю. Затем сообщите эти учетные данные службе Site Recovery, чтобы она могла выполнить автоматическое обнаружение.

   > [!NOTE]
   > Учетная запись vCenter с ролью только для чтения позволяет выполнять отработку отказа только без выключения исходных защищенных компьютеров. Если их работу следует завершить, то потребуется роль [Azure_Site_Recovery](#vmware-account-permissions). Если нужно только перенести виртуальные машины из VMware в Azure и не нужно выполнять восстановление размещения, роли только для чтения достаточно.
   >
   >

### <a name="prepare-the-configuration-server"></a>Подготовить сервер конфигурации
1. Убедитесь, что компьютер, который используется в качестве сервера конфигурации, соответствует [предварительным требованиям](#configuration-server-prerequisites). В частности, проверьте, подключен ли компьютер к Интернету, используя следующие параметры:

   * Разрешить доступ к нескольким URL-адресам: ``*.hypervrecoverymanager.windowsazure.com``; ``*.accesscontrol.windows.net``; ``*.backup.windowsazure.com``; ``*.blob.core.windows.net``; ``*.store.core.windows.net``
   * Разрешите доступ к URL-адресу [http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi](http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi) для скачивания MySQL.
   * В настройках брандмауэра разрешите подключение к Azure по адресам из [диапазона IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протоколу HTTPS (443).
2. Скачайте и установите [VMware vSphere PowerCLI 6.0](https://developercenter.vmware.com/tool/vsphere_powercli/6.0) на сервер конфигурации. (В настоящее время другие версии PowerCLI не поддерживаются, включая выпуски R версии 6.0.)

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Служба архивации и Site Recovery (OMS)**. Также можно щелкнуть **Обзор** > **Хранилище служб восстановления** > **Добавить**.

    ![Новое хранилище](./media/site-recovery-vmware-to-azure/new-vault3.png)
3. В поле **Имя**укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте новую группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите существующую. Укажите регион Azure. В него будут реплицированы данные компьютеров. Обратите внимание, что хранилище и сети Azure, используемые для службы Site Recovery, находятся в том же регионе. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
5. Если вам нужна возможность быстрого доступа к хранилищу из панели мониторинга, щелкните **Закрепить на панели мониторинга**, а затем — **Создать**.

    ![Новое хранилище](./media/site-recovery-vmware-to-azure/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.

## <a name="getting-started"></a>Приступая к работе
В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание максимально быстро. Он проверяет соответствие предварительным требованиям и помогает выполнить действия, необходимые для развертывания Site Recovery.

Необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Затем нужно настроить инфраструктуру, включая локальные серверы, параметры Azure, политики репликации и планирование емкости. Когда инфраструктура будет готова, следует включить репликацию для виртуальных машин и физических серверов. Затем можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.

## <a name="step-1-choose-your-protection-goals"></a>Шаг 1. Выбор целевых объектов для защиты
Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище и щелкните **Параметры**.
2. Выбрав **Параметры** > **Приступая к работе**, щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals.png)
3. На странице **Цель защиты** выберите **В Azure** и **Да, с использованием низкоуровневой оболочки VMware vSphere**. Нажмите кнопку **ОК**.

    ![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals2.png)

## <a name="step-2-set-up-the-source-environment"></a>Шаг 2. Настройка исходной среды
Настройте конфигурацию сервера и зарегистрируйте его в хранилище службы восстановления. При репликации виртуальных машин VMware укажите учетную запись VMware, которая используется для автоматической доставки.

1. Щелкните **Шаг 1. Подготовка инфраструктуры** > **Источник**. Если у вас нет сервера конфигурации, в окне **Подготовка источника** щелкните **Добавить сервер конфигурации**.

    ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source1.png)
2. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
3. Перед настройкой сервера конфигурации проверьте, выполнены ли [предварительные требования](#configuration-server-prerequisites). В частности, убедитесь в том, что компьютер имеет доступ к необходимым URL-адресам.
4. Скачайте файл единой установки Site Recovery.
5. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение 5 дней после создания.

   ![Настройка источника](./media/site-recovery-vmware-to-azure/set-source2.png)
6. На компьютере, который используется в качестве сервера конфигурации, запустите программу единой установки, чтобы установить сервер конфигурации, сервер обработки и главный целевой сервер.

### <a name="run-site-recovery-unified-setup"></a>Выполнение единой установки Site Recovery
1. Запустите файл единой установки.
2. На странице **Перед началом работы** выберите **Установить сервер конфигурации и сервер обработки**.

   ![Перед началом работы](./media/site-recovery-vmware-to-azure/combined-wiz1.png)
3. В окне **Лицензия на программное обеспечение стороннего поставщика** щелкните **Принимаю**, чтобы скачать и установить MySQL.

    ![Стороннее программное обеспечение](./media/site-recovery-vmware-to-azure/combined-wiz105.PNG)
4. На странице **Регистрация** найдите и выберите регистрационный ключ, загруженный из хранилища.

    ![Регистрация](./media/site-recovery-vmware-to-azure/combined-wiz3.png)
5. На странице **Параметры Интернета** укажите параметры для подключения поставщика, который будет выполняться на сервере конфигурации, к Azure Site Recovery через Интернет.

   * Чтобы подключаться с помощью прокси-сервера, который уже настроен на компьютере, выберите **Connect with existing proxy settings**(Подключение с параметрами существующего прокси-сервера).
   * Чтобы поставщик подключался напрямую, выберите **Connect directly without a proxy**(Прямое подключение без прокси-сервера).
   * Если для существующего прокси-сервера требуется аутентификация или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings**(Подключение с параметрами пользовательского прокси-сервера).

     * При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
     * Если прокси-сервер используется, скорее всего, вы уже разрешили использовать URL-адреса, описанные в разделе о [предварительных требованиях](#configuration-server-prerequisites).

     ![Брандмауэр](./media/site-recovery-vmware-to-azure/combined-wiz4.png)
6. В окне **Проверка необходимых компонентов** программа установки проверяет возможность установки. Если появится предупреждение о **проверке глобальной синхронизации времени**, убедитесь, что время системных часов (параметры **даты и времени**) соответствует часовому поясу.

    ![Предварительные требования](./media/site-recovery-vmware-to-azure/combined-wiz5.png)
7. На странице **MySQL Configuration** (Конфигурация MySQL) создайте учетные данные для входа в экземпляр сервера MySQL, который будет установлен.

    ![MySQL](./media/site-recovery-vmware-to-azure/combined-wiz6.png)
8. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. Если нужно, программа установки проверяет, установлен ли компонент PowerCLI 6.0.

    ![MySQL](./media/site-recovery-vmware-to-azure/combined-wiz7.png)
9. На странице **Расположение установки** выберите место для установки двоичных файлов и хранения кэша. Можно выбрать диск кэша с объемом доступной памяти от 5 ГБ. Однако рекомендуемый объем — не менее 600 ГБ.

    ![Расположение установки](./media/site-recovery-vmware-to-azure/combined-wiz8.png)
10. На странице **Выбор сети** укажите прослушиватель (сетевой адаптер и порт SSL), через который сервер конфигурации будет отправлять и получать данные репликации. Можно изменить порт по умолчанию (9443). Помимо этого порта веб-сервером, который координирует операции репликации, будет использоваться порт 443. Не следует использовать порт 443 для приема данных репликации.

    ![Выбор сети](./media/site-recovery-vmware-to-azure/combined-wiz9.png)



1. Просмотрите информацию на странице **Сводка** и нажмите кнопку **Установить**. После завершения установки создается парольная фраза. Она потребуется при включении репликации, поэтому скопируйте ее и сохраните в безопасном месте.

   ![Сводка](./media/site-recovery-vmware-to-azure/combined-wiz10.png)
2. После завершения регистрации сервер появится в колонке хранилища **Параметры** > **Серверы** .

#### <a name="run-setup-from-the-command-line"></a>Запуск установки из командной строки
Сервер конфигурации можно настроить из командной строки:

    UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]

Параметры

* /ServerMode. (Обязательный параметр.) Указывает, нужно ли установить и сервер конфигурации, и сервер обработки или только север обработки. Входные значения: CS, PS.
* InstallLocation. Папка для установки компонентов.
* /MySQLCredsFilePath. (Обязательный параметр.) Путь к файлу, в котором хранятся учетные данные сервера MySQL. Файл должен быть в следующем формате:
  * [MySQLCredentials]
  * MySQLRootPassword = "<Password>"
  * MySQLUserPassword = "<Password>"
* /VaultCredsFilePath. (Обязательный параметр.) Расположение файла с учетными данными хранилища.
* /EnvType. (Обязательный параметр.) Тип установки. Значения: VMware, NonVMware.
* /PSIP и /CSIP. (Обязательный параметр.) IP-адрес сервера обработки и сервера конфигурации.
* /PassphraseFilePath. (Обязательный параметр.) Расположение файла с парольной фразой.
* /BypassProxy. необязательный параметр. Указывает, что сервер конфигурации подключается к Azure без использования прокси-сервера.
* /ProxySettingsFilePath. необязательный параметр. Параметры прокси-сервера (по умолчанию прокси-серверу требуется проверка подлинности или пользовательский прокси-сервер). Файл должен быть в следующем формате:
  * [ProxySettings]
  * ProxyAuthentication = "Да/Нет"
  * Proxy IP = "IP-адрес>"
  * ProxyPort = "<Port>"
  * ProxyUserName="<User Name>"
  * ProxyPassword="<Password>"
* DataTransferSecurePort. необязательный параметр. Номер порта для данных репликации.
* SkipSpaceCheck. необязательный параметр. Пропуск проверки пространства для кэша.
* AcceptThirdpartyEULA. (Обязательный параметр.) Флажок означает принятие лицензионного соглашения между пользователем и сторонним разработчиком.
* ShowThirdpartyEULA. (Обязательный параметр.) Отображает лицензионное соглашение со сторонним разработчиком. Если оно задано как источник данных, все остальные параметры игнорируются.

### <a name="add-the-vmware-account-used-for-automatic-discovery"></a>Добавление учетной записи VMware, используемой для автоматического обнаружения
 При подготовке к развертыванию вы [создали учетную запись VMware](#prepare-an-account-for-automatic-discovery) , которую Site Recovery сможет использовать для автоматического обнаружения. Добавьте эту учетную запись, выполнив указанные ниже действия.

1. Запустите файл **CSPSConfigtool.exe**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
2. Выберите **Управление учетными записями** > **Добавить учетную запись**.

    ![Добавить учетную запись](./media/site-recovery-vmware-to-azure/credentials1.png)
3. В разделе **Сведения об учетной записи** добавьте учетную запись, которая будет использоваться для автоматического обнаружения. Обратите внимание на то, что имя учетной записи может отобразиться на портале через 15 или больше минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > имя_сервера > **Сервер обновления**.

    ![Сведения](./media/site-recovery-vmware-to-azure/credentials2.png)

### <a name="connect-to-vsphere-hosts-and-vcenter-servers"></a>Подключение к узлам vSphere и серверам vCenter
Если вы выполняете репликацию виртуальных машин VMware, подключитесь к узлам vSphere и серверам vCenter.

1. Убедитесь, что сервер конфигурации имеет сетевой доступ к узлам vSphere и серверам vCenter.
2. Выберите **Подготовка инфраструктуры** > **Источник**. В окне **Подготовка источника** выберите сервер конфигурации и щелкните **Добавить vCenter**, чтобы добавить узел vSphere или сервер vCenter.
3. В окне **Add vCenter** (Добавление vCenter) укажите понятное имя для узла vSphere или сервера vCenter, а также IP-адрес или полное доменное имя сервера. Если серверы VMware настроены на прослушивание запросов через другой порт, оставьте порт 443. Выберите учетную запись, которая будет использоваться для подключения к серверу VMware. Нажмите кнопку **ОК**.

    ![VMware](./media/site-recovery-vmware-to-azure/vmware-server.png)

   > [!NOTE]
   > Если вы добавляете сервер vCenter или узел vSphere с учетной записью без прав администратора на сервере vCenter или сервере узла, предоставьте этой учетной записи права на доступ к следующим объектам: центр обработки данных, хранилище данных, папка, узел, сеть, ресурс, виртуальная машина и распределенный коммутатор vSphere. Кроме того, для сервера vCenter должны быть активированы права представлений хранилища.
   >
   >

Site Recovery подключается к серверам VMware, используя указанные вами параметры, и обнаруживает виртуальные машины.

## <a name="step-3-set-up-the-target-environment"></a>Шаг 3. Настройка целевой среды
Убедитесь, что у вас есть учетная запись хранения для репликации и сеть Azure, к которой виртуальные машины Azure будут подключаться после отработки отказа.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите модель развертывания, которая будет использоваться для виртуальных машин после отработки отказа.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Цель](./media/site-recovery-vmware-to-azure/gs-target.png)
4. Если учетная запись хранения еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Storage account** (+Учетная запись хранения).  В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

   ![Хранилище](./media/site-recovery-vmware-to-azure/gs-createstorage.png)

   Обратите внимание на следующее.

   * Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на портале Azure. [Дополнительные сведения](../storage/storage-create-storage-account-classic-portal.md)
   * Если для реплицированных данных используется учетная запись хранения "Премиум", потребуется настроить дополнительную учетную запись хранения "Стандартный" для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.

   > [!NOTE]
   > Защита для учетных записей хранения уровня "Премиум" в центральной и южной Индии в настоящее время не поддерживается.
   >
   >
5. Выберите сеть Azure. Если сеть еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Network** (+ Сеть), чтобы сделать это при настройке. В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.

   ![Сеть](./media/site-recovery-vmware-to-azure/gs-createnetwork.png)

   Если нужно создать сеть, используя классическую модель, это можно сделать на портале Azure. [Подробнее](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).

## <a name="step-4-set-up-replication-settings"></a>Этап 4. Настройка параметров репликации
1. Чтобы создать политику репликации, выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создание и связывание**.
2. На странице **Создать и связать политику**укажите имя политики.
3. В поле **Пороговое значение RPO**укажите предельное значение целевой точки восстановления (RPO). Если непрерывная репликация превышает это значение, выдаются оповещения.
4. В поле **Хранение точки восстановления**укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений**укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений.
6. При создании политики репликации для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения.  
7. Нажмите кнопку **ОК** , чтобы создать политику.

    ![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication2.png)
8. Созданная политика автоматически сопоставляется с облаком сервером конфигурации. Нажмите кнопку **ОК**.

    ![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication3.png)

## <a name="step-5-capacity-planning"></a>Шаг 5. Планирование ресурсов
Теперь вся базовая инфраструктура готова и можно начать планирование ресурсов, чтобы выяснить, нужны ли дополнительные ресурсы.

Site Recovery предоставляет планировщик ресурсов, который поможет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

* Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
* Определите частоту ежедневных изменений (обновлений) реплицированных данных. Для этого можно воспользоваться [устройством планирования загрузки vSphere](https://labs.vmware.com/flings/vsphere-replication-capacity-planning-appliance) .

1. Щелкните **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).
2. После этого выберите **Да** в поле **Вы выполнили планирование ресурсов?**

   ![Планирование загрузки](./media/site-recovery-vmware-to-azure/gs-capacity-planning.png)

Следующая таблица поможет в планировании ресурсов.

| **Компонент** | **Дополнительные сведения** |
| --- | --- | --- |
| **Репликация** |**Максимальный объем ежедневно изменяемых данных**. Защищенный компьютер может использовать только один сервер обработки, а объем ежедневно изменяемых данных на одном сервере обработки может составлять не более 2 ТБ. В связи с этим 2 ТБ — максимальный объем ежедневно изменяемых данных, поддерживаемый защищенным компьютером.<br/><br/> **Максимальная пропускная способность**. Реплицированный компьютер может принадлежать одной учетной записи хранения в Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Рекомендуется не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если есть исходный компьютер с 5 дисками, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером 8 КБ), этот показатель не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для источника на 20 000. |
| **Сервер конфигурации** |Сервер конфигурации должен поддерживать суммарный объем ежедневно изменяемых данных для всех рабочих нагрузок, которые выполняются на защищенных компьютерах. Также он должен обладать достаточной пропускной способностью для непрерывной репликации данных в службу хранилища Azure.<br/><br/> Рекомендуется разместить сервер конфигурации в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.<br/><br/> В следующей таблице приведены рекомендации по размерам для сервера конфигурации. |
| **Сервер обработки** |Первый сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные серверы обработки. Обратите внимание на следующее.<br/><br/> Сервер обработки получает данные репликации с защищенных компьютеров и оптимизирует их путем кэширования, сжатия и шифрования перед отправкой в Azure. Сервер обработки должен располагать достаточными ресурсами для выполнения этих задач.<br/><br/> Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, рекомендуется установить отдельный диск кэша объемом 600 ГБ и более. |

### <a name="size-recommendations-for-the-configuration-server"></a>Рекомендации по размеру сервера конфигурации
| **ЦП** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры** |
| --- | --- | --- | --- | --- |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой @2,5 ГГц) |16 ГБ |300 ГБ |500 ГБ или менее |Репликация не более 100 компьютеров |
| 12 виртуальных ЦП (2 сокета * 6 ядер с частотой @2,5 ГГц) |18 ГБ |600 ГБ |От 500 ГБ до 1 ТБ |Репликация от 100 до 150 компьютеров |
| 16 виртуальных ЦП (2 сокета * 8 ядер с частотой @2,5 ГГц) |32 ГБ |1 TБ |От 1 ТБ до 2 ТБ |Репликация от 150 до 200 компьютеров |
| Разверните другой сервер обработки | | |Более 2 ТБ |Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ. |

Описание

* Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
* Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

### <a name="size-recommendations-for-the-process-server"></a>Рекомендации по размеру сервера обработки
Если необходимо защитить более 200 компьютеров или объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки репликации можно добавить дополнительные серверы обработки. Для масштабирования можно выполнить следующее.

* Увеличить количество серверов конфигурации. Например, с помощью двух серверов конфигурации можно защитить до 400 компьютеров.
* Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера конфигурации (или вместе с ним).

В этой таблице описан следующий сценарий.

* Вы не планируете использовать сервер конфигурации в качестве сервера обработки.
* Вы настроили дополнительный сервер обработки.
* Вы настроили для защищенных виртуальных машин дополнительный сервер обработки.
* Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

| **Сервер конфигурации** | **Дополнительный сервер обработки** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры** |
| --- | --- | --- | --- | --- |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой @2,5 ГГц), память объемом 16 ГБ |4 виртуальных ЦП (2 сокета * 2 ядра с частотой @2,5 ГГц), память объемом 8 ГБ |300 ГБ |250 ГБ или менее |Репликация до 85 компьютеров |
| 8 виртуальных ЦП (2 сокета * 4 ядра с частотой @2,5 ГГц), память объемом 16 ГБ |8 виртуальных ЦП (2 сокета * 4 ядра с частотой@ 2,5 ГГц), память объемом 12 ГБ |600 ГБ |От 250 ГБ до 1 ТБ |Репликация от 85 до 150 компьютеров |
| 12 виртуальных ЦП (2 сокета * 6 ядер с частотой @2,5 ГГц), память объемом 18 ГБ |12 виртуальных ЦП (2 сокета * 6 ядер с частотой @2,5 ГГц), память объемом 24 ГБ |1 TБ |От 1 ТБ до 2 ТБ |Репликация от 150 до 225 компьютеров |

Способ масштабирования серверов будет зависеть от выбора модели увеличения масштаба и развертывания.  Вы можете увеличить масштаб, развернув несколько современных серверов конфигурации и обработки, или выполнить развертывание, развернув несколько серверов с меньшим объемом ресурсов. Например, чтобы защитить 220 компьютеров, можно применить одну из следующих рекомендаций.

* Настроить сервер конфигурации с 12 виртуальными ЦП и памятью объемом 18 ГБ, дополнительный сервер обработки с 12 виртуальными ЦП и памятью объемом 24 ГБ и защищенные компьютеры для использования только дополнительного сервера обработки.
* Кроме того, можно настроить два сервера конфигурации (8 виртуальных ЦП и 16 ГБ ОЗУ в каждом), два дополнительных сервера обработки (8 виртуальных ЦП в одном и 4 виртуальных ЦП, что позволит обрабатывать 220 (135 + 85) компьютеров) и указать, что защищенные компьютеры должны использовать только дополнительные серверы обработки.

[Выполните эти инструкции](#deploy-additional-process-servers) , чтобы настроить дополнительный сервер обработки.

### <a name="network-bandwidth-considerations"></a>Рекомендации по пропускной способности сети
С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Объемом пропускной способности, используемой для репликации, можно управлять несколькими способами.

* **Регулирование пропускной способности**. Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Пропускную способность можно регулировать на компьютерах, которые служат серверами обработки.
* **Изменение пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких ключей реестра:
  * Значение реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\UploadThreadsPerVM** задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.
  * Значение **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DownloadThreadsPerVM** задает количество потоков, используемых для передачи данных при восстановлении размещения.

#### <a name="throttle-bandwidth"></a>Регулирование пропускной способности
1. Откройте оснастку MMC в службе архивации Microsoft Azure на компьютере, который выступает в качестве сервера обработки. По умолчанию ярлык для службы архивации Microsoft Azure расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.

    ![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure/throttle1.png)
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

    ![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

#### <a name="influence-network-bandwidth"></a>Изменение пропускной способности сети
1. В реестре перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM**или создайте его, если он еще не существует.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## <a name="step-6-replicate-applications"></a>Шаг 6. Репликация приложений
Убедитесь, что компьютеры, которые нужно реплицировать, подготовлены для установки службы Mobility и включите репликацию.

### <a name="install-the-mobility-service"></a>Установка службы Mobility
При включении защиты для виртуальных машин и физических серверов нужно прежде всего установить службу Mobility Service. Это можно сделать несколькими способами.

* **Принудительная установка с сервера обработки**. Если вы включаете репликацию для компьютера, выполните принудительную установку компонента службы Mobility Service с сервера обработки. Обратите внимание, что принудительная установка не выполняется, если на компьютере уже работает актуальная версия компонента.
* **Принудительная установка корпоративными средствами**. Автоматическая установка компонента с помощью корпоративных средств принудительной установки, таких как WSUS, System Center Configuration Manager или [служба автоматизации Azure и служба настройки требуемого состояния](site-recovery-automate-mobility-service-install.md). Перед этим настройте сервер конфигурации.
* **Установка вручную**. Установите компонент вручную на каждом компьютере, который нужно реплицировать. Перед этим настройте сервер конфигурации.

#### <a name="prepare-for-automatic-push-on-windows-machines"></a>Подготовка к принудительной установке на компьютерах Windows
Ниже описан процесс подготовки компьютеров Windows для автоматической установки службы Mobility Service сервером обработки.

1. Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Учетная запись должна иметь права администратора (локального или администратора домена) и использоваться только для принудительной установки.

   > [!NOTE]
   > Если учетная запись домена не используется, на локальном компьютере потребуется отключить контроль удаленного доступа пользователей. Для этого в разделе реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System добавьте запись LocalAccountTokenFilterPolicy DWORD и задайте для нее значение 1. Чтобы добавить в реестр запись из интерфейса командной строки, введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**.
   >
   >
2. В брандмауэре Windows на компьютере, который нужно защитить, выберите **Разрешить запуск программы или компонента через брандмауэр Windows**. Активируйте **общий доступ к файлам и принтерам** и **инструментарий управления Windows**. Для компьютеров, принадлежащих домену, можно настроить параметры брандмауэра с помощью объекта групповой политики.

   ![Параметры брандмауэра](./media/site-recovery-vmware-to-azure/mobility1.png)
3. Добавьте созданную учетную запись:

   * Откройте **cspsconfigtool**. Он доступен через ярлык на рабочем столе и расположен в папке [РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
   * На вкладке **Управление учетными записями** щелкните **Добавить учетную запись**.
   * Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении репликации для компьютера.

#### <a name="prepare-for-automatic-push-on-linux-servers"></a>Подготовка к принудительной установке на серверах Linux
1. Убедитесь, что компьютер Linux, который необходимо защитить, соответствует всем [предварительным требованиям для защищаемого компьютера](#protected-machine-prerequisites). Убедитесь, что между компьютером Linux и сервером обработки установлено сетевое подключение.
2. Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux и использоваться только для принудительной установки.

   * Откройте **cspsconfigtool**. Он доступен через ярлык на рабочем столе и расположен в папке [РАСПОЛОЖЕНИЕ УСТАНОВКИ]\home\svsystems\bin.
   * На вкладке **Управление учетными записями** щелкните **Добавить учетную запись**.
   * Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении репликации для компьютера.
3. Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.
4. Установите последние пакеты openssh, openssh-server, openssl на компьютере, который нужно реплицировать.
5. Убедитесь, что служба SSH включена и работает через порт 22.
6. Включите подсистему SFTP и проверку подлинности с помощью пароля в файле sshd_config следующим образом:

   * Выполните вход в качестве привилегированного пользователя.
   * В файле /etc/ssh/sshd_config найдите строку, которая начинается с **PasswordAuthentication**.
   * Раскомментируйте ее и измените значение с **no** на **yes**.
   * Найдите строку, которая начинается с **Subsystem** , и раскомментируйте ее.

     ![Linux](./media/site-recovery-vmware-to-azure/mobility2.png)

### <a name="install-the-mobility-service-manually"></a>Установка службы Mobility Service вручную
Установщики находятся на сервере конфигурации в каталоге **C:\Program Files (x86)\Microsoft Azure Site Recovery\home\svsystems\pushinstallsvc\repository**.

| Исходная операционная система | Файл установки службы Mobility Service |
| --- | --- |
| Windows Server (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_Windows_* release.exe |
| CentOS 6.4, 6.5, 6.6 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_RHEL6-64_*release.tar.gz |
| SUSE Linux Enterprise Server 11 SP3 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_SLES11-SP3-64_*release.tar.gz |
| Oracle Enterprise Linux 6.4, 6.5 (только 64-разрядная версия) |Microsoft-ASR_UA_9.*.0.0_OL6-64_*release.tar.gz |

#### <a name="install-mobility-service-on-a-windows-server"></a>Установка Mobility Service на сервере Windows Server
1. Скачайте и запустите соответствующий установщик.
2. На странице **Перед началом работы** выберите **Служба мобильности**.

    ![Служба мобильности](./media/site-recovery-vmware-to-azure/mobility3.png)
3. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес сервера конфигурации и парольную фразу, созданную при выполнении единой установки. Ее можно получить, выполнив на сервере конфигурации команду **<SiteRecoveryInstallationFolder>\home\sysystems\bin\genpassphrase.exe –n**.

    ![Служба мобильности](./media/site-recovery-vmware-to-azure/mobility6.png)
4. Для параметра **Расположение установки** оставьте значение по умолчанию и нажмите кнопку **Далее**, чтобы начать установку.
5. На странице **Ход установки** следите за ходом установки и при появлении соответствующего запроса перезапустите компьютер. После установки службы ее состояние обновится на портале с задержкой до 15 минут.

#### <a name="install-mobility-service-on-a-windows-server-using-the-command-prompt"></a>Установка Mobility Service на сервере Windows Server с помощью командной строки
1. Скопируйте установщик в локальную папку (например, C:\Temp) на сервере, который необходимо защитить. Установщик можно найти на сервере конфигурации в каталоге **[расположение_установки]\home\svsystems\pushinstallsvc\repository**. Пакет для операционных систем Windows будет иметь похожее имя: Microsoft ASR_UA_9.3.0.0_Windows_GA_17thAug2016_release.exe.
2. Переименуйте этот файл в MobilitySvcInstaller.exe.
3. Извлеките MSI-файл установщика, используя следующую команду.

    ``C:\> cd C:\Tempww
    ``C:\Temp> MobilitySvcInstaller.exe /q /xC:\Temp\Extracted``
    ``C:\Temp> cd Extracted``
    ``C:\Temp\Extracted> UnifiedAgent.exe /Role "Agent" /CSEndpoint "IP Address of Configuration Server" /PassphraseFilePath <Full path to the passphrase file>``

##### <a name="full-command-line-syntax"></a>Полный синтаксис для командной строки
    UnifiedAgent.exe [/Role <Agent/MasterTarget>] [/InstallLocation <Installation Directory>] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>] [/LogFilePath <Log File Path>]<br/>

**Параметры**

* **/Role**: обязательный параметр. (Обязательный параметр.) Указывает, следует ли устанавливать службу Mobility Service. Входные значения: Agent|MasterTarget
* **/InstallLocation:** обязательный параметр. (Обязательный параметр.) Указывает место установки службы.
* **/PassphraseFilePath:** обязательный параметр. (Обязательный параметр.) Парольная фраза сервера конфигурации.
* **/LogFilePath:** обязательный параметр. Расположение, в котором следует создать файлы журнала установки.

#### <a name="uninstall-the-mobility-service-manually"></a>Установка Mobility Service вручную
Службу Mobility Service можно установить с помощью элемента "Установка и удаление программ" в "Панели управления" или с помощью операции командной строки: MsiExec.exe /qn /x {275197FC-14FD-4560-A5EB-38217F80CBD1}

#### <a name="install-the-mobility-service-on-a-linux-server"></a>Установка службы Mobility Service на сервере Linux
1. Скопируйте соответствующий TAR-архив согласно приведенной выше таблице на компьютер Linux, который нужно реплицировать.
2. Откройте программу оболочки и извлеките содержимое сжатого TAR-файла архива в локальный каталог, выполнив команду `tar -xvzf Microsoft-ASR_UA_8.5.0.0*`.
3. Создайте файл passphrase.txt в локальном каталоге, в который извлечено содержимое TAR-архива. Для этого скопируйте парольную фразу из файла C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase на сервере конфигурации и сохраните ее в файле passphrase.txt, выполнив в оболочке команду *`echo <passphrase> >passphrase.txt`*.
4. Установите службу Mobility Service, выполнив команду *`sudo ./install -t both -a host -R Agent -d /usr/local/ASR -i <IP address> -p <port> -s y -c https -P passphrase.txt`*.
5. Укажите внутренний IP-адрес сервера конфигурации и убедитесь, что выбран порт 443. После установки службы ее состояние обновится на портале в течение 15 минут.

**Кроме того, установку можно выполнить из командной строки**.

Скопируйте парольную фразу из файла C:\Program Files (x86)\InMage Systems\private\connection на сервере конфигурации и сохраните ее там же как файл passphrase.txt. Затем выполните следующие команды. В нашем примере используется IP-адрес сервера конфигурации 104.40.75.37 и порт HTTPS 443:


Установка на рабочем сервере

    ./install -t both -a host -R Agent -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

Установка на главном целевом сервере:

    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt


### <a name="enable-replication"></a>Включение репликации
#### <a name="before-you-start"></a>Перед началом работы
При репликации виртуальных машин VMware обратите внимание на следующее.

* Виртуальные машины VMware обнаруживаются каждые 15 минут. Может пройти более 15 минут, прежде чем они будут обнаружены и отображены на портале. Обнаружение может также занять 15 минут или более при добавлении нового сервера vCenter или узла vSphere.
* Изменения среды на виртуальной машине (например, установка средств VMware) также могут отобразиться на портале через 15 и более минут.
* Время последнего обнаружения виртуальных машин VMware можно узнать в колонке **Серверы конфигурации** в поле **Последнее обнаружение** для сервера vCenter или узла vSphere.
* Чтобы добавить компьютеры для репликации, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и нажмите кнопку **Обновить**.
* Если компьютер уже подготовлен, когда вы включаете репликацию, то сервер обработки автоматически устанавливает на него службу Mobility Service.

#### <a name="exclude-disks-from-replication"></a>Исключение дисков из репликации
При включении репликации по умолчанию реплицируются все диски на компьютере. Диски можно исключить из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb SQL Server). Обратите внимание на следующее.

* Исключать можно только те диски, которые уже установлены в службе Mobility. [Службу Mobility Service необходимо установить вручную](#install-the-mobility-service-manually), так как механизм принудительной установки для нее можно использовать только после включения репликации.
* Из репликации можно исключать только базовые диски. Диски операционной системы и динамический диск исключать нельзя.
* После включения репликации нельзя добавить или удалить диски для репликации. Если вы хотите добавить или исключить диск, отключите защиту компьютера, а затем включите ее повторно.
* Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную. Кроме того, для создания диска во время отработки отказа компьютера вы можете интегрировать службу автоматизации Azure в план восстановления.
* Виртуальная машина Windows: диски, создаваемые в Azure вручную, не будут восстановлены в исходном расположении. Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, то восстановление размещения будет выполнено только для трех дисков, задействованных при отработке отказа. Восстановление размещения после сбоя или повторная защита из локальной среды в Azure недоступны для дисков, созданных вручную.
* Виртуальная машина Linux: диски, создаваемые в Azure вручную, будут восстановлены в исходном расположении. Например, если для трех дисков выполняется отработка отказа, а еще два создаются непосредственно в Azure, восстановление будет выполнено для всех пяти дисков. Диски, созданные вручную при восстановлении расположения, исключать нельзя.

**Включите репликацию следующим образом**.

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.
2. В колонке **Источник** выберите **Источник** и нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины** или **Физические компьютеры**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел. Этот параметр не учитывается при репликации физических компьютеров.
5. Выберите сервер обработки. Если ни один дополнительный сервер обработки еще не создан, это будет имя сервера конфигурации. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication2.png)

6. Для параметра **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.


7. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных. Обратите внимание на следующее.

   * Можно выбрать учетную запись хранения класса Standard или Premium. Если вы выберете учетную запись класса Premium, потребуется указать дополнительную учетную запись хранения класса Standard для журналов текущей репликации. Учетные записи должны находиться в том же регионе, что и хранилище служб восстановления.
   * Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account). Чтобы создать учетную запись хранения с использованием Resource Manager, щелкните **Создать**. Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md).
8. Выберите сеть и подсеть Azure, к которой будут подключаться развернутые виртуальные машины Azure после отработки отказа. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если у вас нет сети, ее необходимо [создать](#set-up-an-azure-network). Чтобы создать сеть с помощью Resource Manager, щелкните **Создать**. Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-rep3.png)
9. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication5.png)
10. В поле **Свойства** > **Настройка свойств**и выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер. По умолчанию будут реплицироваться все диски. Щелкните **Все диски** , а затем снимите флажки напротив дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication6.png)
11. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации. Параметры политики репликации можно изменить, последовательно выбрав **Параметры** > **Политики репликации** > имя политики > **Изменить параметры**. Изменения, примененные к политике, будут применены к репликации и новым компьютерам.
12. Включите параметр **Согласование с несколькими виртуальными машинами** , если хотите объединить компьютеры в группу репликации, и укажите имя этой группы. Нажмите кнопку **ОК**. Обратите внимание на следующее.

    * Компьютеры в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные точки восстановления после отработки отказа.
    * Виртуальные машины и физические серверы рекомендуется объединять для того, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication7.png)
13. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

> [!NOTE]
> Если компьютер готов для принудительной установки, компонент службы Mobility будет установлен при включении защиты. После того как компонент будет установлен на компьютере, задание защиты будет запущено и завершится ошибкой. После сбоя каждый компьютер необходимо будет перезапустить вручную. После перезапуска задание защиты будет запущено снова и будет выполнена начальная репликация.
>
>

### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими
Рекомендуется проверить свойства исходного компьютера. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).

1. Щелкните **Параметры** > **Реплицированные элементы** и выберите нужный компьютер. В колонке **Основные компоненты** отображается информация о параметрах и состоянии компьютеров.
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

    ![Включение репликации](./media/site-recovery-vmware-to-azure/test-failover2.png)
3. В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure.
   Кроме того, можно просмотреть и добавить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure. Обратите внимание на следующее.

   * Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
   * Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

     * Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     * Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
     * Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
   * Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети.
   * Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером *по умолчанию* для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.

     ![Включение репликации](./media/site-recovery-vmware-to-azure/test-failover4.png)
4. На странице **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине, для которой будет выполняться репликация.

## <a name="step-7-test-the-deployment"></a>Шаг 7. Тестирование развертывания
Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.

### <a name="prepare-for-failover"></a>Подготовка к отработке отказа
* Для запуска тестовой отработки отказа рекомендуется создать сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании сети в Azure). [Узнайте больше](site-recovery-failover.md#run-a-test-failover) о выполнении тестовой отработки отказа.
* Для оптимальной производительности при отработке отказа в Azure установите агент Azure на защищенном компьютере. Это ускоряет загрузку и помогает устранять неполадки. Установите агент [Linux](https://github.com/Azure/WALinuxAgent) или агент [Windows](http://go.microsoft.com/fwlink/?LinkID=394789).
* Для полного тестирования развертывания необходимо, чтобы инфраструктура для реплицируемой виртуальной машины работала должным образом. Если нужно протестировать Active Directory и DNS, можно создать виртуальную машину в качестве контроллера домена с помощью DNS и реплицировать ее в Azure с помощью службы Azure Site Recovery. Узнайте больше о [рекомендациях по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#test-failover-considerations).
* Убедитесь, что сервер конфигурации запущен. В противном случае произойдет сбой отработки отказа.
* Если вы исключили диски из репликации, после отработки отказа их нужно будет создать вручную, чтобы приложение работало должным образом.
* Если нужно выполнить внеплановую отработку отказа вместо тестовой, обратите внимание на следующее.

  * По возможности перед выполнением внеплановой отработки отказа следует выключить основные машины. В этом случае исходные и реплицированные компьютеры не будут работать одновременно. При репликации виртуальных машин VMware можно указать, что служба Site Recovery должна использовать все доступные способы для выключения исходных компьютеров. В зависимости от состояния основного сайта это может сработать или не сработать. Если вы реплицируете физические серверы, Site Recovery не предоставляет такой возможности.
  * При выполнении внеплановой отработки отказа репликация данных с основных компьютеров прекращается. Поэтому изменения данных, внесенные после начала внеплановой отработки отказа, не будут переданы. Кроме того, при выполнении внеплановой отработки отказа в рамках плана восстановления она завершится даже в случае ошибки.

## <a name="failover"></a>Отработка отказа
По завершении начальной репликации для компьютеров по мере необходимости можно вызывать отработку отказа. Site Recovery поддерживает различные типы отработки отказа: тестовую, плановую и внеплановую.
[Узнайте больше](site-recovery-failover.md) о различных типах отработки отказа и ознакомьтесь с дополнительными сведениями о том, когда и как выполнять каждую из них.

> [!NOTE]
> Если вашей целью является миграция виртуальных машин в Azure, мы настоятельно рекомендуем использовать для этого [операцию плановой отработки отказа](site-recovery-failover.md#run-an-unplanned-failover). После проверки перенесенного приложения в Azure с помощью тестовой отработки отказа используйте инструкции, описанные в разделе [Завершение миграции виртуальных машин в Azure](#Complete-migration-of-your-virtual-machines-to-Azure), чтобы выполнить миграцию виртуальных машин. Нет необходимости выполнять фиксацию или удаление. При завершении миграции выполняется перенос виртуальной машины, удаляется ее защита и прекращается выставление счетов за использование Azure Site Recovery для этой виртуальной машины.
>
>

### <a name="run-an-unplanned-failover"></a>Выполнение внеплановой отработки отказа
В этой процедуре описывается, как запустить внеплановую отработку отказа для плана восстановления. В качестве альтернативы на вкладке "Виртуальные машины" можно запустить отработку отказа для отдельной виртуальной машины. Перед началом работы убедитесь, что все виртуальные машины, для которых необходимо выполнить отработку отказа, завершили начальную репликацию.

1. В разделе **Планы восстановления** выберите пункт с именем плана восстановления.
2. В колонке плана восстановления щелкните **Внеплановая отработка отказа**.
3. На странице **Внеплановая отработка отказа** выберите исходное и целевое расположения.
4. Установите флажок **Завершать работу виртуальных машин и синхронизировать последние данные**. Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных.
5. После отработки отказа виртуальные машины будут находиться в состоянии ожидании фиксации.  Для фиксации отработки отказа выберите команду **Зафиксировать** .

[Подробнее](site-recovery-failover.md#run-an-unplanned-failover)

## <a name="complete-migration-of-your-virtual-machines-to-azure"></a>Завершение миграции виртуальных машин в Azure
> [!NOTE]
> Следующие инструкции применяются только в том случае, если вы переносите виртуальные машины в Azure.
>
>

1. Выполните внеплановую отработку отказа, как указано [здесь](site-recovery-failover.md#run-an-unplanned-failover).
2. Выберите **Параметры > Реплицированные элементы**, щелкните правой кнопкой мыши виртуальную машину и выберите **Завершение миграции**.

    ![completemigration](./media/site-recovery-hyper-v-site-to-azure/migrate.png)
3. Нажмите кнопку **ОК** , чтобы завершить миграцию. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании завершения миграции, выбрав **Параметры > Site Recovery jobs (Задания Site Recovery)**.


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа
Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, обязательно сделайте следующее:

**На локальном компьютере до отработки отказа**.

* Чтобы получить доступ через Интернет, включите протокол RDP. Убедитесь, что правила TCP и UDP добавлены в разделе **Общее** и что RDP разрешен в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для всех профилей.
* Чтобы получить доступ через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Проверьте, разрешен ли протокол RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для сетей **домена** и **частных** сетей.
* Установите [агент виртуальной машины Azure](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) на локальном компьютере.
* [Установите службу Mobility Service вручную](#install-the-mobility-service-manually), не используя принудительную автоматическую установку службы через сервер обработки. Это связано с тем, что принудительная установка будет выполнена только после того, как для этого компьютера будет включена репликация.
* Задайте для политики сети SAN операционной системы значение OnlineAll. [Дополнительные сведения](https://support.microsoft.com/kb/3031135)
* Перед выполнением отработки отказа отключите службу IPSec.

**На виртуальной машине Azure после отработки отказа**.

* Добавьте общедоступную конечную точку для протокола RDP (порт 3389) и укажите учетные данные для входа.
* Убедитесь в отсутствии политик домена, которые не допускают подключение к виртуальной машине с использованием общедоступного адреса.
* Попытайтесь подключиться. Если вам не удалось подключиться, проверьте, запущена ли виртуальная машина. Дополнительные советы по устранению неполадок см. в этой [статье](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Если после отработки отказа нужно получить доступ к виртуальной машине Azure под управлением Linux с помощью клиента SSH, выполните следующее:

**На локальном компьютере до отработки отказа**.

* Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).
* Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.

**На виртуальной машине Azure после отработки отказа**.

* Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
* Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию), необходимо создать общедоступную конечную точку.
* Если доступ к виртуальной машине осуществляется через VPN-подключение (Express Route или VPN типа "сеть — сеть"), можно использовать клиент для прямого подключения к виртуальной машине по протоколу SSH.

**После отработки отказа на виртуальных машинах Windows или Linux в Azure**.

Если у вас есть группа безопасности сети, связанная с виртуальной машиной или подсетью виртуальной машины, убедитесь, что для этой группы существует разрешающее правило для исходящего HTTP или HTTPS трафика. Также убедитесь, что правильно настроена служба DNS для сети, в которую выполняется отработка отказа виртуальной машины. В противном случае отработка отказа может завершиться ошибкой "PreFailoverWorkflow task WaitForScriptExecutionTask timed out" (Истекло время ожидания выполнения задания WaitForScriptExecutionTask PreFailoverWorkflow). [Подробнее](site-recovery-monitoring-and-troubleshooting.md#recovery).

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину, а затем — значок **Добавить тестовую отработку отказа**.

    ![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/test-failover1.png)
2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).
3. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
4. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое открывается щелчком по виртуальной машине, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа дойдет до этапа **Завершение тестирования** , выполните следующие действия.

   1. Просмотрите реплику виртуальной машины на портале Azure. Проверьте, успешно ли выполнен запуск виртуальной машины.
   2. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
   3. Щелкните **Завершить тестирование** .

       ![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/test-failover6.png)
   4. Щелкните **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
   5. Выберите пункт **Тестовая отработка отказа завершена**, чтобы автоматически очистить тестовую среду. После этого для операции тестовой отработки отказа отобразится состояние **Завершено** .
   6. На этом этапе элементы или виртуальные машины, автоматически созданные Site Recovery во время тестовой отработки отказа, удаляются. Дополнительные элементы, созданные для тестовой отработки отказа, не удаляются.

      > [!NOTE]
      > Если отработка отказа выполняется более двух недель, она завершается принудительно.
      >
      >
6. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
7. Если вы заранее [подготовились к подключению после отработки отказа](#prepare-to-connect-to-azure-vms-after-failover), то сможете подключиться к виртуальной машине Azure.

## <a name="monitor-your-deployment"></a>Мониторинг развертывания
Вот как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery:

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты** . На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях.  Панель можно настроить таким образом, чтобы на ней отображались самые полезные элементы и макеты, например сведения о состоянии хранилищ.<br>
   ![Основные компоненты](./media/site-recovery-vmware-to-azure/essentials.png)
2. Элемент **Работоспособность** позволяет следить за серверами сайта (серверами VMM или серверами конфигурации), а также за событиями, о которых сообщила служба Site Recovery за последние 24 часа.
3. Мониторинг репликации и управление ею осуществляется с помощью элементов **Реплицированные элементы**, **Планы восстановления** и **Site Recovery Jobs** (Задания Site Recovery). Для получения подробных сведений о заданиях выберите **Параметры** > **Задания** > **Задания Site Recovery**.

## <a name="deploy-additional-process-servers"></a>Развертывание дополнительных серверов обработки
Если вы увеличите развертывание так, что количество компьютеров-источников превысит 200 или объем ежедневно изменяемых данных превысит 2 ТБ, для обработки такой нагрузки потребуются дополнительные серверы обработки.

Ознакомьтесь с [рекомендациями по выбору размера серверов обработки](#size-recommendations-for-the-process-server) и выполните приведенные ниже инструкции по настройке сервера обработки. После настройки сервера необходимо перевести исходные компьютеры на его использование.

### <a name="install-an-additional-process-server"></a>Установка дополнительного сервера обработки
1. Выберите **Параметры** > **Серверы Site Recovery**, выберите сервер конфигурации и щелкните **Сервер обработки**.

    ![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps1.png)
2. В поле **Тип сервера** щелкните **Сервер обработки (локальный)**.

    ![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps2.png)
3. Загрузите файл единой установки Site Recovery и запустите его, чтобы установить сервер обработки и зарегистрировать его в хранилище.
4. На странице **Перед началом работы** выберите **Add additional process servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).
5. Завершите работу мастера так же, как и при [настройке](#step-2-set-up-the-source-environment) сервера конфигурации.

    ![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/add-ps1.png)
6. На странице **Сведения о сервере конфигурации** укажите IP-адрес сервера конфигурации и парольную фразу. Чтобы получить эту парольную фразу, выполните на сервере конфигурации команду **<SiteRecoveryInstallationFolder>\home\sysystems\bin\genpassphrase.exe –n**.

    ![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/add-ps2.png)

### <a name="migrate-machines-to-use-the-new-process-server"></a>Перенос компьютеров для использования нового сервера обработки
1. В разделе **Параметры** > **Серверы Site Recovery** щелкните сервер конфигурации и разверните список **Серверы обработки**.

    ![Обновление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps2.png)
2. Щелкните используемый сервер обработки правой кнопкой мыши и выберите **Переключить**.

    ![Обновление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps3.png)
3. В поле **Выбор целевого сервера обработки** выберите новый сервер обработки, который нужно использовать, а затем — виртуальные машины, с которыми он будет работать. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Щелкните значок галочки, чтобы начать репликацию на новом сервере обработки.

## <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware
Службе Site Recovery нужен доступ к учетным записям VMware для отработки отказа и восстановления размещения, а также для автоматического обнаружения виртуальных машин на сервере vCenter. В следующей таблице представлены общие сведения о необходимых разрешениях ролей.

* Если вам нужно только обнаружение виртуальных машин и отработка отказа в Azure, но не требуется восстановление размещения (или миграция), можно использовать учетную запись с правами только для чтения.
* Для отработки отказа и восстановления размещения мы рекомендуем создать роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначить эту роль пользователю или группе VMware.

| **Задача.** | **Тип роли** | **Разрешения** | **Дополнительные сведения** |
| --- | --- | --- | --- |
| Обнаружение VMware<br/><br/> Отработка отказа в Azure без выключения исходной виртуальной машины (удобно для миграции, если не требуется восстановление размещения). |Пользователь VMware с правами только для чтения |Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only |Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль "Без доступа" с параметром "Распространить на дочерний объект". |
| Отработка отказа и восстановление размещения |Пользователь VMware<br/><br/> Этот пользователь должен иметь возможность выполнять такие операции, как создание и удаление дисков, включение виртуальных машин и т. д.<br/><br/> Мы рекомендуем создать роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначить эту роль пользователю или группе VMware. |Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. |Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль "Без доступа" с параметром "Распространить на дочерний объект". |

## <a name="next-steps"></a>Дальнейшие действия
* [Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа.
* Изучите статью [Восстановление размещения виртуальных машин VMware и физических серверов на локальном сайте](site-recovery-failback-azure-to-vmware.md).

## <a name="third-party-software-notices-and-information"></a>Уведомления и сведения о стороннем программном обеспечении
Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).  Microsoft is the not original author of the Third Party Code.  The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only.  This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.  

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.



<!--HONumber=Dec16_HO2-->


