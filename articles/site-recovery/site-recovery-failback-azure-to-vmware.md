<properties 
   pageTitle="Пошаговое руководство по восстановлению размещения в VMware после использования Azure для отработки отказа" 
   description="В этой статье описано, как с помощью Azure Site Recovery и средства vContinuum можно восстановить размещение виртуальной машины в VMware после отработки отказа." 
   services="site-recovery" 
   documentationCenter="" 
   authors="ruturaj" 
   manager="mkjain" 
   editor=""/>

<tags
   ms.service="site-recovery"
   ms.devlang="powershell"
   ms.tgt_pltfrm="na"
   ms.topic="article"
   ms.workload="required" 
   ms.date="10/07/2015"
   ms.author="ruturajd@microsoft.com"/>

# Пошаговое руководство по восстановлению размещения в VMware после использования Azure для отработки отказа

В данном документе содержится пошаговое руководство по восстановлению размещения на сайте VMware после использования Azure для отработки отказа. Прежде чем приступить к работе со статьей, выполните действия, описанные в учебнике по [защите и восстановлению с использованием репликации из VMware в Azure](site-recovery-vmware-to-azure.md).

После успешной отработки отказа с выполнением переноса в Azure виртуальные машины будут доступны на вкладке виртуальных машин. Чтобы восстановить размещение, выполните описанные в данной статье действия.

Обратите внимание: когда вы восстанавливаете размещение на сайте VMware после отработки отказа в Azure, вы можете выполнить восстановление только с использованием виртуальной машины. Даже если источник в VMware был физическим компьютером, при отработке отказа с выполнением переноса в Azure и последующем восстановлении размещения в VMware он будет преобразован в виртуальную машину.

## Обзор

1.  Локальная установка сервера vContinuum

    а. Настройка сервера vContinuum так, чтобы он указывал на сервер конфигурации

2.  Развертывание сервера обработки в Azure

3.  Локальная установка главного целевого сервера

4.  Действия по защите виртуальных машин, для которых выполнена отработка отказа, необходимые при переносе этих виртуальных машин обратно в локальную среду

    а. Рекомендации по настройке конфигурации

5.  Мониторинг защиты виртуальных машин при переносе этих машин обратно в локальную среду

6.  Перенос виртуальных машин обратно в локальную среду после отработки их отказа

На схеме ниже показаны необходимые компоненты. Установка некоторых из них описана далее в этой статье. Остальные компоненты уже были установлены во время отработки отказа.

-   Синие линии — это подключения, используемые в процессе отработки отказа.

-   Красные линии — это подключения, используемые в процессе восстановления размещения.

-   Линии со стрелками — это подключения к Интернету.

![](./media/site-recovery-failback-azure-to-vmware/vconports.png)

## Локальная установка vContinuum

Программу установки vContinuum можно скачать из [расположения загрузки](http://go.microsoft.com/fwlink/?linkid=526305). Кроме того, установите приведенное здесь обновление для vContinuum, которое также можно скачать из [расположения загрузки](http://go.microsoft.com/fwlink/?LinkID=533813).

1.  Запустите программу установки vContinuum. Нажмите кнопку **Далее**. ![](./media/site-recovery-failback-azure-to-vmware/image2.png)
2.  Укажите IP-адрес и порт сервера CX. Выберите протокол HTTPS.

	![](./media/site-recovery-failback-azure-to-vmware/image3.png)

3.  Для обнаружения CX IP-адреса перейдите в развертывание CS в Azure и просмотрите его панель мониторинга.

	![](./media/site-recovery-failback-azure-to-vmware/image4.png)

4.  Для обнаружения общедоступного порта CX перейдите на вкладку конечных точек на странице виртуальной машины и определите открытый порт конечных точек HTTPs.

	![](./media/site-recovery-failback-azure-to-vmware/image5.png)

5.  Укажите парольную фразу сервера конфигурации. Вы должны были записать ее в процессе регистрации сервера конфигурации. Возможно, вы использовали эту парольную фразу во время развертывания главного целевого сервера и сервера обработки. Если вы не помните парольную фразу, перейдите на сервер конфигурации в Azure и найдите ее в папке C:\\Program Files (x86)\\InMage Systems\\private\\connection.passphrase.

	![](./media/site-recovery-failback-azure-to-vmware/image6.png)

6.  Укажите расположение для установки сервера vContinuum и начните установку.

	![](./media/site-recovery-failback-azure-to-vmware/image7.png)

7.  По завершении установки можно запустить сервер vContinuum, чтобы проверить, работает ли он. ![](./media/site-recovery-failback-azure-to-vmware/image8.png)


## Установка сервера обработки в Azure

Чтобы виртуальные машины в Azure могли отправлять данные локальному главному целевому серверу, в Azure необходимо установить сервер обработки. Сервер обработки необходимо развернуть в той же сети, в которой находится сервер конфигурации.

1.  На странице **серверов конфигурации** в Azure выберите команду добавления нового сервера обработки.

	![](./media/site-recovery-failback-azure-to-vmware/image9.png)

2.  Укажите имя сервера обработки, а также введите имя и пароль для подключения к виртуальной машине от имени администратора. Выберите сервер конфигурации, на котором необходимо зарегистрировать сервер обработки. Это должен быть тот же сервер, который используется для защиты и отработки отказа на виртуальных машинах. Укажите сеть Azure, в которой должен быть развернут сервер обработки. Это должна быть та же сеть, которая используется для сервера конфигурации. Укажите уникальный IP-адрес из выбранной подсети и начните развертывание.

	![](./media/site-recovery-failback-azure-to-vmware/image10.png)


Будет запущено задание развертывания сервера обработки.

![](./media/site-recovery-failback-azure-to-vmware/image11.png)

По завершении развертывания сервера обработки в Azure можно войти в него, используя указанные вами учетные данные. Для регистрации сервера обработки выполните те же действия, которые вы выполняли в процессе обеспечения защиты в прямом направлении.

![](./media/site-recovery-failback-azure-to-vmware/image12.png)

Серверы, зарегистрированные в процессе возврата после отработки отказа размещения, не отображаются в разделе свойств виртуальной машины. Они будут отображаться только на вкладке "Серверы" в разделе сервера конфигурации, на котором они были зарегистрированы. Чтобы сервер обработки отобразился в разделе сервера конфигурации, может потребоваться примерно 10–15 минут.

## Установка локального главного целевого сервера

Вам понадобится установить в локальной системе главный целевой сервер под управлением ОС Linux или Windows. Выбор ОС зависит от того, какими были исходные виртуальные машины.

### Развертывание главного целевого сервера под управлением ОС Windows

Главный целевой сервер под управлением этой операционной системы уже включен в комплект программы установки vContinuum. При установке vContinuum на том же компьютере будет установлен главный целевой сервер. Кроме того, он будет зарегистрирован на сервере конфигурации.

1.  Чтобы начать развертывание, создайте локальную пустую машину на узле ESX, на который необходимо восстановить виртуальные машины из Auzre.

2.  Убедитесь, что к виртуальной машине подключено не менее двух дисков: один — для операционной системы, а второй — для диска хранения.

3.  Установите операционную систему.

4.  Установите vContinuum на сервере. При этом будет завершена установка главного целевого сервера.

### Развертывание главного целевого сервера под управлением ОС Linux

1.  Чтобы начать развертывание, создайте локальную пустую машину на узле ESX, на который необходимо восстановить виртуальные машины из Auzre.

2.  Убедитесь, что к виртуальной машине подключено не менее двух дисков: один — для операционной системы, а второй — для диска хранения.

3.  Установите необходимую операционную систему. В системе главного целевого сервера под управлением ОС Linux не следует использовать LVM для корня файловой системы или хранения дисковых пространств. По умолчанию главный целевой сервер под управлением ОС Linux настроен так, чтобы не обнаруживать разделы и диски LVM.
4.  Ниже перечислены разделы, которые можно создать.

	![](./media/site-recovery-failback-azure-to-vmware/image13.png)

5.  После установки операционной системы выполните указанные ниже действия. Их необходимо выполнять до установки главного целевого сервера.


#### Действия, которые необходимо выполнить после установки ОС

Чтобы получить идентификаторы SCSI для всех жестких дисков SCSI в виртуальной машине под управлением ОС Linux, необходимо присвоить параметру disk.EnableUUID значение TRUE. Чтобы включить этот параметр, выполните указанные ниже действия.

1. Завершите работу виртуальной машины.
2. Щелкните правой кнопкой мыши запись виртуальной машины на левой панели > **Изменить параметры**.
3. Откройте вкладку **Параметры**. Последовательно выберите пункты **Дополнительно и Общие** слева, а затем нажмите кнопку **Параметры конфигурации** справа. Когда виртуальная машина работает, кнопка "Параметры конфигурации" неактивна. Чтобы она стала активной, завершите работу машины.

	![](./media/site-recovery-failback-azure-to-vmware/image14.png)

4. Посмотрите, есть ли строка с параметром **disk.EnableUUID**. Если такая строка существует и параметр имеет значение False, замените его на True (значения True и False можно вводить в любом регистре). Если строка существует и параметр имеет значение True, нажмите кнопку "Отмена" и после загрузки операционной системы на виртуальной машине проверьте в ней команду SCSI. Если такой строки нет, нажмите кнопку **Добавить строку**.
5. В столбце "Имя" добавьте параметр disk.EnableUUID. Присвойте этому параметру значение TRUE. Не заключайте указанные выше значения в двойные кавычки.

	![](./media/site-recovery-failback-azure-to-vmware/image15.png)

#### Загрузка и установка дополнительных пакетов

ПРИМЕЧАНИЕ. Прежде чем приступить к скачиванию и установке дополнительных пакетов, убедитесь, что система подключена к Интернету.

\# yum install -y xfsprogs perl lsscsi rsync wget kexec-tools

Эта команда скачает 15 перечисленных ниже пакетов из репозитория CentOS 6.6 и установит их.

bc-1.06.95-1.el6.x86\_64.rpm

busybox-1.15.1-20.el6.x86\_64.rpm

elfutils-libs-0.158-3.2.el6.x86\_64.rpm

kexec-tools-2.0.0-280.el6.x86\_64.rpm

lsscsi-0.23-2.el6.x86\_64.rpm

lzo-2.03-3.1.el6\_5.1.x86\_64.rpm

perl-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-Module-Pluggable-3.90-136.el6\_6.1.x86\_64.rpm

perl-Pod-Escapes-1.04-136.el6\_6.1.x86\_64.rpm

perl-Pod-Simple-3.13-136.el6\_6.1.x86\_64.rpm

perl-libs-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-version-0.77-136.el6\_6.1.x86\_64.rpm

rsync-3.0.6-12.el6.x86\_64.rpm

snappy-1.1.0-1.el6.x86\_64.rpm

wget-1.12-5.el6\_6.1.x86\_64.rpm

ПРИМЕЧАНИЕ. Если в исходной машине для корневого устройства или устройства загрузки используется файловая система Reiser или XFS, то до начала мероприятий по защите необходимо скачать указанные ниже пакеты и установить их на главный целевой сервер под управлением ОС Linux.

\# cd /usr/local

\# wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm>

\# wget
<http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm>

\# rpm -ivh kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm
reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm

\# wget
<http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_64.rpm>

\# rpm -ivh xfsprogs-3.1.1-16.el6.x86\_64.rpm

#### Применение изменений настраиваемой конфигурации

Перед применением изменений настраиваемой конфигурации убедитесь, что все действия, которые необходимо выполнить после установки операционной системы, сделаны.

Чтобы применить изменения настраиваемой конфигурации, выполните указанные ниже действия.

1. Скопируйте двоичный файл унифицированного агента RHEL 6-64 в установленную операционную систему.

2. Запустите указанную ниже команду, чтобы распаковать двоичный файл.

**tar -zxvf <Имя\_файла>**

3. Выполните указанную ниже команду, чтобы предоставить необходимое разрешение.

\# **chmod 755 ./ApplyCustomChanges.sh**

4. Выполните указанную ниже команду, чтобы запустить необходимый сценарий.

**# ./ApplyCustomChanges.sh**

ПРИМЕЧАНИЕ. Этот сценарий необходимо выполнить на сервере только один раз. После успешного выполнения указанного выше сценария **ПЕРЕЗАПУСТИТЕ** сервер.

### Начало установки главного целевого сервера

[Скачайте](http://go.microsoft.com/fwlink/?LinkID=529757) файл установщика главного целевого сервера под управлением ОС Linux.

С помощью любой служебной программы SFTP-клиента скопируйте скачанный установщик главного целевого сервера под управлением ОС Linux на соответствующую виртуальную машину. Помимо этого, можно войти в виртуальную машину главного целевого сервера под управлением ОС Linux и с помощью команды wget скачать пакет установки по указанной ссылке.

С помощью любой служебной программы SSH-клиента войдите в виртуальную машину главного целевого сервера под управлением ОС Linux.

Если вы подключены к сети Azure, в которой развернут главный целевой сервер под управлением ОС Linux, через VPN-подключение, то для подключения к этому серверу по протоколу SSH используйте его внутренний IP-адрес, отображаемый на панели мониторинга виртуальной машины, и порт 22.

Если вы подключаетесь к главному целевому серверу под управлением ОС Linux через общедоступное подключение к Интернету, используйте общедоступный виртуальный IP-адрес этого сервера (отображаемый на странице панели мониторинга виртуальных машин) и общедоступную конечную точку, созданную для входа в сервер с использованием протокола SSH.

С помощью программы gzip извлеките файлы установщика главного целевого сервера под управлением ОС Linux из TAR-архива. Для этого выполните следующую команду:

*tar –xvzf Microsoft-ASR\_UA\_8.2.0.0\_RHEL6-64** в каталоге, в который вы скопировали установщик.

![](./media/site-recovery-failback-azure-to-vmware/image16.png)

Если вы извлекли файлы установщика в другой каталог, то перейдите в него. В этом каталоге выполните команду sudo ./install.sh.

![](./media/site-recovery-failback-azure-to-vmware/image17.png)

Когда будет предложено выбрать основную роль этого агента, выберите вариант 2 (главный целевой сервер).

Для всех остальных параметров интерактивной установки оставьте значения по умолчанию.

Дождитесь завершения процесса установки и отображения интерфейса настройки узла. Для настройки главного целевого сервера под управлением ОС Linux используется служебная программа настройки узла, работающая в командной строке. Не изменяйте размер окна служебной программы SSH-клиента. С помощью клавиш со стрелками выберите параметр "Глобальные" и нажмите клавишу ВВОД на клавиатуре.

![](./media/site-recovery-failback-azure-to-vmware/image18.png)

![](./media/site-recovery-failback-azure-to-vmware/image19.png)

1.  В поле "IP-адрес" введите внутренний IP-адрес сервера конфигурации, отображаемый на странице панели мониторинга виртуальных машин, и нажмите клавишу ВВОД.

2.  В поле "Порт" введите значение 22 и нажмите клавишу ВВОД.

3.  Для параметра "Использовать протокол HTTPS" оставьте значение "Да". Нажмите клавишу ВВОД еще раз.

4.  Введите парольную фразу, созданную на сервере конфигурации. Если вы используете клиент PuTTY на машине под управлением ОС Windows для подключения к виртуальной машине главного целевого сервера под управлением ОС Linux с помощью протокола SSH, то для вставки содержимого буфера обмена можно использовать клавиши SHIFT+INSERT. Нажмите клавиши CTRL+C, чтобы скопировать парольную фразу в локальный буфер обмена, а затем вставьте ее с помощью клавиш SHIFT+INSERT. Нажмите клавишу ВВОД.

5.  С помощью клавиш со стрелками выберите пункт "Выход" и нажмите клавишу ВВОД.

Дождитесь завершения процесса установки.

![](./media/site-recovery-failback-azure-to-vmware/image20.png)

Если по какой-либо причине не удалось зарегистрировать главный целевой сервер Linux на сервере конфигурации, можно повторить попытку, запустив служебную программу настройки узла в каталоге /usr/local/ASR/Vx/bin/hostconfigcli (перед этим вам потребуется настроить разрешения на доступ к этому каталогу, выполнив команду chmod от имени суперпользователя).


#### Выполните проверку регистрации главного целевого сервера на сервере конфигурации.

Чтобы проверить, успешно ли зарегистрирован главный целевой сервер на сервере конфигурации, перейдите на страницу сведений о серверах на странице сервера конфигурации в хранилище Azure Site Recovery.

Примечание. После регистрации главного целевого сервера вы можете обнаружить, что в его конфигурации есть ошибка. Возможные причины этой ошибки: возможно, что виртуальная машина удалена из Azure, либо конечные точки не настроены должным образом. Это вызвано тем, что конфигурация главного целевого сервера обнаружена конечными точками Azure во время развертывания этого сервера в Azure. Однако это не распространяется в отношении локального главного целевого сервера; в этом случае эту ошибку можно проигнорировать. Это не повлияет на восстановление размещения


## Включение защиты виртуальных машин при их переносе в локальную среду

Прежде чем восстанавливать размещение виртуальных машин в локальной среде, необходимо обеспечить их защиту при переносе в локальную среду. Выполните указанные ниже действия, чтобы защитить виртуальные машины приложения.

### Временный диск

При отработке отказа виртуальной машины с выполнением переноса в Azure добавляется дополнительный временный диск для файла подкачки. Этот диск обычно не требуется для виртуальной машины, для которой выполняется отработка отказа, так как в ней уже может быть диск, предназначенный для файла подкачки.

Перед началом процесса обратной защиты виртуальных машин убедитесь, что этот диск переведен в автономный режим и не будет защищен.

Чтобы сделать это,

1.  Откройте раздел управления компьютером (это можно сделать с помощью средства администрирования на панели управления. Кроме того, можно щелкнуть правой кнопкой мыши пункт "Этот компьютер" в окне проводника и выбрать пункт "Управление").

2.  Выберите пункт "Управление службой хранилища", чтобы отобразить работающие и подключенные к машине диски.

3.  Выберите временный диск, подключенный к машине, и выберите команду перевода его в автономный режим.

4.  После успешного перевода диска в автономный режим можно начать процесс защиты виртуальной машины в обратном направлении.

### План защиты для виртуальных машин

На портале Azure просмотрите состояния виртуальных машин и убедитесь, что для них выполнена отработка отказа.

![](./media/site-recovery-failback-azure-to-vmware/image21.png)

Примечание. Во время отработки отказа с выполнением переноса из Azure обратно в локальную среду виртуальная машина Azure обрабатывается как физический сервер. При отработке отказа с переносом из Azure в локальную среду используется виртуальная машина.

1.  Запустите vContinuum на компьютере

![](./media/site-recovery-failback-azure-to-vmware/image8.png)

2.  Для параметра **Choose Application** (Выберите приложение) задайте значение **P2V**.

3.  Для начала работы выберите пункт **New Protection** (Создать защиту).

4.  В открывшемся окне задайте настройки защиты виртуальных машин при их переносе обратно в локальную среду.

    а. Выберите значение **OS type** (Тип ОС) в соответствии с операционными системами виртуальных машин, для которых необходимо выполнить восстановление размещения, а затем — пункт **Get Details** (Получить сведения).

    b. В разделе **Primary server details** (Сведения об основном сервере) определите виртуальные машины, которые необходимо защитить.

    c. В списке перечислены имена узлов компьютеров виртуальных машин, а не те имена, которые отображаются в vCenter или в Azure.

    г) В списке имен узлов vCenter отображаются виртуальные машины, которые были там до отработки отказа.

    д. После определения виртуальных машин, которые необходимо защитить, выберите их одну за другой.

5.  При выборе виртуальной машины, которую необходимо защитить (и для которой выполнена отработка отказа с переносом в Azure), отобразится всплывающее окно с двумя записями для этой виртуальной машины. Это происходит из-за того, что сервер конфигурации обнаруживает два экземпляра зарегистрированных на нем виртуальных машин. Необходимо удалить запись локальной виртуальной машины, чтобы защитить правильную виртуальную машину. Обратите внимание, что в записях будут отображены имена узлов компьютеров. Чтобы определить правильную запись виртуальной машины Azure, войдите в виртуальную машину Azure и перейдите в папку C:\\Program Files (x86)\\Microsoft Azure Site Recovery\\Application Data\\etc. В файле drscout.conf найдите адрес узла. В диалоговом окне vContinuum сохраните запись, для которой в виртуальной машине найден адрес узла. Удалите все другие записи.

![](./media/site-recovery-failback-azure-to-vmware/image22.png)

6.  Чтобы выбрать нужную виртуальную машину, можно указать ее IP-адрес. Диапазон IP-адресов локальной сети будет диапазоном локальной виртуальной машины.
7.  Щелкните **Удалить**, чтобы удалить эту запись.

![](./media/site-recovery-failback-azure-to-vmware/image23.png)

8.  Перейдите к серверу vCenter и остановите виртуальную машину на vCenter
9.  Затем вы можете удалить локальные виртуальные машины.
10.  Далее укажите локальный главный целевой сервер, на который необходимо перенести виртуальные машины для их защиты.
11.  Для этого подключитесь к vCenter, на который необходимо выполнить возврат после отработки отказа.

![](./media/site-recovery-failback-azure-to-vmware/image24.png)

12.  Выберите главный целевой сервер на основе узла, на который необходимо восстановить виртуальные машины.

![](./media/site-recovery-failback-azure-to-vmware/image24.png)

13.  Далее укажите параметры репликации для каждой виртуальной машины.

![](./media/site-recovery-failback-azure-to-vmware/image25.png)

14.  Для этого необходимо выбрать **Хранилище данных** на стороне восстановления. Это хранилище данных, в которое будут восстановлены виртуальные машины.

Ниже перечислены различные параметры, которые необходимо указать для каждой виртуальной машины.

**Параметр** | **Рекомендуемое значение параметра**
---|---
IP-адрес сервера обработки | Выберите сервер обработки, который вы развернули в Azure
Размер хранения в мегабайтах| 
Значение хранения | 1
Дни или часы | Дни
Интервал согласованности | 1
Выберите целевое хранилище данных | Хранилище данных, доступное на стороне восстановления. В этом хранилище должно быть достаточно места. Оно должно быть доступно для узла ESX, на котором необходимо реализовать виртуальную машину.
15.  Затем можно настроить свойства, которые получит виртуальная машина после отработки отказа с выполнением переноса на локальный сайт. Вы можете настроить различные свойства, как показано ниже.

![](./media/site-recovery-failback-azure-to-vmware/image26.png)


**Свойство** | **Настройка**
---|---
Конфигурация сети|Для каждой обнаруженной сетевой карты настройте IP-адрес восстановления размещения для виртуальной машины. Выберите необходимый сетевой адаптер и нажмите кнопку **Изменить**, чтобы указать сведения об IP-адресе.
Конфигурация оборудования|Для виртуальной машины можно указать значения ЦП и памяти. Этот параметр можно применить ко всем виртуальным машинам, которые необходимо защитить.
Отображаемое имя|Чтобы определить правильные значения для ЦП и памяти, можно отобразить размеры ролей виртуальных машин "Инфраструктура как услуга" и посмотреть количество назначенных ядер и объем назначенной памяти.
Отображаемое имя|Когда вы выполните отработку отказа с переносом в локальную среду, можно будет переименовать виртуальные машины и присвоить им имена, которые будут отображаться в списке виртуальных машин в vCenter. Обратите внимание, что по умолчанию здесь отображается имя узла компьютера виртуальной машины. Чтобы определить имя виртуальной машины, посмотрите список виртуальных машин в группе "Protection" (Защита).
Конфигурация преобразования сетевых адресов (NAT)|Порядок настройки подробно рассмотрен ниже

![](./media/site-recovery-failback-azure-to-vmware/image27.png)



> **Параметры преобразования сетевых адресов (NAT) для сервера обработки**
>
> Чтобы включить защиту виртуальных машин, необходимо создать два канала связи.
>
> Первый канал соединяет виртуальную машину и сервер обработки. Он служит для сбора данных с виртуальной машины и отправки их на сервер обработки. Далее сервер обработки отправляет эти данные на главный целевой сервер. Если сервер обработки и виртуальная машина, которую необходимо защитить, находятся в одной и той же сети Azure, то не нужно использовать параметры преобразования сетевых адресов (NAT). Если сервер обработки и виртуальная машина, которую необходимо защитить, находятся в разных виртуальных сетях, вам придется указать параметры преобразования сетевых адресов (NAT) для сервера обработки и проверить первый параметр.
>
> ![](./media/site-recovery-failback-azure-to-vmware/image28.png)
>
> Чтобы определить общедоступный IP-адрес сервера обработки, можно перейти к развертыванию этого сервера в Azure и там посмотреть необходимый IP-адрес.
>
> Второй канал соединяет сервер обработки и главный целевой сервер. Необходимость преобразования сетевых адресов (NAT) зависит от того, используете ли вы подключение на основе VPN между главным целевым сервером и сервером обработки или осуществляете защиту, передавая данные через Интернет. Если сервер обработки обменивается данными с главным целевым сервером через VPN-подключение, то не следует выбирать этот вариант. Если главному целевому серверу необходимо обмениваться данными с сервером обработки через Интернет, укажите параметры преобразования сетевых адресов (NAT) для сервера обработки.
>
> ![](./media/site-recovery-failback-azure-to-vmware/image29.png)
>
> Чтобы определить общедоступный IP-адрес сервера обработки, можно перейти к развертыванию этого сервера в Azure и там посмотреть необходимый IP-адрес.
>
> ![](./media/site-recovery-failback-azure-to-vmware/image30.png)

1.  Если вы не удалили локальные виртуальные машины (как указано в действии 5.г), а также если в хранилище данных, используемом для восстановления размещения (выбранном в действии 7.а), по-прежнему находятся старые VMDK, то необходимо убедиться, что при восстановлении размещения виртуальные машины создаются в новом месте. Для этого можно открыть дополнительные настройки и в разделе **Folder Name Settings** (Параметры имени папки) указать другую папку для восстановления.

![](./media/site-recovery-failback-azure-to-vmware/image31.png)

Для других параметров в разделе дополнительных параметров можно оставить значения по умолчанию. Убедитесь, что параметры имени папки будут применены ко всем серверам.

2.  Далее перейдите на последний этап процедуры защиты. Здесь необходимо проверить, подготовлены ли виртуальные машины к процедурам их защиты при переносе обратно в локальную среду.

![](./media/site-recovery-failback-azure-to-vmware/image32.png)

	a.  Click on the readiness check and wait for it to complete.

	b.  The Readiness Report tab will give the information if all the
    virtual machines are ready.

	c.  If the Readiness Report is successful on all the virtual machines it
    will allow you to specify a name to the Protection plan

![](./media/site-recovery-failback-azure-to-vmware/image33.png)

	d.  Give the plan a new Name and begin Protect by clicking the button
    below.


3.  После этого начнется процесс защиты.

    а. Вы можете следить за ходом защиты на сервере vContinuum.

![](./media/site-recovery-failback-azure-to-vmware/image34.png)

	b.  Once the step **Activating Protection Plan** is completed, you can
    monitor the protection of the virtual machines via the ASR Portal.

	c.  You can also monitor the protection via Azure Site Recovery.

![](./media/site-recovery-failback-azure-to-vmware/image35.png)

Кроме того, можно отобразить точное состояние пар. Для этого щелкните необходимую виртуальную машину и отслеживайте ход выполнения процесса для нее в разделе репликации томов.

![](./media/site-recovery-failback-azure-to-vmware/image36.png)

## Подготовка плана восстановления размещения

С помощью vContinuum можно подготовить план восстановления размещения. Это позволит в любое время перенести приложение обратно в локальную среду в случае отработки отказа. Эти планы восстановления очень похожи на планы восстановления Azure Site Recovery.

1.  Запустите vContinuum и установите флажок **Manage plans** (Управление планами).

2.  Установите отобразившийся после этого флажок **Recover** (Восстановление).

![](./media/site-recovery-failback-azure-to-vmware/image37.png)

3.  Можно отобразить список всех планов, использовавшихся для защиты этой виртуальной машины. Это те же планы, которые можно использовать для восстановления.

4.  Выберите необходимый план защиты и все виртуальные машины, которые требуется восстановить в рамках этого плана.

    а. Выбрав какую-либо виртуальную машину, можно отобразить дополнительные сведения об исходной виртуальной машине, целевом сервере ESX, на который будет восстановлена виртуальная машина, и диске исходной виртуальной машины.

5.  Нажмите кнопку "Next" (Далее), чтобы запустить мастер **восстановления**.

6.  Выберите виртуальные машины, которые необходимо восстановить.

    а. Отобразите список всех виртуальных машин, которые можно восстановить.

![](./media/site-recovery-failback-azure-to-vmware/image38.png)

	b.  You can **recover based on** multiple options however we recommend
    the **Latest Tag.** This will ensure that the latest data from the
    virtual machine will be used.

	c.  Select **Apply for All VMs** to ensure that the latest tag will be
    chosen for all the virtual machines.


7.  Запустите проверку готовности (кнопка **Run Readiness Check**). Проверка покажет, правильно ли настроены параметры для восстановления последнего тега виртуальной машины. Если все проверки успешно выполнены, нажмите кнопку "Next" (Далее). В противном случае просмотрите журнал и устраните причины ошибок.

![](./media/site-recovery-failback-azure-to-vmware/image39.png)

8.  На этапе настройки виртуальной машины в мастере проверьте, правильно ли заданы параметры восстановления. Если значения параметров виртуальной машины отличаются от требуемых, можно изменить их. Так как мы уже выполнили это действие во время защиты, можно пропустить его.

![](./media/site-recovery-failback-azure-to-vmware/image40.png)

9.  И, наконец, просмотрите список виртуальных машин, которые будут восстановлены.

    а. Укажите порядок восстановления для виртуальных машин.

Примечание. В списке отображаются имена узлов компьютеров виртуальных машин. Может быть трудно сопоставить имена узлов компьютеров с виртуальными машинами. Чтобы сопоставить эти имена, откройте панель мониторинга виртуальных машин в разделе "Инфраструктура как услуга" в Azure и там посмотрите имя узла виртуальной машины.

![](./media/site-recovery-failback-azure-to-vmware/image41.png)

10.  Укажите имя в поле **Recovery plan name** (Имя плана восстановления) и в разделе **Recovery options** (Параметры восстановления) установите флажок **Recover later** (Восстановить позднее).

    а. Если необходимо выполнить восстановление немедленно, в разделе **Recovery options** (Параметры восстановления) установите флажок **Recover now** (Восстановить сейчас).

    b. Рекомендуется выбрать пункт "Recover later" (Восстановить позднее), так как, возможно, еще не выполнена первоначальная репликация.

    c. В завершение нажмите кнопку **Recover** (Восстановить), чтобы сохранить план либо запустить процесс восстановления на основе заданных вами **параметров восстановления**.

11.  Вы можете просмотреть состояние восстановления и узнать, успешно ли сохранен план.

![](./media/site-recovery-failback-azure-to-vmware/image42.png)

12.  Если вы решили выполнить восстановление позднее, отобразится сообщение о том, что создан план и вы можете выполнить восстановление позднее.

![](./media/site-recovery-failback-azure-to-vmware/image43.png)

## Восстановление виртуальных машин

После создания плана можно восстановить виртуальные машины. Следует обязательно убедиться, что для виртуальных машин выполнена синхронизация.

![](./media/site-recovery-failback-azure-to-vmware/image44.png)

Если состояние репликации имеет значение "OK", это означает, что защита выполнена и достигнут порог целевой точки восстановления. Убедиться в работоспособности пары репликации можно в свойствах виртуальной машины.

**Прежде чем запустить процесс восстановления, выключите виртуальные машины Azure. Благодаря этому не произойдет разделения вычислительных мощностей и ваши конечные пользователи будут обслуживаться одной копией приложения. Указанные ниже действия можно выполнять только в том случае, если виртуальные машины Azure выключены.**

Чтобы запустить процесс восстановления виртуальных машин (их возвращения в локальную среду), необходимо запустить сохраненный ранее план.

1.  На сервере vContinuum выберите команду **Monitor** (Отслеживание) для планов.

2.  Мастер отобразит планы, выполненные до настоящего момента.

![](./media/site-recovery-failback-azure-to-vmware/image45.png)

3.  Выберите **Recovery** (Восстановление) и нужный план.

    а. Отобразится сообщение о том, что план еще не запущен.

4.  Чтобы начать восстановление, выберите команду **Start** (Запустить).

5.  Вы можете отслеживать восстановление виртуальных машин.


![](./media/site-recovery-failback-azure-to-vmware/image46.png)

6. После включения виртуальных машин вы можете подключаться к ним в vCenter.

## Повторная обеспечение защиты в Azure после восстановления размещения

После завершения восстановления размещения можно обеспечить защиту виртуальных машин еще раз. Чтобы перенастроить защиту, выполните указанные ниже действия.

1.  Убедитесь, что локальные виртуальные машины работают и приложению удается связаться с конечными пользователями.

2.  На портале Azure Site Recovery выберите виртуальные машины и удалите их.

    а. Выключите защиту виртуальных машин. После этого виртуальные машины больше не будут защищены.

3.  Откройте список виртуальных машин в разделе "Инфраструктура как услуга" в Azure и удалите виртуальные машины, для которых выполнена отработка отказа.

4.  Удалите старые виртуальные машины в vSpehere. Это виртуальные машины, для которых ранее выполнено отработка отказа с переносом в Azure.

5.  На портале Azure Site Recovery включите параметр защиты виртуальных машин, для которых недавно выполнена отработка отказа.

6.  После защиты виртуальных машин можно добавить их в план восстановления, чтобы они были постоянно защищены.


 

<!---HONumber=Oct15_HO2-->