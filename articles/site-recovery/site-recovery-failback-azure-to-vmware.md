<properties 
   pageTitle="Восстановление размещения виртуальных машин VMware и физических серверов на локальном сайте | Microsoft Azure"
   description="Сведения о восстановлении размещения на локальном сайте после отработки отказа виртуальных машин VMware и физических серверов с переносом в Azure." 
   services="site-recovery" 
   documentationCenter="" 
   authors="ruturaj" 
   manager="mkjain" 
   editor=""/>

<tags
   ms.service="site-recovery"
   ms.devlang="na"
   ms.tgt_pltfrm="na"
   ms.topic="article"
   ms.workload="required" 
   ms.date="05/10/2016"
   ms.author="ruturajd"/>

# Восстановление размещения виртуальных машин VMware и физических серверов на локальном сайте

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-failback-azure-to-vmware.md)
- [Классический портал Azure](site-recovery-failback-azure-to-vmware-classic.md)
- [Классический портал Azure (прежняя версия)](site-recovery-failback-azure-to-vmware-classic-legacy.md)


В этой статье описывается, как восстановить размещение виртуальных машин Azure на локальном сайте с переносом из Azure. Когда вы будете готовы к восстановлению размещения виртуальных машин VMware или физических серверов Windows и Linux, для которых была выполнена отработка отказа из локального сайта в Azure, следуйте инструкциям, изложенным в этом [руководстве](site-recovery-vmware-to-azure-classic.md).



## Обзор

На этой схеме показана архитектура восстановления размещения для этого сценария.

Используйте эту архитектуру, когда сервер обработки является локальным и вы используете ExpressRoute.

![Схема архитектуры для Expressroute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

Используйте эту архитектуру, когда сервер обработки находится в Azure и у вас VPN-подключение или подключение ExpressRoute.

![Схема архитектуры для VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.PNG)

Чтобы просмотреть полный список портов и схему архитектуры восстановления, обратитесь к рисунку ниже.

![Отработка отказа и восстановление размещения во всех портах](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

Ниже приведены этапы восстановления размещения.

- Восстановление размещения на локальном сайте после отработки отказа с переносом в Azure происходит в несколько этапов:
	- **Этап 1**. Повторно включите защиту виртуальных машин Azure, чтобы они начали реплицироваться обратно в виртуальные машины VMware, запущенные на локальном сайте. 
	- **Этап 2**. После репликации виртуальных машин Azure на локальный сайт выполните отработку отказа, чтобы восстановить размещение из Azure.
	- **Этап 3**. После восстановления размещения данных повторно включите защиту локальных виртуальных машин, на которые выполнено восстановление размещения, чтобы они начали реплицироваться в Azure.


### Восстановление размещения в исходном или дополнительном расположении

При отработке отказа виртуальной машины VMware восстановление размещения можно выполнить на той же исходной виртуальной машине, если она по-прежнему доступна локально. В этом случае будет выполнено восстановление размещения только измененных данных. Обратите внимание на следующее:

- При отработке отказа физических серверов восстановление размещения всегда выполняется на новой виртуальной машине VMware.
	- Перед восстановлением размещения на физический компьютер обратите внимание, что
	- защищаемый физический компьютер будет восстановлен как виртуальная машина при восстановлении размещения из Azure в VMware.
	- Убедитесь, что у вас есть хотя бы один главный целевой сервер вместе с необходимыми узлами ESX/ESXi, на которых необходимо восстановить размещение после сбоя.
- Восстановление размещения на исходной виртуальной машине сопровождается следующими требованиями:
	- Если виртуальной машиной управляет сервер vCenter, то узел ESX главного целевого сервера должен иметь доступ к хранилищу данных виртуальных машин.
	- Если виртуальная машина находится на узле ESX, но не управляется с помощью vCenter, жесткий диск виртуальной машины должен находиться в хранилище данных, доступном узлу главного целевого сервера.
	- Если виртуальная машина находится на узле ESX и не использует vCenter, прежде чем повторно включить защиту, следует выполнить обнаружение узла ESX главного целевого сервера. Это применимо, если выполняется восстановление размещения и для физических серверов.
	- Второй вариант — при наличии локальной виртуальной машины удалите ее, прежде чем выполнить восстановление размещения. После восстановления размещения на том же узле, где находится главный целевой узел ESX, создается новая виртуальная машина.
	
- Если восстановление размещения выполняется в альтернативном расположении, данные будут восстановлены в то же хранилище данных и тот же узел ESX, которые использует локальный главный целевой сервер.


## Предварительные требования

- Для восстановления размещения виртуальных машин VMware и физических серверов вам понадобится среда VMware. Восстановление размещения на физическом сервере не поддерживается.
- Для восстановления размещения при первоначальной настройке защиты необходимо создать сеть Azure. Восстановление размещения требует подключения VPN или ExpressRoute к локальному сайту через сеть Azure, в которой расположены виртуальные машины Azure.
- Если виртуальные машины, для которых необходимо выполнить восстановление размещения, управляются с помощью сервера vCenter, необходимо убедиться в наличии требуемых разрешений для обнаружения виртуальных машин на серверах vCenter. [Подробная информация](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).
- Если на виртуальной машине есть моментальные снимки, произойдет сбой повторного включения защиты. Моментальные снимки или диски можно удалить. 
- Прежде чем выполнить восстановление размещения, необходимо создать несколько компонентов.
	- **Создайте сервер обработки в Azure**. Это виртуальная машина Azure, которую необходимо будет создать и которая должна быть запущена во время восстановления размещения. После завершения восстановления размещения ее можно удалить.
	- **Создайте главный целевой сервер**. Этот сервер отправляет и получает данные восстановления размещения. На сервере управления, созданном локально, главный целевой сервер установлен по умолчанию. Но в зависимости от объема трафика восстановления размещения для него может потребоваться создать отдельный главный целевой сервер.
	- Если необходимо создать дополнительный главный целевой сервер под управлением Linux, прежде чем установить главный целевой сервер, потребуется настроить виртуальную машину Linux, как описано ниже.
- При восстановлении размещения сервер конфигурации должен быть в локальной среде. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации, в противном случае восстановление не будет успешным. Таким образом, необходимо обеспечить регулярное плановое резервное копирование сервера. В случае сбоя потребуется восстановить сервер с тем же IP-адресом, чтобы обеспечить работу восстановления размещения.

## Политика восстановления размещения
Для репликации данных обратно в локальные ресурсы требуется политика восстановления размещения. Она создается автоматически, когда вы создаете политику направления переадресации. Обратите внимание на следующее:

1. Эта политика автоматически связывается с сервером конфигурации во время ее создания.
2. Эта политика не подлежит редактированию.
3. Для этой политики используются следующие установки значений: (пороговое значение RPO = 15 мин., хранение точки восстановления = 24 часа, периодичность моментальных снимков согласования App = 60 мин). ![](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## Установка сервера обработки в Azure

Чтобы виртуальные машины Azure могли отправлять данные на локальный главный целевой сервер, в Azure необходимо установить сервер обработки.

Если вы защитили свои компьютеры как классические ресурсы (т. е. виртуальная машина, восстановленная в Azure, является классической виртуальной машиной), вам потребуется классический сервер обработки в Azure. Если вы восстановили компьютеры, используя тип развертывания "диспетчер ресурсов", вам потребуется сервер обработки типа "развертывание диспетчера ресурсов". Выбор типа зависит от того, в какой виртуальной сети Azure развернут сервер обработки.

1.  Последовательно выберите пункты "Хранилище" > "Управление инфраструктурой Site Recovery" > **Серверы конфигурации** под заголовком "Для VMware и физических компьютеров", а затем выберите сервер конфигурации. Щелкните значок "+Сервер обработки".

	![](./media/site-recovery-failback-azure-to-vmware-new/add-processserver.PNG)

2. Выберите для развертывания сервера обработки параметр "Развернуть сервер обработки для восстановления размещения в Azure".

3. Выберите подписку, в которой вы восстановили компьютеры.

4. Затем выберите сеть Azure, в которой вы восстановили компьютеры. Сервер обработки должен находиться в той же сети, чтобы восстановленные виртуальные машины и сервер обработки могли обмениваться данными.

5. Если вы выбрали сеть *классического развертывания*, вам будет предложено создать виртуальную машину на основе коллекции Azure и установить на нее сервер обработки.

	![](./media/site-recovery-failback-azure-to-vmware-new/add-classic.PNG)
	
	1. Имя образа — *Microsoft Azure Site Recovery Process Server V2*. Необходимо выбрать *классическую* модель развертывания.
	
		![](./media/site-recovery-failback-azure-to-vmware-new/templateName.PNG)
	
	2. Установить сервер обработки, как указано [здесь](./site-recovery-vmware-to-azure-classicz.md#step-5-install-the-management-server).
	
6. Если вы выбрали сеть *диспетчера ресурсов* Azure, для развертывания сервера потребуются следующие входные данные:

    1. группа ресурсов для развертывания;
	
	2. имя сервера;
	
	3. имя пользователя и пароль для входа;
	
	4. учетная запись хранения, для которой нужно развернуть сервер;
	
	5. конкретная сеть и сетевая карта для подключения к этой сети. Примечание. Вам потребуется создать свою собственную [сетевую карту](../virtual-network/virtual-networks-multiple-nics.md) и выбрать ее в процессе развертывания.
	
		![](./media/site-recovery-failback-azure-to-vmware-new/PSinputsadd.PNG)
	
	6. Нажмите кнопку ОК. Она запустит задание, которое создаст виртуальную машину с типом развертывания "диспетчер ресурсов" и установкой сервера обработки. Необходимо запустить программу установки на виртуальной машине, чтобы зарегистрировать сервер для сервера конфигурации. Для этого выполните [эти действия](./site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).

	7. После этого будет активировано задание развертывания сервера обработки.

7. В конечном итоге сервер обработки должен появиться на странице серверов конфигурации в разделе соответствующих серверов на вкладке "Серверы обработки". ![](./media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

		
	>[AZURE.NOTE] Сервер не будет отображаться в разделе **Свойства виртуальной машины**. Он отображается только на вкладке **Серверы** на сервере управления, на котором он зарегистрирован. Сервер обработки отобразится примерно через 10–15 минут.


## Локальная установка главного целевого сервера

Главный целевой сервер принимает данные восстановления размещения. Он автоматически устанавливается на локальном сервере управления, но при восстановлении размещения большого объема данных может потребоваться настроить дополнительный главный целевой сервер. Это можно сделать указанным ниже образом.

>[AZURE.NOTE] Если необходимо установить главный целевой сервер под управлением Linux, следуйте инструкциям ниже.

1. Если вы устанавливаете главный целевой сервер под управлением Windows, откройте страницу быстрого запуска на виртуальной машине, на которую выполняется установка главного целевого сервера, и скачайте файл установки для мастера единой установки Azure Site Recovery.
2. Запустите программу установки и в окне **Перед началом работы** выберите **Добавить дополнительные серверы обработки для развертывания масштаба**.
3. Завершите работу мастера так же, как и при [настройке сервера управления](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server). На странице **Сведения о сервере конфигурации** укажите IP-адрес этого главного целевого сервера и парольную фразу для доступа к виртуальной машине.

### Настройка виртуальной машины Linux в качестве главного целевого сервера
Чтобы настроить сервер управления, на котором работает главный целевой сервер в качестве виртуальной машины Linux, необходимо установить операционную систему CentOS 6.6 с минимальным набором возможностей, получить идентификаторы SCSI для каждого жесткого диска SCSI, установить дополнительные пакеты и применить пользовательские изменения.

#### Установка CentOS 6.6

1.	Установите операционную систему CentOS 6.6 с минимальным набором возможностей на виртуальной машине сервера управления. Оставьте DVD-диск с ISO-образом в дисководе и перезапустите систему. Пропустите тестирование носителя, выберите английский язык (США), щелкните **Основные устройства хранилища**, убедитесь, что на жестком диске не содержатся важные данные, нажмите кнопку **Да** и удалите все данные. Введите имя узла сервера управления и выберите сетевой адаптер сервера. В диалоговом окне **Изменение системы** выберите **Подключаться автоматически** и добавьте статический IP-адрес, параметры сети и DNS. Укажите часовой пояс и корневой пароль для доступа к серверу управления. 
2.	При выборе типа разбиения на разделы следует выбрать **Пользовательское разбиение**. Нажав кнопку **Далее**, выберите **Свободно** и щелкните "Создать". Создайте секции **/**, **/var/crash** и **/home partitions**, а в поле **Тип файловой системы** укажите **ext4**. Создайте секцию подкачки с типом файловой системы **swap**.
3.	При наличии существующих устройств появится предупреждающее сообщение. Щелкните **Форматировать**, чтобы отформатировать диск с заданными параметрами секции. Щелкните **Записать изменения на диск**, чтобы применить изменения к секции.
4.	Последовательно выберите **Установить загрузчик** > **Далее**, чтобы установить загрузчик в корневую секцию.
5.	По завершении установки нажмите кнопку **Перезагрузить**.


#### Получение идентификаторов SCSI

1. После установки получите идентификаторы SCSI для каждого жесткого диска SCSI на виртуальной машине. Для этого завершите работу виртуальной машины сервера управления, а в свойствах виртуальной машины VMware щелкните виртуальную машину правой кнопкой мыши и выберите пункты **Изменить настройки** > **Параметры**.
2. Выберите **Дополнительно** > **Общий элемент** и щелкните **Параметры конфигурации**. При запуске компьютера этот параметр будет неактивен. Чтобы сделать его активным, необходимо завершить работу компьютера.
3. При наличии строки **disk.EnableUUID** убедитесь, что для нее задано значение **True** (с учетом регистра). Если это уже сделано, нажмите кнопку "Отмена" и после загрузки операционной системы на виртуальной машине проверьте в ней команду SCSI. 
4.	Если строки нет, щелкните **Добавить строку** и добавьте ее со значением **True**. Не используйте двойные кавычки.

#### Установка дополнительных пакетов

Необходимо скачать и установить дополнительные пакеты.

1.	Убедитесь, что главный целевой сервер подключен к Интернету.
2.	Выполните следующую команду, чтобы скачать и установить 15 пакетов из репозитория CentOS: **# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools**.
3.	Если в защищаемых исходных компьютерах под управлением Linux для корневого устройства или устройства загрузки используется файловая система Reiser или XFS, следует скачать и установить следующие дополнительные пакеты:

	- # cd /usr/local;
	- # wget [http://elrepo.org/linux/elrepo/el6/x86\_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)
	- # wget [http://elrepo.org/linux/elrepo/el6/x86\_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)
	- # rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm;
	- # wget [http://mirror.centos.org/centos/6.6/os/x86\_64/Packages/xfsprogs-3.1.1-16.el6.x86\_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)
	- # rpm –ivh xfsprogs-3.1.1-16.el6.x86\_64.rpm.

#### Применение пользовательских изменений

Выполнив послеустановочные действия и установив пакеты, для применения изменений сделайте следующее:

1.	Скопируйте двоичный файл единого агента RHEL 6-64 в виртуальную машину. Выполните следующую команду, чтобы распаковать двоичный файл: **tar –zxvf<file name>**.
2.	Выполните следующую команду, чтобы предоставить разрешения: **# chmod 755 ./ApplyCustomChanges.sh**
3.	Запустите сценарий **#./ApplyCustomChanges.sh**. Сценарий нужно выполнить только один раз. После успешного выполнения сценария перезапустите сервер.


## Выполнение восстановления размещения

### Повторное включение защиты виртуальных машин Azure

1.	Откройте "Хранилище" > "Реплицированные элементы", выберите виртуальную машину, на которой проводилась отработка отказа, щелкните ее правой кнопкой мыши и выберите пункт **Повторить защиту**. Это также можно сделать, щелкнув машину и выбрав повторную защиту с помощью кнопок управления.
2.	В колонке будет уже выбрано направление защиты "Azure в локальную среду".
3.  В разделах **Главный целевой сервер** и **Сервер обработки** выберите локальный главный целевой сервер и сервер обработки виртуальной машины Azure.
4.  Выберите **хранилище данных**, для которого нужно восстановить диски локальной среды. Этот параметр используется при удалении локальной виртуальной машины и появлении необходимости в создании дисков. Этот параметр учитывается, если диски уже существуют, но значение необходимо указать. 
5.	Диск хранения используется для остановки точек при репликации виртуальной машины в локальную среду. Ниже перечислены некоторые критерии диска хранения, без которых он не будет указываться для главного целевого сервера. а. Том не должен использоваться ни для какой иной цели (как конечный пункт репликации и т. д.). б. Том не должен быть заблокирован. в. Том не должен быть томом кэша. (В томе не должна присутствовать установка главного целевого сервера. Том выборочной установки сервера обработки и главного целевого сервера не может использоваться как том хранения. В данном случае в качестве тома для установки сервера обработки и главного целевого сервера используется тома кэша главного целевого сервера). г. Том не должен иметь тип файловой системы FAT или FAT32. д. Емкость тома не должна быть нулевой. е. Том хранения по умолчанию для Windows — это том R. ж. Том хранения по умолчанию для Linux — /mnt/retention.

6.  Политика восстановления размещения будет выбираться автоматически.

7.	После нажатия кнопки **ОК** для повторного включения защиты задание начинает репликацию виртуальной машины из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания**.

Если необходимо выполнить восстановление в альтернативном расположении, выберите диск для хранения и хранилище данных, настроенные для главного целевого сервера. При восстановлении расположения на локальном сайте виртуальные машины VMware в плане защиты восстановления размещения будут использовать то же хранилище данных, что и главный целевой сервер. Если необходимо восстановить виртуальную машину Azure реплики на той же локальной виртуальной машине, она уже должна находиться в том же хранилище данных, что и главный целевой сервер. Если нет локальных виртуальных машин, во время повторного включения защиты создается новая локальная виртуальная машина. ![](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)



Защиту можно также включить повторно на уровне плана восстановления. Если у вас есть группа репликации, ее защиту можно восстановить только с помощью плана восстановления. При этом для каждой защищаемой машины необходимо будет указать перечисленные выше значения.

>[AZURE.NOTE] Защита группы репликации должна быть восстановлена с использованием того же главного целевого сервера. При выборе другого главного целевого сервера для него нельзя будет выбрать другую общую временную точку.

### Запуск отработки отказа на локальном сайте

После восстановления защиты виртуальной машины вы можете запустить отработку отказа из Azure в локальную среду.

1.	На странице реплицированных элементов выберите виртуальную машину, контекстное меню которой содержит пункт **Внеплановая отработка отказа**.
2.	На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (из Azure) и выберите точку восстановления, до которой будет выполняться отработка отказа (последняя или связанная с последним запущенным приложением). Точка восстановления для приложения будет соответствовать более позднему времени и вызовет потерю данных.
3.	Во время отработки отказа Site Recovery завершит работу виртуальных машин Azure. Если восстановление размещения выполнено правильно, вы можете убедиться, что работа виртуальных машин Azure завершена должным образом.

### Повторное включение защиты локального сайта

Когда восстановление размещения будет завершено, вам нужно будет восстановить виртуальную машину, чтобы обеспечить фиксацию виртуальных машин, восстановленных в Azure.

1. Щелкните защищенный элемент правой кнопкой мыши и нажмите кнопку фиксации. Будет запущено задание, которое удалит из Azure восстановленные ранее виртуальные машины.

После завершения фиксации данные будут перемещены обратно на локальный сайт, но не будут защищены. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее:

1.	В разделе "Хранилище" > "Настройка" > "Реплицированные элементы" выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**. 
2.  Укажите сервер обработки, который необходимо использовать для отправки данных обратно в Azure.
3.	Нажмите кнопку "ОК", чтобы запустить восстановление защиты.

Когда защита будет восстановлена, виртуальная машина реплицируется обратно в Azure и вы сможете выполнить отработку отказа.


### Распространенные проблемы при восстановлении размещения

1. Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция завершится успешно и отработка отказа сработает. Во время повторной защиты отработка отказа завершится неудачно, так как не удается обнаружить хранилища данных. Признаком этой ситуации является отсутствие списка хранилищ данных при повторной защите. Для решения этой проблемы можно обновить учетные данные vCenter, указав учетную запись с соответствующими разрешениями, и повторить задание. [Дополнительные сведения](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access)
2. При восстановлении размещения виртуальной машины Linux и ее последующем локальном запуске вы увидите, что с этой виртуальной машины удален пакет диспетчера сети. Это вызвано тем, что при восстановлении виртуальной машины в Azure пакет диспетчера сети удаляется.
3. Если виртуальная машина настроена со статическим IP-адресом и для нее выполняется отработка отказа в Azure, IP-адрес предоставляется через DHCP. При восстановлении размещения в локальное размещение виртуальная машина также будет получать IP-адрес с помощью DHCP. При необходимости придется вручную зайти в виртуальную машину и настроить статический IP-адрес.
4. Если вы используете бесплатный выпуск ESXi версии 5.5 или низкоуровневой оболочки vSphere версии 6, отработка отказа будет выполнена успешно, но восстановление размещения после сбоя выполнено не будет. Для восстановления размещения необходимо обновиться до любой из версий с ознакомительной лицензией.

## Восстановление размещения с использованием ExpressRoute

Восстановление размещения можно выполнить через подключение VPN или Azure ExpressRoute. Если вы хотите использовать ExpressRoute, обратите внимание на следующее.

- ExpressRoute необходимо настроить в виртуальной сети Azure, где будет выполняться отработка отказа исходных машин и где будут размещены виртуальные машины Azure после отработки отказа.
- Данные реплицируются в учетную запись хранения Azure в общедоступной конечной точке. В ExpressRoute следует настроить общедоступный пиринг с целевым центром обработки данных, чтобы для репликации Site Recovery использовалось подключение ExpressRoute.

<!------HONumber=AcomDC_0518_2016-->