---
title: Настройка аварийного восстановления для локальных виртуальных машин Hyper-V (без VMM) в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Узнайте, как настроить аварийное восстановление локальных виртуальных машин Hyper-V (без VMM) в Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 04/08/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: da643a4d7a1dc74385b3854c1952af5ba93bd241
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59358099"
---
# <a name="set-up-disaster-recovery-of-on-premises-hyper-v-vms-to-azure"></a>Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure

c

> [!div class="checklist"]
> * Выбор источника и целевого объекта репликации.
> * Настройка среды исходной репликации, включая локальные компоненты Site Recovery и целевую среду репликации.
> * Создание политики репликации.
> * Включение репликации для виртуальных машин.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Подробные инструкции см. в разделе с инструкциями в материалах по Site Recovery.

## <a name="before-you-begin"></a>Перед началом работы
Это третье руководство в серии. В этом руководстве предполагается, что вы уже выполнили задачи в предыдущих руководствах:

1. [Подготовка Azure](tutorial-prepare-azure.md).
2. [Подготовка локальных серверов Hyper-V](tutorial-prepare-on-premises-hyper-v.md)



## <a name="select-a-replication-goal"></a>Выбор цели репликации

1. В колонке **Хранилища служб восстановления** выберите хранилище. Мы подготовили хранилище **ContosoVMVault** в предыдущем учебнике.
2. В разделе **Приступая к работе** щелкните **Site Recovery**. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Цель защиты** > **Где расположены компьютеры?**, а затем — **Локально**.
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Ваши компьютеры виртуализированы?** выберите **Yes, with Hyper-V** (Да, с помощью Hyper-V).
6. В поле **Are you using System Center VMM to manage your Hyper-V hosts** (Используете ли вы System Center VMM для управления узлами Hyper-V?) выберите **Нет**. Нажмите кнопку **ОК**.

    ![Цель репликации](./media/hyper-v-azure-tutorial/replication-goal.png)

## <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

1. Если вы планируете выполнить крупномасштабное развертывание, скачайте Планировщик развертывания для Hyper-V, перейдя по ссылке, указанной на странице **Планирование развертывания**. [Ознакомьтесь с дополнительными сведениями](hyper-v-deployment-planner-overview.md) о планировании развертывания Hyper-V.
2. В рамках этого учебника мы не будем использовать планировщик развертывания. В разделе **Вы выполнили планирование развертывания?** выберите **Выполню позже**. Нажмите кнопку **ОК**.

    ![Планирование развертывания](./media/hyper-v-azure-tutorial/deployment-planning.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Чтобы настроить исходную среду, создайте сайт Hyper-V и добавьте ему узлы Hyper-V, содержащие виртуальные машины, которые необходимо реплицировать на сайт. Затем загрузите и установите поставщика Azure Site Recovery и агента служб восстановления Azure для каждого узла, а затем в хранилище зарегистрируйте сайт Hyper-V. 

1. В разделе **Подготовка инфраструктуры** щелкните **Источник**.
2. В разделе **Подготовка источника** щелкните **+Hyper-V Site** (Добавить сайт Hyper-V).
3. В разделе **Создание сайта Hyper-V** укажите имя сайта. Мы используем **ContosoHyperVSite**.

    ![Узел Hyper-V](./media/hyper-v-azure-tutorial/hyperv-site.png)

3. После создания сайта выберите **Подготовка источника** > **Step 1: Select Hyper-V site** (Шаг 1. Выбор сайта Hyper-V), а затем выберите созданный сайт.
4. Щелкните **+Hyper-V Server** (+ Сервер Hyper-V).

    ![Сервер Hyper-V](./media/hyper-v-azure-tutorial/hyperv-server.png)

4. Скачайте программу установки поставщика Microsoft Azure Site Recovery.
6. Скачайте ключ регистрации хранилища. Он понадобится для установки поставщика. Ключ действителен в течение пяти дней после создания.

    ![Скачивание поставщика](./media/hyper-v-azure-tutorial/download.png)
    

### <a name="install-the-provider"></a>Установка поставщика

Установите скачанный файл установки (AzureSiteRecoveryProvider.exe) на каждом узле Hyper-V, добавленном на сайт Hyper-V. При этом на каждом компьютере Hyper-V будет установлен поставщик Azure Site Recovery и агент служб восстановления.

1. Запустите файл установки.
2. В мастере установки поставщика Azure Site Recovery в разделе **Центр обновления Майкрософт** согласитесь на использование Центра обновления Майкрософт для проверки наличия обновлений поставщика.
3. На странице **Установка** примите расположение установки по умолчанию для поставщика и нажмите кнопку **Установить**.
4. После установки в мастере регистрации Microsoft Azure Site Recovery в разделе **Параметры хранилища** щелкните **Обзор**, а в поле **Key File** (Файл ключа) выберите скачанный файл ключа хранилища. 
5. Укажите подписку Azure Site Recovery, имя хранилища (**ContosoVMVault**) и сайта Hyper-V (**ContosoHyperVSite**), к которому относится сервер Hyper-V.
6. В разделе **Proxy Settings** (Параметры прокси-сервера) выберите **Connect directly to Azure Site Recovery without a proxy** (Подключиться к Azure Site Recovery напрямую без прокси-сервера).
7. После регистрации сервера в хранилище в разделе **Registration** (Регистрация) нажмите кнопку **Готово**.

Azure Site Recovery извлечет метаданные с сервера Hyper-V, а сам сервер отобразится в колонке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Hyper-V Hosts** (Узлы Hyper-V). Этот процесс может занять до 30 минут.        

#### <a name="install-on-hyper-v-core-server"></a>Установка на основном сервере Hyper-V

Если вы используете основной сервер Hyper-V, скачайте файл установки и выполните следующие действия:

1. Извлеките файлы из AzureSiteRecoveryProvider.exe в локальный каталог, выполнив команду

    `AzureSiteRecoveryProvider.exe /x:. /q`
 
2.  Запустите `.\setupdr.exe /i. Результаты будут записаны в журнал %Programdata%\ASRLogs\DRASetupWizard.log.

3.  Зарегистрируйте сервер с помощью следующей команды:

    ```
    cd  C:\Program Files\Microsoft Azure Site Recovery Provider\DRConfigurator.exe" /r /Friendlyname "FriendlyName of the Server" /Credentials "path to where the credential file is saved"
    ```
 

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы. 

1. Выберите **Подготовка инфраструктуры** > **Цель**.
2. Выберите подписку и группу ресурсов **ContosoRG**, в которых будут создаваться виртуальные машины Azure после отработки отказа.
3. Выберите модель развертывания **Resource Manager**.

Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.


## <a name="set-up-a-replication-policy"></a>Настройка политики репликации

1. Щелкните **Prepare infrastructure** (Подготовка инфраструктуры) > **Параметры репликации** > **+Create and associate** (+Создание и связывание)
2. На странице **Создать и связать политику**укажите имя политики. Мы используем **ContosoReplicationPolicy**.
3. В рамках этого учебника мы оставим значения по умолчанию.
    - В поле **Периодичность копирования** указывается, как часто реплицируются разностные данные (после начальной репликации). По умолчанию каждые пять минут.
    - В поле **Хранение точки восстановления** указывается, что точки восстановления будут хранится на протяжении двух часов.
    - В поле **Периодичность создания моментальных снимков с согласованием приложений** указывается, что точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений, будут создаваться ежечасно.
    - В поле **Время запуска начальной репликации** указывается, что начальная репликация начнется немедленно.
4. После создания политики нажмите кнопку **OК**. При создании политика автоматически сопоставляется с указанным сайтом Hyper-V (в нашем учебнике — **ContosoHyperVSite**).

    ![Политика репликации](./media/hyper-v-azure-tutorial/replication-policy.png)


## <a name="enable-replication"></a>Включение репликации


1. В разделе **Репликация приложения** щелкните **Источник**. 
2. В разделе **Источник** выберите сайт **ContosoHyperVSite**. Нажмите кнопку **ОК**.
3. В разделе **Цель** убедитесь, что в качестве целевого объекта выбрано Azure, а также проверьте подписку хранилища и убедитесь, что выбрана модель развертывания **Resource Manager**.
4. Если вы используете параметры, указанные в этом руководстве, выберите учетную запись хранения **contosovmsacct1910171607**, созданную в предыдущем учебнике, для реплицируемых данных и сеть **ContosoASRnet**, в которой будут располагаться виртуальные машины Azure после отработки отказа.
5. Щелкните **Виртуальные машины** > **Выбрать** и выберите виртуальную машину, которую необходимо реплицировать. Нажмите кнопку **ОК**.

   Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После завершения задания **Завершение подготовки защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дополнительная информация
> [!div class="nextstepaction"]
> [Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)
