---
title: Настройка аварийного восстановления для локальных виртуальных машин Hyper-V (без VMM) в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Узнайте, как настроить аварийное восстановление локальных виртуальных машин Hyper-V (без VMM) в Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 12/28/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 6e0cff6725db52601b4639ad638216370dd3cfda
ms.sourcegitcommit: 9f87a992c77bf8e3927486f8d7d1ca46aa13e849
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/28/2018
ms.locfileid: "53810701"
---
# <a name="set-up-disaster-recovery-of-on-premises-hyper-v-vms-to-azure"></a>Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этом руководстве показано, как настроить аварийное восстановление локальных виртуальных машин Hyper-V в Azure. Оно предназначено для виртуальных машин Hyper-V, управление которыми осуществляется не в System Center Virtual Machine Manager (VMM). Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Выбор источника и целевого объекта репликации.
> * Настройка среды исходной репликации, включая локальные компоненты Site Recovery и целевую среду репликации.
> * Создание политики репликации.
> * Включение репликации для виртуальных машин.

Это третье руководство в серии. В этом руководстве предполагается, что вы уже выполнили задачи в предыдущих руководствах:

1. [Подготовка Azure](tutorial-prepare-azure.md).
2. [Подготовка локальных серверов Hyper-V](tutorial-prepare-on-premises-hyper-v.md)

Перед началом работы полезно [изучить архитектуру](concepts-hyper-v-to-azure-architecture.md) для этого сценария аварийного восстановления.

## <a name="select-a-replication-goal"></a>Выбор цели репликации


1. В разделе **All Services** (Все службы) > **Хранилища служб восстановления** выберите хранилище, подготовленное в предыдущем руководстве, **ContosoVMVault**.
2. В разделе **Приступая к работе** щелкните **Site Recovery**. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В поле **Are you using System Center VMM to manage your Hyper-V hosts** (Используете ли вы System Center VMM для управления узлами Hyper-V?) выберите **Нет**. Нажмите кнопку **ОК**.

    ![Цель репликации](./media/hyper-v-azure-tutorial/replication-goal.png)

## <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

При планировании крупномасштабного развертывания, необходимо убедиться в том, что было завершено [планирование развертывания для репликации Hyper-V](hyper-v-deployment-planner-overview.md). В рамках этого руководства в поле **Have you completed deployment planning?** (Вы спланировали развертывание?) из раскрывающегося списка выберите **I will do it later** (Выполню позже).

![Планирование развертывания](./media/hyper-v-azure-tutorial/deployment-planning.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Чтобы настроить исходную среду, создайте сайт Hyper-V и добавьте ему узлы Hyper-V. Затем загрузите и установите поставщика Azure Site Recovery и агента служб восстановления Azure для каждого узла, а затем в хранилище зарегистрируйте сайт Hyper-V. 

1. В разделе **Подготовка инфраструктуры** щелкните **Источник**.
2. Щелкните **+Hyper-V Site** (+ Сайт Hyper-V) и укажите имя сайта **ContosoHyperVSite**, созданного при работе с предыдущим руководством.

    ![Узел Hyper-V](./media/hyper-v-azure-tutorial/hyperv-site.png)

3. После создания сайта щелкните **Hyper-V Server**.

    ![Сервер Hyper-V](./media/hyper-v-azure-tutorial/hyperv-server.png)

4. Скачайте файл установки поставщика.
6. Скачайте ключ регистрации хранилища. Этот ключ понадобится при запуске программы установки поставщика. Ключ действителен в течение пяти дней после создания.

    ![Скачивание поставщика](./media/hyper-v-azure-tutorial/download.png)
    

### <a name="install-the-provider"></a>Установка поставщика

Запустите файл установки поставщика (AzureSiteRecoveryProvider.exe) на каждом узле Hyper-V, добавленном на сайт **ContosoHyperVSite**. При этом на каждом компьютере Hyper-V будет установлен поставщик Azure Site Recovery и агент служб восстановления.

1. В мастере "Установка поставщика Azure Site Recovery" в разделе **Центр обновления Майкрософт** согласитесь на использование Центра обновления Майкрософт для проверки наличия обновлений поставщика.
2. На странице **Установка** примите расположение установки по умолчанию для поставщика и нажмите кнопку **Установить**.
3. После установки в мастере регистрации Microsoft Azure Site Recovery в разделе **Параметры хранилища** щелкните **Обзор**, а в поле **Key File** (Файл ключа) выберите скачанный файл ключа хранилища. 
4. Укажите подписку Azure Site Recovery, имя хранилища (**ContosoVMVault**) и сайта Hyper-V (**ContosoHyperVSite**), к которому относится сервер Hyper-V.
5. В разделе **Proxy Settings** (Параметры прокси-сервера) выберите **Connect directly to Azure Site Recovery without a proxy** (Подключиться к Azure Site Recovery напрямую без прокси-сервера).
6. После регистрации сервера в хранилище в разделе **Registration** (Регистрация) нажмите кнопку **Готово**.

Azure Site Recovery извлечет метаданные с сервера Hyper-V, а сам сервер отобразится в колонке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Hyper-V Hosts** (Узлы Hyper-V). Этот процесс может занять до 30 минут.        

Если вы используете основной сервер Hyper-V, выполните следующие действия, когда скачаете учетные данные поставщика и хранилища, как упоминалось [здесь](#set-up-the-source-environment).

1. Извлеките файлы из AzureSiteRecoveryProvider.exe, выполнив следующую команду:

    ``AzureSiteRecoveryProvider.exe /x:. /q``
 
    Файлы будут извлечены в локальный каталог.
 
2.  Запустите ``.\setupdr.exe /i ``

    Результаты будут записаны в журнал %Programdata%\ASRLogs\DRASetupWizard.log.

3.  Зарегистрируйте сервер с помощью этой команды:

``cd  C:\Program Files\Microsoft Azure Site Recovery Provider\DRConfigurator.exe" /r /Friendlyname "FriendlyName of the Server" /Credentials "path to where the credential file is saved" ``
 

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы. 

1. Выберите **Подготовка инфраструктуры** > **Цель**.
2. Выберите подписку и группу ресурсов **ContosoRG**, в которых будут создаваться виртуальные машины Azure после отработки отказа.
3. Выберите модель развертывания **Resource Manager**.

Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.


## <a name="set-up-a-replication-policy"></a>Настройка политики репликации

> [!NOTE]
> В Hyper-V для политик репликации Azure 15-минутный параметр периодичности копирования заменяется 5-минутным и 30-секундным параметрами. Для политик репликаций, использующих 15-минутный параметр периодичности копирования, автоматически задается применение параметра 5-минутной периодичности копирования. 5-минутные и 30-секундные параметры периодичности копирования повышают производительность репликации и оптимизируют целевые точки восстановления (по сравнению с 15-минутным параметром) с минимальным влиянием на объем передаваемых данных и использование пропускной способности.

1. Щелкните **Prepare infrastructure** (Подготовка инфраструктуры) > **Параметры репликации** > **+Create and associate** (+Создание и связывание)
2. На странице **Создать и связать политику** укажите имя политики **ContosoReplicationPolicy**.
3. Оставьте параметры по умолчанию и нажмите кнопку **ОК**.
    - В поле **Периодичность копирования** указывается, что разностные данные (после начальной репликации) будут реплицироваться каждые пять минут.
    - В поле **Хранение точки восстановления** указывается продолжительность периода хранения для каждой точки восстановления — два часа.
    - В поле **Периодичность создания моментальных снимков с согласованием приложений** указывается, что точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений, будут создаваться ежечасно.
    - В поле **Время запуска начальной репликации** указывается, что начальная репликация начнется немедленно.
4. После создания политики нажмите кнопку **OК**. При создании политика автоматически сопоставляется с указанным сайтом Hyper-V (**ContosoHyperVSite**).

    ![Политика репликации](./media/hyper-v-azure-tutorial/replication-policy.png)


## <a name="enable-replication"></a>Включение репликации


1. В разделе **Репликация приложения** щелкните **Источник**. 
2. В разделе **Источник** выберите сайт **ContosoHyperVSite**. Нажмите кнопку **ОК**.
3. В разделе **Цель** убедитесь, что в качестве целевого объекта выбрано Azure, а также проверьте подписку хранилища и убедитесь, что выбрана модель развертывания **Resource Manager**.
4. Выберите учетную запись хранения **contosovmsacct1910171607**, созданную в предыдущем руководстве, для реплицируемых данных и сеть **ContosoASRnet**, в которой будут располагаться виртуальные машины Azure после отработки отказа.
5. Щелкните **Виртуальные машины** > **Выбрать** и выберите виртуальную машину, которую необходимо реплицировать. Нажмите кнопку **ОК**.

 Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После завершения задания **Завершение подготовки защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дополнительная информация
[Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)
