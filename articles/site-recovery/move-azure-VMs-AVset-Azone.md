---
title: Перенос виртуальных машин IaaS Azure в качестве виртуальных машин, прикрепленных к зонам, в другой регион Azure с помощью службы Azure Site Recovery | Документация Майкрософт
description: Используйте службу Azure Site Recovery для переноса виртуальных машин IaaS Azure в другой регион Azure в качестве виртуальных машин, прикрепленных к зонам.
services: site-recovery
author: rajani-janaki-ram
ms.service: site-recovery
ms.topic: tutorial
ms.date: 01/28/2019
ms.author: rajanaki
ms.custom: MVC
ms.openlocfilehash: 6a731750da4edfb4a71c00156c5ff527dee30941
ms.sourcegitcommit: 359b0b75470ca110d27d641433c197398ec1db38
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2019
ms.locfileid: "55824679"
---
# <a name="move-azure-vms-into-availability-zones"></a>Перенос виртуальных машин Azure в Зоны доступности
Функция Зоны доступности в Azure защищает приложения и данные от сбоев на уровне центра обработки данных. Каждая зона доступности состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Чтобы обеспечить отказоустойчивость, во всех включенных регионах используются минимум три отдельные зоны. Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных. Благодаря зонам доступности Azure предлагает наилучшее в отрасли соглашение об уровне обслуживания с гарантией времени непрерывной работы 99,99 % для виртуальных машин. Зоны доступности поддерживаются в выбранных регионах, как уже упоминалось [здесь](https://docs.microsoft.com/azure/availability-zones/az-overview#regions-that-support-availability-zones). 

Если вы развернули виртуальные машины в качестве "единственного экземпляра" в конкретном регионе и желаете повысить доступность, переместив их в зону доступности, можно сделать это с помощью Azure Site Recovery. Процесс можно разделить на подпроцессы:

- перенос одноэкземплярных виртуальных машин в зоны доступности в целевом регионе;
- перенос виртуальных машин в группе доступности в зоны доступности в целевом регионе.

> [!IMPORTANT]
> В настоящее время Azure Site Recovery поддерживает перемещение виртуальных машин из одного региона в другой и не поддерживает перемещение в пределах одного региона. 

## <a name="verify-prerequisites"></a>Проверка предварительных требований

- Убедитесь, что целевой регион [поддерживает зону доступности](https://docs.microsoft.com/azure/availability-zones/az-overview#regions-that-support-availability-zones). Проверьте, поддерживается ли выбранная вами [комбинация исходного и целевого региона](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-support-matrix#region-support), и примите взвешенное решение о целевом регионе.
- Вам должны быть понятны [архитектура и компоненты сценария](azure-to-azure-architecture.md).
- Просмотрите [ограничения и требования для поддержки](azure-to-azure-support-matrix.md).
- Проверьте разрешения учетной записи. Если вы создали бесплатную учетную запись Azure, тогда вы являетесь администратором подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Чтобы включить репликацию для виртуальной машины и в конечном итоге скопировать данные в целевой объект с помощью Azure Site Recovery, необходимо следующее:

    1. Разрешения на создание виртуальной машины в ресурсах Azure. Встроенная роль "Участник виртуальных машин" обладает такими разрешениями:
        - разрешение на создание виртуальной машины в выбранной группе ресурсов;
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в выбранной учетной записи хранения.

    2. Кроме того, требуется разрешение на управление операциями Azure Site Recovery. Роль "Участник Site Recovery" имеет все разрешения, необходимые для управления операциями Azure Site Recovery в хранилище служб восстановления.

## <a name="prepare-the-source-vms"></a>Подготовка исходных виртуальных машин

1. Виртуальные машины должны использовать управляемые диски, если вы хотите переместить их в зону доступности с помощью Site Recovery. Вы можете преобразовать имеющиеся виртуальные машины Windows, использующие неуправляемые диски, в использование управляемых дисков, выполнив следующие шаги, описанные [здесь](https://docs.microsoft.com/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks). Для этого убедитесь, что группа доступности настроена как "управляемая". 
2. Убедитесь, что на виртуальных машинах Azure, которые следует перенести, установлены все новейшие корневые сертификаты. Если такие сертификаты отсутствуют, копирование данных в целевой регион невозможно включить из-за ограничений по соображениям безопасности.

3. При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать присутствие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификатам в вашей организации.

4. На виртуальных машинах Linux выполните инструкции распространителя Linux, чтобы установить на виртуальные машины все свежие доверенные корневые сертификаты и список отзыва сертификатов.
5. Убедитесь, что для переносимых виртуальных машин не используется прокси-сервер аутентификации для управления подключением к сети.

6. Если виртуальная машина, которую вы пытаетесь переместить, не имеет доступа к Интернету и использует прокси-сервер брандмауэра для управления исходящим доступом, [проверьте соответствующие требования](azure-to-azure-tutorial-enable-replication.md#configure-outbound-network-connectivity).

7. Определите исходный сетевой макет и все ресурсы, которые вы используете в настоящее время для проверки, включая подсистемы балансировки нагрузки, NSG, общедоступные IP-адреса и т. д.

## <a name="prepare-the-target-region"></a>Подготовка целевого региона

1. Убедитесь, что подписка Azure позволяет создавать виртуальные машины в целевом регионе, используемом для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить требуемые квоты, если это необходимо.

2. Убедитесь, что подписка располагает достаточными ресурсами для поддержки виртуальных машин таких же размеров, которые установлены для исходных виртуальных машин. Если для копирования данных в целевой объект вы используете Site Recovery, эта служба выберет для целевой виртуальной машины такой же или другой наиболее подходящий размер.

3. Убедитесь, что вы создали целевой ресурс для каждого компонента, указанного в исходном сетевом макете. Это важно для того, чтобы после перехода в целевой регион ваши виртуальные машины имели все функции и возможности исходных виртуальных машин.

    > [!NOTE]
    > Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть и учетную запись хранения, когда вы включаете репликацию для исходной виртуальной машины. Вы также можете предварительно создать эти ресурсы и назначить их виртуальной машине на этапе включения репликации. Любые другие ресурсы, как это описано далее, необходимо создавать вручную в целевом регионе.

     Сведения о создании часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих документах.

    - [Группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group)
    - [Подсистемы балансировки нагрузки](https://docs.microsoft.com/azure/load-balancer/#step-by-step-tutorials
        
     - [Общедоступный IP-адрес](https://docs.microsoft.com/azure/load-balancer/#step-by-step-tutorials)
    
   Сведения о других сетевых компонентах см. в [документации по сетям](https://docs.microsoft.com/azure/#pivot=products&panel=network). 

> [!IMPORTANT]
> Убедитесь, что в целевом объекте используется подсистема балансировки нагрузки, избыточная в пределах зоны. С дополнительными сведениями вы можете ознакомиться [здесь](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-availability-zones).

4. Вручную [создайте непроизводственную сеть](https://docs.microsoft.com/azure/virtual-network/quick-create-portal) в целевом регионе, если вы хотите проверить конфигурацию перед выполнением окончательного перехода в целевой регион. При этом помехи в рабочей среде будут минимальными (рекомендуется выполнить этот шаг).


> [!NOTE]
> Приведенные ниже шаги предназначены для одной виртуальной машины. Вы можете расширить этот процесс на несколько виртуальных машин, перейдя в хранилище Служб восстановления и щелкнув "+ Реплицировать", а затем выбрав релевантные виртуальные машины вместе.

## <a name="enable-replication"></a>Включение репликации
Ниже приведены шаги по включению репликации данных в целевой регион перед их конечным переносом в Зоны доступности с помощью Azure Site Recovery.

1. На портале Azure щелкните **Виртуальные машины**, а затем выберите виртуальную машину, которую требуется перенести в зоны доступности.
2. В разделе **Операции** щелкните **Аварийное восстановление**.
3. В разделе **Настройка аварийного восстановления** > **Целевой регион** выберите целевой регион, в который будет выполняться репликация. Убедитесь, что этот регион [поддерживает](https://docs.microsoft.com/azure/availability-zones/az-overview#regions-that-support-availability-zones) зоны доступности.
![enable-rep-1.PNG](media/azure-vms-to-zones/enable-rep-1.PNG)

1. По завершении выберите **Next: Расширенные параметры**
2. Выберите соответствующие значения для целевой подписки, целевой группы ресурсов виртуальных машин и виртуальной сети.
3. В разделе **Доступность** выберите зону доступности, в которую требуется перенести виртуальную машину. 
> [!NOTE]
> Если вы не видите параметр для группы доступности или зоны доступности, выполните [предварительные требования](#prepare-the-source-vms) и [подготовьте](#prepare-the-source-vms) исходные виртуальные машины.

   ![enable-rep-2.PNG](media/azure-vms-to-zones/enable-rep-2.PNG)

7. Щелкните включенную репликацию. Будет запущено задание для включения репликации виртуальной машины.

## <a name="verify-settings"></a>Проверка параметров

После завершения задания репликации можно проверить состояние репликации, изменить параметры настройки репликации и протестировать развертывание.

1. В меню виртуальной машины щелкните **Аварийное восстановление**.
2. Можно проверить работоспособность репликации, созданные точки восстановления, а также исходный и целевой регионы на карте.

   ![Состояние репликации](media/azure-to-azure-quickstart/replication-status.png)

## <a name="test-the-configuration"></a>Тестирование конфигурации

1. В меню виртуальной машины выберите **Аварийное восстановление**.
2. Щелкните значок **Тестовая отработка отказа**.
3. На странице **Тестовая отработка отказа** выберите точку восстановления:

   - **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана службой Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
   - **Последняя с согласованием приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
   - **Настраиваемая**. Вы можете выбрать любую точку восстановления.

3. Чтобы проверить конфигурацию, выберите целевую тестовую виртуальную сеть Azure, в которую вы хотите переместить виртуальные машины Azure. 

> [!IMPORTANT]
> Для отработки отказа мы рекомендуем использовать отдельную сеть виртуальных машин Azure, а не рабочую сеть в целевом регионе, в который вы планируете перенести свои виртуальные машины.

4. Чтобы начать тестирование, щелкните **ОК**. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Также можно щелкнуть задание **Тестовая отработка отказа** в разделе "Имя хранилища" > **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина работает, имеет соответствующий размер и подключена к соответствующей сети.
6. Если вы хотите удалить виртуальную машину, созданную в ходе тестирования переноса, щелкните **Очистить тестовую отработку отказа** для реплицированного элемента. При необходимости в разделе **Примечания** можно записать и сохранить сведения о тестировании.

## <a name="perform-the-move-to-the-target-region-and-confirm"></a>Выполните и подтвердите перенос в целевой регион.

1.  В меню виртуальной машины выберите **Аварийное восстановление**.
2. Щелкните значок **Отработка отказа**.
3. В области **Отработка отказа**выберите **Последнее**. 
4. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается выключить исходную виртуальную машину перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа. 
5. Когда задание будет завершено, проверьте, отображается ли виртуальная машина в целевом регионе Azure, как и ожидалось.
6. В разделе **Реплицированные элементы** нажмите правой кнопкой мыши пункт "Виртуальная машина" и выберите **Зафиксировать**. Перенос в целевой регион будет завершен. Дождитесь завершения фиксации задания.

## <a name="discard-the-resource-in-the-source-region"></a>Отмена ресурса в исходном регионе 

1. Перейдите к виртуальной машине.  Щелкните **Отключить репликацию**.  Это остановит процесс копирования данных для виртуальной машины.  

> [!IMPORTANT]
> Важно выполнить этот шаг, чтобы не взималась плата за репликацию с помощью Site Recovery. Параметры репликации в источнике автоматически очищаются. Обратите внимание, что расширение Site Recovery, устанавливаемое в рамках репликации, автоматически не удаляется и требует удаления вручную. 

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы повысили доступность виртуальной машины Azure, перенеся ее в группу доступности или Зону доступности. Теперь можно настроить аварийное восстановление для перенесенной виртуальной машины.

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления после миграции](azure-to-azure-quickstart.md)


