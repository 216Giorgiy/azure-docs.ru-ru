---
title: Отработка отказа и обратное переключение виртуальных машин VMware и физических серверов во время аварийного восстановления в Azure с помощью Site Recovery | Документация Майкрософт
description: Сведения об отработке отказа виртуальных машин VMware и физических серверов в Azure и обратное переключение на локальную среду во время аварийного восстановления в Azure с помощью Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
services: site-recovery
ms.topic: tutorial
ms.date: 03/18/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 68f1c5156f4c12af33e6088d862fc12d98021fd4
ms.sourcegitcommit: 90dcc3d427af1264d6ac2b9bde6cdad364ceefcc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2019
ms.locfileid: "58310223"
---
# <a name="fail-over-and-fail-back-vmware-vms-and-physical-servers-replicated-to-azure"></a>Отработка отказа и восстановление размещения виртуальных машин VMware и физических серверов, реплицированных в Azure

В этом учебнике содержатся сведения об отработке отказа виртуальных машин VMware в Azure. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Проверка соответствия свойств виртуальной машины VMware требованиям Azure
> * Выполнение отработки отказа в Azure
> * Создание сервера обработки и главного целевого сервера для восстановления размещения
> * Повторное включение защиты виртуальных машин Azure на локальном сайте
> * Отработка отказа из Azure в локальную среду
> * Повторное включение защиты локальных виртуальных машин для запуска повторной репликации в Azure

>[!NOTE]
>В руководствах приводится самый простой способ развертывания для сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Узнать больше о тестовой отработке отказа можно из этого [руководства](site-recovery-failover.md).

Это пятый учебник в серии. В этом учебнике предполагается, что вы уже выполнили задачи в предыдущих учебниках.

1. [Подготовка Azure](tutorial-prepare-azure.md)
2. [Подготовка локальной среды VMware](vmware-azure-tutorial-prepare-on-premises.md)
3. [Настройка аварийного восстановления](vmware-azure-tutorial.md)
4. [Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)
5. Также будет полезно [изучить архитектуру](vmware-azure-architecture.md) для этого сценария аварийного восстановления.

## <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения

Отработка отказа и восстановление размещения выполняются в четыре этапа.

1. **Отработка отказа с переходом в Azure.** Отработка отказа виртуальных машин с переходом с локального сайта в Azure.
2. **Повторное включение защиты виртуальных машин Azure.** Повторно включите защиту виртуальных машин Azure, чтобы начать их репликацию в виртуальные машины VMware, запущенные на локальном сайте. Во время повторного включения защиты локальная виртуальная машина отключается. Это позволяет обеспечить согласованность данных во время репликации.
3. **Переход на другой ресурс в локальной среде**. Выполнение отработки отказа для восстановления размещения из Azure.
4. **Повторное включение защиты локальных виртуальных машин**: После восстановления данных повторно включите защиту виртуальных машин, запущенных на локальном сайте, на которые выполнено восстановление размещения, чтобы начать их репликацию в Azure.

## <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](vmware-physical-azure-support-matrix.md#replicated-machines).

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

2. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.

3. В области **Вычисления и сеть** можно изменить имя Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и параметры управляемого диска.

4. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.

5. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.

## <a name="run-a-failover-to-azure"></a>Выполнение отработки отказа в Azure

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.

2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
   - **Последняя**. В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
   - **Последняя обработанная**. Отработка отказа виртуальной машины выполняется до последней точки восстановления, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
   - **Последняя с согласованием приложений**. Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery.
   - **Настраиваемая**. Следует указать точку восстановления.

3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы попытаться выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. Тестовая отработка отказа для виртуальных машин VMware **может занимать больше времени** при использовании службы Mobility Service до версии 9.8, физических серверов, виртуальных машин Linux VMware, защищенных в качестве физических серверов виртуальных машин Hyper-V, виртуальных машин VMware без включенной службы DHCP и виртуальных машин VMware без загрузочных драйверов storvsc, vmbus, storflt, intelide, atapi.

> [!WARNING]
> **Не отменяйте отработку отказа в процессе выполнения.** Перед началом отработки отказа репликация виртуальной машины останавливается.
> Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.

## <a name="connect-to-failed-over-virtual-machine-in-azure"></a>Подключение к виртуальной машине, для которой выполнена отработка отказа, в Azure

1. Если после отработки отказа нужно подключиться к виртуальным машинам Azure по RDP или SSH, выполните требования, которые перечислены в [таблице](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover).
2. После отработки отказа перейдите к виртуальной машине и проверьте [подключение](../virtual-machines/windows/connect-logon.md) к ней.
3. Затем щелкните **Зафиксировать**, чтобы завершить подготовку точки восстановления виртуальной машины после отработки отказа. После этого все остальные доступные точки восстановления будут удалены. На этом отработка отказа будет завершена.

>[!TIP]
> Параметр **Изменить точку восстановления** позволяет при необходимости выбрать другую точку восстановления после отработки отказа виртуальной машины. После **фиксации** этот параметр будет недоступным.

Для устранения проблем с подключением после отработки отказа выполните шаги, описанные [здесь](site-recovery-failover-to-azure-troubleshoot.md).

## <a name="preparing-for-reprotection-of-azure-vm"></a>Подготовка к повторному включению защиты виртуальной машины Azure

- Можно использовать локальный сервер обработки (встроенный сервер обработки), который автоматически устанавливается на сервере конфигурации в процессе настройки **при наличии подключения к Azure ExpressRoute**.

> [!IMPORTANT]
> При наличии подключения через VPN между локальной средой и Azure необходимо настроить виртуальную машину Azure в качестве сервера обработки для восстановления защиты и размещения. Чтобы настроить сервер обработки в Azure, следуйте инструкциям в [этой статье](vmware-azure-set-up-process-server-azure.md).

Дополнительные сведения о восстановлении защиты и размещения см. в [этом разделе](vmware-azure-reprotect.md##before-you-begin). 

### <a name="configure-the-master-target-server"></a>Настройка главного целевого сервера

Главный целевой сервер, который получает и обрабатывает данные репликации при восстановлении размещения с переносом из Azure. По умолчанию он доступен на локальном сервере конфигурации. Для работы с этим руководством используется главный целевой сервер по умолчанию.

>[!NOTE]
>Для включения защиты виртуальной машины на основе Linux необходимо создать отдельный главный целевой сервер. [Щелкните здесь](vmware-azure-install-linux-master-target.md), чтобы получить дополнительные сведения.

Если виртуальная машина находится на **узле ESXi под управлением сервера vCenter**, главный целевой сервер должен иметь доступ к хранилищу данных виртуальной машины (VMDK), чтобы записывать реплицированные данные на диски виртуальной машины. Убедитесь, что хранилище данных виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись.

Если виртуальная машина находится на **узле ESXi, который не управляется сервером vCenter**, служба Site Recovery создаст виртуальную машину во время повторного включения защиты. Виртуальная машина создается на узле ESX, на котором создан главный целевой сервер.
Жесткий диск виртуальной машины должен находиться в хранилище данных, доступном для узла, на котором работает главный целевой сервер.

Если виртуальная машина **не использует vCenter**, перед повторным включением защиты машины следует выполнить обнаружение узла, на котором работает главный целевой сервер. Это применимо, если выполняется восстановление размещения и для физических серверов. Второй вариант: при наличии локальной виртуальной машины удалите ее, прежде чем выполнить восстановление размещения. Затем служба восстановления размещения создаст новую виртуальную машину на том же узле, где находится главный целевой узел ESX. Если восстановление размещения выполняется в альтернативном расположении, данные будут восстановлены в то же хранилище данных и тот же узел ESX, которые использует локальный главный целевой сервер.

Вы не можете использовать технологию Storage vMotion на главном целевом сервере. В противном случае восстановление размещения не будет работать, поскольку отсутствуют доступные диски. Исключите главные целевые серверы из списка vMotion.

>[!Warning]
>При выборе другого главного целевого сервера он не сможет предоставить общую точку во времени.

## <a name="reprotect-azure-vms"></a>Повторное включение защиты виртуальных машин Azure

Включение повторной защиты виртуальной машины Azure приводит к репликации данных на локальную виртуальную машину. Это обязательный шаг перед выполнением отработки отказа из Azure на локальную виртуальную машину. Чтобы включить повторную защиту, сделайте следующее:

1. В разделе **Параметры** > **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину, для которой выполнена отработка отказа, и выберите **Защитить повторно**.
2. В окне **Повторная защита** выберите **Из Azure в локальную среду**.
3. Укажите локальный главный целевой сервер и сервер обработки.
4. В поле **Хранилище данных** выберите главное целевое хранилище данных, для которого нужно восстановить диски локальной среды. Если виртуальная машина удалена, новые диски будут созданы в этом хранилище данных. Хотя этот параметр не учитывается, если диски уже существуют, его значение необходимо указать.
5. Выберите главный целевой диск для хранения. Политика восстановления размещения выбирается автоматически.
6. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начнет реплицировать виртуальную машину из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания** .
7. Когда состояние виртуальной машины в разделе **Реплицированные элементы** изменится на **Защищено**, такая виртуальная машина будет готова к отработке отказа на локальный компьютер.

> [!NOTE]
> Виртуальную машину Azure можно восстановить в существующую локальную виртуальную машину или другое расположение. Дополнительные сведения см. в [этой статье](concepts-types-of-failback.md).

## <a name="run-a-failover-from-azure-to-on-premises"></a>Выполнение отработки отказа из Azure в локальную среду

Для репликации данных обратно в локальную среду используется политика восстановления размещения. Эта политика автоматически создается при создании политики репликации для репликации в Azure.

- Политика автоматически сопоставляется с сервером конфигурации.
- Политику невозможно изменить.
- Политика имеет следующие значения:
    - Пороговое значение RPO: 15 минут.
    - Хранение точки восстановления: 24 часа.
    - Периодичность создания моментальных снимков с согласованием приложений: 60 минут.

Выполните отработку отказа следующим образом:

1. На странице **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину и выберите **Отработка отказа**.
2. На странице **Подтверждение отработки отказа** должно быть указано направление отработки отказа "Из Azure".
    ![Направление отработки отказа](media/vmware-azure-tutorial-failover-failback/failover-direction.PNG)
3. Выберите точку восстановления, которую вы хотите использовать для отработки отказа. Точка восстановления с согласованием приложений предшествует самой последней точке во времени, что приведет к потере некоторых данных.

    >[!WARNING]
    >При отработке отказа служба Site Recovery отключает виртуальные машины Azure и загружает локальную виртуальную машину. Чтобы исключить время простоя, выберите подходящий момент.

4. Ход выполнения задания можно отслеживать в разделе **Хранилище служб восстановления** > **Мониторинг и отчеты** > **Задания Site Recovery**.
5. После завершения отработки отказа щелкните правой кнопкой мыши виртуальную машину и нажмите кнопку **Зафиксировать**. Будет запущено задание по удалению виртуальных машин Azure.
6. Убедитесь, что работа виртуальной машины Azure была завершена должным образом.

## <a name="reprotect-on-premises-machines-to-azure"></a>Повторное включение защиты локальных машин в Azure

Теперь данные будут снова находиться на локальном сайте, но они не реплицируются в Azure. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее.

1. В хранилище в разделе **Защищенные элементы** >**Реплицированные элементы** выберите виртуальную машину, для которой выполнено восстановление размещения, и щелкните **Защитить повторно**.
2. Выберите сервер обработки, который будет использоваться для отправки реплицированных данных в Azure, и нажмите кнопку **ОК**.

После завершения повторного включения защиты виртуальная машина будет снова реплицироваться в Azure, и вы сможете выполнять отработку отказа.
