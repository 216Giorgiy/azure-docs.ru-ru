---
title: "Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в Azure, с помощью Site Recovery | Документация Майкрософт"
description: "Сведения об отработке отказа виртуальных машин Hyper-V в Azure и восстановлении размещения на локальном сайте с помощью Azure Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 72065d01-ed0f-430e-b117-a5885cecd1db
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/15/2017
ms.author: raynew
ms.translationtype: HT
ms.sourcegitcommit: c3a2462b4ce4e1410a670624bcbcec26fd51b811
ms.openlocfilehash: e1cc21661450a983c25b24fe2a6228e26ceecec6
ms.contentlocale: ru-ru
ms.lasthandoff: 09/25/2017

---

# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-azure"></a>Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в Azure

Служба [Azure Site Recovery](site-recovery-overview.md) управляет репликацией, отработкой отказа и восстановлением размещения локальных компьютеров и виртуальных машин Azure.

В этом руководстве содержатся сведения об отработке отказа виртуальных машин Hyper-V в Azure. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Отработка отказа виртуальных машин Hyper-V из локальной среды в Azure.
> * Восстановление размещения из Azure в локальную среду и повторная репликация в Azure.

## <a name="overview"></a>Обзор
Отработка отказа и восстановление размещения происходит в два этапа:

1. **Отработка отказа с переходом в Azure.** Отработка отказа с переносом компьютеров с локального сайта в Azure.
2. **Восстановление размещения из Azure в локальную среду.** Запуск плановой отработки отказа с переносом из Azure в локальную среду. После плановой отработки отказа включите обратную репликацию, чтобы снова начать репликацию из локальной среды в Azure. 


## <a name="fail-over-to-azure"></a>Отработка отказа с переходом в Azure

### <a name="failover-prerequisites"></a>Необходимые условия для отработки отказа

Чтобы выполнить отработку отказа, сделайте следующее:

- Убедитесь, что [отработка аварийного восстановления](tutorial-dr-drill-azure.md) выполнена, чтобы быть уверенным в надлежащей работе всех компонентов.
- При необходимости подготовьтесь к подключению к виртуальной машине Azure, прежде чем выполнить отработку отказа.
- Перед запуском отработки отказа проверьте свойства виртуальной машины.

#### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, сделайте следующее:

##### <a name="azure-vms-running-windows"></a>Виртуальные машины Azure под управлением Windows

1. Чтобы получить доступ к виртуальным машинам Azure через Интернет, включите RDP на локальных виртуальных машинах перед отработкой отказа. Убедитесь в том, что правила TCP и UDP добавлены для **общедоступного** профиля, а RDP разрешен в разделе **Брандмауэр Windows** > **Allowed Apps** (Разрешенные приложения) для всех профилей.
2. Для доступа через VPN типа "сеть — сеть" включите RDP на локальном компьютере. Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**. Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Подробнее](https://support.microsoft.com/kb/3031135). Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления. 
3. После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).


##### <a name="azure-vms-running-linux"></a>Виртуальные машины Azure под управлением Linux

1. На локальном компьютере перед отработкой отказа убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы. Убедитесь, что правила брандмауэра разрешают SSH-подключение.
2. Правила группы безопасности сети на виртуальной машине Azure, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.  [Добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md#adding-a-public-ip-on-a-resource-manager-virtual-machine) для виртуальной машины. Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.


#### <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.
2. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.
3. В области **Вычисления и сеть** можно изменить имя Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и [параметры управляемого диска](#managed-disk-considerations).
4. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.
5. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.


### <a name="run-a-failover-from-on-premises-to-azure"></a>Выполнение отработки отказа из локальной среды в Azure

Для виртуальных машин Hyper-V можно выполнить обычную или плановую отработку отказа.

- Обычная отработка отказа используется при непредвиденных сбоях. При запуске такой отработки отказа Site Recovery создает виртуальную машину Azure и включает ее. Выполняется отработка отказа определенной точки восстановления. В зависимости от используемой точки восстановления может произойти потеря данных.
- Плановую отработку отказа можно использовать при обслуживании и во время тестового сбоя. Этот вариант обеспечивает сохранение всех данных. После запуска плановой отработки отказа исходные виртуальные машины завершают работу. Несинхронизированные данные синхронизируются, и запускается отработка отказа.

Далее описано, как выполнять обычную отработку отказа.


1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    - **Последние** (по умолчанию). В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
    - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
    - **Latest app-consistent** (Последняя точка во времени согласованности приложений). Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery. 
    - **Настраиваемая.** Следует указать точку восстановления.
3. Если при отработке отказа виртуальных машин Hyper-V в облаках System Center VMM с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
4. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Site Recovery также предпримет попытку синхронизировать локальные данные, которые еще не были отправлены в Azure, перед запуском отработки отказа. Обратите внимание, что отработка отказа продолжится, даже если при отключении произойдет сбой. На странице **Задания** можно следить за ходом выполнения отработки отказа.
5. Если вы готовы подключиться к виртуальной машине Azure, сделайте это, чтобы проверить ее после отработки отказа.
6. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> **Не отменяйте выполняющуюся отработку отказа.** Перед запуском отработки отказа останавливается репликация виртуальной машины. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.  


## <a name="fail-back-from-azure-to-on-premises"></a>Восстановление размещения из Azure в локальную среду

### <a name="prerequisites-for-failback"></a>Необходимые условия для восстановления размещения

Чтобы выполнить восстановление размещения, убедитесь, что сервер VMM или Hyper-V основного сайта подключен к Site Recovery.


### <a name="run-a-failback-and-reprotect-on-premises-vms"></a>Восстановление размещения и повторная защита виртуальных машин в локальной среде

Выполните отработку отказа из Azure на локальный сайт и начните репликацию виртуальных машин с локального сайта в Azure.

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Плановая отработка отказа**.
2. В разделе **Подтвердить плановую отработку отказа** проверьте направление отработки отказа (из Azure) и выберите исходное и целевое расположение. 
3. В разделе **Синхронизация данных** укажите способ синхронизации:
    - **Синхронизация данных до отработки отказа (синхронизация только изменений)**. Этот параметр сводит к минимуму время простоя виртуальных машин, так как синхронизация выполняется без завершения их работы. Выполняются следующие операции:
        1. Создается моментальный снимок виртуальной машины Azure и копируется в локальный узел Hyper-V. Виртуальная машина продолжает работать в Azure.
        2. Завершает работу виртуальная машина Azure, поэтому никаких новых изменений не происходит. Последний набор разностных изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
    - **Синхронизация данных только во время отработки отказа (полное скачивание)**. Укажите этот параметр, если использовали Azure в течение длительного времени. Это более быстрый вариант, так как ожидается несколько изменений на диске и не тратится время на подсчеты контрольных сумм. При использовании этого варианта скачивается диск. Он также полезен, если локальная виртуальная машина была удалена.
4. Если при отработке отказа виртуальных машин Hyper-V в облаках System Center VMM с переносом в Azure включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
5. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
6. Если синхронизация данных выполняется перед отработкой отказа, то когда вы будете готовы завершить работу виртуальных машин Azure на дополнительном сайте после изначальной синхронизации данных, выберите **Задания**, имя задания плановой отработки отказа и **Завершение отработки отказа**. Эта команда завершит работу виртуальной машины Azure, передаст последние изменения в локальную среду и выполнит запуск локальной виртуальной машины.
7. Войдите в локальную виртуальную машину, чтобы проверить, доступна ли она, как и ожидалось.
8. Теперь локальная виртуальная машина находится в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать**. Эта команда удаляет виртуальные машины Azure и их диски, а также подготавливает локальную виртуальную машину к обратной репликации.
9. Чтобы запустить репликацию локальной виртуальной машины в Azure, включите **обратную репликацию**.


> [!NOTE]
> При этом реплицируются только изменения с момента выключения виртуальной машины Azure и отправляются только разностные изменения.


