---
title: Отработка отказа и восстановление размещения виртуальных машин IaaS Azure, реплицированных в дополнительный регион Azure, в случае аварийного восстановления с помощью службы Azure Site Recovery.
description: Сведения об отработке отказа и восстановлении размещения виртуальных машин Azure, реплицированных в дополнительный регион Azure, в случае аварийного восстановления с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 12/27/2018
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 46dae28fd6c9eaa3d5e03f5f06c5e92449653679
ms.sourcegitcommit: 90c6b63552f6b7f8efac7f5c375e77526841a678
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2019
ms.locfileid: "56737728"
---
# <a name="fail-over-and-fail-back-azure-vms-between-azure-regions"></a>Отработка отказа и восстановление размещения виртуальных машин Azure между регионами Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

Этот учебник содержит сведения об отработке отказа отдельной виртуальной машины Azure в дополнительный регион Azure. Восстановление размещения в основном регионе после отработки отказа происходит в тех ситуациях, где это возможно. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Отработка отказа виртуальной машины Azure
> * Повторная защита дополнительной виртуальной машины Azure, чтобы обеспечить ее репликацию в основной регион
> * Восстановление размещения дополнительной виртуальной машины
> * Повторная защита основной виртуальной машины для использования дополнительного региона

> [!NOTE]
> Это руководство содержит пошаговую инструкцию для пользователя по отработке отказа с переключением на целевой регион и обратно с минимальной настройкой. Если вам нужны дополнительные сведения о различных аспектах, связанных с отработкой отказа, включая требования к сети, автоматизацию или устранение неполадок, см. статьи с руководствами для виртуальных машин Azure.

## <a name="prerequisites"></a>Предварительные требования

- Обязательно выполните [отработку аварийного восстановления](azure-to-azure-tutorial-dr-drill.md), чтобы убедиться в надлежащей работе всех компонентов.
- Перед запуском тестовой отработки отказа проверьте свойства виртуальной машины. Виртуальная машина должна соответствовать [требованиям Azure](azure-to-azure-support-matrix.md#replicated-machine-operating-systems).

## <a name="run-a-failover-to-the-secondary-region"></a>Запуск отработки отказа в дополнительный регион

1. В разделе **Реплицированные элементы** выберите виртуальную машину, для которой требуется отработка отказа, а затем выберите **Отработка отказа**

   ![Отработка отказа](./media/azure-to-azure-tutorial-failover-failback/failover.png)

2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:

   * **Последние** (по умолчанию): выполняет обработку всех данных в службе Site Recovery и обеспечивает наименьшую целевую точку восстановления (RPO).
   * **Последняя обработанная**. отменяет изменения для виртуальной машины до последней точки восстановления из числа обработанных службой Site Recovery.
   * **Настраиваемая**. выполняет отработку отказа до определенной точки восстановления. Этот параметр удобен для выполнения тестовой отработки отказа.

3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. Обратите внимание, что Site Recovery не поддерживает очистку источника после отработки отказа.

4. На странице **Задания** можно следить за ходом выполнения отработки отказа.

5. После отработки отказа войдите на виртуальную машину, чтобы проверить ее работу. Если вы хотите использовать для виртуальной машины другую точку восстановления, выберите команду **Изменить точку восстановления**.

6. Когда вы убедитесь, что после отработки отказа виртуальная машина работает правильно, **зафиксируйте** отработку отказа.
   При фиксации удаляются все доступные в службе точки восстановления. Параметр **Изменить точку восстановления** больше не доступен.

## <a name="reprotect-the-secondary-vm"></a>Повторная защита дополнительной виртуальной машины

После отработки отказа виртуальной машины нужно снова защитить ее, чтобы она реплицировалась в основной регион.

1. Убедитесь, что виртуальная машина находится в состоянии **Отработка отказа зафиксирована**, основной регион доступен и вы можете создавать и использовать новые ресурсы в нем.
2. В разделе **Хранилище** > **Реплицированные элементы** щелкните виртуальную машину, для которой проводилась отработка отказа, щелкните правой кнопкой мыши и выберите **Защитить повторно**.

   ![Щелкните правой кнопкой мыши для повторной защиты](./media/azure-to-azure-tutorial-failover-failback/reprotect.png)

2. Обратите внимание, что направление защиты — из дополнительного региона в основной — уже выбрано.
3. Просмотрите информацию о **группе ресурсов, сети, хранилище и группах доступности**. Все ресурсы, помеченные как новые, создаются во время повторного включения защиты.
4. Нажмите кнопку **ОК**, чтобы запустить задание повторной защиты. Оно заполняет целевой сайт актуальными данными, а затем реплицирует отличия в основной регион. Теперь виртуальная машина находится в защищенном состоянии.

> [!NOTE]
> Дополнительные сведения о том, как повторно включить защиту и что происходит во время повторного включения защиты, см. в [этом разделе](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-how-to-reprotect#what-happens-during-reprotection).


## <a name="fail-back-to-the-primary-region"></a>Восстановление размещения в основном регионе

Когда вы повторно включите защиту виртуальной машины, можете при необходимости восстановить размещение в основном регионе. Для этого настройте отработку отказа из дополнительного региона в основной регион, как описано в этой статье.

![Щелкните правой кнопкой мыши для повторной защиты](./media/azure-to-azure-tutorial-failover-failback/failback.png)

Как показано на снимке экрана выше, для виртуальной машины ContosoWin2016 выполнена отработка отказа из региона "Центральная часть США" в регион "Восточная часть США", а затем восстановление из региона "Восточная часть США" в регион "Центральная часть США".

При отработке отказа завершается работа виртуальной машины в дополнительном регионе (регион аварийного восстановления), создается и загружается виртуальная машина в основном регионе. **Обратите внимание**, что виртуальные машины аварийного восстановления будут оставаться в отключенном состоянии, как показано выше. Это происходит намеренно, так как служба Azure Site Recovery сохраняет сведения о виртуальной машине, которые могут понадобиться при отработке отказа из основного региона в дополнительный регион. Вы не платите за отключенные виртуальные машины, поэтому их необходимо сохранить без изменений.
