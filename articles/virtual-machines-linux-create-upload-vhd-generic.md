<properties urlDisplayName="Upload a Linux VHD" pageTitle="Создание и передача виртуального жесткого диска с операционной системой Linux в Azure" metaKeywords="Azure VHD, uploading Linux VHD" description="Узнайте, как создать и передать виртуальный жесткий диск (VHD-файл) Azure, содержащий операционную систему Linux." metaCanonical="" services="virtual-machines" documentationCenter="" title="Creating and Uploading a Virtual Hard Disk that Contains a Linux Operating System" authors="szarkos" solutions="" manager="timlt" editor="tysonn" />

<tags ms.service="virtual-machines" ms.workload="infrastructure-services" ms.tgt_pltfrm="vm-linux" ms.devlang="na" ms.topic="article" ms.date="06/05/2014" ms.author="szarkos" />


# <a id="nonendorsed"> </a>Информация о нерекомендованных дистрибутивах

**Важно!**: Соглашение об уровне обслуживания для платформы Azure применяется для виртуальных машин с ОС Linux только в том случае, если используется один из [рекомендованных дистрибутивов](../virtual-machines-linux-endorsed-distributions). Все дистрибутивы Linux, представленные в коллекции образов Azure, - это рекомендованные дистрибутивы, уже имеющие необходимую конфигурацию.

- [Linux в Azure - рекомендованные дистрибутивы](../virtual-machines-linux-endorsed-distributions)
- [Поддержка образов Linux в Microsoft Azure](http://support2.microsoft.com/kb/2941892)

Все дистрибутивы, работающие в Azure, должны соответствовать ряду предварительных требований для правильной работы на платформе.  Эта статья далеко не исчерпывающая, так как каждый дистрибутив имеет свои отличия; вполне возможно, что даже при соблюдении всех изложенных ниже критериев, необходимо будет в значительной мере настраивать используемую систему Linux для ее надлежащей работы на платформе.

Именно по этой причине мы рекомендуем по возможности начать работу с одним из [рекомендованных дистрибутивов Linux в Azure](../linux-endorsed-distributions) . В следующих статьях описывается подготовка различных рекомендованных дистрибутивов Linux, которые поддерживаются в Azure:

- **[Дистрибутивы на основе CentOS](../virtual-machines-linux-create-upload-vhd-centos)**
- **[Oracle Linux](../virtual-machines-linux-create-upload-vhd-oracle)**
- **[SLES и openSUSE](../virtual-machines-linux-create-upload-vhd-suse)**
- **[Ubuntu](../virtual-machines-linux-create-upload-vhd-ubuntu)**

Далее в этой статье приводятся общие рекомендации по работе с дистрибутивом Linux в Azure.


##Общие замечания по установке Linux

- Более новый формат VHDX не поддерживается в Azure. Можно преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлета convert-vhd.

- При установке системы Linux рекомендуется использовать стандартные разделы, а не LVM (как правило, значение по умолчанию во многих дистрибутивах). Это позволит избежать конфликта имен LVM при клонировании виртуальных машин, особенно если диск с OC может быть подключен к другой ВМ в целях устранения неполадок.  LVM или [RAID](../virtual-machines-linux-configure-raid) можно использовать на дисках с данными.

- NUMA не поддерживается для виртуальных машин большего размера из-за ошибки ядра Linux в версиях ниже 2.6.37. Эта проблема влияет в основном на дистрибутивы, в которых используется исходное ядро Red Hat 2.6.32. При ручной установке агента Azure Linux (waagent) NUMA автоматически отключается в конфигурации GRUB для ядра Linux.

- Не настраивайте раздел подкачки на диске с ОС. Можно настроить агент Linux для создания файла подкачки на временном диске ресурсов.  Дополнительные сведения описаны далее.

- Все VHD-диски должны иметь размер, кратный 1 МБ.


## Рекомендации по ядру Linux

Драйверы Linux Integration Services (LIS) для Hyper-V и Azure встраиваются непосредственно в основное ядро Linux. Во многих дистрибутивах, которые включают последнюю версию ядра Linux (то есть 3.x), эти драйверы уже будут доступны, или же в ядре предоставляются их более ранние версии.  Эти ядра в основном ядре постоянно обновляются с помощью новых исправлений и функций, поэтому по возможности рекомендуется использовать [рекомендованный дистрибутив](../linux-endorsed-distributions) , включающий все исправления и обновления.

Если вы работаете с одним из вариантов Red Hat Enterprise Linux версий **6.0-6.3**, вам потребуется установить последние драйверы LIS для Hyper-V. Они доступны [по этой ссылке](http://go.microsoft.com/fwlink/p/?LinkID=254263&clcid=0x409). Начиная с RHEL **6.4+** (и его производных вариантов), драйверы LIS уже включены в ядро. Поэтому дополнительные пакеты установки для работы этих системы в Azure не требуются.

Если необходимо собственное ядро, рекомендуется использовать одну из последних версий (то есть **3.8+**). Для дистрибутивов или поставщиков, предоставляющих собственное ядро, рекомендуется перенести драйверы LIS из основного ядра в собственное.  Даже если вы работаете с относительно свежей версией ядра, рекомендуется отслеживать исправления драйверов LIS в основном ядре и обновлять драйверы по мере необходимости. Расположение исходных файлах драйверов LIS доступно в файле [MAINTAINERS](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/MAINTAINERS) в исходном дереве ядра Linux:

	F:	arch/x86/include/asm/mshyperv.h
	F:	arch/x86/include/uapi/asm/hyperv.h
	F:	arch/x86/kernel/cpu/mshyperv.c
	F:	drivers/hid/hid-hyperv.c
	F:	drivers/hv/
	F:	drivers/input/serio/hyperv-keyboard.c
	F:	drivers/net/hyperv/
	F:	drivers/scsi/storvsc_drv.c
	F:	drivers/video/fbdev/hyperv_fb.c
	F:	include/linux/hyperv.h
	F:	tools/hv/

Известно, что отсутствие следующих исправлений приводит к возникновению проблем на Azure, поэтому их необходимо включить в ядро. Этот список может не являться исчерпывающим и полным для всех дистрибутивов:

- [ata_piix: предоставить диски драйверам Hyper-V по умолчанию](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/ata/ata_piix.c?id=cd006086fa5d91414d8ff9ff2b78fbb593878e3c)
- [storvsc: учитывать передаваемые пакеты в папке RESET](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/scsi/storvsc_drv.c?id=5c1b10ab7f93d24f29b5630286e323d1c5802d5c)


## Агент Linux для Azure

Для правильной подготовки виртуальной машины Linux в Azure необходим [Агент Linux для Azure](../virtual-machines-linux-agent-user-guide) (waagent). Можно получить его последнюю версию, узнать о проблемах с файлами или отправить запрос можно в [репозитории GitHub для агента Linux](https://github.com/Azure/WALinuxAgent).

- Агент Linux выпускается по лицензии Apache 2.0. Многие дистрибутивы уже предоставляют пакеты RPM или deb для этого агента, поэтому в некоторых случаях его можно установить и обновить с минимальными усилиями.

- Для работы агента Linux для Azure требуется Python v2.6+.

- Для агента также необходим модуль python-pyasn1. В большинстве дистрибутивов он предоставляется в виде отдельно устанавливаемого пакета.

- В некоторых случаях агент Linux для Azure может быть несовместим с NetworkManager. Многие пакеты RPM/Deb, предоставленные вместе с дистрибутивами, настраивают NetworkManager с использованием параметров, конфликтующих с пакетом waagent, поэтому это приведет к удалению NetworkManager при установке пакета агента Linux.


## Общие системные требования для Linux

- Измените строку загрузки ядра в GRUB или GRUB2 для включения следующих параметров: Это также гарантирует отправку всех сообщений консоли на первый последовательный порт, что может помочь технической поддержке Azure в плане отладки:

		console=ttyS0 earlyprintk=ttyS0 rootdelay=300

	Это также гарантирует отправку всех сообщений консоли на первый последовательный порт, что может помочь технической поддержке Azure в плане отладки.

	Помимо вышесказанного, рекомендуется удалить следующие параметры, если они существуют:

		rhgb quiet crashkernel=auto

	Графическая и "тихая" загрузка бесполезны в облачной среде, в которой нам нужно, чтобы все журналы отправлялись на последовательный порт.

	При желании можно настроить параметр crashkernel, однако учитывайте, что он сокращает объем доступной памяти в виртуальной машине на 128 МБ или более, что может оказаться проблемой в виртуальных машинах небольшого размера.

- Установка агента Linux для Azure

	Агент Linux для Azure необходим для подготовки образа Linux в Azure.  Во многих дистрибутивах агент предоставляется в виде пакета RPM или Deb (пакет обычно называется "WALinuxAgent" или "walinuxagent").  Агент также можно установить вручную, как описано в [руководстве по агенту Linux](../virtual-machines-linux-agent-user-guide).

- Убедитесь, что SSH-сервер установлен и настроен для включения во время загрузки.  Обычно это сделано по умолчанию.

- Не создавайте пространство подкачки на диске с ОС

	Агент Linux для Azure может автоматически настраивать пространство подкачки с использованием диска на локальном ресурсе, подключенном к виртуальной машине после подготовки для работы в среде Azure. Следует отметить, что локальный диск ресурсов является временным диском и должен быть очищен при отмене подготовки виртуальной машины. После установки агента Linux для Azure (см. предыдущий шаг) измените следующие параметры в /etc/waagent.conf соответствующим образом:

		ResourceDisk.Format=y
		ResourceDisk.Filesystem=ext4
		ResourceDisk.MountPoint=/mnt/resource
		ResourceDisk.EnableSwap=y
		ResourceDisk.SwapSizeMB=2048    ## NOTE: set this to whatever you need it to be.

- В "/etc/sudoers" закомментируйте или удалите следующие строки, если они существуют:

		Defaults targetpw
		ALL    ALL=(ALL) ALL

- На последнем этапе выполните следующие команды, чтобы отозвать виртуальную машину:

		# sudo waagent -force -deprovision
		# export HISTSIZE=0
		# logout

- Затем необходимо завершить работу виртуальной машины и передать виртуальный жесткий диск в Azure.



<!--HONumber=35.1-->
